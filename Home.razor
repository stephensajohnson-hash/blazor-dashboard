@page "/"
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JS

<div class="p-4 sm:p-8 relative">
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-between">
        <div class="flex items-center">
            <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none mr-4 z-50 relative" @onclick="ToggleMenu">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <div class="text-sm sm:text-base font-medium">
                <span id="local-clock" class="text-blue-300 ml-1">Loading...</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button @onclick="ToggleEditMode" class="@GetEditButtonClass()" title="Toggle Edit Mode">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            </button>

            <div class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600 hidden sm:flex">
                @if (CurrentWeather?.main != null)
                {
                    <span class="flex items-center">
                        <span class="text-lg font-bold mr-3 @GetTempColor(CurrentWeather.main.temp)">@Math.Round(CurrentWeather.main.temp)Â°</span>
                        <span class="mr-1 text-xl">@GetWeatherEmoji(CurrentWeather.weather?[0].icon ?? "")</span>
                    </span>
                }
            </div>
        </div>
    </nav>

    @if (!string.IsNullOrEmpty(ErrorMessage)) {
        <div class="bg-red-900/80 border border-red-500 text-white p-4 rounded mb-4 text-center">
            <strong>Error:</strong> @ErrorMessage
            <button class="ml-4 underline" @onclick="LoadData">Retry</button>
        </div>
    }

    @if (IsMenuOpen)
    {
        <div class="fixed top-[4rem] left-4 z-50 max-w-xs transition-all duration-300 ease-out">
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
                <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                    <h3 class="text-xl font-semibold text-white">Menu</h3>
                    <button class="text-gray-400 hover:text-white p-1" @onclick="ToggleMenu">X</button>
                </div>
                <div class="space-y-2">
                    <button @onclick="() => OpenGroupModal()" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 border border-gray-600 bg-gray-700/30">+ Add Link Group</button>
                    <button @onclick="() => OpenCountdownModal()" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 border border-gray-600 bg-gray-700/30">+ Add Countdown</button>
                    <button @onclick="() => OpenStockModal()" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 border border-gray-600 bg-gray-700/30">+ Add Stock</button>
                </div>
            </div>
        </div>
    }

    <main class="pt-16 pb-8 max-w-7xl mx-auto">
        <div class="mb-10 w-full h-48 relative flex items-center justify-center group/carousel">
            <button @onclick="PrevSlide" class="absolute left-0 z-40 p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full bg-gray-800/50 border border-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
            <div class="w-full h-full flex items-center justify-center max-w-5xl overflow-hidden relative rounded-xl border border-gray-700/50 bg-gray-800/50 backdrop-blur-sm p-4">
                @if (CarouselItems.Any())
                {
                    var item = CarouselItems[CurrentSlideIndex];
                    @if (item.Type == "forecast" && ForecastDays.Any()) {
                        <div class="flex items-stretch justify-between w-full h-full px-4 gap-2">
                            @foreach(var day in ForecastDays) {
                                <div class="flex flex-col items-center justify-center h-full flex-1 border-r border-gray-700/50 last:border-0">
                                    <div class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-2">@day.Date.ToString("ddd")</div>
                                    <div class="text-4xl mb-3">@GetWeatherEmoji(day.Icon)</div>
                                    <div class="text-sm font-bold"><span class="@GetTempColor(day.High)">@Math.Round(day.High)Â°</span> / <span class="@GetTempColor(day.Low)">@Math.Round(day.Low)Â°</span></div>
                                </div>
                            }
                        </div>
                    }
                    else if (item.Type == "stocks" && StockData.Any()) {
                        <div class="flex items-center justify-around w-full h-full px-4 gap-4 relative">
                            @if(IsEditMode) { <div class="absolute top-0 right-0 text-xs text-gray-500 italic">Manage via Menu</div> }
                            @foreach(var s in StockData) {
                                <div class="flex flex-col items-center relative group/stock">
                                    @if(IsEditMode) { <button @onclick="() => DeleteStock(s.Symbol)" class="absolute -top-4 -right-2 text-red-500 hover:text-red-300">Ã—</button> }
                                    <div class="font-bold text-gray-200 text-lg">@s.Symbol</div>
                                    <div class="text-2xl font-mono font-bold @GetStockColor(s.Change)">@s.Price.ToString("F2")</div>
                                    <div class="text-xs @GetStockColor(s.Change)">@(s.Change > 0 ? "+" : "")@s.Change.ToString("F2")</div>
                                </div>
                            }
                        </div>
                    }
                    else if (item.Type == "countdown" && item.Data is Countdown c) {
                        <div class="relative w-full h-full flex items-center justify-center">
                            @if(IsEditMode) { 
                                <button @onclick="() => DeleteCountdown(c)" class="absolute top-0 right-0 bg-red-900/80 p-2 rounded text-white hover:bg-red-700 z-50">Delete</button> 
                                <button @onclick="() => OpenCountdownModal(c)" class="absolute top-0 right-20 bg-blue-900/80 p-2 rounded text-white hover:bg-blue-700 z-50">Edit</button> 
                            }
                            <a href="@c.LinkUrl" target="_blank" class="flex items-center justify-center w-full h-full px-8 gap-8 hover:bg-white/5 transition duration-200">
                                @if (!string.IsNullOrEmpty(c.Img)) { <img src="@c.Img" class="w-24 h-24 rounded-xl object-cover shadow-lg border border-gray-600" /> }
                                <div class="flex flex-col justify-center">
                                    <div class="text-4xl font-black text-white tracking-tight">@c.Name</div>
                                    <div class="text-sm text-gray-400 uppercase tracking-widest font-semibold mt-1">@c.TargetDate.ToString("M/d/yyyy")</div>
                                </div>
                                <div class="text-right pl-8">
                                    <div class="text-6xl font-mono text-blue-400 font-bold">@GetDaysRemaining(c.TargetDate)</div>
                                    <div class="text-sm font-mono text-gray-400 mt-1">@GetDetailedTime(c.TargetDate)</div>
                                </div>
                            </a>
                        </div>
                    }
                    else { <p class="text-gray-400 animate-pulse">Loading Data...</p> }
                }
                else { <p class="text-gray-400 animate-pulse">Loading Dashboard...</p> }
            </div>
            <button @onclick="NextSlide" class="absolute right-0 z-40 p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full bg-gray-800/50 border border-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
        </div>

        <div class="flex flex-wrap justify-center gap-6 items-start">
            @foreach (var group in Groups) {
                <div class="flex-1 min-w-[300px] max-w-[400px] rounded-2xl border p-5 shadow-xl backdrop-blur-sm @GetGroupColorClass(group.Color) relative group/card">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold tracking-wide text-white">@group.Name</h3>
                        @if(IsEditMode) {
                            <div class="flex gap-2">
                                <button @onclick="() => OpenGroupModal(group)" class="text-blue-300 hover:text-white">Edit</button>
                                <button @onclick="() => DeleteGroup(group)" class="text-red-400 hover:text-white">Del</button>
                            </div>
                        }
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        @foreach (var link in group.Links) {
                            <div class="relative group/link">
                                @if(IsEditMode) {
                                    <div class="absolute -top-2 -right-2 z-10 flex bg-gray-900 rounded-full border border-gray-600 scale-75">
                                        <button @onclick="() => OpenLinkModal(link)" class="p-1 text-blue-400 hover:text-white">âœŽ</button>
                                        <button @onclick="() => DeleteLink(link)" class="p-1 text-red-400 hover:text-white">Ã—</button>
                                    </div>
                                }
                                <a href="@link.Url" target="_blank" class="flex flex-col items-center text-center hover:scale-105 transition duration-200">
                                    <div class="w-24 h-24 bg-gray-900/50 rounded-xl mb-2 p-3 flex items-center justify-center shadow-inner border border-white/5 relative">
                                        @if (!string.IsNullOrEmpty(link.Img)) {
                                            <img src="@link.Img" class="w-full h-full object-contain rounded-md" onerror="this.style.display='none';this.nextElementSibling.style.display='block'" />
                                            <span class="hidden text-3xl font-bold text-gray-500">@GetSafeInitial(link.Name)</span>
                                        } else { <span class="text-3xl font-bold text-gray-500">@GetSafeInitial(link.Name)</span> }
                                    </div>
                                    <span class="text-sm font-medium truncate w-full text-gray-300 group-hover/link:text-white">@link.Name</span>
                                </a>
                            </div>
                        }
                        @if(IsEditMode) {
                            <button @onclick="() => OpenLinkModal(null, group.Id)" class="flex flex-col items-center justify-center text-center opacity-50 hover:opacity-100 border-2 border-dashed border-gray-600 rounded-xl w-24 h-24 mb-6"><span class="text-4xl text-gray-400">+</span></button>
                        }
                    </div>
                </div>
            }
        </div>
    </main>

    @if (ShowLinkModal) { <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-gray-800 rounded p-6 w-full max-w-md"><input class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingLink.Name" placeholder="Name" /><input class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingLink.Url" placeholder="URL" /><input class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingLink.Img" placeholder="Image URL" /><button @onclick="SaveLink" class="bg-blue-600 text-white p-2 rounded">Save</button><button @onclick="()=>ShowLinkModal=false" class="ml-2 text-gray-400">Cancel</button></div></div> }
    @if (ShowGroupModal) { <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-gray-800 rounded p-6 w-full max-w-md"><input class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingGroup.Name" placeholder="Name" /><select class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingGroup.Color"><option value="blue">Blue</option><option value="green">Green</option><option value="red">Red</option><option value="gray">Gray</option></select><button @onclick="SaveGroup" class="bg-green-600 text-white p-2 rounded">Save</button><button @onclick="()=>ShowGroupModal=false" class="ml-2 text-gray-400">Cancel</button></div></div> }
    @if (ShowCountdownModal) { <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-gray-800 rounded p-6 w-full max-w-md"><input class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingCountdown.Name" placeholder="Name" /><input type="date" class="w-full bg-gray-700 p-2 text-white mb-2" @bind="EditingCountdown.TargetDate" /><button @onclick="SaveCountdown" class="bg-purple-600 text-white p-2 rounded">Save</button><button @onclick="()=>ShowCountdownModal=false" class="ml-2 text-gray-400">Cancel</button></div></div> }
    @if (ShowStockModal) { <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4"><div class="bg-gray-800 rounded p-6 w-full max-w-md"><input class="w-full bg-gray-700 p-2 text-white mb-2 uppercase" @bind="NewStockSymbol" placeholder="Symbol" /><button @onclick="SaveStock" class="bg-blue-600 text-white p-2 rounded">Add</button><button @onclick="()=>ShowStockModal=false" class="ml-2 text-gray-400">Cancel</button></div></div> }
</div>

@code {
    [Inject] public AppDbContext Db { get; set; } = default!;
    
    // UI
    bool IsMenuOpen = false, IsEditMode = false, ShowLinkModal = false, ShowGroupModal = false, ShowCountdownModal = false, ShowStockModal = false;
    int CurrentSlideIndex = 0;
    string ErrorMessage = "";
    
    // Editing Objects
    Link EditingLink = new();
    LinkGroup EditingGroup = new();
    Countdown EditingCountdown = new();
    string NewStockSymbol = "";

    // Data
    List<CarouselItem> CarouselItems = new();
    List<LinkGroup> Groups = new();
    List<Countdown> Countdowns = new();
    List<Stock> Stocks = new();
    WeatherResponse? CurrentWeather;
    List<ForecastDay> ForecastDays = new();
    List<StockQuote> StockData = new();
    double TodayHigh, TodayLow;

    protected override async Task OnInitializedAsync() {
        await LoadData();
        _ = FetchWeather(); // Safe async
        _ = FetchStocks();  // Safe async
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if(firstRender) {
            try { await JS.InvokeVoidAsync("startLocalClock"); } catch {}
        }
    }

    private async Task LoadData() {
        try {
            ErrorMessage = "";
            Groups = await Db.LinkGroups.Include(g => g.Links).OrderBy(g => g.Id).ToListAsync();
            Countdowns = await Db.Countdowns.OrderBy(c => c.TargetDate).ToListAsync();
            Stocks = await Db.Stocks.ToListAsync();
            RebuildCarousel();
        } catch (Exception ex) {
            ErrorMessage = "Database Error: " + ex.Message;
        }
    }

    private void RebuildCarousel() {
        CarouselItems.Clear();
        CarouselItems.Add(new CarouselItem { Type = "forecast" });
        if (Stocks.Any()) CarouselItems.Add(new CarouselItem { Type = "stocks" });
        foreach (var c in Countdowns) CarouselItems.Add(new CarouselItem { Type = "countdown", Data = c });
        if(CurrentSlideIndex >= CarouselItems.Count) CurrentSlideIndex = 0;
    }

    // Toggles
    void ToggleMenu() => IsMenuOpen = !IsMenuOpen;
    void ToggleEditMode() => IsEditMode = !IsEditMode;
    void NextSlide() => CurrentSlideIndex = (CurrentSlideIndex + 1) % CarouselItems.Count;
    void PrevSlide() => CurrentSlideIndex = (CurrentSlideIndex - 1 + CarouselItems.Count) % CarouselItems.Count;

    // CRUD Ops (Wrapped in Try/Catch for safety)
    void OpenLinkModal(Link? l, int gId = 0) { EditingLink = l ?? new Link { LinkGroupId = gId }; ShowLinkModal = true; }
    async Task SaveLink() { 
        if(EditingLink.Id == 0) Db.Links.Add(EditingLink); else Db.Links.Update(EditingLink);
        await Db.SaveChangesAsync(); ShowLinkModal = false; await LoadData(); 
    }
    async Task DeleteLink(Link l) { if(await Confirm($"Delete {l.Name}?")) { Db.Links.Remove(l); await Db.SaveChangesAsync(); await LoadData(); } }

    void OpenGroupModal(LinkGroup? g = null) { EditingGroup = g ?? new LinkGroup { Color = "gray" }; ShowGroupModal = true; IsMenuOpen = false; }
    async Task SaveGroup() { 
        if(EditingGroup.Id == 0) Db.LinkGroups.Add(EditingGroup); else Db.LinkGroups.Update(EditingGroup);
        await Db.SaveChangesAsync(); ShowGroupModal = false; await LoadData(); 
    }
    async Task DeleteGroup(LinkGroup g) { if(await Confirm($"Delete {g.Name}?")) { Db.LinkGroups.Remove(g); await Db.SaveChangesAsync(); await LoadData(); } }

    void OpenCountdownModal(Countdown? c = null) { EditingCountdown = c ?? new Countdown { TargetDate = DateTime.Now }; ShowCountdownModal = true; IsMenuOpen = false; }
    async Task SaveCountdown() { 
        if(EditingCountdown.Id == 0) Db.Countdowns.Add(EditingCountdown); else Db.Countdowns.Update(EditingCountdown);
        await Db.SaveChangesAsync(); ShowCountdownModal = false; await LoadData(); 
    }
    async Task DeleteCountdown(Countdown c) { if(await Confirm($"Delete {c.Name}?")) { Db.Countdowns.Remove(c); await Db.SaveChangesAsync(); await LoadData(); } }

    void OpenStockModal() { NewStockSymbol = ""; ShowStockModal = true; IsMenuOpen = false; }
    async Task SaveStock() { 
        if(!string.IsNullOrWhiteSpace(NewStockSymbol)) { Db.Stocks.Add(new Stock{Symbol=NewStockSymbol.ToUpper()}); await Db.SaveChangesAsync(); await FetchStocks(); await LoadData(); }
        ShowStockModal = false; 
    }
    async Task DeleteStock(string s) { 
        var st = await Db.Stocks.FirstOrDefaultAsync(x=>x.Symbol==s); 
        if(st!=null && await Confirm($"Delete {s}?")) { Db.Stocks.Remove(st); await Db.SaveChangesAsync(); await LoadData(); StockData.RemoveAll(x=>x.Symbol==s); } 
    }

    async Task<bool> Confirm(string msg) => await JS.InvokeAsync<bool>("confirm", msg);

    // Weather/Stocks (Safe)
    async Task FetchWeather() {
        try {
            var zip = "75482,us"; var key = "87256fe2710631542ff491e4c5d73306";
            var w = await Http.GetFromJsonAsync<WeatherResponse>($"https://api.openweathermap.org/data/2.5/weather?zip={zip}&units=imperial&appid={key}");
            if(w!=null) CurrentWeather = w;
            var f = await Http.GetFromJsonAsync<ForecastResponse>($"https://api.openweathermap.org/data/2.5/forecast?zip={zip}&units=imperial&appid={key}");
            if(f?.list!=null) {
                ForecastDays = f.list.Where(x=>x.main!=null).GroupBy(x=>DateTimeOffset.FromUnixTimeSeconds(x.dt).Date).Take(5)
                    .Select(g=>new ForecastDay{Date=g.Key, High=g.Max(x=>x.main!.temp_max), Low=g.Min(x=>x.main!.temp_min), Icon=g.First().weather?[0].icon??""}).ToList();
                var t = ForecastDays.FirstOrDefault(); if(t!=null){TodayHigh=t.High; TodayLow=t.Low;}
            }
            StateHasChanged();
        } catch {}
    }
    async Task FetchStocks() {
        try {
            var token = "d4geo7pr01qm5b359cugd4geo7pr01qm5b359cv0";
            foreach(var s in Stocks) {
                if(StockData.Any(x=>x.Symbol==s.Symbol)) continue;
                var r = await Http.GetFromJsonAsync<StockResponse>($"https://finnhub.io/api/v1/quote?symbol={s.Symbol}&token={token}");
                if(r!=null && r.c!=0) StockData.Add(new StockQuote{Symbol=s.Symbol, Price=r.c, Change=r.d, PercentChange=r.dp});
            }
            StateHasChanged();
        } catch {}
    }

    // Helper Methods (The Fix: Moved complex logic here)
    string GetEditButtonClass() {
        return "p-2 rounded-full " + (IsEditMode ? "bg-yellow-600 text-white animate-pulse" : "bg-gray-700 text-gray-400 hover:text-white");
    }
    
    string GetSafeInitial(string? name) {
        if (string.IsNullOrEmpty(name)) return "?";
        return name.Substring(0, 1);
    }

    string GetDaysRemaining(DateTime t) => (t.Date-DateTime.Now.Date).TotalDays<=0?"Today!":(t.Date-DateTime.Now.Date).TotalDays.ToString();
    string GetDetailedTime(DateTime t) {
        var n = DateTime.Now.Date; var d = t.Date-n; if(d.TotalDays<=0) return "It's here!";
        int y=t.Year-n.Year, m=t.Month-n.Month, da=t.Day-n.Day;
        if(da<0){m--; da+=DateTime.DaysInMonth(n.Year, n.Month);} if(m<0){y--; m+=12;}
        var p = new List<string>(); if(y>0)p.Add($"{y} Years"); if(m>0)p.Add($"{m} Months"); if(da>0)p.Add($"{da} Days");
        return string.Join(" ", p);
    }
    string GetGroupColorClass(string c) => c.ToLower() switch { "blue"=>"bg-blue-900/20 border-blue-800/50", "green"=>"bg-green-900/20 border-green-800/50", "red"=>"bg-red-900/20 border-red-800/50", "purple"=>"bg-purple-900/20 border-purple-800/50", "yellow"=>"bg-yellow-900/20 border-yellow-800/50", "teal"=>"bg-teal-900/20 border-teal-800/50", _=>"bg-gray-800 border-gray-700" };
    string GetTempColor(double t) => t>=80?"text-red-500":t>70?"text-green-400":t>=60?"text-green-400/80":t<50?"text-sky-300":"text-white";
    string GetStockColor(double c) => c>0?"text-green-400":c<0?"text-red-400":"text-gray-400";
    string GetWeatherEmoji(string i) { if(i.Contains("01"))return"â˜€ï¸"; if(i.Contains("02"))return"ðŸŒ¤ï¸"; if(i.Contains("03"))return"ðŸŒ¥ï¸"; if(i.Contains("09")||i.Contains("10"))return"ðŸŒ§ï¸"; if(i.Contains("13"))return"â„ï¸"; return"â˜ï¸"; }

    class CarouselItem { public string Type { get; set; } = ""; public object? Data { get; set; } }
    class ForecastDay { public DateTime Date { get; set; } public double High { get; set; } public double Low { get; set; } public string Icon { get; set; } = ""; }
    class StockQuote { public string Symbol { get; set; } = ""; public double Price { get; set; } public double Change { get; set; } public double PercentChange { get; set; } }
    public class WeatherResponse { public MainData? main { get; set; } public List<WeatherIcon>? weather { get; set; } }
    public class ForecastResponse { public List<ForecastItem>? list { get; set; } }
    public class ForecastItem { public long dt { get; set; } public MainData? main { get; set; } public List<WeatherIcon>? weather { get; set; } }
    public class MainData { public double temp { get; set; } public double temp_min { get; set; } public double temp_max { get; set; } }
    public class WeatherIcon { public string icon { get; set; } = ""; }
    public class StockResponse { public double c { get; set; } public double d { get; set; } public double dp { get; set; } }
}
