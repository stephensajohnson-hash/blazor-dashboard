@page "/"
@using Dashboard
@using Microsoft.EntityFrameworkCore

<style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Countdowns */
    .countdown-card { text-align: center; border: none; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .countdown-card:hover { transform: translateY(-3px); }
    .countdown-img { height: 100px; width: 100%; object-fit: cover; }
    .countdown-days { font-size: 2rem; font-weight: bold; color: #d9534f; }
    
    /* Link Groups */
    .group-card { border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; }
    .group-header { padding: 10px 15px; font-weight: bold; font-size: 1.1rem; border-radius: 10px 10px 0 0; color: white; }
    
    /* Colors based on your JSON */
    .bg-blue { background-color: #0d6efd; }
    .bg-green { background-color: #198754; }
    .bg-red { background-color: #dc3545; }
    .bg-yellow { background-color: #ffc107; color: black !important; }
    .bg-purple { background-color: #6f42c1; }
    .bg-teal { background-color: #20c997; }
    .bg-gray { background-color: #6c757d; }
    
    /* Links */
    .link-item { display: flex; align-items: center; padding: 8px 10px; text-decoration: none; color: #333; transition: background 0.2s; border-bottom: 1px solid #f8f9fa; }
    .link-item:hover { background-color: #f8f9fa; color: #000; }
    .link-icon { width: 24px; height: 24px; border-radius: 4px; margin-right: 10px; object-fit: contain; }
</style>

<div class="dashboard-container">
    
    @if (Countdowns.Any())
    {
        <h5 class="text-muted mb-3">Upcoming Events</h5>
        <div class="row mb-4">
            @foreach (var c in Countdowns)
            {
                var daysLeft = (c.TargetDate - DateTime.Now).Days;
                <div class="col-md-3 col-6 mb-3">
                    <div class="card countdown-card">
                        @if (!string.IsNullOrEmpty(c.Img)) { <img src="@c.Img" class="countdown-img" /> }
                        <div class="p-2">
                            <div class="countdown-days">@daysLeft days</div>
                            <small>until @c.Name</small>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <h5 class="text-muted mb-3">Applications</h5>
    <div class="row">
        @foreach (var group in Groups)
        {
            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-4">
                <div class="card group-card">
                    <div class="group-header bg-@group.Color.ToLower()">
                        @group.Name
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var link in group.Links)
                        {
                            <a href="@link.Url" target="_blank" class="link-item">
                                @if (!string.IsNullOrEmpty(link.Img))
                                {
                                    <img src="@link.Img" class="link-icon" onError="this.style.display='none'" />
                                }
                                <span class="text-truncate">@link.Name</span>
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Microsoft.AspNetCore.Components.Inject]
    public Dashboard.AppDbContext Db { get; set; } = default!;

    private List<Dashboard.LinkGroup> Groups = new();
    private List<Dashboard.Countdown> Countdowns = new();

    protected override async Task OnInitializedAsync()
    {
        // Fetch Groups with Links
        Groups = await Db.LinkGroups
            .Include(g => g.Links)
            .ToListAsync();

        // Fetch Countdowns
        Countdowns = await Db.Countdowns
            .OrderBy(c => c.TargetDate)
            .ToListAsync();
    }
}
