@namespace Dashboard.Components.Bullet
@using System.Globalization

<div class="relative inline-block">
    <button @onclick="ToggleGrid" 
            class="bg-black/40 border border-gray-700 rounded-lg text-[10px] px-3 py-1.5 text-blue-400 hover:border-blue-500 font-black shadow-lg flex items-center gap-2 transition-all">
        ðŸ“… JUMP TO DATE
    </button>

    @if (isVisible)
    {
        @* SURGICAL FIX: Changed md:left-0 to md:right-0 to anchor to the right side of the button *@
        <div class="fixed md:absolute top-12 right-4 md:right-0 z-[100] bg-gray-900 border border-gray-700 rounded-2xl shadow-[0_0_60px_rgba(0,0,0,0.9)] p-4 w-[92vw] md:w-[850px] backdrop-blur-xl">
            
            @* NAVIGATION HEADER *@
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-3 px-2">
                <button @onclick="() => ShiftGrid(-25)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">â—€ Prev 2 Years</button>
                <div class="text-center">
                    <h3 class="text-xs font-black tracking-[0.4em] text-white uppercase">Temporal Map</h3>
                    <p class="text-[8px] text-gray-500 font-bold uppercase mt-1">Viewing @GetRangeText()</p>
                </div>
                <button @onclick="() => ShiftGrid(25)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">Next 2 Years â–¶</button>
            </div>

            @* 5x5 MONTH GRID *@
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 overflow-y-auto max-h-[65vh] md:max-h-none pr-2 custom-scroll">
                @foreach (var monthDate in GetGridMonths())
                {
                    <div class="flex flex-col gap-1.5">
                        <div class="text-[9px] font-black @(IsCurrentMonth(monthDate) ? "text-blue-400" : "text-gray-500") uppercase text-center tracking-tighter">
                            @monthDate.ToString("MMMM yyyy")
                        </div>
                        
                        <div class="bg-black/40 border @(IsCurrentMonth(monthDate) ? "border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.1)]" : "border-gray-800") rounded-lg p-1.5 grid grid-cols-7 gap-0.5">
                            @foreach (var day in GetDaysInMonth(monthDate))
                            {
                                <button @onclick="() => SelectDate(day)" 
                                        class="text-[7px] p-0.5 rounded transition-all @GetDayClass(day)"
                                        title="@day.ToShortDateString()">
                                    @day.Day
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
            
            <div class="mt-6 pt-3 border-t border-gray-800 flex justify-between items-center">
                <button @onclick="JumpToToday" class="text-[9px] font-black text-blue-500 uppercase hover:underline">Center on Today</button>
                <button @onclick="ToggleGrid" class="text-[9px] font-black text-gray-500 uppercase hover:text-red-400 transition-colors">Close Map</button>
            </div>
        </div>
    }
</div>

<style>
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
</style>

@code {
    [Parameter] public DateTime SelectedDate { get; set; }
    [Parameter] public EventCallback<DateTime> OnDateSelected { get; set; }

    private bool isVisible = false;
    private DateTime gridCenterDate = DateTime.Today;

    private void ToggleGrid() 
    { 
        isVisible = !isVisible; 
        if(isVisible) gridCenterDate = SelectedDate; 
    }

    private void ShiftGrid(int months) => gridCenterDate = gridCenterDate.AddMonths(months);

    private void JumpToToday() => gridCenterDate = DateTime.Today;

    private async Task SelectDate(DateTime date)
    {
        isVisible = false;
        await OnDateSelected.InvokeAsync(date);
    }

    private List<DateTime> GetGridMonths()
    {
        var months = new List<DateTime>();
        var startDate = new DateTime(gridCenterDate.Year, gridCenterDate.Month, 1).AddMonths(-12);
        for (int i = 0; i < 25; i++) { months.Add(startDate.AddMonths(i)); }
        return months;
    }

    private IEnumerable<DateTime> GetDaysInMonth(DateTime monthDate)
    {
        var days = DateTime.DaysInMonth(monthDate.Year, monthDate.Month);
        for (int i = 1; i <= days; i++) { yield return new DateTime(monthDate.Year, monthDate.Month, i); }
    }

    private string GetRangeText() 
    {
        var months = GetGridMonths();
        return $"{months.First():MMM yyyy} - {months.Last():MMM yyyy}";
    }

    private bool IsCurrentMonth(DateTime dt) => dt.Month == DateTime.Today.Month && dt.Year == DateTime.Today.Year;

    private string GetDayClass(DateTime day)
    {
        if (day.Date == DateTime.Today) return "bg-blue-600 text-white font-black z-10 scale-110 shadow-lg";
        if (day.Date == SelectedDate.Date) return "bg-gray-700 text-blue-300 font-black";
        if (day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday) return "text-gray-600 hover:bg-gray-800 hover:text-white";
        return "text-gray-400 hover:bg-gray-700 hover:text-white";
    }
}