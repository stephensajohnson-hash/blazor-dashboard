@namespace Dashboard.Components.Bullet
@using System.Globalization
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletVacationService VacationService

<div class="relative inline-block">
    <button @onclick="ToggleGrid" 
            class="bg-black/40 border border-gray-700 rounded-lg text-[10px] px-3 py-1.5 text-blue-400 hover:border-blue-500 font-black shadow-lg flex items-center gap-2 transition-all">
        ðŸ“… JUMP TO DATE
    </button>

    @if (isVisible)
    {
        <div class="fixed md:absolute top-12 right-4 md:right-0 z-[100] bg-gray-900 border border-gray-700 rounded-2xl shadow-[0_0_60px_rgba(0,0,0,0.9)] p-4 w-[98vw] md:w-[1100px] backdrop-blur-xl flex flex-col max-h-[90vh]">
            
            @* NAVIGATION HEADER *@
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-3 px-2 shrink-0">
                <button @onclick="() => ShiftGrid(-28)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">â—€ Prev 28 Months</button>
                <div class="text-center">
                    <h3 class="text-xs font-black tracking-[0.4em] text-white uppercase">Temporal Map (28 Month View)</h3>
                    <p class="text-[8px] text-gray-500 font-bold uppercase mt-1">Viewing @GetRangeText()</p>
                </div>
                <button @onclick="() => ShiftGrid(28)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">Next 28 Months â–¶</button>
            </div>

            @* 4 ROWS x 7 COLUMNS MONTH GRID *@
            <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3 overflow-y-auto pr-2 custom-scroll pb-2">
                @foreach (var monthDate in GetGridMonths())
                {
                    <div class="flex flex-col gap-1">
                        <div class="text-[9px] font-black @(IsCurrentMonth(monthDate) ? "text-blue-400" : "text-gray-500") uppercase text-center tracking-tighter">
                            @monthDate.ToString("MMM yyyy")
                        </div>
                        
                        <div class="bg-black/40 border @(IsCurrentMonth(monthDate) ? "border-blue-500/30" : "border-gray-800") rounded-lg p-1 grid grid-cols-7 gap-0.5">
                            @* Restored Weekday Headers for every month *@
                            @foreach (var dayName in new[] { "M", "T", "W", "T", "F", "S", "S" })
                            {
                                <div class="text-[6px] text-gray-700 font-black text-center">@dayName</div>
                            }

                            @* Empty Padding Cells for Monday Start *@
                            @for (int p = 0; p < GetEmptyStartCells(monthDate); p++)
                            {
                                <div class="w-full aspect-square"></div>
                            }

                            @foreach (var day in GetDaysInMonth(monthDate))
                            {
                                var dayData = GetDayStatus(day);
                                <button @onclick="() => SelectDate(day)" 
                                        class="text-[7px] p-0.5 rounded transition-all @dayData.Css"
                                        title="@dayData.Title">
                                    @day.Day
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
            
            @* FOOTER LEGEND *@
            <div class="mt-4 pt-3 border-t border-gray-800 flex justify-between items-center shrink-0">
                <div class="flex gap-4 items-center">
                    <button @onclick="JumpToToday" class="text-[9px] font-black text-blue-500 uppercase hover:underline">Center on Today</button>
                    <div class="flex gap-3">
                        <span class="flex items-center gap-1 text-[7px] text-gray-500 uppercase font-black"><span class="w-2 h-2 border border-blue-500 rounded-sm"></span> Holiday</span>
                        <span class="flex items-center gap-1 text-[7px] text-gray-500 uppercase font-black"><span class="w-2 h-2 border border-pink-500 rounded-sm"></span> Birthday</span>
                        <span class="flex items-center gap-1 text-[7px] text-gray-500 uppercase font-black"><span class="w-2 h-2 border border-orange-500 rounded-sm"></span> Vacation</span>
                    </div>
                </div>
                <button @onclick="ToggleGrid" class="text-[9px] font-black text-gray-500 uppercase hover:text-red-400 transition-colors">Close Map</button>
            </div>
        </div>
    }
</div>

<style>
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
</style>

@code {
    [Parameter] public DateTime SelectedDate { get; set; }
    [Parameter] public EventCallback<DateTime> OnDateSelected { get; set; }
    [Parameter] public int UserId { get; set; }

    private bool isVisible = false;
    private DateTime gridCenterDate = DateTime.Today;
    
    private List<BulletHolidayService.HolidayDTO> internalHolidays = new();
    private List<BulletBirthdayService.BirthdayDTO> internalBirthdays = new();
    private List<BulletVacationService.VacationDTO> internalVacations = new();

    private async Task ToggleGrid() 
    { 
        isVisible = !isVisible; 
        if(isVisible) 
        {
            gridCenterDate = SelectedDate;
            await LoadInternalData();
        }
    }

    private async Task LoadInternalData()
    {
        // SURGICAL RANGE FIX: 
        // We show 12 months before and 15 after. Fetch exactly that range to ensure highlights work.
        var start = new DateTime(gridCenterDate.Year, gridCenterDate.Month, 1).AddMonths(-12);
        var end = start.AddMonths(28).AddDays(-1);
        
        var holidayTask = HolidayService.GetHolidaysForRange(UserId, start, end);
        var birthdayTask = BirthdayService.GetBirthdaysForRange(UserId, start, end);
        var vacationTask = VacationService.GetVacationsForRange(UserId, start, end);

        await Task.WhenAll(holidayTask, birthdayTask, vacationTask);

        internalHolidays = holidayTask.Result;
        internalBirthdays = birthdayTask.Result;
        internalVacations = vacationTask.Result;
    }

    private async Task ShiftGrid(int months) 
    {
        gridCenterDate = gridCenterDate.AddMonths(months);
        await LoadInternalData();
    }

    private async Task JumpToToday() 
    {
        gridCenterDate = DateTime.Today;
        await LoadInternalData();
    }

    private async Task SelectDate(DateTime date)
    {
        isVisible = false;
        await OnDateSelected.InvokeAsync(date);
    }

    private List<DateTime> GetGridMonths()
    {
        var months = new List<DateTime>();
        // Logic: 12 months before the center month
        var startDate = new DateTime(gridCenterDate.Year, gridCenterDate.Month, 1).AddMonths(-12);
        for (int i = 0; i < 28; i++) 
        { 
            months.Add(startDate.AddMonths(i)); 
        }
        return months;
    }

    private int GetEmptyStartCells(DateTime monthDate)
    {
        var firstDay = new DateTime(monthDate.Year, monthDate.Month, 1);
        return ((int)firstDay.DayOfWeek + 6) % 7; // Monday Start logic
    }

    private IEnumerable<DateTime> GetDaysInMonth(DateTime monthDate)
    {
        var days = DateTime.DaysInMonth(monthDate.Year, monthDate.Month);
        for (int i = 1; i <= days; i++) { yield return new DateTime(monthDate.Year, monthDate.Month, i); }
    }

    private string GetRangeText() => $"{GetGridMonths().First():MMM yyyy} - {GetGridMonths().Last():MMM yyyy}";

    private bool IsCurrentMonth(DateTime dt) => dt.Month == DateTime.Today.Month && dt.Year == DateTime.Today.Year;

    private (string Css, string Title) GetDayStatus(DateTime day)
    {
        var holiday = internalHolidays.FirstOrDefault(h => h.Date.Date == day.Date);
        var bday = internalBirthdays.FirstOrDefault(b => b.Date.Date == day.Date);
        var vacation = internalVacations.FirstOrDefault(v => v.Date.Date == day.Date);

        var css = "relative ";
        var title = day.ToShortDateString();

        if (holiday != null)
        {
            css += "outline outline-1 outline-blue-500 text-red-500 font-black z-20 shadow-[0_0_5px_rgba(59,130,246,0.5)] ";
            title = $"Holiday: {holiday.Title}";
        }
        else if (bday != null)
        {
            css += "outline outline-1 outline-pink-500 text-pink-300 font-black z-20 ";
            title = $"Birthday: {bday.Title}";
        }
        else if (vacation != null)
        {
            css += "outline outline-1 outline-orange-500 text-orange-300 font-black z-20 ";
            title = $"Vacation: {vacation.Title}";
        }
        else if (day.Date == DateTime.Today) 
        {
            css += "bg-blue-600 text-white font-black z-10 scale-110 shadow-lg ";
        }
        else if (day.Date == SelectedDate.Date) 
        {
            css += "bg-gray-700 text-blue-300 font-black ";
        }
        else if (day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday) 
        {
            css += "text-gray-600 hover:bg-gray-800 hover:text-white ";
        }
        else 
        {
            css += "text-gray-400 hover:bg-gray-700 hover:text-white ";
        }

        return (css, title);
    }
}