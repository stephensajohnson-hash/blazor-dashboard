@namespace Dashboard.Components.Bullet
@using System.Globalization
@inject BulletHolidayService HolidayService

<div class="relative inline-block">
    <button @onclick="ToggleGrid" 
            class="bg-black/40 border border-gray-700 rounded-lg text-[10px] px-3 py-1.5 text-blue-400 hover:border-blue-500 font-black shadow-lg flex items-center gap-2 transition-all">
        ðŸ“… JUMP TO DATE
    </button>

    @if (isVisible)
    {
        <div class="fixed md:absolute top-12 right-4 md:right-0 z-[100] bg-gray-900 border border-gray-700 rounded-2xl shadow-[0_0_60px_rgba(0,0,0,0.9)] p-4 w-[92vw] md:w-[850px] backdrop-blur-xl">
            
            @* NAVIGATION HEADER *@
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-3 px-2">
                <button @onclick="() => ShiftGrid(-25)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">â—€ Prev 2 Years</button>
                <div class="text-center">
                    <h3 class="text-xs font-black tracking-[0.4em] text-white uppercase">Temporal Map</h3>
                    <p class="text-[8px] text-gray-500 font-bold uppercase mt-1">Viewing @GetRangeText()</p>
                </div>
                <button @onclick="() => ShiftGrid(25)" class="text-blue-500 hover:text-white font-black text-[10px] px-4 py-2 bg-gray-800 rounded-lg transition-colors uppercase tracking-widest">Next 2 Years â–¶</button>
            </div>

            @* 5x5 MONTH GRID *@
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 overflow-y-auto max-h-[65vh] md:max-h-none pr-2 custom-scroll">
                @foreach (var monthDate in GetGridMonths())
                {
                    <div class="flex flex-col gap-1.5">
                        <div class="text-[9px] font-black @(IsCurrentMonth(monthDate) ? "text-blue-400" : "text-gray-500") uppercase text-center tracking-tighter">
                            @monthDate.ToString("MMMM yyyy")
                        </div>
                        
                        <div class="bg-black/40 border @(IsCurrentMonth(monthDate) ? "border-blue-500/30" : "border-gray-800") rounded-lg p-1 grid grid-cols-7 gap-0.5">
                            @* Day Headers *@
                            @foreach (var dayName in new[] { "M", "T", "W", "T", "F", "S", "S" })
                            {
                                <div class="text-[6px] text-gray-700 font-black text-center">@dayName</div>
                            }

                            @* Empty Padding Cells for Monday Start *@
                            @for (int p = 0; p < GetEmptyStartCells(monthDate); p++)
                            {
                                <div class="w-full aspect-square"></div>
                            }

                            @foreach (var day in GetDaysInMonth(monthDate))
                            {
                                var holiday = internalHolidays.FirstOrDefault(h => h.Date.Date == day.Date);
                                <button @onclick="() => SelectDate(day)" 
                                        class="text-[7px] p-0.5 rounded transition-all @GetDayClass(day, holiday != null)"
                                        title="@(holiday?.Title ?? day.ToShortDateString())">
                                    @day.Day
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
            
            <div class="mt-6 pt-3 border-t border-gray-800 flex justify-between items-center">
                <button @onclick="JumpToToday" class="text-[9px] font-black text-blue-500 uppercase hover:underline">Center on Today</button>
                <button @onclick="ToggleGrid" class="text-[9px] font-black text-gray-500 uppercase hover:text-red-400 transition-colors">Close Map</button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public DateTime SelectedDate { get; set; }
    [Parameter] public EventCallback<DateTime> OnDateSelected { get; set; }
    [Parameter] public int UserId { get; set; }

    private bool isVisible = false;
    private DateTime gridCenterDate = DateTime.Today;
    private List<BulletHolidayService.HolidayDTO> internalHolidays = new();

    private async Task ToggleGrid() 
    { 
        isVisible = !isVisible; 
        if(isVisible) 
        {
            gridCenterDate = SelectedDate;
            await LoadInternalHolidays();
        }
    }

    private async Task LoadInternalHolidays()
    {
        // Fetch a wide range: 2 years back, 3 years forward from the center
        // This covers the entire 25-month grid effectively.
        var start = gridCenterDate.AddYears(-2);
        var end = gridCenterDate.AddYears(3);
        internalHolidays = await HolidayService.GetHolidaysForRange(UserId, start, end);
    }

    private async Task ShiftGrid(int months) 
    {
        gridCenterDate = gridCenterDate.AddMonths(months);
        await LoadInternalHolidays();
    }

    private async Task JumpToToday() 
    {
        gridCenterDate = DateTime.Today;
        await LoadInternalHolidays();
    }

    private async Task SelectDate(DateTime date)
    {
        isVisible = false;
        await OnDateSelected.InvokeAsync(date);
    }

    private List<DateTime> GetGridMonths()
    {
        var months = new List<DateTime>();
        var startDate = new DateTime(gridCenterDate.Year, gridCenterDate.Month, 1).AddMonths(-12);
        for (int i = 0; i < 25; i++) { months.Add(startDate.AddMonths(i)); }
        return months;
    }

    private int GetEmptyStartCells(DateTime monthDate)
    {
        var firstDay = new DateTime(monthDate.Year, monthDate.Month, 1);
        return ((int)firstDay.DayOfWeek + 6) % 7;
    }

    private IEnumerable<DateTime> GetDaysInMonth(DateTime monthDate)
    {
        var days = DateTime.DaysInMonth(monthDate.Year, monthDate.Month);
        for (int i = 1; i <= days; i++) { yield return new DateTime(monthDate.Year, monthDate.Month, i); }
    }

    private string GetRangeText() => $"{GetGridMonths().First():MMM yyyy} - {GetGridMonths().Last():MMM yyyy}";

    private bool IsCurrentMonth(DateTime dt) => dt.Month == DateTime.Today.Month && dt.Year == DateTime.Today.Year;

    private string GetDayClass(DateTime day, bool isHoliday)
    {
        // Base classes
        var css = "relative ";
        
        if (isHoliday) 
        {
            // Bright blue outline and red text as requested
            css += "outline outline-1 outline-blue-500 text-red-500 font-black z-20 shadow-[0_0_5px_rgba(59,130,246,0.5)] ";
        }
        else if (day.Date == DateTime.Today) 
        {
            css += "bg-blue-600 text-white font-black z-10 scale-110 shadow-lg ";
        }
        else if (day.Date == SelectedDate.Date) 
        {
            css += "bg-gray-700 text-blue-300 font-black ";
        }
        else if (day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday) 
        {
            css += "text-gray-600 hover:bg-gray-800 hover:text-white ";
        }
        else 
        {
            css += "text-gray-400 hover:bg-gray-700 hover:text-white ";
        }

        return css;
    }
}