@namespace Dashboard.Components.Bullet
@using Dashboard

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-2 shadow-sm group relative flex items-stretch overflow-hidden transition hover:border-blue-500/50">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
        <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">✏️</button>
        <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">✕</button>
    </div>

    <div class="w-10 shrink-0 bg-black/20 border-r border-gray-700 flex items-center justify-center hover:bg-black/40 cursor-pointer transition z-10"
         @onclick="ToggleComplete">
        <input type="checkbox" checked="@(Detail?.IsCompleted ?? false)" class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-offset-gray-800 cursor-pointer pointer-events-none" readonly />
    </div>

    <div class="flex-1 p-3 min-w-0 flex flex-col justify-center">
        <div class="flex justify-between items-start">
            <div class="truncate pr-8"> 
                <h4 class="text-sm font-bold text-white truncate @((Detail?.IsCompleted ?? false) ? "line-through text-gray-500" : "")">
                    @Item.Title
                </h4>
                @if (!string.IsNullOrWhiteSpace(Item.Description))
                {
                    <p class="text-xs text-gray-400 truncate">@Item.Description</p>
                }
            </div>
        </div>

        <div class="flex items-center gap-3 mt-2 text-[10px] uppercase font-bold tracking-wider">
            @if(Detail != null)
            {
                @if(Detail.StartTime != null)
                {
                    <span class="text-blue-400">
                        ⏰ @Detail.StartTime?.ToString("h:mm tt")
                    </span>
                }

                @if (Detail.DurationMinutes > 0)
                {
                    <span class="text-gray-500">
                        ⏳ @FormatDuration(Detail.DurationMinutes)
                    </span>
                }

                @if (Detail.ActualDurationMinutes > 0)
                {
                     <span class="@(Detail.ActualDurationMinutes > Detail.DurationMinutes ? "text-red-400" : "text-green-400")">
                        ✅ Act: @FormatDuration(Detail.ActualDurationMinutes)
                    </span>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggleComplete { get; set; }

    // CAST: Access the specific MeetingDetail property from the DTO
    private BulletMeetingDetail? Detail => Item.MeetingDetail;

    private string FormatDuration(int minutes)
    {
        if (minutes < 60) return $"{minutes}m";
        int h = minutes / 60;
        int m = minutes % 60;
        return m > 0 ? $"{h}h {m}m" : $"{h}h";
    }

    private async Task ToggleComplete()
    {
        if(Detail != null)
        {
            Detail.IsCompleted = !Detail.IsCompleted;
            await OnToggleComplete.InvokeAsync(Item);
        }
    }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}