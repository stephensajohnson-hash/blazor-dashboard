@namespace Dashboard.Components.Bullet
@using Dashboard

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-2 shadow-sm group relative flex items-stretch overflow-hidden transition hover:border-blue-500/50">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
        <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">‚úï</button>
    </div>

    <div class="shrink-0 bg-black/20 border-r border-gray-700 flex items-center justify-center relative overflow-hidden"
         style="width: @BulletViewConfig.ImgWidthDay;">
        @if (!string.IsNullOrEmpty(Item.ImgUrl))
        {
            <img src="@Item.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" />
        }
        else
        {
            <div class="text-2xl opacity-50">ü§ù</div>
        }
    </div>

    <div class="flex-1 flex min-w-0">
        
        <div class="shrink-0 pt-3 pl-3 pr-2 flex items-start">
            <input type="checkbox" 
                   checked="@(Detail?.IsCompleted ?? false)" 
                   @onchange="ToggleComplete" 
                   class="w-4 h-4 rounded bg-gray-800 border-gray-600 cursor-pointer accent-blue-500 hover:border-blue-400 transition" />
        </div>

        <div class="flex-1 py-2 pr-8 flex flex-col justify-center">
            <div class="truncate"> 
                <h4 class="text-sm font-bold text-white truncate @((Detail?.IsCompleted ?? false) ? "line-through text-gray-500" : "")">
                    @Item.Title
                </h4>
                @if (!string.IsNullOrWhiteSpace(Item.Description))
                {
                    <p class="text-xs text-gray-400 truncate">@Item.Description</p>
                }
            </div>

            <div class="flex items-center gap-3 mt-1.5 text-[10px] uppercase font-bold tracking-wider">
                @if(Detail != null)
                {
                    @if(Detail.StartTime != null)
                    {
                        <span class="text-blue-400">‚è∞ @Detail.StartTime?.ToString("h:mm tt")</span>
                    }
                    @if (Detail.DurationMinutes > 0)
                    {
                        <span class="text-gray-500">‚è≥ @FormatDuration(Detail.DurationMinutes)</span>
                    }
                    @if (Detail.ActualDurationMinutes > 0)
                    {
                         <span class="@(Detail.ActualDurationMinutes > Detail.DurationMinutes ? "text-red-400" : "text-green-400")">
                            ‚úÖ Actual: @FormatDuration(Detail.ActualDurationMinutes)
                        </span>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggle { get; set; }

    private BulletMeetingDetail? Detail => Item.MeetingDetail;

    private string FormatDuration(int minutes)
    {
        if (minutes < 60) return $"{minutes}m";
        int h = minutes / 60;
        int m = minutes % 60;
        return m > 0 ? $"{h}h {m}m" : $"{h}h";
    }

    private async Task ToggleComplete(ChangeEventArgs e)
    {
        if(Detail != null)
        {
            // Explicitly set value from event args
            Detail.IsCompleted = (bool)(e.Value ?? false);
            await OnToggle.InvokeAsync(Item);
        }
    }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}