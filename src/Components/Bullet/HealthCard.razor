@namespace Dashboard.Components.Bullet
@using Dashboard
@inject BulletHealthService HealthService

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-3 overflow-hidden shadow-lg group relative transition hover:border-emerald-500/50">
    
    <div class="px-4 py-3 border-b border-gray-700 bg-gray-900/50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider">üí™ Health Log</span>
            <span class="text-[10px] text-gray-500">@Item.Date.ToString("MMM dd")</span>
        </div>
        
        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
            <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md" title="Edit Daily Settings">‚öôÔ∏è</button>
            <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md" title="Delete Day">‚úï</button>
        </div>
    </div>

    <div class="p-4 space-y-6">
        
        <div>
            <div class="flex justify-between items-end mb-1">
                <div class="text-xs font-bold text-white">
                    @TotalIn.ToString("0") <span class="text-gray-500 font-normal">eaten</span>
                </div>
                <div class="text-xs font-bold text-gray-400">
                    @TargetCals.ToString("0") <span class="text-gray-500 font-normal">budget</span>
                </div>
            </div>
            
            <div class="h-4 w-full bg-gray-900 rounded-full border border-gray-700 overflow-hidden relative">
                <div class="absolute top-0 bottom-0 w-0.5 bg-white/20 z-10" style="left: @(Math.Min(100, (TargetCals / (TotalOut > 0 ? TotalOut : 2000)) * 100))%"></div>
                
                <div class="h-full transition-all duration-500 @(NetCalories > TargetCals ? "bg-red-500" : "bg-emerald-500")" 
                     style="width: @(TargetCals > 0 ? Math.Min(100, (TotalIn / TargetCals) * 100) : 0)%">
                </div>
            </div>

            <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                <span>Net: <b class="@(NetCalories > TargetCals ? "text-red-400" : "text-emerald-400")">@(NetCalories.ToString("0"))</b></span>
                <span>Out: <b>@TotalOut.ToString("0")</b></span>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-blue-400 mb-1">Protein</div>
                <div class="text-xs font-bold text-white mb-1">@TotalProtein.ToString("0") <span class="text-gray-600">/ @User.DailyProteinGoal</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500" style="width: @(Math.Min(100, (TotalProtein / (User.DailyProteinGoal > 0 ? User.DailyProteinGoal : 1)) * 100))%"></div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-yellow-400 mb-1">Fat</div>
                <div class="text-xs font-bold text-white mb-1">@TotalFat.ToString("0") <span class="text-gray-600">/ @User.DailyFatGoal</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-yellow-500" style="width: @(Math.Min(100, (TotalFat / (User.DailyFatGoal > 0 ? User.DailyFatGoal : 1)) * 100))%"></div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-green-400 mb-1">Carbs</div>
                <div class="text-xs font-bold text-white mb-1">@TotalCarbs.ToString("0") <span class="text-gray-600">/ @User.DailyCarbGoal</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500" style="width: @(Math.Min(100, (TotalCarbs / (User.DailyCarbGoal > 0 ? User.DailyCarbGoal : 1)) * 100))%"></div>
                </div>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                <h4 class="text-xs font-bold text-gray-400 uppercase">üçΩÔ∏è Meals</h4>
                <button @onclick="() => isAddingMeal = !isAddingMeal" class="text-[10px] bg-gray-700 hover:bg-emerald-600 text-white px-2 py-0.5 rounded transition">
                    @(isAddingMeal ? "Close" : "Ôºã Add Meal")
                </button>
            </div>

            @if(isAddingMeal)
            {
                <div class="bg-gray-900/80 p-3 rounded mb-2 border border-emerald-500/30">
                    <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Meal Name</label>
                    <input @bind="newMeal.Name" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-3" placeholder="e.g. Breakfast Eggs" />
                    
                    <div class="grid grid-cols-5 gap-2 mb-3">
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 text-center mb-1">Cals</label>
                            <input type="number" @bind="newMeal.Calories" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-blue-400 text-center mb-1">Prot</label>
                            <input type="number" @bind="newMeal.Protein" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-yellow-400 text-center mb-1">Fat</label>
                            <input type="number" @bind="newMeal.Fat" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-green-400 text-center mb-1">Carbs</label>
                            <input type="number" @bind="newMeal.Carbs" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-orange-300 text-center mb-1">Fiber</label>
                            <input type="number" @bind="newMeal.Fiber" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                    </div>

                    <button @onclick="AddMeal" class="w-full text-xs bg-emerald-600 hover:bg-emerald-500 text-white py-1.5 rounded font-bold transition">
                        Save Meal
                    </button>
                </div>
            }

            <div class="space-y-1">
                @foreach(var meal in Item.Meals)
                {
                    <div class="flex justify-between items-center text-xs group/item hover:bg-gray-700/30 p-1 rounded transition border-l-2 border-transparent hover:border-emerald-500">
                        <div class="flex-1 truncate">
                            <span class="text-white font-bold">@meal.Name</span>
                            <div class="text-[9px] text-gray-500 flex gap-2">
                                <span class="text-blue-400">P: @meal.Protein</span>
                                <span class="text-yellow-400">F: @meal.Fat</span>
                                <span class="text-green-400">C: @meal.Carbs</span>
                                <span class="text-orange-300">Fi: @meal.Fiber</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-white font-bold">@meal.Calories</span>
                            <button @onclick="() => DeleteMeal(meal)" class="text-gray-600 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition">‚úï</button>
                        </div>
                    </div>
                }
                @if(!Item.Meals.Any()) { <div class="text-[10px] text-gray-600 italic text-center py-2">No meals logged yet.</div> }
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                <h4 class="text-xs font-bold text-gray-400 uppercase">üî• Workouts</h4>
                <button @onclick="() => isAddingWorkout = !isAddingWorkout" class="text-[10px] bg-gray-700 hover:bg-orange-600 text-white px-2 py-0.5 rounded transition">
                    @(isAddingWorkout ? "Close" : "Ôºã Add Workout")
                </button>
            </div>

            @if(isAddingWorkout)
            {
                <div class="bg-gray-900/80 p-3 rounded mb-2 border border-orange-500/30">
                    <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Workout Name</label>
                    <input @bind="newWorkout.Name" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-3" placeholder="e.g. 30min Run" />
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-[9px] font-bold text-orange-400 text-center mb-1">Cals Burned</label>
                            <input type="number" @bind="newWorkout.CaloriesBurned" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-gray-400 text-center mb-1">Duration (min)</label>
                            <input type="number" @bind="newWorkout.TimeSpentMinutes" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                    </div>

                    <button @onclick="AddWorkout" class="w-full text-xs bg-orange-600 hover:bg-orange-500 text-white py-1.5 rounded font-bold transition">
                        Save Workout
                    </button>
                </div>
            }

            <div class="space-y-1">
                @foreach(var wo in Item.Workouts)
                {
                    <div class="flex justify-between items-center text-xs group/item hover:bg-gray-700/30 p-1 rounded transition border-l-2 border-transparent hover:border-orange-500">
                        <div class="flex-1 truncate">
                            <span class="text-white font-bold">@wo.Name</span>
                            <span class="text-[9px] text-gray-500 ml-1">(@wo.TimeSpentMinutes min)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-orange-400 font-bold">-@wo.CaloriesBurned</span>
                            <button @onclick="() => DeleteWorkout(wo)" class="text-gray-600 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition">‚úï</button>
                        </div>
                    </div>
                }
                @if(!Item.Workouts.Any()) { <div class="text-[10px] text-gray-600 italic text-center py-2">No workouts logged yet.</div> }
            </div>
        </div>

    </div>
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public User User { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private bool isAddingMeal = false;
    private bool isAddingWorkout = false;
    
    private BulletHealthMeal newMeal = new();
    private BulletHealthWorkout newWorkout = new();

    // CALCULATIONS
    private double TotalIn => Item.Meals.Sum(m => m.Calories);
    // Total Out = BMR/TDEE + Active Burn
    private double TotalOut => (Item.HealthDetail?.CalculatedTDEE ?? 2000) + Item.Workouts.Sum(w => w.CaloriesBurned);
    
    // Net Calories = In - Out. 
    // Usually "Net" means (In - Exercise) to see if you are under budget TDEE.
    // Let's stick to the visual bar logic: 
    // Target is TDEE - Deficit. 
    // Net displayed is typically (In - Exercise).
    
    private double NetCalories => TotalIn - Item.Workouts.Sum(w => w.CaloriesBurned);
    private double TargetCals => (Item.HealthDetail?.CalculatedTDEE ?? 2000) - (User.WeeklyCalorieDeficitGoal / 7.0);

    private double TotalProtein => Item.Meals.Sum(m => m.Protein);
    private double TotalCarbs => Item.Meals.Sum(m => m.Carbs);
    private double TotalFat => Item.Meals.Sum(m => m.Fat);

    private async Task AddMeal()
    {
        if (string.IsNullOrWhiteSpace(newMeal.Name)) return;
        newMeal.BulletItemId = Item.Id;
        Item.Meals.Add(newMeal);
        await SaveAll();
        newMeal = new();
        isAddingMeal = false;
    }

    private async Task DeleteMeal(BulletHealthMeal meal)
    {
        Item.Meals.Remove(meal);
        await SaveAll();
    }

    private async Task AddWorkout()
    {
        if (string.IsNullOrWhiteSpace(newWorkout.Name)) return;
        newWorkout.BulletItemId = Item.Id;
        Item.Workouts.Add(newWorkout);
        await SaveAll();
        newWorkout = new();
        isAddingWorkout = false;
    }

    private async Task DeleteWorkout(BulletHealthWorkout wo)
    {
        Item.Workouts.Remove(wo);
        await SaveAll();
    }

    private async Task SaveAll()
    {
        var dto = new BulletHealthService.HealthDTO
        {
            Id = Item.Id,
            UserId = Item.UserId,
            Type = "health",
            Category = Item.Category,
            Date = Item.Date,
            Title = Item.Title,
            Description = Item.Description,
            Detail = Item.HealthDetail ?? new(),
            Meals = Item.Meals,
            Workouts = Item.Workouts,
            Notes = Item.Notes
        };
        await HealthService.SaveHealth(dto);
        StateHasChanged();
    }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}