@namespace Dashboard.Components.Bullet
@using Dashboard

<div class="bg-emerald-900/20 border border-emerald-800 rounded-lg mb-3 relative group shadow-sm flex flex-col transition hover:border-emerald-500">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-30">
        <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-emerald-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">‚úï</button>
    </div>

    <div class="p-2 border-b border-emerald-800/50 bg-emerald-950/30 flex justify-between items-center">
        <div class="text-xs font-bold text-emerald-200">
            ‚öñÔ∏è @(Item.HealthDetail.WeightLbs > 0 ? $"{Item.HealthDetail.WeightLbs} lbs" : "No Weight")
        </div>
        
        @{
            var totalCals = Item.Meals.Sum(m => m.Calories);
            var burnedCals = Item.Workouts.Sum(w => w.CaloriesBurned);
            var tdee = Item.HealthDetail.CalculatedTDEE > 0 ? Item.HealthDetail.CalculatedTDEE : 2000;
            var net = totalCals - burnedCals;
            var deficit = tdee - net;
            string defColor = deficit > 0 ? "text-emerald-400" : "text-red-400";
        }
        <div class="text-[10px] font-mono @defColor">
            @(deficit > 0 ? "-" : "+")@Math.Abs(Math.Round(deficit)) kcal
        </div>
    </div>

    <div class="p-3">
        @{
            double p = Item.Meals.Sum(m => m.Protein);
            double c = Item.Meals.Sum(m => m.Carbs);
            double f = Item.Meals.Sum(m => m.Fat);
        }
        <div class="flex justify-between text-[10px] text-gray-400 mb-2 font-mono">
            <span>P: <span class="text-white">@Math.Round(p)</span>g</span>
            <span>C: <span class="text-white">@Math.Round(c)</span>g</span>
            <span>F: <span class="text-white">@Math.Round(f)</span>g</span>
            <span>Cal: <span class="text-white">@Math.Round(totalCals)</span></span>
        </div>

        <div class="space-y-1">
            @foreach(var meal in Item.Meals.Take(3))
            {
                <div class="flex justify-between items-center text-[10px] text-emerald-100/70 border-b border-emerald-900/30 pb-0.5 last:border-0">
                    <span class="truncate pr-2">@meal.Name</span>
                    <span class="shrink-0 text-emerald-500">@meal.Calories</span>
                </div>
            }
            @if(Item.Meals.Count > 3) { <div class="text-[9px] text-center text-gray-500 italic">+@(Item.Meals.Count - 3) more...</div> }
        </div>

        @if(Item.Workouts.Any())
        {
            <div class="mt-2 pt-2 border-t border-emerald-800/50">
                @foreach(var w in Item.Workouts)
                {
                    <div class="flex justify-between text-[10px] text-orange-300/80">
                        <span>üî• @w.Name</span>
                        <span>-@w.CaloriesBurned</span>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}