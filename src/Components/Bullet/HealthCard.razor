@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@inject BulletHealthService HealthService
@inject IServiceScopeFactory ScopeFactory

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-3 overflow-hidden shadow-lg group relative transition hover:border-emerald-500/50">
    
    <div class="px-4 py-3 border-b border-gray-700 bg-gray-900/50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider">üí™ Health Log</span>
        </div>
        
        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
            <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md" title="Edit Daily Settings">‚úèÔ∏è</button>
            <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md" title="Delete Day">‚úï</button>
        </div>
    </div>

    <div class="p-4 space-y-5">
        
        <div class="grid grid-cols-3 gap-2 bg-black/20 p-2 rounded-lg border border-gray-700/50">
            <div class="text-center border-r border-gray-700/50 flex flex-col justify-center">
                <div class="text-[9px] text-gray-500 uppercase font-bold">Weight</div>
                <div class="text-sm font-bold text-white">@(Item.HealthDetail?.WeightLbs ?? 0) <span class="text-[9px] text-gray-600 font-normal">lbs</span></div>
            </div>
            <div class="text-center border-r border-gray-700/50 flex flex-col justify-center">
                <div class="text-[9px] text-gray-500 uppercase font-bold leading-tight">Remaining Cal (Goal)</div>
                <div class="text-sm font-bold @(RemainingGoal < 0 ? "text-red-400" : "text-emerald-400")">@RemainingGoal.ToString("0")</div>
            </div>
            <div class="text-center flex flex-col justify-center">
                <div class="text-[9px] text-gray-500 uppercase font-bold leading-tight">Remaining Cal (TDEE)</div>
                <div class="text-sm font-bold @(RemainingTDEE < 0 ? "text-red-400" : "text-blue-400")">@RemainingTDEE.ToString("0")</div>
            </div>
        </div>

        <div class="space-y-3">
            
            <div>
                <div class="flex justify-between items-end mb-1 text-[10px]">
                    <span class="text-gray-400 font-bold">Weekly Deficit <span class="font-normal text-gray-600">(Mon - Today)</span></span>
                    <span class="text-gray-400">
                        <b class="@(WeeklyDeficit >= 0 ? "text-orange-400" : "text-red-400")">@WeeklyDeficit.ToString("0")</b> 
                        / @WeeklyGoal.ToString("0")
                    </span>
                </div>
                <div class="h-5 w-full bg-gray-900 rounded-full border border-gray-700 overflow-hidden relative">
                    <div class="absolute top-0 bottom-0 w-0.5 bg-gray-600 z-10" style="left: 0%"></div> 
                    
                    <div class="h-full transition-all duration-500 @(WeeklyDeficit >= 0 ? "bg-orange-600" : "bg-red-500")" 
                         style="width: @(Math.Min(100, Math.Max(0, (WeeklyDeficit / (WeeklyGoal > 0 ? WeeklyGoal : 1)) * 100)))%">
                    </div>
                    
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white shadow-black drop-shadow-md z-20">
                        @(Math.Min(100, Math.Max(0, (WeeklyDeficit / (WeeklyGoal > 0 ? WeeklyGoal : 1)) * 100)).ToString("0"))%
                    </div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-1 text-[10px]">
                    <span class="text-gray-400">Net Calories: <b class="text-white">@NetCalories.ToString("0")</b></span>
                    <span class="text-gray-400">Goal: <b class="text-white">@GoalLimit.ToString("0")</b></span>
                </div>
                <div class="h-5 w-full bg-gray-900 rounded-full border border-gray-700 overflow-hidden relative">
                    <div class="h-full transition-all duration-500 @(NetCalories > GoalLimit ? "bg-red-500" : "bg-emerald-600")" 
                         style="width: @(Math.Min(100, PercentGoal))%">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white shadow-black drop-shadow-md">
                        @PercentGoal.ToString("0")%
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-blue-400 mb-1">Protein</div>
                <div class="text-xs font-bold text-white mb-1">@TotalProtein.ToString("0") <span class="text-gray-600">/ @(User?.DailyProteinGoal ?? 150)</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500" style="width: @(Math.Min(100, (TotalProtein / ( (User?.DailyProteinGoal ?? 150) > 0 ? (User?.DailyProteinGoal ?? 150) : 1)) * 100))%"></div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-yellow-400 mb-1">Fat</div>
                <div class="text-xs font-bold text-white mb-1">@TotalFat.ToString("0") <span class="text-gray-600">/ @(User?.DailyFatGoal ?? 70)</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-yellow-500" style="width: @(Math.Min(100, (TotalFat / ((User?.DailyFatGoal ?? 70) > 0 ? (User?.DailyFatGoal ?? 70) : 1)) * 100))%"></div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700/50 text-center">
                <div class="text-[9px] uppercase font-bold text-green-400 mb-1">Net Carbs</div>
                <div class="text-xs font-bold text-white mb-1">@TotalNetCarbs.ToString("0") <span class="text-gray-600">/ @(User?.DailyCarbGoal ?? 200)</span></div>
                <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500" style="width: @(Math.Min(100, (TotalNetCarbs / ((User?.DailyCarbGoal ?? 200) > 0 ? (User?.DailyCarbGoal ?? 200) : 1)) * 100))%"></div>
                </div>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                <h4 class="text-xs font-bold text-gray-400 uppercase">üçΩÔ∏è Meals</h4>
                <button @onclick="ToggleMealForm" class="text-[10px] bg-gray-700 hover:bg-emerald-600 text-white px-2 py-0.5 rounded transition">
                    @(isAddingMeal ? "Close" : "Ôºã Add Meal")
                </button>
            </div>

            @if(isAddingMeal)
            {
                <div class="bg-gray-900/80 p-3 rounded mb-2 border border-emerald-500/30">
                    <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Meal Name</label>
                    <input @bind="tempMeal.Name" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-2" placeholder="e.g. Breakfast Eggs" />
                    
                    <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Type</label>
                    <select @bind="tempMeal.MealType" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-3">
                        <option value="Breakfast">Breakfast</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Dinner">Dinner</option>
                        <option value="Snack">Snack</option>
                    </select>

                    <div class="grid grid-cols-5 gap-2 mb-3">
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 text-center mb-1">Cals</label>
                            <input type="number" @bind="tempMeal.Calories" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-blue-400 text-center mb-1">Prot</label>
                            <input type="number" @bind="tempMeal.Protein" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-yellow-400 text-center mb-1">Fat</label>
                            <input type="number" @bind="tempMeal.Fat" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-green-400 text-center mb-1">Carbs</label>
                            <input type="number" @bind="tempMeal.Carbs" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-orange-300 text-center mb-1">Fiber</label>
                            <input type="number" @bind="tempMeal.Fiber" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                    </div>

                    <button @onclick="SaveMeal" class="w-full text-xs bg-emerald-600 hover:bg-emerald-500 text-white py-1.5 rounded font-bold transition">
                        @(editingMeal != null ? "Update Meal" : "Save New Meal")
                    </button>
                </div>
            }

            <div class="space-y-2">
                @foreach(var meal in Item.Meals)
                {
                    <div class="text-xs group/item hover:bg-gray-700/30 p-2 rounded transition border border-gray-800 hover:border-emerald-500/30 cursor-pointer" @onclick="() => EditMeal(meal)">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex flex-col">
                                @if(!string.IsNullOrEmpty(meal.MealType))
                                {
                                    <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wide">@meal.MealType</span>
                                }
                                <span class="text-white font-bold text-sm">@meal.Name</span>
                            </div>
                            <div class="flex gap-2 items-center">
                                <span class="font-mono text-white font-bold bg-gray-700 px-1.5 rounded text-[10px]">@meal.Calories Cals</span>
                                <button @onclick="() => OnCopyMeal.InvokeAsync(meal)" @onclick:stopPropagation="true" class="text-blue-400 hover:text-white transition" title="Copy to another day">Ôºãüìã</button>
                                <button @onclick="() => DeleteMeal(meal)" @onclick:stopPropagation="true" class="text-gray-600 hover:text-red-500 px-1">‚úï</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-x-3 gap-y-1 text-[10px] text-gray-400">
                            <span>Protein: <b class="text-blue-400">@meal.Protein</b></span>
                            <span>Fat: <b class="text-yellow-400">@meal.Fat</b></span>
                            <span>Carbs: <b class="text-green-400">@meal.Carbs</b></span>
                            <span>Fiber: <b class="text-orange-300">@meal.Fiber</b></span>
                            <span>Net Carbs: <b class="text-emerald-400">@(meal.Carbs - meal.Fiber)</b></span>
                        </div>
                    </div>
                }
                @if(!Item.Meals.Any()) { <div class="text-[10px] text-gray-600 italic text-center py-2">No meals logged yet.</div> }
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                <h4 class="text-xs font-bold text-gray-400 uppercase">üî• Workouts</h4>
                <button @onclick="ToggleWorkoutForm" class="text-[10px] bg-gray-700 hover:bg-orange-600 text-white px-2 py-0.5 rounded transition">
                    @(isAddingWorkout ? "Close" : "Ôºã Add Workout")
                </button>
            </div>

            @if(isAddingWorkout)
            {
                <div class="bg-gray-900/80 p-3 rounded mb-2 border border-orange-500/30">
                    <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Workout Name</label>
                    <input @bind="tempWorkout.Name" class="w-full bg-black border border-gray-600 rounded px-2 py-1 text-xs text-white mb-3" placeholder="e.g. 30min Run" />
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-[9px] font-bold text-orange-400 text-center mb-1">Cals Burned</label>
                            <input type="number" @bind="tempWorkout.CaloriesBurned" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-gray-400 text-center mb-1">Duration (min)</label>
                            <input type="number" @bind="tempWorkout.TimeSpentMinutes" class="w-full bg-black border border-gray-600 rounded px-1 py-1 text-xs text-white text-center" />
                        </div>
                    </div>

                    <button @onclick="SaveWorkout" class="w-full text-xs bg-orange-600 hover:bg-orange-500 text-white py-1.5 rounded font-bold transition">
                        @(editingWorkout != null ? "Update Workout" : "Save New Workout")
                    </button>
                </div>
            }

            <div class="space-y-1">
                @foreach(var wo in Item.Workouts)
                {
                    <div class="flex justify-between items-center text-xs group/item hover:bg-gray-700/30 p-1 rounded transition border-l-2 border-transparent hover:border-orange-500">
                        <div class="flex-1 truncate">
                            <span class="text-white font-bold">@wo.Name</span>
                            <span class="text-[9px] text-gray-500 ml-1">(@wo.TimeSpentMinutes min)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-orange-400 font-bold">-@wo.CaloriesBurned</span>
                            <button @onclick="() => OnCopyWorkout.InvokeAsync(wo)" @onclick:stopPropagation="true" class="text-blue-400 hover:text-white transition" title="Copy to another day">Ôºãüìã</button>
                            <button @onclick="() => DeleteWorkout(wo)" class="text-gray-600 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition">‚úï</button>
                        </div>
                    </div>
                }
                @if(!Item.Workouts.Any()) { <div class="text-[10px] text-gray-600 italic text-center py-2">No workouts logged yet.</div> }
            </div>
        </div>

    </div>
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public User User { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<BulletHealthMeal> OnCopyMeal { get; set; }
    [Parameter] public EventCallback<BulletHealthWorkout> OnCopyWorkout { get; set; }

    private bool isAddingMeal = false;
    private bool isAddingWorkout = false;
    
    private BulletHealthMeal tempMeal = new();
    private BulletHealthMeal? editingMeal = null;
    private BulletHealthWorkout tempWorkout = new();
    private BulletHealthWorkout? editingWorkout = null;

    private double WeeklyDeficit = 0;
    
    // Safety check consolidated here
    public int WeeklyGoal => User?.WeeklyCalorieDeficitGoal ?? 3500;

    protected override async Task OnParametersSetAsync()
    {
        double tempWeeklyDeficit = 0; 

        using (var scope = ScopeFactory.CreateScope())
        {
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            int diff = (7 + (Item.Date.DayOfWeek - DayOfWeek.Monday)) % 7;
            var startOfWeek = Item.Date.AddDays(-1 * diff).Date;
            var endOfRange = Item.Date.Date.AddDays(1).AddSeconds(-1); 

            var weekItems = await db.BulletItems
                .Where(i => i.UserId == Item.UserId && i.Type == "health" && i.Date >= startOfWeek && i.Date <= endOfRange)
                .Select(i => new { i.Id, i.Date })
                .OrderBy(i => i.Date)
                .ToListAsync();

            if (weekItems.Any())
            {
                foreach(var day in weekItems)
                {
                    double dayTDEE, dayFood, dayBurn;

                    if (day.Id == Item.Id)
                    {
                        double currentWeight = Item.HealthDetail?.WeightLbs ?? 0;
                        dayTDEE = (Item.HealthDetail?.CalculatedTDEE > 0) ? Item.HealthDetail.CalculatedTDEE : CalculateFallbackTDEE(currentWeight);
                        dayFood = Item.Meals.Sum(m => m.Calories);
                        dayBurn = Item.Workouts.Sum(w => w.CaloriesBurned);
                    }
                    else
                    {
                        var details = await db.BulletHealthDetails.FirstOrDefaultAsync(d => d.BulletItemId == day.Id);
                        double dbWeight = details?.WeightLbs ?? 0;
                        dayTDEE = (details != null && details.CalculatedTDEE > 0) ? details.CalculatedTDEE : CalculateFallbackTDEE(dbWeight);
                        dayFood = await db.BulletHealthMeals.Where(m => m.BulletItemId == day.Id).SumAsync(m => m.Calories);
                        dayBurn = await db.BulletHealthWorkouts.Where(w => w.BulletItemId == day.Id).SumAsync(w => w.CaloriesBurned);
                    }

                    double dayDeficit = (dayTDEE + dayBurn) - dayFood;
                    tempWeeklyDeficit += dayDeficit;
                }
            }
        }
        
        WeeklyDeficit = tempWeeklyDeficit;
        StateHasChanged();
    }

    private double CalculateFallbackTDEE(double weightLbs)
    {
        double w = weightLbs > 0 ? weightLbs : 200; 
        double kg = w / 2.20462;
        double cm = 178; 
        int age = 40;    
        
        if (User != null && User.HeightInches > 0) cm = User.HeightInches * 2.54;
        if (User != null && User.Age > 0) age = User.Age;

        double bmr = (10 * kg) + (6.25 * cm) - (5 * age) + 5; 
        return bmr * 1.2; 
    }

    private double TotalIn => Item.Meals.Sum(m => m.Calories);
    private double Burned => Item.Workouts.Sum(w => w.CaloriesBurned);
    
    private double TDEE 
    {
        get 
        {
            if (Item.HealthDetail?.CalculatedTDEE > 0) return Item.HealthDetail.CalculatedTDEE;
            return CalculateFallbackTDEE(Item.HealthDetail?.WeightLbs ?? 0);
        }
    }
    
    private double DailyDeficitGoal => WeeklyGoal / 7.0;
    private double GoalLimit => TDEE - DailyDeficitGoal;
    private double NetCalories => TotalIn - Burned;
    private double RemainingGoal => GoalLimit - NetCalories;
    private double RemainingTDEE => TDEE - NetCalories;
    private double PercentGoal => GoalLimit > 0 ? (NetCalories / GoalLimit) * 100 : 0;

    private double TotalProtein => Item.Meals.Sum(m => m.Protein);
    private double TotalCarbs => Item.Meals.Sum(m => m.Carbs);
    private double TotalFat => Item.Meals.Sum(m => m.Fat);
    private double TotalFiber => Item.Meals.Sum(m => m.Fiber);
    private double TotalNetCarbs => TotalCarbs - TotalFiber;

    private void ToggleMealForm() { isAddingMeal = !isAddingMeal; if(!isAddingMeal) { tempMeal = new(); editingMeal = null; } }
    
    private void EditMeal(BulletHealthMeal meal) 
    { 
        editingMeal = meal; 
        tempMeal = new BulletHealthMeal 
        { 
            Id = meal.Id, 
            BulletItemId = meal.BulletItemId, 
            Name = meal.Name, 
            Calories = meal.Calories, 
            Protein = meal.Protein, 
            Fat = meal.Fat, 
            Carbs = meal.Carbs, 
            Fiber = meal.Fiber,
            MealType = meal.MealType 
        }; 
        isAddingMeal = true; 
    }

    private async Task SaveMeal() 
    { 
        if (string.IsNullOrWhiteSpace(tempMeal.Name)) return; 
        
        if (editingMeal != null) 
        { 
            editingMeal.Name = tempMeal.Name; 
            editingMeal.Calories = tempMeal.Calories; 
            editingMeal.Protein = tempMeal.Protein; 
            editingMeal.Fat = tempMeal.Fat; 
            editingMeal.Carbs = tempMeal.Carbs; 
            editingMeal.Fiber = tempMeal.Fiber;
            editingMeal.MealType = tempMeal.MealType;
        } 
        else 
        { 
            tempMeal.BulletItemId = Item.Id; 
            if(string.IsNullOrEmpty(tempMeal.MealType)) tempMeal.MealType = "Breakfast";
            Item.Meals.Add(tempMeal); 
        } 
        
        await SaveAll(); 
        tempMeal = new(); 
        editingMeal = null; 
        isAddingMeal = false; 
    }

    private async Task DeleteMeal(BulletHealthMeal meal) { Item.Meals.Remove(meal); await SaveAll(); }

    private void ToggleWorkoutForm() { isAddingWorkout = !isAddingWorkout; if(!isAddingWorkout) { tempWorkout = new(); editingWorkout = null; } }
    private async Task SaveWorkout() { if (string.IsNullOrWhiteSpace(tempWorkout.Name)) return; if (editingWorkout != null) { editingWorkout.Name = tempWorkout.Name; editingWorkout.CaloriesBurned = tempWorkout.CaloriesBurned; editingWorkout.TimeSpentMinutes = tempWorkout.TimeSpentMinutes; } else { tempWorkout.BulletItemId = Item.Id; Item.Workouts.Add(tempWorkout); } await SaveAll(); tempWorkout = new(); editingWorkout = null; isAddingWorkout = false; }
    private async Task DeleteWorkout(BulletHealthWorkout wo) { Item.Workouts.Remove(wo); await SaveAll(); }

    private async Task SaveAll()
    {
        var dto = new BulletHealthService.HealthDTO
        {
            Id = Item.Id, UserId = Item.UserId, Type = "health", Category = Item.Category, Date = Item.Date, Title = Item.Title, Description = Item.Description,
            Detail = Item.HealthDetail ?? new(), Meals = Item.Meals, Workouts = Item.Workouts, Notes = Item.Notes
        };
        await HealthService.SaveHealth(dto);
        StateHasChanged();
    }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}