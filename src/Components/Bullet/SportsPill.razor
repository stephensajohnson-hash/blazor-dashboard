@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ScopeFactory

<div class="flex items-center gap-2 bg-gray-800/80 border border-gray-700 rounded px-2 py-1.5 cursor-pointer hover:bg-gray-700 transition group mb-1" 
     @onclick="HandleClick">
    
    @* TIME / STATUS *@
    <div class="text-[10px] font-bold text-gray-400 w-8 shrink-0 text-center leading-tight">
        @if(Item.Detail.IsComplete) { <span>FIN</span> }
        else { @Item.Detail.StartTime?.ToString("h:mm") }
    </div>

    @* TEAMS & LOGOS *@
    <div class="flex-1 flex flex-col justify-center min-w-0 gap-0.5">
        @* AWAY TEAM ROW *@
        <div class="flex justify-between items-center text-xs">
            <div class="flex items-center gap-1.5 truncate">
                @if(!string.IsNullOrEmpty(AwayTeam?.LogoUrl)) 
                { 
                    <img src="@AwayTeam.LogoUrl" class="w-4 h-4 object-contain shrink-0 filter drop-shadow-sm" /> 
                }
                <span class="@(IsFavorite(AwayTeam) ? "text-yellow-400 font-black" : "text-gray-300 font-bold") truncate">
                    @AwayTeam?.Abbreviation
                </span>
            </div>
            @if(Item.Detail.IsComplete || Item.Detail.AwayScore > 0) 
            { 
                <span class="font-mono font-bold text-white text-[10px]">@Item.Detail.AwayScore</span> 
            }
        </div>

        @* HOME TEAM ROW *@
        <div class="flex justify-between items-center text-xs">
            <div class="flex items-center gap-1.5 truncate">
                @if(!string.IsNullOrEmpty(HomeTeam?.LogoUrl)) 
                { 
                    <img src="@HomeTeam.LogoUrl" class="w-4 h-4 object-contain shrink-0 filter drop-shadow-sm" /> 
                }
                <span class="@(IsFavorite(HomeTeam) ? "text-yellow-400 font-black" : "text-gray-300 font-bold") truncate">
                    @HomeTeam?.Abbreviation
                </span>
            </div>
            @if(Item.Detail.IsComplete || Item.Detail.HomeScore > 0) 
            { 
                <span class="font-mono font-bold text-white text-[10px]">@Item.Detail.HomeScore</span> 
            }
        </div>
    </div>

    @* RESULT STAMP *@
    @if(ResultState != 0)
    {
        <div class="shrink-0 ml-1">
            <span class="text-[9px] font-black uppercase border px-1 rounded transform -rotate-6 shadow-md @GetStampClass()">
                @GetStampText()
            </span>
        </div>
    }

    @* MOVE BUTTONS (HOVER) *@
    <div class="hidden group-hover:flex flex-col items-center justify-center gap-1 pl-2 border-l border-gray-700 ml-1">
        <button @onclick="MoveUp" @onclick:stopPropagation="true" class="text-gray-500 hover:text-blue-400 transition-colors">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/></svg>
        </button>
        <button @onclick="MoveDown" @onclick:stopPropagation="true" class="text-gray-500 hover:text-blue-400 transition-colors">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
        </button>
    </div>
</div>

@code {
    [Parameter] public BulletSportsService.GameDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnMoveUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveDown { get; set; }

    private Team? HomeTeam;
    private Team? AwayTeam;

    protected override async Task OnParametersSetAsync()
    {
        using (var scope = ScopeFactory.CreateScope())
        {
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            if (Item.Detail.HomeTeamId > 0) HomeTeam = await db.Teams.FindAsync(Item.Detail.HomeTeamId);
            if (Item.Detail.AwayTeamId > 0) AwayTeam = await db.Teams.FindAsync(Item.Detail.AwayTeamId);
        }
    }

    private bool IsFavorite(Team? t) => t?.IsFavorite ?? false;

    private int ResultState 
    {
        get 
        {
            if (!Item.Detail.IsComplete) return 0;
            bool hFav = IsFavorite(HomeTeam), aFav = IsFavorite(AwayTeam);
            if (!hFav && !aFav) return 0;
            if (Item.Detail.HomeScore == Item.Detail.AwayScore) return 3;
            if (hFav) return Item.Detail.HomeScore > Item.Detail.AwayScore ? 1 : 2;
            if (aFav) return Item.Detail.AwayScore > Item.Detail.HomeScore ? 1 : 2;
            return 0;
        }
    }

    private string GetStampText() => ResultState switch { 1 => "W", 2 => "L", 3 => "T", _ => "" };
    private string GetStampClass() => ResultState switch {
        1 => "text-green-400 border-green-500 bg-green-900/40",
        2 => "text-red-400 border-red-500 bg-red-900/40",
        3 => "text-yellow-400 border-yellow-500 bg-yellow-900/40",
        _ => "hidden"
    };

    private async Task HandleClick() 
    {
        var taskDto = new BulletTaskService.TaskDTO { 
            Id = Item.Id, UserId = Item.UserId, Type = "sports", Date = Item.Date, 
            Title = Item.Title, Description = Item.Description, SportsDetail = Item.Detail, Category = Item.Category 
        };
        await OnClick.InvokeAsync(taskDto); 
    }

    private async Task MoveUp() => await OnMoveUp.InvokeAsync(Item.Id);
    private async Task MoveDown() => await OnMoveDown.InvokeAsync(Item.Id);
}