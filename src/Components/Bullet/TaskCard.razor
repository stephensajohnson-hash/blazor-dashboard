@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Web

<div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden mb-3 relative group hover:border-blue-500 transition shadow-sm">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
        <button @onclick="HandleClick" @onclick:stopPropagation="true" class="p-1 rounded bg-gray-800/80 hover:bg-blue-600 text-gray-400 hover:text-white transition shadow-md" title="Edit">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" @onclick:stopPropagation="true" class="p-1 rounded bg-gray-800/80 hover:bg-red-600 text-red-400 hover:text-white transition shadow-md" title="Delete">‚ùå</button>
    </div>

    <div class="flex p-0 relative">
        @if(!string.IsNullOrEmpty(Task.ImgUrl)) {
            @if(!string.IsNullOrEmpty(Task.LinkUrl)) {
                 <a href="@Task.LinkUrl" target="_blank" class="relative bg-black shrink-0 block z-10 hover:opacity-80 transition" style="width: @BulletViewConfig.ImgWidthDay;" @onclick:stopPropagation="true">
                    <img src="@Task.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" />
                </a>
            } else {
                 <div class="relative bg-black shrink-0 cursor-pointer z-10" style="width: @BulletViewConfig.ImgWidthDay;" @onclick="HandleClick">
                    <img src="@Task.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" />
                </div>
            }
        }
        
        <div class="p-3 flex-1 min-w-0 relative cursor-pointer" @onclick="HandleClick">
            <div class="flex items-start gap-3">
                @if(Task.Type == "task") {
                    <input type="checkbox" checked="@Task.Detail.IsCompleted" @onchange="HandleToggle" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer z-10" />
                } else if(Task.Type == "meeting") {
                    <span class="mt-1 text-xs">üïí</span>
                }
                
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold leading-tight @(Task.Detail.IsCompleted && Task.Type == "task" ? "line-through text-gray-500" : "text-white")">
                         @if(!string.IsNullOrEmpty(Task.LinkUrl)) {
                             <a href="@Task.LinkUrl" target="_blank" class="hover:text-blue-400 transition" @onclick:stopPropagation="true">@Task.Title</a>
                         } else {
                             @Task.Title
                         }
                    </h4>
                    
                    @if(!string.IsNullOrEmpty(Task.Description)) { <p class="text-xs text-gray-500 mt-1 line-clamp-2">@Task.Description</p> }
                    
                    <div class="flex gap-2 mt-2 flex-wrap">
                        @if (Task.Type == "meeting" && Task.MeetingDetail.StartTime.HasValue) {
                             <span class="text-[9px] bg-purple-900/30 text-purple-300 border border-purple-800 px-1.5 py-0.5 rounded uppercase tracking-wider">
                                @Task.MeetingDetail.StartTime.Value.ToString("h:mm tt") (@Task.MeetingDetail.DurationMinutes m)
                            </span>
                        }
                        
                        @if(Task.Type == "task") {
                            @if(!string.IsNullOrEmpty(Task.Detail.TicketUrl)) {
                                 <a href="@Task.Detail.TicketUrl" target="_blank" @onclick:stopPropagation="true" class="text-[9px] bg-blue-900/30 text-blue-300 border border-blue-800 px-1.5 py-0.5 rounded uppercase tracking-wider hover:bg-blue-800 transition z-10">
                                    @(string.IsNullOrEmpty(Task.Detail.TicketNumber) ? "Ticket ‚Üó" : Task.Detail.TicketNumber)
                                </a>
                            } else if(!string.IsNullOrEmpty(Task.Detail.TicketNumber)) { 
                                <span class="text-[9px] bg-blue-900/30 text-blue-300 border border-blue-800 px-1.5 py-0.5 rounded uppercase tracking-wider">
                                    @Task.Detail.TicketNumber
                                </span> 
                            }
                            @if(Task.Detail.Priority == "High") { <span class="text-[9px] bg-red-900/30 text-red-300 border border-red-800 px-1.5 py-0.5 rounded uppercase tracking-wider">High</span> }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if(Task.Notes.Any()) {
        <div class="bg-black/20 border-t border-gray-800 p-2 space-y-2">
            @foreach(var note in Task.Notes) {
                @if(!string.IsNullOrEmpty(note.LinkUrl)) {
                    <a href="@note.LinkUrl" target="_blank" @onclick:stopPropagation="true" class="block bg-gray-800/50 rounded p-2 clearfix hover:bg-gray-800 transition relative z-10 border border-transparent hover:border-gray-700">
                        @RenderNoteContent(note)
                    </a>
                } else {
                    <div class="block bg-gray-800/50 rounded p-2 clearfix relative z-10">
                        @RenderNoteContent(note)
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Task { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggle { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private async Task HandleClick() => await OnClick.InvokeAsync(Task);
    private async Task HandleToggle() => await OnToggle.InvokeAsync(Task);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Task.Id);

    private RenderFragment RenderNoteContent(BulletItemNote note) => __builder => {
        if(!string.IsNullOrEmpty(note.ImgUrl)) {
            <img src="@note.ImgUrl" class="float-left w-16 h-16 object-cover rounded mr-2 mb-1 border border-gray-700" />
        }
        <p class="text-xs text-gray-300 whitespace-pre-wrap leading-snug">@note.Content</p>
    };
}