@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Web

<div class="@BorderClass border rounded-lg overflow-hidden mb-3 relative group transition shadow-sm bg-gray-900">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
        <button @onclick="OnEdit" @onclick:stopPropagation="true" class="p-1 rounded bg-gray-800/90 hover:bg-blue-600 text-gray-400 hover:text-white transition shadow-md">✏️</button>
        <button @onclick="OnDelete" @onclick:stopPropagation="true" class="p-1 rounded bg-gray-800/90 hover:bg-red-600 text-red-400 hover:text-white transition shadow-md">✕</button>
    </div>

    <div class="flex p-0 relative">
        @if(!string.IsNullOrEmpty(Item.ImgUrl)) {
            <div class="relative bg-black shrink-0 cursor-pointer z-10" style="width: @BulletViewConfig.ImgWidthDay;" @onclick="OnEdit">
                <img src="@Item.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" />
            </div>
        }
        
        <div class="p-3 flex-1 min-w-0 relative cursor-pointer" @onclick="OnEdit">
            <div class="flex items-start gap-3">
                
                <div class="shrink-0 mt-0.5 z-20">
                    <input type="checkbox" checked="@IsCompleted" @onchange="HandleToggle" @onclick:stopPropagation="true" class="w-4 h-4 rounded bg-gray-800 border-gray-600 cursor-pointer" />
                </div>
                
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold leading-tight @(IsCompleted ? "line-through text-gray-500" : "text-white")">
                         @if(!string.IsNullOrEmpty(Item.LinkUrl)) {
                             <a href="@Item.LinkUrl" target="_blank" class="hover:text-blue-400 transition" @onclick:stopPropagation="true">@Item.Title</a>
                         } else { @Item.Title }
                    </h4>
                    
                    @if(!string.IsNullOrEmpty(Item.Description)) { <p class="text-xs text-gray-500 mt-1 line-clamp-2">@Item.Description</p> }
                    
                    <div class="flex gap-2 mt-2 flex-wrap">
                        @ChildContent
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if(Notes != null && Notes.Any()) {
        <div class="bg-black/20 border-t border-gray-800 p-2 space-y-2">
            @foreach(var note in Notes) {
                <div class="block bg-gray-800/50 rounded p-2 clearfix relative z-10 border border-transparent hover:border-gray-700">
                    @if(!string.IsNullOrEmpty(note.ImgUrl)) { <img src="@note.ImgUrl" class="float-left w-12 h-12 object-cover rounded mr-2 mb-1 border border-gray-700" /> }
                    <p class="text-xs text-gray-300 whitespace-pre-wrap leading-snug">@note.Content</p>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public BulletItem Item { get; set; } = new();
    [Parameter] public List<BulletItemNote> Notes { get; set; } = new();
    [Parameter] public bool IsCompleted { get; set; }
    [Parameter] public string BorderClass { get; set; } = "border-gray-700";
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback<bool> OnToggle { get; set; }

    private async Task HandleToggle(ChangeEventArgs e) => await OnToggle.InvokeAsync((bool)(e.Value ?? false));
}