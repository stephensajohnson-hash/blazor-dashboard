@namespace Dashboard.Components.Bullet
@using Dashboard

@if (Mode == "Card")
{
    <div class="relative group font-black">
        @* Directional and Action Controls *@
        <div class="absolute right-1 top-1/2 -translate-y-1/2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-50">
            <button @onclick="HandleMoveUp" 
                    @onclick:stopPropagation="true" 
                    class="p-1.5 bg-black/60 border border-white/10 rounded hover:bg-blue-600 text-[8px] shadow-2xl">
                â–²
            </button>
            
            <button @onclick="HandleCopy" 
                    @onclick:stopPropagation="true" 
                    class="p-1.5 bg-black/60 border border-white/10 rounded hover:bg-green-600 text-[8px] shadow-2xl"
                    title="Copy to another day">
                ðŸ“‹
            </button>

            <button @onclick="HandleMoveDown" 
                    @onclick:stopPropagation="true" 
                    class="p-1.5 bg-black/60 border border-white/10 rounded hover:bg-blue-600 text-[8px] shadow-2xl">
                â–¼
            </button>
        </div>

        @if (Item.Type == "meeting") 
        { 
            <MeetingCard Item="Item" OnClick="OnEdit" OnToggle="OnToggle" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "habit") 
        { 
            <HabitCard Item="@GetHabitDto()" OnClick="HandleHabitEdit" OnDelete="HandleDelete" OnChange="OnHabitDirectSave" /> 
        }
        else if (Item.Type == "birthday") 
        { 
            <BirthdayCard Item="Item" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "holiday") 
        { 
            <HolidayCard Item="Item" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "anniversary") 
        { 
            <AnniversaryCard Item="Item" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "vacation") 
        { 
            <VacationCard Item="Item" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "health") 
        { 
            <HealthCard Item="Item" User="User" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "media") 
        { 
            <MediaCard Item="Item" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else if (Item.Type == "sports") 
        { 
            <SportsCard Item="@GetSportsDto()" OnClick="OnEdit" OnDelete="HandleDelete" /> 
        }
        else 
        { 
            <TaskCard Item="Item" OnClick="OnEdit" OnToggle="OnToggle" OnDelete="HandleDelete" /> 
        }
    </div>
}
else
{
    @* Pill Mode for Week/Month Views *@
    <div class="relative group font-black">
        @* Quick Copy Button for Pills *@
        <button @onclick="HandleCopy" 
                @onclick:stopPropagation="true" 
                class="absolute -left-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-800 border border-gray-700 rounded p-1 text-[8px] hover:bg-green-600 z-50">
            ðŸ“‹
        </button>

        @if (Item.Type == "sports") 
        {
            <SportsPill Item="@GetSportsDto()" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" />
        }
        else if (Item.Type == "meeting") 
        { 
            <MeetingPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "habit") 
        { 
            <HabitPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "media") 
        { 
            <MediaPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "holiday") 
        { 
            <HolidayPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "birthday") 
        { 
            <BirthdayPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "anniversary") 
        { 
            <AnniversaryPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "vacation") 
        { 
            <VacationPill Item="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
        else if (Item.Type == "health") 
        { 
            <HealthPill Item="Item" User="User" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" /> 
        }
        else 
        { 
            <TaskPill Task="Item" OnClick="OnEdit" OnMoveUp="HandleMoveUpPill" OnMoveDown="HandleMoveDownPill" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> 
        }
    </div>
}

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public string Mode { get; set; } = "Card";
    [Parameter] public User? User { get; set; }

    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnEdit { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggle { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnCopyRequest { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<int> OnMoveUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveDown { get; set; }
    [Parameter] public EventCallback<BulletHabitService.HabitDTO> OnHabitSave { get; set; }

    private async Task HandleMoveUp()
    {
        await OnMoveUp.InvokeAsync(Item.Id);
    }

    private async Task HandleMoveDown()
    {
        await OnMoveDown.InvokeAsync(Item.Id);
    }

    private async Task HandleMoveUpPill()
    {
        await OnMoveUp.InvokeAsync(Item.Id);
    }

    private async Task HandleMoveDownPill()
    {
        await OnMoveDown.InvokeAsync(Item.Id);
    }

    private async Task HandleCopy()
    {
        await OnCopyRequest.InvokeAsync(Item);
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Item.Id);
    }

    private async Task HandleHabitEdit()
    {
        await OnEdit.InvokeAsync(Item);
    }

    private async Task OnHabitDirectSave(BulletHabitService.HabitDTO h)
    {
        await OnHabitSave.InvokeAsync(h);
    }

    private BulletSportsService.GameDTO GetSportsDto()
    {
        return new BulletSportsService.GameDTO
        {
            Id = Item.Id,
            UserId = Item.UserId,
            Category = Item.Category,
            Date = Item.Date,
            Title = Item.Title,
            Description = Item.Description,
            SortOrder = Item.SortOrder,
            Detail = Item.SportsDetail ?? new(),
            ImgUrl = Item.ImgUrl,
            LinkUrl = Item.LinkUrl
        };
    }

    private BulletHabitService.HabitDTO GetHabitDto()
    {
        return new BulletHabitService.HabitDTO
        {
            Id = Item.Id,
            UserId = Item.UserId,
            Category = Item.Category,
            Date = Item.Date,
            Title = Item.Title,
            Description = Item.Description,
            SortOrder = Item.SortOrder,
            Detail = Item.HabitDetail ?? new(),
            ImgUrl = Item.ImgUrl,
            Notes = Item.Notes ?? new List<BulletItemNote>(),
            Todos = Item.Todos ?? new List<BulletTaskTodoItem>()
        };
    }
}