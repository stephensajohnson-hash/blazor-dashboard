@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject BulletBaseService BaseService

@if (Task != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
            
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white">@(Task.Id == 0 ? "New Task" : "Edit Task")</h3>
                <button @onclick="Cancel" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            
            <div class="p-6 space-y-4 overflow-y-auto flex gap-6">
                
                <div class="w-1/3 space-y-4">
                    <div class="w-full aspect-square bg-black border border-gray-700 rounded-lg overflow-hidden flex items-center justify-center relative group">
                        @if(!string.IsNullOrEmpty(Task.ImgUrl)) {
                            <img src="@Task.ImgUrl" class="w-full h-full object-cover" />
                        } else {
                            <span class="text-gray-600 text-4xl">ðŸ“·</span>
                        }
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Upload Image</label>
                        <InputFile OnChange="HandleFile" class="text-xs text-gray-400 w-full" />
                        
                        <div class="text-center text-gray-600 text-xs my-1">- OR -</div>
                        
                        <label class="block text-xs font-bold text-gray-500 uppercase">Image URL</label>
                        <input @bind="Task.ImgUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-1.5 text-white text-xs" placeholder="https://..." />
                    </div>
                </div>

                <div class="flex-1 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                        <input @bind="Task.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                            <input type="date" @bind="Task.Date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                            <select @bind="Task.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="health">Health</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticket #</label>
                            <input @bind="Task.Detail.TicketNumber" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label>
                            <select @bind="Task.Detail.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                <option>Low</option>
                                <option>Normal</option>
                                <option>High</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notes</label>
                        <textarea @bind="Task.Description" rows="4" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"></textarea>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-between">
                @if(Task.Id > 0) {
                    <button @onclick="Delete" class="px-4 py-2 text-red-400 hover:text-red-300 text-sm font-bold hover:bg-red-900/20 rounded">Delete</button>
                } else { <div></div> }
                
                <div class="flex gap-3">
                    <button @onclick="Cancel" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button>
                    <button @onclick="Save" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save Task</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public BulletTaskService.TaskDTO? Task { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    private async Task Save() => await OnSave.InvokeAsync();
    private async Task Cancel() => await OnCancel.InvokeAsync();
    private async Task Delete() => await OnDelete.InvokeAsync();

    private async Task HandleFile(InputFileChangeEventArgs e)
    {
        if(Task == null) return;
        var file = e.File;
        // Limit to 5MB
        if(file.Size > 5 * 1024 * 1024) return; 

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        
        var id = await BaseService.SaveImageAsync(ms.ToArray(), file.ContentType);
        Task.ImgUrl = $"/api/images/{id}";
    }
}