@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Forms
@inject BulletBaseService BaseService
@inject BulletMediaService MediaService

@if (Item != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" @onclick="Cancel">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]" @onclick:stopPropagation="true">
            
            <div class="p-4 border-b border-gray-800 flex flex-col gap-3 bg-gray-800/50 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-white">@(Item.Id == 0 ? "New Item" : "Edit Item")</span>
                    <button @onclick="Cancel" class="text-gray-400 hover:text-white text-xl font-bold px-2">‚úï</button>
                </div>

                <div class="flex gap-2 flex-wrap">
                    <button @onclick='() => Item.Type = "task"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("task", "gray")"><span>üìù</span> Task</button>
                    <button @onclick='() => Item.Type = "meeting"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("meeting", "purple")"><span>ü§ù</span> Meeting</button>
                    <button @onclick='() => Item.Type = "habit"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("habit", "cyan")"><span>üî•</span> Habit</button>
                    <button @onclick='() => Item.Type = "media"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("media", "pink")"><span>üé¨</span> Media</button>
                    <button @onclick='() => Item.Type = "holiday"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("holiday", "blue")"><span>üéâ</span> Holiday</button>
                    <button @onclick='() => Item.Type = "birthday"' class="px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition border @GetButtonClass("birthday", "yellow")"><span>üéÇ</span> Birthday</button>
                </div>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 mb-1">TITLE</label>
                        <input @bind="Item.Title" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="Title..." />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">DATE</label>
                        <input type="date" value="@Item.Date.ToString("yyyy-MM-dd")" @onchange="@(e => Item.Date = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString()))" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" />
                    </div>
                </div>

                @if(Item.Type == "media")
                {
                    <div class="bg-pink-900/10 p-3 rounded border border-pink-900/30 space-y-3">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-pink-500 mb-1">RATING (1-10)</label>
                                <div class="flex gap-1">
                                    @for(int i = 1; i <= 10; i++){ int star = i; <button @onclick="() => MediaDetail.Rating = star" class="text-lg focus:outline-none transition hover:scale-125 @(MediaDetail.Rating >= star ? "text-yellow-400" : "text-gray-700")">‚òÖ</button> }
                                    <span class="ml-2 text-sm text-gray-400 font-bold">@MediaDetail.Rating</span>
                                </div>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs font-bold text-pink-500 mb-1">YEAR</label>
                                <input type="number" value="@(MediaDetail.ReleaseYear == 0 ? "" : MediaDetail.ReleaseYear)" @onchange="@(e => { if(int.TryParse(e.Value?.ToString(), out int y)) MediaDetail.ReleaseYear = y; else MediaDetail.ReleaseYear = 0; })" class="w-full bg-black border border-pink-800 rounded p-2 text-pink-300 focus:border-pink-500 outline-none" placeholder="YYYY" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-pink-500 mb-1">TAGS</label>
                            <input @bind="MediaDetail.Tags" class="w-full bg-black border border-pink-800 rounded p-2 text-pink-300 focus:border-pink-500 outline-none mb-2" placeholder="Action, Sci-Fi..." />
                            <div class="flex flex-wrap gap-1">
                                @foreach(var tag in suggestedTags){ <button @onclick="() => ToggleTag(tag)" class="text-[10px] px-2 py-1 rounded border border-gray-700 hover:border-pink-500 hover:text-white transition @(IsTagSelected(tag) ? "bg-pink-900 text-white" : "bg-black text-gray-400")">@tag</button> }
                            </div>
                        </div>
                    </div>
                }

                @if(Item.Type == "habit")
                {
                    <div class="grid grid-cols-2 gap-4 bg-cyan-900/10 p-3 rounded border border-cyan-900/30">
                        <div><label class="block text-xs font-bold text-cyan-500 mb-1">STREAK COUNT</label><input type="number" @bind="HabitDetail.StreakCount" class="w-full bg-black border border-cyan-800 rounded p-2 text-cyan-300 focus:border-cyan-500 outline-none" /></div>
                        <div><label class="block text-xs font-bold text-cyan-500 mb-1">STATUS</label><select @bind="HabitDetail.Status" class="w-full bg-black border border-cyan-800 rounded p-2 text-cyan-300 focus:border-cyan-500 outline-none"><option value="Active">Active</option><option value="Paused">Paused</option><option value="Archived">Archived</option></select></div>
                    </div>
                }

                @if(Item.Type == "task")
                {
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">STATUS</label><select @bind="TaskDetail.Status" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none"><option>Pending</option><option>In Progress</option><option>Completed</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">PRIORITY</label><select @bind="TaskDetail.Priority" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none"><option>Low</option><option>Normal</option><option>High</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">TICKET #</label><input @bind="TaskDetail.TicketNumber" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="e.g. JIRA-123" /></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">TICKET URL</label><input @bind="TaskDetail.TicketUrl" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="https://..." /></div>
                    </div>
                }

                @if(Item.Type == "meeting")
                {
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-purple-400 mb-1">START TIME</label><input type="time" value="@(MeetingDetail.StartTime?.ToString("HH:mm") ?? "")" @onchange="@(e => { if(TimeSpan.TryParse(e.Value?.ToString(), out var ts)) MeetingDetail.StartTime = Item.Date.Date + ts; })" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-purple-500 outline-none" /></div>
                        <div><label class="block text-xs font-bold text-purple-400 mb-1">DURATION (MIN)</label><input type="number" @bind="MeetingDetail.DurationMinutes" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-purple-500 outline-none" /></div>
                        <div><label class="block text-xs font-bold text-purple-400 mb-1">ACTUAL (MIN)</label><input type="number" @bind="MeetingDetail.ActualDurationMinutes" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-purple-500 outline-none" /></div>
                    </div>
                }

                @if(Item.Type == "holiday")
                {
                    <div class="bg-blue-900/10 p-3 rounded border border-blue-900/30">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" @bind="HolidayDetail.IsWorkHoliday" class="w-5 h-5 rounded bg-black border border-blue-600 accent-blue-500 cursor-pointer" />
                            <label class="font-bold text-blue-400">Is Work Holiday?</label>
                        </div>
                    </div>
                }

                @if(Item.Type == "birthday")
                {
                    <div class="bg-yellow-900/10 p-3 rounded border border-yellow-700/30">
                        <label class="block text-xs font-bold text-yellow-500 mb-1">BIRTH YEAR (YYYY)</label>
                        <input type="number" value="@(BirthdayDetail.DOB_Year == 0 ? "" : BirthdayDetail.DOB_Year)" @onchange="@(e => { if(int.TryParse(e.Value?.ToString(), out int y)) BirthdayDetail.DOB_Year = y; else BirthdayDetail.DOB_Year = 0; })" class="w-full bg-black border border-yellow-700 rounded p-2 text-yellow-200 focus:border-yellow-500 outline-none" placeholder="e.g. 1990" />
                        <p class="text-xs text-yellow-500/50 mt-1">Leave empty if unknown.</p>
                    </div>
                }

                <div><label class="block text-xs font-bold text-gray-500 mb-1">DESCRIPTION</label><textarea @bind="Item.Description" rows="3" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none"></textarea></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">IMAGE URL / UPLOAD</label>
                        <div class="flex gap-2 mb-2">
                            <input @bind="Item.ImgUrl" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none text-xs" placeholder="https://..." />
                            <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-2 py-2 rounded flex items-center justify-center">üìÇ <InputFile OnChange="@(e => UploadImage(e, url => Item.ImgUrl = url))" class="hidden" /></label>
                        </div>
                        @if(!string.IsNullOrEmpty(Item.ImgUrl)) { <img src="@Item.ImgUrl" class="w-[100px] h-[100px] object-cover border border-gray-600 rounded bg-black" /> }
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">LINK URL</label><input @bind="Item.LinkUrl" class="w-full bg-black border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="https://..." /></div>
                </div>

                <div class="border-t border-gray-800 pt-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">NOTES</label>
                    @foreach(var note in Notes)
                    {
                        <div class="bg-gray-800/30 p-2 rounded mb-2 border border-gray-700">
                            <div class="flex gap-2 mb-2">
                                <input @bind="note.Content" class="flex-1 bg-black border border-gray-700 rounded p-1 text-sm text-white" placeholder="Note text..." />
                                <input @bind="note.LinkUrl" class="w-1/4 bg-black border border-gray-700 rounded p-1 text-sm text-gray-400" placeholder="Link..." />
                                <button @onclick="() => Notes.Remove(note)" class="text-red-500 hover:text-red-400 font-bold px-2">√ó</button>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input @bind="note.ImgUrl" class="flex-1 bg-black border border-gray-700 rounded p-1 text-xs text-gray-500" placeholder="Image URL..." />
                                <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">Upload <InputFile OnChange="@(e => UploadImage(e, url => note.ImgUrl = url))" class="hidden" /></label>
                                @if(!string.IsNullOrEmpty(note.ImgUrl)) { <img src="@note.ImgUrl" class="w-8 h-8 object-cover border border-gray-600 rounded" /> }
                            </div>
                        </div>
                    }
                    <button @onclick="() => Notes.Add(new BulletItemNote())" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white">+ Add Note</button>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-xl flex justify-between">
                @if(Item.Id > 0) { <button @onclick="Delete" class="text-red-400 hover:text-red-300 text-sm font-bold">Delete Item</button> } else { <div></div> }
                <div class="flex gap-2">
                    <button @onclick="Cancel" class="px-4 py-2 rounded text-gray-300 hover:text-white hover:bg-gray-700">Cancel</button>
                    <button @onclick="Save" class="px-6 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public BulletTaskService.TaskDTO? Item { get; set; }
    [Parameter] public BulletTaskDetail TaskDetail { get; set; } = new();
    [Parameter] public BulletMeetingDetail MeetingDetail { get; set; } = new();
    [Parameter] public BulletHabitDetail HabitDetail { get; set; } = new();
    [Parameter] public BulletMediaDetail MediaDetail { get; set; } = new(); 
    [Parameter] public BulletHolidayDetail HolidayDetail { get; set; } = new();
    [Parameter] public BulletBirthdayDetail BirthdayDetail { get; set; } = new(); // NEW
    [Parameter] public List<BulletItemNote> Notes { get; set; } = new();
    
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    private List<string> suggestedTags = new();

    protected override async Task OnParametersSetAsync()
    {
        if (Item?.Type == "media")
        {
            if (Item.Id == 0 && MediaDetail.Rating == 0) MediaDetail.Rating = 6;
            suggestedTags = await MediaService.GetTopTags(Item.UserId);
        }
    }

    private bool IsTagSelected(string tag)
    {
        if (string.IsNullOrEmpty(MediaDetail.Tags)) return false;
        var tags = MediaDetail.Tags.Split(',').Select(t => t.Trim()).ToHashSet(StringComparer.OrdinalIgnoreCase);
        return tags.Contains(tag);
    }

    private void ToggleTag(string tag)
    {
        var tags = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (!string.IsNullOrEmpty(MediaDetail.Tags)) { foreach (var t in MediaDetail.Tags.Split(',')) { var clean = t.Trim(); if (!string.IsNullOrEmpty(clean)) tags.Add(clean); } }
        if (tags.Contains(tag)) tags.Remove(tag); else tags.Add(tag);
        MediaDetail.Tags = string.Join(", ", tags);
    }

    private async Task UploadImage(InputFileChangeEventArgs e, Action<string> onSuccess)
    {
        try {
            var file = e.File; using var stream = file.OpenReadStream(5 * 1024 * 1024); using var ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            var url = await BaseService.SaveImageAsync(ms.ToArray(), file.ContentType);
            onSuccess(url);
        } catch (Exception ex) { Console.WriteLine($"Upload Error: {ex.Message}"); }
    }

    private string GetButtonClass(string type, string color)
    {
        bool isActive = Item?.Type == type;
        if (isActive) {
            return color switch {
                "purple" => "bg-purple-600 text-white border-purple-500",
                "cyan" => "bg-cyan-600 text-white border-cyan-500",
                "pink" => "bg-pink-600 text-white border-pink-500",
                "blue" => "bg-blue-600 text-white border-blue-500",
                "yellow" => "bg-yellow-600 text-white border-yellow-500",
                _ => "bg-gray-600 text-white border-gray-500"
            };
        }
        return "bg-gray-900 text-gray-400 border-gray-700 hover:bg-gray-800";
    }

    private async Task Save() => await OnSave.InvokeAsync();
    private async Task Cancel() => await OnCancel.InvokeAsync();
    private async Task Delete() => await OnDelete.InvokeAsync();
}