@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject BulletBaseService BaseService

@if (Task != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto" style="z-index: 100;">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col my-8">
            
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl sticky top-0 z-10 backdrop-blur">
                <h3 class="text-lg font-bold text-white">@(Task.Id == 0 ? "New Task" : "Edit Task")</h3>
                <button @onclick="Cancel" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto">
                
                <div class="flex gap-6 items-start">
                    
                    <div class="w-40 shrink-0 space-y-3">
                        <div class="w-40 h-40 bg-black border border-gray-700 rounded-lg overflow-hidden flex items-center justify-center relative group">
                            @if(!string.IsNullOrEmpty(Task.ImgUrl)) {
                                <img src="@Task.ImgUrl" class="w-full h-full object-cover" />
                            } else {
                                <span class="text-gray-600 text-4xl">ðŸ“·</span>
                            }
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Image</label>
                            <InputFile OnChange="@(e => HandleFile(e, null))" class="text-[10px] text-gray-400 w-full file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-[10px] file:bg-gray-700 file:text-white hover:file:bg-gray-600" />
                            <input @bind="Task.ImgUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-[10px]" placeholder="Img URL..." />
                        </div>

                        <div class="pt-2 border-t border-gray-800">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Main Link URL</label>
                            <input @bind="Task.LinkUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-blue-300 text-xs" placeholder="https://..." />
                        </div>
                    </div>

                    <div class="flex-1 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                            <input @bind="Task.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none font-bold text-lg" />
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                                <input type="date" @bind="Task.Date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                                <select @bind="Task.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                    <option value="work">Work</option>
                                    <option value="personal">Personal</option>
                                    <option value="health">Health</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 p-3 bg-gray-800/30 rounded-lg border border-gray-800">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Ticket #</label>
                                <input @bind="Task.Detail.TicketNumber" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-xs" placeholder="JIRA-123" />
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Ticket URL</label>
                                <input @bind="Task.Detail.TicketUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-blue-300 text-xs" placeholder="https://..." />
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label>
                            <select @bind="Task.Detail.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                <option>Low</option>
                                <option>Normal</option>
                                <option>High</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Main Description</label>
                            <textarea @bind="Task.Description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-800 pt-4">
                    <div class="flex justify-between items-center mb-2">
                         <label class="block text-sm font-bold text-gray-300 uppercase">Notes / Mini-Articles</label>
                         <button @onclick="AddNote" class="bg-gray-700 hover:bg-blue-600 text-xs text-white px-2 py-1 rounded transition">ï¼‹ Add Note</button>
                    </div>
                   
                    <div class="space-y-3">
                        @foreach(var note in Task.Notes)
                        {
                            <div class="bg-black/30 border border-gray-800 p-3 rounded-lg flex gap-4 relative group">
                                <button @onclick="() => RemoveNote(note)" class="absolute top-1 right-1 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">âœ•</button>
                                
                                <div class="w-24 shrink-0 space-y-2">
                                    <div class="w-24 h-24 bg-gray-900 border border-gray-800 rounded flex items-center justify-center overflow-hidden">
                                         @if(!string.IsNullOrEmpty(note.ImgUrl)) { <img src="@note.ImgUrl" class="w-full h-full object-cover" /> } else { <span class="text-gray-700">No Img</span> }
                                    </div>
                                    <InputFile OnChange="@(e => HandleFile(e, note))" class="text-[9px] text-gray-500 w-full file:py-0.5 file:px-1 file:rounded file:border-0 file:text-[9px] file:bg-gray-700 file:text-white hover:file:bg-blue-600" />
                                </div>

                                <div class="flex-1 space-y-2">
                                    <textarea @bind="note.Content" rows="3" class="w-full bg-gray-900 border border-gray-800 rounded p-1.5 text-white text-xs" placeholder="Note content..."></textarea>
                                     <div class="grid grid-cols-2 gap-2">
                                        <input @bind="note.ImgUrl" class="w-full bg-gray-900 border border-gray-800 rounded p-1 text-gray-400 text-[10px]" placeholder="Image URL..." />
                                        <input @bind="note.LinkUrl" class="w-full bg-gray-900 border border-gray-800 rounded p-1 text-blue-300 text-[10px]" placeholder="Link URL..." />
                                    </div>
                                </div>
                            </div>
                        }
                         @if(!Task.Notes.Any()) { <div class="text-center text-gray-600 text-xs italic py-2">No notes added.</div> }
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-between sticky bottom-0 z-10 backdrop-blur">
                @if(Task.Id > 0) {
                    <button @onclick="Delete" class="px-4 py-2 text-red-400 hover:text-red-300 text-sm font-bold hover:bg-red-900/20 rounded">Delete</button>
                } else { <div></div> }
                
                <div class="flex gap-3">
                    <button @onclick="Cancel" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button>
                    <button @onclick="Save" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save Task</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public BulletTaskService.TaskDTO? Task { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    private async Task Save() => await OnSave.InvokeAsync();
    private async Task Cancel() => await OnCancel.InvokeAsync();
    private async Task Delete() => await OnDelete.InvokeAsync();

    private void AddNote() { Task?.Notes.Add(new BulletItemNote()); }
    private void RemoveNote(BulletItemNote note) { Task?.Notes.Remove(note); }

    private async Task HandleFile(InputFileChangeEventArgs e, BulletItemNote? note)
    {
        if(Task == null) return;
        var file = e.File;
        if(file.Size > 5 * 1024 * 1024) return; 

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        
        var id = await BaseService.SaveImageAsync(ms.ToArray(), file.ContentType);
        var url = $"/api/images/{id}";

        if(note == null) Task.ImgUrl = url; else note.ImgUrl = url;
    }
}