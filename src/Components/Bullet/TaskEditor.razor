@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject BulletBaseService BaseService

@if (Item != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto" style="z-index: 100;">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col my-8">
            
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl sticky top-0 z-10 backdrop-blur">
                <h3 class="text-lg font-bold text-white uppercase tracking-wider">@Item.Type EDITOR</h3>
                <button @onclick="Cancel" class="text-gray-400 hover:text-white text-xl">‚úï</button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto">
                
                <div class="bg-gray-800/30 p-2 rounded-lg border border-gray-800">
                    <div class="grid grid-cols-5 gap-2 mb-2">
                        @RenderTypeBtn("task", "‚úÖ Task")
                        @RenderTypeBtn("meeting", "ü§ù Meeting")
                        @RenderTypeBtn("event", "üìÖ Event")
                        @RenderTypeBtn("appointment", "ü©∫ Appt")
                        @RenderTypeBtn("note", "üìù Note")
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        @RenderTypeBtn("goal", "üéØ Goal")
                        @RenderTypeBtn("project", "üöÄ Project")
                        @RenderTypeBtn("habit", "üîÑ Habit")
                        @RenderTypeBtn("media", "üé¨ Media")
                        @RenderTypeBtn("person", "üë§ Person")
                    </div>
                </div>

                <div class="flex gap-6 items-start">
                    <div class="w-40 shrink-0 space-y-3">
                        <div class="w-40 h-40 bg-black border border-gray-700 rounded-lg overflow-hidden flex items-center justify-center relative group">
                            @if(!string.IsNullOrEmpty(Item.ImgUrl)) { <img src="@Item.ImgUrl" class="w-full h-full object-cover" /> } else { <span class="text-gray-600 text-4xl">üì∑</span> }
                        </div>
                        <div class="space-y-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Image</label>
                            <InputFile OnChange="@(e => HandleFile(e, null))" class="text-[10px] text-gray-400 w-full" />
                            <input @bind="Item.ImgUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-[10px]" placeholder="Img URL..." />
                        </div>
                        <div class="pt-2 border-t border-gray-800">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Main Link URL</label>
                            <input @bind="Item.LinkUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-blue-300 text-xs" placeholder="https://..." />
                        </div>
                    </div>

                    <div class="flex-1 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                            <input @bind="Item.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none font-bold text-lg" />
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                                <input type="date" @bind="Item.Date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                                <select @bind="Item.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                    <option value="work">Work</option>
                                    <option value="personal">Personal</option>
                                    <option value="health">Health</option>
                                </select>
                            </div>
                        </div>

                        @if (Item.Type == "task")
                        {
                            <div class="grid grid-cols-2 gap-4 p-3 bg-blue-900/10 rounded-lg border border-blue-900/30">
                                <div>
                                    <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Ticket #</label>
                                    <input @bind="TaskDetail.TicketNumber" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-xs" />
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Ticket URL</label>
                                    <input @bind="TaskDetail.TicketUrl" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-blue-300 text-xs" />
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label>
                                <select @bind="TaskDetail.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                    <option>Low</option><option>Normal</option><option>High</option>
                                </select>
                            </div>
                        }
                        else if (Item.Type == "meeting")
                        {
                            <div class="grid grid-cols-3 gap-4 p-3 bg-purple-900/10 rounded-lg border border-purple-900/30">
                                <div>
                                    <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Start Time</label>
                                    <input type="time" @bind="MeetingDetail.StartTime" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-xs" />
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Duration (Min)</label>
                                    <input type="number" @bind="MeetingDetail.DurationMinutes" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-xs" />
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Actual (Min)</label>
                                    <input type="number" @bind="MeetingDetail.ActualDurationMinutes" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-xs" />
                                </div>
                            </div>
                        }

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                            <textarea @bind="Item.Description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-800 pt-4">
                    <div class="flex justify-between items-center mb-2">
                         <label class="block text-sm font-bold text-gray-300 uppercase">Notes</label>
                         <button @onclick="AddNote" class="bg-gray-700 hover:bg-white hover:text-black text-xs text-white px-3 py-1 rounded transition">Ôºã Add</button>
                    </div>
                    <div class="space-y-3">
                        @foreach(var note in Notes)
                        {
                            <div class="bg-black/30 border border-gray-800 p-3 rounded-lg flex gap-4 relative group">
                                <button @onclick="() => RemoveNote(note)" class="absolute top-1 right-1 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                                <div class="w-24 shrink-0 space-y-2">
                                    <div class="w-24 h-24 bg-gray-900 border border-gray-800 rounded flex items-center justify-center overflow-hidden">
                                         @if(!string.IsNullOrEmpty(note.ImgUrl)) { <img src="@note.ImgUrl" class="w-full h-full object-cover" /> } else { <span class="text-gray-700">No Img</span> }
                                    </div>
                                    <InputFile OnChange="@(e => HandleFile(e, note))" class="text-[9px] text-gray-500 w-full" />
                                </div>
                                <div class="flex-1 space-y-2">
                                    <textarea @bind="note.Content" rows="3" class="w-full bg-gray-900 border border-gray-800 rounded p-1.5 text-white text-xs" placeholder="Note content..."></textarea>
                                     <div class="grid grid-cols-2 gap-2">
                                        <input @bind="note.ImgUrl" class="w-full bg-gray-900 border border-gray-800 rounded p-1 text-gray-400 text-[10px]" placeholder="Image URL..." />
                                        <input @bind="note.LinkUrl" class="w-full bg-gray-900 border border-gray-800 rounded p-1 text-blue-300 text-[10px]" placeholder="Link URL..." />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-between sticky bottom-0 z-10 backdrop-blur">
                @if(Item.Id > 0) { <button @onclick="Delete" class="px-4 py-2 text-red-400 hover:text-white text-sm font-bold hover:bg-red-900 rounded">Delete</button> } else { <div></div> }
                <div class="flex gap-3">
                    <button @onclick="Cancel" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button>
                    <button @onclick="Save" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // We use a generic Item + specific Details approach
    [Parameter] public BulletItem? Item { get; set; }
    [Parameter] public BulletTaskDetail TaskDetail { get; set; } = new();
    [Parameter] public BulletMeetingDetail MeetingDetail { get; set; } = new();
    [Parameter] public List<BulletItemNote> Notes { get; set; } = new();

    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    private async Task Save() => await OnSave.InvokeAsync();
    private async Task Cancel() => await OnCancel.InvokeAsync();
    private async Task Delete() => await OnDelete.InvokeAsync();

    private void AddNote() { Notes.Add(new BulletItemNote()); }
    private void RemoveNote(BulletItemNote note) { Notes.Remove(note); }

    private void SetType(string type) { if(Item != null) Item.Type = type; }

    private RenderFragment RenderTypeBtn(string type, string label) => __builder => {
        bool isActive = Item?.Type == type;
        <button @onclick='() => SetType(type)' class="text-xs py-1.5 rounded font-bold transition @(isActive ? "bg-white text-black shadow" : "bg-gray-900 text-gray-500 hover:bg-gray-700 hover:text-white")">
            @label
        </button>
    };

    private async Task HandleFile(InputFileChangeEventArgs e, BulletItemNote? note)
    {
        if(Item == null) return;
        var file = e.File;
        if(file.Size > 5 * 1024 * 1024) return; 
        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var id = await BaseService.SaveImageAsync(ms.ToArray(), file.ContentType);
        var url = $"/api/images/{id}";
        if(note == null) Item.ImgUrl = url; else note.ImgUrl = url;
    }
}