@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using System.Text.Json

<header class="flex flex-row justify-between items-center bg-gray-800 p-3 shadow-md border-b border-gray-700 mb-4 sticky top-0 z-50">
    
    <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
        <a href="/" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Home">üè†</a>
        <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
        <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Bullet Calendar">‚úÖ</a>
        <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
    </div>

    <div class="flex flex-col items-center gap-2">
        <div class="flex items-center gap-4">
            @if(ShowControls)
            {
                <button @onclick="TriggerPrev" class="w-8 h-8 flex items-center justify-center bg-gray-800 hover:bg-gray-700 hover:scale-110 rounded-full text-white border border-gray-700 transition shadow-lg text-lg">‚óÄ</button>
            }

            <h2 class="text-2xl font-bold text-white tracking-tight text-center drop-shadow-md min-w-[300px]">
                @(string.IsNullOrEmpty(CustomDateText) ? DateTime.Now.ToString("dddd, MMMM d, yyyy") : CustomDateText)
            </h2>

            @if(ShowControls)
            {
                <button @onclick="TriggerNext" class="w-8 h-8 flex items-center justify-center bg-gray-800 hover:bg-gray-700 hover:scale-110 rounded-full text-white border border-gray-700 transition shadow-lg text-lg">‚ñ∂</button>
            }
        </div>

        <div class="flex bg-gray-900/50 rounded-lg p-1 border border-gray-700">
            <button @onclick='() => HandleViewClick("day", true)' 
                    class="px-4 py-1.5 text-xs font-bold rounded-md text-gray-300 hover:bg-blue-900/50 hover:text-white transition uppercase mr-2 border-r border-gray-700 flex items-center gap-1">
                üìÖ Today
            </button>
            <button @onclick='() => HandleViewClick("day", false)' 
                    class="px-3 py-1.5 text-xs font-bold rounded-md transition flex items-center gap-1 @(ActiveView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">
                ‚òÄÔ∏è Day
            </button>
            <button @onclick='() => HandleViewClick("week", false)' 
                    class="px-3 py-1.5 text-xs font-bold rounded-md transition flex items-center gap-1 @(ActiveView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">
                üóìÔ∏è Week
            </button>
            <button @onclick='() => HandleViewClick("month", false)' 
                    class="px-3 py-1.5 text-xs font-bold rounded-md transition flex items-center gap-1 @(ActiveView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">
                üìÜ Month
            </button>
        </div>
    </div>

    <div class="relative">
        <div class="cursor-pointer" @onclick="ToggleUserMenu">
            <img src="@(currentUser?.AvatarUrl ?? "https://i.imgur.com/7Y5j5Yx.png")" 
                 alt="User" 
                 class="w-10 h-10 rounded-full border-2 border-gray-600 hover:border-white transition object-cover" />
        </div>

        @if (showUserMenu)
        {
            <div class="fixed inset-0 z-40 cursor-default" @onclick="() => showUserMenu = false"></div>
            <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                <a href="/settings" class="block w-full text-left text-xs text-gray-300 hover:text-white hover:bg-gray-700 p-2 rounded mb-1 transition">
                    ‚öôÔ∏è Settings
                </a>
                <a href="/manage_sports" class="block w-full text-left text-xs text-yellow-400 hover:bg-gray-700 p-2 rounded mb-1 transition">
                    üèÜ Manage Sports
                </a>
                <a href="/movies" class="block w-full text-left text-xs text-gray-300 hover:text-white hover:bg-gray-700 p-2 rounded mb-1 transition">
                    üé¨ Movies & Media
                </a>
                <div class="border-t border-gray-700 my-1"></div>
                <button @onclick="Logout" class="block w-full text-left text-xs text-red-400 hover:bg-gray-700 p-2 rounded transition">
                    üö™ Logout
                </button>
            </div>
        }
    </div>
</header>

@code {
    // === NEW PARAMETERS FOR CALENDAR CONTROL ===
    [Parameter] public bool ShowControls { get; set; } = false;
    [Parameter] public string CustomDateText { get; set; } = "";
    [Parameter] public string ActiveView { get; set; } = "day"; // Used for highlighting the active button
    
    [Parameter] public EventCallback OnPrev { get; set; }
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnGoToday { get; set; }
    [Parameter] public EventCallback<string> OnViewChanged { get; set; }

    private bool showUserMenu = false;
    private User? currentUser;
    private int userId = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json))
            {
                using (var doc = JsonDocument.Parse(json))
                {
                    if (doc.RootElement.TryGetProperty("UserId", out var p) || 
                        doc.RootElement.TryGetProperty("userId", out p) || 
                        doc.RootElement.TryGetProperty("id", out p))
                    {
                        if (p.ValueKind == JsonValueKind.Number) userId = p.GetInt32();
                        else if (p.ValueKind == JsonValueKind.String && int.TryParse(p.GetString(), out int parsedId)) userId = parsedId;
                    }
                }
            }

            if (userId > 0)
            {
                using (var scope = ScopeFactory.CreateScope())
                {
                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                    currentUser = await db.Users.FindAsync(userId);
                }
                StateHasChanged();
            }
        }
        catch (Exception ex) { Console.WriteLine($"Header Load Error: {ex.Message}"); }
    }

    private void ToggleUserMenu() => showUserMenu = !showUserMenu;

    private void Logout() => Nav.NavigateTo("/");

    // === NAVIGATION LOGIC ===

    private async Task TriggerPrev()
    {
        if (ShowControls && OnPrev.HasDelegate) await OnPrev.InvokeAsync();
    }

    private async Task TriggerNext()
    {
        if (ShowControls && OnNext.HasDelegate) await OnNext.InvokeAsync();
    }

    private async Task HandleViewClick(string viewType, bool isToday)
    {
        if (ShowControls)
        {
            // If we are ON the calendar, execute Parent Logic
            if (isToday && OnGoToday.HasDelegate) await OnGoToday.InvokeAsync();
            else if (OnViewChanged.HasDelegate) await OnViewChanged.InvokeAsync(viewType);
        }
        else
        {
            // If we are elsewhere (e.g. Movies), Redirect
            var url = $"/bullet-calendar?view={viewType}";
            if (isToday) url += $"&date={DateTime.Now:yyyy-MM-dd}";
            Nav.NavigateTo(url);
        }
    }
}