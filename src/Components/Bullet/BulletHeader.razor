@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using System.Text.Json

<header class="flex flex-row justify-between items-center bg-gray-800 p-3 shadow-md border-b border-gray-700 mb-4">
    
    <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
        <a href="/" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Home">üè†</a>
        <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
        <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Bullet Calendar">‚úÖ</a>
        <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
    </div>

    <div class="flex flex-col items-center">
        <div class="text-white font-bold text-lg tracking-wide">
            @DateTime.Now.ToString("dddd, MMMM d, yyyy")
        </div>

        <div class="flex items-center gap-2 text-sm text-gray-400 mt-1">
            <button @onclick='() => GoToCalendar("day", true)' class="hover:text-white hover:underline">Today</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("day", false)' class="hover:text-white hover:underline">Day</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("week", false)' class="hover:text-white hover:underline">Week</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("month", false)' class="hover:text-white hover:underline">Month</button>
        </div>
    </div>

    <div class="relative">
        <div class="cursor-pointer" @onclick="ToggleUserMenu">
            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                 alt="User" 
                 class="w-10 h-10 rounded-full border-2 border-gray-600 hover:border-white transition object-cover" />
        </div>

        @if (showUserMenu)
        {
            <div class="absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 overflow-hidden">
                <a href="/settings" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Settings</a>
                <a href="/manage_sports" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Manage Sports</a>
                <a href="/movies" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Movies</a>
                <div class="border-t border-gray-700 my-1"></div>
                <button @onclick="Logout" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700 hover:text-red-300">
                    Log Out
                </button>
            </div>
        }
    </div>
</header>

@code {
    private bool showUserMenu = false;
    private User? currentUser;
    private int userId = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserData();
        }
    }

    private async Task LoadUserData()
    {
        try
        {
            // 1. Get ID from Local Storage
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json))
            {
                using (var doc = JsonDocument.Parse(json))
                {
                    if (TryGetInt(doc.RootElement, "UserId", out int id) || 
                        TryGetInt(doc.RootElement, "id", out id))
                    {
                        userId = id;
                    }
                }
            }

            if (userId > 0)
            {
                // 2. CREATE A NEW SCOPE to avoid conflict with the Parent Page's DbContext
                using (var scope = ScopeFactory.CreateScope())
                {
                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                    currentUser = await db.Users.FindAsync(userId);
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Header Error: {ex.Message}");
        }
    }

    private bool TryGetInt(JsonElement element, string propName, out int value)
    {
        value = 0;
        if (element.TryGetProperty(propName, out var prop) || 
            element.TryGetProperty(propName.ToLower(), out prop))
        {
            if(prop.ValueKind == JsonValueKind.Number)
            {
                value = prop.GetInt32();
                return true;
            }
        }
        return false;
    }

    private void ToggleUserMenu() => showUserMenu = !showUserMenu;

    private void GoToCalendar(string viewType, bool isToday)
    {
        var url = $"/bullet-calendar?view={viewType}";
        if (isToday) url += $"&date={DateTime.Now:yyyy-MM-dd}";
        Nav.NavigateTo(url);
    }

    private void Logout() => Nav.NavigateTo("/");
}