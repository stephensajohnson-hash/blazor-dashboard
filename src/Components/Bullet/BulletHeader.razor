@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory
@inject Dashboard.Services.BulletNavigationService NavService
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using System.Text.Json

<header class="flex flex-row justify-between items-center bg-[#0c0c0c] p-3 shadow-2xl border-b border-gray-800 mb-4 sticky top-0 z-50 backdrop-blur-md">
    
    <div class="flex items-center gap-6 bg-gray-900/80 px-5 py-2 rounded-xl border border-gray-800 shadow-inner">
        <a href="/" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0 drop-shadow-blue" title="Home">üè†</a>
        <a href="/recipes" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
        <a href="/bullet-calendar" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Bullet Calendar">‚úÖ</a>
        <a href="/budget-tracker" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Budget Tracker">üíµ</a>
    </div>

    <div class="flex flex-col items-center gap-2">
        <div class="flex items-center gap-4">
            @if(ShowControls)
            {
                <button @onclick="TriggerPrev" class="w-8 h-8 flex items-center justify-center bg-gray-900 hover:bg-blue-600 text-white border border-gray-700 rounded-lg transition shadow-lg font-black">‚óÄ</button>
            }

            <div class="flex items-center gap-3">
                <h2 class="text-xl font-black text-white tracking-tighter drop-shadow-md">
                    @(string.IsNullOrEmpty(CustomDateText) ? DateTime.Now.ToString("dddd, MMMM d, yyyy") : CustomDateText)
                </h2>
                
                @if (ChildContent != null)
                {
                    <div class="flex items-center border-l border-gray-700 pl-3">
                        @ChildContent
                    </div>
                }
            </div>

            @if(ShowControls)
            {
                <button @onclick="TriggerNext" class="w-8 h-8 flex items-center justify-center bg-gray-900 hover:bg-blue-600 text-white border border-gray-700 rounded-lg transition shadow-lg font-black">‚ñ∂</button>
            }
        </div>

        @if (ShowControls)
        {
            <div class="flex items-center gap-2">
                <div class="flex bg-black/60 rounded-lg p-1 border border-gray-800 shadow-inner font-black">
                    <button @onclick='() => HandleViewClick("day", true)' 
                            class="px-3 py-1 text-[10px] rounded text-gray-500 hover:text-white transition border-r border-gray-800">
                        Today
                    </button>
                    <button @onclick='() => HandleViewClick("day", false)' 
                            class="px-4 py-1 text-[10px] rounded transition @(ActiveView == "day" ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                        Day
                    </button>
                    <button @onclick='() => HandleViewClick("week", false)' 
                            class="px-4 py-1 text-[10px] rounded transition @(ActiveView == "week" ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                        Week
                    </button>
                    <button @onclick='() => HandleViewClick("month", false)' 
                            class="px-4 py-1 text-[10px] rounded transition @(ActiveView == "month" ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                        Month
                    </button>
                </div>

                @if (ActiveView == "month")
                {
                    <button @onclick="HandleToggleCompact" 
                            class="p-1.5 rounded border text-[10px] font-black uppercase tracking-tighter transition shadow-md @(NavService.IsMonthCompact ? "bg-blue-600 border-blue-500 text-white" : "bg-gray-800 border-gray-700 text-gray-500 hover:text-white")"
                            title="Toggle between Full list and Compact grid">
                        @(NavService.IsMonthCompact ? "üìñ Full View" : "üîç Compact Grid")
                    </button>
                }
            </div>
        }
    </div>

    <div class="relative font-black">
        <div class="cursor-pointer group" @onclick="ToggleUserMenu">
            <img src="@(currentUser?.AvatarUrl ?? "https://i.imgur.com/7Y5j5Yx.png")" 
                 alt="User" 
                 class="w-10 h-10 rounded-xl border-2 border-gray-800 group-hover:border-blue-500 transition-all object-cover shadow-2xl" />
        </div>

        @if (showUserMenu)
        {
            <div class="fixed inset-0 z-40" @onclick="() => showUserMenu = false"></div>
            <div class="absolute right-0 top-full mt-3 w-56 bg-[#0f0f0f] border border-gray-800 rounded-xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] p-2 z-50 animate-in fade-in zoom-in duration-150">
                <div class="px-3 py-2 border-b border-gray-800 mb-1">
                    <div class="text-[10px] text-gray-600 tracking-widest">Authenticated User</div>
                    <div class="text-xs font-bold text-white truncate">@currentUser?.Username</div>
                </div>
                
                <a href="/settings" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-gray-400 hover:text-white hover:bg-gray-800 p-2.5 rounded transition">
                    ‚öôÔ∏è Settings
                </a>

                <a href="/image-manager" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-blue-400 hover:bg-blue-950/20 p-2.5 rounded transition">
                    üñºÔ∏è Manage Images
                </a>

                <a href="/manage-sports" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-yellow-500 hover:bg-yellow-950/20 p-2.5 rounded transition">
                    üèÜ Manage Sports
                </a>

                <a href="/manage-orphans" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-red-400 hover:bg-red-950/20 p-2.5 rounded transition">
                    üõ†Ô∏è Manage Orphans
                </a>

                <a href="/movies" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-gray-400 hover:text-white hover:bg-gray-800 p-2.5 rounded transition">
                    üé¨ Movies & Media
                </a>

                <button @onclick="HandleCloneClick" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-purple-400 hover:bg-purple-950/20 p-2.5 rounded transition">
                    üß¨ Clone Annual Items
                </button>
                
                <button @onclick="HandleExportPdf" 
                        class="flex items-center w-full px-4 py-2 text-[10px] font-black text-blue-400 hover:bg-blue-600 hover:text-white transition-colors uppercase tracking-widest">
                    <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Export Year Book
                </button>
                
                <div class="border-t border-gray-800 my-1"></div>
                                
                <button @onclick="Logout" class="flex items-center gap-3 w-full text-left text-[10px] font-black tracking-widest text-red-500 hover:bg-red-950/20 p-2.5 rounded transition">
                    üö™ Logout
                </button>
            </div>
        }
    </div>
</header>

<style>
    .drop-shadow-blue { filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.4)); }
</style>

@code {
    [Parameter] public bool ShowControls { get; set; } = false;
    [Parameter] public string CustomDateText { get; set; } = "";
    [Parameter] public string ActiveView { get; set; } = "day";
    
    [Parameter] public EventCallback OnPrev { get; set; }
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public EventCallback OnGoToday { get; set; }
    [Parameter] public EventCallback<string> OnViewChanged { get; set; }
    [Parameter] public EventCallback OnCloneRequest { get; set; }
    [Parameter] public EventCallback OnToggleCompact { get; set; }
    [Parameter] public EventCallback OnExportPdf { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private bool showUserMenu = false;
    private User? currentUser;
    private int userId = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json))
            {
                using (var doc = JsonDocument.Parse(json))
                {
                    if (doc.RootElement.TryGetProperty("UserId", out var p) || 
                        doc.RootElement.TryGetProperty("userId", out p) || 
                        doc.RootElement.TryGetProperty("id", out p))
                    {
                        if (p.ValueKind == JsonValueKind.Number) userId = p.GetInt32();
                        else if (p.ValueKind == JsonValueKind.String && int.TryParse(p.GetString(), out int parsedId)) userId = parsedId;
                    }
                }
            }

            if (userId > 0)
            {
                using (var scope = ScopeFactory.CreateScope())
                {
                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
                    currentUser = await db.Users.FindAsync(userId);
                }
                StateHasChanged();
            }
        }
        catch (Exception ex) { Console.WriteLine($"Header Load Error: {ex.Message}"); }
    }

    private void ToggleUserMenu() => showUserMenu = !showUserMenu;

    private async Task HandleCloneClick()
    {
        showUserMenu = false;
        if (OnCloneRequest.HasDelegate) await OnCloneRequest.InvokeAsync();
    }

    private async Task HandleToggleCompact()
    {
        if (OnToggleCompact.HasDelegate) await OnToggleCompact.InvokeAsync();
    }

    private async Task HandleExportPdf()
    {
        if (OnExportPdf.HasDelegate) await OnExportPdf.InvokeAsync();
    }

    private void Logout()
    {
        _ = JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session");
        Nav.NavigateTo("/", true);
    }

    private async Task TriggerPrev()
    {
        if (ShowControls && OnPrev.HasDelegate) await OnPrev.InvokeAsync();
    }

    private async Task TriggerNext()
    {
        if (ShowControls && OnNext.HasDelegate) await OnNext.InvokeAsync();
    }

    private async Task HandleViewClick(string viewType, bool isToday)
    {
        if (ShowControls)
        {
            if (isToday && OnGoToday.HasDelegate) await OnGoToday.InvokeAsync();
            else if (OnViewChanged.HasDelegate) await OnViewChanged.InvokeAsync(viewType);
        }
        else
        {
            var url = $"/bullet-calendar?view={viewType}";
            if (isToday) url += $"&date={DateTime.Now:yyyy-MM-dd}";
            Nav.NavigateTo(url);
        }
    }
}