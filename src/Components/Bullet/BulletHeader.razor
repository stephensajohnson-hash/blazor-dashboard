@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Text.Json

<header class="flex flex-row justify-between items-center bg-gray-800 p-3 shadow-md border-b border-gray-700 mb-4">
    
    <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
        <a href="/" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Home">üè†</a>
        <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
        <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Bullet Calendar">‚úÖ</a>
        <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
    </div>

    <div class="flex flex-col items-center">
        <div class="text-white font-bold text-lg tracking-wide">
            @DateTime.Now.ToString("dddd, MMMM d, yyyy")
        </div>

        <div class="flex items-center gap-2 text-sm text-gray-400 mt-1">
            <button @onclick='() => GoToCalendar("day", true)' class="hover:text-white hover:underline">Today</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("day", false)' class="hover:text-white hover:underline">Day</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("week", false)' class="hover:text-white hover:underline">Week</button>
            <span>|</span>
            <button @onclick='() => GoToCalendar("month", false)' class="hover:text-white hover:underline">Month</button>
        </div>
    </div>

    <div class="relative">
        <div class="cursor-pointer" @onclick="ToggleUserMenu">
            <img src="@avatarUrl" alt="User" class="w-10 h-10 rounded-full border-2 border-gray-600 hover:border-white transition object-cover" />
        </div>

        @if (showUserMenu)
        {
            <div class="absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 overflow-hidden">
                <a href="/settings" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Settings</a>
                <a href="/manage_sports" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Manage Sports</a>
                <a href="/movies" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Movies</a>
                <div class="border-t border-gray-700 my-1"></div>
                <button @onclick="Logout" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700 hover:text-red-300">
                    Log Out
                </button>
            </div>
        }
    </div>
</header>

@code {
    private bool showUserMenu = false;
    
    // Default SVG (Gray User Icon) so it never looks "Broken"
    private string avatarUrl = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCDoLTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Retrieve the session JSON exactly like Movies.razor
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                
                if (!string.IsNullOrEmpty(json))
                {
                    using (var doc = JsonDocument.Parse(json))
                    {
                        // Check common property names for the avatar URL
                        if (TryGetString(doc.RootElement, "AvatarUrl", out var url))                            
                        {
                            if (!string.IsNullOrEmpty(url))
                            {
                                avatarUrl = url;
                                StateHasChanged(); // Force re-render to show the new image
                            }
                        }
                    }
                }
            }
            catch
            {
                // If parsing fails, we just keep the default SVG
            }
        }
    }

    // Helper to safely get string property
    private bool TryGetString(JsonElement element, string propName, out string? value)
    {
        value = null;
        if (element.TryGetProperty(propName, out var prop) || 
            element.TryGetProperty(propName.ToLower(), out prop)) // Check lowercase too
        {
            value = prop.GetString();
            return true;
        }
        return false;
    }

    private void ToggleUserMenu()
    {
        showUserMenu = !showUserMenu;
    }

    private void GoToCalendar(string viewType, bool isToday)
    {
        var url = $"/bullet-calendar?view={viewType}";
        if (isToday)
        {
            var todayStr = DateTime.Now.ToString("yyyy-MM-dd");
            url += $"&date={todayStr}";
        }
        Nav.NavigateTo(url);
    }

    private void Logout()
    {
        Nav.NavigateTo("/");
    }
}