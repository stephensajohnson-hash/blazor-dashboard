@namespace Dashboard.Components.Bullet
@using Dashboard

<div style="background-color: #1f2937; border-left: 5px solid #a855f7; border: 1px solid #374151; margin-bottom: 0.75rem; padding: 0.5rem; min-height: 60px; position: relative;">
    
    @if (Item == null)
    {
        <div style="color: red;">ERR: Item is NULL</div>
    }
    else if (Item.MeetingDetail == null)
    {
        <div style="color: red;">ERR: MeetingDetail is NULL for @Item.Title</div>
    }
    else
    {
        <div style="position: absolute; top: 4px; right: 4px; display: flex; gap: 4px;">
            <button @onclick="HandleClick" @onclick:stopPropagation="true" style="background: #374151; color: #9ca3af; border: none; padding: 2px 6px; cursor: pointer; border-radius: 4px;">‚úèÔ∏è</button>
            <button @onclick="HandleDelete" @onclick:stopPropagation="true" style="background: #374151; color: #f87171; border: none; padding: 2px 6px; cursor: pointer; border-radius: 4px;">‚úï</button>
        </div>

        <div style="display: flex; gap: 10px; cursor: pointer;" @onclick="HandleClick">
            
            <div style="margin-top: 2px;" @onclick:stopPropagation="true">
                <input type="checkbox" checked="@Item.MeetingDetail.IsCompleted" @onchange="HandleToggle" style="cursor: pointer; width: 16px; height: 16px;" />
            </div>

            <div style="flex: 1; overflow: hidden;">
                <h4 style="margin: 0; font-size: 0.875rem; font-weight: bold; color: white; text-decoration: @(Item.MeetingDetail.IsCompleted ? "line-through" : "none"); opacity: @(Item.MeetingDetail.IsCompleted ? "0.6" : "1");">
                    @Item.Title
                </h4>
                
                @if(!string.IsNullOrEmpty(Item.Description)) {
                    <p style="margin: 2px 0 6px 0; font-size: 0.75rem; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@Item.Description</p>
                }

                <div style="display: flex; align-items: center;">
                    <span style="font-size: 0.65rem; background-color: rgba(88, 28, 135, 0.5); color: #e9d5ff; border: 1px solid #7e22ce; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                        üïí @(Item.MeetingDetail.StartTime?.ToString("h:mm tt") ?? "TBD")
                        @if(Item.MeetingDetail.DurationMinutes > 0) { <span> (@Item.MeetingDetail.DurationMinutes m)</span> }
                    </span>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public BulletTaskService.TaskDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggle { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    protected override void OnParametersSet()
    {
        // LOGGING: This will show in the console every time the card tries to render
        if (Item != null)
        {
            Console.WriteLine($"[MeetingCard] Rendering '{Item.Title}' (ID: {Item.Id}). Detail Null? {(Item.MeetingDetail == null)}");
        }
        else
        {
            Console.WriteLine($"[MeetingCard] Rendering NULL Item!");
        }
        base.OnParametersSet();
    }

    private async Task HandleClick() => await OnClick.InvokeAsync(Item);
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
    
    private async Task HandleToggle(ChangeEventArgs e) {
        if(Item?.MeetingDetail != null) {
            bool val = (bool)(e.Value ?? false);
            Item.MeetingDetail.IsCompleted = val;
            await OnToggle.InvokeAsync(Item);
        }
    }
}