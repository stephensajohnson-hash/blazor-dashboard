@namespace Dashboard.Components.Bullet
@using Dashboard

<BaseItemCard Item="Item" Notes="Item.Notes" IsCompleted="Item.Detail.IsCompleted" 
              BorderClass="border-purple-900 hover:border-purple-500"
              OnEdit="HandleClick" OnDelete="HandleDelete" OnToggle="HandleToggle">
    <ChildContent>
        <span class="text-[10px] bg-purple-900/40 text-purple-300 border border-purple-700 px-1.5 py-0.5 rounded font-mono">
            @(Item.Detail.StartTime?.ToString("h:mm tt") ?? "TBD")
            @if(Item.Detail.DurationMinutes > 0) { <span> (@Item.Detail.DurationMinutes m)</span> }
        </span>
    </ChildContent>
</BaseItemCard>

@code {
    [Parameter] public BulletMeetingService.MeetingDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; } // Use Generic DTO for ease
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnToggle { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    // Map back to generic DTO for the main page handler
    private BulletTaskService.TaskDTO ToGeneric() => new BulletTaskService.TaskDTO { 
        Id = Item.Id, UserId = Item.UserId, Type = "meeting", Category = Item.Category, 
        Date = Item.Date, Title = Item.Title, Description = Item.Description, 
        ImgUrl = Item.ImgUrl, LinkUrl = Item.LinkUrl, MeetingDetail = Item.Detail, Notes = Item.Notes 
    };

    private async Task HandleClick() => await OnClick.InvokeAsync(ToGeneric());
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
    
    private async Task HandleToggle(bool val) {
        Item.Detail.IsCompleted = val;
        await OnToggle.InvokeAsync(ToGeneric());
    }
}