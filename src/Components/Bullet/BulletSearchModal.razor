@namespace Dashboard.Components.Bullet

@if (IsVisible)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-black" 
         @onclick="HandleCancel">
        <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl shadow-2xl p-6 font-black overflow-hidden" 
             @onclick:stopPropagation="true">
            <h3 class="text-blue-400 text-xs tracking-widest mb-6 font-black uppercase">
                Advanced Search Engine
            </h3>
            
            <div class="space-y-4 font-black">
                @* SYNCED SEARCH TEXT FIELD *@
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 font-black uppercase">
                        Search Keywords
                    </label>
                    <div class="relative flex items-center">
                        <input type="text" 
                               value="@SearchQuery" 
                               @oninput="UpdateQuery"
                               placeholder="Search for tasks or meals..." 
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500" />
                        @if (!string.IsNullOrEmpty(SearchQuery))
                        {
                            <button @onclick="ClearQuery" 
                                    class="absolute right-2 text-gray-500 hover:text-red-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        }
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 font-black uppercase">
                        Quick Scoping Presets
                    </label>
                    <select @onchange="OnPresetChanged" 
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500">
                        <option value="all-time">Full History (All Time)</option>
                        <option value="">Manual Selection...</option>
                        
                        <optgroup label="Months">
                            <option value="this-month">This Month (@DateTime.Today.ToString("MMMM yyyy"))</option>
                            <option value="last-month">Last Month (@DateTime.Today.AddMonths(-1).ToString("MMMM yyyy"))</option>
                            <option value="last-30">Last 30 Days</option>
                        </optgroup>

                        <optgroup label="Quarters">
                            <option value="this-quarter">This Quarter (@GetCurrentQuarterLabel(0))</option>
                            <option value="last-quarter">Last Quarter (@GetCurrentQuarterLabel(-1))</option>
                        </optgroup>

                        <optgroup label="Years">
                            <option value="this-year">This Year (@DateTime.Today.Year)</option>
                            <option value="last-year">Last Year (@(DateTime.Today.Year - 1))</option>
                        </optgroup>
                        
                        <optgroup label="Future">
                            <option value="next-30">Next 30 Days</option>
                            <option value="next-year">Next Year (@(DateTime.Today.Year + 1))</option>
                        </optgroup>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 font-black border-t border-gray-800 pt-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] text-gray-500 uppercase">From Date</label>
                            @if (SearchStart.HasValue)
                            {
                                <button @onclick="() => ClearDate(true)" class="text-[8px] text-red-400 hover:text-red-300 font-black uppercase tracking-tighter">Clear</button>
                            }
                        </div>
                        <input type="date" 
                               value="@(SearchStart?.ToString("yyyy-MM-dd"))" 
                               @onchange="UpdateStart"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] text-gray-500 uppercase">Thru Date</label>
                            @if (SearchEnd.HasValue)
                            {
                                <button @onclick="() => ClearDate(false)" class="text-[8px] text-red-400 hover:text-red-300 font-black uppercase tracking-tighter">Clear</button>
                            }
                        </div>
                        <input type="date" 
                               value="@(SearchEnd?.ToString("yyyy-MM-dd"))" 
                               @onchange="UpdateEnd"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 uppercase">Identity Type</label>
                    <select value="@SearchType" 
                            @onchange="UpdateType"
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500">
                        <option value="all">All Types</option>
                        <option value="task">Tasks</option>
                        <option value="meeting">Meetings</option>
                        <option value="habit">Habits</option>
                        <option value="health">Health Logs</option>
                        <option value="sports">Sports</option>
                        <option value="birthday">Birthdays</option>
                        <option value="holiday">Holidays</option>
                        <option value="media">Media</option>
                    </select>
                </div>

                <div class="pt-4 flex gap-2 font-black">
                    <button @onclick="HandleCancel" 
                            class="flex-1 py-2 text-[10px] text-gray-500 font-black uppercase hover:text-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button @onclick="HandleSearch" 
                            class="flex-1 bg-blue-600 py-2 rounded-lg text-[10px] text-white shadow-lg tracking-[0.2em] font-black uppercase hover:bg-blue-500 transition-all active:scale-95">
                        Scan Database
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public DateTime? SearchStart { get; set; }
    [Parameter] public DateTime? SearchEnd { get; set; }
    [Parameter] public string SearchType { get; set; } = "all";
    
    // NEW: SearchQuery parameter for sync
    [Parameter] public string SearchQuery { get; set; } = "";
    
    [Parameter] public EventCallback OnSearchRequested { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    
    [Parameter] public EventCallback<DateTime?> SearchStartChanged { get; set; }
    [Parameter] public EventCallback<DateTime?> SearchEndChanged { get; set; }
    [Parameter] public EventCallback<string> SearchTypeChanged { get; set; }
    [Parameter] public EventCallback<string> SearchQueryChanged { get; set; }

    private async Task UpdateQuery(ChangeEventArgs e)
    {
        SearchQuery = e.Value?.ToString() ?? "";
        await SearchQueryChanged.InvokeAsync(SearchQuery);
    }

    private async Task ClearQuery()
    {
        SearchQuery = "";
        await SearchQueryChanged.InvokeAsync("");
    }

    private async Task UpdateStart(ChangeEventArgs e)
    {
        DateTime? d = DateTime.TryParse(e.Value?.ToString(), out var parsed) ? parsed : null;
        await SearchStartChanged.InvokeAsync(d);
    }

    private async Task UpdateEnd(ChangeEventArgs e)
    {
        DateTime? d = DateTime.TryParse(e.Value?.ToString(), out var parsed) ? parsed : null;
        await SearchEndChanged.InvokeAsync(d);
    }

    private async Task ClearDate(bool isStart)
    {
        if (isStart) await SearchStartChanged.InvokeAsync(null);
        else await SearchEndChanged.InvokeAsync(null);
    }

    private async Task UpdateType(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "all";
        await SearchTypeChanged.InvokeAsync(val);
    }

    private async Task HandleCancel() => await OnClose.InvokeAsync();
    private async Task HandleSearch() => await OnSearchRequested.InvokeAsync();

    private string GetCurrentQuarterLabel(int offsetQuarters)
    {
        var targetDate = DateTime.Today.AddMonths(offsetQuarters * 3);
        int quarter = (targetDate.Month - 1) / 3 + 1;
        return $"Q{quarter} {targetDate.Year}";
    }

    private async Task OnPresetChanged(ChangeEventArgs e)
    {
        var preset = e.Value?.ToString();
        var today = DateTime.Today;
        DateTime? start = null;
        DateTime? end = null;

        switch (preset)
        {
            case "all-time": 
                break;
            case "this-month":
                start = new DateTime(today.Year, today.Month, 1);
                end = start.Value.AddMonths(1).AddDays(-1);
                break;
            case "last-month":
                start = new DateTime(today.Year, today.Month, 1).AddMonths(-1);
                end = new DateTime(today.Year, today.Month, 1).AddDays(-1);
                break;
            case "last-30":
                start = today.AddDays(-30);
                end = today;
                break;
            case "next-30":
                start = today;
                end = today.AddDays(30);
                break;
            case "this-quarter":
                int q = (today.Month - 1) / 3;
                start = new DateTime(today.Year, (q * 3) + 1, 1);
                end = start.Value.AddMonths(3).AddDays(-1);
                break;
            case "last-quarter":
                int currentQStartMonth = ((today.Month - 1) / 3) * 3 + 1;
                start = new DateTime(today.Year, currentQStartMonth, 1).AddMonths(-3);
                end = start.Value.AddMonths(3).AddDays(-1);
                break;
            case "this-year":
                start = new DateTime(today.Year, 1, 1);
                end = new DateTime(today.Year, 12, 31);
                break;
            case "last-year":
                start = new DateTime(today.Year - 1, 1, 1);
                end = new DateTime(today.Year - 1, 12, 31);
                break;
            case "next-year":
                start = new DateTime(today.Year + 1, 1, 1);
                end = new DateTime(today.Year + 1, 12, 31);
                break;
        }

        await SearchStartChanged.InvokeAsync(start);
        await SearchEndChanged.InvokeAsync(end);
    }
}