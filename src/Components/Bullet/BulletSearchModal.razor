@namespace Dashboard.Components.Bullet

@if (IsVisible)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-black" 
         @onclick="HandleCancel">
        <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl shadow-2xl p-6 font-black overflow-hidden" 
             @onclick:stopPropagation="true">
            <h3 class="text-blue-400 text-xs tracking-widest mb-6 font-black uppercase">
                Advanced Search Engine
            </h3>
            
            <div class="space-y-4 font-black">
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 font-black uppercase">
                        Date Range Scoping
                    </label>
                    <select @onchange="OnPresetChanged" 
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500">
                        <option value="all-time">Full History (Default)</option>
                        <option value="">Manual Selection...</option>
                        <option value="this-month">This Month</option>
                        <option value="last-month">Last Month</option>
                        <option value="next-month">Next Month</option>
                        <option value="this-quarter">This Quarter</option>
                        <option value="last-quarter">Last Quarter</option>
                        <option value="next-quarter">Next Quarter</option>
                        <option value="this-year">This Year</option>
                        <option value="last-year">Last Year</option>
                        <option value="next-year">Next Year</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 font-black">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] text-gray-500 uppercase">From Date</label>
                            @if (SearchStart.HasValue)
                            {
                                <button @onclick="() => ClearDate(true)" class="text-[8px] text-red-400 hover:text-red-300 font-black uppercase tracking-tighter">Clear</button>
                            }
                        </div>
                        <input type="date" 
                               value="@(SearchStart?.ToString("yyyy-MM-dd"))" 
                               @onchange="UpdateStart"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] text-gray-500 uppercase">Thru Date</label>
                            @if (SearchEnd.HasValue)
                            {
                                <button @onclick="() => ClearDate(false)" class="text-[8px] text-red-400 hover:text-red-300 font-black uppercase tracking-tighter">Clear</button>
                            }
                        </div>
                        <input type="date" 
                               value="@(SearchEnd?.ToString("yyyy-MM-dd"))" 
                               @onchange="UpdateEnd"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 uppercase">Identity Type</label>
                    <select value="@SearchType" 
                            @onchange="UpdateType"
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black outline-none focus:border-blue-500">
                        <option value="all">All Types</option>
                        <option value="task">Tasks</option>
                        <option value="meeting">Meetings</option>
                        <option value="habit">Habits</option>
                        <option value="health">Health Logs</option>
                        <option value="sports">Sports</option>
                        <option value="birthday">Birthdays</option>
                        <option value="holiday">Holidays</option>
                        <option value="media">Media</option>
                    </select>
                </div>

                <div class="pt-4 flex gap-2 font-black">
                    <button @onclick="HandleCancel" 
                            class="flex-1 py-2 text-[10px] text-gray-500 font-black uppercase hover:text-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button @onclick="HandleSearch" 
                            class="flex-1 bg-blue-600 py-2 rounded-lg text-[10px] text-white shadow-lg tracking-[0.2em] font-black uppercase hover:bg-blue-500 transition-all active:scale-95">
                        Scan Database
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    
    // Changed to Nullable to support "All Time" searches
    [Parameter] public DateTime? SearchStart { get; set; }
    [Parameter] public DateTime? SearchEnd { get; set; }
    [Parameter] public string SearchType { get; set; } = "all";
    
    [Parameter] public EventCallback OnSearchRequested { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    
    [Parameter] public EventCallback<DateTime?> SearchStartChanged { get; set; }
    [Parameter] public EventCallback<DateTime?> SearchEndChanged { get; set; }
    [Parameter] public EventCallback<string> SearchTypeChanged { get; set; }

    private async Task UpdateStart(ChangeEventArgs e)
    {
        DateTime? d = DateTime.TryParse(e.Value?.ToString(), out var parsed) ? parsed : null;
        SearchStart = d;
        await SearchStartChanged.InvokeAsync(d);
    }

    private async Task UpdateEnd(ChangeEventArgs e)
    {
        DateTime? d = DateTime.TryParse(e.Value?.ToString(), out var parsed) ? parsed : null;
        SearchEnd = d;
        await SearchEndChanged.InvokeAsync(d);
    }

    private async Task ClearDate(bool isStart)
    {
        if (isStart) { SearchStart = null; await SearchStartChanged.InvokeAsync(null); }
        else { SearchEnd = null; await SearchEndChanged.InvokeAsync(null); }
    }

    private async Task UpdateType(ChangeEventArgs e)
    {
        SearchType = e.Value?.ToString() ?? "all";
        await SearchTypeChanged.InvokeAsync(SearchType);
    }

    private async Task HandleCancel() => await OnClose.InvokeAsync();

    private async Task HandleSearch() => await OnSearchRequested.InvokeAsync();

    private async Task OnPresetChanged(ChangeEventArgs e)
    {
        var preset = e.Value?.ToString();
        var today = DateTime.Today;

        switch (preset)
        {
            case "all-time":
                SearchStart = null;
                SearchEnd = null;
                break;
            case "this-month":
                SearchStart = new DateTime(today.Year, today.Month, 1);
                SearchEnd = SearchStart.Value.AddMonths(1).AddDays(-1);
                break;
            case "last-month":
                SearchStart = new DateTime(today.Year, today.Month, 1).AddMonths(-1);
                SearchEnd = new DateTime(today.Year, today.Month, 1).AddDays(-1);
                break;
            case "next-month":
                SearchStart = new DateTime(today.Year, today.Month, 1).AddMonths(1);
                SearchEnd = SearchStart.Value.AddMonths(1).AddDays(-1);
                break;
            case "this-quarter":
                int q = (today.Month - 1) / 3;
                SearchStart = new DateTime(today.Year, (q * 3) + 1, 1);
                SearchEnd = SearchStart.Value.AddMonths(3).AddDays(-1);
                break;
            case "last-quarter":
                int lq = ((today.Month - 1) / 3) - 1;
                SearchStart = new DateTime(today.Year, 1, 1).AddMonths(lq * 3);
                SearchEnd = SearchStart.Value.AddMonths(3).AddDays(-1);
                break;
            case "next-quarter":
                int nq = ((today.Month - 1) / 3) + 1;
                SearchStart = new DateTime(today.Year, 1, 1).AddMonths(nq * 3);
                SearchEnd = SearchStart.Value.AddMonths(3).AddDays(-1);
                break;
            case "this-year":
                SearchStart = new DateTime(today.Year, 1, 1);
                SearchEnd = new DateTime(today.Year, 12, 31);
                break;
            case "last-year":
                SearchStart = new DateTime(today.Year - 1, 1, 1);
                SearchEnd = new DateTime(today.Year - 1, 12, 31);
                break;
            case "next-year":
                SearchStart = new DateTime(today.Year + 1, 1, 1);
                SearchEnd = new DateTime(today.Year + 1, 12, 31);
                break;
        }

        await SearchStartChanged.InvokeAsync(SearchStart);
        await SearchEndChanged.InvokeAsync(SearchEnd);
    }
}