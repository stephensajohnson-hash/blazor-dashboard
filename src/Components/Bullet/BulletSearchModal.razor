@namespace Dashboard.Components.Bullet

@if (IsVisible)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-black" 
         @onclick="HandleCancel">
        <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl shadow-2xl p-6 font-black overflow-hidden" 
             @onclick:stopPropagation="true">
            <h3 class="text-blue-400 text-xs tracking-widest mb-6 font-black">
                Advanced Search Engine
            </h3>
            
            <div class="space-y-4 font-black">
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1 font-black">
                        Date Range Scoping
                    </label>
                    <select @onchange="OnPresetChanged" 
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black">
                        <option value="">Manual Selection...</option>
                        <option value="this-month">This Month</option>
                        <option value="last-month">Last Month</option>
                        <option value="next-month">Next Month</option>
                        <option value="this-quarter">This Quarter</option>
                        <option value="last-quarter">Last Quarter</option>
                        <option value="next-quarter">Next Quarter</option>
                        <option value="this-year">This Year</option>
                        <option value="last-year">Last Year</option>
                        <option value="next-year">Next Year</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 font-black">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">From Date</label>
                        <input type="date" 
                               value="@SearchStart.ToString("yyyy-MM-dd")" 
                               @onchange="UpdateStart"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black" />
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Thru Date</label>
                        <input type="date" 
                               value="@SearchEnd.ToString("yyyy-MM-dd")" 
                               @onchange="UpdateEnd"
                               class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black" />
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Identity Type</label>
                    <select value="@SearchType" 
                            @onchange="UpdateType"
                            class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white font-black">
                        <option value="all">All Types</option>
                        <option value="task">Tasks</option>
                        <option value="meeting">Meetings</option>
                        <option value="habit">Habits</option>
                        <option value="health">Health Logs</option>
                        <option value="sports">Sports</option>
                        <option value="birthday">Birthdays</option>
                        <option value="holiday">Holidays</option>
                        <option value="media">Media</option>
                    </select>
                </div>

                <div class="pt-4 flex gap-2 font-black">
                    <button @onclick="HandleCancel" 
                            class="flex-1 py-2 text-[10px] text-gray-500 font-black">
                        Cancel
                    </button>
                    <button @onclick="HandleSearch" 
                            class="flex-1 bg-blue-600 py-2 rounded-lg text-[10px] text-white shadow-lg tracking-widest font-black">
                        Scan Database
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public DateTime SearchStart { get; set; }
    [Parameter] public DateTime SearchEnd { get; set; }
    [Parameter] public string SearchType { get; set; } = "all";
    
    [Parameter] public EventCallback OnSearchRequested { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    
    [Parameter] public EventCallback<DateTime> SearchStartChanged { get; set; }
    [Parameter] public EventCallback<DateTime> SearchEndChanged { get; set; }
    [Parameter] public EventCallback<string> SearchTypeChanged { get; set; }

    private async Task UpdateStart(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var d))
        {
            SearchStart = d;
            await SearchStartChanged.InvokeAsync(d);
        }
    }

    private async Task UpdateEnd(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var d))
        {
            SearchEnd = d;
            await SearchEndChanged.InvokeAsync(d);
        }
    }

    private async Task UpdateType(ChangeEventArgs e)
    {
        SearchType = e.Value?.ToString() ?? "all";
        await SearchTypeChanged.InvokeAsync(SearchType);
    }

    private async Task HandleCancel()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleSearch()
    {
        await OnSearchRequested.InvokeAsync();
    }

    private async Task OnPresetChanged(ChangeEventArgs e)
    {
        var preset = e.Value?.ToString();
        var today = DateTime.Today;

        switch (preset)
        {
            case "this-month":
                SearchStart = new DateTime(today.Year, today.Month, 1);
                SearchEnd = SearchStart.AddMonths(1).AddDays(-1);
                break;
            case "last-month":
                SearchStart = new DateTime(today.Year, today.Month, 1).AddMonths(-1);
                SearchEnd = new DateTime(today.Year, today.Month, 1).AddDays(-1);
                break;
            case "next-month":
                SearchStart = new DateTime(today.Year, today.Month, 1).AddMonths(1);
                SearchEnd = SearchStart.AddMonths(1).AddDays(-1);
                break;
            case "this-quarter":
                int q = (today.Month - 1) / 3;
                SearchStart = new DateTime(today.Year, (q * 3) + 1, 1);
                SearchEnd = SearchStart.AddMonths(3).AddDays(-1);
                break;
            case "last-quarter":
                int lq = ((today.Month - 1) / 3) - 1;
                SearchStart = new DateTime(today.Year, 1, 1).AddMonths(lq * 3);
                SearchEnd = SearchStart.AddMonths(3).AddDays(-1);
                break;
            case "next-quarter":
                int nq = ((today.Month - 1) / 3) + 1;
                SearchStart = new DateTime(today.Year, 1, 1).AddMonths(nq * 3);
                SearchEnd = SearchStart.AddMonths(3).AddDays(-1);
                break;
            case "this-year":
                SearchStart = new DateTime(today.Year, 1, 1);
                SearchEnd = new DateTime(today.Year, 12, 31);
                break;
            case "last-year":
                SearchStart = new DateTime(today.Year - 1, 1, 1);
                SearchEnd = new DateTime(today.Year - 1, 12, 31);
                break;
            case "next-year":
                SearchStart = new DateTime(today.Year + 1, 1, 1);
                SearchEnd = new DateTime(today.Year + 1, 12, 31);
                break;
        }

        await SearchStartChanged.InvokeAsync(SearchStart);
        await SearchEndChanged.InvokeAsync(SearchEnd);
    }
}