@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@inject BulletSportsService SportsService
@inject IServiceScopeFactory ScopeFactory

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-3 overflow-hidden shadow-lg group relative transition hover:border-orange-500/50 flex">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-30">
        <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">‚úï</button>
    </div>

    <div class="w-24 shrink-0 bg-black/30 border-r border-gray-700 flex flex-col items-center justify-center p-2 relative">
        @if(Item.Detail.IsComplete)
        {
            <div class="absolute inset-0 flex items-center justify-center bg-black/60 z-10">
                @if(DidFavoriteWin)
                {
                    <span class="text-green-500 font-black text-xl -rotate-12 border-2 border-green-500 px-1 rounded opacity-80">WIN</span>
                }
                else
                {
                    <span class="text-gray-500 font-black text-lg -rotate-12 border-2 border-gray-500 px-1 rounded opacity-60">FINAL</span>
                }
            </div>
        }
        
        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest leading-tight text-center">
            @LeagueName
            @if(!string.IsNullOrEmpty(SeasonName)) 
            {
                <br/><span class="text-[9px] text-gray-600 normal-case">@SeasonName</span>
            }
        </span>
        
        @if(!Item.Detail.IsComplete)
        {
            <div class="text-lg font-bold text-white mt-1">@Item.Detail.StartTime?.ToString("h:mm")</div>
            <div class="text-[10px] text-gray-400 uppercase">@Item.Detail.StartTime?.ToString("tt")</div>
        }
        else
        {
            <div class="text-xs font-bold text-gray-400 mt-1">FINAL</div>
        }
    </div>

    <div class="flex-1 p-3 min-w-0 flex flex-col justify-center gap-2">
        
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 overflow-hidden">
                @if(!string.IsNullOrEmpty(AwayTeam?.LogoUrl)) { <img src="@AwayTeam.LogoUrl" class="w-5 h-5 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(AwayTeam) ? "text-yellow-400" : "text-white") truncate">
                        @AwayTeam?.Name
                    </span>
                    <span class="text-[9px] text-gray-500">(@AwayRecord)</span>
                </div>
            </div>
            <div class="text-lg font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.AwayScore > Item.Detail.HomeScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.AwayScore > 0 || Item.Detail.IsComplete ? Item.Detail.AwayScore : "")
            </div>
        </div>

        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 overflow-hidden">
                @if(!string.IsNullOrEmpty(HomeTeam?.LogoUrl)) { <img src="@HomeTeam.LogoUrl" class="w-5 h-5 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(HomeTeam) ? "text-yellow-400" : "text-white") truncate">
                        @HomeTeam?.Name
                    </span>
                    <span class="text-[9px] text-gray-500">(@HomeRecord)</span>
                </div>
            </div>
            <div class="text-lg font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.HomeScore > Item.Detail.AwayScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.HomeScore > 0 || Item.Detail.IsComplete ? Item.Detail.HomeScore : "")
            </div>
        </div>

        @if(!string.IsNullOrEmpty(Item.Detail.TvChannel))
        {
            <div class="text-[9px] text-gray-600 uppercase font-bold text-right mt-1">
                üì∫ @Item.Detail.TvChannel
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public BulletSportsService.GameDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private Team? HomeTeam;
    private Team? AwayTeam;
    private string LeagueName = "GAME";
    private string SeasonName = "";
    
    private string HomeRecord = "-";
    private string AwayRecord = "-";

    protected override async Task OnParametersSetAsync()
    {
        // 1. Create a FRESH Scope for this component's data fetching
        // This prevents "NpgsqlOperationInProgressException" when multiple cards load at once
        using (var scope = ScopeFactory.CreateScope())
        {
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            if (Item.Detail.HomeTeamId > 0) 
            {
                HomeTeam = await db.Teams.FindAsync(Item.Detail.HomeTeamId);
                HomeRecord = await CalculatePointInTimeRecord(db, Item.Detail.HomeTeamId, Item.Detail.LeagueId);
            }
                
            if (Item.Detail.AwayTeamId > 0) 
            {
                AwayTeam = await db.Teams.FindAsync(Item.Detail.AwayTeamId);
                AwayRecord = await CalculatePointInTimeRecord(db, Item.Detail.AwayTeamId, Item.Detail.LeagueId);
            }

            if (Item.Detail.LeagueId > 0)
            {
                var l = await db.Leagues.FindAsync(Item.Detail.LeagueId);
                if (l != null) LeagueName = l.Name;
            }

            if (Item.Detail.SeasonId != null && Item.Detail.SeasonId > 0)
            {
                var s = await db.Seasons.FindAsync(Item.Detail.SeasonId);
                if (s != null) SeasonName = s.Name;
            }
        }
        
        StateHasChanged();
    }

    private async Task<string> CalculatePointInTimeRecord(AppDbContext db, int teamId, int leagueId)
    {
        if (leagueId == 0) return "0-0";

        try 
        {
            // Join BulletGameDetails with BulletItems to filter by DATE
            // We want completed games from THIS League, up to (and including) THIS game
            var relevantGames = await (from d in db.BulletGameDetails
                                       join i in db.BulletItems on d.BulletItemId equals i.Id
                                       where d.LeagueId == leagueId
                                          && d.IsComplete 
                                          && (d.HomeTeamId == teamId || d.AwayTeamId == teamId)
                                          && (i.Date < Item.Date || (i.Date == Item.Date && i.Id <= Item.Id))
                                       select d).ToListAsync();

            int wins = 0;
            int losses = 0;
            int ties = 0;

            foreach (var g in relevantGames)
            {
                bool isHome = g.HomeTeamId == teamId;
                int myScore = isHome ? g.HomeScore : g.AwayScore;
                int oppScore = isHome ? g.AwayScore : g.HomeScore;

                if (myScore > oppScore) wins++;
                else if (myScore < oppScore) losses++;
                else ties++;
            }

            return ties > 0 ? $"{wins}-{losses}-{ties}" : $"{wins}-{losses}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error calculating record: {ex.Message}");
            return "Err";
        }
    }

    private bool IsFavorite(Team? t) => t?.IsFavorite ?? false;

    private bool DidFavoriteWin 
    {
        get 
        {
            if (!Item.Detail.IsComplete) return false;
            bool homeFav = IsFavorite(HomeTeam);
            bool awayFav = IsFavorite(AwayTeam);
            
            if (homeFav && Item.Detail.HomeScore > Item.Detail.AwayScore) return true;
            if (awayFav && Item.Detail.AwayScore > Item.Detail.HomeScore) return true;
            return false;
        }
    }

    private async Task HandleClick() 
    {
        var taskDto = new BulletTaskService.TaskDTO 
        { 
            Id = Item.Id, 
            UserId = Item.UserId, 
            Type = "sports", 
            Date = Item.Date,
            Title = Item.Title,
            Description = Item.Description,
            SportsDetail = Item.Detail,
            Category = Item.Category
        };
        await OnClick.InvokeAsync(taskDto); 
    }
    
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}