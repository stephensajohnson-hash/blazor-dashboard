@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@inject BulletSportsService SportsService
@inject AppDbContext Db 

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-3 overflow-hidden shadow-lg group relative transition hover:border-orange-500/50 flex">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-30">
        <button @onclick="HandleClick" class="p-1 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" class="p-1 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">‚úï</button>
    </div>

    <div class="w-24 shrink-0 bg-black/30 border-r border-gray-700 flex flex-col items-center justify-center p-2 relative">
        @if(Item.Detail.IsComplete)
        {
            <div class="absolute inset-0 flex items-center justify-center bg-black/60 z-10">
                @if(DidFavoriteWin)
                {
                    <span class="text-green-500 font-black text-xl -rotate-12 border-2 border-green-500 px-1 rounded opacity-80">WIN</span>
                }
                else
                {
                    <span class="text-gray-500 font-black text-lg -rotate-12 border-2 border-gray-500 px-1 rounded opacity-60">FINAL</span>
                }
            </div>
        }
        
        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">@LeagueName</span>
        
        @if(!Item.Detail.IsComplete)
        {
            <div class="text-lg font-bold text-white">@Item.Detail.StartTime?.ToString("h:mm")</div>
            <div class="text-[10px] text-gray-400 uppercase">@Item.Detail.StartTime?.ToString("tt")</div>
        }
        else
        {
            <div class="text-xs font-bold text-gray-400">FINAL</div>
        }
    </div>

    <div class="flex-1 p-3 min-w-0 flex flex-col justify-center gap-2">
        
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 overflow-hidden">
                @if(!string.IsNullOrEmpty(AwayTeam?.LogoUrl)) { <img src="@AwayTeam.LogoUrl" class="w-5 h-5 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(AwayTeam) ? "text-yellow-400" : "text-white") truncate">
                        @AwayTeam?.Name
                    </span>
                    @if (ShowRecords)
                    {
                        <span class="text-[9px] text-gray-500">(@GetRecord(AwayTeam))</span>
                    }
                </div>
            </div>
            <div class="text-lg font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.AwayScore > Item.Detail.HomeScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.AwayScore > 0 || Item.Detail.IsComplete ? Item.Detail.AwayScore : "")
            </div>
        </div>

        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 overflow-hidden">
                @if(!string.IsNullOrEmpty(HomeTeam?.LogoUrl)) { <img src="@HomeTeam.LogoUrl" class="w-5 h-5 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(HomeTeam) ? "text-yellow-400" : "text-white") truncate">
                        @HomeTeam?.Name
                    </span>
                    @if (ShowRecords)
                    {
                        <span class="text-[9px] text-gray-500">(@GetRecord(HomeTeam))</span>
                    }
                </div>
            </div>
            <div class="text-lg font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.HomeScore > Item.Detail.AwayScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.HomeScore > 0 || Item.Detail.IsComplete ? Item.Detail.HomeScore : "")
            </div>
        </div>

        @if(!string.IsNullOrEmpty(Item.Detail.TvChannel))
        {
            <div class="text-[9px] text-gray-600 uppercase font-bold text-right mt-1">
                üì∫ @Item.Detail.TvChannel
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public BulletSportsService.GameDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private Team? HomeTeam;
    private Team? AwayTeam;
    private string LeagueName = "GAME";

    // Show records if date is past OR game is explicitly marked complete
    private bool ShowRecords => Item.Date <= DateTime.UtcNow.AddHours(12) || Item.Detail.IsComplete;

    protected override async Task OnParametersSetAsync()
    {
        // FIX: Use Db context directly since Service methods were missing
        if (Item.Detail.HomeTeamId > 0) 
            HomeTeam = await Db.Teams.FindAsync(Item.Detail.HomeTeamId);
            
        if (Item.Detail.AwayTeamId > 0) 
            AwayTeam = await Db.Teams.FindAsync(Item.Detail.AwayTeamId);

        if (Item.Detail.LeagueId > 0)
        {
            var l = await Db.Leagues.FindAsync(Item.Detail.LeagueId);
            if (l != null) LeagueName = l.Name;
        }
    }

    private bool IsFavorite(Team? t) => t?.IsFavorite ?? false;

    private string GetRecord(Team? t) 
    {
        return "0-0"; 
    }

    private bool DidFavoriteWin 
    {
        get 
        {
            if (!Item.Detail.IsComplete) return false;
            bool homeFav = IsFavorite(HomeTeam);
            bool awayFav = IsFavorite(AwayTeam);
            
            if (homeFav && Item.Detail.HomeScore > Item.Detail.AwayScore) return true;
            if (awayFav && Item.Detail.AwayScore > Item.Detail.HomeScore) return true;
            return false;
        }
    }

    private async Task HandleClick() 
    {
        // Convert GameDTO back to TaskDTO structure for the editor
        var taskDto = new BulletTaskService.TaskDTO 
        { 
            Id = Item.Id, 
            UserId = Item.UserId, 
            Type = "sports", 
            Date = Item.Date,
            Title = Item.Title,
            Description = Item.Description,
            SportsDetail = Item.Detail, // Use correct property
            Category = Item.Category
        };
        await OnClick.InvokeAsync(taskDto); 
    }
    
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}