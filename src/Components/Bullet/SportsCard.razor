@namespace Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ScopeFactory

<div class="bg-gray-800 border border-gray-700 rounded-lg mb-3 overflow-hidden shadow-lg group relative transition hover:border-orange-500/50 flex">
    
    <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition z-30">
        <button @onclick="HandleClick" class="p-1.5 rounded bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white border border-gray-600 shadow-md">‚úèÔ∏è</button>
        <button @onclick="HandleDelete" class="p-1.5 rounded bg-gray-700 hover:bg-red-600 text-red-400 hover:text-white border border-gray-600 shadow-md">‚úï</button>
    </div>

    <div class="w-28 shrink-0 bg-black/30 border-r border-gray-700 flex flex-col items-center justify-center p-2 relative">
        @if(Item.Detail.IsComplete)
        {
            <div class="absolute inset-0 flex items-center justify-center bg-black/60 z-10">
                <span class="font-black text-xl -rotate-12 border-2 px-2 py-0.5 rounded opacity-90 @(DidFavoriteWin ? "text-green-500 border-green-500" : "text-gray-400 border-gray-500")">
                    @(DidFavoriteWin ? "WIN" : "FINAL")
                </span>
            </div>
        }
        
        <div class="flex flex-col items-center gap-0.5 mb-1">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider text-center leading-tight">@LeagueName</span>
            @if(!string.IsNullOrEmpty(SeasonName)) 
            { 
                <span class="text-xs text-gray-500 font-normal">@SeasonName</span> 
            }
        </div>
        
        @if(!Item.Detail.IsComplete)
        {
            <div class="text-xl font-bold text-white">@Item.Detail.StartTime?.ToString("h:mm")</div>
            <div class="text-xs text-gray-400 uppercase font-bold">@Item.Detail.StartTime?.ToString("tt")</div>
        }
    </div>

    <div class="flex-1 p-4 min-w-0 flex flex-col justify-center gap-3">
        
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3 overflow-hidden">
                @if(!string.IsNullOrEmpty(AwayTeam?.LogoUrl)) { <img src="@AwayTeam.LogoUrl" class="w-6 h-6 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(AwayTeam) ? "text-yellow-400" : "text-white") truncate">
                        @AwayTeam?.Name
                    </span>
                    @if(IsFavorite(AwayTeam))
                    {
                        <span class="text-xs font-bold text-gray-400">(@AwayRecord)</span>
                    }
                </div>
            </div>
            <div class="text-xl font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.AwayScore > Item.Detail.HomeScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.AwayScore > 0 || Item.Detail.IsComplete ? Item.Detail.AwayScore : "")
            </div>
        </div>

        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3 overflow-hidden">
                @if(!string.IsNullOrEmpty(HomeTeam?.LogoUrl)) { <img src="@HomeTeam.LogoUrl" class="w-6 h-6 object-contain" /> }
                <div class="flex flex-col truncate">
                    <span class="text-sm font-bold @(IsFavorite(HomeTeam) ? "text-yellow-400" : "text-white") truncate">
                        @HomeTeam?.Name
                    </span>
                    @if(IsFavorite(HomeTeam))
                    {
                        <span class="text-xs font-bold text-gray-400">(@HomeRecord)</span>
                    }
                </div>
            </div>
            <div class="text-xl font-bold font-mono @(Item.Detail.IsComplete && Item.Detail.HomeScore > Item.Detail.AwayScore ? "text-white" : "text-gray-500")">
                @(Item.Detail.HomeScore > 0 || Item.Detail.IsComplete ? Item.Detail.HomeScore : "")
            </div>
        </div>

        @if(!string.IsNullOrEmpty(Item.Detail.TvChannel)) 
        { 
            <div class="text-xs text-blue-400 font-bold text-right mt-1">üì∫ @Item.Detail.TvChannel</div> 
        }
    </div>
</div>

@code {
    [Parameter] public BulletSportsService.GameDTO Item { get; set; } = new();
    [Parameter] public EventCallback<BulletTaskService.TaskDTO> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnDelete { get; set; }

    private Team? HomeTeam;
    private Team? AwayTeam;
    private string LeagueName = "GAME";
    private string SeasonName = "";
    
    private string HomeRecord = "-";
    private string AwayRecord = "-";

    protected override async Task OnParametersSetAsync()
    {
        // Isolated scope to prevent concurrency issues
        using (var scope = ScopeFactory.CreateScope())
        {
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            if (Item.Detail.HomeTeamId > 0) 
            {
                HomeTeam = await db.Teams.FindAsync(Item.Detail.HomeTeamId);
                // ONLY calculate if Favorite
                if (IsFavorite(HomeTeam)) 
                {
                    HomeRecord = await CalculatePointInTimeRecord(db, Item.Detail.HomeTeamId, Item.Detail.LeagueId);
                }
            }
                
            if (Item.Detail.AwayTeamId > 0) 
            {
                AwayTeam = await db.Teams.FindAsync(Item.Detail.AwayTeamId);
                // ONLY calculate if Favorite
                if (IsFavorite(AwayTeam))
                {
                    AwayRecord = await CalculatePointInTimeRecord(db, Item.Detail.AwayTeamId, Item.Detail.LeagueId);
                }
            }

            if (Item.Detail.LeagueId > 0)
            {
                var l = await db.Leagues.FindAsync(Item.Detail.LeagueId);
                if (l != null) LeagueName = l.Name;
            }

            if (Item.Detail.SeasonId != null && Item.Detail.SeasonId > 0)
            {
                var s = await db.Seasons.FindAsync(Item.Detail.SeasonId);
                if (s != null) SeasonName = s.Name;
            }
        }
        StateHasChanged();
    }

    private async Task<string> CalculatePointInTimeRecord(AppDbContext db, int teamId, int leagueId)
    {
        if (leagueId == 0) return "0-0";

        var relevantGames = await (from d in db.BulletGameDetails
                                   join i in db.BulletItems on d.BulletItemId equals i.Id
                                   where d.LeagueId == leagueId
                                      && d.IsComplete 
                                      && (d.HomeTeamId == teamId || d.AwayTeamId == teamId)
                                      && (i.Date < Item.Date || (i.Date == Item.Date && i.Id <= Item.Id))
                                   select d).ToListAsync();

        int wins = 0;
        int losses = 0;
        int ties = 0;

        foreach (var g in relevantGames)
        {
            bool isHome = g.HomeTeamId == teamId;
            int myScore = isHome ? g.HomeScore : g.AwayScore;
            int oppScore = isHome ? g.AwayScore : g.HomeScore;

            if (myScore > oppScore) wins++;
            else if (myScore < oppScore) losses++;
            else ties++;
        }

        return ties > 0 ? $"{wins}-{losses}-{ties}" : $"{wins}-{losses}";
    }

    private bool IsFavorite(Team? t) => t?.IsFavorite ?? false;

    private bool DidFavoriteWin 
    {
        get 
        {
            if (!Item.Detail.IsComplete) return false;
            bool homeFav = IsFavorite(HomeTeam);
            bool awayFav = IsFavorite(AwayTeam);
            
            if (homeFav && Item.Detail.HomeScore > Item.Detail.AwayScore) return true;
            if (awayFav && Item.Detail.AwayScore > Item.Detail.HomeScore) return true;
            return false;
        }
    }

    private async Task HandleClick() 
    {
        var taskDto = new BulletTaskService.TaskDTO 
        { 
            Id = Item.Id, UserId = Item.UserId, Type = "sports", Date = Item.Date, Title = Item.Title, Description = Item.Description, 
            SportsDetail = Item.Detail, Category = Item.Category 
        };
        await OnClick.InvokeAsync(taskDto); 
    }
    
    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item.Id);
}