@namespace Dashboard.Components.Bullet.Editors
@using Dashboard

<div class="bg-black/30 p-4 rounded border border-gray-700 space-y-4">
    
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ† League</label>
            <select @bind="Detail.LeagueId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-sm text-white focus:border-blue-500 outline-none">
                <option value="0">-- Select League --</option>
                @if (Leagues != null)
                {
                    @foreach(var l in Leagues) { <option value="@l.Id">@l.Name</option> }
                }
            </select>
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ“… Season</label>
            <select @bind="Detail.SeasonId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-sm text-white focus:border-blue-500 outline-none">
                <option value="0">-- Select Season --</option>
                @if (Seasons != null)
                {
                    @foreach(var s in Seasons.Where(x => x.LeagueId == Detail.LeagueId || Detail.LeagueId == 0)) 
                    { 
                        <option value="@s.Id">@s.Name</option> 
                    }
                }
            </select>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸƒâ€â™‚ï¸ Away Team</label>
            <select @bind="Detail.AwayTeamId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm text-white focus:border-blue-500 outline-none">
                <option value="0">-- Select --</option>
                @foreach(var t in GetFilteredTeams()) { 
                    <option value="@t.Id">@((t.IsFavorite ? "â˜… " : "") + t.Name)</option> 
                }
            </select>
            <input type="number" @bind="Detail.AwayScore" class="w-full mt-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-white text-center font-bold" placeholder="Score" />
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ  Home Team</label>
            <select @bind="Detail.HomeTeamId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm text-white focus:border-blue-500 outline-none">
                <option value="0">-- Select --</option>
                @foreach(var t in GetFilteredTeams()) { 
                    <option value="@t.Id">@((t.IsFavorite ? "â˜… " : "") + t.Name)</option> 
                }
            </select>
            <input type="number" @bind="Detail.HomeScore" class="w-full mt-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-white text-center font-bold" placeholder="Score" />
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">â° Start Time</label>
            @* Note: type="time" binding requires a specific string format; 
               Ensure Detail.StartTime is not null or handled by the parent *@
            <input type="time" value="@(Detail.StartTime?.ToString("HH:mm"))" 
                   @onchange="@((e) => UpdateTime(e.Value?.ToString()))"
                   class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" />
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ“º Channel</label>
            <input @bind="Detail.TvChannel" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" placeholder="TV / Stream" />
        </div>
    </div>

    <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded border border-gray-700">
        <input type="checkbox" @bind="Detail.IsComplete" id="chkSport" class="w-5 h-5 rounded bg-gray-800 border-gray-600 text-green-500" />
        <label for="chkSport" class="text-sm text-white cursor-pointer select-none">âœ… Game Final / Completed</label>
    </div>
</div>

@code {
    [Parameter] public BulletGameDetail Detail { get; set; } = new();
    
    [Parameter] public List<League> Leagues { get; set; } = new();
    [Parameter] public List<Season> Seasons { get; set; } = new();
    [Parameter] public List<Team> Teams { get; set; } = new();

    private IEnumerable<Team> GetFilteredTeams()
    {
        if (Teams == null) return Enumerable.Empty<Team>();
        
        var q = Teams.AsEnumerable();
        if (Detail.LeagueId > 0)
        {
            q = q.Where(t => t.LeagueId == Detail.LeagueId);
        }
        return q.OrderByDescending(t => t.IsFavorite).ThenBy(t => t.Name);
    }

    private void UpdateTime(string? timeValue)
    {
        if (TimeSpan.TryParse(timeValue, out var time))
        {
            // Preserve the existing date, just update the time
            var date = Detail.StartTime ?? DateTime.Today;
            Detail.StartTime = date.Date + time;
        }
    }
}