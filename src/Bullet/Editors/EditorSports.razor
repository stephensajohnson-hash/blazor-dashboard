@namespace Dashboard.Components.Bullet.Editors
@using Dashboard
@using Microsoft.EntityFrameworkCore
@inject BulletSportsService SportsService
@inject AppDbContext Db 

<div class="bg-black/30 p-4 rounded border border-gray-700 space-y-4">
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ† League</label>
            <select @bind="Detail.LeagueId" @bind:after="OnLeagueChanged" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-sm text-white">
                <option value="0">-- Select League --</option>
                @foreach(var l in leagues) { <option value="@l.Id">@l.Name</option> }
            </select>
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ“… Season</label>
            <select @bind="Detail.SeasonId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-sm text-white">
                <option value="0">-- Select Season --</option>
                @foreach(var s in seasons) { <option value="@s.Id">@s.Name</option> }
            </select>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸƒâ€â™‚ï¸ Away Team</label>
            <select @bind="Detail.AwayTeamId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm text-white">
                <option value="0">-- Select --</option>
                @foreach(var t in filteredTeams) { 
                    <option value="@t.Id">@((t.IsFavorite ? "â˜… " : "") + t.Name)</option> 
                }
            </select>
            <input type="number" @bind="Detail.AwayScore" class="w-full mt-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-white text-center font-bold" placeholder="0" />
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ  Home Team</label>
            <select @bind="Detail.HomeTeamId" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm text-white">
                <option value="0">-- Select --</option>
                @foreach(var t in filteredTeams) { 
                    <option value="@t.Id">@((t.IsFavorite ? "â˜… " : "") + t.Name)</option> 
                }
            </select>
            <input type="number" @bind="Detail.HomeScore" class="w-full mt-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-white text-center font-bold" placeholder="0" />
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">â° Start Time</label>
            <input type="time" @bind="Detail.StartTime" @bind:format="HH:mm" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" />
        </div>
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ“º Channel</label>
            <input @bind="Detail.TvChannel" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" placeholder="TV" />
        </div>
    </div>

    <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded border border-gray-700">
        <input type="checkbox" @bind="Detail.IsComplete" id="chkSport" class="w-5 h-5 rounded bg-gray-800 border-gray-600 text-green-500" />
        <label for="chkSport" class="text-sm text-white cursor-pointer">âœ… Game Final</label>
    </div>
    
    <div class="text-[9px] text-gray-600 font-mono mt-2 border-t border-gray-800 pt-1">
        DEBUG: Lg:@Detail.LeagueId | Seas:@Detail.SeasonId | Teams:@filteredTeams.Count
    </div>
</div>

@code {
    [Parameter] public BulletGameDetail Detail { get; set; } = new();
    [Parameter] public int UserId { get; set; }

    private List<League> leagues = new();
    private List<Season> seasons = new();
    private List<Team> allTeams = new();
    private List<Team> filteredTeams = new();

    protected override async Task OnParametersSetAsync()
    {
        if (UserId > 0)
        {
            // 1. Ensure Reference Data (Leagues/Teams) is Loaded
            if (!leagues.Any()) 
            {
                leagues = await SportsService.GetLeagues(UserId);
                allTeams = await SportsService.GetTeams(UserId);
            }
            
            // 2. Load Seasons specific to the selected League (if any)
            if (Detail.LeagueId > 0 && (!seasons.Any() || seasons.First().LeagueId != Detail.LeagueId))
            {
                await LoadSeasonsForLeague(Detail.LeagueId);
            }

            // 3. Filter Teams
            FilterTeams();
        }
    }

    private async Task OnLeagueChanged()
    {
        // When League changes: Reload Seasons, Reset Selection, Re-filter Teams
        Detail.SeasonId = 0;
        await LoadSeasonsForLeague(Detail.LeagueId);
        FilterTeams();
        
        Detail.HomeTeamId = 0;
        Detail.AwayTeamId = 0;
        StateHasChanged();
    }

    private async Task LoadSeasonsForLeague(int leagueId)
    {
        // Direct DB fetch for seasons since Service might not have a specific helper exposed
        seasons = await Db.Seasons
            .Where(s => s.LeagueId == leagueId)
            .OrderByDescending(s => s.Name)
            .ToListAsync();
    }

    private void FilterTeams()
    {
        if (Detail.LeagueId > 0)
        {
            filteredTeams = allTeams
                .Where(t => t.LeagueId == Detail.LeagueId)
                .OrderByDescending(t => t.IsFavorite) 
                .ThenBy(t => t.Name)
                .ToList();
        }
        else
        {
            filteredTeams = new List<Team>();
        }
        StateHasChanged();
    }
}