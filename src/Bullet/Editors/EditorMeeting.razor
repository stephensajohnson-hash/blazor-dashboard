@namespace Dashboard.Components.Bullet.Editors
@using Dashboard

<div class="bg-black/30 p-4 rounded border border-gray-700 space-y-3">
    
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">⏰ Start Time</label>
            <input type="time" @bind="Detail.StartTime" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" />
        </div>
        
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">⏳ Duration</label>
            <input type="text" 
                   value="@FormatDuration(Detail.DurationMinutes)" 
                   @onchange="@(e => Detail.DurationMinutes = ParseTime(e.Value?.ToString()))"
                   class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-blue-500 outline-none" 
                   placeholder="e.g. 1h, 30m, 1.5h" />
        </div>
    </div>

    <div>
        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">✅ Actual Time Spent</label>
        <input type="text" 
               value="@FormatDuration(Detail.ActualDurationMinutes)" 
               @onchange="@(e => Detail.ActualDurationMinutes = ParseTime(e.Value?.ToString()))"
               class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-green-500 outline-none" 
               placeholder="e.g. 45m, 1h 15m" />
        <div class="text-[9px] text-gray-600 mt-1 italic">Supports: "90", "1h 30m", "1.5h", "45m"</div>
    </div>

    <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded border border-gray-700">
        <input type="checkbox" checked="@IsCompleted" @onchange="OnIsCompletedChange" id="chkMeet" class="w-5 h-5 rounded bg-gray-800 border-gray-600 text-blue-500 focus:ring-offset-gray-800" />
        <label for="chkMeet" class="text-sm text-white cursor-pointer select-none">Mark as Complete</label>
    </div>

</div>

@code {
    [Parameter] public BulletMeetingDetail Detail { get; set; } = new();
    
    // Binding for IsCompleted (Passed from parent/DTO)
    [Parameter] public bool IsCompleted { get; set; }
    [Parameter] public EventCallback<bool> IsCompletedChanged { get; set; }

    private async Task OnIsCompletedChange(ChangeEventArgs e)
    {
        IsCompleted = (bool)(e.Value ?? false);
        await IsCompletedChanged.InvokeAsync(IsCompleted);
    }

    private int ParseTime(string? input)
    {
        if (string.IsNullOrWhiteSpace(input)) return 0;
        input = input.ToLower().Trim();
        try 
        {
            if (input.Contains("."))
            {
                string clean = input.Replace("h", "").Replace("m", "").Trim();
                if (double.TryParse(clean, out double val)) return (int)(val * 60);
            }
            if (input.EndsWith("m") && !input.Contains("h"))
            {
                return int.TryParse(input.Replace("m", "").Trim(), out int val) ? val : 0;
            }
            int totalMin = 0;
            var parts = input.Split(new[] { 'h', 'm', ' ' }, StringSplitOptions.RemoveEmptyEntries);
            if (input.Contains("h"))
            {
                if (parts.Length > 0 && int.TryParse(parts[0], out int h)) totalMin += h * 60;
                if (parts.Length > 1 && int.TryParse(parts[1], out int m)) totalMin += m;
            }
            else if (int.TryParse(input, out int raw)) totalMin = raw;
            return totalMin;
        }
        catch { return 0; }
    }

    private string FormatDuration(int minutes)
    {
        if (minutes <= 0) return "";
        if (minutes < 60) return $"{minutes}m";
        int h = minutes / 60;
        int m = minutes % 60;
        return m > 0 ? $"{h}h {m}m" : $"{h}h";
    }
}