@namespace Dashboard.Components.Bullet.Editors
@using Dashboard

<div class="bg-black/30 p-4 rounded border border-gray-700 space-y-3">
    
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">â° Start Time</label>
            <input type="time" @bind="Detail.StartTime" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" />
        </div>
        
        <div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">â³ Duration</label>
            <input type="text" 
                   value="@FormatDuration(Detail.DurationMinutes)" 
                   @onchange="@(e => Detail.DurationMinutes = ParseTime(e.Value?.ToString()))"
                   class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-blue-500 outline-none" 
                   placeholder="e.g. 1h, 30m, 1.5h" />
        </div>
    </div>

    <div>
        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">âœ… Actual Time Spent</label>
        <input type="text" 
               value="@FormatDuration(Detail.ActualDurationMinutes)" 
               @onchange="@(e => Detail.ActualDurationMinutes = ParseTime(e.Value?.ToString()))"
               class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm focus:border-green-500 outline-none" 
               placeholder="e.g. 45m, 1h 15m" />
        <div class="text-[9px] text-gray-600 mt-1 italic">Supports: "90", "1h 30m", "1.5h", "45m"</div>
    </div>

    <div>
        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ‘¥ Attendees</label>
        <input type="text" @bind="Detail.Attendees" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-white text-sm" placeholder="Names..." />
    </div>

    <div>
        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ğŸ”— Meeting Link</label>
        <input type="text" @bind="Detail.LinkUrl" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-2 text-blue-400 text-sm underline" placeholder="https://zoom.us/..." />
    </div>

    <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded border border-gray-700">
        <input type="checkbox" @bind="Detail.IsComplete" id="chkMeet" class="w-5 h-5 rounded bg-gray-800 border-gray-600 text-blue-500 focus:ring-offset-gray-800" />
        <label for="chkMeet" class="text-sm text-white cursor-pointer select-none">Mark as Complete</label>
    </div>

</div>

@code {
    [Parameter] public BulletMeetingDetail Detail { get; set; } = new();

    // Converts human strings ("1h 30m") to minutes (90)
    private int ParseTime(string? input)
    {
        if (string.IsNullOrWhiteSpace(input)) return 0;
        input = input.ToLower().Trim();

        try 
        {
            // Case 1: Decimal Hours ("1.5" or "1.5h") -> check for dot
            if (input.Contains("."))
            {
                string clean = input.Replace("h", "").Replace("m", "").Trim();
                if (double.TryParse(clean, out double val)) return (int)(val * 60);
            }

            // Case 2: Explicit Minutes ("45m")
            if (input.EndsWith("m") && !input.Contains("h"))
            {
                string clean = input.Replace("m", "").Trim();
                return int.TryParse(clean, out int val) ? val : 0;
            }

            // Case 3: Mixed ("1h 30m" or "1h")
            int totalMin = 0;
            var parts = input.Split(new[] { 'h', 'm', ' ' }, StringSplitOptions.RemoveEmptyEntries);

            if (input.Contains("h"))
            {
                // Parse first number as hours
                if (parts.Length > 0 && int.TryParse(parts[0], out int h)) totalMin += h * 60;
                // Parse second number as minutes
                if (parts.Length > 1 && int.TryParse(parts[1], out int m)) totalMin += m;
            }
            else
            {
                // Case 4: Raw number ("90") -> assume minutes
                if (int.TryParse(input, out int raw)) totalMin = raw;
            }
            
            return totalMin;
        }
        catch 
        {
            return 0; 
        }
    }

    // Converts 90 -> "1h 30m" for display
    private string FormatDuration(int minutes)
    {
        if (minutes <= 0) return "";
        if (minutes < 60) return $"{minutes}m";
        int h = minutes / 60;
        int m = minutes % 60;
        return m > 0 ? $"{h}h {m}m" : $"{h}h";
    }
}