@page "/manage-data"
@using Dashboard
@using Microsoft.JSInterop
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold">üíæ Data Management</h1>
            <a href="/bullet-calendar" class="text-gray-400 hover:text-white">‚Üê Back to Calendar</a>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-bold text-blue-400 mb-4">1. Database Schema</h2>
            <p class="text-gray-400 text-sm mb-4">Run this if you see SQL errors or missing columns.</p>
            <button @onclick="FixSchema" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold transition">
                üõ†Ô∏è Fix Tables & Columns
            </button>
            <div class="mt-2 font-mono text-xs text-green-400">@schemaMsg</div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-bold text-green-400 mb-4">2. Import Data</h2>
            <div class="flex gap-4 items-center">
                <button @onclick="ImportTasks" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold border border-gray-600 transition">
                    üì• Import Tasks (JSON)
                </button>
                <span class="text-xs text-gray-500">Reads from 'wwwroot/bullet_calendar.json'</span>
            </div>
            <div class="mt-2 font-mono text-xs text-green-400">@importMsg</div>
        </div>

        <div class="bg-gray-800 border border-red-900/50 rounded-xl p-6">
            <h2 class="text-xl font-bold text-red-400 mb-4">3. Danger Zone</h2>
            
            <div class="flex gap-4">
                <button @onclick='() => ClearData("task")' class="bg-red-900/30 hover:bg-red-900/50 text-red-300 border border-red-800 px-4 py-2 rounded font-bold transition">
                    üóëÔ∏è Delete ALL Tasks
                </button>
                
                <button @onclick="DropLegacy" class="bg-red-900/30 hover:bg-red-900/50 text-red-300 border border-red-800 px-4 py-2 rounded font-bold transition">
                    üí£ Drop Legacy Tables
                </button>
            </div>
            <div class="mt-2 font-mono text-xs text-red-300">@deleteMsg</div>
        </div>
    </div>
</div>

@code {
    private string schemaMsg = "";
    private string importMsg = "";
    private string deleteMsg = "";
    private int userId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json)) { 
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if(doc.RootElement.TryGetProperty("UserId", out var p)) userId = p.GetInt32();
            }
        }
    }

    private async Task FixSchema()
    {
        schemaMsg = "Running...";
        try {
            await BaseService.CreateBaseTablesIfMissing();
            await TaskService.CreateTable();
            schemaMsg = "‚úÖ Database Schema Updated.";
        } catch(Exception ex) { schemaMsg = "‚ùå Error: " + ex.Message; }
    }

    private async Task ImportTasks()
    {
        importMsg = "Reading...";
        try {
            var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if(System.IO.File.Exists(path)) {
                var content = await System.IO.File.ReadAllTextAsync(path);
                await TaskService.ImportFromOldJson(userId, content);
                importMsg = "‚úÖ Tasks Imported.";
            } else { importMsg = "‚ùå File not found."; }
        } catch(Exception ex) { importMsg = "‚ùå Error: " + ex.Message; }
    }

    private async Task ClearData(string type)
    {
        if(await JS.InvokeAsync<bool>("confirm", $"Delete ALL {type}s? This cannot be undone.")) {
            deleteMsg = "Deleting...";
            await BaseService.ClearDataByType(userId, type);
            deleteMsg = $"‚úÖ All {type}s deleted.";
        }
    }

    private async Task DropLegacy()
    {
        if(await JS.InvokeAsync<bool>("confirm", "Delete old unused tables?")) {
            deleteMsg = "Dropping...";
            await BaseService.DropLegacyTables();
            deleteMsg = "‚úÖ Legacy tables dropped.";
        }
    }
}