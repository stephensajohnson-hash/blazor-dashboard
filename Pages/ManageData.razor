@page "/manage-data"
@using Dashboard
@using Microsoft.JSInterop
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsGameService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white p-8 font-mono">
    <div class="max-w-4xl mx-auto">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-yellow-400">‚ö†Ô∏è Data Manager</h1>
            <a href="/bullet-calendar" class="text-gray-400 hover:text-white">Back to Calendar</a>
        </div>

        <div class="bg-black border border-green-800 p-4 rounded h-64 overflow-y-auto mb-6 shadow-lg text-xs">
            <div class="text-green-600 mb-2">--- SYSTEM LOG STREAM ---</div>
            @foreach(var log in logs) { <div class="border-b border-gray-900 pb-1 mb-1 font-mono text-gray-300">@log</div> }
        </div>

        <div class="bg-gray-800 p-4 rounded mb-6 border border-gray-700">
            <h3 class="font-bold text-white mb-2">1. Diagnostics</h3>
            <div class="flex gap-2">
                <button @onclick="Ping" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500">Test Connection</button>
                <button @onclick="FixSchema" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500">Run Schema Fixer</button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded mb-6 border border-gray-700">
             <h3 class="font-bold text-green-400 mb-2">2. Import</h3>
             <div class="flex gap-2 flex-wrap">
                <button @onclick="ImportTasks" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600">üì• Tasks</button>
                <button @onclick="ImportMeetings" class="bg-purple-700 text-white px-4 py-2 rounded hover:bg-purple-600">üì• Meetings</button>
                <button @onclick="ImportHabits" class="bg-cyan-700 text-white px-4 py-2 rounded hover:bg-cyan-600">üì• Habits</button>
                <button @onclick="ImportMedia" class="bg-pink-700 text-white px-4 py-2 rounded hover:bg-pink-600">üì• Media</button>
                <button @onclick="ImportHolidays" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600">üì• Holidays</button>
                <button @onclick="ImportBirthdays" class="bg-yellow-700 text-white px-4 py-2 rounded hover:bg-yellow-600">üì• Birthdays</button>
                <button @onclick="ImportAnniversaries" class="bg-indigo-700 text-white px-4 py-2 rounded hover:bg-indigo-600">üì• Anniversaries</button>
                <button @onclick="ImportVacations" class="bg-red-700 text-white px-4 py-2 rounded hover:bg-red-600">üì• Vacations</button>
                <button @onclick="ImportHealth" class="bg-emerald-700 text-white px-4 py-2 rounded hover:bg-emerald-600">üì• Health</button>
                <button @onclick="ImportSports" class="bg-orange-700 text-white px-4 py-2 rounded hover:bg-orange-600">üì• Sports</button>
             </div>
        </div>

        <div class="bg-red-900/20 p-4 rounded border border-red-900">
            <h3 class="font-bold text-red-400 mb-2">3. Danger Zone</h3>
            
            <div class="flex gap-4 items-center flex-wrap">
                @if(!deleteTasksConfirm) { <button @onclick="() => deleteTasksConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Tasks</button> } 
                else { <button @onclick="DeleteTasks" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteTasksConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteMeetingsConfirm) { <button @onclick="() => deleteMeetingsConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Meetings</button> } 
                else { <button @onclick="DeleteMeetings" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteMeetingsConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteHabitsConfirm) { <button @onclick="() => deleteHabitsConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Habits</button> } 
                else { <button @onclick="DeleteHabits" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteHabitsConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteMediaConfirm) { <button @onclick="() => deleteMediaConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Media</button> } 
                else { <button @onclick="DeleteMedia" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteMediaConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteHolidaysConfirm) { <button @onclick="() => deleteHolidaysConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Holidays</button> } 
                else { <button @onclick="DeleteHolidays" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteHolidaysConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteBirthdaysConfirm) { <button @onclick="() => deleteBirthdaysConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Birthdays</button> } 
                else { <button @onclick="DeleteBirthdays" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteBirthdaysConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteAnniversariesConfirm) { <button @onclick="() => deleteAnniversariesConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Anniversaries</button> } 
                else { <button @onclick="DeleteAnniversaries" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteAnniversariesConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteVacationsConfirm) { <button @onclick="() => deleteVacationsConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Vacations</button> } 
                else { <button @onclick="DeleteVacations" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteVacationsConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteHealthConfirm) { <button @onclick="() => deleteHealthConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Health</button> } 
                else { <button @onclick="DeleteHealth" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteHealthConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }

                @if(!deleteSportsConfirm) { <button @onclick="() => deleteSportsConfirm = true" class="bg-red-900/30 text-red-300 px-4 py-2 rounded hover:bg-red-900 border border-red-800">üóëÔ∏è Delete Sports</button> } 
                else { <button @onclick="DeleteSports" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 animate-pulse">CONFIRM</button> <button @onclick="() => deleteSportsConfirm = false" class="text-xs text-gray-400 underline">Cancel</button> }
            </div>
        </div>

    </div>
</div>

@code {
    private List<string> logs = new();
    private int userId = 1;
    private bool deleteTasksConfirm = false;
    private bool deleteMeetingsConfirm = false;
    private bool deleteHabitsConfirm = false;
    private bool deleteMediaConfirm = false;
    private bool deleteHolidaysConfirm = false;
    private bool deleteBirthdaysConfirm = false;
    private bool deleteAnniversariesConfirm = false;
    private bool deleteVacationsConfirm = false;
    private bool deleteHealthConfirm = false;
    private bool deleteSportsConfirm = false; // NEW

    private void Log(string msg) { var line = $"{DateTime.Now:HH:mm:ss} > {msg}"; logs.Insert(0, line); Console.WriteLine(line); StateHasChanged(); }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            Log("Page Loaded.");
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) { using(var doc = JsonDocument.Parse(json)) { if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) { userId = p.GetInt32(); Log($"Session: User {userId}"); } } }
            } catch { Log("No session found. Using User 1"); }
        }
    }

    private void Ping() => Log("PONG! Active.");
    private async Task FixSchema() { Log("Running Schema Fix..."); try { await BaseService.CreateBaseTablesIfMissing(); Log("Schema Fix Done."); } catch (Exception ex) { Log($"Schema Error: {ex.Message}"); } }

    private async Task ImportTasks() { Log("Reading Task JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await TaskService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Tasks."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportMeetings() { Log("Reading Meeting JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await MeetingService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Meetings."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportHabits() { Log("Reading Habit JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await HabitService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Habits."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportMedia() { Log("Reading Media JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await MediaService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Media Items."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportHolidays() { Log("Reading Holiday JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await HolidayService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Holidays."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportBirthdays() { Log("Reading Birthday JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await BirthdayService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Birthdays."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportAnniversaries() { Log("Reading Anniversary JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await AnniversaryService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Anniversaries."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportVacations() { Log("Reading Vacation JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await VacationService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Vacations."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    private async Task ImportHealth() { Log("Reading Health JSON..."); try { var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); if (System.IO.File.Exists(path)) { var content = await System.IO.File.ReadAllTextAsync(path); int count = await HealthService.ImportFromOldJson(userId, content); Log($"‚úÖ Imported {count} Health items."); } else { Log("‚ùå File not found."); } } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } }
    
    // NEW: Import Sports Games
    private async Task ImportSports() 
    { 
        Log("Reading Sports JSON..."); 
        try { 
            var path = System.IO.Path.Combine(Env.WebRootPath, "bullet_calendar.json"); 
            if (System.IO.File.Exists(path)) { 
                var content = await System.IO.File.ReadAllTextAsync(path); 
                int count = await SportsGameService.ImportGames(userId, content); 
                Log($"‚úÖ Imported {count} Sports Games."); 
            } else { Log("‚ùå File not found."); } 
        } catch (Exception ex) { Log($"Import Error: {ex.Message}"); } 
    }

    private async Task DeleteTasks() { deleteTasksConfirm = false; Log($"Deleting tasks..."); try { int count = await BaseService.ClearDataByType(userId, "task"); Log($"üóëÔ∏è Deleted {count} tasks."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteMeetings() { deleteMeetingsConfirm = false; Log($"Deleting meetings..."); try { int count = await BaseService.ClearDataByType(userId, "meeting"); Log($"üóëÔ∏è Deleted {count} meetings."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteHabits() { deleteHabitsConfirm = false; Log($"Deleting habits..."); try { int count = await BaseService.ClearDataByType(userId, "habit"); Log($"üóëÔ∏è Deleted {count} habits."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteMedia() { deleteMediaConfirm = false; Log($"Deleting media..."); try { int count = await BaseService.ClearDataByType(userId, "media"); Log($"üóëÔ∏è Deleted {count} media items."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteHolidays() { deleteHolidaysConfirm = false; Log($"Deleting holidays..."); try { int count = await BaseService.ClearDataByType(userId, "holiday"); Log($"üóëÔ∏è Deleted {count} holidays."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteBirthdays() { deleteBirthdaysConfirm = false; Log($"Deleting birthdays..."); try { int count = await BaseService.ClearDataByType(userId, "birthday"); Log($"üóëÔ∏è Deleted {count} birthdays."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteAnniversaries() { deleteAnniversariesConfirm = false; Log($"Deleting anniversaries..."); try { int count = await BaseService.ClearDataByType(userId, "anniversary"); Log($"üóëÔ∏è Deleted {count} anniversaries."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteVacations() { deleteVacationsConfirm = false; Log($"Deleting vacations..."); try { int count = await BaseService.ClearDataByType(userId, "vacation"); Log($"üóëÔ∏è Deleted {count} vacations."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    private async Task DeleteHealth() { deleteHealthConfirm = false; Log($"Deleting health..."); try { int count = await BaseService.ClearDataByType(userId, "health"); Log($"üóëÔ∏è Deleted {count} health items."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
    
    // NEW: Delete Sports Games
    private async Task DeleteSports() { deleteSportsConfirm = false; Log($"Deleting sports games..."); try { int count = await BaseService.ClearDataByType(userId, "sports"); Log($"üóëÔ∏è Deleted {count} sports games."); } catch (Exception ex) { Log($"Delete Error: {ex.Message}"); } }
}