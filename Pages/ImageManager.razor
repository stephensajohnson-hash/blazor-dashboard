@page "/image-manager"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Dashboard
@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Image Registry | Stephens' Dashboard</PageTitle>

<BulletHeader ShowControls="false" CustomDateText="Image Registry">
    <div class="flex items-center gap-2 ml-4">
        @* Tab Switcher *@
        <div class="flex bg-black/40 rounded-lg p-1 border border-gray-700 mr-4">
            <button @onclick='() => activeTab = "registry"' class="px-3 py-1 rounded-md text-[10px] font-black uppercase transition @(activeTab == "registry" ? "bg-blue-600 text-white" : "text-gray-500 hover:text-gray-300")">Registry</button>
            <button @onclick='() => activeTab = "broken"' class="px-3 py-1 rounded-md text-[10px] font-black uppercase transition @(activeTab == "broken" ? "bg-red-600 text-white" : "text-gray-500 hover:text-gray-300")">Broken Links (@brokenLinks.Count)</button>
        </div>

        @if (activeTab == "registry")
        {
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
                <input @bind="searchQuery" @bind:event="oninput" placeholder="Search filenames..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
            </div>

            <div class="flex items-center gap-2 ml-4">
                <button @onclick="PrevPage" disabled="@(currentPage == 1)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">PREV</button>
                <span class="text-[10px] font-mono text-blue-400 min-w-[80px] text-center bg-black/40 py-1 rounded-lg border border-gray-800">Page @currentPage</span>
                <button @onclick="NextPage" disabled="@(!hasMorePages)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">NEXT</button>
            </div>
        }

        <button @onclick="LoadImages" 
                class="text-[10px] text-blue-400 hover:text-white font-black uppercase ml-4 px-2 py-1 border border-blue-900/30 rounded-lg hover:bg-blue-900/20 transition-all">ðŸ”„ Sync Data</button>
    </div>
</BulletHeader>

<div class="p-6">
    @if (activeTab == "registry")
    {
        @if (allImages == null)
        {
            <div class="flex justify-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                @* SORTED: Orphaned (Count 0) first, then by Upload Date *@
                @foreach (var img in allImages.OrderBy(i => usageDetails.ContainsKey(i.Id) && usageDetails[i.Id].TotalCount > 0).ThenByDescending(i => i.UploadedAt))
                {
                    var usage = usageDetails.ContainsKey(img.Id) ? usageDetails[img.Id] : new ImageUsage();
                    var displayPath = $"/db-images/{img.Id}";

                    <div class="group relative bg-[#0f0f0f] border border-gray-800 rounded-2xl overflow-hidden shadow-2xl hover:border-blue-500/50 transition-all">
                        <div class="absolute top-2 right-2 z-10 px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-tighter shadow-xl backdrop-blur-md
                                    @(usage.TotalCount > 0 ? "bg-green-500/20 text-green-400 border border-green-500/30" : "bg-red-500/20 text-red-400 border border-red-500/30")">
                            @(usage.TotalCount == 0 ? "Orphaned" : $"{usage.TotalCount} Links")
                        </div>

                        <button @onclick="() => DeleteOne(img.Id)" 
                                class="absolute top-2 left-2 z-10 p-2 bg-black/60 hover:bg-red-600 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity shadow-xl font-black text-xs">âœ•</button>

                        <div class="aspect-video bg-black cursor-pointer overflow-hidden" @onclick="() => NavigateToSource(usage)">
                            <img src="@displayPath" alt="@img.OriginalName" class="w-full h-full object-cover group-hover:scale-105 transition-all duration-500" />
                        </div>
                        
                        <div class="p-3">
                            <div class="text-[10px] font-black text-gray-500 truncate mb-1 uppercase">@img.OriginalName</div>
                            <div class="bg-black/80 border border-gray-700 p-2 rounded text-[10px] font-mono text-blue-400 mb-3 select-all truncate shadow-inner">@displayPath</div>
                            <div class="flex gap-2">
                                <button @onclick="() => CopyPath(img.Id)" class="flex-1 bg-gray-900 py-2 rounded text-[9px] font-black uppercase border border-gray-700 hover:bg-blue-600 transition shadow-md">Copy Path</button>
                                @if(usage.IsCalendar) {
                                    <button @onclick="() => NavigateToSource(usage)" class="flex-1 bg-blue-600/20 text-blue-400 py-2 rounded text-[9px] font-black uppercase border border-blue-500/30 hover:bg-blue-600 hover:text-white transition">ðŸ“… Day</button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        @* BROKEN LINKS TAB *@
        <div class="space-y-4">
            <div class="bg-red-900/10 border border-red-900/30 p-4 rounded-2xl mb-6">
                <p class="text-xs text-red-400 font-black uppercase tracking-widest">The system is scanning @allSystemImageUrls.Count active links. Broken items will appear below.</p>
            </div>

            @if (!brokenLinks.Any())
            {
                <div class="text-center py-20 border-2 border-dashed border-gray-800 rounded-3xl">
                    <p class="text-gray-500 font-black uppercase tracking-widest">No broken links detected so far</p>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 gap-3">
                    @foreach (var url in brokenLinks)
                    {
                        <div class="flex items-center justify-between bg-black/40 border border-red-900/30 p-4 rounded-xl">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-red-900/20 border border-red-900/40 rounded flex items-center justify-center text-red-500 font-black">!</div>
                                <div>
                                    <div class="text-[10px] font-mono text-gray-400 truncate max-w-md">@url</div>
                                    <div class="text-[8px] text-red-400 font-black uppercase tracking-widest">Link Unreachable</div>
                                </div>
                            </div>
                            <button @onclick="() => CopyRawPath(url)" class="px-4 py-2 bg-gray-800 rounded text-[9px] font-black uppercase hover:bg-blue-600 transition">Copy URL</button>
                        </div>
                    }
                </div>
            }

            @* Hidden Scanner: Renders all system URLs to trigger browser error events *@
            <div class="hidden">
                @foreach (var url in allSystemImageUrls)
                {
                    <img src="@url" @onerror='() => ReportBrokenLink(url)' />
                }
            </div>
        </div>
    }
</div>

@code {
    private string activeTab = "registry";
    private List<Dashboard.StoredImage>? allImages;
    private Dictionary<int, ImageUsage> usageDetails = new(); 
    private List<string> allSystemImageUrls = new();
    private HashSet<string> brokenLinks = new();
    private string searchQuery = "";
    private int currentPage = 1;
    private int pageSize = 50;
    private bool hasMorePages = true;

    public class ImageUsage {
        public int TotalCount { get; set; } = 0;
        public bool IsCalendar { get; set; } = false;
        public bool IsRecipe { get; set; } = false;
        public bool IsBudget { get; set; } = false;
        public bool IsDashboard { get; set; } = false;
        public DateTime? CalendarDate { get; set; }
    }

    protected override async Task OnInitializedAsync() => await LoadImages();

    private void ReportBrokenLink(string url) { brokenLinks.Add(url); StateHasChanged(); }

    private async Task NextPage() { currentPage++; await LoadImages(); }
    private async Task PrevPage() { currentPage--; await LoadImages(); }

    private async Task LoadImages()
    {
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            var query = db.StoredImages.AsNoTracking().OrderByDescending(i => i.UploadedAt).AsQueryable();
            if (!string.IsNullOrWhiteSpace(searchQuery)) query = query.Where(i => i.OriginalName.Contains(searchQuery));

            allImages = await query.Skip((currentPage - 1) * pageSize).Take(pageSize).ToListAsync();
            hasMorePages = allImages.Count == pageSize;

            usageDetails = new();
            var currentPaths = allImages.Select(i => $"/db-images/{i.Id}").ToList();

            // 1. GATHER ALL SYSTEM URLS
            var paths = new List<string?>();
            paths.AddRange(await db.BulletItems.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.BulletItemNotes.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.BudgetItems.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.BudgetIncomeSources.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.Leagues.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.Seasons.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.Teams.Select(x => x.LogoUrl).ToListAsync());
            paths.AddRange(await db.Links.Select(x => x.Img).ToListAsync());
            paths.AddRange(await db.Countdowns.Select(x => x.Img).ToListAsync());
            paths.AddRange(await db.Stocks.Select(x => x.ImgUrl).ToListAsync());
            paths.AddRange(await db.Recipes.Select(x => x.ImageUrl).ToListAsync());
            paths.AddRange(await db.RecipeCategories.Select(x => x.ImageUrl).ToListAsync());

            allSystemImageUrls = paths.Where(p => !string.IsNullOrEmpty(p)).Distinct().ToList()!;

            // 2. RECIPE IDS
            var explicitIds = new List<int>();
            explicitIds.AddRange(await db.Recipes.Where(x => x.ImageId != null).Select(x => x.ImageId!.Value).ToListAsync());
            explicitIds.AddRange(await db.RecipeCategories.Where(x => x.ImageId != null).Select(x => x.ImageId!.Value).ToListAsync());

            // 3. CALENDAR DATES
            var calMatches = await db.BulletItems.AsNoTracking().Where(x => currentPaths.Contains(x.ImgUrl)).Select(x => new { x.ImgUrl, x.Date }).ToListAsync();

            // 4. MAP USAGE
            foreach (var img in allImages)
            {
                var path = $"/db-images/{img.Id}";
                var usage = new ImageUsage();
                var calHits = calMatches.Where(x => x.ImgUrl == path).ToList();
                usage.IsCalendar = calHits.Any();
                if(usage.IsCalendar) usage.CalendarDate = calHits.OrderBy(x => x.Date).First().Date;
                usage.IsRecipe = explicitIds.Contains(img.Id) || await db.Recipes.AnyAsync(r => r.ImageUrl == path) || await db.RecipeCategories.AnyAsync(c => c.ImageUrl == path);
                usage.IsBudget = await db.BudgetItems.AnyAsync(b => b.ImgUrl == path) || await db.BudgetIncomeSources.AnyAsync(i => i.ImgUrl == path);
                usage.TotalCount = paths.Count(x => x == path) + explicitIds.Count(x => x == img.Id);
                usageDetails[img.Id] = usage;
            }
            StateHasChanged();
        } catch (Exception ex) { await JS.InvokeVoidAsync("console.log", ex.Message); }
    }

    private void NavigateToSource(ImageUsage usage) 
    {
        if (usage.IsCalendar && usage.CalendarDate.HasValue) Nav.NavigateTo($"/bullet-calendar?date={usage.CalendarDate.Value:yyyy-MM-dd}", forceLoad: true);
        else if (usage.IsRecipe) Nav.NavigateTo("/recipes");
        else if (usage.IsBudget) Nav.NavigateTo("/budget-tracker");
    }

    private async Task CopyPath(int id) => await CopyRawPath($"/db-images/{id}");
    private async Task CopyRawPath(string path) => await JS.InvokeVoidAsync("navigator.clipboard.writeText", path);

    private async Task DeleteOne(int id) 
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"Permanently delete image #{id}?")) return;
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            var img = await db.StoredImages.FindAsync(id);
            if (img != null) { db.StoredImages.Remove(img); await db.SaveChangesAsync(); await LoadImages(); }
        } catch { }
    }
}