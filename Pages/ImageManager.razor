@page "/image-manager"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Dashboard
@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Image Registry | Stephens' Dashboard</PageTitle>

<BulletHeader ShowControls="false" CustomDateText="Image Registry">
    <div class="flex items-center gap-2 ml-4">
        <div class="flex bg-black/40 rounded-lg p-1 border border-gray-700 mr-4 shadow-inner">
            <button @onclick='() => activeTab = "registry"' 
                    class="px-3 py-1 rounded-md text-[10px] font-black transition @(activeTab == "registry" ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                Registry
            </button>
            <button @onclick='() => activeTab = "broken"' 
                    class="px-3 py-1 rounded-md text-[10px] font-black transition @(activeTab == "broken" ? "bg-red-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                Broken Links (@brokenLinks.Count)
            </button>
        </div>

        @if (activeTab == "registry")
        {
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
                <input @bind="searchQuery" 
                       @bind:event="oninput" 
                       placeholder="Search filenames..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
            </div>

            <div class="flex items-center gap-2 ml-4">
                <button @onclick="PrevPage" 
                        disabled="@(currentPage == 1)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">
                    PREV
                </button>
                <span class="text-[10px] font-mono text-blue-400 min-w-[80px] text-center bg-black/40 py-1 rounded-lg border border-gray-800">
                    Page @currentPage
                </span>
                <button @onclick="NextPage" 
                        disabled="@(!hasMorePages)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">
                    NEXT
                </button>
            </div>
        }
    </div>
</BulletHeader>

<div class="p-6">
    @if (activeTab == "registry")
    {
        @if (allImages == null)
        {
            <div class="flex justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 pb-20 font-black">
                @foreach (var img in allImages)
                {
                    var usage = usageDetails.ContainsKey(img.Id) ? usageDetails[img.Id] : new ImageUsage();
                    var displayPath = $"/db-images/{img.Id}";

                    <div class="group relative bg-[#0f0f0f] border border-gray-800 rounded-xl shadow-2xl hover:border-blue-500/50 transition-all flex items-start">
                        
                        @* SURGICAL: 2x2 Clickable Floating Hover Preview *@
                        <div class="absolute -top-2 -left-2 z-[100] opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <a href="@displayPath" target="_blank" class="block cursor-zoom-in">
                                <div class="bg-black/95 p-1 rounded-lg border border-gray-600 shadow-2xl backdrop-blur-md">
                                    <img src="@displayPath" 
                                         style="max-width: 192px; max-height: 192px;" 
                                         class="object-contain rounded" />
                                </div>
                            </a>
                        </div>

                        @* LEFT SIDE: Image *@
                        <div class="relative bg-black shrink-0 border-r border-gray-700/50 overflow-hidden" style="width: @BulletViewConfig.ImgWidthDay;">
                            <img src="@displayPath" 
                                 alt="@img.OriginalName" 
                                 class="w-full h-auto block opacity-90 transition-all duration-500" />
                            
                            <button @onclick="() => DeleteOne(img.Id)" 
                                    class="absolute top-1 left-1 z-10 p-1.5 bg-black/60 hover:bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity shadow-xl font-black text-[10px]">
                                ‚úï
                            </button>
                        </div>

                        @* RIGHT SIDE: Info *@
                        <div class="flex-1 flex flex-col p-3 min-w-0">
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="px-2 py-1 rounded text-[11px] font-black shadow-xl bg-black/95 border 
                                            @(usage.TotalCount > 0 ? "text-green-400 border-green-500/30" : "text-red-400 border-red-500/30")">
                                    @(usage.TotalCount == 0 ? "Orphaned" : $"{usage.TotalCount} times")
                                </span>

                                @if (usage.IsCalendar && usage.CalendarDate.HasValue)
                                {
                                    <span class="px-2 py-1 rounded text-[9px] font-black shadow-xl bg-blue-950/50 border border-blue-500/30 text-blue-300 font-mono">
                                        üìÖ @usage.CalendarDate.Value.ToString("MMM dd, yyyy")
                                    </span>
                                }
                            </div>

                            <div class="text-[10px] font-black text-gray-500 truncate mb-1">
                                @img.OriginalName
                            </div>

                            <div class="bg-black/60 border border-gray-700 p-1.5 rounded text-[9px] font-mono text-blue-500 mb-3 select-all truncate">
                                @displayPath
                            </div>

                            <div class="flex flex-col gap-1 mt-auto">
                                <button @onclick="() => CopyRawPath(displayPath)" 
                                        class="w-full bg-gray-900 py-1.5 rounded text-[8px] font-black border border-gray-700 hover:bg-blue-600 transition shadow-md">
                                    Copy Path
                                </button>
                                
                                @if(usage.IsCalendar) {
                                    <button @onclick="() => NavigateToSource(usage)" class="w-full bg-blue-600/20 text-blue-400 py-1.5 rounded text-[8px] font-black border border-blue-500/30 hover:bg-blue-600 hover:text-white transition shadow-md">üìÖ View Day</button>
                                }
                                else if(usage.IsRecipe) {
                                    <button @onclick='() => Nav.NavigateTo("/recipes")' class="w-full bg-green-600/20 text-green-400 py-1.5 rounded text-[8px] font-black border border-green-500/30 hover:bg-green-600 hover:text-white transition shadow-md">üç≥ Recipes</button>
                                }
                                else if(usage.IsBudget) {
                                    <button @onclick='() => Nav.NavigateTo("/budget-tracker")' class="w-full bg-purple-600/20 text-purple-400 py-1.5 rounded text-[8px] font-black border border-purple-500/30 hover:bg-purple-600 hover:text-white transition shadow-md">üí∞ Budget</button>
                                }
                                else if(usage.IsSports) {
                                    <button @onclick='() => Nav.NavigateTo("/manage-sports")' class="w-full bg-orange-600/20 text-orange-400 py-1.5 rounded text-[8px] font-black border border-orange-500/30 hover:bg-orange-600 hover:text-white transition shadow-md">üèÜ Sports</button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="space-y-4 font-black">
            <div class="bg-red-900/10 border border-red-900/30 p-4 rounded-2xl mb-6">
                <p class="text-xs text-red-400 font-black tracking-widest">
                    Scanning all validated active links. Orphaned records filtered out.
                </p>
            </div>

            @if (!brokenLinks.Any())
            {
                <div class="text-center py-20 border-2 border-dashed border-gray-800 rounded-3xl">
                    <p class="text-gray-500 font-black tracking-widest">No broken links detected</p>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 gap-4">
                    @foreach (var url in brokenLinks)
                    {
                        var sources = allSystemContexts.Where(x => x.Url == url).ToList();
                        <div class="bg-black/40 border border-red-900/30 p-5 rounded-2xl shadow-xl flex flex-col gap-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] font-mono text-red-400 truncate mb-1">@url</div>
                                    <h4 class="text-xs text-gray-500 tracking-widest">
                                        Found in @sources.Count active location(s):
                                    </h4>
                                </div>
                                <button @onclick="() => CopyRawPath(url)" 
                                        class="px-4 py-1.5 bg-gray-800 rounded text-[9px] font-black hover:bg-blue-600 transition shrink-0 ml-4 shadow-lg">
                                    Copy URL
                                </button>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                @foreach (var src in sources)
                                {
                                    <div class="bg-black/60 border border-gray-800 p-3 rounded-xl flex flex-col justify-between hover:border-blue-500 transition-colors cursor-pointer shadow-md" 
                                         @onclick="() => NavigateToSpecific(src)">
                                        <div>
                                            <div class="text-[8px] text-blue-500 font-black mb-1">@src.Area</div>
                                            <div class="text-[10px] text-white truncate">@src.Title</div>
                                        </div>
                                        @if(src.Date.HasValue) {
                                            <div class="text-[8px] text-gray-500 mt-2 font-bold">
                                                üìÖ @src.Date.Value.ToString("MMM dd, yyyy")
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="hidden">
                @foreach (var context in allSystemContexts)
                {
                    <img src="@context.Url" @onerror='() => ReportBrokenLink(context.Url)' />
                }
            </div>
        </div>
    }
</div>

@code {
    private string activeTab = "registry";
    private List<Dashboard.StoredImage>? allImages;
    private Dictionary<int, ImageUsage> usageDetails = new(); 
    private List<LinkSource> allSystemContexts = new();
    private HashSet<string> brokenLinks = new();
    private string searchQuery = ""; private int currentPage = 1; private int pageSize = 50; private bool hasMorePages = true;

    public class ImageUsage { 
        public int TotalCount { get; set; } = 0; 
        public bool IsCalendar { get; set; } = false; 
        public bool IsRecipe { get; set; } = false; 
        public bool IsBudget { get; set; } = false;
        public bool IsSports { get; set; } = false;
        public DateTime? CalendarDate { get; set; } 
    }
    
    public class LinkSource {
        public string Url { get; set; } = "";
        public string Area { get; set; } = ""; 
        public string Title { get; set; } = ""; 
        public DateTime? Date { get; set; }
    }

    protected override async Task OnInitializedAsync() => await LoadImages();

    private void ReportBrokenLink(string url) { brokenLinks.Add(url); StateHasChanged(); }
    private async Task NextPage() { currentPage++; await LoadImages(); }
    private async Task PrevPage() { currentPage--; await LoadImages(); }

    private async Task LoadImages()
    {
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            int userId = 1; 
            if (!string.IsNullOrEmpty(json)) {
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) 
                    userId = p.GetInt32();
            }

            var baseQuery = db.StoredImages.AsNoTracking().AsQueryable();
            if (!string.IsNullOrWhiteSpace(searchQuery)) 
                baseQuery = baseQuery.Where(i => i.OriginalName.Contains(searchQuery));

            var fullRegistry = await baseQuery.ToListAsync();
            allSystemContexts.Clear();
            
            // 1. CALENDAR
            var bulletItems = await db.BulletItems.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.ImgUrl))
                .Select(x => new LinkSource { Url = x.ImgUrl, Area = "Calendar", Title = x.Title, Date = x.Date })
                .ToListAsync();
            allSystemContexts.AddRange(bulletItems);
            
            var bulletNotes = await (from n in db.BulletItemNotes
                                   join i in db.BulletItems on n.BulletItemId equals i.Id
                                   where i.UserId == userId && n.ImgUrl != null && n.ImgUrl != ""
                                   select new LinkSource { Url = n.ImgUrl, Area = "Note Log", Title = n.Content, Date = i.Date }).ToListAsync();
            allSystemContexts.AddRange(bulletNotes);

            // 2. RECIPES
            var recipes = await db.Recipes.AsNoTracking()
                .Where(x => x.UserId == userId)
                .ToListAsync();
            foreach(var r in recipes) {
                if(!string.IsNullOrEmpty(r.ImageUrl)) 
                    allSystemContexts.Add(new LinkSource { Url = r.ImageUrl, Area = "Recipe", Title = r.Title });
                if(r.ImageId.HasValue) 
                    allSystemContexts.Add(new LinkSource { Url = $"/db-images/{r.ImageId}", Area = "Recipe", Title = r.Title });
            }

            var cats = await db.RecipeCategories.AsNoTracking()
                .Where(x => x.UserId == userId)
                .ToListAsync();
            foreach(var c in cats) {
                if(!string.IsNullOrEmpty(c.ImageUrl)) 
                    allSystemContexts.Add(new LinkSource { Url = c.ImageUrl, Area = "Recipe Category", Title = c.Name });
                if(c.ImageId.HasValue) 
                    allSystemContexts.Add(new LinkSource { Url = $"/db-images/{c.ImageId}", Area = "Recipe Category", Title = c.Name });
            }

            // 3. BUDGET
            var budget = await (from bi in db.BudgetItems
                               join bc in db.BudgetCycles on bi.BudgetCycleId equals bc.Id
                               join bp in db.BudgetPeriods on bc.BudgetPeriodId equals bp.Id
                               where bp.UserId == userId && !string.IsNullOrEmpty(bi.ImgUrl)
                               select new LinkSource { Url = bi.ImgUrl, Area = "Budget Item", Title = bi.Name }).ToListAsync();
            allSystemContexts.AddRange(budget);

            var income = await db.BudgetIncomeSources.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.ImgUrl))
                .Select(x => new LinkSource { Url = x.ImgUrl, Area = "Income Source", Title = x.Name })
                .ToListAsync();
            allSystemContexts.AddRange(income);

            // 4. SPORTS
            var leagues = await db.Leagues.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.ImgUrl))
                .Select(x => new LinkSource { Url = x.ImgUrl, Area = "Sports League", Title = x.Name })
                .ToListAsync();
            allSystemContexts.AddRange(leagues);

            var seasons = await db.Seasons.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.ImgUrl))
                .Select(x => new LinkSource { Url = x.ImgUrl, Area = "Sports Season", Title = x.Name })
                .ToListAsync();
            allSystemContexts.AddRange(seasons);

            var teams = await db.Teams.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.LogoUrl))
                .Select(x => new LinkSource { Url = x.LogoUrl, Area = "Sports Team", Title = x.Name })
                .ToListAsync();
            allSystemContexts.AddRange(teams);

            // 5. DASHBOARD
            var activeLinks = await (from l in db.Links
                                   join lg in db.LinkGroups on l.LinkGroupId equals lg.Id
                                   where lg.UserId == userId && !string.IsNullOrEmpty(l.Img)
                                   select new LinkSource { Url = l.Img, Area = "Dashboard Link", Title = l.Name }).ToListAsync();
            allSystemContexts.AddRange(activeLinks);

            var dashCounts = await db.Countdowns.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.Img))
                .Select(x => new LinkSource { Url = x.Img, Area = "Countdown", Title = x.Name }).ToListAsync();
            allSystemContexts.AddRange(dashCounts);

            var stocks = await db.Stocks.AsNoTracking()
                .Where(x => x.UserId == userId && !string.IsNullOrEmpty(x.ImgUrl))
                .Select(x => new LinkSource { Url = x.ImgUrl, Area = "Stock", Title = x.Symbol }).ToListAsync();
            allSystemContexts.AddRange(stocks);

            // 6. MAPPING
            foreach (var img in fullRegistry) {
                var path = $"/db-images/{img.Id}";
                var matches = allSystemContexts.Where(x => x.Url == path).ToList();
                
                var usage = new ImageUsage {
                    TotalCount = matches.Count,
                    IsCalendar = matches.Any(x => x.Area == "Calendar" || x.Area == "Note Log"),
                    IsRecipe = matches.Any(x => x.Area.Contains("Recipe")),
                    IsBudget = matches.Any(x => x.Area.Contains("Budget") || x.Area == "Income Source"),
                    IsSports = matches.Any(x => x.Area.Contains("Sports") || x.Area.Contains("Team") || x.Area.Contains("League") || x.Area.Contains("Season")),
                    CalendarDate = matches.FirstOrDefault(x => x.Date.HasValue)?.Date
                };
                usageDetails[img.Id] = usage;
            }

            // 7. SORT THEN PAGINATE
            allImages = fullRegistry
                .OrderByDescending(i => usageDetails[i.Id].TotalCount)
                .ThenByDescending(i => i.UploadedAt)
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            hasMorePages = fullRegistry.Count > (currentPage * pageSize);
            StateHasChanged();
        } catch (Exception ex) { await JS.InvokeVoidAsync("console.log", "SYNC_ERROR: " + ex.Message); }
    }

    private void NavigateToSource(ImageUsage usage) {
        if (usage.IsCalendar && usage.CalendarDate.HasValue) Nav.NavigateTo($"/bullet-calendar?date={usage.CalendarDate.Value:yyyy-MM-dd}", forceLoad: true);
        else if (usage.IsRecipe) Nav.NavigateTo("/recipes");
        else if (usage.IsBudget) Nav.NavigateTo("/budget-tracker");
        else if (usage.IsSports) Nav.NavigateTo("/manage-sports");
    }

    private void NavigateToSpecific(LinkSource src) {
        if ((src.Area == "Calendar" || src.Area == "Note Log") && src.Date.HasValue) Nav.NavigateTo($"/bullet-calendar?date={src.Date.Value:yyyy-MM-dd}", forceLoad: true);
        else if (src.Area.Contains("Recipe")) Nav.NavigateTo("/recipes");
        else if (src.Area.Contains("Budget") || src.Area == "Income Source") Nav.NavigateTo("/budget-tracker");
        else if (src.Area.Contains("Sports") || src.Area.Contains("Team") || src.Area.Contains("League") || src.Area.Contains("Season")) Nav.NavigateTo("/manage-sports");
        else Nav.NavigateTo("/");
    }

    private async Task CopyRawPath(string path) => await JS.InvokeVoidAsync("navigator.clipboard.writeText", path);

    private async Task DeleteOne(int id) {
        if (!await JS.InvokeAsync<bool>("confirm", $"Permanently delete image #{id}?")) return;
        using var scope = ScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var img = await db.StoredImages.FindAsync(id);
        if (img != null) { db.StoredImages.Remove(img); await db.SaveChangesAsync(); await LoadImages(); }
    }
}