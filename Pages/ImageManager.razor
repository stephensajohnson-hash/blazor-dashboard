@code {
    private List<Dashboard.StoredImage>? allImages;
    private string searchQuery = "";

    private IEnumerable<Dashboard.StoredImage> filteredImages => 
        (allImages ?? new List<Dashboard.StoredImage>())
        .DistinctBy(i => i.Id)
        .Where(i => string.IsNullOrWhiteSpace(searchQuery) || (i.OriginalName ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync() => await LoadImages();

    private void ClearSearch() => searchQuery = "";

    private async Task LoadImages()
    {
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            allImages = await db.StoredImages.OrderByDescending(i => i.UploadedAt).ToListAsync();
        }
        catch (Exception ex) { Console.WriteLine($"Load Error: {ex.Message}"); }
    }

    private void NavigateToDay(DateTime date) => Nav.NavigateTo($"/bullet-calendar?date={date:yyyy-MM-dd}");

    private async Task CopyUrl(int id)
    {
        var url = $"{Nav.BaseUri}db-images/{id}";
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
    }

    private async Task CleanupOrphanedImages()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "This will only delete images NOT linked to any calendar items. Proceed?");
        if (!confirmed) return;

        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            // --- REVISED LOGIC TO FIND USED IMAGES ---
            // We search the main table where your bullet items are stored. 
            // Replace "BulletItems" with "Tasks" or whatever your table is actually named.
            
            // CHECK TABLE NAME: Is it db.Tasks? db.BulletItems? db.Entries?
            var usedImageIds = await db.StoredImages
                .Join(db.BulletItems, // <--- CHANGE THIS to your actual tasks table name
                      img => img.Id,
                      item => item.ImageId,
                      (img, item) => img.Id)
                .Distinct()
                .ToListAsync();

            var allImagesInDb = await db.StoredImages.ToListAsync();
            var unusedImages = allImagesInDb.Where(img => !usedImageIds.Contains(img.Id)).ToList();

            if (unusedImages.Any())
            {
                db.StoredImages.RemoveRange(unusedImages);
                await db.SaveChangesAsync();
                Console.WriteLine($"Cleanup successful: Removed {unusedImages.Count} orphaned images.");
                
                // Fixed the JS Alert syntax error
                await JS.InvokeVoidAsync("alert", $"Cleanup complete. Removed {unusedImages.Count} unused images.");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "No orphaned images found. Your registry is already clean!");
            }

            await LoadImages();
            StateHasChanged();
        } 
        catch (Exception ex) { 
            Console.WriteLine($"Cleanup Error: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "Error during cleanup. Check the debug console.");
        }
    }
}