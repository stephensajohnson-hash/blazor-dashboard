@page "/image-manager"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Dashboard
@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Image Registry | Stephens' Dashboard</PageTitle>

<BulletHeader ShowControls="false" CustomDateText="Image Registry">
    <div class="flex items-center gap-2 ml-4">
        <div class="flex bg-black/40 rounded-lg p-1 border border-gray-700 mr-4 shadow-inner">
            <button @onclick='() => activeTab = "registry"' 
                    class="px-3 py-1 rounded-md text-[10px] font-black uppercase transition @(activeTab == "registry" ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                Registry
            </button>
            <button @onclick='() => activeTab = "broken"' 
                    class="px-3 py-1 rounded-md text-[10px] font-black uppercase transition @(activeTab == "broken" ? "bg-red-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                Broken Links (@brokenLinks.Count)
            </button>
        </div>

        @if (activeTab == "registry")
        {
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
                <input @bind="searchQuery" @bind:event="oninput" placeholder="Search filenames..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
            </div>

            <div class="flex items-center gap-2 ml-4">
                <button @onclick="PrevPage" disabled="@(currentPage == 1)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">PREV</button>
                <span class="text-[10px] font-mono text-blue-400 min-w-[80px] text-center bg-black/40 py-1 rounded-lg border border-gray-800">Page @currentPage</span>
                <button @onclick="NextPage" disabled="@(!hasMorePages)" 
                        class="px-3 py-1 bg-gray-800 rounded-lg disabled:opacity-30 text-[10px] font-black hover:bg-blue-600 transition shadow-lg">NEXT</button>
            </div>
        }

        <button @onclick="LoadImages" class="text-[10px] text-blue-400 hover:text-white font-black uppercase ml-4 px-2 py-1 border border-blue-900/30 rounded-lg hover:bg-blue-900/20 transition-all">ðŸ”„ Sync Data</button>
    </div>
</BulletHeader>

<div class="p-6">
    @if (activeTab == "registry")
    {
        @if (allImages == null)
        {
            <div class="flex justify-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20 font-black">
                @foreach (var img in allImages.OrderBy(i => usageDetails.ContainsKey(i.Id) && usageDetails[i.Id].TotalCount > 0).ThenByDescending(i => i.UploadedAt))
                {
                    var usage = usageDetails.ContainsKey(img.Id) ? usageDetails[img.Id] : new ImageUsage();
                    var displayPath = $"/db-images/{img.Id}";

                    <div class="group relative bg-[#0f0f0f] border border-gray-800 rounded-2xl overflow-hidden shadow-2xl hover:border-blue-500/50 transition-all">
                        <div class="absolute top-2 right-2 z-10 px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-tighter shadow-xl backdrop-blur-md
                                    @(usage.TotalCount > 0 ? "bg-green-500/20 text-green-400 border border-green-500/30" : "bg-red-500/20 text-red-400 border border-red-500/30")">
                            @(usage.TotalCount == 0 ? "Orphaned" : $"{usage.TotalCount} Links")
                        </div>

                        <button @onclick="() => DeleteOne(img.Id)" class="absolute top-2 left-2 z-10 p-2 bg-black/60 hover:bg-red-600 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity shadow-xl">âœ•</button>

                        <div class="aspect-video bg-black cursor-pointer overflow-hidden" @onclick="() => NavigateToSource(usage)">
                            <img src="@displayPath" alt="@img.OriginalName" class="w-full h-full object-cover group-hover:scale-105 transition-all duration-500" />
                        </div>
                        
                        <div class="p-3">
                            <div class="text-[10px] font-black text-gray-500 truncate mb-1 uppercase">@img.OriginalName</div>
                            <div class="bg-black/80 border border-gray-700 p-2 rounded text-[10px] font-mono text-blue-400 mb-3 select-all truncate">@displayPath</div>
                            <div class="flex gap-2">
                                <button @onclick="() => CopyRawPath(displayPath)" class="flex-1 bg-gray-900 py-2 rounded text-[9px] font-black uppercase border border-gray-700 hover:bg-blue-600 transition shadow-md">Copy Path</button>
                                @if(usage.IsCalendar) {
                                    <button @onclick="() => NavigateToSource(usage)" class="flex-1 bg-blue-600/20 text-blue-400 py-2 rounded text-[9px] font-black uppercase border border-blue-500/30 hover:bg-blue-600 hover:text-white transition shadow-md">ðŸ“… Day</button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="space-y-4">
            <div class="bg-red-900/10 border border-red-900/30 p-4 rounded-2xl mb-6">
                <p class="text-xs text-red-400 font-black uppercase tracking-widest">Scanning @allSystemContexts.Count unique links. Locations found will appear below.</p>
            </div>

            @if (!brokenLinks.Any())
            {
                <div class="text-center py-20 border-2 border-dashed border-gray-800 rounded-3xl">
                    <p class="text-gray-500 font-black uppercase tracking-widest">No broken links detected</p>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 gap-4 font-black">
                    @foreach (var url in brokenLinks)
                    {
                        var sources = allSystemContexts.Where(x => x.Url == url).ToList();
                        <div class="bg-black/40 border border-red-900/30 p-5 rounded-2xl shadow-xl flex flex-col gap-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] font-mono text-red-400 truncate mb-1">@url</div>
                                    <h4 class="text-xs text-gray-500 uppercase tracking-widest">Found in @sources.Count location(s):</h4>
                                </div>
                                <button @onclick="() => CopyRawPath(url)" class="px-4 py-1.5 bg-gray-800 rounded text-[9px] font-black uppercase hover:bg-blue-600 transition shrink-0 ml-4 shadow-lg">Copy URL</button>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                @foreach (var src in sources)
                                {
                                    <div class="bg-black/60 border border-gray-800 p-3 rounded-xl flex flex-col justify-between hover:border-blue-500 transition-colors cursor-pointer shadow-md" @onclick="() => NavigateToSpecific(src)">
                                        <div>
                                            <div class="text-[8px] text-blue-500 uppercase font-black mb-1">@src.Area</div>
                                            <div class="text-[10px] text-white uppercase truncate">@src.Title</div>
                                        </div>
                                        @if(src.Date.HasValue) {
                                            <div class="text-[8px] text-gray-500 mt-2 uppercase font-bold">ðŸ“… @src.Date.Value.ToString("MMM dd, yyyy")</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="hidden">
                @foreach (var context in allSystemContexts)
                {
                    <img src="@context.Url" @onerror='() => ReportBrokenLink(context.Url)' />
                }
            </div>
        </div>
    }
</div>

@code {
    private string activeTab = "registry";
    private List<Dashboard.StoredImage>? allImages;
    private Dictionary<int, ImageUsage> usageDetails = new(); 
    private List<LinkSource> allSystemContexts = new();
    private HashSet<string> brokenLinks = new();
    private string searchQuery = ""; private int currentPage = 1; private int pageSize = 50; private bool hasMorePages = true;

    public class ImageUsage { 
        public int TotalCount { get; set; } = 0; 
        public bool IsCalendar { get; set; } = false; 
        public bool IsRecipe { get; set; } = false; 
        public DateTime? CalendarDate { get; set; } 
    }
    
    public class LinkSource {
        public string Url { get; set; } = "";
        public string Area { get; set; } = ""; 
        public string Title { get; set; } = ""; 
        public DateTime? Date { get; set; }
    }

    protected override async Task OnInitializedAsync() => await LoadImages();

    private void ReportBrokenLink(string url) { brokenLinks.Add(url); StateHasChanged(); }

    private async Task NextPage() { currentPage++; await LoadImages(); }
    private async Task PrevPage() { currentPage--; await LoadImages(); }

    private async Task LoadImages()
    {
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            var query = db.StoredImages.AsNoTracking().OrderByDescending(i => i.UploadedAt).AsQueryable();
            if (!string.IsNullOrWhiteSpace(searchQuery)) query = query.Where(i => i.OriginalName.Contains(searchQuery));

            allImages = await query.Skip((currentPage - 1) * pageSize).Take(pageSize).ToListAsync();
            hasMorePages = allImages.Count == pageSize;

            allSystemContexts.Clear();
            
            // 1. SCAN CALENDAR & NOTES
            var items = await db.BulletItems.AsNoTracking().Select(x => new { x.ImgUrl, x.Title, x.Date }).ToListAsync();
            foreach(var x in items.Where(i => !string.IsNullOrEmpty(i.ImgUrl))) 
                allSystemContexts.Add(new LinkSource { Url = x.ImgUrl, Area = "Calendar", Title = x.Title, Date = x.Date });
            
            var notes = await db.BulletItemNotes.AsNoTracking().Select(x => new { x.ImgUrl, x.Content }).ToListAsync();
            foreach(var n in notes.Where(i => !string.IsNullOrEmpty(i.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = n.ImgUrl, Area = "Note Log", Title = n.Content.Length > 20 ? n.Content[..20] + "..." : n.Content });

            // 2. SCAN RECIPES
            var recipes = await db.Recipes.AsNoTracking().Select(x => new { x.ImageUrl, x.ImageId, x.Title }).ToListAsync();
            foreach(var r in recipes) {
                if(!string.IsNullOrEmpty(r.ImageUrl)) allSystemContexts.Add(new LinkSource { Url = r.ImageUrl, Area = "Recipe", Title = r.Title });
                if(r.ImageId.HasValue) allSystemContexts.Add(new LinkSource { Url = $"/db-images/{r.ImageId}", Area = "Recipe", Title = r.Title });
            }

            var cats = await db.RecipeCategories.AsNoTracking().Select(x => new { x.ImageUrl, x.ImageId, x.Name }).ToListAsync();
            foreach(var c in cats) {
                if(!string.IsNullOrEmpty(c.ImageUrl)) allSystemContexts.Add(new LinkSource { Url = c.ImageUrl, Area = "Recipe Category", Title = c.Name });
                if(c.ImageId.HasValue) allSystemContexts.Add(new LinkSource { Url = $"/db-images/{c.ImageId}", Area = "Recipe Category", Title = c.Name });
            }

            // 3. SCAN BUDGET (Items & Income Sources)
            var budget = await db.BudgetItems.AsNoTracking().Select(x => new { x.ImgUrl, x.Name }).ToListAsync();
            foreach(var b in budget.Where(i => !string.IsNullOrEmpty(i.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = b.ImgUrl, Area = "Budget Item", Title = b.Name });

            var income = await db.BudgetIncomeSources.AsNoTracking().Select(x => new { x.ImgUrl, x.Name }).ToListAsync();
            foreach(var i in income.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = i.ImgUrl, Area = "Income Source", Title = i.Name });

            // 4. SCAN SPORTS (Leagues & Seasons & Teams)
            var leagues = await db.Leagues.AsNoTracking().Select(x => new { x.ImgUrl, x.Name }).ToListAsync();
            foreach(var l in leagues.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = l.ImgUrl, Area = "Sports League", Title = l.Name });

            var seasons = await db.Seasons.AsNoTracking().Select(x => new { x.ImgUrl, x.Name }).ToListAsync();
            foreach(var s in seasons.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = s.ImgUrl, Area = "Sports Season", Title = s.Name });

            var teams = await db.Teams.AsNoTracking().Select(x => new { x.LogoUrl, x.Name }).ToListAsync();
            foreach(var t in teams.Where(x => !string.IsNullOrEmpty(x.LogoUrl)))
                allSystemContexts.Add(new LinkSource { Url = t.LogoUrl, Area = "Sports Team", Title = t.Name });

            // 5. SCAN DASHBOARD (Links, Countdowns, Stocks)
            var dash = await db.Links.AsNoTracking().Select(x => new { x.Img, x.Name }).ToListAsync();
            foreach(var l in dash.Where(i => !string.IsNullOrEmpty(i.Img)))
                allSystemContexts.Add(new LinkSource { Url = l.Img, Area = "Dashboard Link", Title = l.Name });

            var countdowns = await db.Countdowns.AsNoTracking().Select(x => new { x.Img, x.Name }).ToListAsync();
            foreach(var c in countdowns.Where(x => !string.IsNullOrEmpty(x.Img)))
                allSystemContexts.Add(new LinkSource { Url = c.Img, Area = "Countdown", Title = c.Name });

            var stocks = await db.Stocks.AsNoTracking().Select(x => new { x.ImgUrl, x.Symbol }).ToListAsync();
            foreach(var s in stocks.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                allSystemContexts.Add(new LinkSource { Url = s.ImgUrl, Area = "Stock", Title = s.Symbol });

            // MAP REGISTRY USAGE
            foreach (var img in allImages) {
                var path = $"/db-images/{img.Id}";
                var usage = new ImageUsage();
                var matches = allSystemContexts.Where(x => x.Url == path).ToList();
                
                usage.TotalCount = matches.Count;
                var calMatch = matches.FirstOrDefault(x => x.Area == "Calendar");
                usage.IsCalendar = calMatch != null;
                if(usage.IsCalendar) usage.CalendarDate = calMatch?.Date;
                usage.IsRecipe = matches.Any(x => x.Area.Contains("Recipe"));
                
                usageDetails[img.Id] = usage;
            }
            StateHasChanged();
        } catch (Exception ex) { await JS.InvokeVoidAsync("console.log", ex.Message); }
    }

    private void NavigateToSource(ImageUsage usage) {
        if (usage.IsCalendar && usage.CalendarDate.HasValue) Nav.NavigateTo($"/bullet-calendar?date={usage.CalendarDate.Value:yyyy-MM-dd}", forceLoad: true);
        else if (usage.IsRecipe) Nav.NavigateTo("/recipes");
    }

    private void NavigateToSpecific(LinkSource src) {
        if (src.Area == "Calendar" && src.Date.HasValue) Nav.NavigateTo($"/bullet-calendar?date={src.Date.Value:yyyy-MM-dd}", forceLoad: true);
        else if (src.Area.Contains("Recipe")) Nav.NavigateTo("/recipes");
        else if (src.Area.Contains("Budget") || src.Area == "Income Source") Nav.NavigateTo("/budget-tracker");
        else Nav.NavigateTo("/");
    }

    private async Task CopyRawPath(string path) => await JS.InvokeVoidAsync("navigator.clipboard.writeText", path);

    private async Task DeleteOne(int id) {
        if (!await JS.InvokeAsync<bool>("confirm", $"Permanently delete image #{id}?")) return;
        using var scope = ScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var img = await db.StoredImages.FindAsync(id);
        if (img != null) { db.StoredImages.Remove(img); await db.SaveChangesAsync(); await LoadImages(); }
    }
}