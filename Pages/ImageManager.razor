@page "/image-manager"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Dashboard // This ensures we use your global StoredImage model
@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Image Registry | Stephens' Dashboard</PageTitle>

<BulletHeader 
    ShowControls="false"
    CustomDateText="Image Registry">
    
    <div class="flex items-center gap-2 ml-4">
        @* Search Bar *@
        <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            
            <input @bind="searchQuery" 
                   @bind:event="oninput" 
                   placeholder="Search filenames..." 
                   class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
            
            @if(!string.IsNullOrWhiteSpace(searchQuery))
            {
                <button @onclick="ClearSearch" class="text-gray-500 hover:text-red-400 p-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            }
        </div>

        <div class="h-6 w-px bg-gray-800 mx-2"></div>

        <button @onclick="PurgeDatabase" 
                class="px-3 py-1.5 bg-red-950/30 border border-red-900/50 hover:bg-red-600 hover:border-red-400 text-red-500 hover:text-white text-[10px] font-black uppercase tracking-widest rounded-lg transition-all shadow-lg active:scale-95">
            Purge All Images
        </button>
    </div>
</BulletHeader>

<div class="p-6">
    @if (allImages == null)
    {
        <div class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
    }
    else if (!filteredImages.Any())
    {
        <div class="text-center py-20 border-2 border-dashed border-gray-800 rounded-3xl">
            <p class="text-gray-500 font-black uppercase tracking-widest">No images found in registry</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
            @foreach (var img in filteredImages)
            {
                <div class="group bg-[#0f0f0f] border border-gray-800 rounded-2xl overflow-hidden shadow-2xl hover:border-blue-500/50 transition-all">
                    <div class="aspect-square bg-black overflow-hidden cursor-pointer" @onclick="() => NavigateToDay(img.UploadedAt)">
                        <img src="/db-images/@img.Id" 
                             alt="@img.OriginalName" 
                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                    </div>

                    <div class="p-3">
                        <div class="text-[10px] font-black text-gray-500 truncate mb-1 uppercase tracking-tighter">
                            @img.OriginalName
                        </div>
                        <div class="text-[9px] text-gray-600 mb-3 font-bold">
                            Uploaded: @img.UploadedAt.ToString("MMM dd, yyyy")
                        </div>

                        <div class="flex gap-2">
                            <button @onclick="() => CopyUrl(img.Id)" 
                                    class="flex-1 bg-gray-900 hover:bg-blue-600 text-white text-[9px] font-black py-1.5 rounded transition uppercase tracking-widest border border-gray-700">
                                üîó URL
                            </button>
                            <button @onclick="() => NavigateToDay(img.UploadedAt)" 
                                    class="flex-1 bg-gray-900 hover:bg-gray-700 text-white text-[9px] font-black py-1.5 rounded transition uppercase tracking-widest border border-gray-700">
                                üìÖ Day
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    // We use Dashboard.StoredImage to be explicit and avoid local class conflicts
    private List<Dashboard.StoredImage>? allImages;
    private string searchQuery = "";

    private IEnumerable<Dashboard.StoredImage> filteredImages => 
        string.IsNullOrWhiteSpace(searchQuery) 
        ? (allImages ?? new List<Dashboard.StoredImage>()) 
        : (allImages?.Where(i => (i.OriginalName ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) ?? new List<Dashboard.StoredImage>());

    protected override async Task OnInitializedAsync()
    {
        await LoadImages();
    }

    private void ClearSearch() => searchQuery = "";

    private async Task LoadImages()
    {
        try 
        {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            allImages = await db.StoredImages
                .OrderByDescending(i => i.UploadedAt)
                .ToListAsync();
                
            Console.WriteLine($"Registry loaded: {allImages?.Count ?? 0} images found.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error Loading Images: {ex.Message}");
        }
    }

    private void NavigateToDay(DateTime date)
    {
        var targetUrl = $"/bullet-calendar?date={date:yyyy-MM-dd}";
        Console.WriteLine($"Navigating to calendar: {targetUrl}");
        Nav.NavigateTo(targetUrl);
    }

    private async Task CopyUrl(int id)
    {
        var url = $"{Nav.BaseUri}db-images/{id}";
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
        Console.WriteLine($"Copied Image Link: {url}");
    }

    private async Task PurgeDatabase()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "‚ö†Ô∏è DANGER: This will permanently delete all images. Proceed?");
        
        if (!confirmed) return;

        try 
        {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            var imagesToDelete = await db.StoredImages.ToListAsync();
            db.StoredImages.RemoveRange(imagesToDelete);
            await db.SaveChangesAsync();

            Console.WriteLine("Purge Successful.");
            await LoadImages();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Purge Failed: {ex.Message}");
        }
    }
}