@page "/image-manager"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Dashboard
@namespace Dashboard.Components.Bullet
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Image Registry | Stephens' Dashboard</PageTitle>

<BulletHeader ShowControls="false" CustomDateText="Image Registry">
    <div class="flex items-center gap-2 ml-4">
        <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
            <input @bind="searchQuery" @bind:event="oninput" placeholder="Search filenames..." 
                   class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
        </div>

        @* Pagination Controls *@
        <div class="flex items-center gap-2 ml-4">
            <button @onclick="PrevPage" disabled="@(currentPage == 1)" class="px-2 py-1 bg-gray-800 rounded disabled:opacity-30 text-[10px] font-black">PREV</button>
            <span class="text-[10px] font-mono text-blue-400">Page @currentPage</span>
            <button @onclick="NextPage" disabled="@(!hasMorePages)" class="px-2 py-1 bg-gray-800 rounded disabled:opacity-30 text-[10px] font-black">NEXT</button>
        </div>

        <button @onclick="LoadImages" class="text-[10px] text-blue-400 hover:text-white font-black uppercase ml-4">üîÑ Refresh</button>
    </div>
</BulletHeader>

<div class="p-6">
    @if (allImages == null)
    {
        <div class="flex justify-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            @foreach (var img in allImages)
            {
                int count = usageCounts.ContainsKey(img.Id) ? usageCounts[img.Id] : 0;
                var displayPath = $"/db-images/{img.Id}";

                <div class="group relative bg-[#0f0f0f] border border-gray-800 rounded-2xl overflow-hidden shadow-2xl hover:border-blue-500/50 transition-all">
                    
                    @* Usage Badge *@
                    <div class="absolute top-2 right-2 z-10 px-2 py-1 rounded-md text-[9px] font-black uppercase 
                                @(count > 0 ? "bg-green-500/20 text-green-400 border border-green-500/30" : "bg-red-500/20 text-red-400 border border-red-500/30")">
                        @(count == 0 ? "Orphaned" : $"{count} Links")
                    </div>

                    <button @onclick="() => DeleteOne(img.Id)" class="absolute top-2 left-2 z-10 p-2 bg-black/60 hover:bg-red-600 text-white rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                        üóëÔ∏è
                    </button>

                    <div class="aspect-video bg-black cursor-pointer" @onclick="() => NavigateToDay(img.UploadedAt)">
                        <img src="@displayPath" class="w-full h-full object-cover group-hover:scale-105 transition-all" />
                    </div>
                    
                    <div class="p-3">
                        <div class="text-[10px] font-black text-gray-500 truncate uppercase mb-1">@img.OriginalName</div>
                        @* Date Added Back *@
                        <div class="text-[9px] text-gray-600 mb-2 font-bold italic">Uploaded: @img.UploadedAt.ToString("MMM dd, yyyy")</div>
                        
                        <div class="bg-black border border-gray-800 p-2 rounded text-[10px] font-mono text-blue-400 mb-3 select-all truncate">
                            @displayPath
                        </div>

                        <div class="flex gap-2">
                            <button @onclick="() => CopyUrl(img.Id)" class="flex-1 bg-gray-900 py-2 rounded text-[9px] font-black uppercase border border-gray-700 hover:bg-blue-600">URL</button>
                            <button @onclick="() => NavigateToDay(img.UploadedAt)" class="flex-1 bg-gray-900 py-2 rounded text-[9px] font-black uppercase border border-gray-700 hover:bg-gray-700">Day</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Dashboard.StoredImage>? allImages;
    private Dictionary<int, int> usageCounts = new();
    private string searchQuery = "";
    private int currentPage = 1;
    private int pageSize = 50;
    private bool hasMorePages = true;

    protected override async Task OnInitializedAsync() => await LoadImages();

    private async Task NextPage() { currentPage++; await LoadImages(); }
    private async Task PrevPage() { currentPage--; await LoadImages(); }

    private async Task LoadImages()
    {
        Console.WriteLine($"[LOG] Image Manager: Fetching page {currentPage} (Size: {pageSize})...");
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            
            // Paginated query to reduce memory load
            var query = db.StoredImages.AsNoTracking().OrderByDescending(i => i.UploadedAt).AsQueryable();
            
            if (!string.IsNullOrWhiteSpace(searchQuery))
                query = query.Where(i => i.OriginalName.Contains(searchQuery));

            allImages = await query.Skip((currentPage - 1) * pageSize).Take(pageSize).ToListAsync();
            hasMorePages = allImages.Count == pageSize;

            Console.WriteLine($"[LOG] Page {currentPage} loaded. Running lightweight usage scan...");

            // --- LIGHTWEIGHT SCAN ---
            // Instead of scanning every row in the DB, we only check the 50 images currently on screen.
            var currentIds = allImages.Select(i => i.Id).ToList();
            var currentPaths = currentIds.Select(id => $"/db-images/{id}").ToList();

            var bulletMatches = await db.BulletItems.AsNoTracking()
                .Where(x => currentPaths.Contains(x.ImgUrl))
                .GroupBy(x => x.ImgUrl)
                .Select(g => new { Path = g.Key, Count = g.Count() })
                .ToListAsync();

            // Convert paths back to IDs for the badge
            usageCounts = new Dictionary<int, int>();
            foreach(var match in bulletMatches) {
                if (int.TryParse(match.Path.Split('/').Last(), out int id)) usageCounts[id] = match.Count;
            }

            Console.WriteLine($"[LOG] Usage scan complete. {usageCounts.Count} active links found in this batch.");
            StateHasChanged();
        } catch (Exception ex) { Console.WriteLine($"[ERROR] Load Fail: {ex.Message}"); }
    }

    private void NavigateToDay(DateTime date) 
    {
        // Fix: Query string parameters need exact format
        var targetDate = date.ToString("yyyy-MM-dd");
        Console.WriteLine($"[LOG] Navigating to Calendar Day: {targetDate}");
        Nav.NavigateTo($"/bullet-calendar?date={targetDate}", forceLoad: true);
    }

    private async Task CopyUrl(int id) 
    {
        var url = $"{Nav.BaseUri}db-images/{id}";
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
        Console.WriteLine($"[LOG] URL Copied: {url}");
    }

    private async Task DeleteOne(int id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"Delete image #{id}?")) return;
        try {
            using var scope = ScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            var img = await db.StoredImages.FindAsync(id);
            if (img != null) { db.StoredImages.Remove(img); await db.SaveChangesAsync(); await LoadImages(); }
        } catch (Exception ex) { Console.WriteLine($"[ERROR] Delete Fail: {ex.Message}"); }
    }
}