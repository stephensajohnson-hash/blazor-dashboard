@page "/recipes"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.Text
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Error</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">Attempt Fix</button>
        </div>
    }
    else
    {
        <main class="w-full p-8 relative scroll-smooth">
            
            <div class="mb-10 border-b border-gray-800 pb-4 flex justify-between items-end">
                <div>
                    <div class="flex items-baseline gap-4">
                        <h2 class="text-3xl font-bold text-white tracking-tight">@CurrentDate</h2>
                        <span class="text-xl font-medium text-gray-400">@CurrentTime</span>
                    </div>
                    <div class="text-[10px] text-gray-600 font-mono mt-1">v2.5.0 (Deep Data)</div>
                </div>

                <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <a href="/" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Home">üè†</a>
                    <span class="text-2xl transition grayscale-0 drop-shadow-[0_0_10px_rgba(255,165,0,0.5)] cursor-default">üç≥</span>
                    <span class="text-2xl opacity-20 cursor-not-allowed">üöß</span>
                </div>

                <div class="flex items-center gap-8 text-right">
                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu">
                            <div class="text-right hidden md:block">
                                <div class="text-sm font-bold text-white">@(currentUser?.Username ?? "Loading...")</div>
                                <div class="text-[10px] text-gray-500 font-mono text-yellow-400">ID: @(currentUser?.Id)</div>
                            </div>
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                                 class="w-10 h-10 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu)
                        {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <button type="button" @onclick="CheckDbStatus" class="w-full text-left text-xs text-blue-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üîç</span> Check Status</button>
                                <button type="button" @onclick="InspectFirstRecipe" class="w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üî¨</span> Inspect Data</button>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="NukeRecipes" class="w-full text-left text-xs text-red-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üóëÔ∏è</span> Delete All Data</button>
                                <button type="button" @onclick="ImportRecipes" class="w-full text-left text-xs text-purple-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üç≥</span> Import New</button>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                            <div class="fixed inset-0 z-40" @onclick="ToggleUserMenu"></div>
                        }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(debugOutput))
            {
                <div class="bg-black/90 border border-green-500/50 p-4 rounded-xl mb-8 font-mono text-xs text-green-400 overflow-x-auto">
                    <div class="flex justify-between mb-2 border-b border-green-500/30 pb-2">
                        <strong>SYSTEM OUTPUT</strong>
                        <button @onclick="() => debugOutput = null" class="text-white hover:text-red-400">CLOSE [X]</button>
                    </div>
                    <pre>@debugOutput</pre>
                </div>
            }

            <div class="mb-8 relative max-w-xl mx-auto">
                <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search recipes, ingredients..." class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 pl-11 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition duration-200 shadow-lg" />
                <div class="absolute left-3.5 top-3.5 text-gray-500">üîç</div>
            </div>

            @if (selectedRecipe == null)
            {
                <div id="recipe-groups-container" class="flex flex-col space-y-12">
                    @if (!FilteredRecipes.Any())
                    {
                        <div class="text-center py-12">
                            <div class="text-gray-500 text-lg mb-4">No recipes found.</div>
                            <button @onclick="ImportRecipes" class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition">
                                Import & Claim
                            </button>
                        </div>
                    }
                    
                    @foreach (var category in FilteredRecipes.Select(r => r.Category).Distinct().OrderBy(c => c))
                    {
                        var catRecipes = FilteredRecipes.Where(r => r.Category == category).ToList();
                        if (catRecipes.Any())
                        {
                            <section>
                                <div class="bg-gray-800 border border-gray-700 inline-block px-4 py-1.5 rounded-full mb-4 text-lg font-semibold text-white shadow-md">
                                    @category
                                </div>
                                <div class="flex flex-wrap gap-6 justify-start">
                                    @foreach (var r in catRecipes)
                                    {
                                        <div class="w-full max-w-[300px] min-w-[250px] cursor-pointer bg-gray-800 border border-gray-700 rounded-xl shadow-lg overflow-hidden hover:bg-gray-700 transition duration-200" @onclick="() => SelectRecipe(r)">
                                            <img src="@r.ImageUrl" class="w-full h-32 object-cover" onerror="this.src='https://placehold.co/400?text=No+Image'" />
                                            <div class="p-3">
                                                <h3 class="text-lg font-bold text-white truncate">@r.Title</h3>
                                                <p class="text-xs text-gray-400 mt-1 mb-2">@r.PrepTime | @r.CookTime</p>
                                                <div class="flex flex-wrap gap-1">
                                                    @foreach (var tag in GetTags(r.TagsJson))
                                                    {
                                                        <span class="px-2 py-0.5 text-xs rounded-full bg-blue-900/50 text-blue-300">@tag</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </section>
                        }
                    }
                </div>
            }
            else
            {
                <div class="animate-fade-in">
                    <button @onclick="() => selectedRecipe = null" class="mb-6 flex items-center text-gray-400 hover:text-white transition px-4 py-2 rounded-lg bg-gray-800 border border-gray-700">‚Üê Back to Recipes</button>

                    <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-2xl max-w-5xl mx-auto">
                        <div class="flex flex-col md:flex-row gap-6 mb-8">
                            <img src="@selectedRecipe.ImageUrl" class="w-full md:w-1/2 rounded-xl object-cover h-96 shadow-lg border border-gray-700" />
                            <div class="flex-1 flex flex-col justify-center">
                                <h1 class="text-4xl font-extrabold text-white mb-2">@selectedRecipe.Title</h1>
                                <div class="text-sm text-blue-300 mb-4 font-medium">@selectedRecipe.SourceName</div>
                                <p class="text-gray-400 italic mb-6 text-lg">@selectedRecipe.Description</p>
                                <div class="flex gap-4 mb-6 text-sm">
                                    <span class="bg-gray-700 px-3 py-1 rounded text-white">Prep: <strong>@selectedRecipe.PrepTime</strong></span>
                                    <span class="bg-gray-700 px-3 py-1 rounded text-white">Cook: <strong>@selectedRecipe.CookTime</strong></span>
                                    <span class="bg-gray-700 px-3 py-1 rounded text-white">Serves: <strong>@selectedRecipe.Servings</strong></span>
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h2 class="text-2xl font-bold border-b border-blue-900/50 pb-2 mb-4 text-blue-300">Ingredients</h2>
                                @if (!selectedRecipe.Ingredients.Any())
                                {
                                    <div class="text-red-400 italic">No ingredients found in database.</div>
                                }
                                @foreach (var ingGroup in selectedRecipe.Ingredients.GroupBy(i => i.Section))
                                {
                                    <div class="mb-6">
                                        <h3 class="text-lg font-semibold text-white mb-2 pl-2 border-l-2 border-blue-500">@ingGroup.Key</h3>
                                        <ul class="space-y-2">
                                            @foreach (var ing in ingGroup)
                                            {
                                                <li class="flex justify-between border-b border-gray-700/50 pb-1">
                                                    <span class="text-gray-200"><span class="font-bold text-white">@ing.Quantity</span> <span class="font-bold text-white">@ing.Unit</span> @ing.Name</span>
                                                    <span class="text-xs text-gray-500 italic ml-2">@ing.Notes</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold border-b border-green-900/50 pb-2 mb-4 text-green-300">Instructions</h2>
                                @if (!selectedRecipe.Instructions.Any())
                                {
                                    <div class="text-red-400 italic">No instructions found in database.</div>
                                }
                                @foreach (var instGroup in selectedRecipe.Instructions.GroupBy(i => i.Section))
                                {
                                    <div class="mb-8">
                                        <h3 class="text-lg font-semibold text-white mb-3 pl-2 border-l-2 border-green-500">@instGroup.Key</h3>
                                        <ol class="list-decimal list-outside space-y-4 text-gray-300 pl-5">
                                            @foreach (var step in instGroup.OrderBy(s => s.StepNumber))
                                            {
                                                <li class="pl-2">@step.Text</li>
                                            }
                                        </ol>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </main>
    }
</div>

<script>window.getUserOffset = () => { return new Date().getTimezoneOffset(); }; window.scrollToTop = () => window.scrollTo(0, 0);</script>

@code {
    private List<Recipe> RecipeList = new(); 
    private Recipe? selectedRecipe;
    private string searchTerm = "";
    private User? currentUser;
    private string CurrentDate = "", CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private string? debugOutput = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isDbError) 
        { 
            try 
            { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var session = JsonSerializer.Deserialize<SessionData>(json, options);
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }
                currentUser = await Db.Users.FindAsync(session.UserId);
                if (currentUser == null) { await Logout(); return; }

                await LoadData();
                _ = FetchWeather();
                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); UpdateTime(); } catch {}
                _ = StartClock();
                StateHasChanged();
            } 
            catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }
    
    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }

    private async Task NukeRecipes()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "ARE YOU SURE? This will delete ALL recipe data.")) return;
        var r = await Http.PostAsync("/api/admin/nuke-recipes", null);
        debugOutput = await r.Content.ReadAsStringAsync();
        await LoadData();
    }

    private async Task InspectFirstRecipe()
    {
        var r = await Http.GetAsync("/api/admin/debug-recipe");
        var json = await r.Content.ReadAsStringAsync();
        // Pretty Print
        try { 
            var parsed = JsonSerializer.Deserialize<JsonElement>(json);
            debugOutput = JsonSerializer.Serialize(parsed, new JsonSerializerOptions { WriteIndented = true }); 
        } catch { debugOutput = json; }
    }

    private async Task MigrateDashboardData()
    {
        if (currentUser == null) return;
        await Db.Database.ExecuteSqlRawAsync($"UPDATE \"Recipes\" SET \"UserId\" = {currentUser.Id}; UPDATE \"RecipeCategories\" SET \"UserId\" = {currentUser.Id};");
        await LoadData();
    }

    private async Task CheckDbStatus()
    {
        var total = await Db.Recipes.CountAsync();
        var myCount = await Db.Recipes.CountAsync(r => r.UserId == currentUser!.Id);
        var ingCount = await Db.RecipeIngredients.CountAsync();
        debugOutput = $"Total Recipes: {total}\nMy Recipes: {myCount}\nTotal Ingredients: {ingCount}\nUser ID: {currentUser?.Id}";
    }

    private async Task ImportRecipes()
    {
        try {
            var json = await Http.GetStringAsync("/recipes_data.json");
            using var content = new StringContent(json, Encoding.UTF8, "application/json");
            var response = await Http.PostAsync("/api/admin/seed-recipes", content);
            var result = await response.Content.ReadAsStringAsync();
            
            if (response.IsSuccessStatusCode) {
                // Parse the result to show the detailed log
                try {
                    var resultObj = JsonSerializer.Deserialize<JsonElement>(result);
                    var logs = resultObj.GetProperty("Logs").EnumerateArray().Select(x => x.GetString()).ToList();
                    debugOutput = string.Join("\n", logs);
                } catch { debugOutput = result; }

                await MigrateDashboardData();
                await LoadData();
            } else {
                debugOutput = "IMPORT FAILED:\n" + result;
            }
        } catch (Exception ex) { debugOutput = "ERROR:\n" + ex.Message; }
    }

    private async Task UpgradeDatabase()
    {
        try {
            // Re-run create table scripts to ensure nothing is missing
            await Http.PostAsync("/api/admin/seed-recipes", new StringContent("{}", Encoding.UTF8, "application/json")); // Trigger table creation logic
            Nav.NavigateTo(Nav.Uri, forceLoad: true);
        } catch (Exception ex) { errorMessage = "Fix Failed: " + ex.Message; }
    }

    private async Task LoadData()
    {
         if (currentUser == null) return;
         RecipeList = await Db.Recipes
            .Where(r => r.UserId == currentUser.Id)
            .Include(r => r.Ingredients)
            .Include(r => r.Instructions)
            .OrderBy(r => r.Category).ThenBy(r => r.Title)
            .ToListAsync();
         StateHasChanged();
    }

    // SEARCH LOGIC
    private IEnumerable<Recipe> FilteredRecipes => 
        string.IsNullOrWhiteSpace(searchTerm) 
        ? RecipeList 
        : RecipeList.Where(r => 
            (r.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
            (r.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
            (r.SourceName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || 
            r.Ingredients.Any(i => (i.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || (i.Notes?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) || 
            r.Instructions.Any(i => i.Text?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        );

    private async void SelectRecipe(Recipe r) { selectedRecipe = r; await JS.InvokeVoidAsync("scrollToTop"); StateHasChanged(); }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }
    private List<string> GetTags(string json) { try { return JsonSerializer.Deserialize<List<string>>(json) ?? new(); } catch { return new(); } }
    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); string suffix = (now.Day % 10 == 1 && now.Day != 11) ? "st" : (now.Day % 10 == 2 && now.Day != 12) ? "nd" : (now.Day % 10 == 3 && now.Day != 13) ? "rd" : "th"; CurrentDate = $"{now:dddd, MMMM d}{suffix} {now:yyyy}"; CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"Qw", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}