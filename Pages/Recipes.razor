@page "/recipes"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.WebUtilities
@using System.Net.Http.Headers
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav

<style>
    /* TOAST NOTIFICATION STYLES */
    .toast-notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: #10B981; /* Green-500 */
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 100;
        opacity: 0;
        transform: translateY(1rem);
        transition: all 0.3s ease-in-out;
        pointer-events: none;
    }
    .toast-visible {
        opacity: 1;
        transform: translateY(0);
    }

    @@media print {
        @@page { margin: 0.5cm; size: auto; }
        body, main, .min-h-screen { 
            visibility: hidden; 
            background-color: white !important; 
            color: black !important; 
            overflow: visible !important; 
            height: auto !important;
            margin: 0 !important; 
            padding: 0 !important;
        }
        
        #printable-area { 
            visibility: visible; 
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%; 
            background-color: white !important; 
            color: black !important;
            display: block !important;
        }

        .no-print { display: none !important; }

        /* PRINT LAYOUT ADJUSTMENTS */
        .printable-content {
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }

        /* Enforce side-by-side header for print */
        .print-header { 
            display: flex !important; 
            flex-direction: row !important; 
            align-items: flex-start !important;
            gap: 20px !important; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #000; 
            padding-bottom: 15px; 
        }
        
        .print-image-container { 
            width: 35% !important; 
            flex-shrink: 0;
        }
        
        .print-image { 
            width: 100%; 
            height: auto; 
            border-radius: 8px; 
            max-height: 250px;
            object-fit: cover;
        }
        
        .print-info { 
            width: 65% !important; 
            padding-top: 0;
        }
        
        .print-body { display: flex; gap: 30px; margin-top: 20px; }
        .print-ingredients { width: 35%; border-right: 1px solid #ccc; padding-right: 20px; }
        .print-instructions { width: 65%; }

        h1 { font-size: 20pt !important; margin-bottom: 5px; line-height: 1.1; margin-top: 0; }
        h2 { font-size: 14pt !important; margin-top: 0; border-bottom: 1px solid #000; padding-bottom: 5px; }
        h3 { font-size: 11pt !important; margin-top: 10px; text-transform: uppercase; font-weight: bold; }
        p, li, div { font-size: 10pt !important; line-height: 1.3; }
        a { text-decoration: none; color: black !important; }
        
        .macro-box-print { display: flex; gap: 15px; margin-top: 10px; font-size: 9pt; border: 1px solid #ddd; padding: 8px; border-radius: 5px; background: none !important; }
    }
</style>

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    <div class="toast-notification @(showToast ? "toast-visible" : "")">
        @toastMessage
    </div>

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Update Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">
                Apply Schema Update
            </button>
        </div>
    }
    else
    {
        <main class="w-full p-8 relative scroll-smooth">
            
            <div class="mb-10 border-b border-gray-800 pb-4 flex justify-between items-end no-print">
                <div>
                    <div class="flex items-baseline gap-4">
                        <h2 class="text-3xl font-bold text-white tracking-tight">@CurrentDate</h2>
                        <span class="text-xl font-medium text-gray-400">@CurrentTime</span>
                    </div>
                    <div class="text-[10px] text-gray-600 font-mono mt-1">v4.5.8 (Clickable Card Tags)</div>
                </div>

                <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <a href="/" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Home">üè†</a>
                    <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    <span class="text-2xl opacity-20 cursor-not-allowed">‚úÖ</span>
                    <span class="text-2xl opacity-20 cursor-not-allowed">üíµ</span>
                </div>

                <div class="flex items-center gap-8 text-right">
                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                                 class="w-10 h-10 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu)
                        {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <button @onclick="() => OpenAddRecipe()" class="w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>‚ûï</span> Add Recipe</button>
                                <button @onclick="OpenCategoryManager" class="w-full text-left text-xs text-blue-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üè∑Ô∏è</span> Manage Categories</button>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                            <div class="fixed inset-0 z-40" @onclick="ToggleUserMenu"></div>
                        }
                    </div>
                </div>
            </div>

            @if (selectedRecipe == null)
            {
                <div class="mb-2 relative max-w-xl mx-auto animate-fade-in no-print">
                    <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search title, tags, ingredients..." class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 pl-11 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition duration-200 shadow-lg" />
                    <div class="absolute left-3.5 top-3.5 text-gray-500">üîç</div>
                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <button class="absolute right-3 top-3 text-gray-500 hover:text-white" @onclick="() => searchTerm = string.Empty">‚úï</button>
                    }
                </div>
                
                <div class="text-center mb-6 no-print">
                    <span class="text-xs font-bold text-gray-500 bg-gray-800/50 px-3 py-1 rounded-full border border-gray-700/50">
                        Showing @FilteredRecipes.Count() Recipes
                    </span>
                </div>
            }

            @if (selectedRecipe == null)
            {
                <div id="recipe-groups-container" class="flex flex-col space-y-12 mb-16 no-print">
                    @if (!FilteredRecipes.Any() && RecipeList.Any())
                    {
                        <div class="text-center py-12 text-gray-500">No recipes found matching your search.</div>
                    }
                    else if (!RecipeList.Any())
                    {
                         <div class="text-center py-12">
                            <p class="text-gray-500 mb-4">You have no recipes yet.</p>
                            <button @onclick="() => OpenAddRecipe()" class="text-sm bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-full font-bold shadow transition">
                                Create Your First Recipe
                            </button>
                        </div>
                    }
                    
                    @foreach (var categoryName in FilteredRecipes.Select(r => r.Category).Distinct().OrderBy(c => c))
                    {
                        var catRecipes = FilteredRecipes.Where(r => r.Category == categoryName).ToList();
                        var catObj = CategoryList.FirstOrDefault(c => c.Name == categoryName);
                        
                        <section>
                            <div class="group/cat relative inline-flex items-center gap-3 bg-gray-800 border border-gray-700 px-4 py-1.5 rounded-full mb-4 shadow-md pr-20 hover:border-blue-500 transition-colors">
                                
                                @if (catObj != null && !string.IsNullOrEmpty(catObj.ImageUrl))
                                {
                                    <img src="@catObj.ImageUrl" class="w-8 h-8 rounded-full object-cover -ml-2 border border-gray-600" 
                                         onerror="this.style.display='none'" />
                                }
                                
                                <span class="text-lg font-semibold text-white">@categoryName</span>
                                
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 opacity-0 group-hover/cat:opacity-100 transition-opacity">
                                    <button class="text-gray-400 hover:text-green-400 p-1 hover:bg-gray-700 rounded-full transition" 
                                            @onclick="() => OpenAddRecipe(categoryName)" 
                                            @onclick:stopPropagation="true" 
                                            title="Add Recipe to @categoryName">
                                        ‚ûï
                                    </button>
                                    
                                    @if(catObj != null)
                                    {
                                        <button class="text-gray-400 hover:text-blue-400 p-1 hover:bg-gray-700 rounded-full transition"
                                                @onclick="() => { OpenCategoryManager(); EditCategory(catObj); }" 
                                                @onclick:stopPropagation="true"
                                                title="Edit Category">
                                            ‚úèÔ∏è
                                        </button>
                                    }
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-6 justify-start">
                                @foreach (var r in catRecipes)
                                {
                                    <div class="w-full max-w-[300px] min-w-[250px] cursor-pointer bg-gray-800 border border-gray-700 rounded-xl shadow-lg overflow-hidden hover:bg-gray-700 transition duration-200 group relative" @onclick="() => SelectRecipe(r)">
                                        <img src="@r.ImageUrl" class="w-full h-32 object-cover opacity-80 group-hover:opacity-100 transition" onerror="this.src='https://placehold.co/400?text=No+Image'" />
                                        <div class="p-3">
                                            <h3 class="text-lg font-bold text-white truncate">@r.Title</h3>
                                            <p class="text-xs text-gray-400 mt-1 mb-2">@r.PrepTime | @r.CookTime</p>
                                            
                                            @{ var m = CalculateMacros(r); }
                                            @if (m.Cal > 0) 
                                            {
                                                <div class="flex justify-between text-[10px] uppercase font-bold text-gray-500 mb-2 bg-gray-900/50 p-1.5 rounded border border-gray-700/50">
                                                    <div class="text-center"><div class="text-white">@m.Cal</div><div>Cal</div></div>
                                                    <div class="text-center"><div class="text-blue-400">@m.Pro<span class="text-[8px]">g</span></div><div>Pro</div></div>
                                                    <div class="text-center"><div class="text-yellow-400">@m.Fat<span class="text-[8px]">g</span></div><div>Fat</div></div>
                                                    <div class="text-center"><div class="text-emerald-400">@m.Net<span class="text-[8px]">g</span></div><div>Net</div></div>
                                                </div>
                                            }

                                            <div class="flex flex-wrap gap-1">
                                                @foreach (var tag in GetTags(r.TagsJson))
                                                {
                                                    var colors = GetTagColors(tag);
                                                    <button 
                                                        @onclick="() => searchTerm = tag" 
                                                        @onclick:stopPropagation="true"
                                                        class="px-2 py-0.5 text-xs rounded-full border transition hover:scale-110 hover:brightness-110 cursor-pointer @colors.Bg @colors.Border @colors.Text">
                                                        @tag
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                        <button class="absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-blue-600 rounded text-white opacity-0 group-hover:opacity-100 transition" 
                                                @onclick:stopPropagation="true" @onclick="() => OpenEditRecipe(r)">
                                            ‚úèÔ∏è
                                        </button>
                                    </div>
                                }
                            </div>
                        </section>
                    }
                </div>

                @if (RecipeList.Any())
                {
                    var cloud = GenerateTagCloud();
                    if (cloud.Any())
                    {
                        <div class="mt-20 pt-10 border-t border-gray-800 text-center no-print">
                            <h3 class="text-gray-500 text-sm font-bold uppercase tracking-widest mb-6">Tag Cloud</h3>
                            <div class="flex flex-wrap justify-center gap-x-6 gap-y-3 max-w-5xl mx-auto leading-none items-baseline">
                                @foreach (var tag in cloud)
                                {
                                    var colors = GetTagColors(tag.Name);
                                    <button 
                                        @onclick="() => searchTerm = tag.Name"
                                        class="@colors.Text hover:brightness-125 transition-all duration-200 font-bold opacity-80 hover:opacity-100"
                                        style="font-size: @(tag.Size)px; line-height: 1;">
                                        @tag.Name
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="animate-fade-in" id="printable-area">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 no-print">
                        <button @onclick="ClearSelection" class="flex items-center text-gray-400 hover:text-white transition px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 self-start">‚Üê Back</button>
                        
                        <div class="flex items-center gap-1 bg-gray-800 p-1 rounded-xl border border-gray-700 relative z-10">
                            <button @onclick="PrintRecipe" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition" title="Print">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>
                            </button>
                            <button @onclick="CopyRecipeInfo" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition" title="Copy Info">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                            </button>
                            
                            <div class="w-px h-6 bg-gray-700 mx-1"></div>

                            <div class="relative">
                                <button @onclick="() => showShareMenu = !showShareMenu" class="p-2 text-purple-400 hover:text-white hover:bg-purple-900/50 rounded-lg transition" title="Share">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                                </button>
                                @if(showShareMenu)
                                {
                                    <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-20 flex flex-col gap-1">
                                        <button @onclick="CopyShareLink" class="w-full text-left text-xs text-white hover:bg-gray-700 p-2 rounded transition flex items-center gap-2">üîó Copy Link</button>
                                        <a href="sms:?body=Check out this recipe: @Nav.Uri" class="w-full text-left text-xs text-white hover:bg-gray-700 p-2 rounded transition flex items-center gap-2">üí¨ Share via Text</a>
                                    </div>
                                    <div class="fixed inset-0 z-10" @onclick="() => showShareMenu = false"></div>
                                }
                            </div>

                            <div class="w-px h-6 bg-gray-700 mx-1"></div>

                            <button @onclick="() => OpenEditRecipe(selectedRecipe)" class="p-2 text-blue-400 hover:text-white hover:bg-blue-900/50 rounded-lg transition" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button @onclick="() => DeleteRecipe(selectedRecipe)" class="p-2 text-red-400 hover:text-white hover:bg-red-900/50 rounded-lg transition" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-2xl max-w-5xl mx-auto printable-content">
                        <div class="flex flex-col md:flex-row gap-6 mb-8 print-header">
                            <div class="w-full md:w-1/2 print-image-container">
                                <img id="printable-image" src="@selectedRecipe.ImageUrl" class="w-full rounded-xl object-cover h-96 shadow-lg border border-gray-700 print-image" />
                            </div>
                            <div class="flex-1 flex flex-col justify-center print-info">
                                <h1 class="text-4xl font-extrabold text-white mb-2">@selectedRecipe.Title</h1>
                                @if (!string.IsNullOrEmpty(selectedRecipe.SourceUrl)) { <a href="@selectedRecipe.SourceUrl" target="_blank" class="text-sm text-blue-400 hover:text-blue-300 mb-4 font-medium flex items-center gap-1 transition no-print">üîó @selectedRecipe.SourceName</a> <span class="hidden print:block text-sm mb-4">Source: @selectedRecipe.SourceName</span> }
                                else { <div class="text-sm text-gray-500 mb-4 font-medium">@selectedRecipe.SourceName</div> }
                                <p class="text-gray-400 italic mb-6 text-lg">@selectedRecipe.Description</p>
                                
                                <div class="flex flex-wrap gap-2 mb-6 no-print">
                                    @foreach (var tag in GetTags(selectedRecipe.TagsJson))
                                    {
                                        var colors = GetTagColors(tag);
                                        <button 
                                            @onclick="() => { searchTerm = tag; selectedRecipe = null; UpdateUrl(null); }"
                                            class="px-3 py-1 text-xs rounded-full border transition hover:scale-105 @colors.Bg @colors.Border @colors.Text">
                                            @tag
                                        </button>
                                    }
                                </div>
                                
                                <div class="flex flex-wrap gap-4 mb-6 text-sm items-center">
                                    <span class="bg-gray-700 px-3 py-1 rounded text-white border border-gray-600">Prep: <strong>@selectedRecipe.PrepTime</strong></span>
                                    <span class="bg-gray-700 px-3 py-1 rounded text-white border border-gray-600">Cook: <strong>@selectedRecipe.CookTime</strong></span>
                                    
                                    <div class="flex items-center gap-2 bg-gray-700 px-2 py-1 rounded text-white border border-gray-600 no-print">
                                        <span class="text-gray-400 uppercase text-xs mr-1">Serves</span>
                                        <button class="w-6 h-6 flex items-center justify-center bg-gray-600 hover:bg-gray-500 rounded text-sm font-bold transition" @onclick="() => UpdateServings(-1)">-</button>
                                        <span class="w-6 text-center font-bold">@currentServings</span>
                                        <button class="w-6 h-6 flex items-center justify-center bg-gray-600 hover:bg-gray-500 rounded text-sm font-bold transition" @onclick="() => UpdateServings(1)">+</button>
                                    </div>
                                    <span class="hidden print:inline-block font-bold">Serves: @currentServings</span>

                                    @if (!string.IsNullOrEmpty(selectedRecipe.ServingSize))
                                    {
                                        <span class="text-gray-400 italic text-lg">Serving Size: @ToUnicode(selectedRecipe.ServingSize)</span>
                                    }
                                </div>
                                
                                @{ var m = CalculateMacros(selectedRecipe); }
                                <div class="macro-box bg-gray-900/80 p-4 rounded-xl border border-gray-700 shadow-inner mb-4 macro-box-print">
                                    <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2 text-center tracking-widest no-print">Per Serving</h3>
                                    <div class="grid grid-cols-6 gap-2 text-center" style="display: flex; gap: 15px;">
                                        <div><span class="font-bold">@m.Cal</span> <span class="text-xs">Cal</span></div>
                                        <div><span class="font-bold text-blue-400">@m.Pro</span>g Pro</div>
                                        <div><span class="font-bold text-yellow-400">@m.Fat</span>g Fat</div>
                                        <div><span class="font-bold text-green-400">@m.Carb</span>g Carb</div>
                                        <div><span class="font-bold text-gray-400">@m.Fib</span>g Fib</div>
                                        <div><span class="font-bold text-emerald-400">@m.Net</span>g Net</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-8 border-t border-gray-700 pt-8 print-body">
                            <div class="print-ingredients">
                                <h2 class="text-2xl font-bold mb-6 text-blue-300">Ingredients</h2>
                                @foreach (var ingGroup in selectedRecipe.Ingredients.OrderBy(i => i.SectionOrder).GroupBy(i => i.Section)) {
                                    <div class="mb-6">
                                        @if(ingGroup.Key != "Main") { <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b border-gray-700 pb-1">@ingGroup.Key</h3> }
                                        <ul class="space-y-3">
                                            @foreach (var ing in ingGroup.OrderBy(i => i.Order)) {
                                                var scaled = ScaleIngredient(ing.Quantity, ing.Unit, currentServings, selectedRecipe.Servings);
                                                <li class="flex justify-between items-start pb-2 border-b border-gray-800 last:border-0">
                                                    <span class="text-gray-200">
                                                        <span class="font-bold text-white text-lg">@scaled.Qty</span> <span class="font-bold text-blue-300 text-sm mr-1">@scaled.Unit</span> @ing.Name
                                                    </span>
                                                    @if(!string.IsNullOrEmpty(ing.Notes)) { <span class="text-xs text-gray-500 italic ml-2 text-right">@ing.Notes</span> }
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                            <div class="print-instructions">
                                <h2 class="text-2xl font-bold mb-6 text-green-300">Instructions</h2>
                                @foreach (var instGroup in selectedRecipe.Instructions.OrderBy(i => i.SectionOrder).GroupBy(i => i.Section)) {
                                    <div class="mb-8">
                                        @if(instGroup.Key != "Directions") { <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b border-gray-700 pb-1">@instGroup.Key</h3> }
                                        <ol class="space-y-4">
                                            @foreach (var step in instGroup.OrderBy(s => s.StepNumber)) {
                                                <li class="flex gap-4 group">
                                                    <span class="flex-shrink-0 w-6 h-6 rounded-full bg-gray-800 text-green-500 font-bold text-xs flex items-center justify-center border border-gray-700 no-print">@step.StepNumber</span>
                                                    <span class="hidden print:inline-block font-bold mr-2">@step.StepNumber.</span>
                                                    <span class="text-gray-300 leading-relaxed">@ToUnicode(step.Text)</span>
                                                </li>
                                            }
                                        </ol>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

        </main>
    }
</div>

@if (editingRecipe != null)
{
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-white">@(editingRecipe.Id == 0 ? "Create Recipe" : "Edit Recipe")</h2>
                <button @onclick="() => editingRecipe = null" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="flex border-b border-gray-700">
                <button class="flex-1 py-3 text-sm font-bold transition @(activeTab == "General" ? "text-blue-400 border-b-2 border-blue-500" : "text-gray-400 hover:text-white")" @onclick='() => activeTab = "General"'>General</button>
                <button class="flex-1 py-3 text-sm font-bold transition @(activeTab == "Ingredients" ? "text-blue-400 border-b-2 border-blue-500" : "text-gray-400 hover:text-white")" @onclick='() => activeTab = "Ingredients"'>Ingredients</button>
                <button class="flex-1 py-3 text-sm font-bold transition @(activeTab == "Instructions" ? "text-blue-400 border-b-2 border-blue-500" : "text-gray-400 hover:text-white")" @onclick='() => activeTab = "Instructions"'>Instructions</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                @if (activeTab == "General")
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label><input @bind="editingRecipe.Title" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label><textarea @bind="editingRecipe.Description" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></textarea></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label><select @bind="editingRecipe.Category" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white">@foreach (var cat in CategoryList) { <option value="@cat.Name">@cat.Name</option> }</select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Servings</label><input @bind="editingRecipe.Servings" type="number" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Serving Size</label><input @bind="editingRecipe.ServingSize" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" placeholder="e.g. 1 Bowl, 3 oz" /></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Source Name</label><input @bind="editingRecipe.SourceName" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prep Time</label><input @bind="editingRecipe.PrepTime" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cook Time</label><input @bind="editingRecipe.CookTime" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Source URL</label><input @bind="editingRecipe.SourceUrl" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Recipe Image</label>
                            <div class="flex gap-2 mb-2">
                                <button type="button" class="text-xs px-3 py-1 rounded @(uploadMode ? "bg-gray-700 text-gray-400" : "bg-blue-600 text-white")" @onclick="() => uploadMode = false">üîó Link URL</button>
                                <button type="button" class="text-xs px-3 py-1 rounded @(uploadMode ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-400")" @onclick="() => uploadMode = true">üìÇ Upload File</button>
                            </div>
                            @if (!uploadMode) { <input @bind="editingRecipe.ImageUrl" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" placeholder="https://..." /> }
                            else { <InputFile OnChange="HandleImageUpload" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm" /> @if (isUploading) { <span class="text-xs text-blue-400">Uploading...</span> } }
                            @if (!string.IsNullOrEmpty(editingRecipe.ImageUrl)) { <div class="mt-2 h-32 w-full bg-gray-800 rounded overflow-hidden flex items-center justify-center border border-gray-700"><img src="@editingRecipe.ImageUrl" class="h-full object-contain" /></div> }
                        </div>
                        <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tags (Comma Separated)</label><input value="@editingTags" @onchange="@((ChangeEventArgs e) => editingTags = e.Value?.ToString() ?? "")" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" /></div>
                        
                        <div class="md:col-span-2">
                            <div class="flex flex-wrap gap-2">
                                <span class="text-xs text-gray-500 self-center mr-1">Quick Add:</span>
                                @foreach(var tag in GetPopularTags())
                                {
                                    var isSelected = editingTags.Split(',', StringSplitOptions.RemoveEmptyEntries).Any(t => t.Trim().Equals(tag, StringComparison.OrdinalIgnoreCase));
                                    <button type="button" 
                                            @onclick="() => ToggleTagInEditor(tag)" 
                                            class="px-2 py-1 text-xs rounded border transition @(isSelected ? "bg-blue-900 border-blue-500 text-white" : "bg-gray-800 border-gray-600 text-gray-300 hover:bg-gray-700")">
                                        @tag
                                    </button>
                                }
                            </div>
                        </div>
                        
                    </div>
                }
                else if (activeTab == "Ingredients")
                {
                    <div class="space-y-6">
                        <div class="flex justify-end"><label class="flex items-center text-xs font-bold text-gray-400 cursor-pointer hover:text-white"><input type="checkbox" @bind="showMacros" class="mr-2 rounded border-gray-600 bg-gray-700" /> Show Macro Fields</label></div>
                        @for(int s = 0; s < editorIngSections.Count; s++) { var sec = editorIngSections[s]; var sIdx = s; <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"> <div class="flex justify-between items-center mb-3"> <div class="flex items-center gap-2 w-2/3"> <div class="flex flex-col gap-0.5"> <button type="button" @onclick="() => MoveSection(editorIngSections, sIdx, -1)" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(sIdx==0)">‚ñ≤</button> <button type="button" @onclick="() => MoveSection(editorIngSections, sIdx, 1)" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(sIdx==editorIngSections.Count-1)">‚ñº</button> </div> <input @bind="sec.Name" class="bg-transparent border-b border-gray-600 font-bold text-blue-300 w-full" placeholder="Section Name" /> </div> <button class="text-red-400 text-xs" @onclick="() => editorIngSections.RemoveAt(sIdx)">Remove Section</button> </div> @for(int i = 0; i < sec.Items.Count; i++) { var item = sec.Items[i]; var iIdx = i; <div class="mb-2 pb-2 border-b border-gray-700/50 last:border-0 relative"> <div class="flex gap-2 items-center"> <div class="flex flex-col gap-0.5"> <button type="button" @onclick="() => MoveItem(sec.Items, iIdx, -1)" class="text-[8px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(iIdx==0)">‚ñ≤</button> <button type="button" @onclick="() => MoveItem(sec.Items, iIdx, 1)" class="text-[8px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(iIdx==sec.Items.Count-1)">‚ñº</button> </div> <div class="grid grid-cols-12 gap-2 flex-1 items-center"> <input value="@item.Quantity" @onchange="@(e => { item.Quantity = e.Value?.ToString() ?? ""; TryAutoFillMacros(item); })" class="col-span-2 bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white" placeholder="Qty" /> <input value="@item.Unit" @onchange="@(e => { item.Unit = e.Value?.ToString() ?? ""; TryAutoFillMacros(item); })" class="col-span-2 bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white" placeholder="Unit" /> <div class="col-span-5 relative"> <input value="@item.Name" @oninput="@(e => OnIngredientInput(e, item))" @onfocus="@(() => { activeAutocompleteItem = item; FilterSuggestions(item.Name); })" @onblur="@(async () => { await Task.Delay(200); activeAutocompleteItem = null; })" class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white font-bold" placeholder="Name" /> @if (activeAutocompleteItem == item && filteredSuggestions.Any()) { <ul class="absolute z-50 left-0 right-0 mt-1 bg-gray-900 border border-gray-600 rounded-lg shadow-2xl max-h-48 overflow-y-auto"> @foreach (var suggestion in filteredSuggestions) { <li class="p-2 hover:bg-blue-900/50 cursor-pointer border-b border-gray-800 last:border-0" @onclick="@(() => SelectSuggestion(item, suggestion))"> <div class="flex justify-between items-center"> <span class="font-bold text-xs text-white">@suggestion.Name</span> @if (suggestion.Calories > 0) { <span class="text-[9px] text-green-300 bg-green-900/30 px-1 rounded border border-green-800"> @suggestion.Calories cal / @suggestion.Quantity @suggestion.Unit </span> } </div> @if (suggestion.Calories > 0) { <div class="text-[9px] text-gray-500 mt-0.5"> P:@(suggestion.Protein)g F:@(suggestion.Fat)g C:@(suggestion.Carbs)g </div> } </li> } </ul> } </div> <input @bind="item.Notes" class="col-span-2 bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white" placeholder="Notes" /> <button class="col-span-1 text-red-400 font-bold hover:text-red-300 text-right" @onclick="() => sec.Items.RemoveAt(iIdx)">‚úï</button> </div> </div> @if (showMacros) { <div class="grid grid-cols-5 gap-2 pl-8 pr-4 mt-1"> <div class="relative"><input @bind="item.Calories" type="number" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-white text-center" /><span class="absolute -top-1.5 left-1 text-[7px] text-gray-500 bg-gray-800 px-1">Cal</span></div> <div class="relative"><input @bind="item.Protein" type="number" step="0.1" class="w-full bg-gray-900 border border-blue-900/50 rounded p-1 text-[10px] text-blue-300 text-center" /><span class="absolute -top-1.5 left-1 text-[7px] text-blue-500 bg-gray-800 px-1">Pro</span></div> <div class="relative"><input @bind="item.Fat" type="number" step="0.1" class="w-full bg-gray-900 border border-yellow-900/50 rounded p-1 text-[10px] text-yellow-300 text-center" /><span class="absolute -top-1.5 left-1 text-[7px] text-yellow-500 bg-gray-800 px-1">Fat</span></div> <div class="relative"><input @bind="item.Carbs" type="number" step="0.1" class="w-full bg-gray-900 border border-green-900/50 rounded p-1 text-[10px] text-green-300 text-center" /><span class="absolute -top-1.5 left-1 text-[7px] text-green-500 bg-gray-800 px-1">Carb</span></div> <div class="relative"><input @bind="item.Fiber" type="number" step="0.1" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-gray-300 text-center" /><span class="absolute -top-1.5 left-1 text-[7px] text-gray-500 bg-gray-800 px-1">Fib</span></div> </div> } </div> } <button class="text-xs text-green-400 mt-2 hover:text-green-300" @onclick="() => sec.Items.Add(new RecipeIngredient())">+ Add Ingredient</button> </div> }
                        <button class="w-full py-3 border-2 border-dashed border-gray-700 text-gray-500 hover:border-gray-500 hover:text-white rounded-xl transition" @onclick='() => editorIngSections.Add(new SectionContainer<RecipeIngredient> { Name = "New Section", Items = new() })'>+ Add Section</button>
                    </div>
                }
                else if (activeTab == "Instructions")
                {
                      <div class="space-y-6">
                        @for(int s = 0; s < editorInstSections.Count; s++) { var sec = editorInstSections[s]; var sIdx = s; <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"> <div class="flex justify-between items-center mb-3"> <div class="flex items-center gap-2 w-2/3"> <div class="flex flex-col gap-0.5"> <button type="button" @onclick="() => MoveSection(editorInstSections, sIdx, -1)" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(sIdx==0)">‚ñ≤</button> <button type="button" @onclick="() => MoveSection(editorInstSections, sIdx, 1)" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(sIdx==editorInstSections.Count-1)">‚ñº</button> </div> <input @bind="sec.Name" class="bg-transparent border-b border-gray-600 font-bold text-green-300 w-full" placeholder="Section Name" /> </div> <button class="text-red-400 text-xs" @onclick="() => editorInstSections.RemoveAt(sIdx)">Remove Section</button> </div> @for(int i = 0; i < sec.Items.Count; i++) { var item = sec.Items[i]; var iIdx = i; <div class="flex gap-2 mb-2 items-start"> <div class="flex flex-col gap-0.5 mt-1"> <button type="button" @onclick="() => MoveItem(sec.Items, iIdx, -1)" class="text-[8px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(iIdx==0)">‚ñ≤</button> <button type="button" @onclick="() => MoveItem(sec.Items, iIdx, 1)" class="text-[8px] bg-gray-700 hover:bg-gray-600 px-1 rounded text-white disabled:opacity-30" disabled="@(iIdx==sec.Items.Count-1)">‚ñº</button> </div> <textarea @bind="item.Text" class="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-sm text-white" rows="2"></textarea> <button class="text-red-400 self-center hover:text-red-300" @onclick="() => sec.Items.RemoveAt(iIdx)">‚úï</button> </div> } <button class="text-xs text-green-400 mt-2 hover:text-green-300" @onclick="() => sec.Items.Add(new RecipeInstruction())">+ Add Step</button> </div> }
                        <button class="w-full py-3 border-2 border-dashed border-gray-700 text-gray-500 hover:border-gray-500 hover:text-white rounded-xl transition" @onclick='() => editorInstSections.Add(new SectionContainer<RecipeInstruction> { Name = "New Section", Items = new() })'>+ Add Section</button>
                    </div>
                }
            </div>

            <div class="p-4 border-t border-gray-700 bg-gray-800/50 rounded-b-2xl flex justify-end gap-3">
                <button @onclick="() => editingRecipe = null" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button @onclick="SaveRecipe" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>
}

@if (showCatModal)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-white mb-4">Manage Categories</h3>
            <div class="space-y-2 mb-4 max-h-[60vh] overflow-y-auto">
                @foreach (var cat in CategoryList)
                {
                    <div class="flex justify-between items-center bg-gray-900 p-2 rounded border border-gray-700">
                        <span>@cat.Name</span>
                        <div class="flex gap-2">
                             @if (editingCategory != null && editingCategory.Id == cat.Id)
                             {
                                 <button class="text-green-400 hover:text-green-300" @onclick="SaveCategory">üíæ</button>
                                 <button class="text-gray-400 hover:text-gray-300" @onclick="() => editingCategory = null">‚úï</button>
                             }
                             else
                             {
                                 <button class="text-blue-400 hover:text-blue-300" @onclick="() => EditCategory(cat)">‚úèÔ∏è</button>
                                 <button class="text-red-400 hover:text-red-300" @onclick="() => DeleteCategory(cat)">üóëÔ∏è</button>
                             }
                        </div>
                    </div>
                    @if (editingCategory != null && editingCategory.Id == cat.Id)
                    {
                        <div class="p-3 bg-gray-750 border border-gray-600 rounded mt-1 mb-2 space-y-2">
                            <input @bind="editingCategory.Name" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white" placeholder="Name" />
                            <div class="flex gap-2 items-center">
                                <input @bind="editingCategory.ImageUrl" class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white" placeholder="Image URL" />
                                <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs flex items-center shrink-0">
                                    üìÇ
                                    <InputFile OnChange="@(e => HandleCategoryImageUpload(e, editingCategory))" class="hidden" />
                                </label>
                            </div>
                            @if(!string.IsNullOrEmpty(editingCategory.ImageUrl))
                            {
                                <div class="w-full h-20 bg-black/50 rounded flex items-center justify-center overflow-hidden border border-gray-600">
                                    <img src="@editingCategory.ImageUrl" class="h-full object-contain" />
                                </div>
                            }
                            else
                            {
                                <div class="text-[10px] text-gray-500 text-center">No image selected</div>
                            }
                        </div>
                    }
                }
            </div>
            <div class="flex gap-2 pt-4 border-t border-gray-700">
                <input @bind="newCategoryName" class="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-white text-sm" placeholder="New Category..." />
                <button @onclick="AddCategory" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded font-bold">+</button>
            </div>
            <button @onclick="() => showCatModal = false" class="w-full mt-4 text-gray-400 text-sm hover:text-white">Close</button>
        </div>
    </div>
}

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); }; 
    window.scrollToTop = () => window.scrollTo(0, 0);
    window.printPage = () => { window.print(); };
    window.copyToClipboard = (text) => {
        // Just copy, no alert. C# handles the toast notification
        navigator.clipboard.writeText(text);
    };
</script>

@code {
    private List<Recipe> RecipeList = new(); 
    private List<RecipeCategory> CategoryList = new();
    private Dictionary<string, RecipeIngredient> IngredientDatabase = new();
    private List<RecipeIngredient> filteredSuggestions = new();
    private RecipeIngredient? activeAutocompleteItem;
    private Recipe? selectedRecipe;
    private string searchTerm = "";
    private User? currentUser;
    private Recipe? editingRecipe;
    private string activeTab = "General";
    private string editingTags = "";
    private bool showMacros = true;
    private bool uploadMode = false;
    private bool isUploading = false;
    private int currentServings = 1;
    private class SectionContainer<T> { public string Name { get; set; } = ""; public List<T> Items { get; set; } = new(); }
    private List<SectionContainer<RecipeIngredient>> editorIngSections = new();
    private List<SectionContainer<RecipeInstruction>> editorInstSections = new();
    private bool showCatModal = false;
    private string newCategoryName = "";
    private RecipeCategory? editingCategory;
    private string CurrentDate = "", CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private bool showShareMenu = false;

    // Toast Logic
    private bool showToast = false;
    private string toastMessage = "";
    private async Task ShowToast(string message)
    {
        toastMessage = message;
        showToast = true;
        StateHasChanged();
        await Task.Delay(3000); // Wait 3 seconds
        showToast = false;
        StateHasChanged();
    }

    // TAG CLOUD GENERATION & COLORS
    private class TagItem { public string Name { get; set; } = ""; public int Size { get; set; } }
    private readonly (string Text, string Bg, string Border)[] TagColorPalette = new[] { ("text-red-400", "bg-red-900/30", "border-red-800"), ("text-orange-400", "bg-orange-900/30", "border-orange-800"), ("text-amber-400", "bg-amber-900/30", "border-amber-800"), ("text-yellow-300", "bg-yellow-900/30", "border-yellow-800"), ("text-lime-400", "bg-lime-900/30", "border-lime-800"), ("text-green-400", "bg-green-900/30", "border-green-800"), ("text-emerald-400", "bg-emerald-900/30", "border-emerald-800"), ("text-teal-400", "bg-teal-900/30", "border-teal-800"), ("text-cyan-400", "bg-cyan-900/30", "border-cyan-800"), ("text-sky-400", "bg-sky-900/30", "border-sky-800"), ("text-blue-400", "bg-blue-900/30", "border-blue-800"), ("text-indigo-400", "bg-indigo-900/30", "border-indigo-800"), ("text-violet-400", "bg-violet-900/30", "border-violet-800"), ("text-purple-400", "bg-purple-900/30", "border-purple-800"), ("text-fuchsia-400", "bg-fuchsia-900/30", "border-fuchsia-800"), ("text-pink-400", "bg-pink-900/30", "border-pink-800"), ("text-rose-400", "bg-rose-900/30", "border-rose-800") };
    private (string Text, string Bg, string Border) GetTagColors(string tag) { if (string.IsNullOrEmpty(tag)) return TagColorPalette[0]; int hash = Math.Abs(tag.GetHashCode()); return TagColorPalette[hash % TagColorPalette.Length]; }
    private List<TagItem> GenerateTagCloud() { var allTags = RecipeList.SelectMany(r => GetTags(r.TagsJson)).GroupBy(t => t, StringComparer.OrdinalIgnoreCase).Select(g => new { Name = g.Key, Count = g.Count() }).ToList(); if (!allTags.Any()) return new List<TagItem>(); return allTags.OrderBy(t => t.Name).Select(t => new TagItem { Name = t.Name, Size = 7 + (t.Count * 3) }).ToList(); }

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender && !isDbError) { try { var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session"); if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; } var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true }; var session = JsonSerializer.Deserialize<SessionData>(json, options); if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; } currentUser = await Db.Users.FindAsync(session.UserId); if (currentUser == null) { await Logout(); return; } await LoadData(); _ = FetchWeather(); try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); UpdateTime(); } catch {} _ = StartClock(); StateHasChanged(); 
    // DEEP LINKING CHECK
    var uri = Nav.ToAbsoluteUri(Nav.Uri); if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("id", out var idVal) && int.TryParse(idVal, out int rid)) { var target = RecipeList.FirstOrDefault(r => r.Id == rid); if (target != null) SelectRecipe(target); } } catch { Nav.NavigateTo("/login", forceLoad: true); } } }
    private async Task LoadData() { if (currentUser == null) return; try { RecipeList = await Db.Recipes.Where(r => r.UserId == currentUser.Id).Include(r => r.Ingredients).Include(r => r.Instructions).OrderBy(r => r.Category).ThenBy(r => r.Title).ToListAsync(); CategoryList = await Db.RecipeCategories.Where(c => c.UserId == currentUser.Id).OrderBy(c => c.Name).ToListAsync(); var allIngs = await Db.RecipeIngredients.Where(i => Db.Recipes.Any(r => r.Id == i.RecipeId && r.UserId == currentUser.Id)).ToListAsync(); IngredientDatabase = allIngs.Where(i => i.Calories > 0 || i.Protein > 0 || i.Fat > 0 || i.Carbs > 0).GroupBy(i => i.Name.ToLower().Trim()).ToDictionary(g => g.Key, g => g.OrderByDescending(i => (i.Calories>0?1:0) + (i.Protein>0?1:0)).First()); } catch (Exception ex) { if (ex.Message.Contains("42P01") || ex.Message.Contains("42703")) { isDbError = true; errorMessage = ex.Message; } } StateHasChanged(); }

    // --- ACTIONS (Print, Copy, Share) ---
    private void PrintRecipe() { _ = JS.InvokeVoidAsync("printPage"); }
    private async Task CopyRecipeInfo()
    {
        if (selectedRecipe == null) return;
        var m = CalculateMacros(selectedRecipe);
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"{selectedRecipe.Title} - {currentServings} servings");
        if (m.Cal > 0) sb.AppendLine($"Macros per serving: {m.Cal}cal, {m.Pro}g Protein, {m.Fat}g Fat, {m.Carb}g Carbs, {m.Fib}g Fiber, {m.Net}g Net Carb");
        sb.AppendLine("Ingredients:");
        foreach (var ingGroup in selectedRecipe.Ingredients.OrderBy(i => i.SectionOrder).GroupBy(i => i.Section))
        {
             foreach (var ing in ingGroup.OrderBy(i => i.Order)) {
                  var scaled = ScaleIngredient(ing.Quantity, ing.Unit, currentServings, selectedRecipe.Servings);
                  sb.AppendLine($"- {scaled.Qty} {scaled.Unit} {ing.Name}");
             }
        }
        await JS.InvokeVoidAsync("copyToClipboard", sb.ToString());
        await ShowToast("Recipe info copied!");
    }
    private async Task CopyShareLink() 
    { 
        await JS.InvokeVoidAsync("copyToClipboard", Nav.Uri); 
        showShareMenu = false; 
        await ShowToast("Link copied!");
    }


    // --- IMAGE UPLOAD LOGIC ---
    private async Task HandleImageUpload(InputFileChangeEventArgs e) { if (editingRecipe == null) return; isUploading = true; try { var file = e.File; using var content = new MultipartFormDataContent(); using var stream = file.OpenReadStream(5 * 1024 * 1024); var fileContent = new StreamContent(stream); fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType); content.Add(fileContent, "file", file.Name); var response = await Http.PostAsync("/api/images/upload", content); if (response.IsSuccessStatusCode) { var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true }; var result = await response.Content.ReadFromJsonAsync<UploadResult>(options); if (result != null) { editingRecipe.ImageUrl = result.Url; editingRecipe.ImageId = result.Id; StateHasChanged(); } } else { await JS.InvokeVoidAsync("alert", "Upload failed."); } } catch (Exception ex) { await JS.InvokeVoidAsync("alert", "Error: " + ex.Message); } isUploading = false; StateHasChanged(); }
    private async Task HandleCategoryImageUpload(InputFileChangeEventArgs e, RecipeCategory? cat) { if (cat == null) return; try { var file = e.File; using var content = new MultipartFormDataContent(); using var stream = file.OpenReadStream(5 * 1024 * 1024); var fileContent = new StreamContent(stream); fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType); content.Add(fileContent, "file", file.Name); var response = await Http.PostAsync("/api/images/upload", content); if (response.IsSuccessStatusCode) { var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true }; var result = await response.Content.ReadFromJsonAsync<UploadResult>(options); if (result != null) { cat.ImageUrl = result.Url; cat.ImageId = result.Id; StateHasChanged(); } } } catch { await JS.InvokeVoidAsync("alert", "Category upload failed."); } }
    private class UploadResult { public int Id { get; set; } public string Url { get; set; } = ""; }
    // --- CUSTOM AUTOCOMPLETE ---
    private void OnIngredientInput(ChangeEventArgs e, RecipeIngredient item) { item.Name = e.Value?.ToString() ?? ""; activeAutocompleteItem = item; FilterSuggestions(item.Name); TryAutoFillMacros(item); }
    private void FilterSuggestions(string input) { if (string.IsNullOrWhiteSpace(input)) { filteredSuggestions.Clear(); return; } filteredSuggestions = IngredientDatabase.Values.Where(i => i.Name.Contains(input, StringComparison.OrdinalIgnoreCase)).OrderBy(i => i.Name.Length).Take(5).ToList(); }
    private void SelectSuggestion(RecipeIngredient target, RecipeIngredient source) { target.Name = source.Name; activeAutocompleteItem = null; filteredSuggestions.Clear(); TryAutoFillMacros(target); }
    // --- SMART MACRO AUTO-FILL ---
    private void TryAutoFillMacros(RecipeIngredient item) { if (string.IsNullOrWhiteSpace(item.Name)) return; var key = item.Name.ToLower().Trim(); if (!IngredientDatabase.ContainsKey(key)) return; bool isEmpty = item.Calories == 0 && item.Protein == 0 && item.Fat == 0 && item.Carbs == 0; if (!isEmpty) return; var source = IngredientDatabase[key]; double ratio = CalculateRatio(source.Quantity, source.Unit, item.Quantity, item.Unit); if (ratio > 0) { item.Calories = Math.Round(source.Calories * ratio, 1); item.Protein = Math.Round(source.Protein * ratio, 1); item.Fat = Math.Round(source.Fat * ratio, 1); item.Carbs = Math.Round(source.Carbs * ratio, 1); item.Fiber = Math.Round(source.Fiber * ratio, 1); } }
    private double CalculateRatio(string sQty, string sUnit, string tQty, string tUnit) { double sVal = ParseQty(sQty); double tVal = ParseQty(tQty); if (sVal <= 0 || tVal <= 0) return 0; double sNorm = Normalize(sVal, sUnit); double tNorm = Normalize(tVal, tUnit); if (sNorm > 0 && tNorm > 0) return tNorm / sNorm; if (sUnit.Trim().Equals(tUnit.Trim(), StringComparison.OrdinalIgnoreCase)) return tVal / sVal; return 0; }
    
    // Fixed Normalize Method (Returns double for calculations)
    private double Normalize(double val, string unit) 
    { 
        string u = unit.ToLower().Trim(); 
        if (u.StartsWith("cup")) return val * 48; 
        if (u.StartsWith("tbsp") || u.StartsWith("tablespoon")) return val * 3; 
        if (u.StartsWith("tsp") || u.StartsWith("teaspoon")) return val; 
        if (u.StartsWith("lb") || u.StartsWith("pound")) return val * 16; 
        if (u.StartsWith("oz") || u.StartsWith("ounce")) return val; 
        return val; 
    }
    
    private double ParseQty(string qty) { if (string.IsNullOrWhiteSpace(qty)) return 0; var mixedMatch = Regex.Match(qty.Trim(), @"^(\d+)\s+(\d+)/(\d+)$"); if (mixedMatch.Success) return double.Parse(mixedMatch.Groups[1].Value) + (double.Parse(mixedMatch.Groups[2].Value) / double.Parse(mixedMatch.Groups[3].Value)); var fracMatch = Regex.Match(qty.Trim(), @"^(\d+)/(\d+)$"); if (fracMatch.Success) return double.Parse(fracMatch.Groups[1].Value) / double.Parse(fracMatch.Groups[2].Value); if (double.TryParse(qty, out double d)) return d; return 0; }
    // --- RECIPE EDITOR ---
    private void OpenAddRecipe(string? categoryName = null) { editingRecipe = new Recipe { UserId = currentUser.Id, Category = categoryName ?? "Uncategorized" }; editorIngSections = new() { new SectionContainer<RecipeIngredient> { Name = "Main", Items = new() } }; editorInstSections = new() { new SectionContainer<RecipeInstruction> { Name = "Directions", Items = new() } }; editingTags = ""; activeTab = "General"; }
    private void OpenEditRecipe(Recipe r) { editingRecipe = new Recipe { Id = r.Id, UserId = r.UserId, Title = r.Title, Description = r.Description, Category = r.Category, Servings = r.Servings, PrepTime = r.PrepTime, CookTime = r.CookTime, ImageUrl = r.ImageUrl, SourceName = r.SourceName, SourceUrl = r.SourceUrl, TagsJson = r.TagsJson, ServingSize = r.ServingSize }; editorIngSections = r.Ingredients.OrderBy(i => i.SectionOrder).GroupBy(i => i.Section).Select(g => new SectionContainer<RecipeIngredient> { Name = g.Key, Items = g.OrderBy(x => x.Order).Select(i => new RecipeIngredient { Id = i.Id, RecipeId = i.RecipeId, Section = i.Section, Order = i.Order, Name = i.Name, Quantity = i.Quantity, Unit = i.Unit, Notes = i.Notes, Calories = i.Calories, Protein = i.Protein, Carbs = i.Carbs, Fat = i.Fat, Fiber = i.Fiber }).ToList() }).ToList(); editorInstSections = r.Instructions.OrderBy(i => i.SectionOrder).GroupBy(i => i.Section).Select(g => new SectionContainer<RecipeInstruction> { Name = g.Key, Items = g.OrderBy(x => x.StepNumber).Select(i => new RecipeInstruction { Id = i.Id, RecipeId = i.RecipeId, Section = i.Section, StepNumber = i.StepNumber, Text = i.Text }).ToList() }).ToList(); editingTags = string.Join(", ", GetTags(r.TagsJson)); activeTab = "General"; }
    private async Task SaveRecipe() { if (editingRecipe == null || currentUser == null) return; editingRecipe.TagsJson = JsonSerializer.Serialize(editingTags.Split(',').Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)).ToList()); var finalIngredients = new List<RecipeIngredient>(); for(int s=0; s<editorIngSections.Count; s++) { var sec = editorIngSections[s]; for(int i=0; i<sec.Items.Count; i++) { var item = sec.Items[i]; item.Section = sec.Name; item.SectionOrder = s; item.Order = i; finalIngredients.Add(item); } } var finalInstructions = new List<RecipeInstruction>(); for(int s=0; s<editorInstSections.Count; s++) { var sec = editorInstSections[s]; for(int i=0; i<sec.Items.Count; i++) { var item = sec.Items[i]; item.Section = sec.Name; item.SectionOrder = s; item.StepNumber = i + 1; finalInstructions.Add(item); } } if (editingRecipe.Id == 0) { Db.Recipes.Add(editingRecipe); await Db.SaveChangesAsync(); foreach(var ing in finalIngredients) { ing.RecipeId = editingRecipe.Id; Db.RecipeIngredients.Add(ing); } foreach(var inst in finalInstructions) { inst.RecipeId = editingRecipe.Id; Db.RecipeInstructions.Add(inst); } } else { var dbRecipe = await Db.Recipes.FindAsync(editingRecipe.Id); if (dbRecipe != null) { Db.Entry(dbRecipe).CurrentValues.SetValues(editingRecipe); var oldIngs = await Db.RecipeIngredients.Where(i => i.RecipeId == editingRecipe.Id).ToListAsync(); Db.RecipeIngredients.RemoveRange(oldIngs); foreach(var ing in finalIngredients) { ing.Id = 0; ing.RecipeId = editingRecipe.Id; Db.RecipeIngredients.Add(ing); } var oldInsts = await Db.RecipeInstructions.Where(i => i.RecipeId == editingRecipe.Id).ToListAsync(); Db.RecipeInstructions.RemoveRange(oldInsts); foreach(var inst in finalInstructions) { inst.Id = 0; inst.RecipeId = editingRecipe.Id; Db.RecipeInstructions.Add(inst); } } } await Db.SaveChangesAsync(); editingRecipe = null; await LoadData(); if (selectedRecipe != null && selectedRecipe.Id == editingRecipe?.Id) SelectRecipe(RecipeList.First(r => r.Id == selectedRecipe.Id)); }
    private async Task DeleteRecipe(Recipe r) { if (await JS.InvokeAsync<bool>("confirm", $"Delete '{r.Title}'?")) { var ings = await Db.RecipeIngredients.Where(i => i.RecipeId == r.Id).ToListAsync(); var insts = await Db.RecipeInstructions.Where(i => i.RecipeId == r.Id).ToListAsync(); Db.RecipeIngredients.RemoveRange(ings); Db.RecipeInstructions.RemoveRange(insts); Db.Recipes.Remove(r); await Db.SaveChangesAsync(); selectedRecipe = null; await LoadData(); } }
    // --- REORDERING HELPERS ---
    private void MoveSection<T>(List<SectionContainer<T>> list, int index, int direction) { int newIndex = index + direction; if (newIndex >= 0 && newIndex < list.Count) { var item = list[index]; list.RemoveAt(index); list.Insert(newIndex, item); } }
    private void MoveItem<T>(List<T> list, int index, int direction) { int newIndex = index + direction; if (newIndex >= 0 && newIndex < list.Count) { var item = list[index]; list.RemoveAt(index); list.Insert(newIndex, item); } }
    // --- SCALING & CONVERSION LOGIC ---
    private void UpdateServings(int delta) { currentServings = Math.Max(1, currentServings + delta); }
    private (string Qty, string Unit) ScaleIngredient(string qty, string unit, int current, int original) { if (original <= 0) original = 1; if (current == original) return (ToUnicode(qty), unit); double factor = (double)current / original; double val = ParseQty(qty); if (val <= 0) return (qty, unit); val *= factor; string u = unit.ToLower().Trim(); if (u.StartsWith("cup") || u.StartsWith("tbsp") || u.StartsWith("tablespoon") || u.StartsWith("tsp") || u.StartsWith("teaspoon")) { if (u.StartsWith("cup")) val *= 48; else if (u.StartsWith("tbsp") || u.StartsWith("tablespoon")) val *= 3; if (val < 0.125 && val > 0) val = 0.125; if (val >= 48) { val /= 48; u = "cup"; } else if (val >= 3) { val /= 3; u = "tbsp"; } else { u = "tsp"; } } else if (u.StartsWith("lb") || u.StartsWith("pound") || u.StartsWith("oz") || u.StartsWith("ounce")) { if (u.StartsWith("lb") || u.StartsWith("pound")) val *= 16; if (val < 0.125 && val > 0) val = 0.125; if (val >= 16) { val /= 16; u = "lb"; } else { u = "oz"; } } else if (u.StartsWith("g") || u.StartsWith("gram")) { if (val < 1 && val > 0) val = 1; } double fractionPart = val - Math.Floor(val); double wholePart = Math.Floor(val); double[] snaps = { 0, 0.125, 0.25, 0.333, 0.5, 0.666, 0.75, 0.875, 1.0 }; string[] snapStrs = { "", "‚Öõ", "¬º", "‚Öì", "¬Ω", "‚Öî", "¬æ", "‚Öû", "1" }; double closest = snaps.OrderBy(x => Math.Abs(x - fractionPart)).First(); int idx = Array.IndexOf(snaps, closest); if (closest == 1.0) { wholePart++; closest = 0; idx = 0; } string finalQty = wholePart > 0 ? $"{wholePart}" : ""; if (idx > 0) finalQty += (wholePart > 0 ? " " : "") + snapStrs[idx]; if (string.IsNullOrEmpty(finalQty)) finalQty = "0"; return (finalQty, u); }
    private string ToUnicode(string qty) { return qty.Replace("1/2", "¬Ω").Replace("1/4", "¬º").Replace("3/4", "¬æ").Replace("1/3", "‚Öì").Replace("2/3", "‚Öî").Replace("1/8", "‚Öõ"); }
    // --- CATEGORY MANAGER ---
    private void OpenCategoryManager() { showCatModal = true; _ = LoadData(); }
    private async Task AddCategory() { if (!string.IsNullOrWhiteSpace(newCategoryName) && currentUser != null) { Db.RecipeCategories.Add(new RecipeCategory { UserId = currentUser.Id, Name = newCategoryName }); await Db.SaveChangesAsync(); newCategoryName = ""; await LoadData(); } }
    private async Task DeleteCategory(RecipeCategory c) { if (await JS.InvokeAsync<bool>("confirm", $"Delete '{c.Name}'?")) { var orphaned = await Db.Recipes.Where(r => r.Category == c.Name && r.UserId == currentUser.Id).ToListAsync(); foreach(var r in orphaned) r.Category = "Uncategorized"; Db.RecipeCategories.Remove(c); await Db.SaveChangesAsync(); await LoadData(); } }
    private void EditCategory(RecipeCategory c) { editingCategory = new RecipeCategory { Id = c.Id, UserId = c.UserId, Name = c.Name, ImageUrl = c.ImageUrl }; }
    private async Task SaveCategory() { if (editingCategory == null) return; var existing = await Db.RecipeCategories.FindAsync(editingCategory.Id); if (existing != null) { existing.Name = editingCategory.Name; existing.ImageUrl = editingCategory.ImageUrl; existing.ImageId = editingCategory.ImageId; await Db.SaveChangesAsync(); await LoadData(); } editingCategory = null; }
    // --- STANDARD UTILS ---
    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }
    private IEnumerable<Recipe> FilteredRecipes => string.IsNullOrWhiteSpace(searchTerm) ? RecipeList : RecipeList.Where(r => (r.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) || (GetTags(r.TagsJson).Any(t => t.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))));
    private void SelectRecipe(Recipe r) { selectedRecipe = r; currentServings = r.Servings > 0 ? r.Servings : 1; UpdateUrl(r.Id); _ = JS.InvokeVoidAsync("scrollToTop"); }
    private void ClearSelection() { selectedRecipe = null; UpdateUrl(null); _ = JS.InvokeVoidAsync("scrollToTop"); }
    private void UpdateUrl(int? id) { var uri = Nav.ToAbsoluteUri(Nav.Uri).GetLeftPart(UriPartial.Path); if (id.HasValue) Nav.NavigateTo($"{uri}?id={id}", false); else Nav.NavigateTo(uri, false); }
    private List<string> GetTags(string json) { try { return JsonSerializer.Deserialize<List<string>>(json) ?? new(); } catch { return new(); } }
    
    // --- SMART TAG HELPERS ---
    private List<string> GetPopularTags()
    {
        return RecipeList
            .SelectMany(r => GetTags(r.TagsJson))
            .GroupBy(t => t, StringComparer.OrdinalIgnoreCase)
            .OrderByDescending(g => g.Count())
            .Select(g => g.Key)
            .Distinct()
            .Take(20)
            .ToList();
    }

    private void ToggleTagInEditor(string tag)
    {
        var tags = editingTags
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .ToList();

        // Check case-insensitive match
        var existing = tags.FirstOrDefault(t => t.Equals(tag, StringComparison.OrdinalIgnoreCase));

        if (existing != null)
        {
            tags.Remove(existing);
        }
        else
        {
            tags.Add(tag);
        }

        editingTags = string.Join(", ", tags);
    }

    private async Task MigrateDashboardData() { if (currentUser == null) return; await Db.Database.ExecuteSqlRawAsync($"UPDATE \"LinkGroups\" SET \"UserId\" = {currentUser.Id}; UPDATE \"Links\" SET \"UserId\" = {currentUser.Id}; UPDATE \"Stocks\" SET \"UserId\" = {currentUser.Id}; UPDATE \"Countdowns\" SET \"UserId\" = {currentUser.Id};"); await JS.InvokeVoidAsync("alert", "Dashboard Data Claimed!"); }
    private async Task CheckDbStatus() { var total = await Db.Recipes.CountAsync(); var myCount = await Db.Recipes.CountAsync(r => r.UserId == currentUser!.Id); await JS.InvokeVoidAsync("alert", $"Total Recipes: {total}\nMy Recipes: {myCount}\nUser: {currentUser?.Id}"); }
    private void ImportRecipes() { Nav.NavigateTo("/recipes", true); }
    private async Task UpgradeDatabase() { try { await Db.Database.ExecuteSqlRawAsync(@"ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""SourceName"" text; ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""SourceUrl"" text; ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""TagsJson"" text DEFAULT '[]'; ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""UserId"" integer DEFAULT 1; ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""ServingSize"" text; ALTER TABLE ""Recipes"" ADD COLUMN IF NOT EXISTS ""ImageId"" integer; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Section"" text DEFAULT 'Main'; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Calories"" double precision DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Protein"" double precision DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Carbs"" double precision DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Fat"" double precision DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Fiber"" double precision DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""Order"" integer DEFAULT 0; ALTER TABLE ""RecipeIngredients"" ADD COLUMN IF NOT EXISTS ""SectionOrder"" integer DEFAULT 0; ALTER TABLE ""RecipeInstructions"" ADD COLUMN IF NOT EXISTS ""Section"" text DEFAULT 'Directions'; ALTER TABLE ""RecipeInstructions"" ADD COLUMN IF NOT EXISTS ""SectionOrder"" integer DEFAULT 0; UPDATE ""Recipes"" SET ""ServingSize"" = '' WHERE ""ServingSize"" IS NULL; ALTER TABLE ""RecipeCategories"" ADD COLUMN IF NOT EXISTS ""ImageUrl"" text; ALTER TABLE ""RecipeCategories"" ADD COLUMN IF NOT EXISTS ""ImageId"" integer; CREATE TABLE IF NOT EXISTS ""StoredImages"" (""Id"" serial PRIMARY KEY, ""Data"" bytea, ""ContentType"" text, ""OriginalName"" text, ""UploadedAt"" timestamp with time zone);"); Nav.NavigateTo(Nav.Uri, forceLoad: true); } catch (Exception ex) { errorMessage = "Fix Failed: " + ex.Message; } }
    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); string suffix = (now.Day % 10 == 1 && now.Day != 11) ? "st" : (now.Day % 10 == 2 && now.Day != 12) ? "nd" : (now.Day % 10 == 3 && now.Day != 13) ? "rd" : "th"; CurrentDate = $"{now:dddd, MMMM d}{suffix} {now:yyyy}"; CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"Qw", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };
    private (int Cal, int Pro, int Fat, int Carb, int Fib, int Net) CalculateMacros(Recipe r) { double cal = 0, pro = 0, fat = 0, carb = 0, fib = 0; foreach (var ing in r.Ingredients) { cal += ing.Calories; pro += ing.Protein; fat += ing.Fat; carb += ing.Carbs; fib += ing.Fiber; } int s = r.Servings > 0 ? r.Servings : 1; return ((int)(cal / s), (int)(pro / s), (int)(fat / s), (int)(carb / s), (int)(fib / s), (int)((carb - fib) / s)); }
    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}