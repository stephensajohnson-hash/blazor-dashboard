@page "/hsa"
@using Dashboard
@using Microsoft.EntityFrameworkCore
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory

<div class="p-10 bg-black min-h-screen text-white font-sans">
    <h1 class="text-2xl font-black mb-8 border-b border-gray-800 pb-4 uppercase tracking-tighter">
        HSA Table Initializer
    </h1>

    <div class="max-w-2xl">
        <button @onclick="CreateHsaTable" 
                class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-black text-lg uppercase tracking-[0.3em] transition-all shadow-[0_0_30px_rgba(37,99,235,0.4)] active:scale-95 mb-8">
            Initialize Database Table
        </button>

        <div class="bg-gray-900 border border-gray-800 rounded-3xl p-6 shadow-2xl">
            <h2 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">
                System Execution Log
            </h2>
            <div class="font-mono text-xs text-emerald-400 space-y-1 h-96 overflow-y-auto">
                @if (!logs.Any())
                {
                    <div class="text-gray-600 italic">Ready for command...</div>
                }
                @foreach (var log in logs)
                {
                    <div class="leading-relaxed">
                        <span class="text-gray-600">[@log.Timestamp]</span> @log.Message
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<LogEntry> logs = new();

    private async Task CreateHsaTable()
    {
        AddLog("BUTTON CLICKED: Starting initialization sequence.");
        StateHasChanged();

        try
        {
            AddLog("Creating Database Context Factory...");
            using var db = await DbFactory.CreateDbContextAsync();
            
            var sql = @"
                CREATE TABLE IF NOT EXISTS ""HsaReceipts"" (
                    ""Id"" SERIAL PRIMARY KEY,
                    ""UserId"" INTEGER NOT NULL,
                    ""Type"" TEXT NOT NULL,
                    ""Provider"" TEXT NOT NULL,
                    ""ServiceDate"" TIMESTAMP NOT NULL,
                    ""Amount"" DECIMAL(18,2) NOT NULL,
                    ""Note"" TEXT,
                    ""FileName"" TEXT,
                    ""ContentType"" TEXT,
                    ""FileData"" BYTEA,
                    ""IsReimbursed"" BOOLEAN NOT NULL DEFAULT FALSE,
                    ""ReimbursedAt"" TIMESTAMP,
                    ""TaxYear"" INTEGER NOT NULL,
                    ""CreatedAt"" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
                );";

            AddLog("CONNECTION OPEN: Executing Raw SQL command to Postgres...");
            await db.Database.ExecuteSqlRawAsync(sql);
            
            AddLog("SQL SUCCESS: Table 'HsaReceipts' verified or created.");
        }
        catch (Exception ex)
        {
            AddLog("CRITICAL ERROR: " + ex.Message);
            if (ex.InnerException != null)
            {
                AddLog("INNER ERROR: " + ex.InnerException.Message);
            }
        }

        AddLog("Sequence Complete.");
        StateHasChanged();
    }

    private void AddLog(string msg)
    {
        logs.Add(new LogEntry { Timestamp = DateTime.Now.ToString("HH:mm:ss"), Message = msg });
        Console.WriteLine($"HSA_LOG: {msg}");
    }

    private class LogEntry
    {
        public string Timestamp { get; set; } = "";
        public string Message { get; set; } = "";
    }
}