@page "/hsa"
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white font-sans">
    <BulletHeader ShowControls="false" CustomDateText="HSA Manager" />

    <main class="p-10 flex flex-col items-center gap-8">
        <button type="button" 
                @onclick="OpenAddModal" 
                class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-black text-xl uppercase tracking-widest shadow-2xl transition active:scale-95">
            ＋ Add Receipt
        </button>

        <div class="w-full max-w-2xl bg-black border border-gray-800 p-6 rounded-3xl h-64 overflow-y-auto shadow-2xl font-mono text-[10px] text-emerald-500">
            <div class="text-gray-600 uppercase font-black mb-2 border-b border-gray-800 pb-1">System Trace Console</div>
            @foreach (var log in logs)
            {
                <div class="mb-1">@log</div>
            }
        </div>
    </main>
</div>

@if (showModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-700 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden p-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">@(editingId == 0 ? "New Receipt" : "Edit Receipt")</h2>
                <button @onclick="CloseModal" class="text-gray-500 hover:text-white text-2xl font-bold px-2">✕</button>
            </div>

            <EditForm Model="tempReceipt" OnValidSubmit="SaveReceipt" class="space-y-5 text-left">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Provider</label>
                    <InputText @bind-Value="tempReceipt.Provider" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" placeholder="e.g. Walgreens, Dr. Smith" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Amount ($)</label>
                        <InputNumber @bind-Value="tempReceipt.Amount" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none font-mono" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Category</label>
                        <InputSelect @bind-Value="tempReceipt.Type" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none">
                            <option value="Medical">Medical</option>
                            <option value="Dental">Dental</option>
                            <option value="Eye Care">Eye Care</option>
                            <option value="Chiropractor">Chiropractor</option>
                            <option value="Other">Other</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Service Date</label>
                        <InputDate @bind-Value="tempReceipt.ServiceDate" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div class="flex items-center gap-3 pt-6 pl-2">
                        <InputCheckbox @bind-Value="tempReceipt.IsReimbursed" id="reimbursed" class="w-5 h-5 accent-blue-600 rounded bg-gray-900 border-gray-700" />
                        <label for="reimbursed" class="text-[10px] font-black text-gray-400 uppercase cursor-pointer tracking-widest">Already Reimbursed</label>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Notes</label>
                    <InputTextArea @bind-Value="tempReceipt.Note" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm h-24 focus:border-blue-500 outline-none" placeholder="Describe the service or items..." />
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @onclick="CloseModal" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition shadow-lg">
                        @(editingId == 0 ? "Create Record" : "Save Changes")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<string> logs = new();
    private bool showModal = false;
    private int editingId = 0;
    private HsaReceipt tempReceipt = new();

    protected override void OnInitialized()
    {
        AddLog("BOOT: System standing by.");
    }

    private void OpenAddModal()
    {
        AddLog("CLICK: Add modal requested.");
        editingId = 0;
        
        // Match the initialization pattern from budget-tracker
        tempReceipt = new HsaReceipt 
        { 
            ServiceDate = DateTime.Today, 
            Provider = "", 
            Type = "Medical",
            Note = "",
            IsReimbursed = false 
        };
        
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        AddLog("UI: Modal closed.");
        StateHasChanged();
    }

    private async Task SaveReceipt()
    {
        AddLog($"DB_ACTION: Saving record for {tempReceipt.Provider}...");
        try 
        {
            using var db = await DbFactory.CreateDbContextAsync();
            tempReceipt.UserId = 1;
            tempReceipt.TaxYear = tempReceipt.ServiceDate.Year;

            if (editingId == 0)
            {
                db.HsaReceipts.Add(tempReceipt);
            }
            else
            {
                db.HsaReceipts.Update(tempReceipt);
            }
            
            await db.SaveChangesAsync();
            AddLog("DB_SUCCESS: Transaction committed.");
            CloseModal();
            // In the next step, we'll trigger a LoadData here
        }
        catch (Exception ex) 
        { 
            AddLog($"DB_ERROR: {ex.Message}");
            Console.WriteLine($"DB_SAVE_FAIL: {ex.Message}");
        }
    }

    private void AddLog(string msg)
    {
        logs.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {msg}");
        Console.WriteLine($"HSA_DEBUG: {msg}");
    }
}