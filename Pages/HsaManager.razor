@page "/hsa"
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS

<div class="min-h-screen bg-[#0a0a0a] text-white font-sans overflow-x-hidden">
    @* 1. COMMON HEADER *@
    <BulletHeader ShowControls="false" CustomDateText="HSA Archive" />

    <div class="max-w-4xl mx-auto p-10 flex flex-col items-center">
        
        @* 2. TRIGGER BUTTON *@
        <button type="button" @onclick="OpenModal" 
                class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-black text-lg uppercase tracking-[0.3em] shadow-lg transition-all active:scale-95 mb-12">
            Add Receipt
        </button>

        @* 3. TERMINAL CONSOLE (Kept for verification) *@
        <div class="w-full bg-gray-900 border border-gray-800 p-6 rounded-3xl h-64 overflow-y-auto shadow-2xl font-mono text-[10px] text-emerald-500">
            <div class="text-gray-600 uppercase font-black mb-2 border-b border-gray-800 pb-1">System Trace</div>
            @foreach (var log in logs)
            {
                <div class="mb-1">@log</div>
            }
        </div>
    </div>
</div>

@* 4. THE MODAL - Triggered by tempReceipt not being null *@
@if (tempReceipt != null)
{
    <div class="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-[#0f0f0f] border border-gray-800 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-black/20">
                <h2 class="text-sm font-black uppercase tracking-[0.2em]">New Record</h2>
                <button type="button" @onclick="Close" class="text-gray-500 hover:text-white transition px-2 text-2xl">&times;</button>
            </div>
            
            <EditForm Model="tempReceipt" OnValidSubmit="SaveReceipt" class="p-8 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Provider</label>
                        <InputText @bind-Value="tempReceipt.Provider" class="w-full bg-black border border-gray-800 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Amount</label>
                        <InputNumber @bind-Value="tempReceipt.Amount" class="w-full bg-black border border-gray-800 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Type</label>
                        <InputSelect @bind-Value="tempReceipt.Type" class="w-full bg-black border border-gray-800 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none">
                            <option value="Medical">Medical</option>
                            <option value="Dental">Dental</option>
                            <option value="Eye Care">Eye Care</option>
                            <option value="Chiropractor">Chiropractor</option>
                            <option value="Other">Other</option>
                        </InputSelect>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Date of Service</label>
                        <InputDate @bind-Value="tempReceipt.ServiceDate" class="w-full bg-black border border-gray-800 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div class="flex items-center gap-3 pt-6 pl-2">
                        <InputCheckbox @bind-Value="tempReceipt.IsReimbursed" id="reimbursed" class="w-4 h-4 accent-blue-600" />
                        <label for="reimbursed" class="text-[10px] font-black text-gray-400 uppercase cursor-pointer">Reimbursed</label>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" @onclick="Close" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition shadow-lg">Save Record</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<string> logs = new();
    private HsaReceipt? tempReceipt;

    protected override void OnInitialized()
    {
        AddLog("BOOT: Page ready.");
    }

    private void OpenModal()
    {
        try 
        {
            AddLog("CRITICAL_CHECK: Entering OpenModal method.");
            
            tempReceipt = new HsaReceipt 
            { 
                ServiceDate = DateTime.Today, 
                Type = "Medical", 
                Provider = "", 
                Note = "" 
            };
            
            AddLog("CRITICAL_CHECK: tempReceipt initialized. Calling StateHasChanged.");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // This will print to your Render Logs even if the UI is dead
            Console.WriteLine($"FATAL_UI_ERROR: {ex.Message}");
            AddLog($"FATAL: {ex.Message}");
        }
    }

    private async Task SaveReceipt()
    {
        if (tempReceipt == null) return;
        
        try
        {
            AddLog("DB: Attempting Save...");
            using var db = await DbFactory.CreateDbContextAsync();
            
            tempReceipt.UserId = 1; // Default
            tempReceipt.TaxYear = tempReceipt.ServiceDate.Year;
            
            db.HsaReceipts.Add(tempReceipt);
            await db.SaveChangesAsync();
            
            AddLog("DB: Save Successful.");
            Close();
        }
        catch (Exception ex)
        {
            AddLog($"ERROR: {ex.Message}");
        }
    }

    private void Close()
    {
        tempReceipt = null;
        AddLog("STATE: Object cleared. Modal should hide.");
        StateHasChanged();
    }

    private void AddLog(string msg)
    {
        logs.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {msg}");
        Console.WriteLine($"HSA: {msg}");
    }
}