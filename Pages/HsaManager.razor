@page "/hsa"
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web @* FIXED: Added missing namespace for RenderMode *@
@using Microsoft.JSInterop
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white font-sans">
    <BulletHeader ShowControls="false" CustomDateText="HSA Manager" />

    <main class="p-10 flex flex-col items-center gap-8">
        
        @* THE ADD BUTTON *@
        <button type="button" 
                @onclick="OpenAddModal" 
                class="bg-blue-600 hover:bg-blue-500 text-white px-12 py-6 rounded-2xl font-black text-xl uppercase tracking-widest shadow-2xl transition active:scale-95">
            ï¼‹ Add Receipt
        </button>

        @* SYSTEM LOG CONSOLE *@
        <div class="w-full max-w-2xl bg-black border border-gray-800 p-6 rounded-3xl h-64 overflow-y-auto shadow-2xl font-mono text-[10px] text-emerald-500">
            <div class="text-gray-600 uppercase font-black mb-2 border-b border-gray-800 pb-1">System Trace Console</div>
            @foreach (var log in logs)
            {
                <div class="mb-1">@log</div>
            }
        </div>
    </main>
</div>

@* THE MODAL *@
@if (showModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-700 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden p-8 text-center">
            <h2 class="text-lg font-black uppercase tracking-widest text-white mb-8">Modal Interface Active</h2>
            
            <EditForm Model="tempReceipt" OnValidSubmit="SaveReceipt" class="space-y-6 text-left">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1">Provider</label>
                    <InputText @bind-Value="tempReceipt.Provider" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" @onclick="CloseModal" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition shadow-lg">Save Record</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<string> logs = new();
    private bool showModal = false;
    private HsaReceipt tempReceipt = new();

    protected override void OnInitialized()
    {
        AddLog("BOOT: System standing by.");
    }

    private void OpenAddModal()
    {
        AddLog("CLICK: OpenAddModal invoked.");
        tempReceipt = new HsaReceipt { ServiceDate = DateTime.Today, Provider = "", Type = "Medical" };
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        AddLog("STATE: Modal closed.");
        StateHasChanged();
    }

    private async Task SaveReceipt()
    {
        AddLog("DB: Saving record...");
        try 
        {
            using var db = await DbFactory.CreateDbContextAsync();
            tempReceipt.UserId = 1;
            tempReceipt.TaxYear = tempReceipt.ServiceDate.Year;
            db.HsaReceipts.Add(tempReceipt);
            await db.SaveChangesAsync();
            AddLog("DB: Success.");
            CloseModal();
        }
        catch (Exception ex) { AddLog($"DB_ERROR: {ex.Message}"); }
    }

    private void AddLog(string msg)
    {
        logs.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {msg}");
        Console.WriteLine($"HSA_DEBUG: {msg}");
    }
}