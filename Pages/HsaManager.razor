@page "/hsa"
@using Dashboard.Components.Bullet
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory

<div class="print-container bg-white text-black min-h-screen font-sans">
    <BulletHeader ShowControls="false" CustomDateText="HSA Receipt Manager" />

    <div class="max-w-6xl mx-auto p-6">
        @if (!tableExists)
        {
            <div class="bg-blue-900/50 border border-blue-800 text-blue-200 p-8 rounded-2xl mb-6 shadow-2xl">
                <div class="flex flex-col items-center gap-4 text-center">
                    <span class="text-3xl">üõ†Ô∏è</span>
                    <div>
                        <h3 class="font-black uppercase tracking-widest mb-1">Database Initialization Required</h3>
                        <p class="text-xs text-blue-300 mb-4">The HsaReceipts table was not found in your Postgres database.</p>
                    </div>
                    <button @onclick="CreateHsaTable" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-black text-sm uppercase tracking-[0.2em] transition-all shadow-lg">
                        Create HsaReceipts Table
                    </button>
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="mt-4 p-3 bg-black/40 rounded-lg text-[10px] font-mono text-yellow-400">
                            @statusMessage
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl h-fit">
                    <h3 class="text-white font-black uppercase tracking-widest text-sm mb-4 border-b border-gray-800 pb-2">New Receipt</h3>
                    <EditForm Model="newReceipt" OnValidSubmit="HandleSubmit" class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1">Provider</label>
                            <InputText @bind-Value="newReceipt.Provider" class="w-full bg-black border border-gray-800 rounded-lg p-2 text-white text-sm focus:border-blue-500 outline-none" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1">Amount</label>
                                <InputNumber @bind-Value="newReceipt.Amount" class="w-full bg-black border border-gray-800 rounded-lg p-2 text-white text-sm" />
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1">Type</label>
                                <InputSelect @bind-Value="newReceipt.Type" class="w-full bg-black border border-gray-800 rounded-lg p-2 text-white text-sm">
                                    <option value="Medical">Medical</option>
                                    <option value="Dental">Dental</option>
                                    <option value="Eye Care">Eye Care</option>
                                    <option value="Chiropractor">Chiropractor</option>
                                    <option value="Other">Other</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1">Date of Service</label>
                            <InputDate @bind-Value="newReceipt.ServiceDate" class="w-full bg-black border border-gray-800 rounded-lg p-2 text-white text-sm" />
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-xl transition shadow-lg uppercase text-xs tracking-widest mt-4">Save Receipt</button>
                    </EditForm>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl shadow-md">
                            <div class="text-[10px] font-black text-gray-500 uppercase">Total Expenses</div>
                            <div class="text-2xl font-black text-white">$@receipts.Sum(x => x.Amount).ToString("N2")</div>
                        </div>
                    </div>
                    <div class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden shadow-xl">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-black border-b border-gray-800 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                <tr>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Provider</th>
                                    <th class="p-4">Type</th>
                                    <th class="p-4 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm text-gray-300">
                                @if (!receipts.Any()) { <tr><td colspan="4" class="p-10 text-center text-gray-600 italic">No receipts found.</td></tr> }
                                @foreach (var r in receipts)
                                {
                                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition">
                                        <td class="p-4 font-mono text-xs text-gray-500">@r.ServiceDate.ToShortDateString()</td>
                                        <td class="p-4 text-white font-bold uppercase tracking-tight">@r.Provider</td>
                                        <td class="p-4 uppercase text-[10px]">@r.Type</td>
                                        <td class="p-4 text-right font-black text-blue-400">$@r.Amount.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private HsaReceipt newReceipt = new() { ServiceDate = DateTime.Now, Type = "Medical" };
    private List<HsaReceipt> receipts = new();
    private string statusMessage = "";
    private bool tableExists = false;

    // Use AfterRender so the circuit is connected before we check the DB
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) { await LoadReceipts(); }
    }

    private async Task LoadReceipts()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            receipts = await db.HsaReceipts.OrderByDescending(x => x.ServiceDate).ToListAsync();
            tableExists = true;
            statusMessage = "";
        }
        catch (Exception ex)
        {
            tableExists = false;
            statusMessage = $"System Message: Table check failed. {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task CreateHsaTable()
    {
        statusMessage = "Status: Executing SQL 'CREATE TABLE'...";
        await InvokeAsync(StateHasChanged);
        
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var sql = @"
                CREATE TABLE IF NOT EXISTS ""HsaReceipts"" (
                    ""Id"" SERIAL PRIMARY KEY,
                    ""UserId"" INTEGER NOT NULL,
                    ""Type"" TEXT NOT NULL,
                    ""Provider"" TEXT NOT NULL,
                    ""ServiceDate"" TIMESTAMP NOT NULL,
                    ""Amount"" DECIMAL(18,2) NOT NULL,
                    ""Note"" TEXT,
                    ""FileName"" TEXT,
                    ""ContentType"" TEXT,
                    ""FileData"" BYTEA,
                    ""IsReimbursed"" BOOLEAN NOT NULL DEFAULT FALSE,
                    ""ReimbursedAt"" TIMESTAMP,
                    ""TaxYear"" INTEGER NOT NULL,
                    ""CreatedAt"" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
                );";
            
            await db.Database.ExecuteSqlRawAsync(sql);
            statusMessage = "Status: Table created! Refreshing...";
            await InvokeAsync(StateHasChanged);
            await LoadReceipts();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error details: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleSubmit() 
    { 
        using var db = await DbFactory.CreateDbContextAsync();
        newReceipt.UserId = 1;
        newReceipt.TaxYear = newReceipt.ServiceDate.Year;
        db.HsaReceipts.Add(newReceipt);
        await db.SaveChangesAsync();
        newReceipt = new HsaReceipt { ServiceDate = DateTime.Now, Type = "Medical" };
        await LoadReceipts();
    }
}