@page "/hsa"
@using Dashboard
@using Dashboard.Components.Bullet
@using Dashboard.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject HsaExportService ExportService

<div class="min-h-screen bg-[#0a0a0a] text-white font-sans">
    @* 1. MAIN HEADER - STICKY (72px height) *@
    <div class="no-print sticky top-0 z-50 bg-[#0a0a0a] border-b border-gray-800">
        <BulletHeader ShowControls="false" CustomDateText="HSA Ledger" />
    </div>

    @* 2. STICKY SUB-HEADER (Approx 80px height) *@
    <div class="sticky top-[72px] z-40 bg-[#0c0c0c]/95 backdrop-blur-md border-b border-gray-800 p-4 shadow-2xl no-print">
        <div class="max-w-[98%] mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-6">
                @* Year Filters *@
                <div class="flex items-center gap-2 bg-black/50 p-1 rounded-xl border border-gray-800">
                    <button type="button" @onclick="HandleFilterAll"
                            class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition @(selectedYear == 0 ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                        All Time
                    </button>
                    @foreach (var year in availableYears)
                    {
                        <button type="button" @onclick="() => FilterByYear(year)"
                                class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition @(selectedYear == year ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                            @year
                        </button>
                    }
                </div>

                @* TEMPORARY MIGRATION BUTTON *@
                <button @onclick="RunDisbursementMigration" class="bg-purple-900/30 hover:bg-purple-900/50 text-purple-400 border border-purple-800/50 px-3 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition active:scale-95">
                    Upgrade DB: Distributions
                </button>

                @* Selection Stats & Actions *@
                @if (selectedIds.Any())
                {
                    <div class="flex items-center gap-4 animate-in fade-in slide-in-from-left-2">
                        <div class="h-8 w-px bg-gray-800"></div>
                        <div class="flex flex-col">
                            <span class="text-[8px] font-black text-blue-500 uppercase tracking-widest">Selected Total</span>
                            <span class="text-xl font-black text-emerald-400 font-mono leading-none">$@SelectedTotal.ToString("N2")</span>
                        </div>
                        
                        @if (HasUnreimbursedSelected)
                        {
                            <button @onclick="OpenNewDistModal" 
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg transition active:scale-95">
                                Generate Submission
                            </button>
                        }

                        @if (HasReimbursedSelected)
                        {
                            <button @onclick="UndoReimbursement" 
                                    class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg transition active:scale-95">
                                Undo Status
                            </button>
                        }
                    </div>
                }
            </div>

            <button type="button" @onclick="OpenAddModal" 
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-[0.2em] transition shadow-lg active:scale-95 flex items-center gap-2">
                <span>‚ûï</span> Add Receipt
            </button>
        </div>
    </div>

    @* 3. LEDGER DISPLAY *@
    <div class="max-w-[98%] mx-auto p-4 pb-20">
        <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-gray-600 mb-4 ml-2">Receipt Ledger</h3>
        @if (isLoading)
        {
            <div class="flex flex-col items-center justify-center py-20 opacity-30">
                <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-[10px] font-black uppercase tracking-widest text-gray-500">Syncing Ledger...</div>
            </div>
        }
        else
        {
            <div class="bg-[#111] border border-gray-800 rounded-2xl shadow-2xl overflow-visible mb-12">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead>
                        <tr class="bg-[#1a1a1a] text-[10px] font-black uppercase tracking-[0.2em] text-gray-500 border-b border-gray-800">
                            <th class="p-4 w-12 text-center sticky top-[152px] z-30 bg-[#1a1a1a]">
                                <input type="checkbox" checked="@IsAllSelected" @onchange="ToggleAll" class="w-4 h-4 rounded border-gray-700 bg-gray-900 accent-blue-600" />
                            </th>
                            <th class="p-4 w-32 sticky top-[152px] z-30 bg-[#1a1a1a]">Date</th>
                            <th class="p-4 w-40 sticky top-[152px] z-30 bg-[#1a1a1a]">Patient</th>
                            <th class="p-4 w-[25%] sticky top-[152px] z-30 bg-[#1a1a1a]">Provider</th>
                            <th class="p-4 w-48 sticky top-[152px] z-30 bg-[#1a1a1a]">Category</th>
                            <th class="p-4 sticky top-[152px] z-30 bg-[#1a1a1a]">Note</th>
                            <th class="p-4 w-20 text-center sticky top-[152px] z-30 bg-[#1a1a1a]">File</th>
                            <th class="p-4 w-32 text-right sticky top-[152px] z-30 bg-[#1a1a1a]">Amount</th>
                            <th class="p-4 w-40 text-right pr-6 sticky top-[152px] z-30 bg-[#1a1a1a]">Refund Bal</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        @{
                            decimal runningTotal = 0;
                            @foreach (var r in filteredReceipts)
                            {
                                bool isReimbursed = r.DisbursementId != null;
                                if (!isReimbursed) { runningTotal += r.Amount; }
                                bool isSelected = selectedIds.Contains(r.Id);
                                
                                <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition group relative align-top">
                                    <td class="p-4 text-center">
                                        <input type="checkbox" checked="@isSelected" @onchange="@(e => ToggleSelection(r.Id))" class="w-4 h-4 rounded border-gray-700 bg-gray-900 accent-blue-600 cursor-pointer" />
                                    </td>
                                    <td class="p-4 font-mono text-gray-500 text-sm whitespace-nowrap">@r.ServiceDate.ToString("MM/dd/yyyy")</td>
                                    <td class="p-4 text-blue-400 font-bold text-sm break-words">@(r.Patient ?? "---")</td>
                                    <td class="p-4 text-white font-bold tracking-tight text-sm break-words">@(r.Provider ?? "---")</td>
                                    <td class="p-4 text-blue-400 text-sm whitespace-nowrap">@(r.Type ?? "Medical")</td>
                                    <td class="p-4 text-gray-400 italic text-sm break-words leading-relaxed">@(r.Note ?? "---")</td>
                                    <td class="p-4 text-center">
                                        @if (r.FileData != null && r.FileData.Length > 0)
                                        {
                                            <button @onclick="() => ViewFile(r)" class="hover:scale-110 transition-transform inline-block cursor-pointer">
                                                @(r.ContentType?.Contains("pdf") == true ? "üìÑ" : "üñºÔ∏è")
                                            </button>
                                        }
                                    </td>
                                    <td class="p-4 text-right font-mono text-sm whitespace-nowrap @(isReimbursed ? "line-through text-gray-600" : "text-emerald-400 font-bold")">
                                        $@r.Amount.ToString("N2")
                                    </td>
                                    <td class="p-4 text-right pr-6 font-black font-mono text-sm text-blue-400 relative whitespace-nowrap">
                                        $@runningTotal.ToString("N2")
                                        <div class="absolute inset-y-0 right-0 flex items-center gap-2 px-4 bg-gradient-to-l from-[#111] via-[#111] to-transparent opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                            <button @onclick="() => OpenEditModal(r)" class="bg-blue-600 p-1.5 rounded hover:bg-blue-500 text-[10px] shadow-lg">‚úèÔ∏è</button>
                                            <button @onclick="() => DeleteReceipt(r.Id)" class="bg-red-600 p-1.5 rounded hover:bg-red-500 text-[10px] shadow-lg">‚úï</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }

        @* DISTRIBUTION HISTORY *@
        <div class="mt-8 pb-40">
            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-gray-600 mb-4 ml-2">Distribution History</h3>
            <div class="bg-[#111] border border-gray-800 rounded-2xl shadow-2xl overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-black/50 text-[10px] font-black uppercase tracking-[0.2em] text-gray-500 border-b border-gray-800">
                            <th class="p-4 w-40">Created</th>
                            <th class="p-4 w-48">Key</th>
                            <th class="p-4">Description</th>
                            <th class="p-4 w-40 text-right pr-6">Total</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        @foreach (var d in distributions)
                        {
                            <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition group relative align-top">
                                <td class="p-4 font-mono text-gray-500">@d.CreatedAt.ToString("MM/dd/yyyy HH:mm")</td>
                                <td class="p-4 text-blue-400 font-bold font-mono">@d.TransactionKey</td>
                                <td class="p-4 text-gray-400 italic break-words">@(d.Description ?? "---")</td>
                                <td class="p-4 text-right pr-6 font-black font-mono text-emerald-400 relative">
                                    $@d.TotalAmount.ToString("N2")
                                    <div class="absolute inset-y-0 right-0 flex items-center gap-2 px-4 bg-gradient-to-l from-[#111] via-[#111] to-transparent opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                        <button @onclick="() => RegenerateDistributionPdf(d)" class="bg-emerald-600 p-1.5 rounded hover:bg-emerald-500 text-[10px] shadow-lg" title="Regenerate PDF">üìÑ</button>
                                        <button @onclick="() => OpenEditDistModal(d)" class="bg-blue-600 p-1.5 rounded hover:bg-blue-500 text-[10px] shadow-lg">‚úèÔ∏è</button>
                                        <button @onclick="() => DeleteDistribution(d.Id)" class="bg-red-600 p-1.5 rounded hover:bg-red-500 text-[10px] shadow-lg">‚úï</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@* RECEIPT MODAL *@
@if (showModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-700 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden p-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">@(editingId == 0 ? "New Receipt" : "Edit Receipt")</h2>
                <button @onclick="CloseModal" class="text-gray-500 hover:text-white text-2xl font-bold px-2">‚úï</button>
            </div>
            <EditForm Model="tempReceipt" OnValidSubmit="SaveReceipt" class="space-y-5 text-left">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 tracking-widest">Patient</label>
                    <input @bind="tempReceipt.Patient" list="patient-list" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    <datalist id="patient-list">@foreach (var p in knownPatients) { <option value="@p" /> }</datalist>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Provider</label>
                    <input @bind="tempReceipt.Provider" list="provider-list" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    <datalist id="provider-list">@foreach (var pr in knownProviders) { <option value="@pr" /> }</datalist>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Amount ($)</label>
                        <InputNumber @bind-Value="tempReceipt.Amount" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm font-mono" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Category</label>
                        <InputSelect @bind-Value="tempReceipt.Type" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm">
                            <option value="Medical">Medical</option>
                            <option value="Chiropractic">Chiropractic</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Laboratory">Laboratory</option>
                            <option value="Dental">Dental</option>
                            <option value="Vision">Vision</option>
                            <option value="Other">Other</option>
                        </InputSelect>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Date</label>
                    <InputDate @bind-Value="tempReceipt.ServiceDate" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm" />
                </div>
                <div class="bg-black/30 p-4 rounded-2xl border border-gray-700">
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-2 ml-1 tracking-widest">Receipt Document</label>
                    <InputFile OnChange="HandleFileSelected" class="text-xs text-gray-500" />
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Notes</label>
                    <InputTextArea @bind-Value="tempReceipt.Note" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm h-24 focus:border-blue-500 outline-none" />
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" @onclick="CloseModal" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest shadow-lg">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@* DISTRIBUTION MODAL (NEW & EDIT) *@
@if (showDistModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-700 w-full max-w-lg rounded-3xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">@(tempDist.Id == 0 ? "New Distribution" : "Edit Distribution")</h2>
                <button @onclick="() => showDistModal = false" class="text-gray-500 hover:text-white text-2xl font-bold px-2">‚úï</button>
            </div>
            <EditForm Model="tempDist" OnValidSubmit="SaveDistribution" class="space-y-5 text-left">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 tracking-widest">Transaction Key</label>
                    <InputText @bind-Value="tempDist.TransactionKey" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm font-mono" placeholder="yyyyMMdd-HHmm" />
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 tracking-widest">Description</label>
                    <InputTextArea @bind-Value="tempDist.Description" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm h-24" />
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" @onclick="() => showDistModal = false" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl text-[10px] tracking-widest shadow-lg">
                        @(tempDist.Id == 0 ? "Generate & Save" : "Save Changes")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

<script>
    window.viewFileBlob = (base64, contentType) => {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: contentType });
        const blobUrl = URL.createObjectURL(blob);
        window.open(blobUrl, '_blank');
        setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
    };
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const anchorElement = document.createElement('a');
        anchorElement.href = url; anchorElement.download = fileName ?? '';
        anchorElement.click(); anchorElement.remove(); URL.revokeObjectURL(url);
    };
</script>

@code {
    private List<HsaReceipt> allReceipts = new();
    private List<HsaReceipt> filteredReceipts = new();
    private List<HsaDisbursement> distributions = new();
    private List<int> availableYears = new();
    private HashSet<int> selectedIds = new();
    private int selectedYear = 0;
    private bool isLoading = true;

    private bool showModal = false;
    private int editingId = 0;
    private HsaReceipt tempReceipt = new();

    private bool showDistModal = false;
    private HsaDisbursement tempDist = new();

    private List<string> knownPatients = new();
    private List<string> knownProviders = new();

    private decimal SelectedTotal => allReceipts.Where(r => selectedIds.Contains(r.Id)).Sum(r => r.Amount);
    private bool IsAllSelected => filteredReceipts.Any() && filteredReceipts.All(r => selectedIds.Contains(r.Id));
    private bool HasUnreimbursedSelected => allReceipts.Any(r => selectedIds.Contains(r.Id) && r.DisbursementId == null);
    private bool HasReimbursedSelected => allReceipts.Any(r => selectedIds.Contains(r.Id) && r.DisbursementId != null);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) 
        { 
            await LoadData(); 
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            allReceipts = await db.HsaReceipts.OrderBy(x => x.ServiceDate).ToListAsync();
            distributions = await db.HsaDisbursements.OrderByDescending(x => x.CreatedAt).ToListAsync();
            
            knownPatients = allReceipts.Select(x => x.Patient).Where(x => !string.IsNullOrEmpty(x)).Distinct().OrderBy(x => x).ToList()!;
            knownProviders = allReceipts.Select(x => x.Provider).Where(x => !string.IsNullOrEmpty(x)).Distinct().OrderBy(x => x).ToList()!;
            availableYears = allReceipts.Select(x => x.ServiceDate.Year).Distinct().OrderByDescending(x => x).ToList();
            ApplyFilter();
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"LOAD_ERR: {ex.Message}"); 
        }
        finally 
        { 
            isLoading = false; 
            await InvokeAsync(StateHasChanged); 
        }
    }

    private void ApplyFilter()
    {
        if (selectedYear == 0) 
        {
            filteredReceipts = new List<HsaReceipt>(allReceipts);
        }
        else 
        {
            filteredReceipts = allReceipts.Where(x => x.ServiceDate.Year == selectedYear).ToList();
        }
        StateHasChanged();
    }

    private void FilterByYear(int year) { selectedYear = year; ApplyFilter(); }
    private void HandleFilterAll() { selectedYear = 0; ApplyFilter(); }
    private void ToggleSelection(int id) { if (selectedIds.Contains(id)) selectedIds.Remove(id); else selectedIds.Add(id); }
    private void ToggleAll() { if (IsAllSelected) foreach (var r in filteredReceipts) selectedIds.Remove(r.Id); else foreach (var r in filteredReceipts) selectedIds.Add(r.Id); }

    private void OpenNewDistModal()
    {
        tempDist = new HsaDisbursement
        {
            Id = 0,
            CreatedAt = DateTime.Now,
            TransactionKey = DateTime.Now.ToString("yyyyMMdd-HHmm"),
            Description = ""
        };
        showDistModal = true;
    }

    private void OpenEditDistModal(HsaDisbursement d)
    {
        tempDist = new HsaDisbursement
        {
            Id = d.Id,
            CreatedAt = d.CreatedAt,
            TransactionKey = d.TransactionKey,
            Description = d.Description,
            TotalAmount = d.TotalAmount
        };
        showDistModal = true;
    }

    private async Task SaveDistribution()
    {
        isLoading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            if (tempDist.Id == 0)
            {
                // Creating New Distribution from Selection
                var targets = allReceipts.Where(r => selectedIds.Contains(r.Id) && r.DisbursementId == null).ToList();
                var dbTargets = await db.HsaReceipts
                    .Where(r => targets.Select(t => t.Id).Contains(r.Id))
                    .OrderBy(r => r.ServiceDate)
                    .ToListAsync();
                
                tempDist.TotalAmount = dbTargets.Sum(x => x.Amount);
                db.HsaDisbursements.Add(tempDist);
                await db.SaveChangesAsync();

                foreach (var r in dbTargets) 
                { 
                    r.DisbursementId = tempDist.Id; 
                }
                await db.SaveChangesAsync();

                // Generate PDF and Download
                var pdfBytes = ExportService.CreateSubmissionPdf(dbTargets, tempDist.TransactionKey, tempDist.Description);
                var fileName = $"HSA_{DateTime.Now:yyyyMMdd}_{tempDist.TransactionKey}.pdf";
                using var stream = new MemoryStream(pdfBytes);
                using var streamRef = new DotNetStreamReference(stream);
                await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
                
                selectedIds.Clear();
            }
            else
            {
                // Editing Existing Distribution Metadata
                var existing = await db.HsaDisbursements.FindAsync(tempDist.Id);
                if (existing != null)
                {
                    existing.TransactionKey = tempDist.TransactionKey;
                    existing.Description = tempDist.Description;
                    await db.SaveChangesAsync();
                }
            }
            showDistModal = false;
            await LoadData();
        }
        catch (Exception ex) 
        { 
            await JS.InvokeVoidAsync("alert", $"Save Error: {ex.Message}"); 
        }
        finally 
        { 
            isLoading = false; 
        }
    }

    private async Task RegenerateDistributionPdf(HsaDisbursement d)
    {
        isLoading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var dbTargets = await db.HsaReceipts
                .Where(r => r.DisbursementId == d.Id)
                .OrderBy(r => r.ServiceDate)
                .ToListAsync();

            if (dbTargets.Any())
            {
                var pdfBytes = ExportService.CreateSubmissionPdf(dbTargets, d.TransactionKey, d.Description);
                var fileName = $"HSA_Regen_{d.CreatedAt:yyyyMMdd}_{d.TransactionKey}.pdf";
                using var stream = new MemoryStream(pdfBytes);
                using var streamRef = new DotNetStreamReference(stream);
                await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Regen Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DeleteDistribution(int id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Delete this record? Receipts will become unreimbursed.")) 
        {
            return;
        }

        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var receipts = await db.HsaReceipts.Where(r => r.DisbursementId == id).ToListAsync();
            foreach (var r in receipts) 
            { 
                r.DisbursementId = null; 
            }

            var dist = await db.HsaDisbursements.FindAsync(id);
            if (dist != null) 
            { 
                db.HsaDisbursements.Remove(dist); 
            }

            await db.SaveChangesAsync();
            await LoadData();
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"DEL_ERR: {ex.Message}"); 
        }
    }

    private async Task UndoReimbursement()
    {
        var targets = allReceipts.Where(r => selectedIds.Contains(r.Id) && r.DisbursementId != null).ToList();
        if (!targets.Any() || !await JS.InvokeAsync<bool>("confirm", $"Unlink {targets.Count} items from their distributions?")) 
        {
            return;
        }

        isLoading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var dbTargets = await db.HsaReceipts.Where(r => targets.Select(t => t.Id).Contains(r.Id)).ToListAsync();
            foreach (var r in dbTargets) 
            { 
                r.DisbursementId = null; 
            }
            await db.SaveChangesAsync();
            selectedIds.Clear();
            await LoadData();
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"UNDO_ERR: {ex.Message}"); 
        }
        finally 
        { 
            isLoading = false; 
        }
    }

    private void OpenAddModal() 
    { 
        editingId = 0; 
        tempReceipt = new HsaReceipt { ServiceDate = DateTime.Today, Provider = "", Type = "Medical", Note = "" }; 
        showModal = true; 
    }

    private void OpenEditModal(HsaReceipt r) 
    {
        editingId = r.Id;
        tempReceipt = new HsaReceipt 
        { 
            Id = r.Id, 
            UserId = r.UserId, 
            Patient = r.Patient, 
            Provider = r.Provider ?? "", 
            Amount = r.Amount, 
            Type = r.Type ?? "Medical", 
            ServiceDate = r.ServiceDate, 
            Note = r.Note ?? "", 
            DisbursementId = r.DisbursementId, 
            TaxYear = r.TaxYear, 
            FileData = r.FileData, 
            ContentType = r.ContentType, 
            FileName = r.FileName 
        };
        showModal = true; 
    }

    private void CloseModal() { showModal = false; }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            using var stream = e.File.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            tempReceipt.FileData = ms.ToArray();
            tempReceipt.FileName = e.File.Name;
            tempReceipt.ContentType = e.File.ContentType;
            StateHasChanged();
        }
        catch 
        { 
            await JS.InvokeVoidAsync("alert", "Upload failed."); 
        }
    }

    private async Task ViewFile(HsaReceipt r) 
    { 
        if (r.FileData != null) 
        {
            await JS.InvokeVoidAsync("viewFileBlob", Convert.ToBase64String(r.FileData), r.ContentType); 
        }
    }

    private async Task SaveReceipt()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            tempReceipt.TaxYear = tempReceipt.ServiceDate.Year;
            tempReceipt.UserId = 1;
            if (editingId == 0) 
            {
                db.HsaReceipts.Add(tempReceipt);
            }
            else
            {
                var existing = await db.HsaReceipts.FindAsync(editingId);
                if (existing != null) 
                { 
                    db.Entry(existing).CurrentValues.SetValues(tempReceipt); 
                    existing.FileData = tempReceipt.FileData; 
                    existing.FileName = tempReceipt.FileName; 
                    existing.ContentType = tempReceipt.ContentType; 
                }
            }
            await db.SaveChangesAsync();
            showModal = false;
            await LoadData();
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"SAVE_ERR: {ex.Message}"); 
        }
    }

    private async Task DeleteReceipt(int id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Delete record?")) 
        {
            return;
        }

        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var target = await db.HsaReceipts.FindAsync(id);
            if (target != null) 
            { 
                db.HsaReceipts.Remove(target); 
                await db.SaveChangesAsync(); 
                await LoadData(); 
            }
        }
        catch (Exception ex) 
        { 
            Console.WriteLine($"DEL_ERR: {ex.Message}"); 
        }
    }

    private async Task RunDisbursementMigration()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "This will create the Distributions table and update schema. Continue?")) 
        {
            return;
        }

        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            await db.Database.ExecuteSqlRawAsync(@"CREATE TABLE IF NOT EXISTS ""HsaDisbursements"" (""Id"" SERIAL PRIMARY KEY, ""CreatedAt"" TIMESTAMP NOT NULL, ""TransactionKey"" TEXT, ""Description"" TEXT, ""TotalAmount"" DECIMAL(18,2) NOT NULL);");
            await db.Database.ExecuteSqlRawAsync(@"ALTER TABLE ""HsaReceipts"" ADD COLUMN IF NOT EXISTS ""DisbursementId"" INTEGER;");
            await LoadData();
            await JS.InvokeVoidAsync("alert", "Schema Updated.");
        }
        catch (Exception ex) 
        { 
            await JS.InvokeVoidAsync("alert", $"Err: {ex.Message}"); 
        }
    }
}