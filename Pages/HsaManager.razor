@page "/hsa"
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS

<div class="min-h-screen bg-[#0a0a0a] text-white font-sans overflow-x-hidden">
    @* 1. MAIN HEADER (Frozen via component) *@
    <BulletHeader ShowControls="false" CustomDateText="HSA Archive" />

    @* 2. STICKY SUB-HEADER *@
    <div class="sticky top-[73px] z-30 bg-[#0c0c0c]/90 backdrop-blur-md border-b border-gray-800 p-4 shadow-2xl">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            @* Year Filters *@
            <div class="flex items-center gap-2 bg-black/50 p-1 rounded-xl border border-gray-800">
                <button type="button" @onclick="() => FilterByYear(0)"
                        class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition @(selectedYear == 0 ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                    All Years
                </button>
                @foreach (var year in availableYears)
                {
                    <button type="button" @onclick="() => FilterByYear(year)"
                            class="px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition @(selectedYear == year ? "bg-blue-600 text-white shadow-lg" : "text-gray-500 hover:text-gray-300")">
                        @year
                    </button>
                }
            </div>

            @* Action Button *@
            <button type="button" @onclick="OpenAddModal" 
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-[0.2em] transition shadow-lg active:scale-95 flex items-center gap-2">
                <span>‚ûï</span> Add Receipt
            </button>
        </div>
    </div>

    @* 3. DATA DISPLAY GRID *@
    <div class="max-w-7xl mx-auto p-6">
        @if (isLoading)
        {
            <div class="flex flex-col items-center justify-center py-20 opacity-30">
                <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-[10px] font-black uppercase tracking-widest">Querying Records...</div>
            </div>
        }
        else if (!filteredReceipts.Any())
        {
            <div class="text-center py-32 bg-gray-900/20 border-2 border-dashed border-gray-800 rounded-3xl">
                <div class="text-gray-600 font-bold uppercase tracking-widest text-xs">No data found for this period.</div>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                @foreach (var r in filteredReceipts)
                {
                    <div class="group relative bg-[#111] border border-gray-800 rounded-2xl p-5 hover:border-blue-500/50 transition-all duration-300 shadow-xl flex flex-col h-full">
                        @* Hover Actions *@
                        <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <button @onclick="() => OpenEditModal(r)" class="bg-blue-600 p-2 rounded-lg text-xs hover:bg-blue-500 shadow-lg">‚úèÔ∏è</button>
                            <button @onclick="() => DeleteReceipt(r.Id)" class="bg-red-600 p-2 rounded-lg text-xs hover:bg-red-500 shadow-lg">‚úï</button>
                        </div>

                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-gray-800/50 px-3 py-1 rounded-lg text-[9px] font-black text-blue-400 uppercase tracking-widest border border-gray-700">
                                @(string.IsNullOrEmpty(r.Type) ? "MEDICAL" : r.Type.ToUpper())
                            </div>
                            <div class="text-[10px] font-mono text-gray-500">
                                @r.ServiceDate.ToString("yyyy-MM-dd")
                            </div>
                        </div>

                        <h3 class="text-white font-black uppercase tracking-tight text-lg mb-1 leading-tight truncate">
                            @(string.IsNullOrEmpty(r.Provider) ? "UNKNOWN PROVIDER" : r.Provider)
                        </h3>
                        <div class="text-2xl font-black text-emerald-400 mb-4">$@r.Amount.ToString("N2")</div>

                        @if (!string.IsNullOrWhiteSpace(r.Note))
                        {
                            <p class="text-xs text-gray-500 italic mb-4 line-clamp-2">@r.Note</p>
                        }

                        <div class="mt-auto pt-4 border-t border-gray-800 flex justify-between items-center">
                            <span class="text-[9px] font-black uppercase tracking-widest @(r.IsReimbursed ? "text-emerald-500" : "text-amber-500")">
                                @(r.IsReimbursed ? "‚úÖ Reimbursed" : "‚è≥ Pending")
                            </span>
                            @if (!string.IsNullOrEmpty(r.FileName)) { <span class="text-xl">üìÑ</span> }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@* MODAL (Code unchanged but z-index updated) *@
@if (showModal)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-700 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden p-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-lg font-black uppercase tracking-widest text-white">@(editingId == 0 ? "New Receipt" : "Edit Receipt")</h2>
                <button @onclick="CloseModal" class="text-gray-500 hover:text-white text-2xl font-bold px-2">‚úï</button>
            </div>

            <EditForm Model="tempReceipt" OnValidSubmit="SaveReceipt" class="space-y-5 text-left">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Provider</label>
                    <InputText @bind-Value="tempReceipt.Provider" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Amount ($)</label>
                        <InputNumber @bind-Value="tempReceipt.Amount" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Category</label>
                        <InputSelect @bind-Value="tempReceipt.Type" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none">
                            <option value="Medical">Medical</option>
                            <option value="Dental">Dental</option>
                            <option value="Eye Care">Eye Care</option>
                            <option value="Chiropractor">Chiropractor</option>
                            <option value="Other">Other</option>
                        </InputSelect>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Date</label>
                        <InputDate @bind-Value="tempReceipt.ServiceDate" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-blue-500 outline-none" />
                    </div>
                    <div class="flex items-center gap-3 pt-6 pl-2">
                        <InputCheckbox @bind-Value="tempReceipt.IsReimbursed" id="reimbursed" class="w-5 h-5 accent-blue-600 rounded bg-gray-900 border-gray-700" />
                        <label for="reimbursed" class="text-[10px] font-black text-gray-400 uppercase cursor-pointer">Reimbursed</label>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase mb-1 ml-1 tracking-widest">Notes</label>
                    <InputTextArea @bind-Value="tempReceipt.Note" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white text-sm h-24 focus:border-blue-500 outline-none" />
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" @onclick="CloseModal" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest transition">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<HsaReceipt> allReceipts = new();
    private List<HsaReceipt> filteredReceipts = new();
    private List<int> availableYears = new();
    private int selectedYear = 0;
    private bool isLoading = true;

    private bool showModal = false;
    private int editingId = 0;
    private HsaReceipt tempReceipt = new();
    private List<string> logs = new(); // Left for tracing

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) { await LoadData(); }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            allReceipts = await db.HsaReceipts.OrderBy(x => x.ServiceDate).ToListAsync();
            
            // Extract distinct years for the subheader buttons
            availableYears = allReceipts
                .Select(x => x.ServiceDate.Year)
                .Distinct()
                .OrderByDescending(x => x)
                .ToList();

            ApplyFilter();
        }
        catch (Exception ex) { Console.WriteLine($"LOAD_ERR: {ex.Message}"); }
        finally { isLoading = false; await InvokeAsync(StateHasChanged); }
    }

    private void ApplyFilter()
    {
        if (selectedYear == 0) filteredReceipts = allReceipts;
        else filteredReceipts = allReceipts.Where(x => x.ServiceDate.Year == selectedYear).ToList();
    }

    private void FilterByYear(int year) 
    { 
        selectedYear = year; 
        ApplyFilter(); 
    }

    private void OpenAddModal()
    {
        editingId = 0;
        tempReceipt = new HsaReceipt { ServiceDate = DateTime.Today, Provider = "", Type = "Medical", Note = "" };
        showModal = true;
    }

    private void OpenEditModal(HsaReceipt r)
    {
        editingId = r.Id;
        tempReceipt = new HsaReceipt {
            Id = r.Id, UserId = r.UserId, Provider = r.Provider ?? "", Amount = r.Amount,
            Type = r.Type ?? "Medical", ServiceDate = r.ServiceDate, Note = r.Note ?? "", 
            IsReimbursed = r.IsReimbursed, FileName = r.FileName ?? ""
        };
        showModal = true;
    }

    private void CloseModal() { showModal = false; }

    private async Task SaveReceipt()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            tempReceipt.TaxYear = tempReceipt.ServiceDate.Year;
            tempReceipt.UserId = 1;

            if (editingId == 0) db.HsaReceipts.Add(tempReceipt);
            else db.HsaReceipts.Update(tempReceipt);

            await db.SaveChangesAsync();
            showModal = false;
            await LoadData();
        }
        catch (Exception ex) { Console.WriteLine($"SAVE_ERR: {ex.Message}"); }
    }

    private async Task DeleteReceipt(int id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Delete this record permanently?")) return;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var target = await db.HsaReceipts.FindAsync(id);
            if (target != null) { db.HsaReceipts.Remove(target); await db.SaveChangesAsync(); await LoadData(); }
        }
        catch (Exception ex) { Console.WriteLine($"DEL_ERR: {ex.Message}"); }
    }

    private void AddLog(string msg) { Console.WriteLine($"HSA_TRACE: {msg}"); }
}