@page "/hsa"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@* We keep these in the file but don't touch them until a button is pressed *@
@using Dashboard
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory

<div style="background:#000; color:#0f0; min-height:100vh; padding:40px; font-family:monospace; line-height:1.5;">
    
    <h1 style="color:#fff; border-bottom:1px solid #333; pb-4 mb-8">DEBUG TERMINAL v1.0</h1>

    <div style="display:flex; gap:10px; margin-bottom:20px;">
        @* BUTTON 1: THE "DAMN LOG" TEST *@
        <button @onclick="SimpleLog" style="background:#444; color:#fff; padding:10px 20px; cursor:pointer; border:1px solid #666;">
            TEST LOG
        </button>

        @* BUTTON 2: THE DB TEST *@
        <button @onclick="RunDbAction" style="background:#005cc5; color:#fff; padding:10px 20px; cursor:pointer; border:none;">
            INITIALIZE HSA TABLE
        </button>
    </div>

    <div style="background:#111; border:1px solid #333; padding:20px; height:600px; overflow-y:auto;">
        <div style="color:#666; margin-bottom:10px;">> STANDBY_</div>
        @foreach (var log in logs)
        {
            <div style="margin-bottom:4px;">
                <span style="color:#555;">[@log.Split('|')[0]]</span> @log.Split('|')[1]
            </div>
        }
    </div>
</div>

@code {
    private List<string> logs = new();

    protected override void OnInitialized()
    {
        // This MUST show up immediately when the page loads
        AddLog("CORE: Page component initialized.");
    }

    private void SimpleLog()
    {
        // If this doesn't show up, the WebSocket is dead
        AddLog("UI_EVENT: Log button clicked.");
    }

    private async Task RunDbAction()
    {
        AddLog("DB_ACTION: Attempting to connect to Postgres...");
        
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            AddLog("DB_CONNECT: Context factory created.");

            var sql = @"
                CREATE TABLE IF NOT EXISTS ""HsaReceipts"" (
                    ""Id"" SERIAL PRIMARY KEY,
                    ""UserId"" INTEGER NOT NULL,
                    ""Type"" TEXT NOT NULL,
                    ""Provider"" TEXT NOT NULL,
                    ""ServiceDate"" TIMESTAMP NOT NULL,
                    ""Amount"" DECIMAL(18,2) NOT NULL,
                    ""Note"" TEXT,
                    ""FileName"" TEXT,
                    ""ContentType"" TEXT,
                    ""FileData"" BYTEA,
                    ""IsReimbursed"" BOOLEAN NOT NULL DEFAULT FALSE,
                    ""ReimbursedAt"" TIMESTAMP,
                    ""TaxYear"" INTEGER NOT NULL,
                    ""CreatedAt"" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
                );";

            AddLog("DB_SQL: Sending CREATE TABLE command...");
            await db.Database.ExecuteSqlRawAsync(sql);
            AddLog("DB_SUCCESS: Table verified/created.");
        }
        catch (Exception ex)
        {
            AddLog("DB_CRITICAL: " + ex.Message);
            if (ex.InnerException != null) AddLog("INNER: " + ex.InnerException.Message);
        }
    }

    private void AddLog(string msg)
    {
        var time = DateTime.Now.ToString("HH:mm:ss");
        logs.Insert(0, $"{time}|{msg}");
        Console.WriteLine($"HSA_DEBUG_CONSOLE: {msg}");
        StateHasChanged();
    }
}