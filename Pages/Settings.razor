@page "/settings"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using System.Text.Json
@inject AppDbContext Db
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white p-8">
    
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-10 border-b border-gray-800 pb-4">
            <h1 class="text-3xl font-bold">Settings</h1>
            <a href="/" class="text-gray-400 hover:text-white flex items-center gap-2 transition">
                <span>‚Üê</span> Back to Dashboard
            </a>
        </div>

        @if (isDbError)
        {
            <div class="bg-red-900/20 border border-red-500 rounded-xl p-8 text-center">
                <div class="text-red-500 text-5xl mb-4">üõ†Ô∏è</div>
                <h3 class="text-xl font-bold text-white mb-2">Settings Database Missing</h3>
                <p class="text-gray-400 mb-6">The "Feeds" table does not exist yet. Click below to initialize it.</p>
                <button @onclick="SeedFeeds" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition">
                    Initialize Database
                </button>
            </div>
        }
        else
        {
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl mb-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                            <span>üì∞</span> News Feeds
                        </h2>
                        <div class="text-xs text-gray-500 mt-1">Manage RSS feeds displayed on your dashboard</div>
                    </div>
                    <button @onclick="SeedFeeds" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white transition border border-gray-600">
                        Reset / Seed Defaults
                    </button>
                </div>

                @if (Feeds.Any())
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        @foreach (var group in Feeds.GroupBy(f => f.Category))
                        {
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-800">
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">@group.Key</h3>
                                <div class="space-y-3">
                                    @foreach (var feed in group)
                                    {
                                        <div class="flex items-center justify-between p-3 rounded-lg border transition @(feed.IsEnabled ? "bg-blue-900/20 border-blue-500/50" : "bg-gray-800 border-gray-700")">
                                            <div class="overflow-hidden mr-3">
                                                <div class="font-bold text-sm @(feed.IsEnabled ? "text-white" : "text-gray-400") truncate">@feed.Name</div>
                                                <div class="text-[10px] text-gray-600 truncate" title="@feed.Url">@feed.Url</div>
                                            </div>
                                            
                                            <button @onclick="() => Toggle(feed)" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none flex-shrink-0 @(feed.IsEnabled ? "bg-blue-600" : "bg-gray-600")">
                                                <span class="sr-only">Enable</span>
                                                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition duration-200 ease-in-out @(feed.IsEnabled ? "translate-x-6" : "translate-x-1")"></span>
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-gray-500 py-12 bg-gray-900/30 rounded-lg border-2 border-dashed border-gray-800">
                        <p class="mb-2">No feeds found for your account.</p>
                        <button @onclick="SeedFeeds" class="text-blue-400 hover:text-white underline text-sm">Click here to load defaults</button>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Feed> Feeds = new();
    private User? currentUser;
    private bool isDbError = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json))
            {
                try {
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    var session = JsonSerializer.Deserialize<SessionData>(json, options);
                    if(session != null) currentUser = await Db.Users.FindAsync(session.UserId);
                } catch {}
            }

            if (currentUser != null) 
            {
                await LoadFeeds();
            }
            else
            {
                Nav.NavigateTo("/login", true);
            }
        }
    }

    private async Task LoadFeeds()
    {
        if (currentUser == null) return;
        try 
        {
            Feeds = await Db.Feeds.Where(f => f.UserId == currentUser.Id).OrderBy(f => f.Category).ToListAsync();
            isDbError = false;
        }
        catch 
        {
            // If table doesn't exist, we catch the error to prevent crash
            isDbError = true;
        }
        StateHasChanged();
    }

    private async Task Toggle(Feed feed)
    {
        feed.IsEnabled = !feed.IsEnabled;
        Db.Feeds.Update(feed);
        await Db.SaveChangesAsync();
    }

    private async Task SeedFeeds()
    {
        if (currentUser == null) return;

        try {
            // FORCE CREATE TABLE
            await Db.Database.ExecuteSqlRawAsync(@"
                CREATE TABLE IF NOT EXISTS ""Feeds"" (
                    ""Id"" serial PRIMARY KEY, 
                    ""UserId"" integer, 
                    ""Name"" text, 
                    ""Url"" text, 
                    ""Category"" text, 
                    ""IsEnabled"" boolean DEFAULT FALSE
                );
            ");
            
            // Add Missing Columns if table existed but was old
            try { await Db.Database.ExecuteSqlRawAsync(@"ALTER TABLE ""Feeds"" ADD COLUMN IF NOT EXISTS ""UserId"" integer;"); } catch {}

        } catch (Exception ex) {
            await JS.InvokeVoidAsync("alert", "DB Init Error: " + ex.Message);
            return;
        }

        var suggestions = new List<Feed>
        {            
            new Feed { Name = "Dallas Cowboys News", Url = "https://www.dallascowboys.com/rss/news", Category = "Sports" },
            new Feed { Name = "Texas Rangers News", Url = "https://www.mlb.com/rangers/feeds/news/rss.xml", Category = "Sports" },
            new Feed { Name = "Tesla Stock News", Url = "https://news.google.com/rss/search?q=Tesla+Stock", Category = "Finance" },
            new Feed { Name = "Shirt.Woot Derby", Url = "hhttps://shirt.woot.com/derby/rss", Category = "Shopping" },
            new Feed { Name = "NPR National News", Url = "http://www.npr.org/rss/rss.php?id=1003", Category = "News" },
            new Feed { Name = "Time", Url = "http://time.com/newsfeed/feed/", Category = "News" },
            new Feed { Name = "ESPN", Url = "http://sports.espn.go.com/espn/rss/news", Category = "Sports" },
            new Feed { Name = "CBS News - Entertainment", Url = "hhttp://www.cbsnews.com/latest/rss/entertainment", Category = "Entertainment" }
        };

        bool added = false;
        foreach (var s in suggestions)
        {
            // Check if this user already has this feed URL (using Db context safe check now that table exists)
            try 
            {
                if (!await Db.Feeds.AnyAsync(f => f.UserId == currentUser.Id && f.Url == s.Url))
                {
                    s.UserId = currentUser.Id;
                    s.IsEnabled = false;
                    Db.Feeds.Add(s);
                    added = true;
                }
            }
            catch {}
        }

        if (added) await Db.SaveChangesAsync();
        
        await LoadFeeds(); // Reload UI
    }

    public class SessionData { public int UserId { get; set; } }
}