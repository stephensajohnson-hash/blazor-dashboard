@page "/settings"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using System.Text.Json
@inject AppDbContext Db
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white p-8">
    
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-10 border-b border-gray-800 pb-4">
            <h1 class="text-3xl font-bold">Settings</h1>
            <a href="/" class="text-gray-400 hover:text-white flex items-center gap-2 transition">
                <span>‚Üê</span> Back to Dashboard
            </a>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl mb-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                        <span>üì∞</span> News Feeds
                    </h2>
                    <div class="text-xs text-gray-500 mt-1">Manage RSS feeds displayed on your dashboard</div>
                </div>
                <div class="flex gap-3">
                    <button @onclick="OpenAddModal" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-white transition font-bold shadow-lg">
                        + Add Feed
                    </button>
                    <button @onclick="SeedFeeds" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-white transition border border-gray-600">
                        Reset Defaults
                    </button>
                </div>
            </div>

            @if (Feeds.Any())
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    @foreach (var group in Feeds.GroupBy(f => f.Category).OrderBy(g => g.Key == "System" ? 0 : 1).ThenBy(g => g.Key))
                    {
                        <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-800">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                @if(group.Key == "System") { <span>‚öôÔ∏è</span> } 
                                @group.Key
                            </h3>
                            <div class="space-y-3">
                                @foreach (var feed in group)
                                {
                                    <div class="flex items-center justify-between p-3 rounded-lg border transition group @(feed.IsEnabled ? "bg-blue-900/20 border-blue-500/50" : "bg-gray-800 border-gray-700")">
                                        <div class="overflow-hidden mr-3 flex-1">
                                            <div class="font-bold text-sm @(feed.IsEnabled ? "text-white" : "text-gray-400") truncate">
                                                @feed.Name
                                            </div>
                                            <div class="text-[10px] text-gray-600 truncate" title="@feed.Url">@feed.Url</div>
                                        </div>
                                        
                                        <div class="flex items-center gap-2">
                                            @if (feed.Category != "System")
                                            {
                                                <div class="hidden group-hover:flex items-center gap-1 mr-2 transition">
                                                    <button @onclick="() => OpenEditModal(feed)" class="text-gray-500 hover:text-white p-1" title="Edit">‚úèÔ∏è</button>
                                                    <button @onclick="() => DeleteFeed(feed)" class="text-gray-500 hover:text-red-500 p-1" title="Delete">üóëÔ∏è</button>
                                                </div>
                                            }

                                            <button @onclick="() => Toggle(feed)" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none flex-shrink-0 @(feed.IsEnabled ? "bg-blue-600" : "bg-gray-600")">
                                                <span class="sr-only">Enable</span>
                                                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition duration-200 ease-in-out @(feed.IsEnabled ? "translate-x-6" : "translate-x-1")"></span>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-12 bg-gray-900/30 rounded-lg border-2 border-dashed border-gray-800">
                    <p class="mb-2">No feeds found for your account.</p>
                    <button @onclick="SeedFeeds" class="text-blue-400 hover:text-white underline text-sm">Click here to load defaults</button>
                </div>
            }
        </div>
    </div>
</div>

@if (editingFeed != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold text-white mb-6">@(editingFeed.Id == 0 ? "Add New Feed" : "Edit Feed")</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
                    <input @bind="editingFeed.Name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="e.g. Hacker News" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">RSS URL</label>
                    <input @bind="editingFeed.Url" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="https://..." />
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                    <input @bind="editingFeed.Category" list="feed-categories-list" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" placeholder="Select or type new..." />
                    <datalist id="feed-categories-list">
                        @foreach (var cat in CategoryOptions)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </datalist>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button @onclick="() => editingFeed = null" class="px-4 py-2 text-gray-400 hover:text-white text-xs font-bold uppercase">Cancel</button>
                <button @onclick="SaveFeed" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold uppercase shadow-lg">Save</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Feed> Feeds = new();
    private User? currentUser;
    private Feed? editingFeed = null;
    private bool isDbError = false;
    // Initialized immediately so it's never empty
    private List<string> CategoryOptions = new() { "Tech", "Sports", "Finance", "Shopping", "News", "Gaming", "Coding", "Lifestyle", "General" };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
            if (!string.IsNullOrEmpty(json))
            {
                try {
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    var session = JsonSerializer.Deserialize<SessionData>(json, options);
                    if(session != null) currentUser = await Db.Users.FindAsync(session.UserId);
                } catch {}
            }

            if (currentUser != null) 
            {
                await LoadFeeds();
            }
            else
            {
                Nav.NavigateTo("/login", true);
            }
        }
    }

    private async Task LoadFeeds()
    {
        if (currentUser == null) return;
        try 
        {
            Feeds = await Db.Feeds.Where(f => f.UserId == currentUser.Id).OrderBy(f => f.Category).ToListAsync();
            isDbError = false;
            UpdateCategories();
        }
        catch 
        {
            isDbError = true;
        }
        StateHasChanged();
    }
    
    private void UpdateCategories()
    {
        if (Feeds == null || !Feeds.Any()) return;
        var dbCats = Feeds.Select(f => f.Category).Where(c => !string.IsNullOrEmpty(c)).Distinct();
        var defaults = new List<string> { "Tech", "Sports", "Finance", "Shopping", "News", "Gaming", "Coding", "Lifestyle", "General" };
        // Merge and sort
        CategoryOptions = dbCats.Union(defaults).Where(c => c != "System").OrderBy(c => c).ToList();
    }

    private async Task Toggle(Feed feed)
    {
        feed.IsEnabled = !feed.IsEnabled;
        Db.Feeds.Update(feed);
        await Db.SaveChangesAsync();
    }

    // --- CRUD OPERATIONS ---

    private void OpenAddModal()
    {
        if (currentUser == null) return;
        UpdateCategories();
        editingFeed = new Feed { UserId = currentUser.Id, Category = "General", IsEnabled = true };
    }

    private void OpenEditModal(Feed f)
    {
        UpdateCategories();
        editingFeed = new Feed { Id = f.Id, UserId = f.UserId, Name = f.Name, Url = f.Url, Category = f.Category, IsEnabled = f.IsEnabled };
    }

    private async Task SaveFeed()
    {
        if (editingFeed == null) return;

        if (string.IsNullOrWhiteSpace(editingFeed.Name) || string.IsNullOrWhiteSpace(editingFeed.Url))
        {
            await JS.InvokeVoidAsync("alert", "Name and URL are required.");
            return;
        }

        if (editingFeed.Id == 0)
        {
            Db.Feeds.Add(editingFeed);
        }
        else
        {
            var existing = await Db.Feeds.FindAsync(editingFeed.Id);
            if (existing != null)
            {
                existing.Name = editingFeed.Name;
                existing.Url = editingFeed.Url;
                existing.Category = editingFeed.Category;
            }
        }

        await Db.SaveChangesAsync();
        editingFeed = null;
        await LoadFeeds();
    }

    private async Task DeleteFeed(Feed f)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"Delete '{f.Name}'?"))
        {
            Db.Feeds.Remove(f);
            await Db.SaveChangesAsync();
            await LoadFeeds();
        }
    }

    private async Task SeedFeeds()
    {
        if (currentUser == null) return;

        try {
            await Db.Database.ExecuteSqlRawAsync(@"CREATE TABLE IF NOT EXISTS ""Feeds"" (""Id"" serial PRIMARY KEY, ""UserId"" integer, ""Name"" text, ""Url"" text, ""Category"" text, ""IsEnabled"" boolean DEFAULT FALSE);");
            try { await Db.Database.ExecuteSqlRawAsync(@"ALTER TABLE ""Feeds"" ADD COLUMN IF NOT EXISTS ""UserId"" integer;"); } catch {}
        } catch (Exception ex) {
            await JS.InvokeVoidAsync("alert", "DB Init Error: " + ex.Message);
            return;
        }

        // 1. Force Upsert Derby Feed (System)
        var derbyUrl = "https://shirt.woot.com/derby/rss";
        var existingDerby = await Db.Feeds.FirstOrDefaultAsync(f => f.UserId == currentUser.Id && f.Url == derbyUrl);
        if (existingDerby != null)
        {
            existingDerby.Category = "System"; 
            existingDerby.Name = "Shirt.Woot Derby";
        }
        else
        {
            Db.Feeds.Add(new Feed { UserId = currentUser.Id, Name = "Shirt.Woot Derby", Url = derbyUrl, Category = "System", IsEnabled = true });
        }

        // 2. Add Other Suggestions if missing
        var suggestions = new List<Feed>
        {
            new Feed { Name = "Hacker News", Url = "https://news.ycombinator.com/rss", Category = "Tech" },
            new Feed { Name = "Visual Studio Blog", Url = "https://devblogs.microsoft.com/visualstudio/feed/", Category = "Tech" },
            new Feed { Name = "Dallas Cowboys", Url = "https://www.dallascowboys.com/rss/news", Category = "Sports" },
            new Feed { Name = "Texas Rangers", Url = "https://www.mlb.com/rangers/feeds/news/rss.xml", Category = "Sports" },
            new Feed { Name = "Tesla Stock News", Url = "https://news.google.com/rss/search?q=Tesla+Stock", Category = "Finance" },
            new Feed { Name = "Woot Daily Deals", Url = "https://www.woot.com/blog/feed", Category = "Shopping" }
        };

        bool added = false;
        foreach (var s in suggestions)
        {
            if (!await Db.Feeds.AnyAsync(f => f.UserId == currentUser.Id && f.Url == s.Url))
            {
                s.UserId = currentUser.Id;
                s.IsEnabled = false;
                Db.Feeds.Add(s);
                added = true;
            }
        }

        if (added) await Db.SaveChangesAsync();
        await LoadFeeds();
        
        if (added) await JS.InvokeVoidAsync("alert", "Default feeds added!");
        else await JS.InvokeVoidAsync("alert", "Defaults already exist.");
    }

    public class SessionData { public int UserId { get; set; } }
}