@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Globalization
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 relative font-sans">
   
    <BulletHeader 
        ShowControls="true"
        CustomDateText="@GetHeaderDate()"
        ActiveView="@currentView"
        OnPrev="Prev"
        OnNext="Next"
        OnGoToday="GoToday"
        OnViewChanged="SwitchView">
        
        <div class="flex items-center gap-2 ml-4">
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input @bind="searchQuery" 
                       @bind:event="oninput" 
                       @onkeyup="HandleKeyUp"
                       placeholder="Quick search..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
                
                @if(!string.IsNullOrWhiteSpace(searchQuery) || isSearching)
                {
                    <button @onclick="ClearSearch" class="text-gray-500 hover:text-red-400 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                }
                
                <button @onclick="() => showAdvancedSearch = true" 
                        class="ml-1 p-1 text-gray-500 hover:text-blue-400 border-l border-gray-700" 
                        title="Advanced Filters">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                </button>
            </div>

            <div class="h-6 w-px bg-gray-800 mx-2"></div>

            <button @onclick="PrevYear" class="group flex items-center justify-center w-8 h-8 bg-black/40 hover:bg-blue-900/40 border border-gray-800 hover:border-blue-500/50 rounded-lg transition-all shadow-lg" title="Previous Year">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                </svg>
            </button>

            <div class="text-[9px] font-black text-gray-600 uppercase tracking-widest px-1">Year</div>

            <button @onclick="NextYear" class="group flex items-center justify-center w-8 h-8 bg-black/40 hover:bg-blue-900/40 border border-gray-800 hover:border-blue-500/50 rounded-lg transition-all shadow-lg" title="Next Year">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </BulletHeader>

    <div class="px-6 h-[calc(100vh-140px)] overflow-hidden">
        @if (isSearching)
        {
            <div class="h-full flex flex-col font-black">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-sm font-black uppercase tracking-[0.2em] text-blue-400 mb-2">
                            Search Results: <span class="text-white">@searchResults.Count</span> items
                        </h2>
                        <div class="flex flex-wrap gap-2">
                            @foreach (var typeGroup in searchResults.GroupBy(x => x.Type).OrderBy(g => GetTypePriority(g.Key)))
                            {
                                <div class="px-2 py-0.5 bg-gray-800 border border-gray-700 rounded text-[9px] font-black uppercase tracking-tighter text-gray-400">
                                    <span class="text-blue-400">@typeGroup.Count()</span> @typeGroup.Key@(typeGroup.Count() > 1 ? "s" : "")
                                </div>
                            }
                        </div>
                    </div>
                    <button @onclick="ClearSearch" class="text-[10px] font-bold text-gray-400 hover:text-red-400 transition-colors uppercase tracking-[0.2em] flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                        Close Search
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto pr-2 scrollbar-hide">
                    @if (!searchResults.Any())
                    {
                        <div class="h-64 flex flex-col items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 italic">
                            <p>No items found matching your criteria.</p>
                        </div>
                    }
                    else
                    {
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                            @foreach (var item in searchResults)
                            {
                                <div class="relative group">
                                    <div class="absolute -top-2 -right-1 z-10 bg-blue-600 text-[9px] font-black px-2 py-0.5 rounded shadow-xl uppercase tracking-tighter">
                                        @item.Date.ToString("MMM dd, yyyy")
                                    </div>
                                    
                                    <div class="h-full border border-gray-800 rounded-xl overflow-hidden hover:border-blue-500/50 transition-all bg-gray-800/20 shadow-lg">
                                        @if (item.Type == "meeting") { <MeetingCard Item="item" OnClick="OpenEdit" OnToggle="ToggleMeetingComplete" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "habit") { <HabitCard Item="@(GetHabit(item.Id))" OnClick="OpenHabitEdit" OnDelete="DeleteTask" OnChange="SaveHabitDirectly" /> }
                                        else if (item.Type == "media") { <MediaCard Item="item" OnClick="OpenMediaEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "holiday") { <HolidayCard Item="item" OnClick="OpenHolidayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "birthday") { <BirthdayCard Item="item" OnClick="OpenBirthdayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "anniversary") { <AnniversaryCard Item="item" OnClick="OpenAnniversaryEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "vacation") { <VacationCard Item="item" OnClick="OpenVacationEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="OpenHealthEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "sports") { <SportsCard Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnDelete="DeleteTask" /> }
                                        else { <TaskCard Item="item" OnClick="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" /> }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
        else if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 h-full font-black">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden shadow-2xl">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                            <span class="font-bold text-@cat.Item3-400 uppercase tracking-wider text-sm">@cat.Item1</span>
                            <button @onclick='async () => await OpenEditor(cat.Item2, cat.Item2 == "health" ? "health" : "task", viewDate)' 
                                    class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition font-bold uppercase tracking-widest">
                                ï¼‹ Add
                            </button>
                        </div>
                        <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide font-bold">
                            @if(isLoading)
                            {
                                <div class="text-center text-gray-500 text-xs italic mt-4 animate-pulse uppercase tracking-widest">Syncing...</div>
                            }
                            else
                            {
                                var colItems = GetSortedItems(GetItemsForColumn(viewDate, cat.Item2));
                                @foreach(var item in colItems) 
                                { 
                                    <div @key="item.Id">
                                        @if (item.Type == "meeting") { <MeetingCard Item="item" OnClick="OpenEdit" OnToggle="ToggleMeetingComplete" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "habit") { <HabitCard Item="@(GetHabit(item.Id))" OnClick="OpenHabitEdit" OnDelete="DeleteTask" OnChange="SaveHabitDirectly" /> }
                                        else if (item.Type == "media") { <MediaCard Item="item" OnClick="OpenMediaEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "holiday") { <HolidayCard Item="item" OnClick="OpenHolidayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "birthday") { <BirthdayCard Item="item" OnClick="OpenBirthdayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "anniversary") { <AnniversaryCard Item="item" OnClick="OpenAnniversaryEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "vacation") { <VacationCard Item="item" OnClick="OpenVacationEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="OpenHealthEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "sports") { <SportsCard Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnDelete="DeleteTask" /> }
                                        else { <TaskCard Item="item" OnClick="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" /> }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 h-full font-sans font-bold">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    <div class="flex flex-col h-full rounded-xl border overflow-hidden bg-gray-800/40 @GetDayBorderClass(d)">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700 transition" @onclick="() => GoToDate(d)">
                            <div class="text-[10px] uppercase font-black text-gray-500">@d.ToString("ddd")</div>
                            <div class="text-lg font-black text-white">@d.Day</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                            @foreach(var item in GetSortedItems(GetItemsForDate(d))) { 
                                @if(item.Type == "meeting") { <MeetingPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "habit") { <HabitPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "media") { <MediaPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "holiday") { <HolidayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "birthday") { <BirthdayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "anniversary") { <AnniversaryPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "vacation") { <VacationPill Item="item" OnClick="OpenVacationEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "health") { <HealthPill Item="item" User="currentUser" OnClick="OpenHealthEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                else if (item.Type == "sports") { <SportsPill Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                else { <TaskPill Task="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col h-full font-sans font-black">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2 font-black uppercase text-[10px] text-gray-500">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"}){ <div>@day</div> }
                </div>
                <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                    @for(int i=0; i<monthEmptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-800 transition cursor-pointer @GetDayBorderClass(currentDay) bg-gray-900/50 shadow-inner" @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-[10px] font-bold text-gray-500 mb-1">@d</div>
                            <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-24">
                                @foreach(var item in GetSortedItems(GetItemsForDate(currentDay))) { 
                                    @if(item.Type == "meeting") { <MeetingPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "habit") { <HabitPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "media") { <MediaPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "holiday") { <HolidayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "birthday") { <BirthdayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "anniversary") { <AnniversaryPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "vacation") { <VacationPill Item="item" OnClick="OpenVacationEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "health") { <HealthPill Item="item" User="currentUser" OnClick="OpenHealthEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                    else if (item.Type == "sports") { <SportsPill Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                    else { <TaskPill Task="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@if (showAdvancedSearch)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 font-black">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center text-blue-400 uppercase tracking-widest text-sm">
                <span>Advanced Search</span>
                <button @onclick="() => showAdvancedSearch = false" class="text-gray-500 hover:text-white">&times;</button>
            </div>
            
            <div class="p-6 space-y-4 font-bold">
                <div>
                    <label class="block text-[10px] text-gray-500 uppercase mb-1">Item Type</label>
                    <select @bind="filterType" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none focus:border-blue-500">
                        <option value="all">All Types</option>
                        <option value="task">Tasks</option>
                        <option value="meeting">Meetings</option>
                        <option value="habit">Habits</option>
                        <option value="media">Media</option>
                        <option value="health">Health</option>
                        <option value="sports">Sports</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-bold">From Date</label>
                        <input type="date" @bind="filterStart" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 uppercase mb-1 font-bold">To Date</label>
                        <input type="date" @bind="filterEnd" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none focus:border-blue-500" />
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-900/50 flex gap-3">
                <button @onclick="ResetFilters" class="flex-1 py-2 rounded-lg border border-gray-700 uppercase text-[10px] font-black hover:bg-gray-800 transition">Reset</button>
                <button @onclick="PerformAdvancedSearch" class="flex-1 py-2 rounded-lg bg-blue-600 uppercase text-[10px] font-black hover:bg-blue-500 transition shadow-lg">Apply Filters</button>
            </div>
        </div>
    </div>
}

<BaseEditor Item="editingItem" 
            TaskDetail="editingItem?.Detail ?? new()" 
            MeetingDetail="editingItem?.MeetingDetail ?? new()" 
            HabitDetail="editingItem?.HabitDetail ?? new()" 
            MediaDetail="editingItem?.MediaDetail ?? new()" 
            HolidayDetail="editingItem?.HolidayDetail ?? new()"
            BirthdayDetail="editingItem?.BirthdayDetail ?? new()"
            AnniversaryDetail="editingItem?.AnniversaryDetail ?? new()"
            VacationDetail="editingItem?.VacationDetail ?? new()"
            HealthDetail="editingItem?.HealthDetail ?? new()"
            SportsDetail="editingItem?.SportsDetail ?? new()"
            Notes="editingItem?.Notes ?? new()"
            Leagues="allLeagues"
            Seasons="allSeasons"
            Teams="allTeams"
            OnSaveRecurring="SaveRecurringSeries" 
            OnCancel="() => editingItem = null" 
            OnDelete="DeleteCurrentTask" />

@code {
    private User? currentUser;
    private int userId = 0;
    private DateTime viewDate = DateTime.UtcNow;
    private string currentView = "day";
    private int clientOffset = 0;
    private bool isLoading = true;
    
    private List<League> allLeagues = new();
    private List<Season> allSeasons = new();
    private List<Team> allTeams = new();

    private List<BulletTaskService.TaskDTO> loadedItems = new();
    private List<BulletHabitService.HabitDTO> loadedHabits = new(); 
    private List<BulletMediaService.MediaDTO> loadedMedia = new(); 
    private List<BulletHolidayService.HolidayDTO> loadedHolidays = new(); 
    private List<BulletBirthdayService.BirthdayDTO> loadedBirthdays = new();
    private List<BulletAnniversaryService.AnniversaryDTO> loadedAnniversaries = new();
    private List<BulletVacationService.VacationDTO> loadedVacations = new(); 
    private List<BulletHealthService.HealthDTO> loadedHealth = new();
    private List<BulletSportsService.GameDTO> loadedGames = new();
    
    private BulletTaskService.TaskDTO? editingItem;
    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => ((int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek + 6) % 7; 

    // Search Logic State
    private string searchQuery = "";
    private bool isSearching = false;
    private bool showAdvancedSearch = false;
    private List<BulletTaskService.TaskDTO> searchResults = new();
    private string filterType = "all";
    private DateTime? filterStart;
    private DateTime? filterEnd;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) 
                { 
                    using(var doc = JsonDocument.Parse(json)) 
                    {
                        if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) 
                            userId = p.GetInt32();
                    }
                    if(userId > 0) 
                    {
                        currentUser = await Db.Users.FindAsync(userId);
                        if(currentUser != null) 
                        {
                            try { clientOffset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()"); } catch {}
                            viewDate = DateTime.UtcNow.AddMinutes(-clientOffset);
                            allLeagues = await Db.Leagues.OrderBy(x => x.Name).ToListAsync();
                            allSeasons = await Db.Seasons.ToListAsync();
                            allTeams = await Db.Teams.ToListAsync();
                            await LoadData();
                        }
                    }
                }
            } 
            catch 
            { 
                isLoading = false; 
                StateHasChanged(); 
            }
        }
    }

    private async Task LoadData()
    {
        if (currentUser == null) return;
        isLoading = true; 
        StateHasChanged();

        DateTime start = DateTime.SpecifyKind(viewDate.Date, DateTimeKind.Utc);
        DateTime end = start.AddDays(1).AddSeconds(-1); 

        if (currentView == "week") 
        { 
            start = DateTime.SpecifyKind(weekStart, DateTimeKind.Utc); 
            end = start.AddDays(7).AddSeconds(-1); 
        }
        else if (currentView == "month") 
        { 
            start = DateTime.SpecifyKind(new DateTime(viewDate.Year, viewDate.Month, 1), DateTimeKind.Utc); 
            end = start.AddMonths(1).AddSeconds(-1); 
        }

        try 
        {
            loadedItems.Clear(); 
            loadedItems.AddRange(await TaskService.GetTasksForRange(userId, start, end) ?? new());
            loadedItems.AddRange(await MeetingService.GetMeetingsForRange(userId, start, end) ?? new());

            loadedHabits = await HabitService.GetHabits(userId) ?? new();
            foreach(var h in loadedHabits.Where(h => h.Date.Date >= start.Date && h.Date.Date <= end.Date)) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "habit", 
                    Category = h.Category, 
                    Date = h.Date, 
                    Title = h.Title, 
                    HabitDetail = h.Detail,
                    ImgUrl = h.ImgUrl,
                    Description = h.Description,
                    Notes = h.Notes,
                    SortOrder = h.SortOrder
                }); 
            }

            loadedMedia = await MediaService.GetMedia(userId) ?? new();
            foreach(var m in loadedMedia.Where(m => m.Date.Date >= start.Date && m.Date.Date <= end.Date)) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = m.Id, 
                    UserId = m.UserId, 
                    Type = "media", 
                    Category = m.Category, 
                    Date = m.Date, 
                    Title = m.Title,
                    ImgUrl = m.ImgUrl,
                    Description = m.Description,
                    MediaDetail = m.Detail,
                    Notes = m.Notes,
                    SortOrder = m.SortOrder
                }); 
            }

            var holidays = await HolidayService.GetHolidaysForRange(userId, start, end) ?? new();
            foreach(var h in holidays) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "holiday", 
                    Date = h.Date, 
                    Title = h.Title,
                    Description = h.Description,
                    ImgUrl = h.ImgUrl,
                    HolidayDetail = h.Detail,
                    SortOrder = h.SortOrder
                }); 
            }

            var birthdays = await BirthdayService.GetBirthdaysForRange(userId, start, end) ?? new();
            foreach(var b in birthdays) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = b.Id, 
                    UserId = b.UserId, 
                    Type = "birthday", 
                    Date = b.Date, 
                    Title = b.Title,
                    Description = b.Description,
                    ImgUrl = b.ImgUrl,
                    BirthdayDetail = b.Detail,
                    SortOrder = b.SortOrder
                }); 
            }

            var anniversaries = await AnniversaryService.GetAnniversariesForRange(userId, start, end) ?? new();
            foreach(var a in anniversaries) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = a.Id, 
                    UserId = a.UserId, 
                    Type = "anniversary", 
                    Date = a.Date, 
                    Title = a.Title,
                    Description = a.Description,
                    ImgUrl = a.ImgUrl,
                    AnniversaryDetail = a.Detail,
                    SortOrder = a.SortOrder
                }); 
            }

            var vacations = await VacationService.GetVacationsForRange(userId, start, end) ?? new();
            foreach(var v in vacations) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = v.Id, 
                    UserId = v.UserId, 
                    Type = "vacation", 
                    Date = v.Date, 
                    Title = v.Title,
                    Description = v.Description,
                    ImgUrl = v.ImgUrl,
                    VacationDetail = v.Detail,
                    SortOrder = v.SortOrder
                }); 
            }

            var healthItems = await HealthService.GetHealthItemsForRange(userId, start, end) ?? new();
            foreach(var h in healthItems) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "health", 
                    Date = h.Date, 
                    Title = h.Title, 
                    HealthDetail = h.Detail, 
                    Meals = h.Meals, 
                    Workouts = h.Workouts,
                    SortOrder = h.SortOrder
                }); 
            }

            loadedGames = await SportsService.GetGamesForRange(userId, start, end) ?? new();
            foreach(var g in loadedGames) 
            { 
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = g.Id, 
                    UserId = g.UserId, 
                    Type = "sports", 
                    Date = g.Date, 
                    Title = g.Title,
                    Description = g.Description,
                    ImgUrl = g.ImgUrl,
                    SportsDetail = g.Detail,
                    SortOrder = g.SortOrder
                }); 
            }

        } 
        catch { }
        isLoading = false; 
        StateHasChanged();
    }

    private async Task HandleKeyUp(KeyboardEventArgs e) 
    { 
        if (e.Key == "Enter") await PerformQuickSearch(); 
    }

    private async Task PerformQuickSearch() 
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) 
        { 
            ClearSearch(); 
            return; 
        }
        isSearching = true; 
        isLoading = true; 
        StateHasChanged();
        searchResults = await BaseService.SearchItems(userId, searchQuery, "all", DateTime.UtcNow.AddYears(-2), DateTime.UtcNow.AddYears(2));
        isLoading = false; 
        StateHasChanged();
    }

    private async Task PerformAdvancedSearch() 
    {
        showAdvancedSearch = false; 
        isSearching = true; 
        isLoading = true; 
        StateHasChanged();
        searchResults = await BaseService.SearchItems(userId, searchQuery, filterType, filterStart ?? DateTime.UtcNow.AddYears(-5), filterEnd ?? DateTime.UtcNow.AddYears(5));
        isLoading = false; 
        StateHasChanged();
    }

    private void ClearSearch() 
    { 
        searchQuery = ""; 
        isSearching = false; 
        searchResults.Clear(); 
        ResetFilters(); 
        _ = LoadData(); 
    }

    private void ResetFilters() 
    { 
        filterType = "all"; 
        filterStart = null; 
        filterEnd = null; 
    }

    private void Prev() 
    { 
        isSearching = false; 
        if(currentView == "day") viewDate = viewDate.AddDays(-1); 
        else if(currentView == "week") viewDate = viewDate.AddDays(-7); 
        else viewDate = viewDate.AddMonths(-1); 
        _ = LoadData(); 
    }

    private void Next() 
    { 
        isSearching = false; 
        if(currentView == "day") viewDate = viewDate.AddDays(1); 
        else if(currentView == "week") viewDate = viewDate.AddDays(7); 
        else viewDate = viewDate.AddMonths(1); 
        _ = LoadData(); 
    }

    private void PrevYear() 
    { 
        isSearching = false; 
        viewDate = viewDate.AddYears(-1); 
        _ = LoadData(); 
    }

    private void NextYear() 
    { 
        isSearching = false; 
        viewDate = viewDate.AddYears(1); 
        _ = LoadData(); 
    }

    private void SwitchView(string view) 
    { 
        isSearching = false; 
        currentView = view; 
        _ = LoadData(); 
    }

    private void GoToday() 
    { 
        isSearching = false; 
        viewDate = DateTime.UtcNow.AddMinutes(-clientOffset); 
        _ = LoadData(); 
    }

    private void GoToDate(DateTime d) 
    { 
        isSearching = false; 
        viewDate = d; 
        SwitchView("day"); 
    }

    private string GetHeaderDate() 
    { 
        if(currentView == "day") return viewDate.ToString("D"); 
        return currentView == "week" ? $"Week of {weekStart:MMM d}" : viewDate.ToString("MMMM yyyy"); 
    }

    private async Task MoveItemUp(int id) => await ReorderItem(id, -1);
    private async Task MoveItemDown(int id) => await ReorderItem(id, 1);
    
    private async Task ReorderItem(int id, int direction) 
    { 
        var item = loadedItems.FirstOrDefault(x => x.Id == id); 
        if (item == null) return; 
        var dayItems = GetSortedItems(GetItemsForDate(item.Date)); 
        int index = dayItems.FindIndex(x => x.Id == id); 
        if (index == -1) return; 
        int newIndex = index + direction; 
        if (newIndex < 0 || newIndex >= dayItems.Count) return; 
        var updates = new Dictionary<int, int>(); 
        for (int i = 0; i < dayItems.Count; i++) 
        { 
            dayItems[i].SortOrder = i + 1; 
            updates[dayItems[i].Id] = i + 1; 
        } 
        int idA = dayItems[index].Id; 
        int idB = dayItems[newIndex].Id; 
        int orderA = updates[idA]; 
        int orderB = updates[idB]; 
        updates[idA] = orderB; 
        updates[idB] = orderA; 
        dayItems[index].SortOrder = orderB; 
        dayItems[newIndex].SortOrder = orderA; 
        await BaseService.UpdateItemOrders(updates); 
        StateHasChanged(); 
    }

    private void OpenEdit(BulletTaskService.TaskDTO t) 
    { 
        editingItem = CreateCopy(t); 
        editingItem.Id = t.Id; 
    }

    private void OpenHabitEdit(BulletHabitService.HabitDTO h) 
    { 
        editingItem = new BulletTaskService.TaskDTO 
        { 
            Id = h.Id, 
            UserId = h.UserId, 
            Type = "habit", 
            Category = h.Category, 
            Date = h.Date, 
            Title = h.Title, 
            Description = h.Description, 
            ImgUrl = h.ImgUrl, 
            Notes = h.Notes, 
            HabitDetail = h.Detail, 
            SortOrder = h.SortOrder 
        }; 
    }

    // Unified Editor Handlers
    private void OpenMediaEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private void OpenHolidayEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private void OpenBirthdayEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private void OpenAnniversaryEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private void OpenHealthEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private async Task OpenSportsEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);
    private async Task OpenVacationEdit(BulletTaskService.TaskDTO t) => OpenEdit(t);

    private async Task DeleteTask(int id) 
    { 
        if(await JS.InvokeAsync<bool>("confirm", "Delete item?")) 
        { 
            await BaseService.DeleteItem(id); 
            await LoadData(); 
            if(isSearching) await PerformQuickSearch(); 
        } 
    }

    private async Task DeleteCurrentTask() 
    { 
        if(editingItem != null && editingItem.Id > 0 && await JS.InvokeAsync<bool>("confirm", "Delete?")) 
        { 
            await BaseService.DeleteItem(editingItem.Id); 
            editingItem = null; 
            await LoadData(); 
            if(isSearching) await PerformQuickSearch(); 
        } 
    }

    private async Task ToggleComplete(BulletTaskService.TaskDTO t) 
    { 
        t.Detail.IsCompleted = !t.Detail.IsCompleted; 
        await TaskService.ToggleComplete(t.Id, t.Detail.IsCompleted); 
    }

    private async Task ToggleMeetingComplete(BulletTaskService.TaskDTO t) 
    { 
        if(t.MeetingDetail != null) 
        { 
            t.MeetingDetail.IsCompleted = !t.MeetingDetail.IsCompleted; 
            await MeetingService.ToggleComplete(t.Id, t.MeetingDetail.IsCompleted); 
        } 
    }

    private async Task SaveHabitDirectly(BulletHabitService.HabitDTO h) 
    { 
        await HabitService.SaveHabit(h); 
    }

    private async Task SaveRecurringSeries(BaseEditor.RecurrenceRequest req)
    {
        if (editingItem == null) return;
        await CommitItemToDatabase(editingItem);

        if (req.Frequency != "none" && req.ThruDate > editingItem.Date)
        {
            DateTime nextDate = editingItem.Date;
            int offsetCount = 1;
            while (true)
            {
                nextDate = req.Frequency switch {
                    "daily" => nextDate.AddDays(1),
                    "weekly" => nextDate.AddDays(7),
                    "biweekly" => nextDate.AddDays(14),
                    "monthly" => nextDate.AddMonths(1),
                    _ => nextDate
                };
                if (nextDate.Date > req.ThruDate.Date) break;

                var clone = CreateCopy(editingItem);
                clone.Id = 0; 
                clone.Date = nextDate;
                if (editingItem.EndDate.HasValue) {
                    var duration = editingItem.EndDate.Value - editingItem.Date;
                    clone.EndDate = nextDate + duration;
                }
                if (editingItem.Type == "habit" && req.IncrementHabitStreak && clone.HabitDetail != null) {
                    clone.HabitDetail.StreakCount += offsetCount;
                }
                await CommitItemToDatabase(clone);
                offsetCount++;
                if (offsetCount > 365) break; 
            }
        }
        editingItem = null; 
        await LoadData();
        if (isSearching) await PerformQuickSearch();
    }

    private async Task CommitItemToDatabase(BulletTaskService.TaskDTO t)
    {
        if (t.Type == "meeting") await MeetingService.SaveMeeting(new BulletMeetingService.MeetingDTO { Id = t.Id, UserId = t.UserId, Type = "meeting", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, MeetingDetail = t.MeetingDetail ?? new(), Notes = t.Notes });
        else if (t.Type == "habit") await HabitService.SaveHabit(new BulletHabitService.HabitDTO { Id = t.Id, UserId = t.UserId, Type = "habit", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.HabitDetail ?? new(), Notes = t.Notes });
        else if (t.Type == "media") await MediaService.SaveMedia(new BulletMediaService.MediaDTO { Id = t.Id, UserId = t.UserId, Type = "media", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.MediaDetail ?? new(), Notes = t.Notes });
        else if (t.Type == "holiday") await HolidayService.SaveHoliday(new BulletHolidayService.HolidayDTO { Id = t.Id, UserId = t.UserId, Type = "holiday", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.HolidayDetail ?? new() });
        else if (t.Type == "birthday") await BirthdayService.SaveBirthday(new BulletBirthdayService.BirthdayDTO { Id = t.Id, UserId = t.UserId, Type = "birthday", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.BirthdayDetail ?? new() });
        else if (t.Type == "anniversary") await AnniversaryService.SaveAnniversary(new BulletAnniversaryService.AnniversaryDTO { Id = t.Id, UserId = t.UserId, Type = "anniversary", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.AnniversaryDetail ?? new() });
        else if (t.Type == "vacation") {
            var start = t.Date.Date; var end = (t.EndDate ?? start).Date;
            for (var dt = start; dt <= end; dt = dt.AddDays(1)) {
                await VacationService.SaveVacation(new BulletVacationService.VacationDTO { Id = 0, UserId = t.UserId, Type = "vacation", Category = t.Category, Date = dt, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.VacationDetail ?? new() });
            }
        }
        else if (t.Type == "health") await HealthService.SaveHealth(new BulletHealthService.HealthDTO { Id = t.Id, UserId = t.UserId, Type = "health", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.HealthDetail ?? new(), Meals = t.Meals, Workouts = t.Workouts });
        else if (t.Type == "sports") await SportsService.SaveGame(new BulletSportsService.GameDTO { Id = t.Id, UserId = t.UserId, Type = "sports", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.SportsDetail ?? new() });
        else await TaskService.SaveTask(t);
    }

    private BulletTaskService.TaskDTO CreateCopy(BulletTaskService.TaskDTO t) 
    {
        var newItem = new BulletTaskService.TaskDTO 
        { 
            Id = 0, 
            UserId = t.UserId, 
            Type = t.Type, 
            Category = t.Category, 
            Date = t.Date, 
            EndDate = t.EndDate, 
            Title = t.Title, 
            Description = t.Description, 
            ImgUrl = t.ImgUrl, 
            LinkUrl = t.LinkUrl, 
            OriginalStringId = t.OriginalStringId, 
            SortOrder = t.SortOrder, 
            Notes = t.Notes?.Select(n => new BulletItemNote { Content = n.Content, ImgUrl = n.ImgUrl, LinkUrl = n.LinkUrl }).ToList() ?? new(), 
            Meals = t.Meals?.ToList() ?? new(), 
            Workouts = t.Workouts?.ToList() ?? new() 
        };
        if (t.Detail != null) newItem.Detail = new BulletTaskDetail { DueDate = t.Detail.DueDate, IsCompleted = t.Detail.IsCompleted, Priority = t.Detail.Priority, Status = t.Detail.Status, TicketNumber = t.Detail.TicketNumber, TicketUrl = t.Detail.TicketUrl };
        if (t.MeetingDetail != null) newItem.MeetingDetail = new BulletMeetingDetail { StartTime = t.MeetingDetail.StartTime, DurationMinutes = t.MeetingDetail.DurationMinutes, ActualDurationMinutes = t.MeetingDetail.ActualDurationMinutes, IsCompleted = t.MeetingDetail.IsCompleted };
        if (t.HabitDetail != null) newItem.HabitDetail = new BulletHabitDetail { StreakCount = t.HabitDetail.StreakCount, IsCompleted = t.HabitDetail.IsCompleted };
        if (t.VacationDetail != null) newItem.VacationDetail = new BulletVacationDetail { VacationGroupId = t.VacationDetail.VacationGroupId };
        if (t.HealthDetail != null) newItem.HealthDetail = new BulletHealthDetail { WeightLbs = t.HealthDetail.WeightLbs, CalculatedTDEE = t.HealthDetail.CalculatedTDEE };
        if (t.MediaDetail != null) newItem.MediaDetail = new BulletMediaDetail { Rating = t.MediaDetail.Rating, ReleaseYear = t.MediaDetail.ReleaseYear, Tags = t.MediaDetail.Tags };
        if (t.HolidayDetail != null) newItem.HolidayDetail = new BulletHolidayDetail { IsWorkHoliday = t.HolidayDetail.IsWorkHoliday };
        if (t.BirthdayDetail != null) newItem.BirthdayDetail = new BulletBirthdayDetail { DOB_Year = t.BirthdayDetail.DOB_Year };
        if (t.AnniversaryDetail != null) newItem.AnniversaryDetail = new BulletAnniversaryDetail { AnniversaryType = t.AnniversaryDetail.AnniversaryType, FirstYear = t.AnniversaryDetail.FirstYear };
        if (t.SportsDetail != null) newItem.SportsDetail = new BulletGameDetail { LeagueId = t.SportsDetail.LeagueId, HomeTeamId = t.SportsDetail.HomeTeamId, AwayTeamId = t.SportsDetail.AwayTeamId, HomeScore = t.SportsDetail.HomeScore, AwayScore = t.SportsDetail.AwayScore, StartTime = t.SportsDetail.StartTime, IsComplete = t.SportsDetail.IsComplete, TvChannel = t.SportsDetail.TvChannel, SeasonId = t.SportsDetail.SeasonId };
        return newItem;
    }

    private async Task OpenEditor(string category, string type, DateTime date) 
    { 
        editingItem = new BulletTaskService.TaskDTO { UserId = userId, Category = category, Type = type, Date = date, Detail = new() }; 
    }
    
    private List<BulletTaskService.TaskDTO> GetSortedItems(List<BulletTaskService.TaskDTO> items) 
        => items?.OrderBy(t => t.SortOrder).ThenBy(t => GetTypePriority(t.Type)).ToList() ?? new();

    private int GetTypePriority(string type) => type switch { "health" => -3, "habit" => -1, "meeting" => 1, "task" => 2, _ => 5 };
    
    private List<BulletTaskService.TaskDTO> GetItemsForColumn(DateTime d, string category) 
    { 
        var dayItems = loadedItems.Where(t => t.Date.Date == d.Date); 
        if (category.Equals("personal", StringComparison.OrdinalIgnoreCase)) return dayItems.Where(t => !t.Category.Trim().Equals("work", StringComparison.OrdinalIgnoreCase) && !t.Category.Trim().Equals("health", StringComparison.OrdinalIgnoreCase)).ToList(); 
        return dayItems.Where(t => t.Category.Trim().Equals(category, StringComparison.OrdinalIgnoreCase)).ToList(); 
    }
    
    private List<BulletTaskService.TaskDTO> GetItemsForDate(DateTime d) => loadedItems.Where(t => t.Date.Date == d.Date).ToList();
    private BulletHabitService.HabitDTO GetHabit(int id) => loadedHabits.FirstOrDefault(h => h.Id == id) ?? new();
    private BulletSportsService.GameDTO GetGame(int id) => loadedGames.FirstOrDefault(g => g.Id == id) ?? new();
    private string GetDayBorderClass(DateTime d) => d.Date == DateTime.UtcNow.AddMinutes(-clientOffset).Date ? "border-yellow-500 shadow-lg" : "border-gray-700";

    public class SessionData { public int UserId { get; set; } }
}