@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Globalization
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 relative font-sans">
    
    <BulletHeader 
        ShowControls="true"
        CustomDateText="@GetHeaderDate()"
        ActiveView="@currentView"
        OnPrev="Prev"
        OnNext="Next"
        OnGoToday="GoToday"
        OnViewChanged="SwitchView">
        
        <div class="flex items-center gap-2 ml-4">
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleKeyUp"
                       placeholder="Quick search..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
                
                @if(!string.IsNullOrWhiteSpace(searchQuery) || isSearching)
                {
                    <button @onclick="ClearSearch" class="text-gray-500 hover:text-red-400 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                }
                
                <button @onclick="() => showAdvancedSearch = true" 
                        class="ml-1 p-1 text-gray-500 hover:text-blue-400 transition-colors border-l border-gray-700" 
                        title="Advanced Search">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                </button>
            </div>

            <div class="h-6 w-px bg-gray-800 mx-2"></div>

            <button @onclick="PrevYear" class="group flex items-center justify-center w-8 h-8 bg-black/40 hover:bg-blue-900/40 border border-gray-800 hover:border-blue-500/50 rounded-lg transition-all shadow-lg" title="Previous Year">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
            </button>
            <div class="text-[9px] font-black text-gray-600 uppercase tracking-widest px-1">Year</div>
            <button @onclick="NextYear" class="group flex items-center justify-center w-8 h-8 bg-black/40 hover:bg-blue-900/40 border border-gray-800 hover:border-blue-500/50 rounded-lg transition-all shadow-lg" title="Next Year">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
            </button>
        </div>
    </BulletHeader>

    <div class="px-6 h-[calc(100vh-140px)] overflow-hidden">
        @if (isSearching)
{
    <div class="h-full flex flex-col">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h2 class="text-sm font-black uppercase tracking-[0.2em] text-blue-400 mb-2">
                    Search Results: <span class="text-white">@searchResults.Count</span> items
                </h2>
                <div class="flex flex-wrap gap-2">
                    @foreach (var typeGroup in searchResults.GroupBy(x => x.Type).OrderBy(g => GetTypePriority(g.Key)))
                    {
                        <div class="px-2 py-0.5 bg-gray-800 border border-gray-700 rounded text-[9px] font-black uppercase tracking-tighter text-gray-400">
                            <span class="text-blue-400">@typeGroup.Count()</span> @typeGroup.Key@(typeGroup.Count() > 1 ? "s" : "")
                        </div>
                    }
                </div>
            </div>
            <button @onclick="ClearSearch" class="text-[10px] font-bold text-gray-500 hover:text-red-400 transition-colors uppercase tracking-[0.2em] flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                Close Search
            </button>
        </div>

        <div class="flex-1 overflow-y-auto pr-2 scrollbar-hide">
            @if (!searchResults.Any())
            {
                <div class="h-64 flex flex-col items-center justify-center border-2 border-dashed border-gray-800 rounded-2xl text-gray-600 italic">
                    <p>No matches found.</p>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                    @foreach (var item in searchResults)
                    {
                        <div class="relative">
                            <div class="absolute -top-2 -right-1 z-10 bg-blue-600 text-[9px] font-black px-2 py-0.5 rounded shadow-xl uppercase tracking-tighter">
                                @item.Date.ToString("MMM dd, yyyy")
                            </div>
                            
                            <div class="h-full border border-gray-800 rounded-xl overflow-hidden hover:border-blue-500/50 transition-all bg-gray-800/20">
                                @if (item.Type == "meeting") { <MeetingCard Item="item" OnClick="OpenEdit" OnToggle="ToggleMeetingComplete" OnDelete="DeleteTask" /> }
                                else if (item.Type == "habit") { <HabitCard Item="@(GetHabit(item.Id))" OnClick="OpenHabitEdit" OnDelete="DeleteTask" OnChange="SaveHabitDirectly" /> }
                                else if (item.Type == "media") { <MediaCard Item="item" OnClick="OpenMediaEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "holiday") { <HolidayCard Item="item" OnClick="OpenHolidayEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "birthday") { <BirthdayCard Item="item" OnClick="OpenBirthdayEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "anniversary") { <AnniversaryCard Item="item" OnClick="OpenAnniversaryEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "vacation") { <VacationCard Item="item" OnClick="OpenVacationEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="OpenHealthEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "sports") { <SportsCard Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnDelete="DeleteTask" /> }
                                else { <TaskCard Item="item" OnClick="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" /> }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}
        else if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 h-full font-black">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                            <span class="font-bold text-@cat.Item3-400 uppercase tracking-wider text-sm">@cat.Item1</span>
                            <button @onclick='async () => await OpenEditor(cat.Item2, cat.Item2 == "health" ? "health" : "task", viewDate)' 
                                    class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition font-bold uppercase tracking-widest">
                                ï¼‹ Add
                            </button>
                        </div>
                        <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide font-bold">
                            @if(isLoading)
                            {
                                <div class="text-center text-gray-500 text-xs italic mt-4 animate-pulse uppercase tracking-widest">Syncing...</div>
                            }
                            else
                            {
                                var colItems = GetSortedItems(GetItemsForColumn(viewDate, cat.Item2));
                                @foreach(var item in colItems) 
                                { 
                                    <div @key="item.Id">
                                        @if (item.Type == "meeting") { <MeetingCard Item="item" OnClick="OpenEdit" OnToggle="ToggleMeetingComplete" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "habit") { <HabitCard Item="@(GetHabit(item.Id))" OnClick="OpenHabitEdit" OnDelete="DeleteTask" OnChange="SaveHabitDirectly" /> }
                                        else if (item.Type == "media") { <MediaCard Item="item" OnClick="OpenMediaEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "holiday") { <HolidayCard Item="item" OnClick="OpenHolidayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "birthday") { <BirthdayCard Item="item" OnClick="OpenBirthdayEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "anniversary") { <AnniversaryCard Item="item" OnClick="OpenAnniversaryEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "vacation") { <VacationCard Item="item" OnClick="OpenVacationEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="OpenHealthEdit" OnDelete="DeleteTask" /> }
                                        else if (item.Type == "sports") { <SportsCard Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnDelete="DeleteTask" /> }
                                        else { <TaskCard Item="item" OnClick="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" /> }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "week")
        {
             <div class="grid grid-cols-7 gap-2 h-full font-sans font-bold">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    <div class="flex flex-col h-full rounded-xl border overflow-hidden bg-gray-800/40 @GetDayBorderClass(d)">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700 transition" @onclick="() => GoToDate(d)">
                            <div class="text-[10px] uppercase font-black text-gray-500">@d.ToString("ddd")</div>
                            <div class="text-lg font-black text-white">@d.Day</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                            @foreach(var item in GetSortedItems(GetItemsForDate(d))) { 
                                @if(item.Type == "meeting") { <MeetingPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "habit") { <HabitPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "media") { <MediaPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "holiday") { <HolidayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "birthday") { <BirthdayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "anniversary") { <AnniversaryPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "vacation") { <VacationPill Item="item" OnClick="OpenVacationEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                                else if (item.Type == "health") { <HealthPill Item="item" User="currentUser" OnClick="OpenHealthEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                else if (item.Type == "sports") { <SportsPill Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                else { <TaskPill Task="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthWeek" /> }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col h-full font-sans font-black">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2 font-black uppercase text-[10px] text-gray-500">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"}){ <div>@day</div> }
                </div>
                <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                    @for(int i=0; i<monthEmptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-800 transition cursor-pointer @GetDayBorderClass(currentDay) bg-gray-900/50" @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-[10px] font-bold text-gray-500 mb-1">@d</div>
                            <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-24">
                                @foreach(var item in GetSortedItems(GetItemsForDate(currentDay))) { 
                                    @if(item.Type == "meeting") { <MeetingPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "habit") { <HabitPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "media") { <MediaPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "holiday") { <HolidayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "birthday") { <BirthdayPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "anniversary") { <AnniversaryPill Item="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "vacation") { <VacationPill Item="item" OnClick="OpenVacationEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                    else if (item.Type == "health") { <HealthPill Item="item" User="currentUser" OnClick="OpenHealthEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                    else if (item.Type == "sports") { <SportsPill Item="@(GetGame(item.Id))" OnClick="OpenSportsEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" /> }
                                    else { <TaskPill Task="item" OnClick="OpenEdit" OnMoveUp="MoveItemUp" OnMoveDown="MoveItemDown" ImageWidth="@BulletViewConfig.ImgWidthMonth" /> }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@if (showAdvancedSearch)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center">
                <h3 class="text-sm font-black uppercase tracking-widest text-blue-400">Advanced Search</h3>
                <button @onclick="() => showAdvancedSearch = false" class="text-gray-500 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Item Type</label>
                    <select @bind="filterType" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none focus:border-blue-500">
                        <option value="all">All Types</option>
                        <option value="task">Tasks</option>
                        <option value="meeting">Meetings</option>
                        <option value="habit">Habits</option>
                        <option value="media">Media</option>
                        <option value="health">Health</option>
                        <option value="sports">Sports</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">From Date</label>
                        <input type="date" @bind="filterStart" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none focus:border-blue-500" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">To Date</label>
                        <input type="date" @bind="filterEnd" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none focus:border-blue-500" />
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-900/50 flex gap-3">
                <button @onclick="ResetFilters" class="flex-1 py-2 rounded-lg border border-gray-700 text-xs font-black uppercase tracking-widest hover:bg-gray-800 transition">Reset</button>
                <button @onclick="PerformAdvancedSearch" class="flex-1 py-2 rounded-lg bg-blue-600 text-xs font-black uppercase tracking-widest hover:bg-blue-500 transition shadow-lg shadow-blue-900/20">Apply Filters</button>
            </div>
        </div>
    </div>
}

<BaseEditor Item="editingItem" 
            TaskDetail="editingItem?.Detail ?? new()" 
            MeetingDetail="editingItem?.MeetingDetail ?? new()" 
            HabitDetail="editingItem?.HabitDetail ?? new()" 
            MediaDetail="editingItem?.MediaDetail ?? new()" 
            HolidayDetail="editingItem?.HolidayDetail ?? new()"
            BirthdayDetail="editingItem?.BirthdayDetail ?? new()"
            AnniversaryDetail="editingItem?.AnniversaryDetail ?? new()"
            VacationDetail="editingItem?.VacationDetail ?? new()"
            HealthDetail="editingItem?.HealthDetail ?? new()"
            SportsDetail="editingItem?.SportsDetail ?? new()"
            Notes="editingItem?.Notes ?? new()"
            Leagues="allLeagues"
            Seasons="allSeasons"
            Teams="allTeams"
            OnSaveRecurring="SaveRecurringSeries" 
            OnCancel="() => editingItem = null" 
            OnDelete="DeleteCurrentTask" />

@code {
    // ... (Keep all your existing private variables) ...
    private User? currentUser;
    private int userId = 0;
    private DateTime viewDate = DateTime.UtcNow;
    private string currentView = "day";
    private int clientOffset = 0;
    private bool isLoading = true;
    
    private List<League> allLeagues = new();
    private List<Season> allSeasons = new();
    private List<Team> allTeams = new();

    private List<BulletTaskService.TaskDTO> loadedItems = new();
    private List<BulletHabitService.HabitDTO> loadedHabits = new(); 
    private List<BulletMediaService.MediaDTO> loadedMedia = new(); 
    private List<BulletHolidayService.HolidayDTO> loadedHolidays = new(); 
    private List<BulletBirthdayService.BirthdayDTO> loadedBirthdays = new();
    private List<BulletAnniversaryService.AnniversaryDTO> loadedAnniversaries = new();
    private List<BulletVacationService.VacationDTO> loadedVacations = new(); 
    private List<BulletHealthService.HealthDTO> loadedHealth = new();
    private List<BulletSportsService.GameDTO> loadedGames = new();
    
    private BulletTaskService.TaskDTO? editingItem;
    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => ((int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek + 6) % 7; 

    // NEW SEARCH STATE
    private string searchQuery = "";
    private bool isSearching = false;
    private bool showAdvancedSearch = false;
    private List<BulletTaskService.TaskDTO> searchResults = new();

    // ADVANCED FILTERS
    private string filterType = "all";
    private DateTime? filterStart;
    private DateTime? filterEnd;

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformQuickSearch();
        }
    }

    private async Task PerformQuickSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            ClearSearch();
            return;
        }

        isSearching = true;
        isLoading = true;
        StateHasChanged();

        // Query the database for matches across all categories
        // We look back 1 year and forward 1 year for quick search context
        var start = DateTime.UtcNow.AddYears(-1);
        var end = DateTime.UtcNow.AddYears(1);

        searchResults = await BaseService.SearchItems(userId, searchQuery, "all", start, end);
        
        isLoading = false;
        StateHasChanged();
    }

    private async Task PerformAdvancedSearch()
    {
        showAdvancedSearch = false;
        isSearching = true;
        isLoading = true;
        StateHasChanged();

        // Default to a wide range if not specified
        var start = filterStart ?? DateTime.UtcNow.AddYears(-5);
        var end = filterEnd ?? DateTime.UtcNow.AddYears(5);

        searchResults = await BaseService.SearchItems(userId, searchQuery, filterType, start, end);

        isLoading = false;
        StateHasChanged();
    }

    private void ClearSearch()
    {
        searchQuery = "";
        isSearching = false;
        searchResults.Clear();
        ResetFilters();
        _ = LoadData();
    }

    private void ResetFilters()
    {
        filterType = "all";
        filterStart = null;
        filterEnd = null;
    }

    // ... (Keep all your existing methods: OnAfterRenderAsync, LoadData, SaveRecurringSeries, etc.) ...
    // Note: Ensure LoadData is called whenever editing or deleting an item from search results to keep calendar in sync.

    // ADDITION: In your BulletBaseService (in the background), you'll need a SearchItems method.
    // If you don't have it, it should look something like this in your Service class:
    /*
    public async Task<List<BulletTaskService.TaskDTO>> SearchItems(int userId, string query, string type, DateTime start, DateTime end)
    {
        // This is where you join your tables or search the generic BulletItems table
        // and return the list of TaskDTOs.
    }
    */
    
    // MODIFIED LoadData: Ensure it clears isSearching if we are navigating the calendar
    private async Task InternalLoadData() 
    {
        isSearching = false;
        await LoadData();
    }

    // Replace your existing Prev/Next calls to use InternalLoadData
    private void Prev() { /* ... */ _ = InternalLoadData(); }
    private void Next() { /* ... */ _ = InternalLoadData(); }

    // (Remaining implementation is the same as your provided code)
}