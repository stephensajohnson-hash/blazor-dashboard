@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 relative">
    
    <div class="p-6 pb-2 mb-2 border-b border-gray-800 flex items-center justify-between shrink-0 sticky top-0 bg-gray-900 z-40">
        <div class="min-w-[200px]">
            <h2 class="text-2xl font-bold text-white tracking-tight">@GetHeaderDate()</h2>
            <span class="text-sm font-medium text-gray-400">@currentView.ToUpper() VIEW</span>
        </div>

        <div class="flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
            <div class="flex items-center gap-2">
                <button @onclick="Prev" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">◀</button>
                <button @onclick="GoToday" class="px-3 h-8 flex items-center justify-center bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider transition">Today</button>
                <button @onclick="Next" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">▶</button>
            </div>
            
            <div class="flex bg-gray-900/50 rounded-lg p-1 border border-gray-700">
                <button @onclick='() => SwitchView("day")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Day</button>
                <button @onclick='() => SwitchView("week")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Week</button>
                <button @onclick='() => SwitchView("month")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Month</button>
            </div>
        </div>

        <div class="flex gap-4">
             <button @onclick='() => OpenEditor("personal", "task", viewDate)' class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm transition">
                <span>＋</span> New Task
            </button>
            
            <button @onclick="SetupTables" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-300 px-3 py-2 rounded-lg text-xs font-bold" title="Re-run DB Migrations">
               ⚙️ Fix DB
            </button>

            <div class="relative">
                <button @onclick="() => showUserMenu = !showUserMenu" class="w-10 h-10 rounded-full bg-gray-800 border-2 border-gray-700 overflow-hidden hover:border-gray-500 transition">
                    <img src="@(currentUser?.AvatarUrl ?? "https://i.imgur.com/7Y5j5Yx.png")" class="w-full h-full object-cover" />
                </button>
                @if (showUserMenu) {
                    <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 border border-gray-700 rounded-xl shadow-xl p-2 z-50">
                        <button @onclick="RunTaskImport" class="block w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1">Import Tasks</button>
                        <button @onclick="DropLegacy" class="block w-full text-left text-xs text-red-300 hover:bg-gray-700 p-2 rounded mb-1">Drop Old Tables</button>
                        <button @onclick="Logout" class="w-full text-left text-xs text-gray-400 hover:bg-gray-700 p-2 rounded">Logout</button>
                    </div>
                }
            </div>
        </div>
    </div>

    @if(!string.IsNullOrEmpty(statusMessage) || isDbError) {
        <div class="mx-6 mb-4 p-2 rounded @(isDbError ? "bg-red-900/50 border-red-600 text-red-200" : "bg-blue-900/20 border-blue-800 text-blue-300") border text-xs font-mono">
            @(isDbError ? "ERROR: " + errorMessage : statusMessage)
        </div>
    }

    <div class="px-6 h-[calc(100vh-100px)] overflow-hidden">
        @if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 h-full">
                @RenderDayColumn("Work", "work", "blue")
                @RenderDayColumn("Personal", "personal", "green")
                @RenderDayColumn("Health", "health", "orange")
            </div>
        }
        else if (currentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 h-full">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    var isToday = d.Date == DateTime.UtcNow.AddMinutes(clientOffset).Date;
                    <div class="flex flex-col h-full rounded-xl border overflow-hidden bg-gray-800/40 @(isToday ? "border-blue-500" : "border-gray-700")">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60">
                            <div class="text-[10px] uppercase font-bold text-gray-500">@d.ToString("ddd")</div>
                            <div class="text-lg font-bold @(isToday ? "text-blue-400" : "text-white")">@d.Day</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                            @foreach(var t in GetTasksForDate(d)) { @RenderTaskPill(t) }
                            <button @onclick='() => OpenEditor("personal", "task", d)' class="w-full py-2 text-gray-600 hover:text-gray-400 hover:bg-gray-700/50 rounded text-xs transition mt-2">＋</button>
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col h-full">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"}){ <div class="text-xs font-bold text-gray-500 uppercase">@day</div> }
                </div>
                <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                    @for(int i=0; i<monthEmptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        var isToday = currentDay.Date == DateTime.UtcNow.AddMinutes(clientOffset).Date;
                        <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-800 transition cursor-pointer @(isToday ? "border-blue-500 bg-gray-800/50" : "border-gray-700 bg-gray-900")" @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-xs font-bold text-gray-500 mb-1">@d</div>
                            <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-24">
                                @foreach(var t in GetTasksForDate(currentDay)) { <div class="w-2 h-2 rounded-full @(GetCategoryColor(t.Category)) inline-block mr-0.5"></div> }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@if (editingItem != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white">@(editingItem.Id == 0 ? "New Task" : "Edit Task")</h3>
                <button @onclick="() => editingItem = null" class="text-gray-400 hover:text-white">✕</button>
            </div>
            
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                    <input @bind="editingItem.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none" />
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" @bind="editingItem.Date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                        <select @bind="editingItem.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                            <option value="work">Work</option>
                            <option value="personal">Personal</option>
                            <option value="health">Health</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticket #</label>
                        <input @bind="editingItem.Detail.TicketNumber" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label>
                        <select @bind="editingItem.Detail.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white">
                            <option>Low</option>
                            <option>Normal</option>
                            <option>High</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
                    <input @bind="editingItem.ImgUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" />
                    @if(!string.IsNullOrEmpty(editingItem.ImgUrl)) {
                        <div class="mt-2 h-32 w-full rounded bg-black overflow-hidden border border-gray-700">
                            <img src="@editingItem.ImgUrl" class="w-full h-full object-contain" />
                        </div>
                    }
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                    <textarea @bind="editingItem.Description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-between">
                @if(editingItem.Id > 0) {
                    <button @onclick="DeleteItem" class="px-4 py-2 text-red-400 hover:text-red-300 text-sm font-bold hover:bg-red-900/20 rounded">Delete</button>
                } else { <div></div> }
                
                <div class="flex gap-3">
                    <button @onclick="() => editingItem = null" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button>
                    <button @onclick="SaveItem" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save Task</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private User? currentUser;
    private DateTime viewDate = DateTime.UtcNow;
    private string currentView = "day";
    private int clientOffset = 0;
    private bool showUserMenu = false;
    private bool isDbError = false;
    private string errorMessage = "";
    private string statusMessage = "";
    
    // Data
    private List<BulletTaskService.TaskDTO> loadedTasks = new();
    private BulletTaskService.TaskDTO? editingItem;

    // Computed Properties
    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => ((int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek + 6) % 7; 

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try {
                // 1. SESSION CHECK
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", true); return; }
                
                // 2. PARSE ID (Safe)
                int userId = 0;
                using(var doc = JsonDocument.Parse(json)) {
                    if(doc.RootElement.TryGetProperty("UserId", out var p)) userId = p.GetInt32();
                }

                if(userId > 0) {
                    // 3. FETCH USER (Database Safe)
                    try {
                        currentUser = await Db.Users.FindAsync(userId);
                    } catch { /* Ignore DB error here, will catch in LoadData */ }
                    
                    if(currentUser != null) {
                        try { clientOffset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()"); } catch {}
                        viewDate = DateTime.UtcNow.AddMinutes(-clientOffset);
                        await LoadData();
                    } else {
                        Nav.NavigateTo("/login", true);
                    }
                }
            } catch { /* Prevent loop */ }
        }
    }

    private async Task LoadData()
    {
        if (currentUser == null) return;

        // CALCULATE RANGE based on View
        DateTime start, end;
        if (currentView == "week") { 
            start = weekStart; 
            end = start.AddDays(7); 
        }
        else if (currentView == "month") { 
            start = new DateTime(viewDate.Year, viewDate.Month, 1); 
            end = start.AddMonths(1).AddSeconds(-1); 
        }
        else { 
            start = viewDate.Date; 
            end = viewDate.Date.AddDays(1).AddSeconds(-1); 
        } 

        try {
            // FIX: Call correct service method for range
            loadedTasks = await TaskService.GetTasksForRange(currentUser.Id, start, end);
            isDbError = false;
        } catch(Exception ex) {
            isDbError = true;
            errorMessage = "Data Load Failed: " + ex.Message;
        }
        StateHasChanged();
    }

    // --- VIEW LOGIC ---
    private void SwitchView(string view) { currentView = view; _ = LoadData(); }
    
    private void Prev() { 
        if(currentView == "day") viewDate = viewDate.AddDays(-1);
        else if(currentView == "week") viewDate = viewDate.AddDays(-7);
        else viewDate = viewDate.AddMonths(-1);
        _ = LoadData(); 
    }
    
    private void Next() { 
        if(currentView == "day") viewDate = viewDate.AddDays(1);
        else if(currentView == "week") viewDate = viewDate.AddDays(7);
        else viewDate = viewDate.AddMonths(1);
        _ = LoadData(); 
    }
    
    private void GoToday() { viewDate = DateTime.UtcNow.AddMinutes(-clientOffset); _ = LoadData(); }
    
    private void GoToDate(DateTime d) { viewDate = d; SwitchView("day"); }
    
    private string GetHeaderDate() => currentView == "day" ? viewDate.ToString("dddd, MMM d") : (currentView == "week" ? $"Week of {weekStart:MMM d}" : viewDate.ToString("MMMM yyyy"));

    // Helper for rendering
    private List<BulletTaskService.TaskDTO> GetTasksForDate(DateTime d) => loadedTasks.Where(t => t.Date.Date == d.Date).ToList();

    // --- ACTIONS ---
    private async Task SetupTables()
    {
        statusMessage = "Fixing DB Schema...";
        try {
            await BaseService.CreateBaseTablesIfMissing();
            await TaskService.CreateTable();
            statusMessage = "Schema Fixed. Reloading...";
            isDbError = false;
            await LoadData();
        } catch (Exception ex) {
            isDbError = true;
            errorMessage = ex.Message;
        }
        StateHasChanged();
    }

    private async Task RunTaskImport()
    {
        if(currentUser == null) return;
        statusMessage = "Importing...";
        try {
            var path = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if(File.Exists(path)) {
                var content = await File.ReadAllTextAsync(path);
                await TaskService.ImportFromOldJson(currentUser.Id, content);
                statusMessage = "Imported Successfully.";
                await LoadData();
            } else { statusMessage = "File not found."; }
        } catch(Exception ex) { 
            statusMessage = "Error: " + ex.Message; 
        }
        StateHasChanged();
    }

    private async Task DropLegacy()
    {
        if(!await JS.InvokeAsync<bool>("confirm", "Delete old tables?")) return;
        await BaseService.DropLegacyTables();
        statusMessage = "Legacy tables dropped.";
        StateHasChanged();
    }

    private async Task ToggleComplete(BulletTaskService.TaskDTO t)
    {
        t.Detail.IsCompleted = !t.Detail.IsCompleted;
        await TaskService.ToggleComplete(t.Id, t.Detail.IsCompleted);
    }

    private void OpenEditor(string category, string type, DateTime date)
    {
        editingItem = new BulletTaskService.TaskDTO 
        { 
            UserId = currentUser!.Id, 
            Category = category, 
            Type = type, 
            Date = date 
        };
    }

    private void OpenEdit(BulletTaskService.TaskDTO t)
    {
        var json = JsonSerializer.Serialize(t);
        editingItem = JsonSerializer.Deserialize<BulletTaskService.TaskDTO>(json);
        if(editingItem != null) editingItem.Date = t.Date; 
    }

    private async Task SaveItem()
    {
        if(editingItem != null) {
            await TaskService.SaveTask(editingItem);
            editingItem = null;
            await LoadData();
        }
    }

    private async Task DeleteItem()
    {
        if(editingItem != null && editingItem.Id > 0) {
            if(await JS.InvokeAsync<bool>("confirm", "Delete this task?")) {
                await BaseService.DeleteItem(editingItem.Id);
                editingItem = null;
                await LoadData();
            }
        }
    }
    
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }

    private string GetCategoryColor(string cat) => cat.ToLower() switch { "work" => "bg-blue-500", "personal" => "bg-green-500", "health" => "bg-orange-500", _ => "bg-gray-500" };

    // --- RENDERERS ---
    private RenderFragment RenderDayColumn(string title, string category, string colorClass) => __builder => {
        var tasks = GetTasksForDate(viewDate).Where(t => t.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList();
        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                <span class="font-bold text-@colorClass-400 uppercase tracking-wider text-sm">@title</span>
            </div>
            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                @foreach(var t in tasks) { @RenderTaskCard(t) }
                @if(!tasks.Any()) { <div class="text-center text-gray-600 text-xs italic mt-4">No tasks</div> }
            </div>
        </div>
    };

    private RenderFragment RenderTaskCard(BulletTaskService.TaskDTO t) => __builder => {
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-0 relative group hover:border-blue-500 transition shadow-sm overflow-hidden mb-2" @onclick="() => OpenEdit(t)">
            @if(!string.IsNullOrEmpty(t.ImgUrl)) {
                <div class="h-24 w-full bg-black relative">
                    <img src="@t.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" />
                </div>
            }
            <div class="p-3">
                <div class="flex items-start gap-3">
                    <input type="checkbox" checked="@t.Detail.IsCompleted" @onchange="() => ToggleComplete(t)" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer" />
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-white leading-tight @(t.Detail.IsCompleted ? "line-through text-gray-500" : "")">@t.Title</h4>
                        @if(!string.IsNullOrEmpty(t.Description)) { <p class="text-xs text-gray-500 mt-1 line-clamp-2">@t.Description</p> }
                        <div class="flex gap-2 mt-2">
                            @if(!string.IsNullOrEmpty(t.Detail.TicketNumber)) { <span class="text-[9px] bg-blue-900/30 text-blue-300 border border-blue-800 px-1.5 py-0.5 rounded uppercase tracking-wider">@t.Detail.TicketNumber</span> }
                            @if(t.Detail.Priority == "High") { <span class="text-[9px] bg-red-900/30 text-red-300 border border-red-800 px-1.5 py-0.5 rounded uppercase tracking-wider">High</span> }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment RenderTaskPill(BulletTaskService.TaskDTO t) => __builder => {
        <div class="text-xs px-1.5 py-1 rounded mb-1 border group relative cursor-pointer truncate transition hover:scale-105 @(t.Detail.IsCompleted ? "bg-gray-800 text-gray-500 border-gray-700 line-through" : "bg-gray-700 text-gray-200 border-gray-600 hover:border-blue-400")" 
             @onclick="() => OpenEdit(t)" @onclick:stopPropagation="true">
            @t.Title
        </div>
    };
}