@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject BulletVacationService VacationService
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white pb-40">
   <BulletHeader ShowControls="true" CustomDateText="@GetHeaderDate()" ActiveView="@currentView" OnPrev="Prev" OnNext="Next" OnGoToday="GoToday" OnViewChanged="SwitchView" />

    <div class="px-6 h-[calc(100vh-140px)]">
        @if(isLoading) {
            <div class="flex items-center justify-center h-full text-gray-500 animate-pulse uppercase font-bold">Initializing Database...</div>
        }
        else {
            <div class="grid grid-cols-3 gap-6 h-full">
                @foreach (var cat in new[] { ("Work", "work"), ("Personal", "personal"), ("Health", "health") }) {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center">
                            <span class="font-bold uppercase text-sm">@cat.Item1</span>
                            <button @onclick='() => OpenEditor(cat.Item2, "task", viewDate)' class="text-xs bg-gray-700 px-2 py-0.5 rounded">ï¼‹ Add</button>
                        </div>
                        <div class="p-3 overflow-y-auto flex-1 space-y-3">
                            @foreach(var item in loadedItems.Where(t => t.Date.Date == viewDate.Date && (cat.Item2 == "personal" ? (t.Category != "work" && t.Category != "health") : t.Category == cat.Item2))) { 
                                @if (item.Type == "sports") { <SportsCard Item="item" OnClick="OpenEdit" OnDelete="DeleteTask" /> }
                                else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="OpenEdit" OnDelete="DeleteTask" /> }
                                else { <TaskCard Item="item" OnClick="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" /> }
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<BaseEditor Item="editingItem" 
            TaskDetail="editingItem?.Detail ?? new()" 
            MeetingDetail="editingItem?.MeetingDetail ?? new()" 
            HabitDetail="editingItem?.HabitDetail ?? new()" 
            VacationDetail="editingItem?.VacationDetail ?? new()"
            HealthDetail="editingItem?.HealthDetail ?? new()"
            SportsDetail="editingItem?.SportsDetail ?? new()"
            Leagues="allLeagues" Seasons="allSeasons" Teams="allTeams"
            OnSave="SaveItem" OnCancel="() => editingItem = null" OnDelete="DeleteTaskFromEditor" />

@code {
    private User? currentUser;
    private int userId = 0;
    private DateTime viewDate = DateTime.Today;
    private string currentView = "day";
    private bool isLoading = true;
    private BulletTaskService.TaskDTO? editingItem;
    private List<BulletTaskService.TaskDTO> loadedItems = new();
    private List<League> allLeagues = new();
    private List<Season> allSeasons = new();
    private List<Team> allTeams = new();

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) {
                    var session = JsonSerializer.Deserialize<SessionData>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (session?.UserId > 0) {
                        userId = session.UserId;
                        currentUser = await Db.Users.FindAsync(userId);
                        // ONE LINEAR FETCH
                        allLeagues = await Db.Leagues.ToListAsync() ?? new();
                        allSeasons = await Db.Seasons.ToListAsync() ?? new();
                        allTeams = await Db.Teams.ToListAsync() ?? new();
                        await LoadData();
                    }
                }
            } catch { isLoading = false; StateHasChanged(); }
        }
    }

    private async Task LoadData() {
        if (currentUser == null) return;
        isLoading = true; StateHasChanged();
        try {
            var tasks = await TaskService.GetTasksForRange(userId, viewDate.Date, viewDate.Date.AddDays(1)) ?? new();
            var sports = await SportsService.GetGamesForRange(userId, viewDate.Date, viewDate.Date.AddDays(1)) ?? new();
            loadedItems = tasks.Concat(sports.Select(g => new BulletTaskService.TaskDTO { Id = g.Id, Title = g.Title, Type = "sports", Date = g.Date, Category = g.Category, SportsDetail = g.Detail })).ToList();
        } finally { isLoading = false; StateHasChanged(); }
    }

    private void OpenEditor(string cat, string type, DateTime dt) => editingItem = new BulletTaskService.TaskDTO { UserId = userId, Category = cat, Type = type, Date = dt };
    private void OpenEdit(BulletTaskService.TaskDTO t) => editingItem = t;
    private async Task SaveItem() { if (editingItem == null) return; if (editingItem.Type == "sports") await SportsService.SaveGame(new BulletSportsService.GameDTO { Id = editingItem.Id, UserId = userId, Title = editingItem.Title, Detail = editingItem.SportsDetail ?? new(), Date = editingItem.Date, Category = editingItem.Category }); else await TaskService.SaveTask(editingItem); editingItem = null; await LoadData(); }
    private async Task DeleteTask(int id) { await BaseService.DeleteItem(id); await LoadData(); }
    private async Task DeleteTaskFromEditor() { if (editingItem != null) await DeleteTask(editingItem.Id); editingItem = null; }
    private async Task ToggleComplete(BulletTaskService.TaskDTO t) { t.Detail.IsCompleted = !t.Detail.IsCompleted; await TaskService.ToggleComplete(t.Id, t.Detail.IsCompleted); }
    private void SwitchView(string v) => currentView = v;
    private void Prev() { viewDate = viewDate.AddDays(-1); _ = LoadData(); }
    private void Next() { viewDate = viewDate.AddDays(1); _ = LoadData(); }
    private void GoToday() { viewDate = DateTime.Today; _ = LoadData(); }
    private string GetHeaderDate() => viewDate.ToString("D");
    private DateTime weekStart => viewDate.AddDays(-(int)viewDate.DayOfWeek);
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => (int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek;
    public class SessionData { public int UserId { get; set; } }
}