@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.IO
@using System.Net.Http.Headers
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Setup Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">Create Missing Tables</button>
        </div>
    }
    else
    {
        <main class="w-full p-6 relative h-screen flex flex-col" @onclick="CloseMenus">
            
            <div class="mb-4 border-b border-gray-800 pb-2 flex items-center justify-between shrink-0">
                <div class="min-w-[200px]">
                    <div class="flex flex-col">
                        <h2 class="text-2xl font-bold text-white tracking-tight">@GetHeaderDate()</h2>
                        <span class="text-lg font-medium text-gray-400">@CurrentTime</span>
                    </div>
                </div>
                <div class="flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <div class="flex items-center gap-4 border-r border-gray-600 pr-4">
                        <a href="/" class="text-xl hover:scale-125 transition grayscale-0" title="Home">üè†</a>
                        <a href="/recipes" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @onclick="Prev" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚óÄ</button>
                        <button @onclick="GoToday" class="px-3 h-8 flex items-center justify-center bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider transition">Today</button>
                        <div class="flex bg-gray-900/50 rounded-lg p-1">
                            <button @onclick="@(() => SwitchView("day"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Day</button>
                            <button @onclick="@(() => SwitchView("week"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Week</button>
                            <button @onclick="@(() => SwitchView("month"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Month</button>
                        </div>
                        <button @onclick="Next" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚ñ∂</button>
                    </div>
                </div>
                <div class="flex items-center gap-6 min-w-[200px] justify-end">
                     @if (weather?.current != null)
                    {
                        <div class="flex items-center gap-3 bg-gray-800/30 px-3 py-1.5 rounded-xl border border-gray-700/30">
                            <div class="flex items-center gap-2 pr-3 border-r border-gray-600">
                                <span class="text-xl">@GetWeatherIcon(weather.current.weather_code)</span>
                                <div class="font-bold text-white text-base leading-none">@weather.current.temperature_2m.ToString("0")¬∞</div>
                            </div>
                            <div class="flex gap-2">
                                @if (weather.daily?.time != null) {
                                    @for (int i = 1; i <= 5 && i < weather.daily.time.Length; i++) {
                                        <div class="flex flex-col items-center">
                                            <span class="text-[8px] text-gray-500 font-bold uppercase">@GetDayName(weather.daily.time[i])</span>
                                            <span class="text-[9px]">@GetWeatherIcon(weather.daily.weather_code[i])</span>
                                            <div class="text-[7px] font-mono flex gap-0.5"><span class="text-white">@weather.daily.temperature_2m_max[i].ToString("0")¬∞</span><span class="text-gray-500">@weather.daily.temperature_2m_min[i].ToString("0")¬∞</span></div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu" @onclick:stopPropagation="true">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" class="w-9 h-9 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu) {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <button type="button" @onclick="() => { showImportModal = true; showUserMenu = false; }" class="w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üìÇ</span> Import Data</button>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative">
                @if (currentView == "day")
                {
                    <div class="grid grid-cols-3 gap-4 h-full">
                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-blue-400 uppercase tracking-wider text-sm">Work</span>
                                <button @onclick='() => OpenEditor("work", "task")' class="text-xs bg-blue-900/50 hover:bg-blue-600 text-blue-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var m in GetMeetingsForDate(viewDate)) { @RenderMeetingCard(m) }
                                @foreach(var t in GetTasksForDate(viewDate, "work")) { @RenderTaskCard(t) }
                                @if(!GetTasksForDate(viewDate, "work").Any() && !GetMeetingsForDate(viewDate).Any()) { <div class="text-center text-gray-600 text-xs italic mt-10">No items</div> }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-green-400 uppercase tracking-wider text-sm">Personal</span>
                                <button @onclick='() => OpenEditor("personal", "task")' class="text-xs bg-green-900/50 hover:bg-green-600 text-green-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var h in GetHabitsForDate(viewDate)) { @RenderHabitCard(h) }
                                @foreach(var t in GetTasksForDate(viewDate, "personal")) { @RenderTaskCard(t) }
                                @foreach(var m in GetMediaForDate(viewDate)) { @RenderMediaCard(m) }
                                @if(!GetTasksForDate(viewDate, "personal").Any() && !GetMediaForDate(viewDate).Any() && !GetHabitsForDate(viewDate).Any()) { <div class="text-center text-gray-600 text-xs italic mt-10">No items</div> }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-orange-400 uppercase tracking-wider text-sm">Health</span>
                                <button @onclick='() => OpenEditor("health", "habit")' class="text-xs bg-orange-900/50 hover:bg-orange-600 text-orange-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var t in GetTasksForDate(viewDate, "health")) { @RenderTaskCard(t) }
                                @if(!GetTasksForDate(viewDate, "health").Any()) { <div class="text-center text-gray-600 text-xs italic mt-10">No logs</div> }
                            </div>
                        </div>
                    </div>
                }
                else if (currentView == "week") { @RenderWeekView() }
                else if (currentView == "month") { @RenderMonthView() }
            </div>
        </main>
    }
</div>

@if (editingItem != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-lg flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white">@(editingItem.Id == 0 ? "Add Item" : "Edit Item")</h3>
                <button @onclick="() => editingItem = null" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="p-4 border-b border-gray-800 bg-gray-900">
                <div class="flex gap-2 justify-center">
                    <button type="button" @onclick='() => editingItem.Type = "task"' class="px-3 py-1.5 rounded-lg text-xs font-bold transition @(editingItem.Type == "task" ? "bg-blue-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üìã Task</button>
                    <button type="button" @onclick='() => editingItem.Type = "meeting"' class="px-3 py-1.5 rounded-lg text-xs font-bold transition @(editingItem.Type == "meeting" ? "bg-indigo-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">‚è∞ Meeting</button>
                    <button type="button" @onclick='() => editingItem.Type = "habit"' class="px-3 py-1.5 rounded-lg text-xs font-bold transition @(editingItem.Type == "habit" ? "bg-green-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üî• Habit</button>
                    <button type="button" @onclick='() => editingItem.Type = "media"' class="px-3 py-1.5 rounded-lg text-xs font-bold transition @(editingItem.Type == "media" ? "bg-purple-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üé¨ Media</button>
                </div>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" @bind="editingItem.Date" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                        <select @bind="editingItem.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm">
                            <option value="work">Work</option>
                            <option value="personal">Personal</option>
                            <option value="health">Health</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                    <input @bind="editingItem.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none" placeholder="Enter title..." />
                </div>

                @if(editingItem.Type == "task")
                {
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticket #</label>
                            <input @bind="editingItem.TicketNumber" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="JIRA-123" />
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label>
                             <select @bind="editingItem.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"><option>Normal</option><option>High</option><option>Low</option></select>
                        </div>
                    </div>
                }
                else if(editingItem.Type == "meeting")
                {
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Start Time</label>
                            <input type="time" @bind="editingItem.StartTime" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Duration (Min)</label>
                            <input type="number" @bind="editingItem.Duration" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                        </div>
                    </div>
                }
                else if(editingItem.Type == "media")
                {
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rating (1-10)</label>
                            <input type="number" @bind="editingItem.Rating" min="1" max="10" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Release Year</label>
                            <input type="number" @bind="editingItem.ReleaseYear" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                        </div>
                    </div>
                }
                else if(editingItem.Type == "habit")
                {
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Streak</label>
                        <input type="number" @bind="editingItem.Streak" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                    </div>
                }

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description / Notes</label>
                    <textarea @bind="editingItem.Description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image</label>
                    <div class="flex gap-2 mb-2">
                        <button type="button" class="text-xs px-3 py-1 rounded @(!isUploading ? "bg-blue-600 text-white" : "bg-gray-800 text-gray-400")" @onclick="() => isUploading = false">Link URL</button>
                        <button type="button" class="text-xs px-3 py-1 rounded @(isUploading ? "bg-blue-600 text-white" : "bg-gray-800 text-gray-400")" @onclick="() => isUploading = true">Upload</button>
                    </div>
                    @if (!isUploading)
                    {
                        <input @bind="editingItem.ImgUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="https://..." />
                    }
                    else
                    {
                        <InputFile OnChange="HandleImageUpload" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />
                    }
                </div>

            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-end gap-3">
                <button @onclick="() => editingItem = null" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button>
                <button @onclick="SaveItem" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save</button>
            </div>
        </div>
    </div>
}

@if (showImportModal)
{
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold text-white mb-2">Import Data</h3>
            <div class="flex gap-2 mb-4 flex-wrap">
                 <button @onclick="UpgradeDatabase" class="bg-blue-800 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">üõ†Ô∏è Missing Tables</button>
                 <button @onclick="ImportTasks" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üìã Import Tasks</button>
                 <button @onclick="ImportMeetings" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">‚è∞ Import Meetings</button>
                 <button @onclick="ImportHabits" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üî• Import Habits</button>
                 <button @onclick="ImportMedia" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üé¨ Import Media</button>
                 <button @onclick="WipeAll" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">üóëÔ∏è Wipe All</button>
            </div>
            <div class="flex-1 bg-black rounded-lg border border-gray-700 p-4 font-mono text-[10px] overflow-y-auto text-gray-300">
                @foreach(var log in debugLogs) { <div class="mb-1 border-b border-gray-900/50 pb-1 break-all">@log</div> }
            </div>
            <div class="mt-4 flex justify-end">
                <button @onclick="() => showImportModal = false" class="px-4 py-2 text-gray-400 hover:text-white">Close</button>
            </div>
        </div>
    </div>
}

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); };
    window.copyTextToClipboard = async (text) => { try { await navigator.clipboard.writeText(text); } catch (err) { console.error(err); } };
</script>

@code {
    private string CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private bool showImportModal = false;
    private User? currentUser;

    private string currentView = "day"; 
    private DateTime viewDate = DateTime.UtcNow;

    private List<BulletMedia> AllMedia = new();
    private List<BulletTask> AllTasks = new();
    private List<BulletMeeting> AllMeetings = new();
    private List<BulletHabit> AllHabits = new();

    // Editor State
    private DraftItem? editingItem;
    private bool isUploading = false;
    private class DraftItem {
        public int Id { get; set; }
        public string Type { get; set; } = "task";
        public string Category { get; set; } = "work";
        public DateTime Date { get; set; } = DateTime.UtcNow;
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string ImgUrl { get; set; } = "";
        public int? ImageId { get; set; }
        // Specifics
        public string TicketNumber { get; set; } = "";
        public string Priority { get; set; } = "Normal";
        public string StartTime { get; set; } = "";
        public int Duration { get; set; }
        public int Rating { get; set; }
        public int ReleaseYear { get; set; }
        public int Streak { get; set; }
    }

    // Import State
    private bool isImporting = false;
    private List<string> debugLogs = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isDbError) 
        { 
            try { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var session = JsonSerializer.Deserialize<SessionData>(json, options);
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }
                currentUser = await Db.Users.FindAsync(session.UserId);
                if (currentUser != null) { await LoadData(); _ = FetchWeather(); }
                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); } catch {}
                viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes);
                _ = StartClock(); StateHasChanged();
            } 
            catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }

    // --- EDITOR LOGIC ---
    private void OpenEditor(string category, string type) {
        editingItem = new DraftItem { 
            Category = category, 
            Type = type, 
            Date = viewDate // Default to current view date
        };
    }

    private void EditItem(string type, int id) {
        if (type == "task") { var t = AllTasks.First(x => x.Id == id); editingItem = new DraftItem { Id = t.Id, Type = "task", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, TicketNumber = t.TicketNumber, Priority = t.Priority }; }
        else if (type == "meeting") { var m = AllMeetings.First(x => x.Id == id); editingItem = new DraftItem { Id = m.Id, Type = "meeting", Category = m.Category, Date = m.Date, Title = m.Title, Description = m.Description, ImgUrl = m.ImgUrl, StartTime = m.StartTime, Duration = m.DurationPlanned }; }
        else if (type == "media") { var m = AllMedia.First(x => x.Id == id); editingItem = new DraftItem { Id = m.Id, Type = "media", Category = m.Category, Date = m.Date, Title = m.Title, Description = m.Description, ImgUrl = m.ImgUrl, Rating = m.Rating, ReleaseYear = m.ReleaseYear }; }
        else if (type == "habit") { var h = AllHabits.First(x => x.Id == id); editingItem = new DraftItem { Id = h.Id, Type = "habit", Category = h.Category, Date = h.Date, Title = h.Title, Description = h.Notes, ImgUrl = h.ImgUrl, Streak = h.StreakCount }; }
    }

    private async Task SaveItem() {
        if(editingItem == null || currentUser == null) return;
        
        if (editingItem.Type == "task") {
            BulletTask t;
            if(editingItem.Id > 0) t = await Db.BulletTasks.FindAsync(editingItem.Id) ?? new BulletTask();
            else { t = new BulletTask { UserId = currentUser.Id }; await Db.BulletTasks.AddAsync(t); }
            t.Title = editingItem.Title; t.Category = editingItem.Category; t.Date = editingItem.Date; t.Description = editingItem.Description; t.ImgUrl = editingItem.ImgUrl; t.TicketNumber = editingItem.TicketNumber; t.Priority = editingItem.Priority;
        }
        else if (editingItem.Type == "meeting") {
            BulletMeeting m;
            if(editingItem.Id > 0) m = await Db.BulletMeetings.FindAsync(editingItem.Id) ?? new BulletMeeting();
            else { m = new BulletMeeting { UserId = currentUser.Id }; await Db.BulletMeetings.AddAsync(m); }
            m.Title = editingItem.Title; m.Category = editingItem.Category; m.Date = editingItem.Date; m.Description = editingItem.Description; m.ImgUrl = editingItem.ImgUrl; m.StartTime = editingItem.StartTime; m.DurationPlanned = editingItem.Duration;
        }
        else if (editingItem.Type == "media") {
            BulletMedia m;
            if(editingItem.Id > 0) m = await Db.BulletMedia.FindAsync(editingItem.Id) ?? new BulletMedia();
            else { m = new BulletMedia { UserId = currentUser.Id }; await Db.BulletMedia.AddAsync(m); }
            m.Title = editingItem.Title; m.Category = "Movie"; m.Date = editingItem.Date; m.Description = editingItem.Description; m.ImgUrl = editingItem.ImgUrl; m.Rating = editingItem.Rating; m.ReleaseYear = editingItem.ReleaseYear;
        }
        else if (editingItem.Type == "habit") {
            BulletHabit h;
            if(editingItem.Id > 0) h = await Db.BulletHabits.FindAsync(editingItem.Id) ?? new BulletHabit();
            else { h = new BulletHabit { UserId = currentUser.Id }; await Db.BulletHabits.AddAsync(h); }
            h.Title = editingItem.Title; h.Category = editingItem.Category; h.Date = editingItem.Date; h.Notes = editingItem.Description; h.ImgUrl = editingItem.ImgUrl; h.StreakCount = editingItem.Streak;
        }

        await Db.SaveChangesAsync();
        editingItem = null;
        await LoadData();
    }

    private async Task DeleteItem(string type, int id) {
        if(!await JS.InvokeAsync<bool>("confirm", "Delete item?")) return;
        if(type == "task") { var x = await Db.BulletTasks.FindAsync(id); if(x != null) Db.BulletTasks.Remove(x); }
        else if(type == "meeting") { var x = await Db.BulletMeetings.FindAsync(id); if(x != null) Db.BulletMeetings.Remove(x); }
        else if(type == "media") { var x = await Db.BulletMedia.FindAsync(id); if(x != null) Db.BulletMedia.Remove(x); }
        else if(type == "habit") { var x = await Db.BulletHabits.FindAsync(id); if(x != null) Db.BulletHabits.Remove(x); }
        await Db.SaveChangesAsync(); await LoadData();
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e) { 
        if (editingItem == null) return; 
        try { 
            var file = e.File; using var content = new MultipartFormDataContent(); using var stream = file.OpenReadStream(5 * 1024 * 1024);
            var fileContent = new StreamContent(stream); fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType); content.Add(fileContent, "file", file.Name);
            var response = await Http.PostAsync("/api/images/upload", content);
            if (response.IsSuccessStatusCode) {
                var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                if (result != null) { editingItem.ImgUrl = result.Url; editingItem.ImageId = result.Id; }
            }
        } catch {} 
    }
    private class UploadResult { public int Id { get; set; } public string Url { get; set; } = ""; }

    // --- VIEW RENDERERS ---
    private RenderFragment RenderWeekView() => __builder => {
        <div class="grid grid-cols-7 gap-2 h-full">
            @{ var weekStart = GetStartOfWeek(viewDate); }
            @for (int i = 0; i < 7; i++) {
                var d = weekStart.AddDays(i); var isToday = d.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isWeekend = d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday;
                var borderClass = isToday ? "border-yellow-500 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700");
                <div class="flex flex-col h-full rounded-xl border overflow-hidden transition hover:border-gray-500 @borderClass @(isWeekend?"bg-gray-800/30":"bg-gray-800/60")">
                    <div class="p-2 text-center border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/50 @(isToday?"bg-blue-900/50 text-white":"text-gray-400")" @onclick="() => GoToDate(d)">
                        <div class="text-[10px] uppercase font-bold">@d.ToString("dddd")</div><div class="text-lg font-bold">@d.Day</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                        @foreach(var h in GetHabitsForDate(d)) { @RenderHabitPill(h) }
                        @foreach(var m in GetMeetingsForDate(d)) { @RenderMeetingPill(m) }
                        @foreach(var t in GetTasksForDate(d)) { @RenderTaskPill(t) }
                        @foreach(var m in GetMediaForDate(d)) { @RenderMediaCard(m, true) }
                    </div>
                </div>
            }
        </div>
    };
    private RenderFragment RenderMonthView() => __builder => {
        <div class="flex flex-col h-full"><div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2">@foreach(var day in new[]{"Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"}){ <div class="text-xs font-bold text-gray-500 uppercase">@day</div> }</div><div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">@{ var monthStart = new DateTime(viewDate.Year, viewDate.Month, 1); var daysInMonth = DateTime.DaysInMonth(viewDate.Year, viewDate.Month); var startDay = (int)monthStart.DayOfWeek; if (startDay == 0) startDay = 7; var emptyCells = startDay - 1; }@for(int i=0; i<emptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }@for(int d=1; d<=daysInMonth; d++){ var currentDay = new DateTime(viewDate.Year, viewDate.Month, d); var isToday = currentDay.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isWeekend = currentDay.DayOfWeek == DayOfWeek.Saturday || currentDay.DayOfWeek == DayOfWeek.Sunday; var borderClass = isToday ? "border-yellow-500 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700"); <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-700 transition cursor-pointer @borderClass @(isWeekend?"bg-gray-800/30":"bg-gray-800")" @onclick="() => GoToDate(currentDay)"><div class="text-right text-xs font-bold text-gray-500 mb-1 @(isToday?"text-yellow-400":"")">@d</div><div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-32">@foreach(var h in GetHabitsForDate(currentDay)) { @RenderHabitPill(h) }@foreach(var m in GetMeetingsForDate(currentDay)) { @RenderMeetingPill(m) }@foreach(var t in GetTasksForDate(currentDay)) { @RenderTaskPill(t) }@foreach(var m in GetMediaForDate(currentDay)) { @RenderMediaCard(m, true) }</div></div> }</div></div>
    };

    // --- CARDS ---
    private RenderFragment RenderHabitCard(BulletHabit h) => __builder => {
        <div class="bg-gray-900 border border-green-900/50 rounded-lg p-3 mb-2 hover:border-green-500 transition shadow-md group flex justify-between items-center relative">
            <div class="flex items-center gap-2"><div class="text-xl">üî•</div><div><h4 class="text-base font-bold text-white leading-tight">@h.Title</h4><div class="text-sm text-gray-500">@h.StreakCount Day Streak</div></div></div>
            <input type="checkbox" checked="@h.IsCompleted" disabled class="w-5 h-5 rounded border-green-600 text-green-600 bg-gray-800" />
            <div class="absolute top-1 right-1 hidden group-hover:flex gap-1"><button @onclick='() => EditItem("habit", h.Id)' class="p-1 text-gray-400 hover:text-white bg-black/50 rounded">‚úé</button><button @onclick='() => DeleteItem("habit", h.Id)' class="p-1 text-red-400 hover:text-red-200 bg-black/50 rounded">‚úï</button></div>
        </div>
    };
    private RenderFragment RenderTaskCard(BulletTask t) => __builder => {
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-2 hover:border-blue-500 transition shadow-md group relative">
            <div class="absolute top-1 right-1 hidden group-hover:flex gap-1 z-10"><button @onclick='() => EditItem("task", t.Id)' class="p-1 text-gray-400 hover:text-white bg-black/50 rounded">‚úé</button><button @onclick='() => DeleteItem("task", t.Id)' class="p-1 text-red-400 hover:text-red-200 bg-black/50 rounded">‚úï</button></div>
            @if(!string.IsNullOrEmpty(t.ImgUrl)){ <div class="flex flex-row gap-3"><div class="w-[30%]"><img src="@t.ImgUrl" class="w-full h-20 object-cover rounded" /></div><div class="w-[70%]"><h4 class="text-base font-bold text-white @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4><p class="text-sm text-gray-500 line-clamp-2">@t.Description</p></div></div> }
            else { <div class="flex gap-2"><input type="checkbox" checked="@t.IsCompleted" disabled class="mt-1 w-4 h-4 rounded bg-gray-800" /><div><h4 class="text-base font-bold text-white @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4><p class="text-sm text-gray-500">@t.Description</p></div></div> }
        </div>
    };
    private RenderFragment RenderMeetingCard(BulletMeeting m) => __builder => {
         <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-2 hover:border-indigo-500 transition shadow-md group relative">
            <div class="absolute top-1 right-1 hidden group-hover:flex gap-1 z-10"><button @onclick='() => EditItem("meeting", m.Id)' class="p-1 text-gray-400 hover:text-white bg-black/50 rounded">‚úé</button><button @onclick='() => DeleteItem("meeting", m.Id)' class="p-1 text-red-400 hover:text-red-200 bg-black/50 rounded">‚úï</button></div>
            @if(!string.IsNullOrEmpty(m.ImgUrl)){ <div class="flex flex-row gap-3"><div class="w-[30%]"><img src="@m.ImgUrl" class="w-full h-20 object-cover rounded" /></div><div class="w-[70%]"><div class="text-xs text-indigo-400 font-bold">@m.StartTime (@m.DurationPlanned m)</div><h4 class="text-base font-bold text-white">@m.Title</h4></div></div> }
            else { <div class="border-l-4 border-indigo-600 pl-2"><div class="text-xs text-indigo-400 font-bold">@m.StartTime (@m.DurationPlanned m)</div><h4 class="text-base font-bold text-white">@m.Title</h4><div class="text-xs text-gray-500">@m.Location</div></div> }
        </div>
    };
    private RenderFragment RenderMediaCard(BulletMedia m, bool compact = false) => __builder => {
         if (compact) { <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-purple-500 transition shadow mb-1 flex items-stretch h-14">@if(!string.IsNullOrEmpty(m.ImgUrl)){<div class="w-10 shrink-0 bg-black"><img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div>}<div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><h4 class="font-bold text-white text-xs truncate">@m.Title</h4>@if(m.Rating>0){<div class="text-xs text-yellow-400">@m.Rating ‚òÖ</div>}</div></div> }
         else { <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-purple-500 transition shadow-lg w-full mb-3 flex flex-row"><div class="absolute top-1 right-1 hidden group-hover:flex gap-1 z-10"><button @onclick='() => EditItem("media", m.Id)' class="p-1 text-gray-400 hover:text-white bg-black/50 rounded">‚úé</button><button @onclick='() => DeleteItem("media", m.Id)' class="p-1 text-red-400 hover:text-red-200 bg-black/50 rounded">‚úï</button></div><div class="w-[40%] bg-black relative">@if(!string.IsNullOrEmpty(m.ImgUrl)){<img src="@m.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 120px;"/>}else{<div class="w-full h-full flex items-center justify-center text-3xl text-gray-700">üé¨</div>}</div><div class="w-[60%] p-3 flex flex-col justify-between"><div><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-white text-base leading-tight truncate mr-2">@m.Title</h4>@if(m.Rating>0){<div class="shrink-0 bg-yellow-900/30 text-yellow-400 text-sm font-bold px-1.5 py-0.5 rounded border border-yellow-700/50">@m.Rating ‚òÖ</div>}</div><p class="text-sm text-gray-400 line-clamp-3">@m.Description</p></div></div></div> }
    };
    private RenderFragment RenderHabitPill(BulletHabit h) => __builder => { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border @(h.IsCompleted?"bg-green-900/40 text-green-200 border-green-800":"bg-orange-900/40 text-orange-200 border-orange-800")">üî• @h.Title</div> };
    private RenderFragment RenderTaskPill(BulletTask t) => __builder => { if(!string.IsNullOrEmpty(t.ImgUrl)){ <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-blue-500 transition shadow mb-1 flex items-stretch h-14"><div class="w-10 shrink-0 bg-black"><img src="@t.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="flex items-center gap-1"><span class="text-xs @(t.IsCompleted?"text-green-500":"text-blue-400")">@(t.IsCompleted?"‚úì":"‚Ä¢")</span><h4 class="font-bold text-white text-xs truncate @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4></div></div></div> } else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border flex items-center gap-1 @(t.IsCompleted?"bg-gray-800 text-gray-500 border-gray-700 line-through":"bg-blue-900/30 text-blue-200 border-blue-800")"><span class="@(t.IsCompleted?"text-green-500":"text-blue-400")">@(t.IsCompleted?"‚úì":"‚Ä¢")</span>@t.Title</div> } };
    private RenderFragment RenderMeetingPill(BulletMeeting m) => __builder => { if(!string.IsNullOrEmpty(m.ImgUrl)){ <div class="bg-gray-900 border border-indigo-900 rounded overflow-hidden group relative hover:border-indigo-500 transition shadow mb-1 flex items-stretch h-14"><div class="w-10 shrink-0 bg-black"><img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-indigo-300 font-bold leading-none mb-0.5">@m.StartTime</div><div class="font-bold text-white text-[10px] truncate">@m.Title</div></div></div> } else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-indigo-800 bg-indigo-900/30 text-indigo-200"><span class="font-bold">@m.StartTime</span> @m.Title</div> } };

    // --- CORE LOGIC ---
    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private void CloseMenus() { showUserMenu = false; }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }
    private void SwitchView(string view) { currentView = view; StateHasChanged(); }
    private void Prev() { if (currentView == "day") viewDate = viewDate.AddDays(-1); else if (currentView == "week") viewDate = viewDate.AddDays(-7); else viewDate = viewDate.AddMonths(-1); }
    private void Next() { if (currentView == "day") viewDate = viewDate.AddDays(1); else if (currentView == "week") viewDate = viewDate.AddDays(7); else viewDate = viewDate.AddMonths(1); }
    private void GoToday() { viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); SwitchView("day"); }
    private void GoToDate(DateTime d) { viewDate = d; SwitchView("day"); }
    private string GetHeaderDate() => currentView == "day" ? viewDate.ToString("dddd, MMMM d, yyyy") : (currentView == "week" ? $"Week of {GetStartOfWeek(viewDate):MMM d, yyyy}" : viewDate.ToString("MMMM yyyy"));
    private DateTime GetStartOfWeek(DateTime d) => d.AddDays(-1 * ((7 + (d.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private List<BulletMedia> GetMediaForDate(DateTime d) => AllMedia.Where(m => m.Date.Date == d.Date).ToList();
    private List<BulletTask> GetTasksForDate(DateTime d, string? category = null) { var t = AllTasks.Where(x => x.Date.Date == d.Date); return category == null ? t.ToList() : t.Where(x => x.Category == category).ToList(); }
    private List<BulletMeeting> GetMeetingsForDate(DateTime d) => AllMeetings.Where(m => m.Date.Date == d.Date).OrderBy(m => m.StartTime).ToList();
    private List<BulletHabit> GetHabitsForDate(DateTime d) => AllHabits.Where(h => h.Date.Date == d.Date).ToList();
    private async Task LoadData() {
        if (currentUser == null) return;
        try {
            AllMedia = await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllTasks = await Db.Set<BulletTask>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllMeetings = await Db.Set<BulletMeeting>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllHabits = await Db.Set<BulletHabit>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            StateHasChanged();
        } catch (Exception ex) { if (ex.Message.Contains("42P01")) { isDbError = true; errorMessage = "Missing Tables."; } }
    }
    // IMPORTER Logic
    private void Log(string msg) { debugLogs.Add($"{DateTime.Now:HH:mm:ss} - {msg}"); InvokeAsync(StateHasChanged); }
    private void ClearLogs() => debugLogs.Clear();
    private async Task CopyLogs() { var text = string.Join("\n", debugLogs); await JS.InvokeVoidAsync("copyTextToClipboard", text); Log("Logs copied."); }
    private async Task ImportList<T>(string typeName, Func<JsonElement, T?> mapper, DbSet<T> table) where T : class {
        if (currentUser == null) return;
        isImporting = true; debugLogs.Clear(); Log($"Scanning for {typeName}s...");
        try {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if (!File.Exists(filePath)) { Log("File not found."); return; }
            var jsonContent = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(jsonContent); var root = doc.RootElement;
            List<JsonElement> rawList = new();
            if (root.ValueKind == JsonValueKind.Array) { foreach (var el in root.EnumerateArray()) rawList.Add(el); }
            else if (root.ValueKind == JsonValueKind.Object) { if (root.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array) foreach (var el in items.EnumerateArray()) rawList.Add(el); }
            var newItems = new List<T>();
            foreach (var raw in rawList) {
                string type = ""; if (raw.TryGetProperty("type", out var t)) type = t.ToString().ToLower();
                if (type != typeName.ToLower()) continue;
                try { var mapped = mapper(raw); if (mapped != null) newItems.Add(mapped); } catch (Exception ex) { Log($"Error mapping: {ex.Message}"); }
            }
            if (newItems.Any()) { await table.AddRangeAsync(newItems); await Db.SaveChangesAsync(); Log($"Imported {newItems.Count} {typeName}s."); await LoadData(); } else { Log($"No {typeName}s found."); }
        } catch (Exception ex) { Log($"Error: {ex.Message}"); } finally { isImporting = false; }
    }
    private async Task ImportTasks() => await ImportList("task", MapTask, Db.Set<BulletTask>());
    private async Task ImportMedia() => await ImportList("media", MapMedia, Db.Set<BulletMedia>());
    private async Task ImportMeetings() => await ImportList("meeting", MapMeeting, Db.Set<BulletMeeting>());
    private async Task ImportHabits() => await ImportList("habit", MapHabit, Db.Set<BulletHabit>());
    private BulletHabit? MapHabit(JsonElement raw) { var item = new BulletHabit { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("streakCount", out var sc) && sc.TryGetInt32(out int s)) item.StreakCount = s; if (raw.TryGetProperty("status", out var st) && st.ToString() == "completed") item.IsCompleted = true; if (raw.TryGetProperty("isCompleted", out var ic) && ic.ValueKind == JsonValueKind.True) item.IsCompleted = true; if (raw.TryGetProperty("notes", out var n)) item.Notes = n.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletTask? MapTask(JsonElement raw) { var item = new BulletTask { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString(); if (raw.TryGetProperty("ticketNumber", out var tn)) item.TicketNumber = tn.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("status", out var s) && s.ToString() == "completed") item.IsCompleted = true; if (raw.TryGetProperty("isCompleted", out var ic) && ic.ValueKind == JsonValueKind.True) item.IsCompleted = true; if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletMedia? MapMedia(JsonElement raw) { var item = new BulletMedia { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("rating", out var r) && r.TryGetInt32(out int rate)) item.Rating = rate; if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletMeeting? MapMeeting(JsonElement raw) { var item = new BulletMeeting { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("startTime", out var st)) item.StartTime = st.ToString(); if (raw.TryGetProperty("durationMinutes", out var dm) && dm.TryGetInt32(out int plan)) item.DurationPlanned = plan; if (raw.TryGetProperty("timeSpentMinutes", out var am) && am.TryGetInt32(out int act)) item.DurationActual = act; if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private async Task WipeAll() { if (await JS.InvokeAsync<bool>("confirm", "Delete ALL Bullet Data?")) { Db.Set<BulletTask>().RemoveRange(await Db.Set<BulletTask>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletMedia>().RemoveRange(await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletMeeting>().RemoveRange(await Db.Set<BulletMeeting>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletHabit>().RemoveRange(await Db.Set<BulletHabit>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); await Db.SaveChangesAsync(); await LoadData(); } }
    private async Task WipeTasks() { if (await JS.InvokeAsync<bool>("confirm", "Delete All Tasks?")) { Db.Set<BulletTask>().RemoveRange(await Db.Set<BulletTask>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); await Db.SaveChangesAsync(); await LoadData(); } }
    private async Task UpgradeDatabase() { try { await Db.Database.ExecuteSqlRawAsync(@"CREATE TABLE IF NOT EXISTS ""BulletMedia"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'Movie', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""Rating"" integer DEFAULT 0, ""ReleaseYear"" integer DEFAULT 0, ""Actors"" text DEFAULT '', ""Tags"" text DEFAULT '', ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletTasks"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'task', ""IsCompleted"" boolean DEFAULT false, ""Priority"" text DEFAULT 'Normal', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""TicketNumber"" text, ""TicketUrl"" text, ""Tags"" text, ""DueDate"" timestamp with time zone, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletMeetings"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'work', ""Type"" text DEFAULT 'meeting', ""StartTime"" text DEFAULT '', ""DurationPlanned"" integer DEFAULT 0, ""DurationActual"" integer DEFAULT 0, ""Location"" text DEFAULT '', ""MeetingLeader"" text DEFAULT '', ""Attendees"" text DEFAULT '', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""IsCompleted"" boolean DEFAULT false, ""Tags"" text DEFAULT '', ""Description"" text, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletHabits"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'habit', ""StreakCount"" integer DEFAULT 0, ""TargetStreak"" integer DEFAULT 0, ""IsCompleted"" boolean DEFAULT false, ""Notes"" text DEFAULT '', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Tags"" text DEFAULT '', ""OriginalStringId"" text);"); isDbError = false; await LoadData(); Log("Tables Created Successfully"); } catch (Exception ex) { errorMessage = ex.Message; Log($"DB Error: {ex.Message}"); } }
    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"‚õÖ", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}