@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Dashboard.Helpers
@using Dashboard.Services
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Globalization
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject BulletOrchestratorService Orchestrator
@inject BulletNavigationService NavService
@inject BulletSearchService SearchService
@inject BulletPrintService PrintService
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Calendar | Stephens' Dashboard</PageTitle>

<div class="min-h-screen bg-gray-900 text-white pb-40 relative font-sans">
    
    <div class="sticky top-0 z-40 bg-gray-900 border-b border-gray-800 shadow-2xl">
        <BulletHeader 
            ShowControls="true"
            CustomDateText="@NavService.GetHeaderDateText()"
            ActiveView="@NavService.CurrentView"
            OnPrev="HandlePrev"
            OnNext="HandleNext"
            OnGoToday="HandleGoToday"
            OnViewChanged="HandleSwitchView"
            OnCloneRequest="HandleShowCloner"
            OnToggleCompact="HandleToggleMonthCompact"
            OnExportPdf="HandleExportPdf">
            
            <div class="flex items-center gap-2 ml-4 font-black">
                <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black shadow-inner">
                    <input @bind="SearchService.Query" 
                           @bind:event="oninput" 
                           @onkeyup="HandleKeyUp" 
                           placeholder="Search..." 
                           class="bg-transparent border-none text-xs py-1.5 px-2 w-24 md:w-32 outline-none text-white font-black" />
                    
                    @if (!string.IsNullOrEmpty(SearchService.Query))
                    {
                        <button @onclick="HandleClearSearch" 
                                class="p-1 text-gray-500 hover:text-red-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    }

                    <button @onclick="ToggleAdvancedSearch" 
                            class="p-1 text-gray-500 hover:text-blue-400 transition-colors" 
                            title="Advanced Filters">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                    </button>
                </div>

                <TemporalJumpGrid SelectedDate="NavService.ViewDate" 
                                  UserId="userId" 
                                  OnDateSelected="HandleGoToDate" />
            </div>
        </BulletHeader>
    </div>

    <div class="px-6 pt-4 font-black">
        @if (SearchService.IsSearching)
        {
            <div class="h-full flex flex-col font-black">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-sm font-black text-blue-400">Search Results (@SearchService.Results.Count)</h2>
                        @if (SearchService.TotalPages > 1)
                        {
                            <div class="flex items-center gap-2 bg-black/40 px-2 py-1 rounded-lg border border-gray-800 shadow-xl">
                                <button @onclick="HandleSearchPrevPage" 
                                        disabled="@(SearchService.CurrentPage == 1)" 
                                        class="text-[10px] text-gray-400 hover:text-white disabled:opacity-30">
                                    PREV
                                </button>
                                <span class="text-[10px] text-gray-600 font-black">
                                    Page @SearchService.CurrentPage of @SearchService.TotalPages
                                </span>
                                <button @onclick="HandleSearchNextPage" 
                                        disabled="@(SearchService.CurrentPage == SearchService.TotalPages)" 
                                        class="text-[10px] text-gray-400 hover:text-white disabled:opacity-30">
                                    NEXT
                                </button>
                            </div>
                        }
                    </div>
                    <button @onclick="HandleClearSearch" 
                            class="text-[10px] font-bold text-gray-400 hover:text-red-400 tracking-widest transition-colors">
                        Close Results
                    </button>
                </div>

                <div class="pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        @foreach (var item in SearchService.GetPagedResults()) 
                        {
                            <div class="h-full border border-gray-800 rounded-xl overflow-hidden bg-gray-800/20 p-1 relative shadow-2xl">
                                <button @onclick="() => HandleGoToDate(item.Date)" 
                                        @onclick:stopPropagation="true" 
                                        class="absolute top-2 left-2 z-20 bg-blue-600 hover:bg-blue-500 text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg cursor-pointer transition-colors border-none outline-none font-black">
                                    @item.Date.ToString("MMM dd, yyyy")
                                </button>
                                <BulletItemSwitcher Item="item" 
                                                   Mode="Card" 
                                                   User="currentUser" 
                                                   ShowControls="false"
                                                   OnEdit="OpenEdit" 
                                                   OnToggle="ToggleComplete" 
                                                   OnDelete="@(async (id) => await DeleteTask(id))"
                                                   OnCopyRequest="InitiateDeepCopy"
                                                   OnMoveUp="() => MoveItem(item, -1, true)" 
                                                   OnMoveDown="() => MoveItem(item, 1, true)" 
                                                   OnHabitSave="SaveHabitDirectly"
                                                   OnHabitSkip="HandleHabitSkip"
                                                   OnCopyMeal="@(m => HandleMealCopy(item, m))"
                                                   OnCopyWorkout="@(w => HandleWorkoutCopy(item, w))" />
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (NavService.CurrentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 font-black ">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10 font-black ">
                            <span class="font-bold text-@cat.Item3-400 tracking-wider text-sm font-black">
                                @cat.Item1
                            </span>
                            <button @onclick='async () => await OpenEditor(cat.Item2, cat.Item2 == "health" ? "health" : "task", NavService.ViewDate)' 
                                    class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition font-bold tracking-widest shadow-md font-black ">
                                ＋ Add
                            </button>
                        </div>
                        <div class="p-3 space-y-3 font-bold font-black ">
                            
                            @if(isLoading) 
                            { 
                                <div class="text-center text-gray-500 text-xs italic mt-4 animate-pulse tracking-widest font-black ">
                                    Syncing...
                                </div> 
                            }
                            else 
                            {
                                var dayItems = BulletDataLogic.GetItemsForColumn(loadedItems, NavService.ViewDate, cat.Item2);
                                var sortedItems = BulletDataLogic.GetSortedItems(dayItems);
                                
                                foreach(var item in sortedItems) 
                                { 
                                    <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" 
                                                       Item="item" 
                                                       Mode="Card" 
                                                       User="currentUser" 
                                                       OnEdit="OpenEdit" 
                                                       OnToggle="ToggleComplete" 
                                                       OnDelete="@(async (id) => await DeleteTask(id))"
                                                       OnCopyRequest="InitiateDeepCopy"
                                                       OnMoveUp="() => MoveItem(item, -1, true)" 
                                                       OnMoveDown="() => MoveItem(item, 1, true)" 
                                                       OnHabitSave="SaveHabitDirectly"
                                                       OnHabitSkip="HandleHabitSkip"
                                                       OnCopyMeal="@(m => HandleMealCopy(item, m))"
                                                       OnCopyWorkout="@(w => HandleWorkoutCopy(item, w))" />
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (NavService.CurrentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 font-sans font-bold font-black ">
                @for(int i = 0; i < 7; i++) 
                {
                    var d = NavService.GetWeekStart().AddDays(i);
                    
                    <div class="flex flex-col rounded-xl border @GetDayBorderClass(d) overflow-hidden bg-gray-800/40 shadow-xl font-black ">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700 transition" 
                             @onclick="() => HandleGoToDate(d)">
                            <div class="text-[10px] font-black text-gray-500 font-black ">@d.ToString("ddd")</div>
                            <div class="text-lg font-black text-white font-black ">@d.Day</div>
                        </div>
                        <div class="p-1 space-y-1 font-black ">
                            @{
                                var weekItems = BulletDataLogic.GetItemsForDate(loadedItems, d);
                                var sortedWeekItems = BulletDataLogic.GetSortedItems(weekItems);
                            }
                            @foreach(var item in sortedWeekItems) 
                            { 
                                <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" 
                                                   Item="item" 
                                                   Mode="Pill" 
                                                   User="currentUser" 
                                                   OnEdit="OpenEdit" 
                                                   OnCopyRequest="InitiateDeepCopy"
                                                   OnMoveUp="HandlePillReorder" 
                                                   OnMoveDown="HandlePillReorder" />
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (NavService.CurrentView == "month")
        {
            <div class="flex flex-col font-sans font-black font-black ">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2 text-[10px] text-gray-500 font-black ">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"})
                    { 
                        <div class="font-black ">@day</div> 
                    }
                </div>
                <div class="grid grid-cols-7 gap-1 auto-rows-fr font-black">
                    @for(int i = 0; i < GetMonthEmptyCells(); i++) 
                    { 
                        <div class="bg-gray-900/30 rounded-lg h-32"></div> 
                    }
                    @for(int d = 1; d <= GetDaysInMonth(); d++)
                    {
                        var currentDay = new DateTime(NavService.ViewDate.Year, NavService.ViewDate.Month, d);
                        
                        <div class="relative flex flex-col rounded-lg border @GetDayBorderClass(currentDay) p-1 hover:bg-gray-800 transition cursor-pointer bg-gray-900/50 shadow-inner font-black 
                             @(NavService.IsMonthCompact ? "h-36 overflow-hidden" : "min-h-[120px]")" 
                             @onclick="() => HandleGoToDate(currentDay)">
                            
                            <div class="text-right text-[10px] font-bold text-gray-500 mb-1 font-black ">@d</div>
                            <div class="space-y-1 font-black">
                                @{
                                    var monthItems = BulletDataLogic.GetItemsForDate(loadedItems, currentDay);
                                    var sortedMonthItems = BulletDataLogic.GetSortedItems(monthItems);
                                }
                                
                                @foreach(var item in sortedMonthItems.Take(NavService.IsMonthCompact ? 3 : 999)) 
                                { 
                                    <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" 
                                                       Item="item" 
                                                       Mode="Pill" 
                                                       User="currentUser" 
                                                       OnEdit="OpenEdit" 
                                                       OnCopyRequest="InitiateDeepCopy"
                                                       OnMoveUp="HandlePillReorder" 
                                                       OnMoveDown="HandlePillReorder" />
                                }

                                @if (NavService.IsMonthCompact && sortedMonthItems.Count > 3)
                                {
                                    <div class="text-[9px] font-black text-blue-400 mt-1 pl-1 italic">
                                        +@(sortedMonthItems.Count - 3) more...
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(toastMessage))
    {
        <div class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] bg-red-600/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl font-black border border-white/20 animate-pulse">
            @toastMessage
        </div>
    }
</div>

<BulletSearchModal 
    @bind-SearchStart="SearchService.Start" 
    @bind-SearchEnd="SearchService.End" 
    @bind-SearchType="SearchService.Type" 
    IsVisible="showAdvancedSearch" 
    OnClose="HideAdvancedSearch" 
    OnSearchRequested="HandleExecuteAdvancedSearch" />

<BulletClonerModal 
    IsVisible="showTemporalCloneModal" 
    @bind-SourceYear="cloneSourceYear" 
    @bind-TargetYear="cloneTargetYear" 
    @bind-IncludeBirthdays="includeBirthdays" 
    @bind-IncludeAnniversaries="includeAnniversaries" 
    @bind-IncludeHolidays="includeHolidays" 
    OnClose="HideCloner" 
    OnCloneRequested="ExecuteClone" />

<BulletCopyModal 
    IsVisible="showCopyModal" 
    ItemType="@itemToCopy?.Type" 
    OnCancel="() => showCopyModal = false" 
    OnConfirm="@(async (options) => await ExecuteCopy((options.date, options.notes, options.todos, false)))" />

<BaseEditor Item="editingItem" 
            TaskDetail="editingItem?.Detail ?? new()" 
            MeetingDetail="editingItem?.MeetingDetail ?? new()"
            BirthdayDetail="editingItem?.BirthdayDetail ?? new()"
            HealthDetail="editingItem?.HealthDetail ?? new()"
            HabitDetail="editingItem?.HabitDetail ?? new()"
            MediaDetail="editingItem?.MediaDetail ?? new()"
            HolidayDetail="editingItem?.HolidayDetail ?? new()"
            AnniversaryDetail="editingItem?.AnniversaryDetail ?? new()"
            VacationDetail="editingItem?.VacationDetail ?? new()"
            SportsDetail="editingItem?.SportsDetail ?? new()"
            Leagues="leagues"
            Seasons="seasons"
            Teams="teams"
            Notes="editingItem?.Notes ?? new List<BulletItemNote>()"
            OnSaveRecurring="HandleSave" 
            OnCancel="CancelEditing" 
            OnDelete="@(async () => await DeleteCurrentTask())" />

@code {
    #region State Variables

    private User? currentUser;
    private int userId = 0;
    private bool isLoading = true;
    private List<BulletTaskService.TaskDTO> loadedItems = new();

    private List<League> leagues = new();
    private List<Season> seasons = new();
    private List<Team> teams = new();

    private List<BulletMeetingService.MeetingDTO> _meetings = new();
    private List<BulletBirthdayService.BirthdayDTO> _bdays = new();
    private List<BulletVacationService.VacationDTO> _vacations = new();
    private List<BulletHolidayService.HolidayDTO> _holidays = new();
    private List<BulletAnniversaryService.AnniversaryDTO> _anniversaries = new();
    private List<BulletMediaService.MediaDTO> _media = new();
    private List<BulletSportsService.GameDTO> _sports = new();
    private List<BulletHealthService.HealthDTO> loadedHealth = new();
    private List<BulletHabitService.HabitDTO> loadedHabits = new();

    private BulletTaskService.TaskDTO? editingItem;
    private BulletTaskService.TaskDTO? itemToCopy;
    private object? pendingSubItem;

    private bool showAdvancedSearch = false;
    private bool showCopyModal = false;
    private string toastMessage = "";

    private bool showTemporalCloneModal = false;
    private int cloneSourceYear = DateTime.Today.Year;
    private int cloneTargetYear = DateTime.Today.Year + 1;
    private bool includeBirthdays = true;
    private bool includeAnniversaries = true;
    private bool includeHolidays = true;

    private const int pageSize = 50;

    #endregion

    #region Lifecycle

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                
                if (!string.IsNullOrEmpty(json))
                {
                    using var doc = JsonDocument.Parse(json);
                    
                    if (doc.RootElement.TryGetProperty("UserId", out var p) || 
                        doc.RootElement.TryGetProperty("userId", out p))
                    {
                        userId = p.GetInt32();
                    }

                    if (userId > 0)
                    {
                        currentUser = await Db.Users.FindAsync(userId);
                        
                        NavService.ClientOffsetMinutes = await JS.InvokeAsync<int>(
                            "eval", 
                            "new Date().getTimezoneOffset()"
                        );
                        
                        var uri = Nav.ToAbsoluteUri(Nav.Uri);
                        
                        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("date", out var dVal) && 
                            DateTime.TryParse(dVal, out var parsed))
                        {
                            NavService.SetViewDate(parsed);
                        }
                        else
                        {
                            NavService.GoToday();
                        }

                        leagues = await Db.Leagues.OrderBy(x => x.Name).ToListAsync() ?? new();
                        seasons = await Db.Seasons.ToListAsync() ?? new();
                        teams = await Db.Teams.ToListAsync() ?? new();
                        
                        await LoadData();
                    }
                }
            }
            catch (Exception ex) 
            { 
                await LogToConsole($"Init Fail: {ex.Message}"); 
            }
            finally 
            { 
                isLoading = false; 
                StateHasChanged(); 
            }
        }
    }

    #endregion

    #region Data Loading

    private async Task LoadData()
    {
        if (currentUser == null) return;

        isLoading = true;
        StateHasChanged();

        DateTime s = DateTime.SpecifyKind(NavService.ViewDate.Date, DateTimeKind.Utc);
        DateTime e = s.AddDays(1).AddSeconds(-1);

        if (NavService.CurrentView == "week") 
        { 
            s = NavService.GetWeekStart(); 
            e = s.AddDays(7).AddSeconds(-1); 
        }
        else if (NavService.CurrentView == "month") 
        { 
            s = new DateTime(NavService.ViewDate.Year, NavService.ViewDate.Month, 1); 
            e = s.AddMonths(1).AddSeconds(-1); 
        }

        try
        {
            loadedItems.Clear();

            loadedItems.AddRange(await TaskService.GetTasksForRange(userId, s, e));

            _meetings = await MeetingService.GetMeetingsForRange(userId, s, e);
            foreach (var m in _meetings) { loadedItems.Add(BulletMapper.MapMeeting(m)); }

            _bdays = await BirthdayService.GetBirthdaysForRange(userId, s, e);
            foreach (var b in _bdays) { loadedItems.Add(BulletMapper.MapBirthday(b)); }

            _vacations = await VacationService.GetVacationsForRange(userId, s, e);
            foreach (var v in _vacations) { loadedItems.Add(BulletMapper.MapVacation(v)); }

            _holidays = await HolidayService.GetHolidaysForRange(userId, s, e);
            foreach (var h in _holidays) { loadedItems.Add(BulletMapper.MapHoliday(h)); }

            _anniversaries = await AnniversaryService.GetAnniversariesForRange(userId, s, e);
            foreach (var a in _anniversaries) { loadedItems.Add(BulletMapper.MapAnniversary(a)); }

            _sports = await SportsService.GetGamesForRange(userId, s, e);
            foreach (var g in _sports) { loadedItems.Add(BulletMapper.MapGame(g)); }

            _media = await MediaService.GetMedia(userId);
            foreach (var m in _media.Where(x => x.Date.Date >= s.Date && x.Date.Date <= e.Date)) { loadedItems.Add(BulletMapper.MapMedia(m)); }

            loadedHealth = await HealthService.GetHealthItemsForRange(userId, s, e);
            foreach (var h in loadedHealth) { loadedItems.Add(BulletMapper.MapHealth(h)); }

            loadedHabits = await HabitService.GetHabits(userId);
            foreach (var h in loadedHabits.Where(x => x.Date.Date >= s.Date && x.Date.Date <= e.Date)) { loadedItems.Add(BulletMapper.MapHabit(h)); }
        }
        catch (Exception ex) 
        { 
            await LogToConsole($"Sync Error: {ex.Message}"); 
        }

        isLoading = false; 
        StateHasChanged();
    }

    #endregion

    #region Navigation Handlers

    private async Task HandlePrev()
    {
        SearchService.IsSearching = false; 
        NavService.MovePrev();
        await LoadData();
    }

    private async Task HandleNext()
    {
        SearchService.IsSearching = false; 
        NavService.MoveNext();
        await LoadData();
    }

    private async Task HandleGoToday()
    {
        SearchService.ClearSearch(); 
        NavService.GoToday();
        await LoadData();
    }

    private async Task HandleGoToDate(DateTime d)
    {
        SearchService.ClearSearch(); 
        NavService.SetViewDate(d);
        NavService.SetView("day");
        await LoadData();
    }

    private async Task HandleSwitchView(string view)
    {
        SearchService.IsSearching = false; 
        NavService.SetView(view);
        await LoadData();
    }

    private async Task HandleToggleMonthCompact()
    {
        NavService.ToggleMonthCompact();
        StateHasChanged();
    }

    private async Task HandleExportPdf()
    {
        // Simply tell the browser to open the new print-all page in a new tab
        var url = $"/year-book-print-all/{NavService.ViewDate.Year}";
        await JS.InvokeVoidAsync("open", url, "_blank");
    }

    private int GetDaysInMonth()
    {
        return DateTime.DaysInMonth(NavService.ViewDate.Year, NavService.ViewDate.Month);
    }

    private int GetMonthEmptyCells()
    {
        var firstDay = new DateTime(NavService.ViewDate.Year, NavService.ViewDate.Month, 1);
        return ((int)firstDay.DayOfWeek + 6) % 7;
    }

    private string GetDayBorderClass(DateTime date)
    {
        var today = DateTime.UtcNow.AddMinutes(-NavService.ClientOffsetMinutes).Date;
        if (date.Date == today) return "border-yellow-500 shadow-lg";
        return "border-gray-700";
    }

    #endregion

    #region CRUD & Deep Copy

    private async Task HandleSave(BaseEditor.RecurrenceRequest req)
    {
        if (editingItem == null) return;
        try 
        { 
            await Orchestrator.ProcessSaveRequest(editingItem, req); 
            editingItem = null; 
            await LoadData(); 
        }
        catch (Exception ex) { await LogToConsole($"Save Error: {ex.Message}"); }
    }

    private void InitiateDeepCopy(BulletTaskService.TaskDTO item)
    {
        itemToCopy = item;
        pendingSubItem = null;
        showCopyModal = true;
    }

    private void HandleMealCopy(BulletTaskService.TaskDTO parent, BulletHealthMeal meal)
    {
        itemToCopy = parent;
        pendingSubItem = meal;
        showCopyModal = true;
    }

    private void HandleWorkoutCopy(BulletTaskService.TaskDTO parent, BulletHealthWorkout workout)
    {
        itemToCopy = parent;
        pendingSubItem = workout;
        showCopyModal = true;
    }

    private async Task HandleHabitSkip(BulletTaskService.TaskDTO item)
    {
        try 
        {
            await Orchestrator.SkipHabitInstance(item);
            await LoadData();
            toastMessage = "Habit instance skipped and future streaks adjusted.";
            _ = Task.Delay(2000).ContinueWith(_ => { toastMessage = ""; InvokeAsync(StateHasChanged); });
        }
        catch (Exception ex) { await LogToConsole($"Skip Error: {ex.Message}"); }
    }

    private async Task ExecuteCopy((DateTime date, bool notes, bool todos, bool move) options)
    {
        if (itemToCopy == null) return;
        try
        {
            if (pendingSubItem != null)
            {
                await Orchestrator.CloneHealthSubItem(itemToCopy, options.date, pendingSubItem);
                pendingSubItem = null;
            }
            else
            {
                await Orchestrator.DeepCloneItem(itemToCopy, options.date, options.notes, options.todos, options.move);
            }
            showCopyModal = false;
            itemToCopy = null;
            await LoadData();
        }
        catch (Exception ex) { await LogToConsole($"Copy Error: {ex.Message}"); }
    }

    private async Task DeleteTask(int id) 
    { 
        var item = loadedItems.FirstOrDefault(x => x.Id == id) ?? SearchService.Results.FirstOrDefault(x => x.Id == id);
        var title = item?.Title ?? "Item";
        await BaseService.DeleteItem(id); 
        toastMessage = $"✕ {title} deleted";
        StateHasChanged();
        if (SearchService.IsSearching) await SearchService.ExecuteSearch(userId);
        else await LoadData(); 

        _ = Task.Delay(2000).ContinueWith(_ => {
            toastMessage = "";
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task DeleteCurrentTask() 
    { 
        if (editingItem != null && editingItem.Id > 0)
        {
            await BaseService.DeleteItem(editingItem.Id); 
            editingItem = null; 
            await LoadData(); 
        }
    }

    private async Task ToggleComplete(BulletTaskService.TaskDTO t) 
    { 
        try { await Orchestrator.CommitItemToDatabase(t); } 
        catch (Exception ex) { await LogToConsole($"Toggle Fail: {ex.Message}"); } 
    }

    private async Task SaveHabitDirectly(BulletHabitService.HabitDTO h) 
    { 
        await HabitService.SaveHabit(h); 
    }

    private async Task MoveItem(BulletTaskService.TaskDTO item, int direction, bool useCategory = false)
    {
        List<BulletTaskService.TaskDTO> list;
        if (useCategory) list = BulletDataLogic.GetSortedItems(BulletDataLogic.GetItemsForColumn(loadedItems, item.Date, item.Category));
        else list = BulletDataLogic.GetSortedItems(BulletDataLogic.GetItemsForDate(loadedItems, item.Date));

        int currentIndex = list.FindIndex(x => x.Id == item.Id && x.Type == item.Type);
        if (currentIndex == -1) return;

        int newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= list.Count) return;
        
        var targetItem = list[newIndex];
        await Orchestrator.SwapSortOrders(item.Id, targetItem.Id, list);
        await LoadData();
    }

    #endregion

    #region Editor Handlers

    private void CancelEditing() { editingItem = null; }

    private void OpenEdit(BulletTaskService.TaskDTO t) 
    { 
        editingItem = BulletMapper.CreateCopy(t); 
        editingItem.Id = t.Id; 
        editingItem.MeetingDetail ??= new(); 
        editingItem.HabitDetail ??= new(); 
        editingItem.MediaDetail ??= new(); 
        editingItem.HolidayDetail ??= new(); 
        editingItem.BirthdayDetail ??= new(); 
        editingItem.AnniversaryDetail ??= new(); 
        editingItem.VacationDetail ??= new(); 
        editingItem.HealthDetail ??= new(); 
        editingItem.SportsDetail ??= new(); 
        editingItem.Notes ??= new List<BulletItemNote>(); 
        editingItem.Todos ??= new List<BulletTaskTodoItem>(); 
    }

    private async Task OpenEditor(string category, string type, DateTime date) 
    { 
        await OpenNewEditor(category, type, date); 
    }

    private async Task OpenNewEditor(string cat, string type, DateTime targetDate) 
    { 
        var newItem = new BulletTaskService.TaskDTO 
        { 
            UserId = userId, Category = cat, Type = type, 
            Date = targetDate, Detail = new(), HealthDetail = new(), 
            MeetingDetail = new(), HabitDetail = new(), HolidayDetail = new(), 
            BirthdayDetail = new(), AnniversaryDetail = new(), VacationDetail = new(), 
            MediaDetail = new(), SportsDetail = new(), Notes = new List<BulletItemNote>(), 
            Todos = new List<BulletTaskTodoItem>() 
        }; 

        if (type == "health") 
        { 
            try 
            { 
                var lastHealth = await Db.BulletHealthDetails.Include(d => d.BulletItem)
                    .Where(h => h.BulletItem.UserId == userId && h.BulletItem.Type == "health" && h.BulletItem.Date < targetDate)
                    .OrderByDescending(h => h.BulletItem.Date)
                    .FirstOrDefaultAsync(); 

                if (lastHealth != null && lastHealth.WeightLbs > 0) newItem.HealthDetail.WeightLbs = lastHealth.WeightLbs; 
            } 
            catch { } 
        } 
        editingItem = newItem; 
    }

    #endregion

    #region Search Handlers

    private async Task HandleKeyUp(KeyboardEventArgs e) 
    { 
        if (e.Key == "Enter") await SearchService.ExecuteSearch(userId); 
        if (e.Key == "Escape") HandleClearSearch(); 
    }

    private void HandleClearSearch() 
    { 
        SearchService.ClearSearch(); 
        _ = LoadData(); 
    }

    private void ToggleAdvancedSearch() { showAdvancedSearch = !showAdvancedSearch; }
    private void HideAdvancedSearch() { showAdvancedSearch = false; }

    private async Task HandleExecuteAdvancedSearch() 
    { 
        showAdvancedSearch = false; 
        await SearchService.ExecuteSearch(userId); 
    }

    private void HandleSearchPrevPage() { SearchService.MoveToPrevPage(); }
    private void HandleSearchNextPage() { SearchService.MoveToNextPage(); }

    #endregion

    #region Cloning Logic

    private void HandleShowCloner() { showTemporalCloneModal = true; }
    private void HideCloner() { showTemporalCloneModal = false; }

    private async Task ExecuteClone() 
    { 
        var count = await BaseService.CloneYearlyItems(userId, cloneSourceYear, cloneTargetYear, includeBirthdays, includeAnniversaries, includeHolidays); 
        showTemporalCloneModal = false; 
        await JS.InvokeVoidAsync("alert", $"Successfully created {count} new items for {cloneTargetYear}!"); 
        await LoadData(); 
    }

    private async Task HandlePillReorder(int id) 
    { 
        var item = loadedItems.FirstOrDefault(x => x.Id == id); 
        if (item == null) return; 
        await MoveItem(item, 0, false); 
    }

    private async Task LogToConsole(string msg) { await JS.InvokeVoidAsync("console.log", $"[CALENDAR] {msg}"); }

    #endregion
}