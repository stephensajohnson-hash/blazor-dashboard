@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.IO
@using System.Net.Http.Headers
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Setup Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">
                Create Missing Tables
            </button>
        </div>
    }
    else
    {
        <main class="w-full p-6 relative h-screen flex flex-col" @onclick="CloseMenus">
            
            <div class="mb-4 border-b border-gray-800 pb-2 flex items-center justify-between shrink-0">
                <div class="min-w-[200px]">
                    <div class="flex flex-col">
                        <h2 class="text-2xl font-bold text-white tracking-tight">@GetHeaderDate()</h2>
                        <span class="text-lg font-medium text-gray-400">@CurrentTime</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <div class="flex items-center gap-4 border-r border-gray-600 pr-4">
                        <a href="/" class="text-xl hover:scale-125 transition grayscale-0" title="Home">üè†</a>
                        <a href="/recipes" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @onclick="Prev" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚óÄ</button>
                        <button @onclick="GoToday" class="px-3 h-8 flex items-center justify-center bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider transition">Today</button>
                        <div class="flex bg-gray-900/50 rounded-lg p-1">
                            <button @onclick='() => SwitchView("day")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Day</button>
                            <button @onclick='() => SwitchView("week")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Week</button>
                            <button @onclick='() => SwitchView("month")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Month</button>
                        </div>
                        <button @onclick="Next" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚ñ∂</button>
                    </div>
                </div>

                <div class="flex items-center gap-6 min-w-[200px] justify-end">
                    @if (weather?.current != null)
                    {
                        <div class="flex items-center gap-3 bg-gray-800/30 px-3 py-1.5 rounded-xl border border-gray-700/30">
                            <div class="flex items-center gap-2 pr-3 border-r border-gray-600">
                                <span class="text-xl">@GetWeatherIcon(weather.current.weather_code)</span>
                                <div class="font-bold text-white text-base leading-none">@weather.current.temperature_2m.ToString("0")¬∞</div>
                            </div>
                            <div class="flex gap-2">
                                @if (weather.daily?.time != null) {
                                    @for (int i = 1; i <= 5 && i < weather.daily.time.Length; i++) {
                                        <div class="flex flex-col items-center">
                                            <span class="text-[8px] text-gray-500 font-bold uppercase">@GetDayName(weather.daily.time[i])</span>
                                            <span class="text-[9px]">@GetWeatherIcon(weather.daily.weather_code[i])</span>
                                            <div class="text-[7px] font-mono flex gap-0.5"><span class="text-white">@weather.daily.temperature_2m_max[i].ToString("0")¬∞</span><span class="text-gray-500">@weather.daily.temperature_2m_min[i].ToString("0")¬∞</span></div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }

                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu" @onclick:stopPropagation="true">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                                 class="w-9 h-9 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu) {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <button type="button" @onclick="() => { showImportModal = true; showUserMenu = false; }" class="w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üìÇ</span> Import Data</button>
                                <a href="settings" class="block w-full text-left text-xs text-gray-300 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>‚öôÔ∏è</span> Settings</a>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if(currentView == "day")
            {
                @foreach(var h in GetHolidaysForDate(viewDate))
                {
                    <div class="mb-4 w-full h-32 rounded-xl overflow-hidden bg-gray-800 border border-gray-700 flex shadow-2xl relative group">
                        @RenderActions("holiday", h.Id)
                        @if(!string.IsNullOrEmpty(h.ImgUrl)) {
                            <img src="@h.ImgUrl" class="h-full w-auto max-w-[40%] object-cover" />
                        } else {
                            <div class="h-full w-32 bg-red-900/30 flex items-center justify-center text-4xl">üéâ</div>
                        }
                        
                        <div class="flex-1 p-6 flex flex-col justify-center bg-gradient-to-r from-gray-900 via-gray-900 to-gray-800/50">
                            <div class="flex items-baseline gap-4">
                                <h1 class="text-4xl font-bold text-white tracking-tight">@h.Title</h1>
                                @if(h.IsWorkHoliday) { 
                                    <span class="text-2xl font-light text-green-400 opacity-90">Work - Day Off</span> 
                                }
                            </div>
                            @if(!string.IsNullOrEmpty(h.Description)) { <p class="text-gray-400 mt-1 text-sm">@h.Description</p> }
                            @if(!string.IsNullOrEmpty(h.LinkUrl)) { <a href="@h.LinkUrl" target="_blank" class="text-xs text-blue-400 hover:underline mt-2 block">More Info ‚Üí</a> }
                        </div>
                    </div>
                }

                @foreach(var b in GetBirthdaysForDate(viewDate))
                {
                    int age = b.BirthYear.HasValue ? (viewDate.Year - b.BirthYear.Value) : 0;
                    <div class="mb-4 w-full h-32 rounded-xl overflow-hidden bg-gray-800 border border-pink-700 flex shadow-2xl relative group">
                        @RenderActions("birthday", b.Id)
                        @if(!string.IsNullOrEmpty(b.ImgUrl)) {
                            <img src="@b.ImgUrl" class="h-full w-auto max-w-[40%] object-cover" />
                        } else {
                            <div class="h-full w-32 bg-pink-900/30 flex items-center justify-center text-4xl">üéÇ</div>
                        }
                        
                        <div class="flex-1 p-6 flex flex-col justify-center bg-gradient-to-r from-gray-900 via-gray-900 to-gray-800/50">
                            <div class="flex items-baseline gap-4">
                                <h1 class="text-4xl font-bold text-white tracking-tight">@b.Title</h1>
                                @if(age > 0) { 
                                    <span class="text-2xl font-light text-pink-400 opacity-90">Turning @age!</span> 
                                }
                            </div>
                            @if(!string.IsNullOrEmpty(b.Description)) { <p class="text-gray-400 mt-1 text-sm">@b.Description</p> }
                        </div>
                    </div>
                }
            }

            <div class="flex-1 overflow-hidden relative">
                @if (currentView == "day")
                {
                    <div class="grid grid-cols-3 gap-4 h-full">
                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-blue-400 uppercase tracking-wider text-sm">Work</span>
                                <button @onclick='() => OpenEditor("work", "task")' class="text-xs bg-blue-900/50 hover:bg-blue-600 text-blue-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var v in GetVacationsForDate(viewDate, "work")) { @RenderVacationCard(v) }
                                @foreach(var m in GetMeetingsForDate(viewDate, "work")) { @RenderMeetingCard(m) }
                                @foreach(var t in GetTasksForDate(viewDate, "work")) { @RenderTaskCard(t) }
                                @if(!GetTasksForDate(viewDate, "work").Any() && !GetMeetingsForDate(viewDate, "work").Any() && !GetVacationsForDate(viewDate, "work").Any()) { <div class="text-center text-gray-600 text-sm italic mt-10">No items</div> }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-green-400 uppercase tracking-wider text-sm">Personal</span>
                                <button @onclick='() => OpenEditor("personal", "task")' class="text-xs bg-green-900/50 hover:bg-green-600 text-green-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var v in GetVacationsForDate(viewDate, "personal")) { @RenderVacationCard(v) }
                                @foreach(var a in GetAnniversariesForDate(viewDate)) { @RenderAnniversaryCard(a) }
                                @foreach(var h in GetHabitsForDate(viewDate, "personal")) { @RenderHabitCard(h) }
                                @foreach(var t in GetTasksForDate(viewDate, "personal")) { @RenderTaskCard(t) }
                                @foreach(var m in GetMediaForDate(viewDate)) { @RenderMediaCard(m) }
                                @foreach(var mt in GetMeetingsForDate(viewDate, "personal")) { @RenderMeetingCard(mt) }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                                <span class="font-bold text-orange-400 uppercase tracking-wider text-sm">Health</span>
                                <button @onclick='() => OpenEditor("health", "health")' class="text-xs bg-orange-900/50 hover:bg-orange-600 text-orange-300 hover:text-white px-2 py-0.5 rounded transition">Ôºã Add</button>
                            </div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var v in GetVacationsForDate(viewDate, "health")) { @RenderVacationCard(v) }
                                @foreach(var h in GetHealthForDate(viewDate)) { @RenderHealthCard(h) }
                                @foreach(var t in GetTasksForDate(viewDate, "health")) { @RenderTaskCard(t) }
                                @foreach(var h in GetHabitsForDate(viewDate, "health")) { @RenderHabitCard(h) }
                                @if(!GetTasksForDate(viewDate, "health").Any() && !GetHealthForDate(viewDate).Any()) { 
                                    <div class="text-center mt-10">
                                        <div class="text-gray-600 text-sm italic mb-2">No daily log</div>
                                        <button @onclick='() => OpenEditor("health", "health")' class="text-xs bg-orange-900/30 hover:bg-orange-600 border border-orange-800 text-orange-400 hover:text-white px-3 py-1 rounded transition">Start Log</button>
                                    </div> 
                                }
                            </div>
                        </div>
                    </div>
                }
                else if (currentView == "week") { @RenderWeekView() }
                else if (currentView == "month") { @RenderMonthView() }
            </div>
        </main>
    }
</div>

@if (editingItem != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-lg flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white">@(editingItem.Id == 0 ? "Add Item" : "Edit Item")</h3>
                <button @onclick="() => editingItem = null" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-4 border-b border-gray-800 bg-gray-900 grid grid-cols-3 gap-2">
                <button @onclick='() => editingItem.Type = "task"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "task" ? "bg-blue-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üìã Task</button>
                <button @onclick='() => editingItem.Type = "meeting"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "meeting" ? "bg-indigo-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">‚è∞ Meeting</button>
                <button @onclick='() => editingItem.Type = "habit"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "habit" ? "bg-green-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üî• Habit</button>
                <button @onclick='() => editingItem.Type = "media"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "media" ? "bg-purple-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üé¨ Media</button>
                <button @onclick='() => editingItem.Type = "health"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "health" ? "bg-orange-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üçé Health</button>
                <button @onclick='() => editingItem.Type = "holiday"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "holiday" ? "bg-red-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üéâ Holiday</button>
                <button @onclick='() => editingItem.Type = "birthday"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "birthday" ? "bg-pink-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">üéÇ Birthday</button>
                <button @onclick='() => editingItem.Type = "anniversary"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "anniversary" ? "bg-yellow-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">ü•Ç Anniversary</button>
                <button @onclick='() => editingItem.Type = "vacation"' class="px-3 py-2 w-full rounded-lg text-xs font-bold transition @(editingItem.Type == "vacation" ? "bg-teal-600 text-white" : "bg-gray-800 text-gray-400 hover:bg-gray-700")">‚úàÔ∏è Vacation</button>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label><input type="date" @bind="editingItem.Date" @bind:format="yyyy-MM-dd" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label><select @bind="editingItem.Category" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"><option value="work">Work</option><option value="personal">Personal</option><option value="health">Health</option><option value="public">Public</option></select></div>
                </div>

                @if(editingItem.Type == "health")
                {
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Weight (lbs)</label><input type="number" step="0.1" @bind="editingItem.Weight" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Water (oz)</label><input type="number" @bind="editingItem.Water" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div>
                    </div>
                    <div class="border-t border-gray-700 pt-3">
                        <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-500 uppercase">Meals</label><button type="button" @onclick="AddMeal" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Ôºã Add</button></div>
                        <div class="flex gap-1 mb-1 px-1 text-[10px] uppercase font-bold text-gray-500 text-center"><div class="flex-1 text-left">Food</div><div class="w-12">Cal</div><div class="w-10">Pro</div><div class="w-10">Fat</div><div class="w-10">Carb</div><div class="w-10">Fib</div><div class="w-6"></div></div>
                        @foreach(var meal in editingItem.Meals) { <div class="flex gap-1 mb-2"><input @bind="meal.Name" placeholder="Item" class="flex-1 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white" /><input @bind="meal.Calories" type="number" placeholder="0" class="w-12 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><input @bind="meal.Protein" type="number" placeholder="0" class="w-10 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><input @bind="meal.Fat" type="number" placeholder="0" class="w-10 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><input @bind="meal.Carbs" type="number" placeholder="0" class="w-10 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><input @bind="meal.Fiber" type="number" placeholder="0" class="w-10 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><button type="button" @onclick="() => editingItem.Meals.Remove(meal)" class="text-red-400 px-1 hover:text-red-300">‚úï</button></div> }
                    </div>
                    <div class="border-t border-gray-700 pt-3">
                        <div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-500 uppercase">Workouts</label><button type="button" @onclick="AddWorkout" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Ôºã Add</button></div>
                        <div class="flex gap-1 mb-1 px-1 text-[10px] uppercase font-bold text-gray-500 text-center"><div class="flex-1 text-left">Exercise</div><div class="w-16">Min</div><div class="w-16">Cal Burn</div><div class="w-6"></div></div>
                        @foreach(var work in editingItem.Workouts) { <div class="flex gap-1 mb-2"><input @bind="work.Description" placeholder="Exercise" class="flex-1 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white" /><input @bind="work.DurationMinutes" type="number" placeholder="0" class="w-16 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><input @bind="work.CaloriesBurned" type="number" placeholder="0" class="w-16 bg-gray-800 border border-gray-700 rounded p-1 text-xs text-white text-center" /><button type="button" @onclick="() => editingItem.Workouts.Remove(work)" class="text-red-400 px-1">‚úï</button></div> }
                    </div>
                }
                else
                {
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label><input @bind="editingItem.Title" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="Enter title..." /></div>
                    
                    @if(editingItem.Type=="holiday"){ 
                         <div class="flex items-center gap-2 border border-gray-700 p-2 rounded bg-gray-800 mb-2"><input type="checkbox" @bind="editingItem.IsWorkHoliday" class="w-5 h-5 rounded bg-gray-900 border-gray-600 text-green-500" /><label class="text-sm font-bold text-gray-300 uppercase">Is Work Holiday (Day Off?)</label></div>
                         <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link URL</label><input @bind="editingItem.LinkUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="https://..." /></div>
                    }

                    @if(editingItem.Type=="birthday"){ 
                         <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Birth Year (Optional)</label><input type="number" @bind="editingItem.BirthYear" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="1980" /></div>
                    }
                    @if(editingItem.Type=="anniversary"){ 
                         <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">First Year (Optional)</label><input type="number" @bind="editingItem.FirstYear" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="2010" /></div>
                    }
                    @if(editingItem.Type=="vacation"){ 
                         <div class="grid grid-cols-2 gap-4">
                             <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Location</label><input @bind="editingItem.Location" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div>
                             <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Group ID</label><input @bind="editingItem.GroupId" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="e.g. Hawaii2025" /></div>
                         </div>
                    }

                    @if(editingItem.Type=="task"){ <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticket #</label><input @bind="editingItem.TicketNumber" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"/></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Priority</label><select @bind="editingItem.Priority" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"><option>Normal</option><option>High</option><option>Low</option></select></div></div> }
                    @if(editingItem.Type=="meeting"){ <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Start Time</label><input type="time" @bind="editingItem.StartTime" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Duration (Min)</label><input type="number" @bind="editingItem.Duration" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div></div> }
                    @if(editingItem.Type=="media"){ <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rating</label><input type="number" @bind="editingItem.Rating" min="1" max="10" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Release Year</label><input type="number" @bind="editingItem.ReleaseYear" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div></div> }
                    @if(editingItem.Type=="habit"){ <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Streak</label><input type="number" @bind="editingItem.Streak" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" /></div> }
                    
                    @if(editingItem.Type!="health") { <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description / Notes</label><textarea @bind="editingItem.Description" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm"></textarea></div> }
                    
                    @if(editingItem.Type!="health") { <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image</label><div class="flex gap-2 mb-2"><button class="text-xs px-3 py-1 rounded @(!isUploading?"bg-blue-600":"bg-gray-800")" @onclick="()=>isUploading=false">Link URL</button><button class="text-xs px-3 py-1 rounded @(isUploading?"bg-blue-600":"bg-gray-800")" @onclick="()=>isUploading=true">Upload</button></div>@if(!isUploading){<input @bind="editingItem.ImgUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="https://..." />}else{<InputFile OnChange="HandleImageUpload" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />}@if(!string.IsNullOrEmpty(editingItem.ImgUrl)){<div class="mt-2 h-20 w-20 rounded overflow-hidden border border-gray-600"><img src="@editingItem.ImgUrl" class="w-full h-full object-cover" /></div>}</div> }
                }
            </div>
            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-end gap-3"><button @onclick="() => editingItem = null" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button><button @onclick="SaveItem" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save</button></div>
        </div>
    </div>
}

@if (showImportModal)
{
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold text-white mb-2">Import Data</h3>
            <div class="flex gap-2 mb-4 flex-wrap"><button @onclick="UpgradeDatabase" class="bg-blue-800 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">üõ†Ô∏è Missing Tables</button><button @onclick="ImportTasks" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üìã Import Tasks</button><button @onclick="ImportMeetings" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">‚è∞ Import Meetings</button><button @onclick="ImportHabits" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üî• Import Habits</button><button @onclick="ImportMedia" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üé¨ Import Media</button><button @onclick="ImportHealth" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üçé Import Health</button><button @onclick="ImportHolidays" class="bg-red-700 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üéâ Import Holidays</button><button @onclick="ImportBirthdays" class="bg-pink-700 hover:bg-pink-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">üéÇ Import Birthdays</button><button @onclick="ImportAnniversaries" class="bg-yellow-700 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">ü•Ç Import Anniversaries</button><button @onclick="ImportVacations" class="bg-teal-700 hover:bg-teal-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">‚úàÔ∏è Import Vacations</button><button @onclick="WipeAll" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">üóëÔ∏è Wipe All</button></div>
            <div class="flex-1 bg-black rounded-lg border border-gray-700 p-4 font-mono text-[10px] overflow-y-auto text-gray-300 relative group"><div class="flex justify-between border-b border-gray-800 pb-1 mb-1 text-gray-500 uppercase font-bold sticky top-0 bg-black z-10"><span>Console Output</span><div class="flex gap-2"><button @onclick="CopyLogs" class="hover:text-white">üìã Copy Logs</button><button @onclick="ClearLogs" class="hover:text-white">Clear</button></div></div>@foreach(var log in debugLogs) { <div class="mb-1 border-b border-gray-900/50 pb-1 break-all">@log</div> }</div>
            <div class="mt-4 flex justify-end"><button @onclick="() => showImportModal = false" class="px-4 py-2 text-gray-400 hover:text-white">Close</button></div>
        </div>
    </div>
}

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); };
    window.copyTextToClipboard = async (text) => { try { await navigator.clipboard.writeText(text); } catch (err) { console.error(err); } };
</script>

@code {
    // --- STATE ---
    private string CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private bool showImportModal = false;
    private User? currentUser;

    private string currentView = "day"; 
    private DateTime viewDate = DateTime.UtcNow;

    private List<BulletMedia> AllMedia = new();
    private List<BulletTask> AllTasks = new();
    private List<BulletMeeting> AllMeetings = new();
    private List<BulletHabit> AllHabits = new();
    private List<BulletMacroTracker> AllHealth = new();
    private List<BulletMeal> AllMeals = new();
    private List<BulletWorkout> AllWorkouts = new();
    private List<BulletHoliday> AllHolidays = new();
    private List<BulletBirthday> AllBirthdays = new();
    private List<BulletAnniversary> AllAnniversaries = new();
    private List<BulletVacation> AllVacations = new();

    private DraftItem? editingItem;
    private bool isUploading = false;
    private class DraftItem { 
        public int Id { get; set; } 
        public string Type { get; set; } = "task"; 
        public string Category { get; set; } = "work"; 
        public DateTime Date { get; set; } = DateTime.UtcNow; 
        public string Title { get; set; } = ""; 
        public string Description { get; set; } = ""; 
        public string ImgUrl { get; set; } = ""; 
        public string LinkUrl { get; set; } = "";
        public int? ImageId { get; set; } 
        public string TicketNumber { get; set; } = ""; 
        public string Priority { get; set; } = "Normal"; 
        public TimeOnly? StartTime { get; set; } 
        public int Duration { get; set; } 
        public int Rating { get; set; } 
        public int ReleaseYear { get; set; } 
        public int Streak { get; set; }
        // Health
        public double Weight { get; set; }
        public double Water { get; set; }
        public List<BulletMeal> Meals { get; set; } = new();
        public List<BulletWorkout> Workouts { get; set; } = new();
        // Holiday
        public bool IsWorkHoliday { get; set; } = false;
        // Birthday & Anniversary
        public int? BirthYear { get; set; }
        public int? FirstYear { get; set; }
        // Vacation
        public string GroupId { get; set; } = "";
        public string Location { get; set; } = "";
    }

    private bool isImporting = false;
    private List<string> debugLogs = new();

    // --- INITIALIZATION ---
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender && !isDbError) { 
            try { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", true); return; }
                var session = JsonSerializer.Deserialize<SessionData>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", true); return; }
                currentUser = await Db.Users.FindAsync(session.UserId);
                if (currentUser != null) { await LoadData(); _ = FetchWeather(); }
                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); } catch {}
                viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes);
                _ = StartClock(); StateHasChanged();
            } catch { Nav.NavigateTo("/login", true); }
        }
    }

    // --- NAVIGATION LOGIC ---
    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private void CloseMenus() { showUserMenu = false; }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }
    private void SwitchView(string view) { currentView = view; StateHasChanged(); }
    private void Prev() { if (currentView == "day") viewDate = viewDate.AddDays(-1); else if (currentView == "week") viewDate = viewDate.AddDays(-7); else viewDate = viewDate.AddMonths(-1); }
    private void Next() { if (currentView == "day") viewDate = viewDate.AddDays(1); else if (currentView == "week") viewDate = viewDate.AddDays(7); else viewDate = viewDate.AddMonths(1); }
    private void GoToday() { viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); SwitchView("day"); }
    private void GoToDate(DateTime d) { viewDate = d; SwitchView("day"); }
    private string GetHeaderDate() => currentView == "day" ? viewDate.ToString("dddd, MMMM d, yyyy") : (currentView == "week" ? $"Week of {GetStartOfWeek(viewDate):MMM d, yyyy}" : viewDate.ToString("MMMM yyyy"));
    private DateTime GetStartOfWeek(DateTime d) => d.AddDays(-1 * ((7 + (d.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;

    // --- DATA LOADING & FILTERING ---
    private List<BulletMedia> GetMediaForDate(DateTime d, string? category = null) { var q = AllMedia.Where(m => m.Date.Date == d.Date); return category == null ? q.ToList() : q.Where(x => x.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList(); }
    private List<BulletTask> GetTasksForDate(DateTime d, string? category = null) { var t = AllTasks.Where(x => x.Date.Date == d.Date); return category == null ? t.ToList() : t.Where(x => x.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList(); }
    private List<BulletMeeting> GetMeetingsForDate(DateTime d, string? category = null) { var q = AllMeetings.Where(m => m.Date.Date == d.Date).OrderBy(m => m.StartTime); return category == null ? q.ToList() : q.Where(x => x.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList(); }
    private List<BulletHabit> GetHabitsForDate(DateTime d, string? category = null) { var q = AllHabits.Where(h => h.Date.Date == d.Date); return category == null ? q.ToList() : q.Where(x => x.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList(); }
    private List<BulletMacroTracker> GetHealthForDate(DateTime d) 
    { 
        if (AllHealth == null) return new List<BulletMacroTracker>();
        try { return AllHealth.Where(h => h.Date.Date == d.Date).ToList(); } catch { return new List<BulletMacroTracker>(); }
    }
    private List<BulletHoliday> GetHolidaysForDate(DateTime d) => AllHolidays.Where(h => h.Date.Date == d.Date).ToList();
    private List<BulletBirthday> GetBirthdaysForDate(DateTime d) => AllBirthdays.Where(b => b.Date.Date == d.Date).ToList();
    private List<BulletAnniversary> GetAnniversariesForDate(DateTime d) => AllAnniversaries.Where(a => a.Date.Date == d.Date).ToList();
    private List<BulletVacation> GetVacationsForDate(DateTime d, string? category = null) 
    {
        var q = AllVacations.Where(v => v.Date.Date == d.Date);
        return category == null ? q.ToList() : q.Where(x => x.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private async Task LoadData() {
        if (currentUser == null) return;
        try {
            AllMedia = await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllTasks = await Db.Set<BulletTask>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllMeetings = await Db.Set<BulletMeeting>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllHabits = await Db.Set<BulletHabit>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllHealth = await Db.Set<BulletMacroTracker>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllMeals = await Db.Set<BulletMeal>().ToListAsync();
            AllWorkouts = await Db.Set<BulletWorkout>().ToListAsync();
            AllHolidays = await Db.Set<BulletHoliday>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllBirthdays = await Db.Set<BulletBirthday>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllAnniversaries = await Db.Set<BulletAnniversary>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllVacations = await Db.Set<BulletVacation>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            StateHasChanged();
        } catch (Exception ex) { 
            Console.WriteLine("Load Error: " + ex.Message);
            if (ex.Message.Contains("42P01")) { isDbError = true; errorMessage = "Missing Tables."; } 
        }
    }

    // --- HEALTH CALCULATIONS ---
    private double CalculateTDEE(double weightLbs) {
        if (currentUser == null) return 2000;
        double weightKg = Math.Max(weightLbs, 1) * 0.453592; double heightCm = Math.Max(currentUser.HeightInches, 1) * 2.54; int age = Math.Max(currentUser.Age, 1);
        double bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age); bmr += (currentUser.Gender == "Male" ? 5 : -161);
        double factor = currentUser.ActivityLevel switch { "Light" => 1.375, "Moderate" => 1.55, "Active" => 1.725, "Extra" => 1.9, _ => 1.2 };
        return Math.Max(bmr * factor, 1200);
    }
    private (double deficit, int days) CalculateWeeklyDeficit(DateTime currentDate) {
        try {
            var diff = (7 + (currentDate.DayOfWeek - DayOfWeek.Monday)) % 7; var monday = currentDate.Date.AddDays(-1 * diff);
            double totalDeficit = 0; int daysCounted = 0;
            for (var day = monday; day <= currentDate.Date; day = day.AddDays(1)) {
                var log = AllHealth.FirstOrDefault(h => h.Date.Date == day);
                if (log != null && log.Weight > 0) {
                    var meals = AllMeals.Where(m => m.BulletMacroTrackerId == log.Id); var works = AllWorkouts.Where(w => w.BulletMacroTrackerId == log.Id);
                    double net = meals.Sum(m => m.Calories) - works.Sum(w => w.CaloriesBurned); double tdee = CalculateTDEE(log.Weight);
                    totalDeficit += (tdee - net); daysCounted++;
                }
            }
            return (totalDeficit, daysCounted);
        } catch { return (0, 0); }
    }

    private string GetOrdinal(int num)
    {
        if (num <= 0) return "";
        switch (num % 100)
        {
            case 11: case 12: case 13: return num + "th";
        }
        return (num % 10) switch
        {
            1 => num + "st",
            2 => num + "nd",
            3 => num + "rd",
            _ => num + "th"
        };
    }

    // --- ACTIONS (CRUD) ---
    private async Task ToggleTaskComplete(BulletTask t) { t.IsCompleted = !t.IsCompleted; await Db.SaveChangesAsync(); }
    private async Task ToggleMeetingComplete(BulletMeeting m) { m.IsCompleted = !m.IsCompleted; await Db.SaveChangesAsync(); }
    private async Task ToggleHabitComplete(BulletHabit h) { h.IsCompleted = !h.IsCompleted; await Db.SaveChangesAsync(); }

    private void AddMeal() => editingItem?.Meals.Add(new BulletMeal());
    private void AddWorkout() => editingItem?.Workouts.Add(new BulletWorkout());

    private void OpenEditor(string category, string type) { editingItem = new DraftItem { Category = category, Type = type, Date = viewDate }; }
    private void EditItem(string type, int id) {
        if (type == "task") { var t = AllTasks.First(x => x.Id == id); editingItem = new DraftItem { Id = t.Id, Type = "task", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, TicketNumber = t.TicketNumber, Priority = t.Priority }; }
        else if (type == "meeting") { var m = AllMeetings.First(x => x.Id == id); TimeOnly.TryParse(m.StartTime, out var st); editingItem = new DraftItem { Id = m.Id, Type = "meeting", Category = m.Category, Date = m.Date, Title = m.Title, Description = m.Description, ImgUrl = m.ImgUrl, StartTime = st, Duration = m.DurationPlanned }; }
        else if (type == "media") { var m = AllMedia.First(x => x.Id == id); editingItem = new DraftItem { Id = m.Id, Type = "media", Category = m.Category, Date = m.Date, Title = m.Title, Description = m.Description, ImgUrl = m.ImgUrl, Rating = m.Rating, ReleaseYear = m.ReleaseYear }; }
        else if (type == "habit") { var h = AllHabits.First(x => x.Id == id); editingItem = new DraftItem { Id = h.Id, Type = "habit", Category = h.Category, Date = h.Date, Title = h.Title, Description = h.Notes, ImgUrl = h.ImgUrl, Streak = h.StreakCount }; }
        else if (type == "health") { 
            var h = AllHealth.First(x => x.Id == id); 
            var meals = AllMeals.Where(m => m.BulletMacroTrackerId == h.Id).ToList();
            var works = AllWorkouts.Where(w => w.BulletMacroTrackerId == h.Id).ToList();
            editingItem = new DraftItem { Id = h.Id, Type = "health", Category = h.Category, Date = h.Date, Weight = h.Weight, Water = h.WaterIntake, Meals = meals, Workouts = works }; 
        }
        else if (type == "holiday") { var h = AllHolidays.First(x => x.Id == id); editingItem = new DraftItem { Id = h.Id, Type = "holiday", Category = h.Category, Date = h.Date, Title = h.Title, Description = h.Description, ImgUrl = h.ImgUrl, LinkUrl = h.LinkUrl, IsWorkHoliday = h.IsWorkHoliday }; }
        else if (type == "birthday") { var b = AllBirthdays.First(x => x.Id == id); editingItem = new DraftItem { Id = b.Id, Type = "birthday", Category = b.Category, Date = b.Date, Title = b.Title, Description = b.Description, ImgUrl = b.ImgUrl, LinkUrl = b.LinkUrl, BirthYear = b.BirthYear }; }
        else if (type == "anniversary") { var a = AllAnniversaries.First(x => x.Id == id); editingItem = new DraftItem { Id = a.Id, Type = "anniversary", Category = a.Category, Date = a.Date, Title = a.Title, Description = a.Description, ImgUrl = a.ImgUrl, LinkUrl = a.LinkUrl, FirstYear = a.FirstYear }; }
        else if (type == "vacation") { var v = AllVacations.First(x => x.Id == id); editingItem = new DraftItem { Id = v.Id, Type = "vacation", Category = v.Category, Date = v.Date, Title = v.Title, Description = v.Description, ImgUrl = v.ImgUrl, LinkUrl = v.LinkUrl, GroupId = v.GroupId, Location = v.Location }; }
    }
    
    private async Task SaveItem() {
        if(editingItem == null || currentUser == null) return;
        if (editingItem.Type == "task") { BulletTask t; if(editingItem.Id > 0) t = await Db.BulletTasks.FindAsync(editingItem.Id) ?? new BulletTask(); else { t = new BulletTask { UserId = currentUser.Id }; await Db.BulletTasks.AddAsync(t); } t.Title = editingItem.Title; t.Category = editingItem.Category; t.Date = editingItem.Date; t.Description = editingItem.Description; t.ImgUrl = editingItem.ImgUrl; t.TicketNumber = editingItem.TicketNumber; t.Priority = editingItem.Priority; }
        else if (editingItem.Type == "meeting") { BulletMeeting m; if(editingItem.Id > 0) m = await Db.BulletMeetings.FindAsync(editingItem.Id) ?? new BulletMeeting(); else { m = new BulletMeeting { UserId = currentUser.Id }; await Db.BulletMeetings.AddAsync(m); } m.Title = editingItem.Title; m.Category = editingItem.Category; m.Date = editingItem.Date; m.Description = editingItem.Description; m.ImgUrl = editingItem.ImgUrl; m.StartTime = editingItem.StartTime.HasValue ? editingItem.StartTime.Value.ToString("HH:mm") : ""; m.DurationPlanned = editingItem.Duration; }
        else if (editingItem.Type == "media") { BulletMedia m; if(editingItem.Id > 0) m = await Db.BulletMedia.FindAsync(editingItem.Id) ?? new BulletMedia(); else { m = new BulletMedia { UserId = currentUser.Id }; await Db.BulletMedia.AddAsync(m); } m.Title = editingItem.Title; m.Category = "Movie"; m.Date = editingItem.Date; m.Description = editingItem.Description; m.ImgUrl = editingItem.ImgUrl; m.Rating = editingItem.Rating; m.ReleaseYear = editingItem.ReleaseYear; }
        else if (editingItem.Type == "habit") { BulletHabit h; if(editingItem.Id > 0) h = await Db.BulletHabits.FindAsync(editingItem.Id) ?? new BulletHabit(); else { h = new BulletHabit { UserId = currentUser.Id }; await Db.BulletHabits.AddAsync(h); } h.Title = editingItem.Title; h.Category = editingItem.Category; h.Date = editingItem.Date; h.Notes = editingItem.Description; h.ImgUrl = editingItem.ImgUrl; h.StreakCount = editingItem.Streak; }
        else if (editingItem.Type == "holiday") { BulletHoliday h; if(editingItem.Id > 0) h = await Db.BulletHolidays.FindAsync(editingItem.Id) ?? new BulletHoliday(); else { h = new BulletHoliday { UserId = currentUser.Id }; await Db.BulletHolidays.AddAsync(h); } h.Title = editingItem.Title; h.Category = editingItem.Category; h.Date = editingItem.Date; h.Description = editingItem.Description; h.ImgUrl = editingItem.ImgUrl; h.LinkUrl = editingItem.LinkUrl; h.IsWorkHoliday = editingItem.IsWorkHoliday; }
        else if (editingItem.Type == "birthday") { BulletBirthday b; if(editingItem.Id > 0) b = await Db.BulletBirthdays.FindAsync(editingItem.Id) ?? new BulletBirthday(); else { b = new BulletBirthday { UserId = currentUser.Id }; await Db.BulletBirthdays.AddAsync(b); } b.Title = editingItem.Title; b.Category = editingItem.Category; b.Date = editingItem.Date; b.Description = editingItem.Description; b.ImgUrl = editingItem.ImgUrl; b.LinkUrl = editingItem.LinkUrl; b.BirthYear = editingItem.BirthYear; }
        else if (editingItem.Type == "anniversary") { BulletAnniversary a; if(editingItem.Id > 0) a = await Db.BulletAnniversaries.FindAsync(editingItem.Id) ?? new BulletAnniversary(); else { a = new BulletAnniversary { UserId = currentUser.Id }; await Db.BulletAnniversaries.AddAsync(a); } a.Title = editingItem.Title; a.Category = editingItem.Category; a.Date = editingItem.Date; a.Description = editingItem.Description; a.ImgUrl = editingItem.ImgUrl; a.LinkUrl = editingItem.LinkUrl; a.FirstYear = editingItem.FirstYear; }
        else if (editingItem.Type == "vacation") { BulletVacation v; if(editingItem.Id > 0) v = await Db.BulletVacations.FindAsync(editingItem.Id) ?? new BulletVacation(); else { v = new BulletVacation { UserId = currentUser.Id }; await Db.BulletVacations.AddAsync(v); } v.Title = editingItem.Title; v.Category = editingItem.Category; v.Date = editingItem.Date; v.Description = editingItem.Description; v.ImgUrl = editingItem.ImgUrl; v.LinkUrl = editingItem.LinkUrl; v.GroupId = editingItem.GroupId; v.Location = editingItem.Location; }
        else if (editingItem.Type == "health") {
            BulletMacroTracker h;
            if(editingItem.Id > 0) {
                h = await Db.BulletMacroTrackers.FindAsync(editingItem.Id) ?? new BulletMacroTracker();
                // 1. DELETE OLD
                var oldMeals = await Db.BulletMeals.Where(m => m.BulletMacroTrackerId == h.Id).ToListAsync();
                Db.BulletMeals.RemoveRange(oldMeals);
                var oldWorks = await Db.BulletWorkouts.Where(w => w.BulletMacroTrackerId == h.Id).ToListAsync();
                Db.BulletWorkouts.RemoveRange(oldWorks);
                await Db.SaveChangesAsync(); // Commit the delete immediately
            }
            else { 
                h = new BulletMacroTracker { UserId = currentUser.Id }; 
                await Db.BulletMacroTrackers.AddAsync(h); 
                await Db.SaveChangesAsync(); // Save first to get the ID
            }
            
            // 2. UPDATE PARENT
            h.Date = editingItem.Date; 
            h.Weight = editingItem.Weight; 
            h.WaterIntake = editingItem.Water; 
            h.TDEE = CalculateTDEE(h.Weight);
            
            // 3. ADD NEW
            foreach(var m in editingItem.Meals) { 
                m.Id = 0; // Force insert
                m.BulletMacroTrackerId = h.Id; 
                await Db.BulletMeals.AddAsync(m); 
            }
            foreach(var w in editingItem.Workouts) { 
                w.Id = 0; // Force insert
                w.BulletMacroTrackerId = h.Id; 
                await Db.BulletWorkouts.AddAsync(w); 
            }
        }
        await Db.SaveChangesAsync(); editingItem = null; await LoadData();
    }

    private async Task DeleteItem(string type, int id) { if(!await JS.InvokeAsync<bool>("confirm", "Delete item?")) return; if(type == "task") { var x = await Db.BulletTasks.FindAsync(id); if(x != null) Db.BulletTasks.Remove(x); } else if(type == "meeting") { var x = await Db.BulletMeetings.FindAsync(id); if(x != null) Db.BulletMeetings.Remove(x); } else if(type == "media") { var x = await Db.BulletMedia.FindAsync(id); if(x != null) Db.BulletMedia.Remove(x); } else if(type == "habit") { var x = await Db.BulletHabits.FindAsync(id); if(x != null) Db.BulletHabits.Remove(x); } else if(type == "holiday") { var x = await Db.BulletHolidays.FindAsync(id); if(x != null) Db.BulletHolidays.Remove(x); } else if(type == "birthday") { var x = await Db.BulletBirthdays.FindAsync(id); if(x != null) Db.BulletBirthdays.Remove(x); } else if(type == "anniversary") { var x = await Db.BulletAnniversaries.FindAsync(id); if(x != null) Db.BulletAnniversaries.Remove(x); } else if(type == "vacation") { var x = await Db.BulletVacations.FindAsync(id); if(x != null) Db.BulletVacations.Remove(x); } else if(type == "health") { var x = await Db.BulletMacroTrackers.FindAsync(id); if(x != null) Db.BulletMacroTrackers.Remove(x); } await Db.SaveChangesAsync(); await LoadData(); }
    private async Task HandleImageUpload(InputFileChangeEventArgs e) { if (editingItem == null) return; try { var file = e.File; using var content = new MultipartFormDataContent(); using var stream = file.OpenReadStream(5 * 1024 * 1024); var fileContent = new StreamContent(stream); fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType); content.Add(fileContent, "file", file.Name); var response = await Http.PostAsync("/api/images/upload", content); if (response.IsSuccessStatusCode) { var result = await response.Content.ReadFromJsonAsync<UploadResult>(); if (result != null) { editingItem.ImgUrl = result.Url; editingItem.ImageId = result.Id; } } } catch {} }
    private class UploadResult { public int Id { get; set; } public string Url { get; set; } = ""; }

    // RENDERERS
    private RenderFragment RenderActions(string type, int id) => __builder => { <div class="absolute top-1 right-1 hidden group-hover:flex gap-1 z-20 bg-black/60 rounded backdrop-blur-sm shadow-sm border border-gray-700/50"><button @onclick='() => EditItem(type, id)' @onclick:stopPropagation="true" class="p-1 text-gray-300 hover:text-white hover:bg-gray-600 rounded" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button><button @onclick='() => DeleteItem(type, id)' @onclick:stopPropagation="true" class="p-1 text-red-400 hover:text-red-200 hover:bg-red-900/50 rounded" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div> };
    private RenderFragment RenderWeekView() => __builder => { <div class="grid grid-cols-7 gap-2 h-full">@{ var weekStart = GetStartOfWeek(viewDate); }@for (int i = 0; i < 7; i++) { var d = weekStart.AddDays(i); var isToday = d.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isWeekend = d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday; var isVacation = GetVacationsForDate(d).Any(); var isHoliday = GetHolidaysForDate(d).Any(x => x.IsWorkHoliday); var borderClass = isToday ? "border-yellow-500 border-2" : (isHoliday ? "border-green-500 border-2" : (isVacation ? "border-emerald-600 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700"))); <div class="flex flex-col h-full rounded-xl border overflow-hidden transition hover:border-gray-500 @borderClass @(isWeekend?"bg-gray-800/30":"bg-gray-800/60")"><div class="p-2 text-center border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/50 @(isToday?"bg-blue-900/50 text-white":"text-gray-400")" @onclick="() => GoToDate(d)"><div class="text-[10px] uppercase font-bold">@d.ToString("dddd")</div><div class="text-lg font-bold">@d.Day</div></div><div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">@foreach(var hol in GetHolidaysForDate(d)) { @RenderHolidayPill(hol) }@foreach(var b in GetBirthdaysForDate(d)) { @RenderBirthdayPill(b) }@foreach(var a in GetAnniversariesForDate(d)) { @RenderAnniversaryPill(a) }@foreach(var v in GetVacationsForDate(d)) { @RenderVacationPill(v) }@foreach(var h in GetHabitsForDate(d)) { @RenderHabitPill(h) }@foreach(var m in GetMeetingsForDate(d)) { @RenderMeetingPill(m) }@foreach(var t in GetTasksForDate(d)) { @RenderTaskPill(t) }@foreach(var m in GetMediaForDate(d)) { @RenderMediaCard(m, true) }@foreach(var h in GetHealthForDate(d)) { @RenderHealthPill(h) }</div></div> }</div> };
    private RenderFragment RenderMonthView() => __builder => { <div class="flex flex-col h-full"><div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2">@foreach(var day in new[]{"Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"}){ <div class="text-xs font-bold text-gray-500 uppercase">@day</div> }</div><div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">@{ var monthStart = new DateTime(viewDate.Year, viewDate.Month, 1); var daysInMonth = DateTime.DaysInMonth(viewDate.Year, viewDate.Month); var startDay = (int)monthStart.DayOfWeek; if (startDay == 0) startDay = 7; var emptyCells = startDay - 1; }@for(int i=0; i<emptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }@for(int d=1; d<=daysInMonth; d++){ var currentDay = new DateTime(viewDate.Year, viewDate.Month, d); var isToday = currentDay.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isWeekend = currentDay.DayOfWeek == DayOfWeek.Saturday || currentDay.DayOfWeek == DayOfWeek.Sunday; var isVacation = GetVacationsForDate(currentDay).Any(); var isHoliday = GetHolidaysForDate(currentDay).Any(x => x.IsWorkHoliday); var borderClass = isToday ? "border-yellow-500 border-2" : (isHoliday ? "border-green-500 border-2" : (isVacation ? "border-emerald-600 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700"))); <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-700 transition cursor-pointer @borderClass @(isWeekend?"bg-gray-800/30":"bg-gray-800")" @onclick="() => GoToDate(currentDay)"><div class="text-right text-xs font-bold text-gray-500 mb-1 @(isToday?"text-yellow-400":"")">@d</div><div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-32">@foreach(var hol in GetHolidaysForDate(currentDay)) { @RenderHolidayPill(hol) }@foreach(var b in GetBirthdaysForDate(currentDay)) { @RenderBirthdayPill(b) }@foreach(var a in GetAnniversariesForDate(currentDay)) { @RenderAnniversaryPill(a) }@foreach(var v in GetVacationsForDate(currentDay)) { @RenderVacationPill(v) }@foreach(var h in GetHabitsForDate(currentDay)) { @RenderHabitPill(h) }@foreach(var m in GetMeetingsForDate(currentDay)) { @RenderMeetingPill(m) }@foreach(var t in GetTasksForDate(currentDay)) { @RenderTaskPill(t) }@foreach(var m in GetMediaForDate(currentDay)) { @RenderMediaCard(m, true) }@foreach(var h in GetHealthForDate(currentDay)) { @RenderHealthPill(h) }</div></div> }</div></div> };

    private RenderFragment RenderAnniversaryCard(BulletAnniversary a) => __builder => {
        int years = a.FirstYear.HasValue ? (viewDate.Year - a.FirstYear.Value) : 0;
        string title = years > 0 ? $"{GetOrdinal(years)} Anniversary" : "Anniversary";
        if(!string.IsNullOrEmpty(a.ImgUrl)) { <div class="bg-gray-900 border border-yellow-700 rounded-lg overflow-hidden group relative hover:border-yellow-500 transition shadow-md mb-2 flex flex-row">@RenderActions("anniversary", a.Id)<div class="w-[30%] bg-black relative"><img src="@a.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;"/></div><div class="w-[70%] p-3 flex flex-col justify-center"><h4 class="text-sm font-bold text-white leading-tight">@a.Title</h4><div class="text-sm text-yellow-500 mt-1">ü•Ç @title</div></div></div> }
        else { <div class="bg-gray-900 border border-yellow-700 rounded-lg p-3 mb-2 hover:border-yellow-500 transition shadow-md group flex items-center gap-3 relative">@RenderActions("anniversary", a.Id)<div class="flex items-center gap-2"><div class="text-xl">ü•Ç</div><div><h4 class="text-sm font-bold text-white leading-tight">@a.Title</h4><div class="text-sm text-yellow-500">@title</div></div></div></div> }
    };
    private RenderFragment RenderAnniversaryPill(BulletAnniversary a) => __builder => {
        var widthClass = currentView == "week" ? "w-[25%]" : "w-[15%]";
        int years = a.FirstYear.HasValue ? (viewDate.Year - a.FirstYear.Value) : 0;
        string text = years > 0 ? $"{GetOrdinal(years)} Anniv." : "Anniv.";
        if(!string.IsNullOrEmpty(a.ImgUrl)){ <div class="bg-gray-900 border border-yellow-900 rounded overflow-hidden group relative hover:border-yellow-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("anniversary", a.Id)<div class="@widthClass shrink-0 bg-black"><img src="@a.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-yellow-500 font-bold leading-none mb-0.5">@text</div><div class="font-bold text-white text-[10px] truncate leading-tight">@a.Title</div></div></div> } 
        else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-yellow-800 bg-yellow-900/30 text-yellow-200 group relative">@RenderActions("anniversary", a.Id)ü•Ç @a.Title @text</div> } 
    };

    private RenderFragment RenderVacationCard(BulletVacation v) => __builder => {
        if(!string.IsNullOrEmpty(v.ImgUrl)) { <div class="bg-gray-900 border border-teal-700 rounded-lg overflow-hidden group relative hover:border-teal-500 transition shadow-md mb-2 flex flex-row">@RenderActions("vacation", v.Id)<div class="w-[30%] bg-black relative"><img src="@v.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;"/></div><div class="w-[70%] p-3 flex flex-col justify-center"><h4 class="text-sm font-bold text-white leading-tight">@v.Title</h4>@if(!string.IsNullOrEmpty(v.Location)){<div class="text-sm text-teal-400 mt-1">üìç @v.Location</div>}</div></div> }
        else { <div class="bg-gray-900 border border-teal-700 rounded-lg p-3 mb-2 hover:border-teal-500 transition shadow-md group flex items-center gap-3 relative">@RenderActions("vacation", v.Id)<div class="flex items-center gap-2"><div class="text-xl">‚úàÔ∏è</div><div><h4 class="text-sm font-bold text-white leading-tight">@v.Title</h4>@if(!string.IsNullOrEmpty(v.Location)){<div class="text-sm text-teal-400">@v.Location</div>}</div></div></div> }
    };
    private RenderFragment RenderVacationPill(BulletVacation v) => __builder => {
        var widthClass = currentView == "week" ? "w-[25%]" : "w-[15%]";
        if(!string.IsNullOrEmpty(v.ImgUrl)){ <div class="bg-gray-900 border border-teal-900 rounded overflow-hidden group relative hover:border-teal-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("vacation", v.Id)<div class="@widthClass shrink-0 bg-black"><img src="@v.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-teal-500 font-bold leading-none mb-0.5">Vacation</div><div class="font-bold text-white text-[10px] truncate leading-tight">@v.Title</div></div></div> } 
        else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-teal-800 bg-teal-900/30 text-teal-200 group relative">@RenderActions("vacation", v.Id)‚úàÔ∏è @v.Title</div> } 
    };

    private RenderFragment RenderHabitCard(BulletHabit h) => __builder => {
        var today = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isMissed = h.Date.Date < today && !h.IsCompleted; var borderColor = h.IsCompleted ? "border-green-500" : (isMissed ? "border-red-500" : "border-gray-600");
        if(!string.IsNullOrEmpty(h.ImgUrl)) { <div class="bg-gray-900 border @borderColor rounded-lg overflow-hidden group relative hover:border-green-400 transition shadow-md mb-2 flex flex-row">@RenderActions("habit", h.Id)<div class="w-[30%] bg-black relative"><img src="@h.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;" /></div><div class="w-[70%] p-3 flex items-center gap-3"><input type="checkbox" checked="@h.IsCompleted" @onchange="() => ToggleHabitComplete(h)" @onclick:stopPropagation="true" class="shrink-0 w-5 h-5 rounded border-green-600 text-green-600 bg-gray-800 cursor-pointer" /><div class="min-w-0"><h4 class="text-sm font-bold text-white leading-tight">@h.Title</h4><div class="text-sm text-gray-500 mt-1">@if(h.IsCompleted){<span>üî• @h.StreakCount</span>}else{<span class="text-gray-400 italic">Pending (@h.StreakCount)</span>}</div></div></div></div> }
        else { <div class="bg-gray-900 border @borderColor rounded-lg p-3 mb-2 hover:border-green-400 transition shadow-md group flex items-center gap-3 relative">@RenderActions("habit", h.Id)<input type="checkbox" checked="@h.IsCompleted" @onchange="() => ToggleHabitComplete(h)" @onclick:stopPropagation="true" class="shrink-0 w-5 h-5 rounded border-green-600 text-green-600 bg-gray-800 cursor-pointer" /><div class="flex items-center gap-2"><div class="text-xl">üî•</div><div><h4 class="text-sm font-bold text-white leading-tight">@h.Title</h4><div class="text-sm text-gray-500">@if(h.IsCompleted){<span>@h.StreakCount Day Streak</span>}else{<span class="text-gray-400 italic">Pending (@h.StreakCount)</span>}</div></div></div></div> }
    };
    private RenderFragment RenderHabitPill(BulletHabit h) => __builder => { var today = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date; var isMissed = h.Date.Date < today && !h.IsCompleted; var style = h.IsCompleted ? "bg-green-900/40 text-green-200 border-green-500" : (isMissed ? "bg-red-900/40 text-red-200 border-red-800" : "bg-gray-800 text-gray-400 border-gray-600"); var widthClass = currentView == "week" ? "w-[25%]" : "w-[15%]"; if(!string.IsNullOrEmpty(h.ImgUrl)) { <div class="bg-gray-900 border @style rounded overflow-hidden group relative hover:border-green-400 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("habit", h.Id)<div class="@widthClass shrink-0 bg-black"><img src="@h.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-gray-500 font-bold leading-none mb-0.5">@if(h.IsCompleted){<span>üî• @h.StreakCount</span>}else{<span>Pending</span>}</div><div class="font-bold text-white text-xs truncate leading-tight">@h.Title</div></div></div> } else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border @style group relative">@RenderActions("habit", h.Id)üî• @h.Title @(h.IsCompleted ? $"({h.StreakCount})" : "(Pending)")</div> } };

    // UPDATED RENDERERS
    private RenderFragment RenderHealthPill(BulletMacroTracker h) => __builder => { 
        var meals = AllMeals.Where(m => m.BulletMacroTrackerId == h.Id).ToList(); var workouts = AllWorkouts.Where(w => w.BulletMacroTrackerId == h.Id).ToList();
        double net = meals.Sum(m => m.Calories) - workouts.Sum(w => w.CaloriesBurned); double tdee = CalculateTDEE(h.Weight); double target = tdee - 500;
        bool goalMet = net <= target;
        string borderColor = goalMet ? "border-green-600" : "border-red-600";
        string bgColor = goalMet ? "bg-green-900/30" : "bg-red-900/30";
        string textColor = goalMet ? "text-green-200" : "text-red-200";

        <div class="text-[10px] px-1 py-0.5 rounded truncate mb-1 border @borderColor @bgColor @textColor group relative">
            @RenderActions("health", h.Id)
            <div class="flex justify-between items-center">
                <span class="flex items-center gap-1">üçé @h.Weight</span>
                <span class="font-bold">@net.ToString("N0")</span>
            </div>
        </div>
    };
    
    private RenderFragment RenderBirthdayPill(BulletBirthday b) => __builder => {
        var widthClass = currentView == "week" ? "w-[25%]" : "w-[15%]";
        int age = b.BirthYear.HasValue ? (viewDate.Year - b.BirthYear.Value) : 0;
        if(!string.IsNullOrEmpty(b.ImgUrl)){ <div class="bg-gray-900 border border-pink-900 rounded overflow-hidden group relative hover:border-pink-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("birthday", b.Id)<div class="@widthClass shrink-0 bg-black"><img src="@b.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-pink-300 font-bold leading-none mb-0.5">Birthday @(age>0?$"({age})":"")</div><div class="font-bold text-white text-[10px] truncate leading-tight">@b.Title</div></div></div> } 
        else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-pink-800 bg-pink-900/30 text-pink-200 group relative">@RenderActions("birthday", b.Id)üéÇ @b.Title @(age>0?$"({age})":"")</div> } 
    };

    private RenderFragment RenderHolidayPill(BulletHoliday h) => __builder => { 
        var widthClass = currentView == "week" ? "w-[25%]" : "w-[15%]";
        if(!string.IsNullOrEmpty(h.ImgUrl)){ <div class="bg-gray-900 border border-red-900 rounded overflow-hidden group relative hover:border-red-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("holiday", h.Id)<div class="@widthClass shrink-0 bg-black"><img src="@h.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-red-300 font-bold leading-none mb-0.5">Holiday</div><div class="font-bold text-white text-[10px] truncate leading-tight">@h.Title</div></div></div> } 
        else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-red-800 bg-red-900/30 text-red-200 group relative">@RenderActions("holiday", h.Id)@h.Title</div> } 
    };
    
    private RenderFragment RenderHealthCard(BulletMacroTracker h) => __builder => {
        var meals = AllMeals.Where(m => m.BulletMacroTrackerId == h.Id).ToList(); var workouts = AllWorkouts.Where(w => w.BulletMacroTrackerId == h.Id).ToList();
        double calIn = meals.Sum(m => m.Calories); double calOut = workouts.Sum(w => w.CaloriesBurned); double net = calIn - calOut; double tdee = CalculateTDEE(h.Weight);
        double targetCal = tdee - 500;
        double remaining = (targetCal + calOut) - calIn;
        
        // Goals: Protein (30%), Fat (35%), Carb (35%)
        double proteinGoal = Math.Max(1, (tdee * 0.30) / 4); 
        double fatGoal = Math.Max(1, (tdee * 0.35) / 9);
        double carbGoal = Math.Max(1, (tdee * 0.35) / 4);

        double pro = meals.Sum(m => m.Protein); double fat = meals.Sum(m => m.Fat); double carb = meals.Sum(m => m.Carbs); double fib = meals.Sum(m => m.Fiber);
        double netCarbs = carb - fib;
        
        var (wkDeficit, days) = CalculateWeeklyDeficit(h.Date);
        double dailyDeficit = tdee - net;
        
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 mb-2 hover:border-orange-500 transition shadow-md group relative">@RenderActions("health", h.Id)
            
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-gray-400 font-bold uppercase">Weight</div>
                <div class="text-xl font-bold text-white">@h.Weight <span class="text-sm text-gray-500">lbs</span></div>
            </div>

            <div class="mb-4 bg-gray-800/50 p-2 rounded border border-gray-700">
                <div class="flex justify-between text-xs text-gray-300 font-bold uppercase mb-1">
                    <span>Weekly Deficit Goal</span>
                    <span class="@(wkDeficit >= 0 ? "text-green-400" : "text-red-400")">@wkDeficit.ToString("N0") / 3,500</span>
                </div>
                <div class="h-3 w-full bg-gray-900 rounded-full overflow-hidden border border-gray-600 relative">
                     <div class="@(wkDeficit >= 0 ? "bg-green-600" : "bg-red-600") h-full transition-all duration-500" style="width: @(Math.Min(100, Math.Abs(wkDeficit / 3500) * 100))%"></div>
                </div>
                <div class="text-xs text-right mt-1 text-gray-400">
                    @(wkDeficit < 0 ? "Surplus (Over)" : $"{Math.Max(0, 3500 - wkDeficit):N0} remaining")
                    <span class="ml-1 text-[10px]">(@(Math.Min(100, Math.Abs(wkDeficit/3500)*100).ToString("0"))%)</span>
                </div>
            </div>

            <div class="flex justify-between items-center mb-3 px-1">
                 <div class="text-xs text-gray-400 font-bold uppercase">Remaining Calories</div>
                 <div class="text-sm font-bold @(remaining >= 0 ? "text-green-400" : "text-red-400")">
                     @remaining.ToString("N0") <span class="text-[10px] text-gray-500 font-normal">left</span>
                 </div>
            </div>
            
            <div class="flex justify-between text-[10px] text-gray-500 mb-4 uppercase tracking-wider px-1 border-b border-gray-800 pb-2">
                <span>Burned: <span class="text-blue-400 font-bold">@calOut.ToString("N0")</span></span>
                <span>TDEE: @tdee.ToString("N0")</span>
            </div>

            <div class="space-y-4 mb-4">
                 <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-bold text-white">Calories (Net)</span>
                        <span class="text-gray-400">@net.ToString("N0") / @targetCal.ToString("N0")</span>
                    </div>
                    <div class="h-2 w-full bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                        <div class="@(net <= targetCal ? "bg-green-500" : "bg-red-500") h-full" style="width: @(Math.Min(100, (net / tdee) * 100))%"></div>
                    </div>
                    <div class="text-[10px] text-right text-gray-500">@((net/targetCal*100).ToString("0"))% of Goal</div>
                 </div>
                 
                 <div>
                    <div class="flex justify-between text-xs mb-1"><span class="font-bold text-blue-400">Protein</span><span class="text-gray-400">@pro.ToString("0") / @proteinGoal.ToString("0")g</span></div>
                    <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width: @(Math.Min(100, (pro / proteinGoal) * 100))%"></div></div>
                     <div class="text-[10px] text-right text-gray-500">@((pro/proteinGoal*100).ToString("0"))%</div>
                 </div>

                 <div>
                    <div class="flex justify-between text-xs mb-1"><span class="font-bold text-yellow-400">Fat</span><span class="text-gray-400">@fat.ToString("0") / @fatGoal.ToString("0")g</span></div>
                    <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden"><div class="bg-yellow-500 h-full" style="width: @(Math.Min(100, (fat / fatGoal) * 100))%"></div></div>
                    <div class="text-[10px] text-right text-gray-500">@((fat/fatGoal*100).ToString("0"))%</div>
                 </div>

                 <div>
                    <div class="flex justify-between text-xs mb-1"><span class="font-bold text-green-400">Net Carbs</span><span class="text-gray-400">@netCarbs.ToString("0") / @carbGoal.ToString("0")g</span></div>
                    <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden"><div class="bg-green-500 h-full" style="width: @(Math.Min(100, (netCarbs / carbGoal) * 100))%"></div></div>
                    <div class="text-[10px] text-right text-gray-500">@((netCarbs/carbGoal*100).ToString("0"))%</div>
                 </div>
            </div>

            @if(meals.Any()) { <div class="mt-3 pt-2 border-t border-gray-800"><div class="text-xs font-bold text-gray-500 uppercase mb-1">Meals</div>@foreach(var m in meals){ <div class="flex justify-between text-xs text-gray-300 py-0.5"><span class="truncate pr-2">@m.Name</span><span>@m.Calories</span></div> }</div> }
            @if(workouts.Any()) { <div class="mt-2 pt-2 border-t border-gray-800"><div class="text-xs font-bold text-gray-500 uppercase mb-1">Workouts</div>@foreach(var w in workouts){ <div class="flex justify-between text-xs text-blue-300 py-0.5"><span class="truncate pr-2">@w.Description</span><span>-@w.CaloriesBurned</span></div> }</div> }
        </div>
    };
    private RenderFragment RenderTaskCard(BulletTask t) => __builder => { if(!string.IsNullOrEmpty(t.ImgUrl)){ <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-blue-500 transition shadow-md mb-2 flex flex-row">@RenderActions("task", t.Id)<div class="w-[30%] bg-black relative"><img src="@t.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;"/></div><div class="w-[70%] p-3 flex items-start gap-2"><input type="checkbox" checked="@t.IsCompleted" @onchange="() => ToggleTaskComplete(t)" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer"/><div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-white leading-tight @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4>@if(!string.IsNullOrEmpty(t.Description)){<p class="text-sm text-gray-500 mt-1 line-clamp-2">@t.Description</p>}@if(!string.IsNullOrEmpty(t.TicketNumber)){<span class="inline-block bg-gray-800 text-xs text-blue-300 px-1.5 rounded border border-blue-900 mt-1">@t.TicketNumber</span>}</div></div></div> } else{ <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-2 hover:border-blue-500 transition shadow-md group relative">@RenderActions("task", t.Id)<div class="flex items-start gap-2"><input type="checkbox" checked="@t.IsCompleted" @onchange="() => ToggleTaskComplete(t)" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer"/><div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-white leading-tight @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4>@if(!string.IsNullOrEmpty(t.Description)){<p class="text-sm text-gray-500 mt-1 line-clamp-2">@t.Description</p>}@if(!string.IsNullOrEmpty(t.TicketNumber)){<span class="inline-block bg-gray-800 text-xs text-blue-300 px-1.5 rounded border border-blue-900 mt-1">@t.TicketNumber</span>}</div></div></div> } };
    private RenderFragment RenderTaskPill(BulletTask t) => __builder => { if(!string.IsNullOrEmpty(t.ImgUrl)){ <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-blue-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("task", t.Id)<div class="w-[15%] shrink-0 bg-black"><img src="@t.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="flex items-center gap-1"><span class="text-xs @(t.IsCompleted?"text-green-500":"text-blue-400")">@(t.IsCompleted?"‚úì":"‚Ä¢")</span><h4 class="font-bold text-white text-xs truncate leading-tight @(t.IsCompleted?"line-through text-gray-500":"")">@t.Title</h4></div></div></div> } else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border flex items-center gap-1 @(t.IsCompleted?"bg-gray-800 text-gray-500 border-gray-700 line-through":"bg-blue-900/30 text-blue-200 border-blue-800") group relative">@RenderActions("task", t.Id)<span class="@(t.IsCompleted?"text-green-500":"text-blue-400")">@(t.IsCompleted?"‚úì":"‚Ä¢")</span>@t.Title</div> } };
    private RenderFragment RenderMeetingCard(BulletMeeting m) => __builder => { if(!string.IsNullOrEmpty(m.ImgUrl)){ <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-indigo-500 transition shadow-md mb-2 flex flex-row">@RenderActions("meeting", m.Id)<div class="w-[30%] bg-black relative"><img src="@m.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;"/></div><div class="w-[70%] p-3 flex items-start gap-2"><input type="checkbox" checked="@m.IsCompleted" @onchange="() => ToggleMeetingComplete(m)" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer"/><div class="flex-1 min-w-0"><div class="flex justify-between items-start mb-1"><span class="text-indigo-400 text-xs font-bold font-mono">@m.StartTime</span><span class="text-xs text-gray-500">@m.DurationPlanned min</span></div><h4 class="text-sm font-bold text-white leading-tight">@m.Title</h4>@if(!string.IsNullOrEmpty(m.Description)){<p class="text-sm text-gray-500 mt-1 line-clamp-2">@m.Description</p>}</div></div></div> } else { <div class="bg-gray-900 border border-indigo-900/50 rounded-lg p-3 mb-2 hover:border-indigo-500 transition shadow-md group border-l-4 border-l-indigo-600 relative">@RenderActions("meeting", m.Id)<div class="flex items-start gap-2"><input type="checkbox" checked="@m.IsCompleted" @onchange="() => ToggleMeetingComplete(m)" @onclick:stopPropagation="true" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer"/><div class="flex-1 min-w-0"><div class="flex justify-between items-start mb-1"><span class="text-indigo-300 text-xs font-bold font-mono flex items-center gap-1">‚è∞ @m.StartTime</span><span class="text-xs text-gray-500">@m.DurationPlanned min</span></div><h4 class="text-sm font-bold text-white leading-tight">@m.Title</h4>@if(!string.IsNullOrEmpty(m.Location)){<div class="text-xs text-gray-400 mt-1">üìç @m.Location</div>}</div></div></div> } };
    private RenderFragment RenderMeetingPill(BulletMeeting m) => __builder => { if(!string.IsNullOrEmpty(m.ImgUrl)){ <div class="bg-gray-900 border border-indigo-900 rounded overflow-hidden group relative hover:border-indigo-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("meeting", m.Id)<div class="w-[15%] shrink-0 bg-black"><img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div><div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><div class="text-[9px] text-indigo-300 font-bold leading-none mb-0.5">@m.StartTime</div><div class="font-bold text-white text-[10px] truncate leading-tight">@m.Title</div></div></div> } else { <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border border-indigo-800 bg-indigo-900/30 text-indigo-200 group relative">@RenderActions("meeting", m.Id)<span class="font-bold">@m.StartTime</span> @m.Title</div> } };
    private RenderFragment RenderMediaCard(BulletMedia m, bool compact = false) => __builder => {
         if (compact) { <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-purple-500 transition shadow mb-1 flex items-stretch h-auto">@RenderActions("media", m.Id)@if(!string.IsNullOrEmpty(m.ImgUrl)){<div class="w-[15%] shrink-0 bg-black"><img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy"/></div>}<div class="flex-1 p-1 min-w-0 flex flex-col justify-center"><h4 class="font-bold text-white text-xs truncate">@m.Title</h4>@if(m.Rating>0){<div class="text-xs text-yellow-400">@m.Rating ‚òÖ</div>}</div></div> }
         else { <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-purple-500 transition shadow-lg w-full mb-3 flex flex-row">@RenderActions("media", m.Id)<div class="w-[40%] bg-black relative">@if(!string.IsNullOrEmpty(m.ImgUrl)){<img src="@m.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 120px;"/>}else{<div class="w-full h-full flex items-center justify-center text-3xl text-gray-700">üé¨</div>}</div><div class="w-[60%] p-3 flex flex-col justify-between"><div><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-white text-base leading-tight truncate mr-2">@m.Title</h4>@if(m.Rating>0){<div class="shrink-0 bg-yellow-900/30 text-yellow-400 text-sm font-bold px-1.5 py-0.5 rounded border border-yellow-700/50">@m.Rating ‚òÖ</div>}</div>@if(!string.IsNullOrEmpty(m.Description)){<p class="text-sm text-gray-400 line-clamp-3 leading-snug">@m.Description</p>}</div></div></div> }
    };
    
    // IMPORT LOGIC (UNCHANGED from previous steps, except adding Health Import)
    private void Log(string msg) { debugLogs.Add($"{DateTime.Now:HH:mm:ss} - {msg}"); InvokeAsync(StateHasChanged); }
    private void ClearLogs() => debugLogs.Clear();
    private async Task CopyLogs() { var text = string.Join("\n", debugLogs); await JS.InvokeVoidAsync("copyTextToClipboard", text); Log("Logs copied."); }
    private async Task ImportList<T>(string typeName, Func<JsonElement, T?> mapper, DbSet<T> table) where T : class {
        if (currentUser == null) return;
        isImporting = true; debugLogs.Clear(); Log($"Scanning for {typeName}s...");
        try {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if (!File.Exists(filePath)) { Log("File not found."); return; }
            var jsonContent = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(jsonContent); var root = doc.RootElement;
            List<JsonElement> rawList = new();
            if (root.ValueKind == JsonValueKind.Array) { foreach (var el in root.EnumerateArray()) rawList.Add(el); }
            else if (root.ValueKind == JsonValueKind.Object) { if (root.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array) foreach (var el in items.EnumerateArray()) rawList.Add(el); }
            var newItems = new List<T>();
            foreach (var raw in rawList) {
                string type = ""; if (raw.TryGetProperty("type", out var t)) type = t.ToString().ToLower();
                if (type != typeName.ToLower()) continue;
                try { var mapped = mapper(raw); if (mapped != null) newItems.Add(mapped); } catch (Exception ex) { Log($"Error mapping: {ex.Message}"); }
            }
            if (newItems.Any()) { await table.AddRangeAsync(newItems); await Db.SaveChangesAsync(); Log($"Imported {newItems.Count} {typeName}s."); await LoadData(); } else { Log($"No {typeName}s found."); }
        } catch (Exception ex) { Log($"Error: {ex.Message}"); } finally { isImporting = false; }
    }
    
    private async Task ImportTasks() => await ImportList("task", MapTask, Db.Set<BulletTask>());
    private async Task ImportMedia() => await ImportList("media", MapMedia, Db.Set<BulletMedia>());
    private async Task ImportMeetings() => await ImportList("meeting", MapMeeting, Db.Set<BulletMeeting>());
    private async Task ImportHabits() => await ImportList("habit", MapHabit, Db.Set<BulletHabit>());

    // NEW HEALTH IMPORT LOGIC
    private async Task ImportHealth()
    {
        if (currentUser == null) return;
        isImporting = true; debugLogs.Clear(); Log("Scanning Health...");
        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            var jsonContent = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(jsonContent);
            
            // Simplified loop (assuming structure from previous steps)
            List<JsonElement> rawList = new();
            var root = doc.RootElement;
            if (root.ValueKind == JsonValueKind.Array) foreach (var el in root.EnumerateArray()) rawList.Add(el);
            else if (root.TryGetProperty("items", out var items)) foreach (var el in items.EnumerateArray()) rawList.Add(el);

            int imported = 0;
            foreach (var raw in rawList)
            {
                if (raw.TryGetProperty("type", out var t) && t.ToString().ToLower() == "health")
                {
                    var tracker = new BulletMacroTracker { UserId = currentUser.Id };
                    
                    if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) tracker.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
                    if (raw.TryGetProperty("weightLbs", out var w) && w.TryGetDouble(out double weight)) tracker.Weight = weight;
                    if (raw.TryGetProperty("id", out var oldId)) tracker.OriginalStringId = oldId.ToString();

                    // Save tracker first to get ID
                    await Db.BulletMacroTrackers.AddAsync(tracker);
                    await Db.SaveChangesAsync(); 

                    // Import Meals
                    if (raw.TryGetProperty("meals", out var mealsArr) && mealsArr.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var m in mealsArr.EnumerateArray())
                        {
                            var meal = new BulletMeal { BulletMacroTrackerId = tracker.Id };
                            if (m.TryGetProperty("name", out var n)) meal.Name = n.ToString();
                            if (m.TryGetProperty("calories", out var cal) && cal.TryGetDouble(out double c)) meal.Calories = c;
                            if (m.TryGetProperty("protein", out var p) && p.TryGetDouble(out double prot)) meal.Protein = prot;
                            if (m.TryGetProperty("fat", out var f) && f.TryGetDouble(out double fat)) meal.Fat = fat;
                            if (m.TryGetProperty("carbs", out var cb) && cb.TryGetDouble(out double carb)) meal.Carbs = carb;
                            await Db.BulletMeals.AddAsync(meal);
                        }
                    }

                    // Import Workouts
                    if (raw.TryGetProperty("workouts", out var wArr) && wArr.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var wk in wArr.EnumerateArray())
                        {
                            var workout = new BulletWorkout { BulletMacroTrackerId = tracker.Id };
                            if (wk.TryGetProperty("description", out var desc)) workout.Description = desc.ToString();
                            if (wk.TryGetProperty("calories", out var wc) && wc.TryGetDouble(out double wcal)) workout.CaloriesBurned = wcal;
                            await Db.BulletWorkouts.AddAsync(workout);
                        }
                    }
                    imported++;
                }
            }
            await Db.SaveChangesAsync();
            Log($"Imported {imported} Health Records.");
            await LoadData();
        }
        catch (Exception ex) { Log($"Error: {ex.Message}"); }
        finally { isImporting = false; }
    }
    
    // NEW HOLIDAY IMPORT
    private async Task ImportHolidays() => await ImportList("holiday", MapHoliday, Db.Set<BulletHoliday>());

    private BulletHoliday? MapHoliday(JsonElement raw) {
        var item = new BulletHoliday { UserId = currentUser!.Id };
        if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
        if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
        if (raw.TryGetProperty("isWorkHoliday", out var h) && h.ValueKind == JsonValueKind.True) item.IsWorkHoliday = true;
        if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString();
        if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
        if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
        if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();
        return item;
    }
    
    private async Task ImportBirthdays() => await ImportList("birthday", MapBirthday, Db.Set<BulletBirthday>());

    private BulletBirthday? MapBirthday(JsonElement raw) {
        var item = new BulletBirthday { UserId = currentUser!.Id };
        if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
        if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
        if (raw.TryGetProperty("birthYear", out var y) && y.TryGetInt32(out int year)) item.BirthYear = year;
        if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString();
        if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
        if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
        if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();
        return item;
    }
    
    private async Task ImportAnniversaries() => await ImportList("anniversary", MapAnniversary, Db.Set<BulletAnniversary>());

    private BulletAnniversary? MapAnniversary(JsonElement raw) {
        var item = new BulletAnniversary { UserId = currentUser!.Id };
        if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
        if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
        if (raw.TryGetProperty("firstYear", out var y) && y.TryGetInt32(out int year)) item.FirstYear = year;
        if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString();
        if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
        if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
        if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();
        return item;
    }
    
    private async Task ImportVacations() => await ImportList("vacation", MapVacation, Db.Set<BulletVacation>());

    private BulletVacation? MapVacation(JsonElement raw) {
        var item = new BulletVacation { UserId = currentUser!.Id };
        if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
        if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
        if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString();
        if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
        if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
        if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();
        if (raw.TryGetProperty("groupId", out var gid)) item.GroupId = gid.ToString();
        if (raw.TryGetProperty("location", out var loc)) item.Location = loc.ToString();
        return item;
    }
    
    // (Existing Mappers)
    private BulletHabit? MapHabit(JsonElement raw) { var item = new BulletHabit { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("streakCount", out var sc) && sc.TryGetInt32(out int s)) item.StreakCount = s; if (raw.TryGetProperty("status", out var st) && st.ToString() == "completed") item.IsCompleted = true; if (raw.TryGetProperty("isCompleted", out var ic) && ic.ValueKind == JsonValueKind.True) item.IsCompleted = true; if (raw.TryGetProperty("notes", out var n)) item.Notes = n.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletTask? MapTask(JsonElement raw) { var item = new BulletTask { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString(); if (raw.TryGetProperty("ticketNumber", out var tn)) item.TicketNumber = tn.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("status", out var s) && s.ToString() == "completed") item.IsCompleted = true; if (raw.TryGetProperty("isCompleted", out var ic) && ic.ValueKind == JsonValueKind.True) item.IsCompleted = true; if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletMedia? MapMedia(JsonElement raw) { var item = new BulletMedia { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("rating", out var r) && r.TryGetInt32(out int rate)) item.Rating = rate; if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private BulletMeeting? MapMeeting(JsonElement raw) { var item = new BulletMeeting { UserId = currentUser!.Id }; if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString(); else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString(); if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc); else item.Date = DateTime.UtcNow; if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString(); if (raw.TryGetProperty("startTime", out var st)) item.StartTime = st.ToString(); if (raw.TryGetProperty("durationMinutes", out var dm) && dm.TryGetInt32(out int plan)) item.DurationPlanned = plan; if (raw.TryGetProperty("timeSpentMinutes", out var am) && am.TryGetInt32(out int act)) item.DurationActual = act; if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString(); if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString(); if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString(); return item; }
    private async Task WipeAll() { if (await JS.InvokeAsync<bool>("confirm", "Delete ALL Bullet Data?")) { Db.Set<BulletTask>().RemoveRange(await Db.Set<BulletTask>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletMedia>().RemoveRange(await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletMeeting>().RemoveRange(await Db.Set<BulletMeeting>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletHabit>().RemoveRange(await Db.Set<BulletHabit>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); Db.Set<BulletMacroTracker>().RemoveRange(await Db.Set<BulletMacroTracker>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); await Db.SaveChangesAsync(); await LoadData(); } }
    private async Task WipeTasks() { if (await JS.InvokeAsync<bool>("confirm", "Delete All Tasks?")) { Db.Set<BulletTask>().RemoveRange(await Db.Set<BulletTask>().Where(i => i.UserId == currentUser!.Id).ToListAsync()); await Db.SaveChangesAsync(); await LoadData(); } }
    private async Task UpgradeDatabase() { try { await Db.Database.ExecuteSqlRawAsync(@"CREATE TABLE IF NOT EXISTS ""BulletMedia"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'Movie', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""Rating"" integer DEFAULT 0, ""ReleaseYear"" integer DEFAULT 0, ""Actors"" text DEFAULT '', ""Tags"" text DEFAULT '', ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletTasks"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'task', ""IsCompleted"" boolean DEFAULT false, ""Priority"" text DEFAULT 'Normal', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""TicketNumber"" text, ""TicketUrl"" text, ""Tags"" text, ""DueDate"" timestamp with time zone, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletMeetings"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'work', ""Type"" text DEFAULT 'meeting', ""StartTime"" text DEFAULT '', ""DurationPlanned"" integer DEFAULT 0, ""DurationActual"" integer DEFAULT 0, ""Location"" text DEFAULT '', ""MeetingLeader"" text DEFAULT '', ""Attendees"" text DEFAULT '', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""IsCompleted"" boolean DEFAULT false, ""Tags"" text DEFAULT '', ""Description"" text, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletHabits"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'habit', ""StreakCount"" integer DEFAULT 0, ""TargetStreak"" integer DEFAULT 0, ""IsCompleted"" boolean DEFAULT false, ""Notes"" text DEFAULT '', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Tags"" text DEFAULT '', ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletMacroTrackers"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Date"" timestamp with time zone NOT NULL, ""Weight"" double precision DEFAULT 0, ""TDEE"" double precision DEFAULT 0, ""WaterIntake"" double precision DEFAULT 0, ""Notes"" text, ""Category"" text DEFAULT 'health', ""Type"" text DEFAULT 'health', ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletMeals"" (""Id"" serial PRIMARY KEY, ""BulletMacroTrackerId"" integer NOT NULL, ""Name"" text, ""MealType"" text, ""Calories"" double precision DEFAULT 0, ""Protein"" double precision DEFAULT 0, ""Fat"" double precision DEFAULT 0, ""Carbs"" double precision DEFAULT 0, ""Fiber"" double precision DEFAULT 0); CREATE TABLE IF NOT EXISTS ""BulletWorkouts"" (""Id"" serial PRIMARY KEY, ""BulletMacroTrackerId"" integer NOT NULL, ""Description"" text, ""CaloriesBurned"" double precision DEFAULT 0, ""DurationMinutes"" integer DEFAULT 0); CREATE TABLE IF NOT EXISTS ""BulletHolidays"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'public', ""Type"" text DEFAULT 'holiday', ""IsWorkHoliday"" boolean DEFAULT false, ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletBirthdays"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'birthday', ""BirthYear"" integer, ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletAnniversaries"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'anniversary', ""FirstYear"" integer, ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""OriginalStringId"" text); CREATE TABLE IF NOT EXISTS ""BulletVacations"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'vacation', ""GroupId"" text, ""Location"" text, ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""OriginalStringId"" text);"); isDbError = false; await LoadData(); Log("Tables Created Successfully"); } catch (Exception ex) { errorMessage = ex.Message; Log($"DB Error: {ex.Message}"); } }
    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"‚õÖ", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}