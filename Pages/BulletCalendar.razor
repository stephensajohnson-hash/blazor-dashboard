@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Globalization
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Calendar | Stephens' Dashboard</PageTitle>

<div class="min-h-screen bg-gray-900 text-white pb-40 relative font-sans">
    
    <div class="sticky top-0 z-40 bg-gray-900 border-b border-gray-800 shadow-2xl">
        <BulletHeader 
            ShowControls="true"
            CustomDateText="@GetHeaderDate()"
            ActiveView="@currentView"
            OnPrev="Prev"
            OnNext="Next"
            OnGoToday="GoToday"
            OnViewChanged="SwitchView"
            OnCloneRequest="() => showTemporalCloneModal = true">
            
            <div class="flex items-center gap-2 ml-4 font-black">
                <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black shadow-inner">
                    <input @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleKeyUp" placeholder="Search..." 
                           class="bg-transparent border-none text-xs py-1.5 px-2 w-24 md:w-32 outline-none text-white font-black" />
                    
                    @if (!string.IsNullOrEmpty(searchQuery))
                    {
                        <button @onclick="ClearSearch" class="p-1 text-gray-500 hover:text-red-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    }

                    <button @onclick="ToggleAdvancedSearch" class="p-1 text-gray-500 hover:text-blue-400 transition-colors" title="Advanced Filters">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                    </button>
                </div>

                <TemporalJumpGrid SelectedDate="viewDate" UserId="userId" OnDateSelected="GoToDate" />
            </div>
        </BulletHeader>
    </div>

    <div class="px-6 pt-4 font-black">
        @if (isSearching)
        {
            <div class="h-full flex flex-col font-black">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-sm font-black text-blue-400">Search Results (@searchResults.Count)</h2>
                        @if (TotalPages > 1)
                        {
                            <div class="flex items-center gap-2 bg-black/40 px-2 py-1 rounded-lg border border-gray-800 shadow-xl">
                                <button @onclick="PrevSearchPage" disabled="@(currentPage == 1)" class="text-[10px] text-gray-400 hover:text-white disabled:opacity-30">PREV</button>
                                <span class="text-[10px] text-gray-600 font-black">Page @currentPage of @TotalPages</span>
                                <button @onclick="NextSearchPage" disabled="@(currentPage == TotalPages)" class="text-[10px] text-gray-400 hover:text-white disabled:opacity-30">NEXT</button>
                            </div>
                        }
                    </div>
                    <button @onclick="ClearSearch" class="text-[10px] font-bold text-gray-400 hover:text-red-400 tracking-widest transition-colors">Close Results</button>
                </div>
                <div class="pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        @foreach (var item in searchResults.Skip((currentPage - 1) * pageSize).Take(pageSize)) 
                        {
                            <div class="h-full border border-gray-800 rounded-xl overflow-hidden bg-gray-800/20 p-1 relative shadow-2xl">
                                <button @onclick="() => GoToDate(item.Date)" @onclick:stopPropagation="true" 
                                        class="absolute top-2 left-2 z-20 bg-blue-600 hover:bg-blue-500 text-[8px] font-black px-1.5 py-0.5 rounded shadow-lg cursor-pointer transition-colors border-none outline-none font-black">
                                    @item.Date.ToString("MMM dd, yyyy")
                                </button>
                                <BulletItemSwitcher Item="item" Mode="Card" User="currentUser" OnEdit="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" OnMoveUp="() => MoveItem(item, -1, true)" OnMoveDown="() => MoveItem(item, 1, true)" OnHabitSave="SaveHabitDirectly" />
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 font-black ">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10 font-black ">
                            <span class="font-bold text-@cat.Item3-400 tracking-wider text-sm font-black">@cat.Item1</span>
                            <button @onclick='async () => await OpenEditor(cat.Item2, cat.Item2 == "health" ? "health" : "task", viewDate)' 
                                    class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition font-bold tracking-widest shadow-md font-black ">Ôºã Add</button>
                        </div>
                        <div class="p-3 space-y-3 font-bold font-black ">
                            
                            @if (cat.Item2 == "personal" && showGameBanner && !isLoading)
                            {
                                var favoriteGames = GetFavoriteGamesForDate(viewDate);
                                foreach (var game in favoriteGames)
                                {
                                    var favTeam = teams.FirstOrDefault(t => t.IsFavorite && (t.Id == game.Detail.HomeTeamId || t.Id == game.Detail.AwayTeamId));
                                    <div class="bg-blue-600/20 border border-blue-500/50 rounded-lg flex items-stretch shadow-lg animate-pulse mb-4 overflow-hidden">
                                        <div class="bg-black/40 flex items-center justify-center p-2 border-r border-blue-500/30" style="width: @BulletViewConfig.ImgWidthDay;">
                                            @if (!string.IsNullOrEmpty(favTeam?.LogoUrl)) { <img src="@favTeam.LogoUrl" class="w-full h-auto object-contain max-h-12" /> }
                                            else { <span class="text-xl">üèÜ</span> }
                                        </div>
                                        <div class="flex-1 p-2 flex flex-col justify-center min-w-0">
                                            <div class="flex items-center justify-between">
                                                <span class="text-[9px] bg-blue-600 text-white px-1.5 py-0.5 rounded font-black tracking-widest">Game Day</span>
                                                @if (game.Detail?.StartTime != null) { <span class="text-[9px] text-blue-300 font-mono">‚è∞ @game.Detail.StartTime?.ToString("h:mm tt")</span> }
                                            </div>
                                            <div class="text-xs text-white font-black truncate mt-1">@game.Title</div>
                                        </div>
                                    </div>
                                }
                            }

                            @if(isLoading) 
                            { 
                                <div class="text-center text-gray-500 text-xs italic mt-4 animate-pulse tracking-widest font-black ">Syncing...</div> 
                            }
                            else 
                            {
                                var colItems = GetSortedItems(GetItemsForColumn(viewDate, cat.Item2));
                                foreach(var item in colItems) 
                                { 
                                    <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" Item="item" Mode="Card" User="currentUser" OnEdit="OpenEdit" OnToggle="ToggleComplete" OnDelete="DeleteTask" OnMoveUp="() => MoveItem(item, -1, true)" OnMoveDown="() => MoveItem(item, 1, true)" OnHabitSave="SaveHabitDirectly" />
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 font-sans font-bold font-black ">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    <div class="flex flex-col rounded-xl border @GetDayBorderClass(d) overflow-hidden bg-gray-800/40 shadow-xl font-black ">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700 transition" @onclick="() => GoToDate(d)">
                            <div class="text-[10px] font-black text-gray-500 font-black ">@d.ToString("ddd")</div>
                            <div class="text-lg font-black text-white font-black ">@d.Day</div>
                        </div>
                        <div class="p-1 space-y-1 font-black ">
                            @foreach(var item in GetSortedItems(GetItemsForDate(d))) 
                            { 
                                <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" Item="item" Mode="Pill" User="currentUser" OnEdit="OpenEdit" OnMoveUp="HandlePillReorder" OnMoveDown="HandlePillReorder" />
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col font-sans font-black font-black ">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2 text-[10px] text-gray-500 font-black ">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"}){ <div class="font-black ">@day</div> }
                </div>
                <div class="grid grid-cols-7 gap-1 auto-rows-fr font-black">
                    @for(int i=0; i<monthEmptyCells; i++) { <div class="bg-gray-900/30 rounded-lg h-32"></div> }
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        <div class="relative flex flex-col rounded-lg border @GetDayBorderClass(currentDay) p-1 hover:bg-gray-800 transition cursor-pointer bg-gray-900/50 shadow-inner min-h-[120px] font-black " @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-[10px] font-bold text-gray-500 mb-1 font-black ">@d</div>
                            <div class="space-y-1 font-black">
                                @foreach(var item in GetSortedItems(GetItemsForDate(currentDay))) 
                                { 
                                    <BulletItemSwitcher @key="@($"{item.Type}_{item.Id}")" Item="item" Mode="Pill" User="currentUser" OnEdit="OpenEdit" OnMoveUp="HandlePillReorder" OnMoveDown="HandlePillReorder" />
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<BulletSearchModal 
    @bind-SearchStart="searchStart" 
    @bind-SearchEnd="searchEnd" 
    @bind-SearchType="searchType" 
    IsVisible="showAdvancedSearch" 
    OnClose="HideAdvancedSearch" 
    OnSearchRequested="ExecuteAdvancedSearch" />

<BulletClonerModal 
    IsVisible="showTemporalCloneModal" 
    @bind-SourceYear="cloneSourceYear" 
    @bind-TargetYear="cloneTargetYear" 
    @bind-IncludeBirthdays="includeBirthdays" 
    @bind-IncludeAnniversaries="includeAnniversaries" 
    @bind-IncludeHolidays="includeHolidays" 
    OnClose="() => showTemporalCloneModal = false" 
    OnCloneRequested="ExecuteClone" />

<BaseEditor Item="editingItem" 
            TaskDetail="editingItem?.Detail ?? new()" 
            MeetingDetail="editingItem?.MeetingDetail ?? new()"
            BirthdayDetail="editingItem?.BirthdayDetail ?? new()"
            HealthDetail="editingItem?.HealthDetail ?? new()"
            HabitDetail="editingItem?.HabitDetail ?? new()"
            MediaDetail="editingItem?.MediaDetail ?? new()"
            HolidayDetail="editingItem?.HolidayDetail ?? new()"
            AnniversaryDetail="editingItem?.AnniversaryDetail ?? new()"
            VacationDetail="editingItem?.VacationDetail ?? new()"
            SportsDetail="editingItem?.SportsDetail ?? new()"
            Leagues="leagues"
            Seasons="seasons"
            Teams="teams"
            Notes="editingItem?.Notes ?? new List<BulletItemNote>()"
            OnSaveRecurring="HandleSave" 
            OnCancel="CancelEditing" 
            OnDelete="DeleteCurrentTask" />

@code {
    #region State Variables

    private User? currentUser;
    private int userId = 0;
    private DateTime viewDate = DateTime.UtcNow;
    private string currentView = "day";
    private int clientOffset = 0;
    private bool isLoading = true;
    private List<BulletTaskService.TaskDTO> loadedItems = new();

    private List<League> leagues = new();
    private List<Season> seasons = new();
    private List<Team> teams = new();

    private List<BulletMeetingService.MeetingDTO> _meetings = new();
    private List<BulletBirthdayService.BirthdayDTO> _bdays = new();
    private List<BulletVacationService.VacationDTO> _vacations = new();
    private List<BulletHolidayService.HolidayDTO> _holidays = new();
    private List<BulletAnniversaryService.AnniversaryDTO> _anniversaries = new();
    private List<BulletMediaService.MediaDTO> _media = new();
    private List<BulletSportsService.GameDTO> _sports = new();
    private List<BulletHealthService.HealthDTO> loadedHealth = new();
    private List<BulletHabitService.HabitDTO> loadedHabits = new();

    private BulletTaskService.TaskDTO? editingItem;
    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => ((int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek + 6) % 7;

    private string searchQuery = "";
    private bool isSearching = false;
    private List<BulletTaskService.TaskDTO> searchResults = new();
    private bool showAdvancedSearch = false;
    private DateTime searchStart = DateTime.Today.AddYears(-1);
    private DateTime searchEnd = DateTime.Today.AddYears(1);
    private string searchType = "all";
    private bool showGameBanner = false;

    private int currentPage = 1;
    private const int pageSize = 50;
    private int TotalPages => (int)Math.Ceiling(searchResults.Count / (double)pageSize);

    private bool showTemporalCloneModal = false;
    private int cloneSourceYear = DateTime.Today.Year;
    private int cloneTargetYear = DateTime.Today.Year + 1;
    private bool includeBirthdays = true;
    private bool includeAnniversaries = true;
    private bool includeHolidays = true;

    #endregion

    #region Lifecycle

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json))
                {
                    using var doc = JsonDocument.Parse(json);
                    if (doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p))
                    {
                        userId = p.GetInt32();
                    }

                    if (userId > 0)
                    {
                        currentUser = await Db.Users.FindAsync(userId);
                        clientOffset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()");
                        
                        var uri = Nav.ToAbsoluteUri(Nav.Uri);
                        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("date", out var dVal) && DateTime.TryParse(dVal, out var parsed))
                        {
                            viewDate = parsed;
                        }
                        else
                        {
                            viewDate = DateTime.UtcNow.AddMinutes(-clientOffset);
                        }

                        leagues = await Db.Leagues.OrderBy(x => x.Name).ToListAsync() ?? new();
                        seasons = await Db.Seasons.ToListAsync() ?? new();
                        teams = await Db.Teams.ToListAsync() ?? new();
                        await LoadData();
                    }
                }
            }
            catch (Exception ex)
            {
                await LogToConsole($"Init Fail: {ex.Message}");
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    #endregion

    #region Data Loading

    private async Task LoadData()
    {
        if (currentUser == null)
        {
            return;
        }

        isLoading = true;
        StateHasChanged();

        DateTime s = DateTime.SpecifyKind(viewDate.Date, DateTimeKind.Utc);
        DateTime e = s.AddDays(1).AddSeconds(-1);

        if (currentView == "week") 
        { 
            s = weekStart; 
            e = s.AddDays(7).AddSeconds(-1); 
        }
        else if (currentView == "month") 
        { 
            s = new DateTime(viewDate.Year, viewDate.Month, 1); 
            e = s.AddMonths(1).AddSeconds(-1); 
        }

        try
        {
            loadedItems.Clear();

            loadedItems.AddRange(await TaskService.GetTasksForRange(userId, s, e));

            _meetings = await MeetingService.GetMeetingsForRange(userId, s, e);
            foreach (var m in _meetings) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = m.Id, 
                    UserId = m.UserId, 
                    Type = "meeting", 
                    Category = m.Category, 
                    Date = m.Date, 
                    Title = m.Title, 
                    Description = m.Description, 
                    SortOrder = m.SortOrder, 
                    MeetingDetail = m.MeetingDetail ?? new(), 
                    ImgUrl = m.ImgUrl, 
                    LinkUrl = m.LinkUrl, 
                    Notes = m.Notes ?? new List<BulletItemNote>() 
                });
            }

            _bdays = await BirthdayService.GetBirthdaysForRange(userId, s, e);
            foreach (var b in _bdays) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = b.Id, 
                    UserId = b.UserId, 
                    Type = "birthday", 
                    Category = b.Category, 
                    Date = b.Date, 
                    Title = b.Title, 
                    Description = b.Description, 
                    SortOrder = b.SortOrder, 
                    BirthdayDetail = b.Detail ?? new(), 
                    ImgUrl = b.ImgUrl, 
                    LinkUrl = b.LinkUrl, 
                    Notes = b.Notes ?? new List<BulletItemNote>() 
                });
            }

            _vacations = await VacationService.GetVacationsForRange(userId, s, e);
            foreach (var v in _vacations) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = v.Id, 
                    UserId = v.UserId, 
                    Type = "vacation", 
                    Category = v.Category, 
                    Date = v.Date, 
                    Title = v.Title, 
                    Description = v.Description, 
                    SortOrder = v.SortOrder, 
                    VacationDetail = v.Detail, 
                    ImgUrl = v.ImgUrl, 
                    LinkUrl = v.LinkUrl, 
                    Notes = v.Notes ?? new List<BulletItemNote>() 
                });
            }

            _holidays = await HolidayService.GetHolidaysForRange(userId, s, e);
            foreach (var h in _holidays) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "holiday", 
                    Category = h.Category, 
                    Date = h.Date, 
                    Title = h.Title, 
                    Description = h.Description, 
                    SortOrder = h.SortOrder, 
                    HolidayDetail = h.Detail, 
                    ImgUrl = h.ImgUrl, 
                    LinkUrl = h.LinkUrl, 
                    Notes = h.Notes ?? new List<BulletItemNote>() 
                });
            }

            _anniversaries = await AnniversaryService.GetAnniversariesForRange(userId, s, e);
            foreach (var a in _anniversaries) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = a.Id, 
                    UserId = a.UserId, 
                    Type = "anniversary", 
                    Category = a.Category, 
                    Date = a.Date, 
                    Title = a.Title, 
                    Description = a.Description, 
                    SortOrder = a.SortOrder, 
                    AnniversaryDetail = a.Detail, 
                    ImgUrl = a.ImgUrl, 
                    LinkUrl = a.LinkUrl, 
                    Notes = a.Notes ?? new List<BulletItemNote>() 
                });
            }

            _sports = await SportsService.GetGamesForRange(userId, s, e);
            foreach (var g in _sports) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = g.Id, 
                    UserId = g.UserId, 
                    Type = "sports", 
                    Category = g.Category, 
                    Date = g.Date, 
                    Title = g.Title, 
                    Description = g.Description, 
                    SortOrder = g.SortOrder, 
                    SportsDetail = g.Detail, 
                    ImgUrl = g.ImgUrl, 
                    LinkUrl = g.LinkUrl, 
                    Notes = g.Notes ?? new List<BulletItemNote>() 
                });
            }

            _media = await MediaService.GetMedia(userId);
            foreach (var m in _media.Where(x => x.Date.Date >= s.Date && x.Date.Date <= e.Date)) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = m.Id, 
                    UserId = m.UserId, 
                    Type = "media", 
                    Category = m.Category, 
                    Date = m.Date, 
                    Title = m.Title, 
                    Description = m.Description, 
                    SortOrder = m.SortOrder, 
                    MediaDetail = m.Detail, 
                    ImgUrl = m.ImgUrl, 
                    LinkUrl = m.LinkUrl, 
                    Notes = m.Notes ?? new List<BulletItemNote>() 
                });
            }

            loadedHealth = await HealthService.GetHealthItemsForRange(userId, s, e);
            foreach (var h in loadedHealth) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "health", 
                    Category = h.Category, 
                    Date = h.Date, 
                    Title = h.Title, 
                    Description = h.Description, 
                    SortOrder = h.SortOrder, 
                    HealthDetail = h.Detail, 
                    Meals = h.Meals ?? new List<BulletHealthMeal>(), 
                    Workouts = h.Workouts ?? new List<BulletHealthWorkout>(), 
                    Notes = h.Notes ?? new List<BulletItemNote>(), 
                    ImgUrl = h.ImgUrl 
                });
            }

            loadedHabits = await HabitService.GetHabits(userId);
            foreach (var h in loadedHabits.Where(x => x.Date.Date >= s.Date && x.Date.Date <= e.Date)) 
            {
                loadedItems.Add(new BulletTaskService.TaskDTO 
                { 
                    Id = h.Id, 
                    UserId = h.UserId, 
                    Type = "habit", 
                    Category = h.Category, 
                    Date = h.Date, 
                    Title = h.Title, 
                    Description = h.Description, 
                    SortOrder = h.SortOrder, 
                    HabitDetail = h.Detail, 
                    ImgUrl = h.ImgUrl 
                });
            }

            if (GetFavoriteGamesForDate(viewDate).Any())
            {
                showGameBanner = true;
                _ = Task.Delay(5000).ContinueWith(_ => 
                { 
                    showGameBanner = false; 
                    InvokeAsync(StateHasChanged); 
                });
            }
        }
        catch (Exception ex) 
        { 
            await LogToConsole($"Sync Error: {ex.Message}"); 
        }

        isLoading = false; 
        StateHasChanged();
    }

    #endregion

    #region Navigation & Filtering

    private void Prev()
    {
        isSearching = false; 
        if (currentView == "day") 
        {
            viewDate = viewDate.AddDays(-1);
        }
        else if (currentView == "week") 
        {
            viewDate = viewDate.AddDays(-7);
        }
        else 
        {
            viewDate = viewDate.AddMonths(-1);
        }
        _ = LoadData();
    }

    private void Next()
    {
        isSearching = false; 
        if (currentView == "day") 
        {
            viewDate = viewDate.AddDays(1);
        }
        else if (currentView == "week") 
        {
            viewDate = viewDate.AddDays(7);
        }
        else 
        {
            viewDate = viewDate.AddMonths(1);
        }
        _ = LoadData();
    }

    private void GoToday()
    {
        searchQuery = ""; 
        isSearching = false; 
        viewDate = DateTime.UtcNow.AddMinutes(-clientOffset); 
        currentView = "day"; 
        _ = LoadData();
    }

    private void GoToDate(DateTime d)
    {
        isSearching = false; 
        searchQuery = ""; 
        viewDate = d; 
        currentView = "day"; 
        _ = LoadData();
    }

    private void SwitchView(string view)
    {
        isSearching = false; 
        currentView = view; 
        _ = LoadData();
    }

    private string GetHeaderDate()
    {
        if (currentView == "day") 
        {
            return viewDate.ToString("D");
        }
        return currentView == "week" ? $"Week of {weekStart:MMM d}" : viewDate.ToString("MMMM yyyy");
    }

    private string GetDayBorderClass(DateTime date)
    {
        var today = DateTime.UtcNow.AddMinutes(-clientOffset).Date;
        return date.Date == today ? "border-yellow-500 shadow-lg" : "border-gray-700";
    }

    private List<BulletSportsService.GameDTO> GetFavoriteGamesForDate(DateTime d)
    {
        var favoriteTeamIds = teams.Where(t => t.IsFavorite).Select(t => t.Id).ToList();
        return _sports.Where(g => g.Date.Date == d.Date && (favoriteTeamIds.Contains(g.Detail.HomeTeamId) || favoriteTeamIds.Contains(g.Detail.AwayTeamId))).ToList();
    }

    private List<BulletTaskService.TaskDTO> GetSortedItems(List<BulletTaskService.TaskDTO> items)
    {
        return items?.OrderBy(t => t.SortOrder)
                     .ThenBy(t => GetTypePriority(t.Type))
                     .ThenBy(t => t.MeetingDetail?.StartTime)
                     .ThenBy(t => t.Id)
                     .ToList() ?? new List<BulletTaskService.TaskDTO>();
    }

    private int GetTypePriority(string type) 
    {
        return type switch
        {
            "health" => -3, 
            "vacation" => -2, 
            "habit" => -1, 
            "holiday" => 0, 
            "meeting" => 1, 
            "task" => 2, 
            "birthday" => 3, 
            "anniversary" => 4, 
            "media" => 5, 
            _ => 6
        };
    }

    private List<BulletTaskService.TaskDTO> GetItemsForColumn(DateTime d, string category)
    {
        var dayItems = loadedItems.Where(t => t.Date.Date == d.Date);
        if (category.Equals("personal", StringComparison.OrdinalIgnoreCase))
        {
            return dayItems.Where(t => !t.Category.Trim().Equals("work", StringComparison.OrdinalIgnoreCase) && !t.Category.Trim().Equals("health", StringComparison.OrdinalIgnoreCase)).ToList();
        }
        return dayItems.Where(t => t.Category.Trim().Equals(category.Trim(), StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private List<BulletTaskService.TaskDTO> GetItemsForDate(DateTime d)
    {
        return loadedItems.Where(t => t.Date.Date == d.Date).ToList();
    }

    #endregion

    #region CRUD Operations

    private async Task HandleSave(BaseEditor.RecurrenceRequest req)
    {
        if (editingItem == null) 
        {
            return;
        }
        try 
        { 
            await CommitItemToDatabase(editingItem); 
            editingItem = null; 
            await LoadData(); 
        }
        catch (Exception ex) 
        { 
            await LogToConsole($"Save Error: {ex.Message}"); 
        }
    }

    private async Task CommitItemToDatabase(BulletTaskService.TaskDTO t)
    {
        if (t.Id > 0)
        {
            var dbItem = await Db.BulletItems.FindAsync(t.Id);
            if (dbItem != null) 
            { 
                dbItem.Type = t.Type; 
                dbItem.Category = t.Category; 
                dbItem.Description = t.Description; 
                await Db.SaveChangesAsync(); 
            }
        }

        string type = t.Type?.ToLower().Trim() ?? "task";

        if (type == "meeting") 
        {
            await MeetingService.SaveMeeting(new BulletMeetingService.MeetingDTO { Id = t.Id, UserId = t.UserId, Type = "meeting", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, MeetingDetail = t.MeetingDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
        }
        else if (type == "habit") 
        {
            await HabitService.SaveHabit(new BulletHabitService.HabitDTO { Id = t.Id, UserId = t.UserId, Type = "habit", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.HabitDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
        }
        else if (type == "media") 
        {
            await MediaService.SaveMedia(new BulletMediaService.MediaDTO { Id = t.Id, UserId = t.UserId, Type = "media", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.MediaDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
        }
        else if (type == "holiday") 
        {
            await HolidayService.SaveHoliday(new BulletHolidayService.HolidayDTO { Id = t.Id, UserId = t.UserId, Type = "holiday", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.HolidayDetail ?? new() });
        }
        else if (type == "birthday") 
        {
            await BirthdayService.SaveBirthday(new BulletBirthdayService.BirthdayDTO { Id = t.Id, UserId = t.UserId, Type = "birthday", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.BirthdayDetail ?? new() });
        }
        else if (type == "anniversary") 
        {
            await AnniversaryService.SaveAnniversary(new BulletAnniversaryService.AnniversaryDTO { Id = t.Id, UserId = t.UserId, Type = "anniversary", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, LinkUrl = t.LinkUrl, Detail = t.AnniversaryDetail ?? new() });
        }
        else if (type == "vacation")
        {
            string vGroupId = t.VacationDetail?.VacationGroupId;
            if (t.Id > 0 && !string.IsNullOrEmpty(vGroupId))
            {
                var groupDetails = await Db.BulletVacationDetails.Include(v => v.BulletItem).Where(v => v.VacationGroupId == vGroupId).ToListAsync();
                foreach (var vd in groupDetails) 
                {
                    if (vd.BulletItem != null) 
                    { 
                        vd.BulletItem.Title = t.Title; 
                        vd.BulletItem.Category = t.Category; 
                        vd.BulletItem.Description = t.Description; 
                        vd.BulletItem.ImgUrl = t.ImgUrl; 
                    }
                }
                await VacationService.SaveVacation(new BulletVacationService.VacationDTO { Id = t.Id, UserId = t.UserId, Type = "vacation", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.VacationDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
                await Db.SaveChangesAsync();
            }
            else if (t.Id > 0) 
            {
                await VacationService.SaveVacation(new BulletVacationService.VacationDTO { Id = t.Id, UserId = t.UserId, Type = "vacation", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.VacationDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
            }
            else
            {
                var start = t.Date.Date; 
                var end = (t.EndDate ?? start).Date;
                for (var dt = start; dt <= end; dt = dt.AddDays(1)) 
                {
                    await VacationService.SaveVacation(new BulletVacationService.VacationDTO { Id = 0, UserId = t.UserId, Type = "vacation", Category = t.Category, Date = dt, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.VacationDetail ?? new(), Notes = t.Notes ?? new List<BulletItemNote>() });
                }
            }
        }
        else if (type == "health") 
        {
            await HealthService.SaveHealth(new BulletHealthService.HealthDTO { Id = t.Id, UserId = t.UserId, Date = t.Date, Title = t.Title, Description = t.Description, Category = t.Category, Detail = t.HealthDetail ?? new(), Meals = t.Meals ?? new List<BulletHealthMeal>(), Workouts = t.Workouts ?? new List<BulletHealthWorkout>(), Notes = t.Notes ?? new List<BulletItemNote>() });
        }
        else if (type == "sports") 
        {
            await SportsService.SaveGame(new BulletSportsService.GameDTO { Id = t.Id, UserId = t.UserId, Type = "sports", Category = t.Category, Date = t.Date, Title = t.Title, Description = t.Description, ImgUrl = t.ImgUrl, Detail = t.SportsDetail ?? new() });
        }
        else 
        {
            await TaskService.SaveTask(t);
        }
    }

    private async Task DeleteTask(int id) 
    { 
        if (await JS.InvokeAsync<bool>("confirm", "Delete item?")) 
        { 
            await BaseService.DeleteItem(id); 
            await LoadData(); 
        } 
    }

    private async Task DeleteCurrentTask() 
    { 
        if (editingItem != null && editingItem.Id > 0 && await JS.InvokeAsync<bool>("confirm", "Delete?")) 
        { 
            await BaseService.DeleteItem(editingItem.Id); 
            editingItem = null; 
            await LoadData(); 
        } 
    }

    private async Task ToggleComplete(BulletTaskService.TaskDTO t) 
    { 
        try 
        { 
            await TaskService.SaveTask(t); 
        } 
        catch (Exception ex) 
        { 
            await LogToConsole($"Toggle Fail: {ex.Message}"); 
        } 
    }

    private async Task ToggleMeetingComplete(BulletTaskService.TaskDTO t) 
    { 
        if (t.MeetingDetail != null) 
        {
            await MeetingService.ToggleComplete(t.Id, t.MeetingDetail.IsCompleted); 
        }
    }

    private async Task SaveHabitDirectly(BulletHabitService.HabitDTO h) 
    { 
        await HabitService.SaveHabit(h); 
    }

    private async Task MoveItem(BulletTaskService.TaskDTO item, int direction, bool useCategory = false)
    {
        var dayItems = useCategory ? GetSortedItems(GetItemsForColumn(item.Date, item.Category)) : GetSortedItems(GetItemsForDate(item.Date));
        int currentIndex = dayItems.FindIndex(x => x.Id == item.Id && x.Type == item.Type);
        if (currentIndex == -1) return;
        int newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= dayItems.Count) return;
        var targetItem = dayItems[newIndex];
        var dbItem = await Db.BulletItems.FindAsync(item.Id);
        var dbTarget = await Db.BulletItems.FindAsync(targetItem.Id);
        if (dbItem != null && dbTarget != null)
        {
            if (dbItem.SortOrder == dbTarget.SortOrder) 
            { 
                for (int i = 0; i < dayItems.Count; i++) 
                { 
                    var dItem = await Db.BulletItems.FindAsync(dayItems[i].Id); 
                    if (dItem != null) dItem.SortOrder = i * 10; 
                } 
                await Db.SaveChangesAsync(); 
                dbItem = await Db.BulletItems.FindAsync(item.Id); 
                dbTarget = await Db.BulletItems.FindAsync(targetItem.Id); 
            }
            int temp = dbItem.SortOrder; 
            dbItem.SortOrder = dbTarget.SortOrder; 
            dbTarget.SortOrder = temp;
            await Db.SaveChangesAsync(); 
            await LoadData();
        }
    }

    #endregion

    #region Editor Helpers

    private void CancelEditing() 
    { 
        editingItem = null; 
    }

    private void OpenEdit(BulletTaskService.TaskDTO t) 
    { 
        editingItem = CreateCopy(t); 
        editingItem.Id = t.Id; 
        editingItem.MeetingDetail ??= new(); 
        editingItem.HabitDetail ??= new(); 
        editingItem.MediaDetail ??= new(); 
        editingItem.HolidayDetail ??= new(); 
        editingItem.BirthdayDetail ??= new(); 
        editingItem.AnniversaryDetail ??= new(); 
        editingItem.VacationDetail ??= new(); 
        editingItem.HealthDetail ??= new(); 
        editingItem.SportsDetail ??= new(); 
        editingItem.Notes ??= new List<BulletItemNote>(); 
        editingItem.Todos ??= new List<BulletTaskTodoItem>(); 
    }

    private async Task OpenEditor(string category, string type, DateTime date) 
    { 
        await OpenNewEditor(category, type, date); 
    }

    private async Task OpenNewEditor(string cat, string type, DateTime targetDate) 
    { 
        var newItem = new BulletTaskService.TaskDTO 
        { 
            UserId = userId, 
            Category = cat, 
            Type = type, 
            Date = targetDate, 
            Detail = new(), 
            HealthDetail = new(), 
            MeetingDetail = new(), 
            HabitDetail = new(), 
            HolidayDetail = new(), 
            BirthdayDetail = new(), 
            AnniversaryDetail = new(), 
            VacationDetail = new(), 
            MediaDetail = new(), 
            SportsDetail = new(), 
            Notes = new List<BulletItemNote>(), 
            Todos = new List<BulletTaskTodoItem>() 
        }; 

        if (type == "health") 
        { 
            try 
            { 
                var lastHealth = await Db.BulletHealthDetails.Include(d => d.BulletItem)
                    .Where(h => h.BulletItem.UserId == userId && h.BulletItem.Type == "health" && h.BulletItem.Date < targetDate)
                    .OrderByDescending(h => h.BulletItem.Date)
                    .FirstOrDefaultAsync(); 

                if (lastHealth != null && lastHealth.WeightLbs > 0) 
                {
                    newItem.HealthDetail.WeightLbs = lastHealth.WeightLbs; 
                }
            } 
            catch { } 
        } 

        editingItem = newItem; 
    }

    private BulletTaskService.TaskDTO CreateCopy(BulletTaskService.TaskDTO t)
    {
        var newItem = new BulletTaskService.TaskDTO 
        { 
            Id = 0, 
            UserId = t.UserId, 
            Type = t.Type, 
            Category = t.Category, 
            Date = t.Date, 
            EndDate = t.EndDate, 
            Title = t.Title, 
            Description = t.Description, 
            ImgUrl = t.ImgUrl, 
            LinkUrl = t.LinkUrl, 
            OriginalStringId = t.OriginalStringId, 
            SortOrder = t.SortOrder, 
            Notes = t.Notes?.Select(n => new BulletItemNote { Content = n.Content, ImgUrl = n.ImgUrl, LinkUrl = n.LinkUrl }).ToList() ?? new List<BulletItemNote>(), 
            Todos = t.Todos?.Select(x => new BulletTaskTodoItem { Content = x.Content, IsCompleted = x.IsCompleted, Order = x.Order }).ToList() ?? new List<BulletTaskTodoItem>(), 
            Meals = t.Meals?.ToList() ?? new List<BulletHealthMeal>(), 
            Workouts = t.Workouts?.ToList() ?? new List<BulletHealthWorkout>() 
        };

        if (t.Detail != null) 
        {
            newItem.Detail = new BulletTaskDetail { DueDate = t.Detail.DueDate, IsCompleted = t.Detail.IsCompleted, Priority = t.Detail.Priority, Status = t.Detail.Status, TicketNumber = t.Detail.TicketNumber, TicketUrl = t.Detail.TicketUrl };
        }
        if (t.MeetingDetail != null) 
        {
            newItem.MeetingDetail = new BulletMeetingDetail { StartTime = t.MeetingDetail.StartTime, DurationMinutes = t.MeetingDetail.DurationMinutes, ActualDurationMinutes = t.MeetingDetail.ActualDurationMinutes, IsCompleted = t.MeetingDetail.IsCompleted };
        }
        if (t.HabitDetail != null) 
        {
            newItem.HabitDetail = new BulletHabitDetail { StreakCount = t.HabitDetail.StreakCount, IsCompleted = t.HabitDetail.IsCompleted };
        }
        if (t.VacationDetail != null) 
        {
            newItem.VacationDetail = new BulletVacationDetail { VacationGroupId = t.VacationDetail.VacationGroupId };
        }
        if (t.HealthDetail != null) 
        {
            newItem.HealthDetail = new BulletHealthDetail { WeightLbs = t.HealthDetail.WeightLbs, CalculatedTDEE = t.HealthDetail.CalculatedTDEE };
        }
        if (t.MediaDetail != null) 
        {
            newItem.MediaDetail = new BulletMediaDetail { Rating = t.MediaDetail.Rating, ReleaseYear = t.MediaDetail.ReleaseYear, Tags = t.MediaDetail.Tags };
        }
        if (t.HolidayDetail != null) 
        {
            newItem.HolidayDetail = new BulletHolidayDetail { IsWorkHoliday = t.HolidayDetail.IsWorkHoliday };
        }
        if (t.BirthdayDetail != null) 
        {
            newItem.BirthdayDetail = new BulletBirthdayDetail { DOB_Year = t.BirthdayDetail.DOB_Year };
        }
        if (t.AnniversaryDetail != null) 
        {
            newItem.AnniversaryDetail = new BulletAnniversaryDetail { AnniversaryType = t.AnniversaryDetail.AnniversaryType, FirstYear = t.AnniversaryDetail.FirstYear };
        }
        if (t.SportsDetail != null) 
        {
            newItem.SportsDetail = new BulletGameDetail { LeagueId = t.SportsDetail.LeagueId, HomeTeamId = t.SportsDetail.HomeTeamId, AwayTeamId = t.SportsDetail.AwayTeamId, HomeScore = t.SportsDetail.HomeScore, AwayScore = t.SportsDetail.AwayScore, StartTime = t.SportsDetail.StartTime, IsComplete = t.SportsDetail.IsComplete, TvChannel = t.SportsDetail.TvChannel, SeasonId = t.SportsDetail.SeasonId };
        }
        return newItem;
    }

    #endregion

    #region Search & Filtering

    private async Task HandleKeyUp(KeyboardEventArgs e) 
    { 
        if (e.Key == "Enter") 
        {
            await PerformQuickSearch(); 
        }
        if (e.Key == "Escape") 
        {
            ClearSearch(); 
        }
    }

    private async Task PerformQuickSearch() 
    { 
        if (string.IsNullOrWhiteSpace(searchQuery)) 
        { 
            ClearSearch(); 
            return; 
        } 
        currentPage = 1; 
        isSearching = true; 
        var results = await BaseService.SearchItems(userId, searchQuery, searchType, searchStart, searchEnd);
        searchResults = results.OrderBy(x => x.Date).ToList(); 
    }

    private void ClearSearch() 
    { 
        searchQuery = ""; 
        isSearching = false; 
        _ = LoadData(); 
    }

    private void ToggleAdvancedSearch() 
    { 
        showAdvancedSearch = !showAdvancedSearch; 
    }

    private void HideAdvancedSearch() 
    { 
        showAdvancedSearch = false; 
    }

    private void PrevSearchPage() 
    { 
        currentPage = Math.Max(1, currentPage - 1); 
    }

    private void NextSearchPage() 
    { 
        currentPage = Math.Min(TotalPages, currentPage + 1); 
    }

    private async Task ExecuteAdvancedSearch() 
    { 
        showAdvancedSearch = false; 
        await PerformQuickSearch(); 
    }

    private async Task ExecuteClone() 
    { 
        var count = await BaseService.CloneYearlyItems(userId, cloneSourceYear, cloneTargetYear, includeBirthdays, includeAnniversaries, includeHolidays); 
        showTemporalCloneModal = false; 
        await JS.InvokeVoidAsync("alert", $"Successfully created {count} new items for {cloneTargetYear}!"); 
        await LoadData(); 
    }

    private async Task HandlePillReorder(int id) 
    { 
        var item = loadedItems.FirstOrDefault(x => x.Id == id); 
        if (item == null) 
        {
            return; 
        }
        await MoveItem(item, 0, false); 
    }

    private async Task LogToConsole(string msg) 
    { 
        await JS.InvokeVoidAsync("console.log", $"[CALENDAR] {msg}"); 
    }

    #endregion
}