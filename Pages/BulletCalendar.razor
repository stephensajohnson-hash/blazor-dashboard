@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">
    
    <div class="bg-blue-900/50 border-b border-blue-700 p-2 flex justify-between items-center text-xs">
        <span class="font-bold text-blue-200">üõ†Ô∏è Task Migration (v5)</span>
        <div class="flex gap-2">
            <button @onclick="SetupTables" class="px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded transition">1. Fix DB & Create Tables</button>
            <button @onclick="RunTaskImport" class="px-3 py-1 bg-green-700 hover:bg-green-600 rounded transition" disabled="@(currentUser == null)">2. Import Tasks</button>
            <button @onclick="DropLegacy" class="px-3 py-1 bg-red-900/50 hover:bg-red-700 rounded transition border border-red-800">3. Drop Legacy Tables</button>
        </div>
    </div>

    @if (isDbError)
    {
        <div class="m-6 p-6 rounded-xl bg-red-900/30 border border-red-500">
            <h2 class="text-xl font-bold text-red-400 mb-2">‚ö†Ô∏è Database Error</h2>
            <div class="font-mono text-xs bg-black/50 p-4 rounded text-gray-300 mb-4 whitespace-pre-wrap">@errorMessage</div>
            <button @onclick="SetupTables" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg">
                Click Here to Fix Database Columns
            </button>
        </div>
    }

    @if (currentUser != null)
    {
        <main class="w-full p-6 relative h-screen flex flex-col" @onclick="() => showUserMenu = false">
            
            <div class="mb-4 border-b border-gray-800 pb-2 flex items-center justify-between shrink-0">
                <div class="min-w-[200px]">
                    <h2 class="text-2xl font-bold text-white tracking-tight">@viewDate.ToString("dddd, MMMM d, yyyy")</h2>
                    <span class="text-lg font-medium text-gray-400">@DateTime.Now.ToString("h:mm tt").ToLower()</span>
                </div>

                <div class="flex items-center gap-2 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700/50">
                    <button @onclick="() => ChangeDate(-1)" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300">‚óÄ</button>
                    <button @onclick="GoToday" class="px-3 h-8 bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider">Today</button>
                    <button @onclick="() => ChangeDate(1)" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300">‚ñ∂</button>
                </div>

                <div class="relative z-50">
                    <button @onclick="() => showUserMenu = !showUserMenu" @onclick:stopPropagation="true">
                        <img src="@(currentUser?.AvatarUrl ?? "https://i.imgur.com/7Y5j5Yx.png")" class="w-9 h-9 rounded-full border-2 border-gray-700 object-cover bg-gray-800" />
                    </button>
                    @if (showUserMenu) {
                        <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 border border-gray-700 rounded-xl shadow-xl p-2">
                            <button @onclick="Logout" class="w-full text-left text-xs text-red-400 hover:bg-gray-700 p-2 rounded">Logout</button>
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="mb-4 p-2 rounded bg-gray-800 border border-gray-600 text-xs font-mono text-green-400">
                    @statusMessage
                </div>
            }

            <div class="flex-1 grid grid-cols-3 gap-4 h-full overflow-hidden">
                @RenderColumn("Work", "work")
                @RenderColumn("Personal", "personal")
                @RenderColumn("Health", "health")
            </div>

        </main>
    }
</div>

@code {
    private User? currentUser;
    private DateTime viewDate = DateTime.UtcNow;
    private bool showUserMenu = false;
    
    // Error Handling
    private bool isDbError = false;
    private string errorMessage = "";
    private string statusMessage = "";

    // Data Holders
    private List<BulletTaskService.TaskDTO> DayTasks = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try {
                // 1. GET TOKEN
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", true); return; }
                
                // 2. PARSE TOKEN (Robust Check)
                int userId = 0;
                try {
                    using var doc = JsonDocument.Parse(json);
                    if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) 
                    {
                        userId = p.GetInt32();
                    }
                } catch { 
                    statusMessage = "Session Parse Error. Please logout and login again.";
                    return; 
                }

                if (userId == 0) { 
                    Nav.NavigateTo("/login", true); 
                    return; 
                }

                // 3. FETCH USER
                // We wrap this to catch the specific 'Table Missing' error on Users if schema is totally broken
                try {
                    currentUser = await Db.Users.FindAsync(userId);
                } catch (Exception ex) {
                    isDbError = true;
                    errorMessage = $"Critical DB Error: {ex.Message}";
                    StateHasChanged();
                    return;
                }

                if (currentUser == null) { Nav.NavigateTo("/login", true); return; }

                // 4. SETUP VIEW
                try {
                    int offset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()");
                    viewDate = DateTime.UtcNow.AddMinutes(-offset);
                } catch {}

                // 5. LOAD DATA
                await LoadData(); 

            } catch (Exception ex) {
                errorMessage = $"Init Failed: {ex.Message}";
                isDbError = true;
                StateHasChanged();
            }
        }
    }

    private async Task LoadData()
    {
        if(currentUser == null) return;
        
        try {
            DayTasks = await TaskService.GetTasksForDate(currentUser.Id, viewDate);
            isDbError = false; 
        } 
        catch (Exception ex) 
        {
            isDbError = true;
            errorMessage = $"Data Load Error: {ex.Message} \n(Click 'Fix DB & Create Tables' above)";
        }
        StateHasChanged();
    }

    private void ChangeDate(int days) { viewDate = viewDate.AddDays(days); _ = LoadData(); }
    private void GoToday() { viewDate = DateTime.Now; _ = LoadData(); }

    private async Task SetupTables()
    {
        statusMessage = "Running migrations... (Check Console for details)";
        try {
            await BaseService.CreateBaseTablesIfMissing();
            await TaskService.CreateTable();
            
            statusMessage = "Database Updated Successfully. Reloading data...";
            isDbError = false;
            await LoadData();
        } catch (Exception ex) {
            statusMessage = "Migration Failed: " + ex.Message;
            errorMessage = ex.Message;
            isDbError = true;
        }
        StateHasChanged();
    }

    private async Task RunTaskImport()
    {
        if(currentUser == null) return;
        statusMessage = "Reading JSON...";
        try {
            var path = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if(File.Exists(path))
            {
                var content = await File.ReadAllTextAsync(path);
                statusMessage = "Importing Tasks...";
                await TaskService.ImportFromOldJson(currentUser.Id, content);
                statusMessage = "Tasks Imported! Reloading...";
                await LoadData();
            }
            else { statusMessage = "File not found."; }
        } catch(Exception ex) { statusMessage = "Import Error: " + ex.Message; }
        StateHasChanged();
    }

    private async Task DropLegacy()
    {
        if(!await JS.InvokeAsync<bool>("confirm", "This will DELETE old tables. Are you sure?")) return;
        statusMessage = "Dropping legacy tables...";
        await BaseService.DropLegacyTables();
        statusMessage = "Legacy tables dropped.";
        StateHasChanged();
    }
    
    private async Task Logout() 
    { 
        await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); 
        Nav.NavigateTo("/login", true); 
    }

    private RenderFragment RenderColumn(string title, string category) => __builder => {
        var tasks = DayTasks.Where(t => t.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList();

        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
            <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                <span class="font-bold text-gray-400 uppercase tracking-wider text-sm">@title</span>
                <button class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition">Ôºã Add</button>
            </div>
            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                @foreach(var t in tasks) {
                    <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 relative group hover:border-blue-500 transition shadow-sm">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" checked="@t.Detail.IsCompleted" class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0 cursor-pointer" />
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-bold text-white leading-tight @(t.Detail.IsCompleted ? "line-through text-gray-500" : "")">@t.Title</h4>
                                @if(!string.IsNullOrEmpty(t.Description)) { <p class="text-xs text-gray-500 mt-1 line-clamp-2">@t.Description</p> }
                                @if(!string.IsNullOrEmpty(t.Detail.TicketNumber)) { 
                                    <span class="inline-block mt-2 text-[10px] bg-blue-900/30 text-blue-300 border border-blue-800 px-1.5 rounded">@t.Detail.TicketNumber</span> 
                                }
                            </div>
                        </div>
                    </div>
                }
                @if(!tasks.Any()) { <div class="text-center text-gray-600 text-xs italic mt-4">No items</div> }
            </div>
        </div>
    };
}