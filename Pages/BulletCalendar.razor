@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.IO
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Setup Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">
                Create Missing Tables
            </button>
        </div>
    }
    else
    {
        <main class="w-full p-6 relative h-screen flex flex-col" @onclick="CloseMenus">
            
            <div class="mb-4 border-b border-gray-800 pb-2 flex items-center justify-between shrink-0">
                <div class="min-w-[200px]">
                    <div class="flex flex-col">
                        <h2 class="text-2xl font-bold text-white tracking-tight">@GetHeaderDate()</h2>
                        <span class="text-lg font-medium text-gray-400">@CurrentTime</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <div class="flex items-center gap-4 border-r border-gray-600 pr-4">
                        <a href="/" class="text-xl hover:scale-125 transition grayscale-0" title="Home">üè†</a>
                        <a href="/recipes" class="text-xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    </div>

                    <div class="flex items-center gap-2">
                        <button @onclick="Prev" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚óÄ</button>
                        <button @onclick="GoToday" class="px-3 h-8 flex items-center justify-center bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider transition">Today</button>
                        
                        <div class="flex bg-gray-900/50 rounded-lg p-1">
                            <button @onclick="@(() => SwitchView("day"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Day</button>
                            <button @onclick="@(() => SwitchView("week"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Week</button>
                            <button @onclick="@(() => SwitchView("month"))" class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Month</button>
                        </div>

                        <button @onclick="Next" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚ñ∂</button>
                    </div>
                </div>

                <div class="flex items-center gap-6 min-w-[200px] justify-end">
                    @if (weather?.current != null)
                    {
                        <div class="flex items-center gap-3 bg-gray-800/30 px-3 py-1.5 rounded-xl border border-gray-700/30">
                            <div class="flex items-center gap-2 pr-3 border-r border-gray-600">
                                <span class="text-xl">@GetWeatherIcon(weather.current.weather_code)</span>
                                <div class="font-bold text-white text-base leading-none">@weather.current.temperature_2m.ToString("0")¬∞</div>
                            </div>
                            <div class="flex gap-2">
                                @if (weather.daily?.time != null) {
                                    @for (int i = 1; i <= 5 && i < weather.daily.time.Length; i++) {
                                        <div class="flex flex-col items-center">
                                            <span class="text-[8px] text-gray-500 font-bold uppercase">@GetDayName(weather.daily.time[i])</span>
                                            <span class="text-[9px]">@GetWeatherIcon(weather.daily.weather_code[i])</span>
                                            <div class="text-[7px] font-mono flex gap-0.5"><span class="text-white">@weather.daily.temperature_2m_max[i].ToString("0")¬∞</span><span class="text-gray-500">@weather.daily.temperature_2m_min[i].ToString("0")¬∞</span></div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }

                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu" @onclick:stopPropagation="true">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                                 class="w-9 h-9 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu)
                        {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <button type="button" @onclick="() => { showImportModal = true; showUserMenu = false; }" class="w-full text-left text-xs text-green-400 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>üìÇ</span> Import Data</button>
                                <a href="settings" class="block w-full text-left text-xs text-gray-300 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>‚öôÔ∏è</span> Settings</a>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative">
                @if (currentView == "day")
                {
                    var isToday = viewDate.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date;
                    var isWeekend = viewDate.DayOfWeek == DayOfWeek.Saturday || viewDate.DayOfWeek == DayOfWeek.Sunday;
                    var borderClass = isToday ? "border-yellow-500 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-transparent");

                    <div class="grid grid-cols-3 gap-4 h-full p-2 rounded-xl border @borderClass transition-all">
                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 text-center font-bold text-blue-400 uppercase tracking-wider text-sm sticky top-0 backdrop-blur">Work</div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-2 scrollbar-hide">
                                @foreach(var t in GetTasksForDate(viewDate, "work"))
                                {
                                    @RenderTaskCard(t)
                                }
                                @if(!GetTasksForDate(viewDate, "work").Any())
                                {
                                    <div class="text-center text-gray-600 text-xs italic mt-10">No work tasks</div>
                                }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 text-center font-bold text-green-400 uppercase tracking-wider text-sm sticky top-0 backdrop-blur">Personal</div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                @foreach(var t in GetTasksForDate(viewDate, "personal"))
                                {
                                    @RenderTaskCard(t)
                                }
                                
                                @foreach(var m in GetMediaForDate(viewDate))
                                {
                                    @RenderMediaCard(m)
                                }
                                
                                @if(!GetTasksForDate(viewDate, "personal").Any() && !GetMediaForDate(viewDate).Any())
                                {
                                    <div class="text-center text-gray-600 text-xs italic mt-10">No items</div>
                                }
                            </div>
                        </div>

                        <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                            <div class="p-3 bg-gray-800/80 border-b border-gray-700 text-center font-bold text-orange-400 uppercase tracking-wider text-sm sticky top-0 backdrop-blur">Health</div>
                            <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                                <div class="text-center text-gray-600 text-xs italic mt-10">No logs yet</div>
                            </div>
                        </div>
                    </div>
                }
                else if (currentView == "week")
                {
                    <div class="grid grid-cols-7 gap-2 h-full">
                        @{ var weekStart = GetStartOfWeek(viewDate); }
                        @for (int i = 0; i < 7; i++)
                        {
                            var d = weekStart.AddDays(i);
                            var isToday = d.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date;
                            var isWeekend = d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday;
                            
                            var borderClass = isToday ? "border-yellow-500 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700");
                            var bgClass = isWeekend ? "bg-gray-800/30" : "bg-gray-800/60";

                            var dayMedia = GetMediaForDate(d);
                            var dayTasks = GetTasksForDate(d);

                            <div class="flex flex-col h-full rounded-xl border overflow-hidden transition hover:border-gray-500 @borderClass @bgClass">
                                <div class="p-2 text-center border-b border-gray-700/50 @(isToday ? "bg-blue-900/50 text-white" : "text-gray-400")">
                                    <div class="text-[10px] uppercase font-bold">@d.ToString("dddd")</div>
                                    <div class="text-lg font-bold">@d.Day</div>
                                </div>
                                <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                                    @foreach(var t in dayTasks) { @RenderTaskPill(t) }
                                    @foreach(var m in dayMedia) { @RenderMediaCard(m, true) }
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (currentView == "month")
                {
                    <div class="flex flex-col h-full">
                        <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2">
                            @foreach(var day in new[]{"Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"})
                            { <div class="text-xs font-bold text-gray-500 uppercase">@day</div> }
                        </div>
                        <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                            @{ 
                                var monthStart = new DateTime(viewDate.Year, viewDate.Month, 1);
                                var daysInMonth = DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
                                var startDay = (int)monthStart.DayOfWeek; 
                                if (startDay == 0) startDay = 7; 
                                var emptyCells = startDay - 1; 
                            }
                            
                            @for(int i=0; i<emptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }

                            @for(int d=1; d<=daysInMonth; d++)
                            {
                                var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                                var isToday = currentDay.Date == DateTime.UtcNow.AddMinutes(-clientOffsetMinutes).Date;
                                var isWeekend = currentDay.DayOfWeek == DayOfWeek.Saturday || currentDay.DayOfWeek == DayOfWeek.Sunday;
                                
                                var borderClass = isToday ? "border-yellow-500 border-2" : (isWeekend ? "border-blue-900 border-2" : "border-gray-700");
                                var bgClass = isWeekend ? "bg-gray-800/30" : "bg-gray-800";

                                var dayMedia = GetMediaForDate(currentDay);
                                var dayTasks = GetTasksForDate(currentDay);

                                <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-700 transition cursor-pointer @borderClass @bgClass" @onclick="() => GoToDate(currentDay)">
                                    <div class="text-right text-xs font-bold text-gray-500 mb-1 @(isToday ? "text-yellow-400" : "")">@d</div>
                                    <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-32">
                                        @foreach(var t in dayTasks) { @RenderTaskPill(t) }
                                        @foreach(var m in dayMedia) { @RenderMediaCard(m, true) }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </main>
    }
</div>

@if (showImportModal)
{
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold text-white mb-2">Import Data</h3>
            
            <div class="flex gap-2 mb-4 flex-wrap">
                 <button @onclick="UpgradeDatabase" class="bg-blue-800 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                     üõ†Ô∏è Create Missing Tables
                 </button>
                 
                 <button @onclick="ImportTasks" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">
                     @if(isImporting) { <span>‚è≥ Processing...</span> } else { <span>üìã Import Tasks Only</span> }
                </button>
                 <button @onclick="WipeTasks" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                    üóëÔ∏è Wipe Tasks
                </button>
            </div>
            
            <div class="flex-1 bg-black rounded-lg border border-gray-700 p-4 font-mono text-[10px] overflow-y-auto text-gray-300 relative group">
                 <div class="flex justify-between border-b border-gray-800 pb-1 mb-1 text-gray-500 uppercase font-bold sticky top-0 bg-black z-10">
                    <span>Console Output</span>
                    <div class="flex gap-2">
                        <button @onclick="CopyLogs" class="hover:text-white">üìã Copy Logs</button>
                        <button @onclick="ClearLogs" class="hover:text-white">Clear</button>
                    </div>
                </div>
                @foreach(var log in debugLogs) { <div class="mb-1 border-b border-gray-900/50 pb-1 break-all">@log</div> }
            </div>
            <div class="mt-4 flex justify-end">
                <button @onclick="() => showImportModal = false" class="px-4 py-2 text-gray-400 hover:text-white">Close</button>
            </div>
        </div>
    </div>
}

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); };
    window.copyTextToClipboard = async (text) => {
        try { await navigator.clipboard.writeText(text); } catch (err) { console.error(err); }
    };
</script>

@code {
    private string CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private bool showImportModal = false;
    private User? currentUser;

    // View State
    private string currentView = "day"; 
    private DateTime viewDate = DateTime.UtcNow;

    // Data
    private List<BulletMedia> AllMedia = new();
    private List<BulletTask> AllTasks = new();
    
    private bool isImporting = false;
    private List<string> debugLogs = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isDbError) 
        { 
            try 
            { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var session = JsonSerializer.Deserialize<SessionData>(json, options);
                
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }

                currentUser = await Db.Users.FindAsync(session.UserId);
                
                if (currentUser != null) {
                    await LoadData();
                    _ = FetchWeather();
                }

                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); } catch {}
                viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes);
                
                _ = StartClock();
                StateHasChanged();
            } 
            catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }

    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private void CloseMenus() { showUserMenu = false; }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", forceLoad: true); }

    // --- VIEW LOGIC ---
    private void SwitchView(string view) { currentView = view; StateHasChanged(); }
    
    private void Prev() 
    {
        if (currentView == "day") viewDate = viewDate.AddDays(-1);
        else if (currentView == "week") viewDate = viewDate.AddDays(-7);
        else if (currentView == "month") viewDate = viewDate.AddMonths(-1);
    }

    private void Next() 
    {
        if (currentView == "day") viewDate = viewDate.AddDays(1);
        else if (currentView == "week") viewDate = viewDate.AddDays(7);
        else if (currentView == "month") viewDate = viewDate.AddMonths(1);
    }

    private void GoToday() 
    { 
        viewDate = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); 
        SwitchView("day"); // FORCE DAY MODE
    }
    
    private void GoToDate(DateTime d) { viewDate = d; SwitchView("day"); }

    private string GetHeaderDate()
    {
        if (currentView == "day") return viewDate.ToString("dddd, MMMM d, yyyy");
        if (currentView == "week") {
            var start = GetStartOfWeek(viewDate);
            return $"Week of {start:MMM d, yyyy}";
        }
        if (currentView == "month") return viewDate.ToString("MMMM yyyy");
        return "";
    }

    private DateTime GetStartOfWeek(DateTime d)
    {
        var diff = (7 + (d.DayOfWeek - DayOfWeek.Monday)) % 7;
        return d.AddDays(-1 * diff).Date;
    }

    private List<BulletMedia> GetMediaForDate(DateTime d) => AllMedia.Where(m => m.Date.Date == d.Date).ToList();
    
    private List<BulletTask> GetTasksForDate(DateTime d, string? category = null)
    {
        var tasks = AllTasks.Where(t => t.Date.Date == d.Date);
        if (!string.IsNullOrEmpty(category)) return tasks.Where(t => t.Category == category).ToList();
        return tasks.ToList();
    }

    // --- RENDERERS ---
    private RenderFragment RenderMediaCard(BulletMedia m, bool compact = false) => __builder =>
    {
        if (compact)
        {
            <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-purple-500 transition shadow mb-1 flex items-stretch h-14">
                 @if(!string.IsNullOrEmpty(m.ImgUrl)) {
                    <div class="w-10 shrink-0 bg-black">
                        <img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy" />
                    </div>
                }
                <div class="flex-1 p-1 min-w-0 flex flex-col justify-center">
                    <h4 class="font-bold text-white text-xs truncate leading-tight">@m.Title</h4>
                    @if(m.Rating > 0) { <div class="text-xs text-yellow-400">@m.Rating ‚òÖ</div> }
                </div>
            </div>
        }
        else
        {
            // Day View Split Layout (40% Image | 60% Content)
            <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-purple-500 transition shadow-lg w-full mb-3 flex flex-row">
                <div class="w-[40%] bg-black relative">
                    @if(!string.IsNullOrEmpty(m.ImgUrl)) { <img src="@m.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 120px;" /> }
                    else { <div class="w-full h-full flex items-center justify-center text-3xl text-gray-700">üé¨</div> }
                </div>
                <div class="w-[60%] p-3 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-1">
                             <h4 class="font-bold text-white text-base leading-tight truncate mr-2">@m.Title</h4>
                             @if(m.Rating > 0) {
                                 <div class="shrink-0 bg-yellow-900/30 text-yellow-400 text-sm font-bold px-1.5 py-0.5 rounded border border-yellow-700/50">
                                     @m.Rating ‚òÖ
                                 </div>
                             }
                        </div>
                        @if(!string.IsNullOrEmpty(m.Description)) { <p class="text-sm text-gray-400 line-clamp-3 leading-snug">@m.Description</p> }
                    </div>
                </div>
            </div>
        }
    };

    private RenderFragment RenderTaskCard(BulletTask t) => __builder =>
    {
        if(!string.IsNullOrEmpty(t.ImgUrl))
        {
            // Task with Image (Day View) - Split Layout
            <div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden group relative hover:border-blue-500 transition shadow-md mb-2 flex flex-row">
                <div class="w-[30%] bg-black relative">
                    <img src="@t.ImgUrl" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition" loading="lazy" style="min-height: 80px;" />
                </div>
                <div class="w-[70%] p-3 flex items-start gap-2">
                    <input type="checkbox" checked="@t.IsCompleted" disabled class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0" />
                    <div class="flex-1 min-w-0">
                        <h4 class="text-base font-bold text-white leading-tight @(t.IsCompleted ? "line-through text-gray-500" : "")">@t.Title</h4>
                        @if(!string.IsNullOrEmpty(t.Description))
                        {
                            <p class="text-sm text-gray-500 mt-1 line-clamp-2">@t.Description</p>
                        }
                        @if(!string.IsNullOrEmpty(t.TicketNumber))
                        {
                            <span class="inline-block bg-gray-800 text-xs text-blue-300 px-1.5 rounded border border-blue-900 mt-1">@t.TicketNumber</span>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            // Standard Layout (No Image)
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-2 hover:border-blue-500 transition shadow-md group">
                <div class="flex items-start gap-2">
                    <input type="checkbox" checked="@t.IsCompleted" disabled class="mt-1 w-4 h-4 rounded bg-gray-800 border-gray-600 shrink-0" />
                    <div class="flex-1 min-w-0">
                        <h4 class="text-base font-bold text-white leading-tight @(t.IsCompleted ? "line-through text-gray-500" : "")">@t.Title</h4>
                        @if(!string.IsNullOrEmpty(t.Description))
                        {
                            <p class="text-sm text-gray-500 mt-1 line-clamp-2">@t.Description</p>
                        }
                        @if(!string.IsNullOrEmpty(t.TicketNumber))
                        {
                            <span class="inline-block bg-gray-800 text-xs text-blue-300 px-1.5 rounded border border-blue-900 mt-1">@t.TicketNumber</span>
                        }
                    </div>
                </div>
            </div>
        }
    };

    private RenderFragment RenderTaskPill(BulletTask t) => __builder =>
    {
        if(!string.IsNullOrEmpty(t.ImgUrl))
        {
             // Mini Card Style (Image Left) for Week/Month
            <div class="bg-gray-900 border border-gray-700 rounded overflow-hidden group relative hover:border-blue-500 transition shadow mb-1 flex items-stretch h-14">
                <div class="w-10 shrink-0 bg-black">
                    <img src="@t.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy" />
                </div>
                <div class="flex-1 p-1 min-w-0 flex flex-col justify-center">
                    <div class="flex items-center gap-1">
                        <span class="text-xs @(t.IsCompleted ? "text-green-500" : "text-blue-400")">@(t.IsCompleted ? "‚úì" : "‚Ä¢")</span>
                        <h4 class="font-bold text-white text-xs truncate leading-tight @(t.IsCompleted ? "line-through text-gray-500" : "")">@t.Title</h4>
                    </div>
                </div>
            </div>
        }
        else
        {
            // Standard Pill Style
            <div class="text-xs px-1 py-0.5 rounded truncate mb-1 border flex items-center gap-1 @(t.IsCompleted ? "bg-gray-800 text-gray-500 border-gray-700 line-through" : "bg-blue-900/30 text-blue-200 border-blue-800")">
                <span class="@(t.IsCompleted ? "text-green-500" : "text-blue-400")">@(t.IsCompleted ? "‚úì" : "‚Ä¢")</span>
                @t.Title
            </div>
        }
    };

    // --- DATA OPERATIONS ---
    private async Task LoadData()
    {
        if (currentUser == null) return;
        try 
        {
            // Try Loading all. If table missing, specific error catch will handle it.
            AllMedia = await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            AllTasks = await Db.Set<BulletTask>().Where(i => i.UserId == currentUser.Id).ToListAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("42P01")) // Table missing error code
            {
                isDbError = true;
                errorMessage = "Database Tables missing. Please create them.";
            }
        }
    }

    // --- IMPORT LOGIC ---
    private void Log(string msg) { debugLogs.Add($"{DateTime.Now:HH:mm:ss} - {msg}"); InvokeAsync(StateHasChanged); }
    private void ClearLogs() => debugLogs.Clear();
    private async Task CopyLogs() { var text = string.Join("\n", debugLogs); await JS.InvokeVoidAsync("copyTextToClipboard", text); Log("Logs copied."); }

    private async Task ImportTasks()
    {
        if (currentUser == null) return;
        isImporting = true; debugLogs.Clear(); Log("Scanning Tasks...");
        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if (!File.Exists(filePath)) { Log("File not found."); return; }
            var jsonContent = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(jsonContent);
            var root = doc.RootElement;
            List<JsonElement> rawList = new();
            if (root.ValueKind == JsonValueKind.Array) { foreach (var el in root.EnumerateArray()) rawList.Add(el); }
            else if (root.ValueKind == JsonValueKind.Object) {
                if (root.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array) foreach (var el in items.EnumerateArray()) rawList.Add(el);
            }
            
            var newItems = new List<BulletTask>();
            int skipped = 0;
            foreach (var raw in rawList)
            {
                string type = "";
                if (raw.TryGetProperty("type", out var t)) type = t.ToString().ToLower();
                
                if (type != "task") { skipped++; continue; }

                try
                {
                    var item = new BulletTask();
                    item.UserId = currentUser.Id;
                    
                    if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
                    else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString();
                    
                    if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt)) item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
                    else item.Date = DateTime.UtcNow;

                    if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
                    else if (raw.TryGetProperty("notes", out var n)) item.Description = n.ToString();
                    
                    if (raw.TryGetProperty("category", out var cat)) item.Category = cat.ToString();
                    if (raw.TryGetProperty("ticketNumber", out var tn)) item.TicketNumber = tn.ToString();
                    if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString();
                    if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
                    
                    if (raw.TryGetProperty("status", out var s) && s.ToString() == "completed") item.IsCompleted = true;
                    if (raw.TryGetProperty("isCompleted", out var ic) && ic.ValueKind == JsonValueKind.True) item.IsCompleted = true;

                    if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();

                    newItems.Add(item);
                }
                catch (Exception ex) { Log($"Error mapping: {ex.Message}"); }
            }

            if (newItems.Any()) { await Db.Set<BulletTask>().AddRangeAsync(newItems); await Db.SaveChangesAsync(); Log($"Imported {newItems.Count} tasks."); await LoadData(); }
            else { Log("No tasks found."); }
        }
        catch (Exception ex) { Log($"Error: {ex.Message}"); }
        finally { isImporting = false; }
    }
    
    private async Task WipeTasks()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Delete All Tasks?")) {
            var items = await Db.Set<BulletTask>().Where(i => i.UserId == currentUser!.Id).ToListAsync();
            Db.Set<BulletTask>().RemoveRange(items); await Db.SaveChangesAsync(); await LoadData();
        }
    }
    
    private async Task UpgradeDatabase() {
        try {
             // Explicitly Create BulletTasks and BulletMedia if missing
             await Db.Database.ExecuteSqlRawAsync(@"
                CREATE TABLE IF NOT EXISTS ""BulletMedia"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'Movie', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""Rating"" integer DEFAULT 0, ""ReleaseYear"" integer DEFAULT 0, ""Actors"" text DEFAULT '', ""Tags"" text DEFAULT '', ""OriginalStringId"" text);
                CREATE TABLE IF NOT EXISTS ""BulletTasks"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""Category"" text DEFAULT 'personal', ""Type"" text DEFAULT 'task', ""IsCompleted"" boolean DEFAULT false, ""Priority"" text DEFAULT 'Normal', ""LinkUrl"" text, ""ImgUrl"" text, ""ImageId"" integer, ""Description"" text, ""TicketNumber"" text, ""TicketUrl"" text, ""Tags"" text, ""DueDate"" timestamp with time zone, ""OriginalStringId"" text);
             ");
             isDbError = false; await LoadData();
             Log("Tables Created Successfully");
        } catch (Exception ex) { errorMessage = ex.Message; Log($"DB Error: {ex.Message}"); }
    }

    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"‚õÖ", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}