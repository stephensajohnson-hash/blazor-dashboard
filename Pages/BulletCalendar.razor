@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.IO
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Setup Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">
                Create BulletItems Table
            </button>
        </div>
    }
    else
    {
        <main class="w-full p-8 relative scroll-smooth" @onclick="CloseMenus">
            
            <div class="mb-10 border-b border-gray-800 pb-4 flex items-center justify-between">
                <div>
                    <div class="flex items-baseline gap-4">
                        <h2 class="text-3xl font-bold text-white tracking-tight">@CurrentDate</h2>
                        <span class="text-xl font-medium text-gray-400">@CurrentTime</span>
                    </div>
                    <div class="text-[10px] text-gray-600 font-mono mt-1">v1.3.0 (Namespace Fix)</div>
                </div>

                <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <a href="/" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Home">üè†</a>
                    <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Bullet Calendar">‚úÖ</a>
                    <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
                </div>

                <div class="flex items-center gap-6">
                    @if (weather?.current != null)
                    {
                        <div class="flex items-center gap-4 bg-gray-800/30 px-4 py-2 rounded-xl border border-gray-700/30 transition hover:bg-gray-800/50">
                            <div class="flex items-center gap-2 pr-4 border-r border-gray-600">
                                <span class="text-2xl">@GetWeatherIcon(weather.current.weather_code)</span>
                                <div class="text-right">
                                    <div class="font-bold text-white text-lg leading-none">@weather.current.temperature_2m.ToString("0")¬∞</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                @if (weather.daily?.time != null)
                                {
                                    @for (int i = 1; i <= 5 && i < weather.daily.time.Length; i++)
                                    {
                                        <div class="flex flex-col items-center">
                                            <span class="text-[9px] text-gray-500 font-bold uppercase">@GetDayName(weather.daily.time[i])</span>
                                            <span class="text-[10px] my-0.5">@GetWeatherIcon(weather.daily.weather_code[i])</span>
                                            <div class="text-[8px] font-mono flex gap-1">
                                                <span class="text-white">@weather.daily.temperature_2m_max[i].ToString("0")¬∞</span>
                                                <span class="text-gray-500">@weather.daily.temperature_2m_min[i].ToString("0")¬∞</span>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }

                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" 
                                 class="w-10 h-10 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu)
                        {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <a href="settings" class="block w-full text-left text-xs text-gray-300 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>‚öôÔ∏è</span> Settings</a>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="max-w-6xl mx-auto">
                
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-200">Database Verification</h3>
                        <p class="text-xs text-gray-500">Checking: wwwroot/bullet_calendar.json</p>
                    </div>
                    
                    <div class="flex gap-3">
                         <button @onclick="ImportFromServer" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">
                             @if(isImporting) { <span>‚è≥ Processing...</span> } else { <span>üìÇ Import from Server</span> }
                        </button>
                         <button @onclick="LoadData" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                            üîÑ Refresh
                        </button>
                         <button @onclick="WipeData" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                            üóëÔ∏è Wipe Table
                        </button>
                    </div>
                </div>
                
                @if (debugLogs.Any())
                {
                    <div class="bg-black border border-gray-700 rounded-lg p-3 mb-6 font-mono text-[10px] text-green-400 max-h-40 overflow-y-auto relative group">
                        <div class="flex justify-between border-b border-gray-800 pb-1 mb-1 text-gray-500 uppercase font-bold sticky top-0 bg-black z-10">
                            <span>Console Output</span>
                            <div class="flex gap-2">
                                <button @onclick="CopyLogs" class="hover:text-white">üìã Copy Logs</button>
                                <button @onclick="ClearLogs" class="hover:text-white">Clear</button>
                            </div>
                        </div>
                        @foreach(var log in debugLogs)
                        {
                            <div class="mb-1 border-b border-gray-900/50 pb-1 break-all">@log</div>
                        }
                    </div>
                }

                @if (!Items.Any())
                {
                    <div class="flex flex-col items-center justify-center h-64 border-2 border-dashed border-gray-800 rounded-2xl bg-gray-900/50">
                        <div class="text-4xl mb-4">üì≠</div>
                        <p class="text-gray-500 font-bold">Database is empty</p>
                        <p class="text-gray-600 text-sm mt-2">Click "Import from Server" to load data from wwwroot.</p>
                    </div>
                }
                else
                {
                    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-xl">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 font-bold">
                                <tr>
                                    <th class="p-4 border-b border-gray-700">ID</th>
                                    <th class="p-4 border-b border-gray-700">Type</th>
                                    <th class="p-4 border-b border-gray-700">Date</th>
                                    <th class="p-4 border-b border-gray-700">Content</th>
                                    <th class="p-4 border-b border-gray-700 text-center">Done</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-gray-700">
                                @foreach (var item in Items)
                                {
                                    <tr class="hover:bg-gray-700/50 transition">
                                        <td class="p-4 font-mono text-blue-400 font-bold">@item.Id</td>
                                        <td class="p-4">
                                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase @GetTypeColor(item.Type)">
                                                @item.Type
                                            </span>
                                        </td>
                                        <td class="p-4 text-gray-300">@item.Date.ToString("MMM dd, yyyy")</td>
                                        <td class="p-4 text-white font-medium">@item.Content</td>
                                        <td class="p-4 text-center">
                                            @if (item.IsCompleted) { <span class="text-green-400">‚úî</span> }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center text-xs text-gray-500 mt-4">Showing first 50 items for verification</div>
                }
            </div>

        </main>
    }
</div>

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); };
    window.copyTextToClipboard = async (text) => {
        try {
            await navigator.clipboard.writeText(text);
        } catch (err) {
            console.error('Failed to copy: ', err);
        }
    };
</script>

@code {
    private string CurrentDate = "", CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private User? currentUser;

    // Data Logic
    private List<BulletItem> Items = new();
    private bool isImporting = false;
    private List<string> debugLogs = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isDbError) 
        { 
            try 
            { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var session = JsonSerializer.Deserialize<SessionData>(json, options);
                
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }

                currentUser = await Db.Users.FindAsync(session.UserId);
                
                if (currentUser != null) {
                    await LoadData();
                    _ = FetchWeather();
                }

                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); UpdateTime(); } catch {}
                _ = StartClock();
                StateHasChanged();
            } 
            catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }

    private void Log(string msg)
    {
        var line = $"{DateTime.Now:HH:mm:ss} - {msg}";
        debugLogs.Add(line);
        Console.WriteLine($"[BULLET] {msg}"); 
        InvokeAsync(StateHasChanged);
    }
    
    private void ClearLogs() => debugLogs.Clear();
    
    private async Task CopyLogs()
    {
        var text = string.Join("\n", debugLogs);
        await JS.InvokeVoidAsync("copyTextToClipboard", text);
        Log("Logs copied to clipboard.");
    }

    private async Task LoadData()
    {
        if (currentUser == null) return;
        try 
        {
            // Use generic Set because we just added BulletItems to Data.cs, but context might need reload or just to be safe
            Items = await Db.Set<BulletItem>()
                            .Where(i => i.UserId == currentUser.Id)
                            .OrderByDescending(i => i.Date)
                            .Take(50)
                            .ToListAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("42P01")) 
            {
                isDbError = true;
                errorMessage = "Table 'BulletItems' does not exist.";
            }
        }
    }

    private async Task ImportFromServer()
    {
        if (currentUser == null) return;
        isImporting = true;
        ClearLogs();
        Log("Starting server-side import...");

        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            Log($"Looking for file at: {filePath}");

            if (!File.Exists(filePath))
            {
                Log("ERROR: File not found in wwwroot folder.");
                return;
            }

            Log("File found. Reading content...");
            var jsonContent = await File.ReadAllTextAsync(filePath);
            Log($"Read {jsonContent.Length} characters.");

            if (string.IsNullOrWhiteSpace(jsonContent))
            {
                Log("File is empty.");
                return;
            }

            // --- SMART PARSING LOGIC ---
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            using var doc = JsonDocument.Parse(jsonContent);
            var root = doc.RootElement;

            List<JsonElement> rawList = new();

            if (root.ValueKind == JsonValueKind.Array)
            {
                Log("Root is Array. proceeding...");
                foreach (var el in root.EnumerateArray()) rawList.Add(el);
            }
            else if (root.ValueKind == JsonValueKind.Object)
            {
                Log("Root is Object. Searching for array property...");
                // Common property names for lists
                if (root.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array) 
                {
                    Log("Found 'items' array.");
                    foreach (var el in items.EnumerateArray()) rawList.Add(el);
                }
                else if (root.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array) 
                {
                    Log("Found 'data' array.");
                    foreach (var el in data.EnumerateArray()) rawList.Add(el);
                }
                else if (root.TryGetProperty("bulletItems", out var bi) && bi.ValueKind == JsonValueKind.Array) 
                {
                    Log("Found 'bulletItems' array.");
                    foreach (var el in bi.EnumerateArray()) rawList.Add(el);
                }
                else
                {
                     Log("Could not find a valid array property. Trying to map root properties as single item...");
                     rawList.Add(root);
                }
            }
            else
            {
                Log($"Unknown Root Type: {root.ValueKind}");
                return;
            }

            Log($"Found {rawList.Count} items to process.");

            var newItems = new List<BulletItem>();
            int success = 0;

            foreach (var raw in rawList)
            {
                try
                {
                    var item = new BulletItem();
                    item.UserId = currentUser.Id;
                    
                    // --- CONTENT ---
                    if (raw.TryGetProperty("content", out var c)) item.Content = c.ToString();
                    else if (raw.TryGetProperty("text", out c)) item.Content = c.ToString();
                    else if (raw.TryGetProperty("title", out c)) item.Content = c.ToString();
                    else item.Content = "(No Content)";
                    
                    // --- DATE ---
                    if (raw.TryGetProperty("date", out var d))
                    {
                        string dateStr = d.ToString();
                        if (DateTime.TryParse(dateStr, out var dt))
                            item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
                        else
                        {
                             item.Date = DateTime.UtcNow;
                             Log($"Invalid date '{dateStr}'. Used Now.");
                        }
                    }
                    else
                    {
                        item.Date = DateTime.UtcNow;
                    }

                    // --- TYPE ---
                    if (raw.TryGetProperty("type", out var t))
                        item.Type = t.ToString().ToLower();
                    else
                        item.Type = "task"; 

                    // --- COMPLETED ---
                    if (raw.TryGetProperty("isCompleted", out var ic)) item.IsCompleted = ic.ValueKind == JsonValueKind.True;
                    else if (raw.TryGetProperty("completed", out ic)) item.IsCompleted = ic.ValueKind == JsonValueKind.True;
                    else if (raw.TryGetProperty("done", out ic)) item.IsCompleted = ic.ValueKind == JsonValueKind.True;
                    
                    // --- ID ---
                    if (raw.TryGetProperty("id", out var oldId))
                        item.OriginalStringId = oldId.ToString();

                    newItems.Add(item);
                    success++;
                }
                catch (Exception itemEx)
                {
                    Log($"Skipped item error: {itemEx.Message}");
                }
            }

            Log($"Successfully mapped {success} items.");

            if (newItems.Any())
            {
                Log("Saving to Database...");
                await Db.Set<BulletItem>().AddRangeAsync(newItems);
                await Db.SaveChangesAsync();
                Log("SAVE COMPLETE!");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Log($"CRITICAL ERROR: {ex.Message}");
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private async Task UpgradeDatabase()
    {
        try 
        {
            await Db.Database.ExecuteSqlRawAsync(@"
                CREATE TABLE IF NOT EXISTS ""BulletItems"" (
                    ""Id"" serial PRIMARY KEY,
                    ""UserId"" integer NOT NULL,
                    ""Type"" text NOT NULL,
                    ""Content"" text,
                    ""Date"" timestamp with time zone NOT NULL,
                    ""IsCompleted"" boolean DEFAULT false,
                    ""Order"" integer DEFAULT 0,
                    ""OriginalStringId"" text
                );
            ");
            isDbError = false;
            Log("Table created successfully.");
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Log($"DB Create Error: {ex.Message}");
        }
    }

    private async Task WipeData()
    {
        if (await JS.InvokeAsync<bool>("confirm", "‚ö†Ô∏è Delete ALL Bullet Items? This cannot be undone."))
        {
            Log("Wiping data...");
            var items = await Db.Set<BulletItem>().Where(i => i.UserId == currentUser!.Id).ToListAsync();
            Db.Set<BulletItem>().RemoveRange(items);
            await Db.SaveChangesAsync();
            Log("Data Wiped.");
            await LoadData();
        }
    }

    private string GetTypeColor(string type) => type switch {
        "task" => "bg-blue-900 text-blue-300",
        "event" => "bg-purple-900 text-purple-300",
        "note" => "bg-gray-700 text-gray-300",
        _ => "bg-gray-800 text-white"
    };

    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private void CloseMenus() { showUserMenu = false; }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session");
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); string suffix = (now.Day % 10 == 1 && now.Day != 11) ? "st" : (now.Day % 10 == 2 && now.Day != 12) ? "nd" : (now.Day % 10 == 3 && now.Day != 13) ? "rd" : "th"; CurrentDate = $"{now:dddd, MMMM d}{suffix} {now:yyyy}"; CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"Qw", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}