@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Globalization
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject BulletMeetingService MeetingService
@inject BulletHabitService HabitService
@inject BulletMediaService MediaService
@inject BulletHolidayService HolidayService
@inject BulletBirthdayService BirthdayService
@inject BulletAnniversaryService AnniversaryService
@inject BulletVacationService VacationService
@inject BulletHealthService HealthService
@inject BulletSportsService SportsService
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Calendar | Stephens' Dashboard</PageTitle>

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 relative font-sans">
    
    <BulletHeader 
        ShowControls="true"
        CustomDateText="@GetHeaderDate()"
        ActiveView="@currentView"
        OnPrev="Prev"
        OnNext="Next"
        OnGoToday="GoToday"
        OnViewChanged="SwitchView">
        
        <div class="flex items-center gap-2 ml-4">
            <div class="relative flex items-center bg-black/40 border border-gray-700 rounded-lg px-2 focus-within:border-blue-500 transition-all font-black">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                
                <input @bind="searchQuery" 
                       @bind:event="oninput" 
                       @onkeyup="HandleKeyUp"
                       placeholder="Quick search..." 
                       class="bg-transparent border-none text-xs py-1.5 px-2 w-32 md:w-48 outline-none text-white font-bold" />
                
                @if(!string.IsNullOrWhiteSpace(searchQuery) || isSearching)
                {
                    <button @onclick="ClearSearch" class="text-gray-500 hover:text-red-400 p-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                }
            </div>
        </div>
    </BulletHeader>

    <div class="px-6 h-[calc(100vh-140px)] overflow-hidden pt-4 font-black">
        @if (isSearching)
        {
            <div class="h-full flex flex-col font-black">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-sm font-black uppercase tracking-[0.2em] text-blue-400">Search Results: @searchResults.Count</h2>
                    <button @onclick="ClearSearch" class="text-[10px] font-bold text-gray-400 hover:text-red-400 uppercase tracking-widest">Close Search</button>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 scrollbar-hide">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                        @foreach (var item in searchResults)
                        {
                            <div class="h-full border border-gray-800 rounded-xl overflow-hidden bg-gray-800/20 shadow-lg relative p-1">
                                <div class="absolute top-2 right-2 z-10 bg-blue-600 text-[8px] font-black px-1.5 py-0.5 rounded uppercase">@item.Date.ToString("MMM dd")</div>
                                @RenderItem(item)
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 h-full font-black">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden shadow-2xl">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                            <span class="font-bold text-@cat.Item3-400 uppercase tracking-wider text-sm">@cat.Item1</span>
                            <button @onclick='() => OpenEditor(cat.Item2, cat.Item2 == "health" ? "health" : "task", viewDate)' 
                                    class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition font-bold uppercase">ï¼‹ Add</button>
                        </div>
                        <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                            @if(isLoading) { <div class="text-center text-gray-500 text-xs italic mt-4 animate-pulse">Syncing...</div> }
                            else {
                                var currentColumnItems = GetSortedItems(GetItemsForColumn(viewDate, cat.Item2));
                                foreach(var item in currentColumnItems) 
                                { 
                                    <div @key="item.Id">@RenderItem(item)</div> 
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 h-full font-sans font-bold">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    <div class="flex flex-col h-full rounded-xl border @GetDayBorderClass(d) overflow-hidden bg-gray-800/40">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700" @onclick="() => GoToDate(d)">
                            <div class="text-[10px] uppercase font-black text-gray-500">@d.ToString("ddd")</div>
                            <div class="text-lg font-black text-white">@d.Day</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                            @foreach(var item in GetSortedItems(GetItemsForDate(d))) { @RenderPill(item) }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col h-full font-sans font-black">
                <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        <div class="relative flex flex-col rounded-lg border @GetDayBorderClass(currentDay) p-1 hover:bg-gray-800 transition cursor-pointer bg-gray-900/50 shadow-inner" @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-[10px] font-bold text-gray-500 mb-1">@d</div>
                            <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-24">
                                @foreach(var item in GetSortedItems(GetItemsForDate(currentDay))) { @RenderPill(item) }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@* Rendering Logic separated to avoid build ambiguity *@
@code {
    RenderFragment RenderItem(BulletTaskService.TaskDTO item) => __builder => {
        @if (item.Type == "meeting") { <MeetingCard Item="item" OnClick="() => OpenEdit(item)" OnToggle="() => ToggleMeetingComplete(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else if (item.Type == "habit") { <HabitCard Item="@(GetHabit(item.Id))" OnClick="() => OpenHabitEdit(GetHabit(item.Id))" OnDelete="() => DeleteTask(item.Id)" OnChange="SaveHabitDirectly" /> }
        else if (item.Type == "birthday") { <BirthdayCard Item="item" OnClick="() => OpenEdit(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else if (item.Type == "anniversary") { <AnniversaryCard Item="item" OnClick="() => OpenEdit(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else if (item.Type == "sports") { <SportsCard Item="@(GetGame(item.Id))" OnClick="() => OpenSportsEdit(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else if (item.Type == "media") { <MediaCard Item="item" OnClick="() => OpenEdit(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else if (item.Type == "health") { <HealthCard Item="item" User="currentUser" OnClick="() => OpenEdit(item)" OnDelete="() => DeleteTask(item.Id)" /> }
        else { <TaskCard Item="item" OnClick="() => OpenEdit(item)" OnToggle="() => ToggleComplete(item)" OnDelete="() => DeleteTask(item.Id)" /> }
    };

    RenderFragment RenderPill(BulletTaskService.TaskDTO item) => __builder => {
        @if(item.Type == "sports") { <SportsPill Item="@(GetGame(item.Id))" OnClick="() => OpenSportsEdit(item)" /> }
        else { <TaskPill Task="item" OnClick="() => OpenEdit(item)" /> }
    };
}

@code {
    private User? currentUser; 
    private int userId = 0; 
    private DateTime viewDate = DateTime.UtcNow; 
    private string currentView = "day"; 
    private int clientOffset = 0; 
    private bool isLoading = true;
    
    private List<League> allLeagues = new(); 
    private List<Team> allTeams = new();
    
    private List<BulletTaskService.TaskDTO> loadedItems = new(); 
    private List<BulletHabitService.HabitDTO> loadedHabits = new(); 
    private List<BulletSportsService.GameDTO> loadedGames = new();
    
    private BulletTaskService.TaskDTO? editingItem;
    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);

    private string searchQuery = ""; 
    private bool isSearching = false; 
    private bool showAdvancedSearch = false; 
    private List<BulletTaskService.TaskDTO> searchResults = new();

    private async Task LogToConsole(string message) => await JS.InvokeVoidAsync("console.log", $"[CALENDAR] {message}");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) {
                    using var doc = JsonDocument.Parse(json);
                    if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) userId = p.GetInt32();
                    if(userId > 0) {
                        currentUser = await Db.Users.FindAsync(userId);
                        if(currentUser != null) {
                            clientOffset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()");
                            
                            var uri = Nav.ToAbsoluteUri(Nav.Uri);
                            if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("date", out var dateValue))
                            {
                                if (DateTime.TryParse(dateValue, out var parsed)) viewDate = parsed;
                            } else {
                                viewDate = DateTime.UtcNow.AddMinutes(-clientOffset);
                            }

                            allLeagues = await Db.Leagues.OrderBy(x => x.Name).ToListAsync();
                            allTeams = await Db.Teams.ToListAsync();
                            await LoadData();
                        }
                    }
                }
            } catch (Exception ex) { await LogToConsole($"Init Fail: {ex.Message}"); }
            finally { isLoading = false; StateHasChanged(); }
        }
    }

    private async Task LoadData()
    {
        if (currentUser == null) return; 
        isLoading = true; 
        StateHasChanged();
        
        DateTime start = DateTime.SpecifyKind(viewDate.Date, DateTimeKind.Utc); 
        DateTime end = start.AddDays(1).AddSeconds(-1);

        if (currentView == "week") { start = weekStart; end = start.AddDays(7).AddSeconds(-1); }
        else if (currentView == "month") { start = new DateTime(viewDate.Year, viewDate.Month, 1); end = start.AddMonths(1).AddSeconds(-1); }
        
        try 
        {
            loadedItems.Clear();
            await LogToConsole($"Syncing data for: {start:yyyy-MM-dd}");

            // 1. Core
            loadedItems.AddRange(await TaskService.GetTasksForRange(userId, start, end));
            loadedItems.AddRange(await MeetingService.GetMeetingsForRange(userId, start, end));

            // 2. Birthdays (Try/Catch protected)
            try {
                var bdays = await BirthdayService.GetBirthdaysForRange(userId, start, end);
                foreach(var b in bdays) loadedItems.Add(new BulletTaskService.TaskDTO { Id = b.Id, UserId = b.UserId, Type = "birthday", Category = "personal", Date = b.Date, Title = b.Title, BirthdayDetail = b.Detail });
                await LogToConsole($"Loaded {bdays.Count} Birthdays");
            } catch { await LogToConsole("Birthdays unavailable."); }

            // 3. Media (Safe Check for Service Method Name)
            try {
                // If this method name fails in build, we will check your MediaService definition
                var mediaItems = await MediaService.GetMedia(userId); 
                var filteredMedia = mediaItems.Where(x => x.Date.Date >= start.Date && x.Date.Date <= end.Date);
                foreach(var m in filteredMedia) loadedItems.Add(new BulletTaskService.TaskDTO { Id = m.Id, UserId = m.UserId, Type = "media", Category = "personal", Date = m.Date, Title = m.Title, MediaDetail = m.Detail });
            } catch { await LogToConsole("Media skip."); }

            // 4. Sports
            try {
                loadedGames = await SportsService.GetGamesForRange(userId, start, end);
                foreach(var g in loadedGames) loadedItems.Add(new BulletTaskService.TaskDTO { Id = g.Id, UserId = g.UserId, Type = "sports", Category = "personal", Date = g.Date, Title = g.Title, SportsDetail = g.Detail });
            } catch { await LogToConsole("Sports skip."); }

            // 5. Habits
            try {
                loadedHabits = await HabitService.GetHabits(userId);
                foreach(var h in loadedHabits.Where(x => x.Date.Date >= start.Date && x.Date.Date <= end.Date))
                    loadedItems.Add(new BulletTaskService.TaskDTO { Id = h.Id, UserId = h.UserId, Type = "habit", Category = h.Category, Date = h.Date, Title = h.Title, HabitDetail = h.Detail });
            } catch { }
        }
        catch (Exception ex) { await LogToConsole($"Data Sync Error: {ex.Message}"); }

        isLoading = false; 
        StateHasChanged();
    }

    // Helper Methods
    private void OpenEditor(string category, string type, DateTime date) => editingItem = new BulletTaskService.TaskDTO { UserId = userId, Category = category, Type = type, Date = date };
    private void GoToDate(DateTime d) { viewDate = d; currentView = "day"; _ = LoadData(); }
    private void Prev() { if(currentView == "day") viewDate = viewDate.AddDays(-1); else if(currentView == "week") viewDate = viewDate.AddDays(-7); else viewDate = viewDate.AddMonths(-1); _ = LoadData(); }
    private void Next() { if(currentView == "day") viewDate = viewDate.AddDays(1); else if(currentView == "week") viewDate = viewDate.AddDays(7); else viewDate = viewDate.AddMonths(1); _ = LoadData(); }
    private void GoToday() { viewDate = DateTime.UtcNow.AddMinutes(-clientOffset); _ = LoadData(); }
    private void SwitchView(string v) { currentView = v; _ = LoadData(); }
    private string GetHeaderDate() => currentView == "day" ? viewDate.ToString("D") : (currentView == "week" ? $"Week of {weekStart:MMM d}" : viewDate.ToString("MMMM yyyy"));

    private async Task DeleteTask(int id) { if(await JS.InvokeAsync<bool>("confirm", "Delete?")) { await BaseService.DeleteItem(id); await LoadData(); } }
    private void OpenEdit(BulletTaskService.TaskDTO t) { editingItem = t; }
    private void OpenSportsEdit(BulletTaskService.TaskDTO t) { editingItem = t; }
    private void OpenHabitEdit(BulletHabitService.HabitDTO h) { editingItem = new BulletTaskService.TaskDTO { Id = h.Id, Type = "habit", HabitDetail = h.Detail }; }
    private async Task ToggleComplete(BulletTaskService.TaskDTO t) { await TaskService.ToggleComplete(t.Id, !t.Detail.IsCompleted); await LoadData(); }
    private async Task ToggleMeetingComplete(BulletTaskService.TaskDTO t) { await MeetingService.ToggleComplete(t.Id, !t.MeetingDetail.IsCompleted); await LoadData(); }
    private async Task SaveHabitDirectly(BulletHabitService.HabitDTO h) { await HabitService.SaveHabit(h); await LoadData(); }
    private async Task HandleKeyUp(KeyboardEventArgs e) { if (e.Key == "Enter") await PerformQuickSearch(); }
    private async Task PerformQuickSearch() { isSearching = true; searchResults = await BaseService.SearchItems(userId, searchQuery, "all", DateTime.UtcNow.AddYears(-1), DateTime.UtcNow.AddYears(1)); }
    private void ClearSearch() { searchQuery = ""; isSearching = false; _ = LoadData(); }

    private List<BulletTaskService.TaskDTO> GetSortedItems(List<BulletTaskService.TaskDTO> items) => items?.OrderBy(t => t.SortOrder).ToList() ?? new();
    private List<BulletTaskService.TaskDTO> GetItemsForColumn(DateTime d, string cat) { 
        var items = loadedItems.Where(t => t.Date.Date == d.Date); 
        if (cat == "health") return items.Where(t => t.Type == "health" || t.Category == "health").ToList();
        if (cat == "personal") return items.Where(t => t.Category != "work" && t.Category != "health" && t.Type != "health").ToList();
        return items.Where(t => t.Category == "work").ToList();
    }
    private List<BulletTaskService.TaskDTO> GetItemsForDate(DateTime d) => loadedItems.Where(t => t.Date.Date == d.Date).ToList();
    private BulletHabitService.HabitDTO GetHabit(int id) => loadedHabits.FirstOrDefault(h => h.Id == id) ?? new();
    private BulletSportsService.GameDTO GetGame(int id) => loadedGames.FirstOrDefault(g => g.Id == id) ?? new();
    private string GetDayBorderClass(DateTime d) => d.Date == DateTime.Today ? "border-yellow-500 shadow-lg" : "border-gray-700";
}