@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.IO
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-bold">‚ö†Ô∏è Database Setup Required</div>
            <p class="text-gray-400 max-w-md text-center">@errorMessage</p>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg transition">
                Create BulletMedia Table
            </button>
        </div>
    }
    else
    {
        <main class="w-full p-8 relative scroll-smooth">
            
            <div class="mb-10 border-b border-gray-800 pb-4 flex items-center justify-between">
                <div>
                    <div class="flex items-baseline gap-4">
                        <h2 class="text-3xl font-bold text-white tracking-tight">@CurrentDate</h2>
                        <span class="text-xl font-medium text-gray-400">@CurrentTime</span>
                    </div>
                    <div class="text-[10px] text-gray-600 font-mono mt-1">v2.0.0 (Media Import)</div>
                </div>

                <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
                    <a href="/" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Home">üè†</a>
                    <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
                    <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Bullet Calendar">‚úÖ</a>
                    <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
                </div>

                <div class="flex items-center gap-6">
                    @if (weather?.current != null)
                    {
                        <div class="flex items-center gap-4 bg-gray-800/30 px-4 py-2 rounded-xl border border-gray-700/30 transition hover:bg-gray-800/50">
                            <div class="flex items-center gap-2 pr-4 border-r border-gray-600">
                                <span class="text-2xl">@GetWeatherIcon(weather.current.weather_code)</span>
                                <div class="text-right"><div class="font-bold text-white text-lg leading-none">@weather.current.temperature_2m.ToString("0")¬∞</div></div>
                            </div>
                            <div class="flex gap-3">
                                @if (weather.daily?.time != null) {
                                    @for (int i = 1; i <= 5 && i < weather.daily.time.Length; i++) {
                                        <div class="flex flex-col items-center">
                                            <span class="text-[9px] text-gray-500 font-bold uppercase">@GetDayName(weather.daily.time[i])</span>
                                            <span class="text-[10px] my-0.5">@GetWeatherIcon(weather.daily.weather_code[i])</span>
                                            <div class="text-[8px] font-mono flex gap-1"><span class="text-white">@weather.daily.temperature_2m_max[i].ToString("0")¬∞</span><span class="text-gray-500">@weather.daily.temperature_2m_min[i].ToString("0")¬∞</span></div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                    <div class="relative group z-50">
                        <button class="flex items-center gap-3 focus:outline-none" @onclick="ToggleUserMenu">
                            <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "https://i.imgur.com/7Y5j5Yx.png" : currentUser.AvatarUrl)" class="w-10 h-10 rounded-full border-2 border-gray-700 transition object-cover bg-gray-800" />
                        </button>
                        @if (showUserMenu) {
                            <div class="absolute right-0 top-full mt-2 w-56 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-2 z-50">
                                <a href="settings" class="block w-full text-left text-xs text-gray-300 hover:bg-gray-700 p-2 rounded mb-1 transition flex items-center gap-2"><span>‚öôÔ∏è</span> Settings</a>
                                <div class="border-t border-gray-700 my-1"></div>
                                <button type="button" @onclick="Logout" class="w-full text-left text-xs text-red-500 font-bold hover:bg-gray-700 p-2 rounded">Logout</button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="max-w-6xl mx-auto">
                
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-200">Media Library (Movies/TV)</h3>
                        <p class="text-xs text-gray-500">Import only "type: media" records</p>
                    </div>
                    
                    <div class="flex gap-3">
                         <button @onclick="ImportMedia" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm" disabled="@isImporting">
                             @if(isImporting) { <span>‚è≥ Processing...</span> } else { <span>üé¨ Import Media Only</span> }
                        </button>
                         <button @onclick="LoadData" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                            üîÑ Refresh
                        </button>
                         <button @onclick="WipeData" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 text-sm">
                            üóëÔ∏è Wipe Media
                        </button>
                    </div>
                </div>
                
                @if (debugLogs.Any())
                {
                    <div class="bg-black border border-gray-700 rounded-lg p-3 mb-6 font-mono text-[10px] text-green-400 max-h-40 overflow-y-auto relative group">
                        <div class="flex justify-between border-b border-gray-800 pb-1 mb-1 text-gray-500 uppercase font-bold sticky top-0 bg-black z-10">
                            <span>Console Output</span>
                            <div class="flex gap-2">
                                <button @onclick="CopyLogs" class="hover:text-white">üìã Copy Logs</button>
                                <button @onclick="ClearLogs" class="hover:text-white">Clear</button>
                            </div>
                        </div>
                        @foreach(var log in debugLogs)
                        {
                            <div class="mb-1 border-b border-gray-900/50 pb-1 break-all">@log</div>
                        }
                    </div>
                }

                @if (!MediaItems.Any())
                {
                    <div class="flex flex-col items-center justify-center h-64 border-2 border-dashed border-gray-800 rounded-2xl bg-gray-900/50">
                        <div class="text-4xl mb-4">üé¨</div>
                        <p class="text-gray-500 font-bold">No Media Records Found</p>
                        <p class="text-gray-600 text-sm mt-2">Click "Import Media Only" to scan your json file for movies.</p>
                    </div>
                }
                else
                {
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        @foreach (var m in MediaItems)
                        {
                            <div class="group relative bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700 hover:border-purple-500 transition hover:-translate-y-1">
                                <div class="aspect-[2/3] bg-gray-900 relative">
                                    @if(!string.IsNullOrEmpty(m.ImgUrl))
                                    {
                                        <img src="@m.ImgUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" onerror="this.style.display='none'" />
                                    }
                                    else
                                    {
                                        <div class="flex items-center justify-center h-full text-4xl">üé¨</div>
                                    }
                                    
                                    @if(m.Rating > 0)
                                    {
                                        <div class="absolute top-2 right-2 bg-black/80 backdrop-blur text-yellow-400 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-yellow-500/30">
                                            <span>‚òÖ</span> @m.Rating
                                        </div>
                                    }
                                </div>

                                <div class="p-3">
                                    <h4 class="font-bold text-white text-sm truncate" title="@m.Title">@m.Title</h4>
                                    <div class="text-[10px] text-gray-400 mb-2">@m.Date.ToString("MMM d, yyyy")</div>
                                    
                                    @if(!string.IsNullOrEmpty(m.Description))
                                    {
                                        <p class="text-xs text-gray-500 line-clamp-2 leading-snug">@m.Description</p>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <div class="text-center text-xs text-gray-500 mt-6">Showing @MediaItems.Count records</div>
                }
            </div>

        </main>
    }
</div>

<script>
    window.getUserOffset = () => { return new Date().getTimezoneOffset(); };
    window.copyTextToClipboard = async (text) => {
        try { await navigator.clipboard.writeText(text); } catch (err) { console.error(err); }
    };
</script>

@code {
    private string CurrentDate = "", CurrentTime = "";
    private WeatherData? weather;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private bool showUserMenu = false;
    private User? currentUser;

    // Data
    private List<BulletMedia> MediaItems = new();
    private bool isImporting = false;
    private List<string> debugLogs = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isDbError) 
        { 
            try 
            { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var session = JsonSerializer.Deserialize<SessionData>(json, options);
                
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }

                currentUser = await Db.Users.FindAsync(session.UserId);
                
                if (currentUser != null) {
                    await LoadData();
                    _ = FetchWeather();
                }

                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); UpdateTime(); } catch {}
                _ = StartClock();
                StateHasChanged();
            } 
            catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }

    private void Log(string msg)
    {
        var line = $"{DateTime.Now:HH:mm:ss} - {msg}";
        debugLogs.Add(line);
        Console.WriteLine($"[MEDIA] {msg}"); 
        InvokeAsync(StateHasChanged);
    }
    
    private void ClearLogs() => debugLogs.Clear();
    private async Task CopyLogs() { var text = string.Join("\n", debugLogs); await JS.InvokeVoidAsync("copyTextToClipboard", text); Log("Logs copied."); }

    private async Task LoadData()
    {
        if (currentUser == null) return;
        try 
        {
            MediaItems = await Db.Set<BulletMedia>()
                            .Where(i => i.UserId == currentUser.Id)
                            .OrderByDescending(i => i.Date)
                            .ToListAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("42P01")) 
            {
                isDbError = true;
                errorMessage = "Table 'BulletMedia' does not exist.";
            }
        }
    }

    private async Task ImportMedia()
    {
        if (currentUser == null) return;
        isImporting = true;
        ClearLogs();
        Log("Starting Media Import...");

        try
        {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            if (!File.Exists(filePath)) { Log("ERROR: File not found."); return; }

            var jsonContent = await File.ReadAllTextAsync(filePath);
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            using var doc = JsonDocument.Parse(jsonContent);
            var root = doc.RootElement;

            List<JsonElement> rawList = new();

            // Locate Array
            if (root.ValueKind == JsonValueKind.Array) { foreach (var el in root.EnumerateArray()) rawList.Add(el); }
            else if (root.ValueKind == JsonValueKind.Object) {
                if (root.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array) foreach (var el in items.EnumerateArray()) rawList.Add(el);
                else if (root.TryGetProperty("bulletItems", out var bi) && bi.ValueKind == JsonValueKind.Array) foreach (var el in bi.EnumerateArray()) rawList.Add(el);
            }

            Log($"Scanned {rawList.Count} total items. Filtering for 'media'...");

            var newItems = new List<BulletMedia>();
            int skipped = 0;

            foreach (var raw in rawList)
            {
                // FILTER: Only type = media
                string type = "";
                if (raw.TryGetProperty("type", out var t)) type = t.ToString().ToLower();
                
                if (type != "media") { skipped++; continue; }

                try
                {
                    var item = new BulletMedia();
                    item.UserId = currentUser.Id;
                    item.Category = "Movie"; // Default
                    
                    // --- MAPPING ---
                    if (raw.TryGetProperty("title", out var c)) item.Title = c.ToString();
                    else if (raw.TryGetProperty("content", out c)) item.Title = c.ToString();
                    
                    if (raw.TryGetProperty("date", out var d) && DateTime.TryParse(d.ToString(), out var dt))
                        item.Date = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
                    else
                        item.Date = DateTime.UtcNow;

                    if (raw.TryGetProperty("description", out var desc)) item.Description = desc.ToString();
                    else if (raw.TryGetProperty("notes", out var n)) item.Description = n.ToString();

                    if (raw.TryGetProperty("rating", out var r) && r.TryGetInt32(out int rate)) item.Rating = rate;
                    
                    if (raw.TryGetProperty("imgUrl", out var img)) item.ImgUrl = img.ToString();
                    if (raw.TryGetProperty("linkUrl", out var lnk)) item.LinkUrl = lnk.ToString();

                    if (raw.TryGetProperty("id", out var oldId)) item.OriginalStringId = oldId.ToString();

                    newItems.Add(item);
                }
                catch (Exception ex) { Log($"Error mapping item: {ex.Message}"); }
            }

            Log($"Filtered: {newItems.Count} Media items found. ({skipped} skipped)");

            if (newItems.Any())
            {
                Log("Saving to Database...");
                await Db.Set<BulletMedia>().AddRangeAsync(newItems);
                await Db.SaveChangesAsync();
                Log($"Success! Saved {newItems.Count} movies.");
                await LoadData();
            }
            else
            {
                Log("No media items found to import.");
            }
        }
        catch (Exception ex)
        {
            Log($"CRITICAL ERROR: {ex.Message}");
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

    private async Task UpgradeDatabase()
    {
        try 
        {
            await Db.Database.ExecuteSqlRawAsync(@"
                CREATE TABLE IF NOT EXISTS ""BulletMedia"" (
                    ""Id"" serial PRIMARY KEY,
                    ""UserId"" integer NOT NULL,
                    ""Title"" text,
                    ""Date"" timestamp with time zone NOT NULL,
                    ""Category"" text DEFAULT 'Movie',
                    ""LinkUrl"" text,
                    ""ImgUrl"" text,
                    ""ImageId"" integer,
                    ""Description"" text,
                    ""Rating"" integer DEFAULT 0,
                    ""ReleaseYear"" integer DEFAULT 0,
                    ""Actors"" text DEFAULT '',
                    ""Tags"" text DEFAULT '',
                    ""OriginalStringId"" text
                );
            ");
            isDbError = false;
            Log("Media Table Created.");
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private async Task WipeData()
    {
        if (await JS.InvokeAsync<bool>("confirm", "‚ö†Ô∏è Delete ALL Media Items?"))
        {
            var items = await Db.Set<BulletMedia>().Where(i => i.UserId == currentUser!.Id).ToListAsync();
            Db.Set<BulletMedia>().RemoveRange(items);
            await Db.SaveChangesAsync();
            Log("Media Data Wiped.");
            await LoadData();
        }
    }

    private void ToggleUserMenu() { showUserMenu = !showUserMenu; }
    private void CloseMenus() { showUserMenu = false; }
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", forceLoad: true); }
    private async Task StartClock() { var now = DateTime.Now; await Task.Delay((60 - now.Second) * 1000); using var timer = new PeriodicTimer(TimeSpan.FromMinutes(1)); UpdateTime(); while (await timer.WaitForNextTickAsync()) { UpdateTime(); } }
    private void UpdateTime() { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); string suffix = (now.Day % 10 == 1 && now.Day != 11) ? "st" : (now.Day % 10 == 2 && now.Day != 12) ? "nd" : (now.Day % 10 == 3 && now.Day != 13) ? "rd" : "th"; CurrentDate = $"{now:dddd, MMMM d}{suffix} {now:yyyy}"; CurrentTime = now.ToString("h:mm tt").ToLower(); InvokeAsync(StateHasChanged); }
    private async Task FetchWeather() { if (currentUser == null) return; try { var url = "https://api.open-meteo.com/v1/forecast?latitude=33.1383&longitude=-95.6011&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto"; weather = await Http.GetFromJsonAsync<WeatherData>(url); StateHasChanged(); } catch {} }
    private string GetDayName(string s) => DateTime.TryParse(s, out var d) ? d.ToString("ddd") : "";
    private string GetWeatherIcon(int c) => c switch { 0=>"‚òÄÔ∏è", 1=>"üå§Ô∏è", 2=>"‚õÖ", 3=>"‚òÅÔ∏è", 45 or 48=>"üå´Ô∏è", 51 or 53 or 55=>"üå¶Ô∏è", 61 or 63 or 65=>"üåßÔ∏è", 80 or 81 or 82=>"üå¶Ô∏è", 71 or 73 or 75=>"‚ùÑÔ∏è", 95 or 96 or 99=>"‚ö°", _=>"üå°Ô∏è" };

    public class WeatherData { public CurrentWeather current { get; set; } = new(); public DailyWeather daily { get; set; } = new(); }
    public class CurrentWeather { public double temperature_2m { get; set; } public int weather_code { get; set; } }
    public class DailyWeather { public string[] time { get; set; } = Array.Empty<string>(); public int[] weather_code { get; set; } = Array.Empty<int>(); public double[] temperature_2m_max { get; set; } = Array.Empty<double>(); public double[] temperature_2m_min { get; set; } = Array.Empty<double>(); }
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
}