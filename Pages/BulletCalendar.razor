@page "/bullet-calendar"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.IO
@using Microsoft.JSInterop
@using System.Text.Json
@inject AppDbContext Db
@inject BulletBaseService BaseService
@inject BulletTaskService TaskService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 relative">
    
    <div class="p-6 pb-2 mb-2 border-b border-gray-800 flex items-center justify-between shrink-0 sticky top-0 bg-gray-900 z-40">
        
        <div class="flex items-center gap-6 bg-gray-800/50 px-6 py-2 rounded-full border border-gray-700/50 backdrop-blur-md">
            <a href="/" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Home">üè†</a>
            <a href="/recipes" class="text-2xl hover:scale-125 transition grayscale hover:grayscale-0" title="Recipes">üç¥</a>
            <a href="/bullet-calendar" class="text-2xl hover:scale-125 transition grayscale-0 drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]" title="Bullet Calendar">‚úÖ</a>
            <span class="text-2xl opacity-20 cursor-not-allowed" title="Coming Soon - Budget Tracker">üíµ</span>
        </div>

        <div class="flex items-center gap-4">
            <div class="min-w-[250px] text-center">
                <h2 class="text-xl font-bold text-white tracking-tight">@GetHeaderDate()</h2>
            </div>

            <div class="flex items-center gap-2 bg-gray-800/50 px-3 py-1 rounded-full border border-gray-700/50 backdrop-blur-md">
                <button @onclick="Prev" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚óÄ</button>
                <button @onclick="GoToday" class="px-3 h-8 flex items-center justify-center bg-gray-700 hover:bg-blue-600 hover:text-white text-gray-300 rounded-lg text-xs font-bold uppercase tracking-wider transition">Today</button>
                <button @onclick="Next" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-gray-300 transition">‚ñ∂</button>
            </div>
            
            <div class="flex bg-gray-900/50 rounded-lg p-1 border border-gray-700">
                <button @onclick='() => SwitchView("day")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "day" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Day</button>
                <button @onclick='() => SwitchView("week")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "week" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Week</button>
                <button @onclick='() => SwitchView("month")' class="px-3 py-1 text-xs font-bold rounded-md transition @(currentView == "month" ? "bg-blue-600 text-white shadow" : "text-gray-400 hover:text-white")">Month</button>
            </div>
        </div>

        <div class="relative">
            <button @onclick="() => showUserMenu = !showUserMenu" class="w-10 h-10 rounded-full bg-gray-800 border-2 border-gray-700 overflow-hidden hover:border-gray-500 transition">
                <img src="@(currentUser?.AvatarUrl ?? "https://i.imgur.com/7Y5j5Yx.png")" class="w-full h-full object-cover" />
            </button>
            @if (showUserMenu) {
                <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 border border-gray-700 rounded-xl shadow-xl p-2 z-50">
                    <a href="/manage-data" class="block w-full text-left text-xs text-blue-400 hover:bg-gray-700 p-2 rounded mb-1">üíæ Manage Data</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <button @onclick="Logout" class="w-full text-left text-xs text-red-400 hover:bg-gray-700 p-2 rounded">Logout</button>
                </div>
            }
        </div>
    </div>

    @if(!string.IsNullOrEmpty(statusMessage)) {
        <div class="mx-6 mb-4 p-2 rounded bg-blue-900/20 border border-blue-800 text-xs font-mono text-blue-300">@statusMessage</div>
    }

    <div class="px-6 h-[calc(100vh-100px)] overflow-hidden">
        @if (currentView == "day")
        {
            <div class="grid grid-cols-3 gap-6 h-full">
                @foreach (var cat in new[] { ("Work", "work", "blue"), ("Personal", "personal", "green"), ("Health", "health", "orange") })
                {
                    <div class="bg-gray-800/40 rounded-xl border border-gray-700 flex flex-col h-full overflow-hidden">
                        <div class="p-3 bg-gray-800/80 border-b border-gray-700 flex justify-between items-center sticky top-0 backdrop-blur z-10">
                            <span class="font-bold text-@cat.Item3-400 uppercase tracking-wider text-sm">@cat.Item1</span>
                            <button @onclick='() => OpenEditor(cat.Item2, "task", viewDate)' class="text-xs bg-gray-700 hover:bg-white hover:text-black px-2 py-0.5 rounded transition">Ôºã Add</button>
                        </div>
                        <div class="p-3 overflow-y-auto flex-1 space-y-3 scrollbar-hide">
                            @{
                                var dayTasks = GetTasksForDate(viewDate).Where(t => t.Category.Equals(cat.Item2, StringComparison.OrdinalIgnoreCase)).ToList();
                            }
                            @foreach(var t in dayTasks) { 
                                <TaskCard Task="t" OnClick="@(x => OpenEdit(x))" OnToggle="@(x => ToggleComplete(x))" OnDelete="@(id => DeleteTask(id))" />
                            }
                            @if(!dayTasks.Any()) { <div class="text-center text-gray-600 text-xs italic mt-4">No tasks</div> }
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "week")
        {
            <div class="grid grid-cols-7 gap-2 h-full">
                @for(int i=0; i<7; i++) {
                    var d = weekStart.AddDays(i);
                    var isToday = d.Date == DateTime.UtcNow.AddMinutes(clientOffset).Date;
                    <div class="flex flex-col h-full rounded-xl border overflow-hidden bg-gray-800/40 @(isToday ? "border-blue-500" : "border-gray-700")">
                        <div class="p-2 text-center border-b border-gray-700/50 bg-gray-800/60 cursor-pointer hover:bg-gray-700 transition" @onclick="() => GoToDate(d)">
                            <div class="text-[10px] uppercase font-bold text-gray-500">@d.ToString("ddd")</div>
                            <div class="text-lg font-bold @(isToday ? "text-blue-400" : "text-white")">@d.Day</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 space-y-1 scrollbar-hide">
                            @foreach(var t in GetTasksForDate(d)) { 
                                <TaskPill Task="t" OnClick="@(x => OpenEdit(x))" ImageWidth="@BulletViewConfig.ImgWidthWeek" />
                            }
                            <button @onclick='() => OpenEditor("personal", "task", d)' class="w-full py-2 text-gray-600 hover:text-gray-400 hover:bg-gray-700/50 rounded text-xs transition mt-2">Ôºã</button>
                        </div>
                    </div>
                }
            </div>
        }
        else if (currentView == "month")
        {
            <div class="flex flex-col h-full">
                <div class="grid grid-cols-7 text-center pb-2 border-b border-gray-800 mb-2">
                    @foreach(var day in new[]{"Mon","Tue","Wed","Thu","Fri","Sat","Sun"}){ <div class="text-xs font-bold text-gray-500 uppercase">@day</div> }
                </div>
                <div class="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-hidden">
                    @for(int i=0; i<monthEmptyCells; i++) { <div class="bg-gray-900/30 rounded-lg"></div> }
                    @for(int d=1; d<=daysInMonth; d++){
                        var currentDay = new DateTime(viewDate.Year, viewDate.Month, d);
                        var isToday = currentDay.Date == DateTime.UtcNow.AddMinutes(clientOffset).Date;
                        <div class="relative flex flex-col rounded-lg border overflow-hidden p-1 hover:bg-gray-800 transition cursor-pointer @(isToday ? "border-blue-500 bg-gray-800/50" : "border-gray-700 bg-gray-900")" @onclick="() => GoToDate(currentDay)">
                            <div class="text-right text-xs font-bold text-gray-500 mb-1">@d</div>
                            <div class="flex-1 overflow-y-auto space-y-1 scrollbar-hide max-h-24">
                                @foreach(var t in GetTasksForDate(currentDay)) { 
                                    <TaskPill Task="t" OnClick="@(x => OpenEdit(x))" ImageWidth="@BulletViewConfig.ImgWidthMonth" />
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<TaskEditor Task="editingItem" OnSave="SaveItem" OnCancel="() => editingItem = null" OnDelete="DeleteCurrentTask" />

@code {
    private User? currentUser;
    private DateTime viewDate = DateTime.UtcNow;
    private string currentView = "day";
    private int clientOffset = 0;
    private bool showUserMenu = false;
    private string statusMessage = "";
    
    private List<BulletTaskService.TaskDTO> loadedTasks = new();
    private BulletTaskService.TaskDTO? editingItem;

    private DateTime weekStart => viewDate.AddDays(-1 * ((7 + (viewDate.DayOfWeek - DayOfWeek.Monday)) % 7)).Date;
    private int daysInMonth => DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
    private int monthEmptyCells => ((int)new DateTime(viewDate.Year, viewDate.Month, 1).DayOfWeek + 6) % 7; 

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) { 
                    int userId = 0;
                    using(var doc = JsonDocument.Parse(json)) {
                        if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) 
                            userId = p.GetInt32();
                    }
                    if(userId > 0) {
                        try { currentUser = await Db.Users.FindAsync(userId); } catch { }
                        if(currentUser != null) {
                            try { clientOffset = await JS.InvokeAsync<int>("eval", "new Date().getTimezoneOffset()"); } catch {}
                            viewDate = DateTime.UtcNow.AddMinutes(-clientOffset);
                            await LoadData();
                        }
                    }
                }
            } catch { }
        }
    }

    private async Task LoadData()
    {
        if (currentUser == null) return;
        DateTime start = viewDate.Date, end = viewDate.Date.AddDays(1).AddSeconds(-1);
        if (currentView == "week") { start = weekStart; end = start.AddDays(7); }
        else if (currentView == "month") { start = new DateTime(viewDate.Year, viewDate.Month, 1); end = start.AddMonths(1); }

        try {
            loadedTasks = await TaskService.GetTasksForRange(currentUser.Id, start, end);
        } catch(Exception ex) { statusMessage = "Error: " + ex.Message; }
        StateHasChanged();
    }

    private void SwitchView(string view) { currentView = view; _ = LoadData(); }
    private void Prev() { 
        if(currentView == "day") viewDate = viewDate.AddDays(-1);
        else if(currentView == "week") viewDate = viewDate.AddDays(-7);
        else viewDate = viewDate.AddMonths(-1);
        _ = LoadData(); 
    }
    private void Next() { 
        if(currentView == "day") viewDate = viewDate.AddDays(1);
        else if(currentView == "week") viewDate = viewDate.AddDays(7);
        else viewDate = viewDate.AddMonths(1);
        _ = LoadData(); 
    }
    private void GoToday() { viewDate = DateTime.UtcNow.AddMinutes(-clientOffset); _ = LoadData(); }
    private void GoToDate(DateTime d) { viewDate = d; SwitchView("day"); }
    
    // --- DATE FORMATTER ---
    private string GetHeaderDate() 
    {
        if(currentView == "day") {
            var day = viewDate.Day;
            var suffix = day switch { 1 or 21 or 31 => "st", 2 or 22 => "nd", 3 or 23 => "rd", _ => "th" };
            return $"{viewDate:dddd, MMMM} {day}{suffix}, {viewDate:yyyy}";
        }
        return currentView == "week" ? $"Week of {weekStart:MMM d}" : viewDate.ToString("MMMM yyyy");
    }

    private List<BulletTaskService.TaskDTO> GetTasksForDate(DateTime d) => loadedTasks.Where(t => t.Date.Date == d.Date).ToList();

    private async Task ToggleComplete(BulletTaskService.TaskDTO t)
    {
        t.Detail.IsCompleted = !t.Detail.IsCompleted;
        await TaskService.ToggleComplete(t.Id, t.Detail.IsCompleted);
    }

    private void OpenEditor(string category, string type, DateTime date)
    {
        editingItem = new BulletTaskService.TaskDTO { UserId = currentUser!.Id, Category = category, Type = type, Date = date };
    }

    private void OpenEdit(BulletTaskService.TaskDTO t)
    {
        var json = JsonSerializer.Serialize(t);
        editingItem = JsonSerializer.Deserialize<BulletTaskService.TaskDTO>(json);
        if(editingItem != null) editingItem.Date = t.Date; 
    }

    private async Task SaveItem()
    {
        if(editingItem != null) {
            await TaskService.SaveTask(editingItem);
            editingItem = null;
            await LoadData();
        }
    }

    // RENAMED to avoid ambiguity (Argument: int id)
    private async Task DeleteTask(int id)
    {
        if(await JS.InvokeAsync<bool>("confirm", "Delete this task?")) {
            await BaseService.DeleteItem(id);
            await LoadData();
        }
    }

    // RENAMED to avoid ambiguity (Argument: none, uses editingItem)
    private async Task DeleteCurrentTask()
    {
        if(editingItem != null && editingItem.Id > 0) {
            if(await JS.InvokeAsync<bool>("confirm", "Delete this task?")) {
                await BaseService.DeleteItem(editingItem.Id);
                editingItem = null;
                await LoadData();
            }
        }
    }
    
    private async Task Logout() { await JS.InvokeVoidAsync("localStorage.removeItem", "dashboard_session"); Nav.NavigateTo("/login", true); }
}