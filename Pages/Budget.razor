@page "/budget-tracker"
@using Microsoft.AspNetCore.Components.Web
@rendermode RenderMode.InteractiveServer
@using Dashboard
@using Dashboard.Components.Bullet
@using System.IO
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using System.Text.RegularExpressions
@inject IJSRuntime JSRuntime
@inject BudgetService BudgetService
@inject IJSRuntime JS
@inject AppDbContext Db
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env 

<BulletHeader />

<div class="min-h-screen bg-gray-900 text-white p-6">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold flex items-center gap-3">
            <span>üíµ</span> Budget Tracker <span class="text-xs font-normal text-gray-500 self-end mb-1">v3.0 (Smart Inference)</span>
        </h1>
        
        <div class="flex gap-3">
            <button @onclick="LoadServerDefaults" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition shadow-lg flex items-center gap-2 border border-gray-600">
                <span>‚ö° Load Server Data</span>
            </button>

            <div class="relative">
                <label class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded cursor-pointer transition shadow-lg flex items-center gap-2">
                    <span>üìÇ Upload JSON</span>
                    <InputFile OnChange="LoadJsonFile" class="hidden" />
                </label>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="p-4 border-2 border-dashed border-red-500 bg-red-900/20 rounded-xl">
            <div class="flex flex-col gap-4">
                <div>
                    <h3 class="font-bold text-red-400 text-lg">‚ö†Ô∏è Database Repair</h3>
                    <p class="text-sm text-gray-400">Click below only if you see "Relation does not exist" errors.</p>
                </div>
                <button class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded shadow-lg transition w-full" 
                        @onclick="ForceCreateTablesSQL">
                    üî® Force Create & Fix Columns
                </button>
            </div>
        </div>

        <div class="relative bg-black border border-gray-700 rounded-xl p-4 font-mono text-xs h-48 overflow-hidden shadow-inner flex flex-col">
            <button class="absolute top-2 right-2 bg-gray-800 hover:bg-gray-700 text-gray-300 px-2 py-1 rounded border border-gray-600 text-[10px] z-10 transition" 
                    @onclick="CopyLogs">
                üìã Copy Log
            </button>
            <div class="overflow-y-auto flex flex-col-reverse h-full pt-6">
                @if (debugLogs.Count == 0)
                {
                    <div class="text-gray-600 italic">Waiting for logs...</div>
                }
                else
                {
                    @foreach (var log in ((IEnumerable<string>)debugLogs).Reverse())
                    {
                        <div class="border-b border-gray-900 py-0.5 whitespace-pre-wrap break-all">
                            <span class="text-gray-500 select-none">@log.Split('|')[0]</span> 
                            <span class="@GetLogColor(log)">@log.Split('|')[1]</span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="flex flex-col items-center justify-center py-20 space-y-4">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-gray-400 animate-pulse">Processing... check console above</div>
        </div>
    }
    else if (!periods.Any())
    {
        <div class="text-center py-20 border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/30">
            <p class="text-gray-500 text-xl mb-2">Ready.</p>
            <p class="text-sm text-gray-600">Click "Load Server Data" to begin.</p>
        </div>
    }
    else
    {
        @foreach (var period in periods)
        {
            <div class="bg-gray-800 border border-gray-700 rounded-xl mb-8 overflow-hidden shadow-2xl">
                <div class="bg-gray-900 p-4 border-b border-gray-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            @period.DisplayName
                            @if(period.StringId.Contains("2026")) { <span class="text-xs bg-blue-900 text-blue-200 px-2 py-0.5 rounded border border-blue-700">Future</span> }
                        </h2>
                        <div class="text-xs text-gray-400 mt-1">Start: @period.StartDate.ToShortDateString() | Opening: <span class="text-white font-mono">@period.InitialBankBalance.ToString("C")</span></div>
                    </div>
                    <div class="flex gap-6 text-sm font-bold bg-black/20 p-2 rounded-lg border border-gray-700/50">
                        <div class="text-green-400 flex flex-col items-end leading-tight">
                            <span class="text-[10px] text-gray-500 uppercase">Income</span>
                            @period.Transactions.Where(t => t.Amount > 0).Sum(t => t.Amount).ToString("C0")
                        </div>
                        <div class="w-px bg-gray-700"></div>
                        <div class="text-red-400 flex flex-col items-end leading-tight">
                            <span class="text-[10px] text-gray-500 uppercase">Expenses</span>
                            @Math.Abs(period.Transactions.Where(t => t.Amount < 0).Sum(t => t.Amount)).ToString("C0")
                        </div>
                    </div>
                </div>

                <div class="p-4 grid lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest border-b border-gray-700 pb-2 mb-2">Budget Cycles</h3>
                        @foreach (var cycle in period.Cycles.OrderBy(c => c.CycleNumber))
                        {
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden">
                                <div class="bg-gray-900/50 p-2 border-b border-gray-700 flex justify-between items-center">
                                    <span class="font-bold text-gray-300 text-xs uppercase">Cycle @cycle.CycleNumber: @cycle.Label</span>
                                    <span class="text-[10px] text-gray-500">@cycle.Items.Count items</span>
                                </div>
                                <div class="divide-y divide-gray-700/50">
                                    @foreach (var item in cycle.Items)
                                    {
                                        <div class="flex items-center justify-between p-2 hover:bg-gray-700/30 transition">
                                            <div class="flex items-center gap-3">
                                                @if(!string.IsNullOrEmpty(item.ImgUrl)) 
                                                { 
                                                    <img src="@item.ImgUrl" class="w-8 h-8 rounded object-cover bg-black/40" /> 
                                                }
                                                else
                                                {
                                                    <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center text-xs">üí∞</div>
                                                }
                                                <div>
                                                    <div class="font-bold text-sm text-gray-200">@item.Name</div>
                                                    @if(item.CarriedOver > 0) { <div class="text-[10px] text-yellow-500">Carry: @item.CarriedOver.ToString("C")</div> }
                                                </div>
                                            </div>
                                            <div class="font-mono font-bold text-gray-300">@item.PlannedAmount.ToString("C0")</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div>
                        <div class="mb-6 bg-gray-800/30 border border-yellow-700/30 rounded-lg overflow-hidden">
                            <h3 class="text-sm font-bold text-yellow-400 uppercase tracking-widest p-2 bg-yellow-900/20 border-b border-yellow-700/30 flex justify-between">
                                <span>Expected Income</span>
                                <span>@((period.ExpectedIncome ?? new List<BudgetExpectedIncome>()).Sum(x => x.Amount).ToString("C0"))</span>
                            </h3>
                            @if(period.ExpectedIncome != null && period.ExpectedIncome.Any())
                            {
                                <div class="divide-y divide-gray-700/50">
                                    @foreach(var inc in period.ExpectedIncome.OrderBy(x => x.Date))
                                    {
                                        <div class="flex justify-between items-center p-2 text-sm hover:bg-white/5 transition">
                                            <div class="flex items-center gap-2">
                                                <span class="text-gray-500 text-xs font-mono">@inc.Date.ToString("MMM dd")</span>
                                                <span class="text-gray-200">@inc.SourceStringId</span> 
                                            </div>
                                            <span class="font-mono text-yellow-200">@inc.Amount.ToString("C")</span>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="p-2 text-xs text-gray-500 italic text-center">No expected income logged.</div>
                            }
                        </div>

                        <h3 class="text-sm font-bold text-purple-400 uppercase tracking-widest border-b border-gray-700 pb-2 mb-4">Transactions (@period.Transactions.Count)</h3>
                        <div class="space-y-1 max-h-[600px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
                            @foreach (var t in period.Transactions.OrderByDescending(x => x.Date))
                            {
                                <div class="flex justify-between items-start p-3 rounded bg-gray-800 hover:bg-gray-700 transition border border-gray-700/50 text-sm group">
                                    <div class="flex-1">
                                        <div class="text-gray-200 font-bold group-hover:text-white transition">@t.Description</div>
                                        <div class="text-xs text-gray-500">@t.Date.ToString("MMM dd")</div>
                                        @if(t.Splits.Any()) 
                                        { 
                                            <div class="mt-1 space-y-1">
                                                @foreach(var s in t.Splits) 
                                                { 
                                                    <div class="text-[10px] text-gray-400 flex gap-2 pl-2 border-l-2 border-gray-600">
                                                        <span>‚Ü≥</span>
                                                        <span class="font-mono">@s.Amount.ToString("C")</span>
                                                        <span class="italic">@s.Note</span>
                                                    </div> 
                                                }
                                            </div> 
                                        }
                                    </div>
                                    <div class="font-mono font-bold @(t.Amount >= 0 ? "text-green-400" : "text-white")">
                                        @t.Amount.ToString("C")
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private int userId = 0;
    private bool isLoading = true;
    private List<BudgetPeriod> periods = new();
    private List<string> debugLogs = new();

    private void Log(string msg, string type = "info") 
    {
        debugLogs.Add($"{DateTime.Now:HH:mm:ss}|{msg}|{type}");
        StateHasChanged();
    }
    private string GetLogColor(string log) 
    {
        if(log.Contains("|error")) return "text-red-400 font-bold";
        if(log.Contains("|success")) return "text-green-400 font-bold";
        return "text-gray-300";
    }

    private async Task CopyLogs()
    {
        var text = string.Join("\n", debugLogs.Select(l => l.Replace("|", " : ")));
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        Log("Logs copied to clipboard.", "success");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Log("Page initializing (Manual Mode)...");
            try
            {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json))
                {
                    using (var doc = JsonDocument.Parse(json))
                    {
                        if (doc.RootElement.TryGetProperty("UserId", out var p) || 
                            doc.RootElement.TryGetProperty("userId", out p) ||
                            doc.RootElement.TryGetProperty("id", out p))
                        {
                            userId = p.GetInt32();
                            Log($"User Identified: ID {userId}", "success");
                            Log("Ready. Click buttons above to start.", "info");
                        }
                    }
                }
                if (userId == 0) Log("No user found in local storage.", "error");
            }
            catch (Exception ex)
            {
                Log($"Initialization Error: {ex.Message}", "error");
            }
            finally 
            { 
                isLoading = false; 
                StateHasChanged(); 
            }
        }
    }

    private async Task LoadData()
    {
        Log("Querying Database for periods...");
        try 
        {
            var expIncomeCount = await Db.BudgetExpectedIncome.CountAsync();
            Log($"DEBUG: Found {expIncomeCount} Expected Income records in DB.", "info");

            periods = await BudgetService.GetPeriods(userId);
            
            // MANUAL ATTACH
            if(periods != null)
            {
                foreach(var p in periods)
                {
                    p.ExpectedIncome = await Db.BudgetExpectedIncome
                        .Where(x => x.BudgetPeriodId == p.Id)
                        .ToListAsync();
                }
                Log("Attached Expected Income to models.", "success");
            }

            Log($"Loaded {periods.Count} periods.", "success");
        }
        catch(Exception ex)
        {
            Log($"LoadData Error: {ex.Message}", "error");
        }
    }

    // --- REVISED: SMART IMPORT LOGIC ---
    private async Task ImportExpectedIncomeManual(string json)
    {
        try 
        {
            Log("Manual Import: Parsing JSON...", "info");
            using var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;

            // DEBUG: Log keys so we know what we are dealing with
            var keys = string.Join(", ", root.EnumerateObject().Select(p => p.Name));
            Log($"JSON Keys found: {keys}", "info");

            DateTime targetDate = DateTime.MinValue;

            // STRATEGY 1: Explicit Property (Case Insensitive)
            if(root.TryGetProperty("startDate", out var d) || 
               root.TryGetProperty("StartDate", out d) || 
               root.TryGetProperty("date", out d))
            {
                if(DateTime.TryParse(d.GetString(), out var explicitDate)) 
                {
                    targetDate = explicitDate;
                    Log($"Strategy 1: Found Explicit StartDate {targetDate:MM/yyyy}", "success");
                }
            }

            // STRATEGY 2: Infer from Income Items
            JsonElement incomeArray = default;
            bool foundArray = root.TryGetProperty("expectedIncome", out incomeArray) ||
                              root.TryGetProperty("ExpectedIncome", out incomeArray);

            if(!foundArray || incomeArray.ValueKind != JsonValueKind.Array)
            {
                Log("Manual Import: 'expectedIncome' array missing. Skipping.", "info");
                return;
            }

            if(targetDate == DateTime.MinValue)
            {
                foreach(var item in incomeArray.EnumerateArray())
                {
                    if((item.TryGetProperty("date", out var id) || item.TryGetProperty("Date", out id)) 
                        && DateTime.TryParse(id.GetString(), out var inferred))
                    {
                        targetDate = new DateTime(inferred.Year, inferred.Month, 1);
                        Log($"Strategy 2: Inferred date {targetDate:MM/yyyy} from items.", "success");
                        break;
                    }
                }
            }

            if(targetDate == DateTime.MinValue)
            {
                Log("Manual Import Failed: Could not determine budget month.", "error");
                return;
            }

            // 3. Find Parent Period in DB
            var period = await Db.BudgetPeriods
                .Where(p => p.UserId == userId && p.StartDate.Year == targetDate.Year && p.StartDate.Month == targetDate.Month)
                .OrderByDescending(p => p.Id)
                .FirstOrDefaultAsync();

            if(period == null) 
            {
                Log($"Manual Import Aborted: BudgetPeriod for {targetDate:MM/yyyy} not found in DB.", "error");
                return;
            }

            // 4. Insert Items
            int count = 0;
            foreach(var item in incomeArray.EnumerateArray())
            {
                string sourceStringId = "";
                if(item.TryGetProperty("sourceId", out var sid)) sourceStringId = sid.GetString();
                else if(item.TryGetProperty("SourceId", out sid)) sourceStringId = sid.GetString();

                var exists = await Db.BudgetExpectedIncome.AnyAsync(x => x.BudgetPeriodId == period.Id && x.SourceStringId == sourceStringId);
                if(exists) continue;

                var newInc = new BudgetExpectedIncome
                {
                    BudgetPeriodId = period.Id,
                    SourceStringId = sourceStringId,
                    Amount = 0,
                    Date = targetDate
                };

                if(item.TryGetProperty("amount", out var amt)) newInc.Amount = amt.GetDecimal();
                if((item.TryGetProperty("date", out var d2) || item.TryGetProperty("Date", out d2)) 
                    && DateTime.TryParse(d2.GetString(), out var idate)) 
                {
                    newInc.Date = idate;
                }

                Db.BudgetExpectedIncome.Add(newInc);
                count++;
            }
            
            if(count > 0)
            {
                await Db.SaveChangesAsync();
                Log($"Manual Import: Added {count} records.", "success");
            }
        }
        catch(Exception ex)
        {
            Log($"Manual Import Critical Fail: {ex.Message}", "error");
        }
    }

    private async Task ForceCreateTablesSQL()
    {
        Log("Button Clicked: Starting RAW SQL Creation...", "info");
        try
        {
            var sql = @"
                CREATE TABLE IF NOT EXISTS ""BudgetPeriods"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""UserId"" integer NOT NULL, ""StringId"" text, ""DisplayName"" text, ""StartDate"" timestamp with time zone NOT NULL, ""InitialBankBalance"" numeric NOT NULL, CONSTRAINT ""PK_BudgetPeriods"" PRIMARY KEY (""Id"") );
                CREATE TABLE IF NOT EXISTS ""BudgetCycles"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetPeriodId"" integer NOT NULL, ""CycleNumber"" integer NOT NULL, ""Label"" text, CONSTRAINT ""PK_BudgetCycles"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetCycles_BudgetPeriods_BudgetPeriodId"" FOREIGN KEY (""BudgetPeriodId"" ) REFERENCES ""BudgetPeriods"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetItems"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetCycleId"" integer NOT NULL, ""StringId"" text, ""Name"" text, ""PlannedAmount"" numeric NOT NULL, ""CarriedOver"" numeric NOT NULL, ""ImgUrl"" text, CONSTRAINT ""PK_BudgetItems"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetItems_BudgetCycles_BudgetCycleId"" FOREIGN KEY (""BudgetCycleId"") REFERENCES ""BudgetCycles"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetTransactions"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetPeriodId"" integer NOT NULL, ""StringId"" text, ""Date"" timestamp with time zone NOT NULL, ""Description"" text, ""Amount"" numeric NOT NULL, ""Type"" text NOT NULL, ""LinkedBudgetItemStringId"" text, ""SourceStringId"" text, ""ResolvedBudgetItemId"" integer, CONSTRAINT ""PK_BudgetTransactions"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetTransactions_BudgetPeriods_BudgetPeriodId"" FOREIGN KEY (""BudgetPeriodId"") REFERENCES ""BudgetPeriods"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetTransactionSplits"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetTransactionId"" integer NOT NULL, ""Amount"" numeric NOT NULL, ""Note"" text, ""LinkedBudgetItemStringId"" text, ""ResolvedBudgetItemId"" integer, CONSTRAINT ""PK_BudgetTransactionSplits"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetTransactionSplits_BudgetTransactions_BudgetTransactionId"" FOREIGN KEY (""BudgetTransactionId"") REFERENCES ""BudgetTransactions"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetTransfers"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetPeriodId"" integer NOT NULL, ""Date"" timestamp with time zone NOT NULL, ""Amount"" numeric NOT NULL, ""Note"" text, ""FromStringId"" text, ""ToStringId"" text, ""ResolvedFromId"" integer, ""ResolvedToId"" integer, CONSTRAINT ""PK_BudgetTransfers"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetTransfers_BudgetPeriods_BudgetPeriodId"" FOREIGN KEY (""BudgetPeriodId"") REFERENCES ""BudgetPeriods"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetIncomeSources"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""UserId"" integer NOT NULL, ""StringId"" text, ""Name"" text, ""Amount"" numeric NOT NULL, CONSTRAINT ""PK_BudgetIncomeSources"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetIncomeSources_BudgetPeriods_BudgetPeriodId"" FOREIGN KEY (""BudgetPeriodId"") REFERENCES ""BudgetPeriods"" (""Id"") ON DELETE CASCADE );
                CREATE TABLE IF NOT EXISTS ""BudgetExpectedIncome"" ( ""Id"" integer GENERATED BY DEFAULT AS IDENTITY, ""BudgetPeriodId"" integer NOT NULL, ""SourceStringId"" text, ""Amount"" numeric NOT NULL, ""Date"" timestamp with time zone NOT NULL, CONSTRAINT ""PK_BudgetExpectedIncome"" PRIMARY KEY (""Id""), CONSTRAINT ""FK_BudgetExpectedIncome_BudgetPeriods"" FOREIGN KEY (""BudgetPeriodId"") REFERENCES ""BudgetPeriods"" (""Id"") ON DELETE CASCADE );

                ALTER TABLE ""BudgetItems"" ADD COLUMN IF NOT EXISTS ""ImgUrl"" text;
                ALTER TABLE ""BudgetIncomeSources"" ADD COLUMN IF NOT EXISTS ""ImgUrl"" text;
                ALTER TABLE ""BudgetIncomeSources"" ADD COLUMN IF NOT EXISTS ""UserId"" integer NOT NULL DEFAULT 0;
                ALTER TABLE ""BudgetIncomeSources"" ALTER COLUMN ""Amount"" DROP NOT NULL;
                ALTER TABLE ""BudgetIncomeSources"" ALTER COLUMN ""BudgetPeriodId"" DROP NOT NULL;
                ALTER TABLE ""BudgetIncomeSources"" ALTER COLUMN ""UserId"" DROP NOT NULL;
                ALTER TABLE ""BudgetTransactions"" ALTER COLUMN ""Type"" TYPE text;
            ";

            await Db.Database.ExecuteSqlRawAsync(sql);
            Log("‚úÖ SQL Executed Successfully!", "success");
            Log("Tables should now exist. Click 'Load Server Data'.", "info");
        }
        catch (Exception ex)
        {
            Log($"‚ùå SQL ERROR: {ex.Message}", "error");
        }
    }

    private string PatchJsonDates(string json)
    {
        return Regex.Replace(json, @"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?!"")(?![.Z])", "$1Z");
    }

    private async Task LoadServerDefaults()
    {
        if (userId == 0) return;
        isLoading = true;
        StateHasChanged();

        try
        {
            var webRoot = Env.WebRootPath;
            var files = new[] { "budget_dec25.json", "budget_jan26.json" };
            int successCount = 0;

            foreach(var fileName in files)
            {
                var path = Path.Combine(webRoot, fileName);
                Log($"Looking for {fileName}...", "info");
                
                if(File.Exists(path))
                {
                    var json = await File.ReadAllTextAsync(path);
                    json = PatchJsonDates(json);
                    
                    // 1. Regular Import
                    await BudgetService.ImportBudgetJson(userId, json);
                    
                    // 2. Manual Data Patch for Expected Income
                    await ImportExpectedIncomeManual(json);
                    
                    successCount++;
                }
            }
            Log($"Import finished. {successCount} files processed.", "success");
            await LoadData();
        }
        catch (Exception ex)
        {
            Log($"Import Error: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadJsonFile(InputFileChangeEventArgs e)
    {
        if (userId == 0) return;
        isLoading = true;
        StateHasChanged();

        try
        {
            var file = e.File;
            using var reader = new StreamReader(file.OpenReadStream(2 * 1024 * 1024)); 
            var json = await reader.ReadToEndAsync();
            json = PatchJsonDates(json);

            await BudgetService.ImportBudgetJson(userId, json);
            await ImportExpectedIncomeManual(json);
            
            await LoadData();
            Log("Upload successful.", "success");
        }
        catch (Exception ex)
        {
            Log($"Upload Failed: {ex.Message}", "error");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}