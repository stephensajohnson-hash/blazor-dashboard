@page "/budget-tracker"
@using Microsoft.AspNetCore.Components.Web
@rendermode RenderMode.InteractiveServer
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@using Microsoft.JSInterop 
@using System.Text.Json 
@using System.IO 
@using Microsoft.AspNetCore.Components.Forms 
@inject IJSRuntime JS
@inject BudgetService BudgetService
@inject BulletBaseService BulletBase
@inject AppDbContext Db
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<BulletHeader />

<div class="min-h-screen bg-[#1e2124] text-gray-800 p-4 font-sans relative">
    
    @if (isLoading)
    {
        <div class="flex flex-col items-center justify-center h-[80vh]">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-gray-400 mt-4 animate-pulse">Loading Financials...</div>
        </div>
    }
    else if (CurrentPeriod == null)
    {
        <div class="flex flex-col items-center justify-center h-[80vh] border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/30">
            <p class="text-gray-500 text-xl mb-2">No Budget Data Found.</p>
            <p class="text-sm text-gray-600">Please import data or create a new period.</p>
        </div>
    }
    else
    {
        <div class="bg-[#282b30] p-4 rounded-t-xl border-b border-gray-700 shadow-lg mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                <div class="text-sm font-mono text-gray-400 flex gap-4">
                    <span>Start: <span class="text-white font-bold">$@CurrentPeriod.InitialBankBalance.ToString("N2")</span></span>
                    <span>Current: <span class="@GetBalanceColor(CurrentBalance)">$@CurrentBalance.ToString("N2")</span></span>
                </div>

                <div class="flex items-center gap-6">
                    <button @onclick="PrevPeriod" class="p-2 hover:bg-gray-700 rounded-full transition text-gray-400 hover:text-white" disabled="@(!CanGoBack)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    
                    <div class="text-center">
                        <h1 class="text-xl font-bold text-white tracking-wide">@CurrentPeriod.DisplayName</h1>
                        @if(CurrentPeriod.StartDate > DateTime.UtcNow) 
                        { 
                            <span class="text-[10px] bg-blue-900 text-blue-200 px-2 py-0.5 rounded border border-blue-700 uppercase tracking-wider font-bold">Future</span> 
                        }
                    </div>

                    <button @onclick="NextPeriod" class="p-2 hover:bg-gray-700 rounded-full transition text-gray-400 hover:text-white" disabled="@(!CanGoNext)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>

                <div>
                    <button class="bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-2 px-4 rounded shadow transition flex items-center gap-2"
                            @onclick="() => OpenTransactionModal()">
                        <span>+ Add Transaction</span>
                    </button>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 pt-3 border-t border-gray-700 justify-center">
                <span class="text-[10px] text-gray-500 uppercase font-bold self-center tracking-widest">Admin DB Tools:</span>
                <button @onclick="FixWatchTableStructure" class="bg-red-900/40 hover:bg-red-800 text-red-200 text-[10px] px-3 py-1 rounded border border-red-700 transition">üî® 1. Update DB Table</button>
                <button @onclick="RepairWatchLinks" class="bg-blue-900/40 hover:bg-blue-800 text-blue-200 text-[10px] px-3 py-1 rounded border border-blue-700 transition">üîó 2. Link Data by Name</button>
            </div>
        </div>

        <div class="grid lg:grid-cols-[60%_40%] gap-6">
            
            <div class="bg-white rounded-xl shadow-xl overflow-hidden flex flex-col h-[calc(100vh-230px)] border border-gray-300">
                <div class="p-3 bg-gray-100 border-b border-gray-300 font-bold text-gray-600 text-xs uppercase tracking-widest grid grid-cols-[110px_1fr_100px_100px_30px] gap-4 items-center">
                    <span class="pl-2">Date</span>
                    <span>Description</span>
                    <span class="text-right">Amount</span>
                    <span class="text-right pr-2">Balance</span>
                    <span></span>
                </div>
                
                <div class="overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">
                    @if (!CurrentPeriod.Transactions.Any())
                    {
                        <div class="text-center py-20 text-gray-400 italic">No transactions recorded.</div>
                    }
                    else
                    {
                        decimal runningBalance = CurrentPeriod.InitialBankBalance;
                        var sortedTrans = CurrentPeriod.Transactions.OrderBy(t => t.Date).ToList();
                        
                        foreach(var t in sortedTrans)
                        {
                            runningBalance += t.Amount;
                            string imgUrl = GetTransactionImage(t);

                            <div class="grid grid-cols-[110px_1fr_100px_100px_30px] gap-4 items-center p-3 border-b border-gray-200 hover:bg-blue-50 transition group text-sm">
                                <div class="flex items-center gap-3 pl-2">
                                    <div class="w-8 h-8 flex-shrink-0">
                                        <img src="@(string.IsNullOrEmpty(imgUrl) ? "/images/placeholder.png" : imgUrl)" class="w-8 h-8 rounded-full object-cover border border-gray-300" />
                                    </div>
                                    <div class="text-gray-500 font-mono text-xs">@t.Date.ToString("MMM dd")</div>
                                </div>
                                
                                <div class="text-gray-800 font-medium truncate flex items-center gap-2">
                                    @t.Description
                                    @if(t.Splits.Any()) { <span class="text-xs" title="Split Transaction">üîÄ</span> }
                                </div>
                                
                                <div class="text-right font-mono font-bold @(t.Amount >= 0 ? "text-green-600" : "text-red-600")">
                                    $@t.Amount.ToString("N2")
                                </div>
                                
                                <div class="text-right pr-2 font-mono text-gray-400">
                                    $@runningBalance.ToString("N2")
                                </div>

                                <button class="text-gray-400 hover:text-blue-600 transition" @onclick="() => OpenTransactionModal(t)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="space-y-6 h-[calc(100vh-230px)] overflow-y-auto scrollbar-hide pb-20 pr-2">
                
                <div class="space-y-6">
                    @foreach (var cycle in CurrentPeriod.Cycles.OrderBy(c => c.CycleNumber))
                    {
                        <div class="bg-white rounded-lg overflow-hidden border border-gray-300 shadow-md">
                            <div class="bg-gray-100 px-4 py-3 border-b border-gray-300 flex justify-between items-center text-gray-800">
                                <span class="font-bold text-sm uppercase tracking-wider block">@cycle.Label</span>
                                <button class="bg-white hover:bg-gray-200 border border-gray-300 rounded p-1 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                            </div>

                            <div class="divide-y divide-gray-100 p-0">
                                @foreach (var item in cycle.Items)
                                {
                                    decimal rawNetSpent = GetSpentForBudgetItem(item.Id);
                                    decimal credits = rawNetSpent < 0 ? Math.Abs(rawNetSpent) : 0;
                                    decimal actualSpending = rawNetSpent > 0 ? rawNetSpent : 0;
                                    decimal totalBase = item.PlannedAmount + item.CarriedOver;
                                    decimal totalAvailable = totalBase + credits; 
                                    decimal remaining = totalAvailable - actualSpending;
                                    double percent = totalAvailable > 0 ? (double)(actualSpending / totalAvailable) * 100 : 0;
                                    bool isExpanded = ExpandedItemId == item.Id;

                                    <div class="p-4 hover:bg-gray-50 transition cursor-pointer select-none border-l-4 @(isExpanded ? "border-blue-500 bg-blue-50" : "border-transparent")" @onclick="() => ToggleExpand(item.Id)">
                                        <div class="flex flex-col gap-1">
                                            <div class="flex justify-between items-end">
                                                <div class="flex items-center gap-2">
                                                    <img src="@item.ImgUrl" class="w-5 h-5 rounded-full object-cover" onerror="this.style.display='none'" />
                                                    <span class="font-bold text-sm text-gray-800">@item.Name</span>
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <span class="text-sm font-bold @(remaining < 0 ? "text-red-600" : "text-green-600")">$@remaining.ToString("N2")</span>
                                                    <button class="text-gray-400 hover:text-blue-600 transition p-1" @onclick:stopPropagation="true" @onclick="() => OpenEditModal(item)">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="bg-blue-500 h-full transition-all duration-500" style="width: @Math.Min(percent, 100)%"></div>
                                            </div>
                                            <div class="flex justify-end text-[10px] text-gray-400">of $@totalAvailable.ToString("N2") @if(item.CarriedOver != 0){<span>($@item.CarriedOver carry)</span>}</div>
                                        </div>
                                    </div>

                                    @if(isExpanded)
                                    {
                                        var details = GetItemHistory(item.Id);
                                        <div class="bg-gray-100 border-y border-gray-200 p-3 shadow-inner">
                                            @if(details.Any())
                                            {
                                                <table class="w-full text-xs">
                                                    <thead><tr class="text-gray-500 uppercase tracking-wide text-left border-b border-gray-300"><th class="pb-1">Date</th><th class="pb-1">Desc</th><th class="pb-1 text-right">Amt</th></tr></thead>
                                                    <tbody class="divide-y divide-gray-200">
                                                        @foreach(var d in details) { <tr class="hover:bg-gray-50"><td class="py-1 text-gray-500 font-mono">@d.Date.ToString("MM/dd")</td><td class="py-1 text-gray-800 truncate max-w-[120px]" title="@d.Desc">@d.Desc</td><td class="py-1 text-right font-bold @(d.Amount < 0 ? "text-green-600" : "text-red-600")">$@Math.Abs(d.Amount).ToString("N2")</td></tr> }
                                                    </tbody>
                                                </table>
                                            }
                                            else { <div class="text-center text-xs text-gray-400 italic py-2">No items.</div> }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                    <button class="w-full py-3 border-2 border-dashed border-gray-600 hover:border-gray-400 text-gray-500 rounded-lg transition font-bold uppercase tracking-wider text-xs">+ Add Budget Cycle</button>
                </div>

                <div class="bg-white rounded-lg overflow-hidden border border-green-200 shadow-md mt-8">
                    <div class="bg-green-600 px-3 py-2 flex justify-between items-center text-white">
                        <span class="font-bold text-xs uppercase tracking-wider">Expected Income</span>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono font-bold">$@((CurrentPeriod.ExpectedIncome ?? new()).Sum(x => x.Amount).ToString("N2"))</span>
                            <button class="bg-green-700 rounded p-0.5" @onclick="() => OpenIncomeModal()"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-100">
                        @foreach(var inc in (CurrentPeriod.ExpectedIncome ?? new()).OrderBy(x => x.Date)) {
                            <div class="flex justify-between items-center p-2 hover:bg-green-50 transition group">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full border border-green-200 overflow-hidden bg-white flex-shrink-0">
                                        <img src="@GetSourceImage(inc.SourceStringId)" class="w-full h-full object-cover" />
                                    </div>
                                    <div><div class="text-xs font-bold text-gray-800">@GetSourceName(inc.SourceStringId)</div><div class="text-[10px] text-gray-500">Exp: @inc.Date.ToString("MM/dd")</div></div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-mono text-green-600 font-bold text-sm">+$@inc.Amount.ToString("N2")</span>
                                    <button class="text-gray-400 hover:text-green-600 transition" @onclick="() => OpenIncomeModal(inc)"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="bg-white rounded-lg overflow-hidden border border-orange-200 shadow-md">
                    <div class="bg-[#e67e22] px-3 py-2 flex justify-between items-center text-white">
                        <span class="font-bold text-xs uppercase tracking-wider">Expected Expenses</span>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono font-bold">$@((CurrentPeriod.WatchList ?? new()).Sum(x => x.Amount).ToString("N2"))</span>
                            <button class="bg-[#d35400] rounded p-0.5" @onclick="() => OpenWatchModal()"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-100">
                        @foreach(var item in (CurrentPeriod.WatchList ?? new()).OrderBy(x => x.DueDate ?? DateTime.MaxValue)) {
                            <div class="flex justify-between items-center p-3 hover:bg-orange-50 transition text-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-white overflow-hidden flex-shrink-0 border border-gray-200 shadow-sm">
                                        <img src="@GetBudgetItemImage(item.ResolvedBudgetItemId)" class="w-full h-full object-cover" />
                                    </div>
                                    <div><div class="text-xs font-bold text-gray-800 truncate w-32">@item.Description</div><div class="text-[10px] text-gray-500">Due: @(item.DueDate?.ToString("MM/dd") ?? "TBD")</div></div>
                                </div>
                                <div class="flex items-center gap-3 text-right">
                                    <span class="font-mono font-bold text-sm text-gray-700">$@item.Amount.ToString("N2")</span>
                                    <button class="text-gray-400 hover:text-orange-600 transition" @onclick="() => OpenWatchModal(item)"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    }

    @* 1. BUDGET ITEM MODAL *@
    @if (EditingItem != null)
    {
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-gray-200">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span>Edit Budget Category</span>
                    <button @onclick="CloseEditModal" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Item Name</label>
                        <input @bind="EditingItem.Name" class="w-full border rounded p-2 text-sm outline-none" />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Planned ($)</label>
                            <input type="number" @bind="EditingItem.PlannedAmount" step="0.01" class="w-full border rounded p-2 text-sm font-mono outline-none" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Carried Over ($)</label>
                            <input type="number" @bind="EditingItem.CarriedOver" step="0.01" class="w-full border rounded p-2 text-sm font-mono outline-none" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Image</label>
                        <div class="flex gap-4">
                            <div class="w-20 h-20 bg-white rounded-lg flex-shrink-0 overflow-hidden border border-gray-300 flex items-center justify-center shadow-sm">
                                @if(!string.IsNullOrEmpty(EditingItem.ImgUrl)) { <img src="@EditingItem.ImgUrl" class="w-full h-full object-cover" /> } else { <span class="text-xs text-gray-400 font-mono">No Img</span> }
                            </div>
                            <div class="flex-1 flex flex-col gap-2">
                                <input @bind="EditingItem.ImgUrl" class="w-full border rounded p-2 text-xs outline-none font-mono" placeholder="Paste URL..." />
                                <div class="relative">
                                    <label class="w-full bg-gray-200 hover:bg-gray-300 text-gray-600 text-xs font-bold py-2 px-4 rounded cursor-pointer text-center block transition">üìÅ Upload Image<InputFile OnChange="HandleFileUpload" class="hidden" accept="image/*" /></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex justify-end gap-2 border-t">
                    <button @onclick="CloseEditModal" class="px-4 py-2 text-xs font-bold text-gray-600 hover:bg-gray-200 rounded uppercase">Cancel</button>
                    <button @onclick="SaveEditItem" class="px-4 py-2 text-xs font-bold bg-blue-600 hover:bg-blue-500 text-white rounded shadow uppercase">Save Changes</button>
                </div>
            </div>
        </div>
    }

    @* 2. INCOME MODAL *@
    @if (EditingIncome != null)
    {
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border border-gray-200">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span>@(EditingIncome.Id == 0 ? "Add Income" : "Edit Income")</span>
                    <button @onclick="() => EditingIncome = null" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Source</label>
                        <select @bind="EditingIncome.SourceStringId" class="w-full border rounded p-2 text-sm">
                            <option value="">-- Select Source --</option>
                            @foreach(var src in incomeSources) { <option value="@src.StringId">@src.Name</option> }
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" @bind="EditingIncome.Date" class="w-full border rounded p-2 text-sm" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Amount ($)</label>
                        <input type="number" @bind="EditingIncome.Amount" step="0.01" class="w-full border rounded p-2 text-sm font-mono text-green-700 font-bold" />
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex justify-end gap-2 border-t">
                    <button @onclick="() => EditingIncome = null" class="px-4 py-2 text-xs text-gray-600 font-bold uppercase">Cancel</button>
                    <button @onclick="SaveIncome" class="px-4 py-2 text-xs bg-green-600 text-white rounded font-bold uppercase">Save Income</button>
                </div>
            </div>
        </div>
    }

    @* 3. WATCH MODAL *@
    @if (EditingWatch != null)
    {
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden border border-gray-200">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span>@(EditingWatch.Id == 0 ? "Add Watch Item" : "Edit Watch Item")</span>
                    <button @onclick="() => EditingWatch = null" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                </div>
                <div class="p-5 space-y-4 text-sm text-gray-800">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Description</label>
                        <input @bind="EditingWatch.Description" class="w-full border rounded p-2 text-sm" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Link to Category (For Image)</label>
                        <select @bind="EditingWatch.ResolvedBudgetItemId" class="w-full border rounded p-2 text-sm outline-none">
                            <option value="">-- No Link --</option>
                            @foreach(var item in FlatBudgetList) { <option value="@item.Id">@item.Name</option> }
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Amount ($)</label>
                            <input type="number" @bind="EditingWatch.Amount" step="0.01" class="w-full border rounded p-2 text-sm text-red-600 font-bold" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Due Date</label>
                            <input type="date" @bind="EditingWatch.DueDate" class="w-full border rounded p-2 text-sm" />
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex justify-end gap-2 border-t">
                    <button @onclick="() => EditingWatch = null" class="px-4 py-2 text-xs text-gray-600 font-bold uppercase">Cancel</button>
                    <button @onclick="SaveWatchItem" class="px-4 py-2 text-xs bg-orange-600 text-white rounded font-bold uppercase shadow">Save Item</button>
                </div>
            </div>
        </div>
    }

    @* 4. TRANSACTION MODAL *@
    @if (EditingTransaction != null)
    {
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden border border-gray-200 text-gray-800">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span>@(EditingTransaction.Id == 0 ? "Add Transaction" : "Edit Transaction")</span>
                    <button @onclick="() => EditingTransaction = null" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                </div>
                <div class="p-5 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Date</label>
                            <input type="date" @bind="EditingTransaction.Date" class="w-full border rounded p-2 text-sm" />
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Description</label>
                            <input @bind="EditingTransaction.Description" class="w-full border rounded p-2 text-sm" />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Amount</label>
                        <input type="number" @bind="EditingTransaction.Amount" step="0.01" class="w-full border rounded p-2 text-lg font-mono font-bold @(EditingTransaction.Amount >= 0 ? "text-green-700 border-green-200 bg-green-50" : "text-red-700 border-red-200 bg-red-50")" />
                    </div>

                    @if (EditingTransaction.Amount > 0)
                    {
                        <div class="bg-green-50 p-3 rounded border border-green-200">
                            <label class="block text-[10px] font-bold text-green-700 uppercase mb-1">Income Source (Optional)</label>
                            <select @bind="EditingTransaction.SourceStringId" class="w-full bg-white border border-green-300 rounded p-2 text-sm outline-none">
                                <option value="">-- Select --</option>
                                @foreach(var src in incomeSources) { <option value="@src.StringId">@src.Name</option> }
                            </select>
                        </div>
                    }

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Allocation</label>
                            <button class="text-xs text-blue-600 hover:underline" @onclick="AddSplit">üîÄ Split this Transaction</button>
                        </div>

                        @if (!EditingTransaction.Splits.Any())
                        {
                            <select @bind="EditingTransaction.ResolvedBudgetItemId" class="w-full border rounded p-2 text-sm">
                                <option value="">-- Unallocated --</option>
                                @foreach(var item in FlatBudgetList) { <option value="@item.Id">@item.Name</option> }
                            </select>
                        }
                        else
                        {
                            <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                @foreach (var split in EditingTransaction.Splits)
                                {
                                    <div class="flex gap-2 items-center">
                                        <select @bind="split.ResolvedBudgetItemId" class="flex-1 border rounded p-2 text-sm">
                                            <option value="">-- Select Budget --</option>
                                            @foreach(var item in FlatBudgetList) { <option value="@item.Id">@item.Name</option> }
                                        </select>
                                        <input type="number" @bind="split.Amount" step="0.01" class="w-24 border rounded p-2 text-sm font-mono text-right" />
                                        <button class="text-red-400 px-2" @onclick="() => EditingTransaction.Splits.Remove(split)">&times;</button>
                                    </div>
                                }
                            </div>
                            <button class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold" @onclick="AddSplit">+ Add Row</button>
                        }
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 flex justify-end gap-2 border-t">
                    <button @onclick="() => EditingTransaction = null" class="px-4 py-2 text-xs text-gray-600 font-bold uppercase">Cancel</button>
                    <button @onclick="SaveTransaction" class="px-4 py-2 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded font-bold uppercase shadow">Save</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private int userId = 0;
    private bool isLoading = true;
    private List<BudgetPeriod> periods = new();
    private List<BudgetIncomeSource> incomeSources = new();
    private List<BudgetItem> FlatBudgetList = new(); 
    
    private int currentIndex = 0;
    private int? ExpandedItemId = null;
    
    private BudgetItem? EditingItem = null; 
    private BudgetExpectedIncome? EditingIncome = null;
    private BudgetWatchItem? EditingWatch = null;
    private BudgetTransaction? EditingTransaction = null;

    private BudgetPeriod? CurrentPeriod => periods.Count > 0 && currentIndex >= 0 && currentIndex < periods.Count ? periods[currentIndex] : null;
    private bool CanGoBack => currentIndex < periods.Count - 1; 
    private bool CanGoNext => currentIndex > 0; 
    private decimal CurrentBalance => CurrentPeriod == null ? 0 : CurrentPeriod.InitialBankBalance + CurrentPeriod.Transactions.Sum(t => t.Amount);
    private string GetBalanceColor(decimal bal) => bal >= 0 ? "text-green-400 font-bold" : "text-red-400 font-bold";

    private void NextPeriod() { if (CanGoNext) { currentIndex--; ExpandedItemId = null; RefreshFlatList(); } } 
    private void PrevPeriod() { if (CanGoBack) { currentIndex++; ExpandedItemId = null; RefreshFlatList(); } } 
    private void ToggleExpand(int itemId) { ExpandedItemId = ExpandedItemId == itemId ? null : itemId; }

    // --- MODALS ---
    private void OpenEditModal(BudgetItem item) { EditingItem = item; }
    private void CloseEditModal() { EditingItem = null; }
    private void OpenIncomeModal(BudgetExpectedIncome? income = null) { EditingIncome = income ?? new BudgetExpectedIncome { BudgetPeriodId = CurrentPeriod?.Id ?? 0, Date = CurrentPeriod?.StartDate ?? DateTime.Today }; }
    private void OpenWatchModal(BudgetWatchItem? item = null) { RefreshFlatList(); EditingWatch = item ?? new BudgetWatchItem { BudgetPeriodId = CurrentPeriod?.Id ?? 0 }; }
    private void OpenTransactionModal(BudgetTransaction? trans = null) { RefreshFlatList(); if (trans == null) { EditingTransaction = new BudgetTransaction { BudgetPeriodId = CurrentPeriod?.Id ?? 0, Date = DateTime.Today, Amount = -0.00m }; } else { EditingTransaction = trans; } }

    private void AddSplit() { if (EditingTransaction == null) return; if (!EditingTransaction.Splits.Any() && EditingTransaction.ResolvedBudgetItemId.HasValue) { EditingTransaction.Splits.Add(new BudgetTransactionSplit { ResolvedBudgetItemId = EditingTransaction.ResolvedBudgetItemId.Value, Amount = Math.Abs(EditingTransaction.Amount) }); EditingTransaction.ResolvedBudgetItemId = null; } EditingTransaction.Splits.Add(new BudgetTransactionSplit { Amount = 0 }); }

    // --- ADMIN DB FIXES (The corrected logic that won't break the build) ---
    private async Task FixWatchTableStructure() {
        var sql = @"DROP TABLE IF EXISTS ""BudgetWatchItems""; CREATE TABLE ""BudgetWatchItems"" (""Id"" SERIAL PRIMARY KEY, ""BudgetPeriodId"" INTEGER NOT NULL, ""Description"" TEXT NOT NULL DEFAULT '', ""Amount"" NUMERIC NOT NULL DEFAULT 0, ""DueDate"" TIMESTAMP NULL, ""ResolvedBudgetItemId"" INTEGER NULL, CONSTRAINT ""FK_Watch_Periods"" FOREIGN KEY (""BudgetPeriodId"") REFERENCES ""BudgetPeriods""(""Id"") ON DELETE CASCADE);";
        await Db.Database.ExecuteSqlRawAsync(sql); await RefreshData(); await JS.InvokeVoidAsync("alert", "Database Table Structure Updated.");
    }

    private async Task RepairWatchLinks() {
        if (CurrentPeriod == null) return;
        
        // Corrected DB Join Logic (The part that failed previously)
        var cycleIds = await Db.BudgetCycles.Where(c => c.BudgetPeriodId == CurrentPeriod.Id).Select(c => c.Id).ToListAsync();
        var items = await Db.BudgetItems.Where(i => cycleIds.Contains(i.BudgetCycleId)).ToListAsync();
        
        var watchItems = await Db.BudgetWatchItems.Where(w => w.BudgetPeriodId == CurrentPeriod.Id).ToListAsync();
        foreach(var w in watchItems) { 
            var match = items.FirstOrDefault(i => string.Equals(i.Name, w.Description, StringComparison.OrdinalIgnoreCase)); 
            if(match != null) w.ResolvedBudgetItemId = match.Id; 
        }
        await Db.SaveChangesAsync(); await RefreshData(); await JS.InvokeVoidAsync("alert", $"Linked {watchItems.Count(x => x.ResolvedBudgetItemId.HasValue)} items.");
    }

    // --- SAVES ---
    private async Task SaveEditItem() { if(EditingItem != null) { Db.BudgetItems.Update(EditingItem); await Db.SaveChangesAsync(); EditingItem = null; await RefreshData(); } }
    private async Task SaveIncome() { if(EditingIncome != null) { if(EditingIncome.Id == 0) Db.BudgetExpectedIncome.Add(EditingIncome); else Db.BudgetExpectedIncome.Update(EditingIncome); await Db.SaveChangesAsync(); EditingIncome = null; await RefreshData(); } }
    private async Task SaveWatchItem() { if(EditingWatch != null) { if(EditingWatch.Id == 0) Db.BudgetWatchItems.Add(EditingWatch); else Db.BudgetWatchItems.Update(EditingWatch); await Db.SaveChangesAsync(); EditingWatch = null; await RefreshData(); } }
    private async Task SaveTransaction() { if(EditingTransaction != null) { if(EditingTransaction.Splits.Any()) EditingTransaction.ResolvedBudgetItemId = null; if(EditingTransaction.Id == 0) Db.BudgetTransactions.Add(EditingTransaction); else Db.BudgetTransactions.Update(EditingTransaction); await Db.SaveChangesAsync(); EditingTransaction = null; await RefreshData(); } }

    // --- LOGIC HELPERS ---
    private string GetTransactionImage(BudgetTransaction t) {
        if(!string.IsNullOrEmpty(t.SourceStringId)) { var src = incomeSources.FirstOrDefault(x => x.StringId == t.SourceStringId); if(src != null && !string.IsNullOrEmpty(src.ImgUrl)) return src.ImgUrl; }
        if(t.ResolvedBudgetItemId.HasValue) return GetBudgetItemImage(t.ResolvedBudgetItemId.Value);
        if(t.Splits.Any()) { var first = t.Splits.FirstOrDefault(); if(first?.ResolvedBudgetItemId != null) return GetBudgetItemImage(first.ResolvedBudgetItemId.Value); }
        return "";
    }
    private string GetBudgetItemImage(int? itemId) { if (itemId == null) return ""; return FlatBudgetList.FirstOrDefault(i => i.Id == itemId)?.ImgUrl ?? ""; }
    private string GetSourceName(string sid) => incomeSources.FirstOrDefault(s => s.StringId == sid)?.Name ?? sid;
    private string GetSourceImage(string sid) => incomeSources.FirstOrDefault(s => s.StringId == sid)?.ImgUrl ?? "";

    private decimal GetSpentForBudgetItem(int itemId) {
        if (CurrentPeriod == null) return 0;
        var direct = CurrentPeriod.Transactions.Where(t => t.ResolvedBudgetItemId == itemId).Sum(t => t.Amount * -1); 
        var splits = CurrentPeriod.Transactions.SelectMany(t => t.Splits.Select(s => new { P = t, S = s })).Where(x => x.S.ResolvedBudgetItemId == itemId).Sum(x => x.P.Amount < 0 ? Math.Abs(x.S.Amount) : -Math.Abs(x.S.Amount));
        var trOut = CurrentPeriod.Transfers.Where(tr => tr.ResolvedFromId == itemId).Sum(tr => tr.Amount);
        var trIn = CurrentPeriod.Transfers.Where(tr => tr.ResolvedToId == itemId).Sum(tr => tr.Amount);
        return (direct + splits + trOut) - trIn;
    }

    private List<(DateTime Date, string Desc, decimal Amount)> GetItemHistory(int itemId) {
        var list = new List<(DateTime, string, decimal)>();
        if (CurrentPeriod == null) return list;
        foreach(var t in CurrentPeriod.Transactions.Where(t => t.ResolvedBudgetItemId == itemId)) list.Add((t.Date, t.Description, t.Amount * -1));
        foreach(var x in CurrentPeriod.Transactions.SelectMany(t => t.Splits.Select(s => new { P = t, S = s })).Where(x => x.S.ResolvedBudgetItemId == itemId)) { decimal a = x.P.Amount < 0 ? Math.Abs(x.S.Amount) : -Math.Abs(x.S.Amount); list.Add((x.P.Date, $"{x.P.Description} (Split)", a)); }
        foreach(var tr in CurrentPeriod.Transfers.Where(tr => tr.ResolvedFromId == itemId)) list.Add((tr.Date, $"To {tr.ToStringId}", tr.Amount));
        foreach(var tr in CurrentPeriod.Transfers.Where(tr => tr.ResolvedToId == itemId)) list.Add((tr.Date, $"From {tr.FromStringId}", -tr.Amount)); 
        return list.OrderBy(x => x.Item1).ToList(); 
    }

    private void RefreshFlatList() { FlatBudgetList.Clear(); if(CurrentPeriod != null) foreach(var c in CurrentPeriod.Cycles) FlatBudgetList.AddRange(c.Items); }
    private async Task RefreshData() { if(userId != 0) { periods = await BudgetService.GetPeriods(userId); RefreshFlatList(); StateHasChanged(); } }
    private async Task HandleFileUpload(InputFileChangeEventArgs e) { if (EditingItem == null) return; var url = await UploadImageToDb(e.File); if(!string.IsNullOrEmpty(url)) EditingItem.ImgUrl = url; }
    private async Task<string> UploadImageToDb(IBrowserFile file) { if (file.Size > 5 * 1024 * 1024) return ""; using var stream = file.OpenReadStream(5 * 1024 * 1024); using var ms = new MemoryStream(); await stream.CopyToAsync(ms); return await BulletBase.SaveImageAsync(ms.ToArray(), file.ContentType); }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) {
                    using (var doc = JsonDocument.Parse(json)) {
                        if (doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("id", out p)) {
                            userId = p.GetInt32(); await LoadData();
                        }
                    }
                }
            } catch { } finally { isLoading = false; StateHasChanged(); }
        }
    }

    private async Task LoadData() {
        if (userId == 0) return;
        incomeSources = await Db.BudgetIncomeSources.Where(x => x.UserId == userId || x.UserId == 0).ToListAsync();
        periods = await BudgetService.GetPeriods(userId);
        if (periods.Any()) currentIndex = 0;
        RefreshFlatList();
    }
}