@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject AppDbContext Db
@inject BulletTaskService TaskService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Year Book Export | Stephens' Dashboard</PageTitle>

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="p-20 text-center text-2xl font-black italic">Preparing Chapter: @CurrentMonthName...</div>
    }
    else
    {
        @* --- 1. THE MONTHLY OVERVIEW PAGES (LEFT) --- *@
        <div class="print-page page-left">
            <div class="flex h-full">
                <div class="month-vertical-label">@CurrentMonthName.ToUpper()</div>
                <div class="flex-1 grid grid-cols-3 gap-2 p-6 border-l border-gray-100">
                    @foreach (var day in LeftDays)
                    {
                        <div class="border border-gray-300 rounded p-2 flex flex-col h-full bg-gray-50/30">
                            <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1">@day.Date.ToString("ddd d")</span>
                            <div class="space-y-1 overflow-hidden">
                                @foreach (var item in GetItemsForDay(day.Date).Take(8))
                                {
                                    <div class="text-[8px] leading-tight truncate">
                                        @GetIcon(item) @item.Title
                                    </div>
                                }
                                @if(GetItemsForDay(day.Date).Count > 8)
                                {
                                    <div class="text-[7px] text-blue-500 font-bold">+ @(GetItemsForDay(day.Date).Count - 8) more</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* --- 2. THE MONTHLY OVERVIEW PAGES (RIGHT) --- *@
        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="flex-1 grid grid-cols-4 gap-2 p-6 pb-2">
                    @foreach (var day in RightDays)
                    {
                        <div class="border border-gray-300 rounded p-2 flex flex-col h-full bg-gray-50/30">
                            <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1">@day.Date.ToString("ddd d")</span>
                            <div class="space-y-1 overflow-hidden">
                                @foreach (var item in GetItemsForDay(day.Date).Take(8))
                                {
                                    <div class="text-[8px] leading-tight truncate">
                                        @GetIcon(item) @item.Title
                                    </div>
                                }
                                @if(GetItemsForDay(day.Date).Count > 8)
                                {
                                    <div class="text-[7px] text-blue-500 font-bold">+ @(GetItemsForDay(day.Date).Count - 8) more</div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="h-24 border-t border-dashed border-gray-300 m-6 mt-0 p-4 rounded-lg bg-gray-50">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Monthly Goals & Focus</div>
                    <div class="border-b border-gray-200 w-full mb-3"></div>
                    <div class="border-b border-gray-200 w-full mb-3"></div>
                    <div class="border-b border-gray-200 w-full mb-3"></div>
                </div>
            </div>
        </div>

        @* --- 3. THE DAILY DETAIL CHUNKS (2 per page) --- *@
        @foreach (var dayGroup in AllDays.Chunk(2))
        {
            <div class="print-page @(GetSideClass())">
                @foreach (var dayDate in dayGroup)
                {
                    var items = GetItemsForDay(dayDate);
                    <div class="day-block border-b border-gray-100 p-10 h-1/2 relative">
                        <div class="flex justify-between items-end mb-6 border-b-4 border-black pb-2">
                            <h3 class="text-3xl font-black tracking-tighter uppercase">@dayDate.ToString("dddd")</h3>
                            <div class="text-right">
                                <div class="text-xl font-black">@dayDate.ToString("MMMM d")</div>
                                <div class="text-[10px] font-bold text-gray-400 tracking-[0.2em]">YEAR @Year</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-12 gap-10 h-[calc(100%-80px)]">
                            <div class="col-span-7 space-y-4">
                                @foreach (var t in items.Where(x => x.Type == "task" || x.Type == "meeting" || x.Type == "habit").Take(12))
                                {
                                    <div class="flex items-start gap-3 text-xs">
                                        <div class="w-4 h-4 border-2 border-black rounded-sm shrink-0 mt-0.5 @(IsDone(t) ? "bg-black" : "")">
                                            @if(IsDone(t)) { <span class="text-white text-[10px] flex items-center justify-center">‚úì</span> }
                                        </div>
                                        <div class="flex-1">
                                            <span class="font-bold @(IsDone(t) ? "line-through text-gray-400" : "")">@t.Title</span>
                                            @if(t.Todos != null && t.Todos.Any())
                                            {
                                                <div class="pl-4 mt-1 space-y-1">
                                                    @foreach(var todo in t.Todos.Take(3))
                                                    {
                                                        <div class="text-[10px] text-gray-500">‚Ä¢ @todo.Content</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="col-span-5 flex flex-col gap-6">
                                @if (items.Any(x => !string.IsNullOrEmpty(x.ImgUrl)))
                                {
                                    <div class="rounded-xl overflow-hidden border-2 border-gray-100 shadow-sm">
                                        <img src="@items.First(x => !string.IsNullOrEmpty(x.ImgUrl)).ImgUrl" class="w-full h-auto object-cover max-h-48" />
                                    </div>
                                }

                                @{ var health = items.FirstOrDefault(x => x.Type == "health"); }
                                @if (health != null)
                                {
                                    <div class="bg-black text-white p-4 rounded-xl shadow-lg">
                                        <div class="text-[9px] uppercase font-black tracking-widest text-emerald-400 mb-2">Daily Stats</div>
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-xs">Weight:</span>
                                            <span class="text-lg font-black">@(health.HealthDetail?.WeightLbs ?? 0) lbs</span>
                                        </div>
                                        <div class="flex justify-between items-baseline mt-1">
                                            <span class="text-xs">Meals:</span>
                                            <span class="text-lg font-black">@health.Meals.Count</span>
                                        </div>
                                    </div>
                                }
                                
                                @if (items.Any(x => x.Notes != null && x.Notes.Any()))
                                {
                                    <div class="p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg italic text-[10px] text-gray-700">
                                        @foreach(var note in items.Where(x => x.Notes != null).SelectMany(x => x.Notes).Take(2))
                                        {
                                            <div class="mb-1">‚Äú@note.Content‚Äù</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .print-page { width: 8.5in; height: 11in; position: relative; overflow: hidden; page-break-after: always; background: white; }
    .page-left { padding-right: 0.8in; padding-left: 0.4in; }
    .page-right { padding-left: 0.8in; padding-right: 0.4in; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; color: #f3f4f6; display: flex; align-items: center; padding-top: 2rem; line-height: 1; }
    @@media screen { .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); } .print-container { background: #f0f0f0; padding: 20px 0; } }
</style>

@code {
    [Parameter][SupplyParameterFromQuery] public int Year { get; set; } = DateTime.Now.Year;
    [Parameter][SupplyParameterFromQuery] public int Month { get; set; } = DateTime.Now.Month;

    private bool isLoading = true;
    private List<BulletTaskService.TaskDTO> monthItems = new();
    private List<DateTime> AllDays = new();
    private List<DateTime> LeftDays = new();
    private List<DateTime> RightDays = new();
    private string CurrentMonthName => new DateTime(Year > 0 ? Year : 2026, Month > 0 ? Month : 1, 1).ToString("MMMM");
    private int pageCounter = 0;

    protected override async Task OnInitializedAsync()
    {
        if (Year == 0) Year = DateTime.Now.Year;
        if (Month == 0) Month = DateTime.Now.Month;

        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);

        monthItems = await TaskService.GetTasksForRange(1, start, end);
        
        AllDays.Clear(); LeftDays.Clear(); RightDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1))
        {
            AllDays.Add(dt);
            if (dt.DayOfWeek == DayOfWeek.Monday || dt.DayOfWeek == DayOfWeek.Tuesday || dt.DayOfWeek == DayOfWeek.Wednesday)
                LeftDays.Add(dt);
            else
                RightDays.Add(dt);
        }
        isLoading = false;
    }

    private List<BulletTaskService.TaskDTO> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass()
    {
        pageCounter++;
        return pageCounter % 2 == 0 ? "page-left" : "page-right";
    }

    private string GetIcon(BulletTaskService.TaskDTO item) => item.Type switch {
        "habit" => "üî•", "meeting" => "‚è∞", "health" => "üí™", "media" => "üé¨", _ => "‚Ä¢"
    };

    private bool IsDone(BulletTaskService.TaskDTO t) => 
        (t.Detail?.IsCompleted ?? false) || (t.HabitDetail?.IsCompleted ?? false);
}