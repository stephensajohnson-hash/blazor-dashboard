@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="month-chapter">
    @if (isLoading)
    {
        <div class="print-page flex items-center justify-center text-gray-300 italic font-black">
            Syncing @CurrentMonthName...
        </div>
    }
    else
    {
        @* --- SPREAD PAGE 1 (LEFT SIDE: MON-WED) --- *@
        <div class="print-page page-left">
            <div class="flex h-full">
                <div class="month-vertical-label">@CurrentMonthName.ToUpper()</div>
                <div class="flex-1 grid grid-cols-3 gap-2 p-6 border-l border-gray-100">
                    @foreach (var day in CalendarGrid.Where(x => x.DayOfWeek >= 1 && x.DayOfWeek <= 3))
                    {
                        <div class="border border-gray-300 rounded p-2 min-h-[140px] bg-gray-50/30 @(day.IsPlaceholder ? "opacity-0 border-none" : "")">
                            @if (!day.IsPlaceholder)
                            {
                                <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@day.Date.ToString("ddd d")</span>
                                <div class="space-y-1">
                                    @foreach (var item in GetItemsForDay(day.Date).Take(5))
                                    {
                                        <div class="text-[8px] leading-tight truncate">@GetIcon(item) @item.Title</div>
                                    }
                                    @if (!string.IsNullOrEmpty(GetImageForDay(day.Date)))
                                    {
                                        <img src="@GetImageForDay(day.Date)" class="mt-1 rounded w-full h-14 object-cover grayscale opacity-80" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        @* --- SPREAD PAGE 2 (RIGHT SIDE: THU-SUN) --- *@
        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="flex-1 grid grid-cols-4 gap-2 p-6 pb-2">
                    @foreach (var day in CalendarGrid.Where(x => x.DayOfWeek == 0 || x.DayOfWeek >= 4))
                    {
                        @* Sort Sunday (0) to the end of the line if you prefer Mon-Sun layout *@
                        <div class="border border-gray-300 rounded p-2 min-h-[140px] bg-gray-50/30 @(day.IsPlaceholder ? "opacity-0 border-none" : "")">
                            @if (!day.IsPlaceholder)
                            {
                                <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@day.Date.ToString("ddd d")</span>
                                <div class="space-y-1">
                                    @foreach (var item in GetItemsForDay(day.Date).Take(5))
                                    {
                                        <div class="text-[8px] leading-tight truncate">@GetIcon(item) @item.Title</div>
                                    }
                                    @if (!string.IsNullOrEmpty(GetImageForDay(day.Date)))
                                    {
                                        <img src="@GetImageForDay(day.Date)" class="mt-1 rounded w-full h-14 object-cover grayscale opacity-80" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="h-24 border-t border-dashed border-gray-300 m-6 mt-0 p-4 rounded-lg bg-gray-50">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Monthly Goals & Focus (@CurrentMonthName)</div>
                    <div class="border-b border-gray-100 w-full mb-3 h-4"></div>
                    <div class="border-b border-gray-100 w-full mb-3 h-4"></div>
                </div>
            </div>
        </div>

        @* --- DAILY DETAIL PAGES (Elastic Layout) --- *@
        @foreach (var dayDate in AllDays)
        {
            var items = GetItemsForDay(dayDate);
            <div class="print-page daily-detail @(GetSideClass())">
                <div class="p-12 relative flex flex-col h-full">
                    <div class="flex justify-between items-end mb-8 border-b-8 border-black pb-2">
                        <h3 class="text-4xl font-black tracking-tighter uppercase leading-none">@dayDate.ToString("dddd")</h3>
                        <div class="text-right">
                            <div class="text-2xl font-black leading-none">@dayDate.ToString("MMMM d")</div>
                            <div class="text-[10px] font-bold text-gray-400 tracking-[0.3em] uppercase">Stephens' Journal</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-12">
                        <div class="col-span-8 space-y-10">
                            @foreach (var t in items)
                            {
                                <div class="item-entry">
                                    <div class="flex items-start gap-4">
                                        <div class="text-xl">@GetIcon(t)</div>
                                        <div class="flex-1">
                                            <div class="text-base font-black uppercase tracking-tight">@t.Title</div>
                                            @if (!string.IsNullOrEmpty(t.Description))
                                            {
                                                <div class="text-xs text-gray-600 mt-2 leading-relaxed border-l-4 border-gray-100 pl-4">@t.Description</div>
                                            }
                                            @if (t.Todos?.Any() == true)
                                            {
                                                <div class="mt-4 space-y-2 ml-1">
                                                    @foreach (var todo in t.Todos)
                                                    {
                                                        <div class="text-xs flex items-center gap-3">
                                                            <div class="w-3 h-3 border-2 border-black rounded-sm shrink-0 @(todo.IsCompleted ? "bg-black" : "")"></div>
                                                            <span class="@(todo.IsCompleted ? "line-through text-gray-400" : "")">@todo.Content</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="col-span-4 flex flex-col gap-8">
                            @foreach(var img in items.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                            {
                                <div class="rounded-xl overflow-hidden border border-gray-200 shadow-xl">
                                    <img src="@img.ImgUrl" class="w-full h-auto" />
                                </div>
                            }

                            @{ var health = items.FirstOrDefault(x => x.Type == "health"); }
                            @if (health != null)
                            {
                                <div class="bg-black text-white p-6 rounded-2xl shadow-2xl">
                                    <div class="text-[10px] uppercase font-black text-emerald-400 mb-4 tracking-[0.2em] border-b border-emerald-900 pb-2">Daily Health Log</div>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-xs opacity-60 uppercase">Weight</span>
                                            <span class="text-xl font-black">@(health.DbHealthDetail?.WeightLbs ?? 0) <small class="text-[10px] opacity-50">LBS</small></span>
                                        </div>
                                        @if(health.Meals?.Any() == true) {
                                            <div class="space-y-3 mt-4">
                                                @foreach(var meal in health.Meals) {
                                                    <div class="text-[10px] leading-tight">
                                                        <div class="font-bold text-emerald-300 uppercase tracking-tighter">@meal.MealType: @meal.Name</div>
                                                        <div class="opacity-50 mt-0.5">@meal.Calories CAL | P:@meal.Protein C:@meal.Carbs F:@meal.Fat</div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .print-page { width: 8.5in; min-height: 11in; position: relative; page-break-after: always; background: white; overflow: hidden; }
    .daily-detail { height: auto; min-height: 11in; overflow: visible; }
    .page-left { padding-right: 0.8in; padding-left: 0.4in; }
    .page-right { padding-left: 0.8in; padding-right: 0.4in; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; color: #f9fafb; display: flex; align-items: center; padding-top: 2rem; line-height: 1; }
    @@media screen { 
        .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); height: 11in; overflow-y: auto; } 
        .print-container { background: #f3f4f6; padding: 20px 0; }
    }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }

    private bool isLoading = true;
    private List<BulletItem> monthItems = new();
    private List<DateTime> AllDays = new();
    private List<CalendarSlot> CalendarGrid = new();
    private string CurrentMonthName => new DateTime(Year, Month, 1).ToString("MMMM");
    private int pageCounter = 0;

    public class CalendarSlot {
        public DateTime Date { get; set; }
        public bool IsPlaceholder { get; set; }
        public int DayOfWeek { get; set; } // 0=Sun, 1=Mon...
    }

    protected override async Task OnParametersSetAsync() { await LoadMonthData(); }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);

        using var db = await DbFactory.CreateDbContextAsync();
        monthItems = await db.BulletItems
            .Include(x => x.DbTaskDetail).Include(x => x.DbHabitDetail).Include(x => x.DbHealthDetail)
            .Include(x => x.Todos).Include(x => x.Notes).Include(x => x.Meals).Include(x => x.Workouts)
            .Where(x => x.UserId == 1 && x.Date >= start && x.Date <= end)
            .OrderBy(x => x.Date).ThenBy(x => x.SortOrder)
            .ToListAsync();
        
        AllDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1)) { AllDays.Add(dt); }

        // BUILD THE GRID
        CalendarGrid.Clear();
        int daysInMonth = DateTime.DaysInMonth(Year, Month);
        int offset = ((int)start.DayOfWeek + 6) % 7; // Monday-based offset

        // 1. Pre-padding (Placeholders for days before the 1st)
        for (int i = 0; i < offset; i++) {
            CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true, DayOfWeek = (i + 1) });
        }
        // 2. Real Days
        for (int d = 1; d <= daysInMonth; d++) {
            var date = new DateTime(Year, Month, d);
            int dw = (int)date.DayOfWeek;
            CalendarGrid.Add(new CalendarSlot { Date = date, DayOfWeek = dw == 0 ? 7 : dw });
        }
        // 3. Post-padding to complete the weeks
        while (CalendarGrid.Count % 7 != 0) {
            CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true });
        }

        isLoading = false;
    }

    private string GetImageForDay(DateTime d) => 
        monthItems.FirstOrDefault(x => x.Date.Date == d.Date && !string.IsNullOrEmpty(x.ImgUrl))?.ImgUrl ?? "";

    private List<BulletItem> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass() { pageCounter++; return pageCounter % 2 == 0 ? "page-left" : "page-right"; }

    private string GetIcon(BulletItem item) => item.Type switch {
        "habit" => "ðŸ”¥", "meeting" => "â°", "health" => "ðŸ’ª", "media" => "ðŸŽ¬", _ => "â€¢"
    };

    private bool IsDone(BulletItem t) => (t.DbTaskDetail?.IsCompleted ?? false) || (t.DbHabitDetail?.IsCompleted ?? false);
}