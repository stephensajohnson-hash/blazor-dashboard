@page "/year-book-export"
@* proven namespaces from your working files *@
@using Dashboard.Services
@using Dashboard.Components.Layout
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@* Use the short names here. Docker's compiler is choking on long-paths *@
@inject AppDbContext Db
@inject BulletTaskService TaskService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Year Book Export | Stephens' Dashboard</PageTitle>

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="p-20 text-center text-2xl font-black italic">Preparing Chapter: @CurrentMonthName...</div>
    }
    else
    {
        <div class="print-page page-left">
            <div class="flex h-full">
                <div class="month-vertical-label">@CurrentMonthName.ToUpper()</div>
                <div class="flex-1 grid grid-cols-3 gap-2 p-6 border-l border-gray-100">
                    @foreach (var day in LeftDays)
                    {
                        <div class="border border-gray-300 rounded p-2 flex flex-col h-full bg-gray-50/30">
                            <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1">@day.Date.ToString("ddd d")</span>
                            <div class="space-y-1 overflow-hidden">
                                @foreach (var item in GetItemsForDay(day.Date).Take(8))
                                {
                                    <div class="text-[8px] leading-tight truncate">
                                        @GetIcon(item) @item.Title
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="flex-1 grid grid-cols-4 gap-2 p-6 pb-2">
                    @foreach (var day in RightDays)
                    {
                        <div class="border border-gray-300 rounded p-2 flex flex-col h-full bg-gray-50/30">
                            <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1">@day.Date.ToString("ddd d")</span>
                            <div class="space-y-1 overflow-hidden">
                                @foreach (var item in GetItemsForDay(day.Date).Take(8))
                                {
                                    <div class="text-[8px] leading-tight truncate">
                                        @GetIcon(item) @item.Title
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        @foreach (var dayGroup in AllDays.Chunk(2))
        {
            <div class="print-page @(GetSideClass())">
                @foreach (var dayDate in dayGroup)
                {
                    var items = GetItemsForDay(dayDate);
                    <div class="day-block border-b border-gray-100 p-10 h-1/2 relative">
                        <div class="flex justify-between items-end mb-6 border-b-4 border-black pb-2">
                            <h3 class="text-3xl font-black tracking-tighter uppercase">@dayDate.ToString("dddd")</h3>
                            <div class="text-right">
                                <div class="text-xl font-black">@dayDate.ToString("MMMM d")</div>
                            </div>
                        </div>
                        @* Logic for task display goes here... *@
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .print-page { width: 8.5in; height: 11in; position: relative; overflow: hidden; page-break-after: always; background: white; }
    .page-left { padding-right: 0.8in; padding-left: 0.4in; }
    .page-right { padding-left: 0.8in; padding-right: 0.4in; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; color: #f3f4f6; display: flex; align-items: center; padding-top: 2rem; line-height: 1; }
    @@media screen { .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); } .print-container { background: #f0f0f0; padding: 20px 0; } }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }

    private bool isLoading = true;
    // Using simple names to avoid shadow conflict
    private List<BulletTaskService.TaskDTO> monthItems = new();
    private List<DateTime> AllDays = new();
    private List<DateTime> LeftDays = new();
    private List<DateTime> RightDays = new();
    private string CurrentMonthName => new DateTime(Year, Month, 1).ToString("MMMM");
    private int pageCounter = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);
        monthItems = await TaskService.GetTasksForRange(1, start, end);
        
        for (var dt = start; dt <= end; dt = dt.AddDays(1))
        {
            AllDays.Add(dt);
            if (dt.DayOfWeek == DayOfWeek.Monday || dt.DayOfWeek == DayOfWeek.Tuesday || dt.DayOfWeek == DayOfWeek.Wednesday)
                LeftDays.Add(dt);
            else
                RightDays.Add(dt);
        }
        isLoading = false;
    }

    private List<BulletTaskService.TaskDTO> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass() { pageCounter++; return pageCounter % 2 == 0 ? "page-left" : "page-right"; }

    private string GetIcon(BulletTaskService.TaskDTO item) => "â€¢";

    private bool IsDone(BulletTaskService.TaskDTO t) => (t.Detail?.IsCompleted ?? false);
}