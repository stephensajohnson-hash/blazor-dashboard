@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="print-page flex items-center justify-center text-gray-400 italic font-black">
            Syncing Year Book Data...
        </div>
    }
    else
    {
        @* --- 1. MONTHLY OVERVIEW SPREAD --- *@
        <div class="print-page page-left">
            <div class="flex h-full flex-col">
                <div class="header-bar flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                    <span class="text-3xl font-black uppercase tracking-tighter">@Year</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em]">Monthly Overview</span>
                </div>
                <div class="flex flex-1">
                    <div class="month-vertical-label text-gray-900">@CurrentMonthName.ToUpper()</div>
                    <div class="flex-1 grid grid-cols-3 gap-1 p-2 border-l border-gray-200">
                        @foreach (var slot in CalendarGrid.Where(x => x.DayOfWeek >= 1 && x.DayOfWeek <= 3))
                        {
                            <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(slot.IsPlaceholder ? "invisible" : "")">
                                @if (!slot.IsPlaceholder)
                                {
                                    <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                        <span class="text-[14px] font-black text-black">@slot.Date.Day</span>
                                        <span class="text-[7px] font-bold text-gray-400 uppercase">@slot.Date.ToString("dddd")</span>
                                    </div>
                                    <div class="space-y-1">
                                        @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                        {
                                            <div class="text-[7px] leading-tight truncate flex items-center gap-1 text-black font-semibold">
                                                @GetIcon(item) <span>@GetCompactText(item)</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                @RenderFooter()
            </div>
        </div>

        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="header-bar flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em]">Monthly Overview</span>
                    <span class="text-3xl font-black uppercase tracking-tighter">@Year</span>
                </div>
                <div class="flex-1 grid grid-cols-4 gap-1 p-2">
                    @foreach (var day in CalendarGrid.Where(x => x.DayOfWeek == 0 || x.DayOfWeek >= 4))
                    {
                        <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(day.IsPlaceholder ? "invisible" : "")">
                            @if (!day.IsPlaceholder)
                            {
                                <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                    <span class="text-[14px] font-black text-black">@day.Date.Day</span>
                                    <span class="text-[7px] font-bold text-gray-400 uppercase">@day.Date.ToString("dddd")</span>
                                </div>
                                <div class="space-y-1">
                                    @foreach (var item in GetItemsForDay(day.Date).Take(6))
                                    {
                                        <div class="text-[7px] leading-tight truncate flex items-center gap-1 text-black font-semibold">
                                            @GetIcon(item) <span>@GetCompactText(item)</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                @RenderFooter()
            </div>
        </div>

        @* --- 2. DAILY DETAIL GRID (5-COLUMN DENSE VIEW) --- *@
        <div class="daily-detail-flow px-[0.4in]">
            @foreach (var dayDate in AllDays)
            {
                var items = GetItemsForDay(dayDate).Where(x => !string.IsNullOrWhiteSpace(x.Title)).ToList();
                if (!items.Any()) continue;

                <section class="day-section">
                    <div class="day-header-line border-b-2 border-black mb-3 mt-10 flex justify-between items-end pb-1">
                        <div>
                            <h3 class="text-3xl font-black tracking-tighter leading-none">@dayDate.Day</h3>
                            <span class="text-[9px] font-black text-gray-400 uppercase tracking-[0.4em]">@dayDate.ToString("dddd")</span>
                        </div>
                        <div class="text-[8px] font-bold text-gray-300">@Year</div>
                    </div>

                    <div class="dense-card-grid">
                        @foreach (var t in items)
                        {
                            <div class="archive-card border border-gray-100 rounded shadow-sm flex flex-col bg-white relative break-inside-avoid">
                                @* Sports/Habit Background Stamps *@
                                @if (t.Type == "sports" && t.DbSportsDetail?.IsComplete == true)
                                {
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.05] z-0">
                                        <span class="text-[28px] font-black -rotate-12 border-2 border-black px-1">@GetScoreStatus(t)</span>
                                    </div>
                                }

                                <div class="flex flex-1 min-h-[80px]">
                                    @* IMAGE LEFT (25% width per config) *@
                                    @if (!string.IsNullOrEmpty(t.ImgUrl))
                                    {
                                        <div class="w-[25%] bg-gray-50 border-r border-gray-50 flex items-start overflow-hidden shrink-0">
                                            <img src="@t.ImgUrl" class="w-full h-auto object-contain" />
                                        </div>
                                    }

                                    @* CONTENT AREA *@
                                    <div class="@(string.IsNullOrEmpty(t.ImgUrl) ? "w-full" : "w-[75%]") p-1.5 flex flex-col z-10">
                                        <div class="flex justify-between items-start gap-1 mb-0.5">
                                            <h4 class="text-[8px] font-black uppercase leading-tight truncate flex-1 text-black">@t.Title</h4>
                                        </div>

                                        <div class="card-details space-y-1">
                                            @if (t.Type == "sports" && t.DbSportsDetail != null)
                                            {
                                                <div class="flex items-center justify-center gap-1.5 py-1">
                                                    @if(allTeams.TryGetValue(t.DbSportsDetail.AwayTeamId, out var away)) { <img src="@away.LogoUrl" class="w-6 h-6 object-contain" /> }
                                                    <span class="text-[10px] font-black">@t.DbSportsDetail.AwayScore : @t.DbSportsDetail.HomeScore</span>
                                                    @if(allTeams.TryGetValue(t.DbSportsDetail.HomeTeamId, out var home)) { <img src="@home.LogoUrl" class="w-6 h-6 object-contain" /> }
                                                </div>
                                            }
                                            else if (t.Type == "media" && t.DbMediaDetail != null)
                                            {
                                                <div class="flex items-center gap-1">
                                                    <span class="text-[7px] font-black bg-black text-white px-1 rounded">@t.DbMediaDetail.ReleaseYear</span>
                                                    <span class="text-[7px] font-black text-yellow-600">â˜… @(t.DbMediaDetail.Rating / 10.0)</span>
                                                </div>
                                            }
                                            else if (t.Type == "habit" && t.DbHabitDetail != null)
                                            {
                                                <div class="flex items-center gap-1 text-[7px] font-black uppercase">
                                                    @if(t.DbHabitDetail.IsCompleted) {
                                                        <span class="text-orange-600">ðŸ”¥ STREAK: @t.DbHabitDetail.StreakCount</span>
                                                    } else if (t.DbHabitDetail.Status == "Skipped") {
                                                        <span class="text-gray-400">SKIPPED</span>
                                                    }
                                                </div>
                                            }
                                            else if (t.Type == "health")
                                            {
                                                <div class="text-[7px] leading-tight border-l border-emerald-200 pl-1.5 space-y-0.5">
                                                    <div class="font-black text-black">@(t.DbHealthDetail?.WeightLbs ?? 0) LBS</div>
                                                    <div class="text-emerald-600 font-bold">Î£ @(t.Meals?.Sum(x => x.Calories) ?? 0) CAL</div>
                                                    @if(t.Meals != null) {
                                                        @foreach(var m in t.Meals.Take(2)) {
                                                            <div class="text-[6px] text-gray-400 truncate uppercase">â€¢ @m.Name</div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>

                                        @if (t.Notes?.Any() == true)
                                        {
                                            <div class="mt-auto pt-1">
                                                <div class="text-[6px] text-gray-400 italic truncate border-t border-gray-50 pt-0.5">
                                                    @t.Notes.First().Content
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }
        </div>
    }
</div>

<style>
    .print-page { 
        width: 8.5in; 
        min-height: 11in; 
        position: relative; 
        background: white; 
        page-break-after: always; 
        display: flex; 
        flex-direction: column; 
        padding-top: 0.4in;
        padding-bottom: 0.4in;
    }
    .page-left { padding-right: 0.6in; padding-left: 0.2in; }
    .page-right { padding-left: 0.6in; padding-right: 0.2in; }

    .dense-card-grid { 
        display: grid; 
        grid-template-columns: repeat(5, 1fr); 
        gap: 6px; 
        padding-bottom: 24px;
    }

    .day-section { page-break-inside: avoid; }
    .archive-card { min-height: 90px; height: auto; }

    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; line-height: 1; }

    @@media screen { 
        .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); } 
    }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }
    [Parameter] public int StartPageNumber { get; set; }

    private bool isLoading = true;
    private List<BulletItem> monthItems = new();
    private Dictionary<int, Team> allTeams = new();
    private List<DateTime> AllDays = new();
    private List<CalendarSlot> CalendarGrid = new();
    private string CurrentMonthName => new DateTime(Year > 0 ? Year : 2026, Month > 0 ? Month : 1, 1).ToString("MMMM");
    private int localPageCounter = 0;

    public class CalendarSlot { public DateTime Date { get; set; } public bool IsPlaceholder { get; set; } public int DayOfWeek { get; set; } }

    protected override async Task OnParametersSetAsync() { await LoadMonthData(); }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);
        using var db = await DbFactory.CreateDbContextAsync();
        
        monthItems = await db.BulletItems
            .Include(x => x.DbTaskDetail).Include(x => x.DbMeetingDetail).Include(x => x.DbHabitDetail)
            .Include(x => x.DbMediaDetail).Include(x => x.DbHealthDetail).Include(x => x.DbSportsDetail)
            .Include(x => x.Todos).Include(x => x.Notes).Include(x => x.Meals).Where(x => x.UserId == 1 && x.Date >= start && x.Date <= end)
            .OrderBy(x => x.Date).ThenBy(x => x.SortOrder).ToListAsync();

        var teams = await db.Teams.Where(x => x.UserId == 1).ToListAsync();
        allTeams = teams.ToDictionary(x => x.Id, x => x);
        
        AllDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1)) AllDays.Add(dt);

        CalendarGrid.Clear();
        int offset = ((int)start.DayOfWeek + 6) % 7; 
        for (int i = 0; i < offset; i++) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true, DayOfWeek = (i + 1) });
        for (int d = 1; d <= DateTime.DaysInMonth(Year, Month); d++) {
            var date = new DateTime(Year, Month, d);
            int dw = (int)date.DayOfWeek;
            CalendarGrid.Add(new CalendarSlot { Date = date, DayOfWeek = dw == 0 ? 7 : dw });
        }
        while (CalendarGrid.Count % 7 != 0) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true });
        isLoading = false;
    }

    private List<BulletItem> GetItemsForDay(DateTime d) => monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetCompactText(BulletItem t) {
        if (t.Type == "meeting" && t.DbMeetingDetail?.StartTime != null) return $"{t.DbMeetingDetail.StartTime.Value:h:mm} {t.Title}";
        if (t.Type == "sports" && t.DbSportsDetail != null && t.DbSportsDetail.IsComplete) return $"{t.Title} ({GetScoreStatus(t)})";
        return t.Title;
    }

    private string GetScoreStatus(BulletItem t) {
        if (t.DbSportsDetail == null || !t.DbSportsDetail.IsComplete) return "";
        allTeams.TryGetValue(t.DbSportsDetail.HomeTeamId, out var homeTeam);
        allTeams.TryGetValue(t.DbSportsDetail.AwayTeamId, out var awayTeam);
        bool homeIsFav = homeTeam?.IsFavorite ?? false;
        bool awayIsFav = awayTeam?.IsFavorite ?? false;
        if (homeIsFav) {
            if (t.DbSportsDetail.HomeScore > t.DbSportsDetail.AwayScore) return "WIN";
            if (t.DbSportsDetail.AwayScore > t.DbSportsDetail.HomeScore) return "LOSS";
        } 
        else if (awayIsFav) {
            if (t.DbSportsDetail.AwayScore > t.DbSportsDetail.HomeScore) return "WIN";
            if (t.DbSportsDetail.HomeScore > t.DbSportsDetail.AwayScore) return "LOSS";
        }
        return "TIE";
    }

    private string GetSideClass() { localPageCounter++; return localPageCounter % 2 == 0 ? "page-left" : "page-right"; }
    private string GetIcon(BulletItem item) => item.Type switch { "habit" => "ðŸ”¥", "meeting" => "â°", "health" => "ðŸ’ª", "media" => "ðŸŽ¬", "sports" => "ðŸ†", _ => "â€¢" };

    private RenderFragment RenderFooter() => builder => {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "page-footer text-[10px] font-black text-gray-200 uppercase tracking-[0.5em] flex justify-center mt-auto pb-4");
        builder.AddContent(2, "Page " + (StartPageNumber + localPageCounter));
        builder.CloseElement();
    };
}