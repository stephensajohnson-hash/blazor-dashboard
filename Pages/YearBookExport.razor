@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject AppDbContext Db
@inject BulletTaskService TaskService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Year Book Export | Stephens' Dashboard</PageTitle>

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="p-20 text-center text-2xl font-black italic text-gray-400">Preparing Chapter: @CurrentMonthName...</div>
    }
    else
    {
        @* --- 1. MONTHLY OVERVIEW SPREAD (Fixed Grid Logic) --- *@
        <div class="print-page page-left">
            <div class="flex h-full">
                <div class="month-vertical-label">@CurrentMonthName.ToUpper()</div>
                <div class="flex-1 grid grid-cols-3 gap-2 p-6 border-l border-gray-100">
                    @for (int dayOfWeek = 1; dayOfWeek <= 3; dayOfWeek++) @* Mon, Tue, Wed *@
                    {
                        <div class="flex flex-col gap-2">
                            @foreach (var slot in GetCalendarSlots(dayOfWeek))
                            {
                                <div class="border border-gray-300 rounded p-2 min-h-[120px] bg-gray-50/30 @(slot.IsEmpty ? "opacity-0" : "")">
                                    @if (!slot.IsEmpty)
                                    {
                                        <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@slot.Date.ToString("ddd d")</span>
                                        <div class="space-y-1">
                                            @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                            {
                                                <div class="text-[8px] leading-tight truncate flex items-center gap-1">
                                                    @GetIcon(item) <span>@item.Title</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(GetImageForDay(slot.Date)))
                                            {
                                                <img src="@GetImageForDay(slot.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-200" />
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="flex-1 grid grid-cols-4 gap-2 p-6 pb-2">
                    @for (int dayOfWeek = 4; dayOfWeek <= 7; dayOfWeek++) @* Thu, Fri, Sat, Sun *@
                    {
                        <div class="flex flex-col gap-2">
                            @foreach (var slot in GetCalendarSlots(dayOfWeek))
                            {
                                <div class="border border-gray-300 rounded p-2 min-h-[120px] bg-gray-50/30 @(slot.IsEmpty ? "opacity-0" : "")">
                                    @if (!slot.IsEmpty)
                                    {
                                        <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@slot.Date.ToString("ddd d")</span>
                                        <div class="space-y-1">
                                            @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                            {
                                                <div class="text-[8px] leading-tight truncate flex items-center gap-1">
                                                    @GetIcon(item) <span>@item.Title</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(GetImageForDay(slot.Date)))
                                            {
                                                <img src="@GetImageForDay(slot.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-200" />
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="h-24 border-t border-dashed border-gray-300 m-6 mt-0 p-4 rounded-lg bg-gray-50">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Monthly Goals & Focus</div>
                </div>
            </div>
        </div>

        @* --- 2. DAILY DETAIL PAGES (Elastic Layout) --- *@
        @foreach (var dayDate in AllDays)
        {
            var items = GetItemsForDay(dayDate);
            <div class="print-page daily-detail @(GetSideClass())">
                <div class="p-10 relative flex flex-col h-full">
                    <div class="flex justify-between items-end mb-6 border-b-4 border-black pb-2">
                        <h3 class="text-3xl font-black tracking-tighter uppercase">@dayDate.ToString("dddd")</h3>
                        <div class="text-right">
                            <div class="text-xl font-black">@dayDate.ToString("MMMM d")</div>
                            <div class="text-[10px] font-bold text-gray-400 tracking-[0.2em]">YEAR @Year</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-10">
                        <div class="col-span-8 space-y-8">
                            @foreach (var t in items)
                            {
                                <div class="item-entry">
                                    <div class="flex items-start gap-3">
                                        <div class="text-lg mt-0.5">@GetIcon(t)</div>
                                        <div class="flex-1">
                                            <div class="text-sm font-black uppercase tracking-tight">@t.Title</div>
                                            
                                            @if (!string.IsNullOrEmpty(t.Description))
                                            {
                                                <div class="text-[11px] text-gray-600 mt-1 leading-relaxed border-l-2 border-gray-100 pl-3 italic">
                                                    @t.Description
                                                </div>
                                            }
                                            
                                            @if (t.Todos != null && t.Todos.Any())
                                            {
                                                <div class="mt-2 space-y-1 ml-1">
                                                    @foreach (var todo in t.Todos)
                                                    {
                                                        <div class="text-[10px] flex items-center gap-2">
                                                            <div class="w-2.5 h-2.5 border border-black rounded-sm shrink-0 @(todo.IsCompleted ? "bg-black" : "")"></div>
                                                            <span class="@(todo.IsCompleted ? "line-through text-gray-400" : "")">@todo.Content</span>
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            @if (t.Notes != null && t.Notes.Any())
                                            {
                                                <div class="mt-3 space-y-2">
                                                    @foreach(var note in t.Notes)
                                                    {
                                                        <div class="p-2 bg-yellow-50/50 rounded text-[10px] text-gray-700 border-l-2 border-yellow-200">
                                                            @note.Content
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="col-span-4 flex flex-col gap-6">
                            @foreach(var imgItem in items.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                            {
                                <div class="rounded-lg overflow-hidden border border-gray-200 shadow-sm">
                                    <img src="@imgItem.ImgUrl" class="w-full h-auto" />
                                    @if(!string.IsNullOrEmpty(imgItem.Title)) {
                                        <div class="bg-gray-50 p-1 text-[8px] text-center border-t border-gray-200">@imgItem.Title</div>
                                    }
                                </div>
                            }

                            @{ var health = items.FirstOrDefault(x => x.Type == "health"); }
                            @if (health != null)
                            {
                                <div class="bg-gray-900 text-white p-4 rounded-xl shadow-lg">
                                    <div class="text-[9px] uppercase font-black text-emerald-400 mb-2 tracking-widest border-b border-emerald-900 pb-1">Health & Nutrition</div>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-[10px] opacity-70">Weight:</span>
                                            <span class="text-sm font-black">@(health.DbHealthDetail?.WeightLbs ?? 0) lbs</span>
                                        </div>
                                        
                                        @if(health.Meals != null && health.Meals.Any()) {
                                            <div class="space-y-2 mt-2">
                                                @foreach(var meal in health.Meals) {
                                                    <div class="text-[9px] leading-tight">
                                                        <div class="font-bold text-emerald-300">@meal.MealType: @meal.Name</div>
                                                        <div class="opacity-60">@meal.Calories cal | P: @meal.Protein | C: @meal.Carbs | F: @meal.Fat</div>
                                                    </div>
                                                }
                                            </div>
                                        }

                                        @if(health.Workouts != null && health.Workouts.Any()) {
                                            <div class="space-y-2 mt-2 pt-2 border-t border-gray-800">
                                                @foreach(var workout in health.Workouts) {
                                                    <div class="text-[9px] leading-tight">
                                                        <div class="font-bold text-blue-300">@workout.Name</div>
                                                        <div class="opacity-60">@workout.CaloriesBurned kcal | @workout.TimeSpentMinutes mins</div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .print-page { width: 8.5in; min-height: 11in; position: relative; page-break-after: always; background: white; overflow: hidden; }
    .daily-detail { height: auto; min-height: 11in; overflow: visible; }
    .page-left { padding-right: 0.8in; padding-left: 0.4in; }
    .page-right { padding-left: 0.8in; padding-right: 0.4in; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; color: #f3f4f6; display: flex; align-items: center; padding-top: 2rem; line-height: 1; }
    @@media screen { .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); height: 11in; overflow-y: auto; } }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }

    private bool isLoading = true;
    private List<BulletItem> monthItems = new();
    private List<DateTime> AllDays = new();
    private string CurrentMonthName => new DateTime(Year > 0 ? Year : 2026, Month > 0 ? Month : 1, 1).ToString("MMMM");
    private int pageCounter = 0;

    protected override async Task OnParametersSetAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);

        // Map directly to your BulletItem entities with full includes
        monthItems = await Db.BulletItems
            .Include(x => x.DbTaskDetail)
            .Include(x => x.DbHabitDetail)
            .Include(x => x.DbHealthDetail)
            .Include(x => x.Todos)
            .Include(x => x.Notes)
            .Include(x => x.Meals)
            .Include(x => x.Workouts)
            .Where(x => x.UserId == 1 && x.Date >= start && x.Date <= end)
            .OrderBy(x => x.Date).ThenBy(x => x.SortOrder)
            .ToListAsync();
        
        AllDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1)) { AllDays.Add(dt); }
        isLoading = false;
    }

    private IEnumerable<(DateTime Date, bool IsEmpty)> GetCalendarSlots(int targetDayOfWeek)
    {
        var firstOfMonth = new DateTime(Year, Month, 1);
        // Map DayOfWeek (Sun=0...Sat=6) to Mon=1...Sun=7
        int startOffset = ((int)firstOfMonth.DayOfWeek + 6) % 7 + 1; 

        for (int week = 0; week < 6; week++)
        {
            int dayNumber = (week * 7) + targetDayOfWeek - startOffset + 1;
            if (dayNumber >= 1 && dayNumber <= DateTime.DaysInMonth(Year, Month))
            {
                yield return (new DateTime(Year, Month, dayNumber), false);
            }
            else
            {
                yield return (DateTime.MinValue, true);
            }
        }
    }

    private string GetImageForDay(DateTime d) => 
        monthItems.FirstOrDefault(x => x.Date.Date == d.Date && !string.IsNullOrEmpty(x.ImgUrl))?.ImgUrl ?? "";

    private List<BulletItem> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass() { pageCounter++; return pageCounter % 2 == 0 ? "page-left" : "page-right"; }

    private string GetIcon(BulletItem item) => item.Type switch {
        "habit" => "ðŸ”¥", "meeting" => "â°", "health" => "ðŸ’ª", "media" => "ðŸŽ¬", "birthday" => "ðŸŽ‚", "vacation" => "âœˆï¸", _ => "â€¢"
    };

    private bool IsDone(BulletItem t) => 
        (t.DbTaskDetail?.IsCompleted ?? false) || (t.DbHabitDetail?.IsCompleted ?? false) || (t.DbMeetingDetail?.IsCompleted ?? false);
}