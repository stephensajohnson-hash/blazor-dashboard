@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="print-page flex items-center justify-center text-gray-400 italic font-black uppercase tracking-widest text-lg">
            Compiling Archive...
        </div>
    }
    else
    {
        @* --- 1. TITLE PAGE (ONLY FOR JANUARY, BECOMES PAGE 1) --- *@
        @if (Month == 1)
        {
            localPageCounter++; 
            <div class="print-page @(GetSideClass())">
                <div class="flex flex-1 flex-col items-center justify-center border-4 border-black m-8">
                    <h1 class="text-[50pt] font-black text-center leading-none uppercase tracking-tighter">
                        Stephens' <br />
                        Bullet Calendar <br />
                        <span class="text-gray-300">@Year</span>
                    </h1>
                    <div class="mt-12 w-24 border-b-8 border-black"></div>
                </div>
                @RenderFooter()
            </div>
        }

        @* --- 2. MONTHLY OVERVIEW SPREAD --- *@
        @{ localPageCounter++; }
        <div class="print-page @(GetSideClass())">
            <div class="flex h-full flex-col">
                <div class="header-bar flex justify-between items-center border-b-4 border-black pb-2 mb-4">
                    <span class="text-4xl font-black uppercase tracking-tighter">@Year</span>
                    <span class="text-[12pt] font-bold text-gray-400 uppercase tracking-[0.3em]">Monthly Overview</span>
                </div>
                <div class="flex flex-1">
                    <div class="month-vertical-label text-gray-900">@CurrentMonthName.ToUpper()</div>
                    <div class="flex-1 grid grid-cols-3 gap-1 p-2 border-l-2 border-gray-200">
                        @foreach (var slot in CalendarGrid.Where(x => x.DayOfWeek >= 1 && x.DayOfWeek <= 3))
                        {
                            <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(slot.IsPlaceholder ? "invisible" : "")">
                                @if (!slot.IsPlaceholder)
                                {
                                    <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                        <span class="text-[16pt] font-black text-black leading-none">@slot.Date.Day</span>
                                        <span class="text-[9pt] font-bold text-gray-400 uppercase">@slot.Date.ToString("dddd")</span>
                                    </div>
                                    <div class="space-y-1">
                                        @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                        {
                                            <div class="text-[10pt] leading-tight truncate flex items-center gap-1 text-black font-semibold">
                                                @GetIcon(item) <span>@(string.IsNullOrEmpty(item.Title) ? item.Type : item.Title)</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                @RenderFooter()
            </div>
        </div>

        @{ localPageCounter++; }
        <div class="print-page @(GetSideClass())">
            <div class="flex flex-col h-full">
                <div class="header-bar flex justify-between items-center border-b-4 border-black pb-2 mb-4">
                    <span class="text-[12pt] font-bold text-gray-400 uppercase tracking-[0.3em]">Monthly Overview</span>
                    <span class="text-4xl font-black uppercase tracking-tighter">@Year</span>
                </div>
                <div class="flex-1 grid grid-cols-4 gap-1 p-2">
                    @foreach (var day in CalendarGrid.Where(x => x.DayOfWeek == 0 || x.DayOfWeek >= 4))
                    {
                        <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(day.IsPlaceholder ? "invisible" : "")">
                            @if (!day.IsPlaceholder)
                            {
                                <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                    <span class="text-[16pt] font-black text-black leading-none">@day.Date.Day</span>
                                    <span class="text-[9pt] font-bold text-gray-400 uppercase">@day.Date.ToString("dddd")</span>
                                </div>
                                <div class="space-y-1">
                                    @foreach (var item in GetItemsForDay(day.Date).Take(6))
                                    {
                                        <div class="text-[10pt] leading-tight truncate flex items-center gap-1 text-black font-semibold">
                                            @GetIcon(item) <span>@(string.IsNullOrEmpty(item.Title) ? item.Type : item.Title)</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                @RenderFooter()
            </div>
        </div>

        @* --- 3. DAILY DETAIL PAGES --- *@
        @foreach (var dayDate in AllDays)
        {
            var items = GetItemsForDay(dayDate).ToList();
            localPageCounter++; 
            <div class="print-page @(GetSideClass())">
                <div class="flex-1">
                    <div class="day-header-line border-b-8 border-black mb-8 mt-4 flex justify-between items-baseline pb-2 w-full uppercase">
                        <span class="text-[28pt] font-black text-gray-400">@dayDate.ToString("dddd")</span>
                        <span class="text-[28pt] font-black text-black">@dayDate.ToString("MMMM ") @GetDayWithSuffix(dayDate.Day)</span>
                        <span class="text-[28pt] font-black text-gray-400">@dayDate.Year</span>
                    </div>

                    @if (items.Any())
                    {
                        <div class="grid grid-cols-3 gap-6 items-start">
                            @foreach (var t in items)
                            {
                                <div class="archive-card border-2 border-gray-100 rounded-2xl shadow-sm bg-white relative break-inside-avoid h-fit overflow-hidden p-3">
                                    @if (t.Type == "sports" && t.DbSportsDetail?.IsComplete == true)
                                    {
                                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.08] z-0">
                                            <span class="text-[44pt] font-black -rotate-12 border-8 border-black px-4">@GetScoreStatus(t)</span>
                                        </div>
                                    }

                                    @if (t.Type == "task" || t.Type == "meeting")
                                    {
                                        <div class="flex items-start gap-3 mb-2 border-b-2 border-gray-50 pb-2">
                                            @if (!string.IsNullOrEmpty(t.ImgUrl))
                                            {
                                                <div class="rounded-lg border border-gray-100 overflow-hidden bg-gray-50 shrink-0" style="width: 25%">
                                                    <img src="@t.ImgUrl" class="w-full h-auto block" />
                                                </div>
                                            }
                                            <h4 class="text-[12pt] font-bold leading-tight text-black break-words">@(string.IsNullOrEmpty(t.Title) ? "Untitled " + t.Type : t.Title)</h4>
                                        </div>
                                    }
                                    else
                                    {
                                        @if (!string.IsNullOrEmpty(t.ImgUrl))
                                        {
                                            <div class="float-left w-[25%] mr-3 mb-2 rounded-lg border-2 border-gray-50 overflow-hidden bg-gray-50 shadow-inner">
                                                <img src="@t.ImgUrl" class="w-full h-auto block" />
                                            </div>
                                        }
                                        <h4 class="text-[12pt] font-bold leading-tight text-black break-words mb-1">
                                            @(t.Type == "health" ? "üí™ " : "")@(string.IsNullOrEmpty(t.Title) ? t.Type.ToUpper() : t.Title)
                                        </h4>
                                    }

                                    <div class="z-10 relative">
                                        @if (!string.IsNullOrWhiteSpace(t.Description))
                                        {
                                            <div class="text-[11pt] text-gray-500 italic truncate mb-2">@t.Description</div>
                                        }

                                        <div class="space-y-3 clear-none">
                                            @if (t.Type == "birthday" && t.DbBirthdayDetail != null)
                                            {
                                                <div class="text-[12pt] font-bold text-pink-600 uppercase">
                                                    üéÇ @(t.DbBirthdayDetail.DOB_Year.HasValue ? $"Turning {Year - t.DbBirthdayDetail.DOB_Year.Value}" : "Birthday")
                                                </div>
                                            }

                                            @if (t.Type == "anniversary" && t.DbAnniversaryDetail != null)
                                            {
                                                <div class="text-[12pt] font-bold text-purple-600 uppercase">
                                                    üíç @(t.DbAnniversaryDetail.FirstYear.HasValue ? $"{Year - t.DbAnniversaryDetail.FirstYear.Value} Years" : t.DbAnniversaryDetail.AnniversaryType)
                                                </div>
                                            }

                                            @if (t.Type == "health" && t.DbHealthDetail != null)
                                            {
                                                <div class="text-[12pt] leading-tight border-l-4 border-emerald-400 pl-2 py-1">
                                                    <div class="font-bold text-black uppercase">Weight: @t.DbHealthDetail.WeightLbs LBS</div>
                                                    <div class="text-emerald-700 font-bold text-[11pt] mt-1">Calories: @(t.Meals?.Sum(m => m.Calories) ?? 0)</div>
                                                    @if (t.Meals?.Any() == true)
                                                    {
                                                        <div class="mt-2 space-y-0.5">
                                                            @foreach(var meal in t.Meals)
                                                            {
                                                                <div class="text-[11pt] text-gray-500 truncate font-bold">‚Ä¢ @meal.Name (@meal.Calories)</div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            
                                            @if (t.Type == "sports" && t.DbSportsDetail != null)
                                            {
                                                <div class="flex flex-col items-center gap-1 py-2 border-y border-gray-50 font-bold">
                                                    <div class="flex items-center gap-4">
                                                        @if(allTeams.TryGetValue(t.DbSportsDetail.AwayTeamId, out var away)) { <img src="@away.LogoUrl" class="w-12 h-12 object-contain" /> }
                                                        <span class="text-[16pt] text-gray-300 mx-1">:</span>
                                                        @if(allTeams.TryGetValue(t.DbSportsDetail.HomeTeamId, out var home)) { <img src="@home.LogoUrl" class="w-12 h-12 object-contain" /> }
                                                    </div>
                                                    <div class="text-[18pt]">@t.DbSportsDetail.AwayScore - @t.DbSportsDetail.HomeScore</div>
                                                    @{
                                                        var favId = GetFavoriteTeamId(t);
                                                        if (favId > 0)
                                                        {
                                                            <div class="text-[10pt] text-blue-600 uppercase tracking-widest">Season: @GetSeasonRecord(favId, t.DbSportsDetail.LeagueId, t.Date, t.Id)</div>
                                                        }
                                                    }
                                                </div>
                                            }

                                            @if (t.Type == "media" && t.DbMediaDetail != null)
                                            {
                                                <div class="space-y-2">
                                                    <div class="flex items-center gap-2 font-bold">
                                                        <span class="text-[12pt] bg-black text-white px-2 py-0.5 rounded">@t.DbMediaDetail.ReleaseYear</span>
                                                        <span class="text-[12pt] text-yellow-600">@t.DbMediaDetail.Rating‚òÖ</span>
                                                    </div>
                                                </div>
                                            }

                                            @if (t.Type == "habit" && t.DbHabitDetail != null)
                                            {
                                                <div class="flex justify-between items-center bg-orange-50/50 p-2 rounded border border-orange-100">
                                                    <span class="text-[12pt] font-bold text-orange-700 uppercase">üî• Streak</span>
                                                    <span class="text-[14pt] font-black text-orange-600">@t.DbHabitDetail.StreakCount</span>
                                                </div>
                                            }

                                            @if (t.Type == "meeting" && t.DbMeetingDetail != null)
                                            {
                                                <div class="bg-blue-50/50 p-2 rounded-lg border border-blue-100 flex justify-between items-center font-bold">
                                                    @if(t.DbMeetingDetail.StartTime.HasValue) { <span class="text-[12pt] text-blue-700">‚è∞ @t.DbMeetingDetail.StartTime.Value.ToString("h:mm tt")</span> }
                                                    @if(t.DbMeetingDetail.ActualDurationMinutes > 0) { <span class="text-[11pt] text-blue-900/40">‚è± @t.DbMeetingDetail.ActualDurationMinutes mins</span> }
                                                </div>
                                            }

                                            @if (t.Todos?.Any() == true)
                                            {
                                                <div class="mt-2 space-y-1 border-t border-gray-50 pt-2 font-bold">
                                                    @foreach (var todo in t.Todos.Take(3))
                                                    {
                                                        <div class="text-[12pt] flex items-center gap-2 truncate text-gray-600">
                                                            <div class="w-3 h-3 border-2 border-black @(todo.IsCompleted ? "bg-black" : "") shrink-0"></div>
                                                            <span class="truncate">@todo.Content</span>
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            @if (t.Notes?.Any() == true)
                                            {
                                                <div class="mt-2 space-y-1 border-t border-gray-50 pt-2">
                                                    @foreach(var note in t.Notes.OrderBy(n => n.Order))
                                                    {
                                                        <div class="text-[12pt] text-gray-600 truncate font-bold">‚Äî @note.Content</div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="clear-both"></div>
                                </div>
                            }
                        </div>
                    }
                </div>
                @RenderFooter()
            </div>
        }
    }
</div>

<style>
    @@media print {
        body { margin: 0; padding: 0; background: white; }
        @@page { size: 8.5in 11in; margin: 0; }
    }
    .print-page { 
        width: 8.5in; height: 11in; position: relative; background: white; 
        page-break-after: always; display: flex; flex-direction: column; overflow: hidden; 
    }
    .page-left { padding: 0.5in 0.6in 0.5in 0.4in; }
    .page-right { padding: 0.5in 0.4in 0.5in 0.6in; }

    .page-left .page-footer { justify-content: flex-start; padding-left: 0.25in; }
    .page-right .page-footer { justify-content: flex-end; padding-right: 0.25in; }

    .grid-cols-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .archive-card { height: fit-content; min-height: 120px; page-break-inside: avoid; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; line-height: 1; }
    @@media screen { .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); } }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }
    [Parameter] public int StartPageNumber { get; set; }

    private bool isLoading = true;
    private List<BulletItem> monthItems = new();
    private List<BulletGameDetail> seasonGames = new();
    private Dictionary<int, Team> allTeams = new();
    private List<DateTime> AllDays = new();
    private List<CalendarSlot> CalendarGrid = new();
    private string CurrentMonthName => new DateTime(Year > 0 ? Year : 2026, Month > 0 ? Month : 1, 1).ToString("MMMM");
    private int localPageCounter = 0;

    public class CalendarSlot { public DateTime Date { get; set; } public bool IsPlaceholder { get; set; } public int DayOfWeek { get; set; } }

    protected override async Task OnParametersSetAsync() { await LoadMonthData(); }

    private async Task LoadMonthData()
    {
        isLoading = true;
        try {
            var start = new DateTime(Year, Month, 1);
            var end = start.AddMonths(1).AddDays(-1);
            using var db = await DbFactory.CreateDbContextAsync();
            
            monthItems = await db.BulletItems
                .Include(x => x.DbTaskDetail).Include(x => x.DbMeetingDetail).Include(x => x.DbHabitDetail)
                .Include(x => x.DbMediaDetail).Include(x => x.DbHealthDetail).Include(x => x.DbSportsDetail)
                .Include(x => x.DbBirthdayDetail).Include(x => x.DbAnniversaryDetail)
                .Include(x => x.Todos).Include(x => x.Notes).Include(x => x.Meals)
                .Where(x => x.UserId == 1 && x.Date >= start && x.Date <= end)
                .OrderBy(x => x.Date).ThenBy(x => x.SortOrder).ToListAsync();

            var teams = await db.Teams.Where(x => x.UserId == 1).ToListAsync();
            allTeams = teams.ToDictionary(x => x.Id, x => x);

            var seasonStart = new DateTime(Year - 1, 7, 1);
            seasonGames = await db.BulletGameDetails
                .Include(x => x.BulletItem)
                .Where(x => x.IsComplete && x.BulletItem.Date >= seasonStart && x.BulletItem.Date <= end)
                .ToListAsync();
            
            AllDays.Clear();
            for (var dt = start; dt <= end; dt = dt.AddDays(1)) AllDays.Add(dt);

            CalendarGrid.Clear();
            int offset = ((int)start.DayOfWeek + 6) % 7; 
            for (int i = 0; i < offset; i++) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true, DayOfWeek = (i + 1) });
            for (int d = 1; d <= DateTime.DaysInMonth(Year, Month); d++) {
                var date = new DateTime(Year, Month, d);
                int dw = (int)date.DayOfWeek;
                CalendarGrid.Add(new CalendarSlot { Date = date, DayOfWeek = dw == 0 ? 7 : dw });
            }
            while (CalendarGrid.Count % 7 != 0) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true });
        } catch (Exception ex) {
            Console.WriteLine($"LOAD_ERROR: {ex.Message}");
        } finally {
            isLoading = false;
        }
    }

    private string GetDayWithSuffix(int day)
    {
        return day switch
        {
            1 or 21 or 31 => day + "st",
            2 or 22 => day + "nd",
            3 or 23 => day + "rd",
            _ => day + "th"
        };
    }

    private List<BulletItem> GetItemsForDay(DateTime d) => monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private int GetFavoriteTeamId(BulletItem t) {
        if (t.DbSportsDetail == null) return 0;
        allTeams.TryGetValue(t.DbSportsDetail.HomeTeamId, out var home);
        if (home?.IsFavorite == true) return home.Id;
        allTeams.TryGetValue(t.DbSportsDetail.AwayTeamId, out var away);
        if (away?.IsFavorite == true) return away.Id;
        return 0;
    }

    private string GetSeasonRecord(int teamId, int leagueId, DateTime pointInTime, int itemId)
    {
        var games = seasonGames
            .Where(g => g.LeagueId == leagueId && (g.HomeTeamId == teamId || g.AwayTeamId == teamId))
            .Where(g => g.BulletItem.Date < pointInTime || (g.BulletItem.Date == pointInTime && g.BulletItemId <= itemId))
            .OrderBy(g => g.BulletItem.Date).ThenBy(g => g.BulletItemId)
            .ToList();

        int w = 0, l = 0, t = 0;
        foreach (var g in games) {
            bool isHome = g.HomeTeamId == teamId;
            int myScore = isHome ? g.HomeScore : g.AwayScore;
            int oppScore = isHome ? g.AwayScore : g.HomeScore;
            if (myScore > oppScore) w++; else if (myScore < oppScore) l++; else t++;
        }
        return t > 0 ? $"{w}-{l}-{t}" : $"{w}-{l}";
    }

    private string GetScoreStatus(BulletItem t) {
        if (t.DbSportsDetail == null || !t.DbSportsDetail.IsComplete) return "";
        int favId = GetFavoriteTeamId(t);
        if (favId == 0) return "FINAL";
        bool isHome = t.DbSportsDetail.HomeTeamId == favId;
        int myScore = isHome ? t.DbSportsDetail.HomeScore : t.DbSportsDetail.AwayScore;
        int oppScore = isHome ? t.DbSportsDetail.AwayScore : t.DbSportsDetail.HomeScore;
        if (myScore > oppScore) return "WIN";
        if (myScore < oppScore) return "LOSS";
        return "TIE";
    }

    @* GLOBAL PARITY FIX: Use the actual calculated page number to determine Left/Right side *@
    private string GetSideClass() 
    { 
        int globalPageNum = StartPageNumber + localPageCounter;
        return globalPageNum % 2 == 0 ? "page-left" : "page-right"; 
    }

    private string GetIcon(BulletItem item) => item.Type switch { "habit" => "üî•", "meeting" => "‚è∞", "health" => "üí™", "media" => "üé¨", "sports" => "üèÜ", "birthday" => "üéÇ", "anniversary" => "üíç", _ => "‚Ä¢" };

    private RenderFragment RenderFooter() => builder => {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "page-footer text-[14pt] font-black text-gray-200 uppercase tracking-[0.5em] flex items-center mt-auto pb-6");
        builder.AddContent(2, (StartPageNumber + localPageCounter).ToString());
        builder.CloseElement();
    };
}