@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject IDbContextFactory<AppDbContext> DbFactory

<div class="month-chapter">
    @if (isLoading)
    {
        <div class="print-page flex items-center justify-center text-gray-400 italic font-black">
            Preparing @CurrentMonthName...
        </div>
    }
    else
    {
        @* --- 1. MONTHLY OVERVIEW SPREAD (LEFT: MON-WED) --- *@
        <div class="print-page page-left">
            <div class="flex h-full flex-col">
                <div class="header-bar flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                    <span class="text-2xl font-black uppercase tracking-tighter">@CurrentMonthName</span>
                    <span class="text-xs font-bold text-gray-400">@Year OVERVIEW</span>
                </div>
                
                <div class="flex flex-1">
                    <div class="month-vertical-label text-gray-900">@CurrentMonthName.ToUpper()</div>
                    <div class="flex-1 grid grid-cols-3 gap-1 p-2 border-l border-gray-200">
                        @foreach (var slot in CalendarGrid.Where(x => x.DayOfWeek >= 1 && x.DayOfWeek <= 3))
                        {
                            <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(slot.IsPlaceholder ? "invisible" : "")">
                                @if (!slot.IsPlaceholder)
                                {
                                    <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                        <span class="text-[12px] font-black text-black">@slot.Date.Day</span>
                                        <span class="text-[7px] font-bold text-gray-400 uppercase">@slot.Date.ToString("dddd")</span>
                                    </div>
                                    <div class="space-y-1">
                                        @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                        {
                                            <div class="text-[7px] leading-tight truncate flex items-center gap-1 text-black">
                                                @GetIcon(item) <span>@GetCompactText(item)</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(GetImageForDay(slot.Date)))
                                        {
                                            <img src="@GetImageForDay(slot.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-100 shadow-sm" />
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                @RenderFooter()
            </div>
        </div>

        @* --- 2. MONTHLY OVERVIEW SPREAD (RIGHT: THU-SUN) --- *@
        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="header-bar flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                    <span class="text-xs font-bold text-gray-400">@Year OVERVIEW</span>
                    <span class="text-2xl font-black uppercase tracking-tighter">@CurrentMonthName</span>
                </div>

                <div class="flex-1 grid grid-cols-4 gap-1 p-2">
                    @foreach (var slot in CalendarGrid.Where(x => x.DayOfWeek == 0 || x.DayOfWeek >= 4))
                    {
                        <div class="border border-gray-300 rounded p-1.5 min-h-[140px] bg-white relative @(slot.IsPlaceholder ? "invisible" : "")">
                            @if (!slot.IsPlaceholder)
                            {
                                <div class="flex justify-between items-start border-b border-gray-100 mb-1 pb-1">
                                    <span class="text-[12px] font-black text-black">@slot.Date.Day</span>
                                    <span class="text-[7px] font-bold text-gray-400 uppercase">@slot.Date.ToString("dddd")</span>
                                </div>
                                <div class="space-y-1">
                                    @foreach (var item in GetItemsForDay(slot.Date).Take(6))
                                    {
                                        <div class="text-[7px] leading-tight truncate flex items-center gap-1 text-black">
                                            @GetIcon(item) <span>@GetCompactText(item)</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(GetImageForDay(slot.Date)))
                                    {
                                        <img src="@GetImageForDay(slot.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-100 shadow-sm" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="h-20 border-t border-dashed border-gray-300 mx-2 mt-2 p-2 bg-gray-50 rounded-b-lg">
                    <div class="text-[8px] font-black text-black uppercase tracking-widest">Monthly Goals & Focus</div>
                </div>
                @RenderFooter()
            </div>
        </div>

        @* --- 3. DAILY DETAIL PAGES (Alternating Gutter Margins) --- *@
        @foreach (var dayDate in AllDays)
        {
            var items = GetItemsForDay(dayDate);
            var sideClass = GetSideClass();
            <div class="print-page daily-detail @sideClass">
                <div class="p-8 relative flex flex-col h-full bg-white">
                    <div class="flex justify-between items-end mb-6 border-b-4 border-black pb-2">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">@CurrentMonthName @Year</span>
                            <h3 class="text-4xl font-black tracking-tighter uppercase leading-none text-black">@dayDate.ToString("dddd")</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-black leading-none text-gray-800">@dayDate.ToString("MMMM d")</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        @foreach (var t in items)
                        {
                            <div class="border border-gray-200 rounded-xl p-4 shadow-sm flex gap-4 items-start bg-white">
                                <div class="text-2xl pt-1">@GetIcon(t)</div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="text-sm font-black uppercase text-black">@t.Title</h4>
                                        @if(t.Type == "meeting" && t.DbMeetingDetail?.StartTime.HasValue == true) {
                                            <span class="text-[10px] font-black text-blue-600">@t.DbMeetingDetail.StartTime.Value.ToString("h:mm tt")</span>
                                        }
                                        @if(t.Type == "sports" && t.DbSportsDetail != null) {
                                            <span class="text-[10px] font-black bg-orange-100 text-orange-700 px-2 py-0.5 rounded">
                                                @t.DbSportsDetail.AwayScore - @t.DbSportsDetail.HomeScore
                                            </span>
                                        }
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(t.Description))
                                    {
                                        <p class="text-[10px] text-gray-500 italic mb-2">@t.Description</p>
                                    }

                                    <div class="grid grid-cols-2 gap-4">
                                        @if (t.Todos?.Any() == true)
                                        {
                                            <div class="space-y-1">
                                                @foreach (var todo in t.Todos)
                                                {
                                                    <div class="text-[9px] flex items-center gap-2">
                                                        <div class="w-2.5 h-2.5 border border-black rounded-sm @(todo.IsCompleted ? "bg-black" : "")"></div>
                                                        <span class="@(todo.IsCompleted ? "line-through text-gray-400" : "text-black")">@todo.Content</span>
                                                    </div>
                                                }
                                            </div>
                                        }

                                        @if (t.Type == "health")
                                        {
                                            <div class="bg-gray-50 p-2 rounded-lg border border-gray-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-[14px] font-black">@(t.DbHealthDetail?.WeightLbs ?? 0) lbs</span>
                                                    <span class="text-[9px] font-black text-emerald-600">Total: @(t.Meals?.Sum(x => x.Calories) ?? 0) cal</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(t.ImgUrl))
                                {
                                    <div class="w-20 h-20 rounded-lg overflow-hidden border border-gray-100 shrink-0">
                                        <img src="@t.ImgUrl" class="w-full h-full object-cover" />
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                @RenderFooter()
            </div>
        }
    }
</div>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }
    [Parameter] public int StartPageNumber { get; set; }

    private bool isLoading = true;
    private List<BulletItem> monthItems = new();
    private List<DateTime> AllDays = new();
    private List<CalendarSlot> CalendarGrid = new();
    private string CurrentMonthName => new DateTime(Year, Month, 1).ToString("MMMM");
    private int localPageCounter = 0;

    public class CalendarSlot {
        public DateTime Date { get; set; }
        public bool IsPlaceholder { get; set; }
        public int DayOfWeek { get; set; }
    }

    protected override async Task OnParametersSetAsync() { await LoadMonthData(); }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);
        using var db = await DbFactory.CreateDbContextAsync();
        monthItems = await db.BulletItems
            .Include(x => x.DbTaskDetail).Include(x => x.DbMeetingDetail)
            .Include(x => x.DbHabitDetail).Include(x => x.DbHealthDetail).Include(x => x.DbSportsDetail)
            .Include(x => x.Todos).Include(x => x.Notes).Include(x => x.Meals).Include(x => x.Workouts)
            .Where(x => x.UserId == 1 && x.Date >= start && x.Date <= end)
            .OrderBy(x => x.Date).ThenBy(x => x.SortOrder).ToListAsync();
        
        AllDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1)) { AllDays.Add(dt); }

        CalendarGrid.Clear();
        int offset = ((int)start.DayOfWeek + 6) % 7; 
        for (int i = 0; i < offset; i++) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true, DayOfWeek = (i + 1) });
        for (int d = 1; d <= DateTime.DaysInMonth(Year, Month); d++) {
            var date = new DateTime(Year, Month, d);
            int dw = (int)date.DayOfWeek;
            CalendarGrid.Add(new CalendarSlot { Date = date, DayOfWeek = dw == 0 ? 7 : dw });
        }
        while (CalendarGrid.Count % 7 != 0) CalendarGrid.Add(new CalendarSlot { IsPlaceholder = true });
        isLoading = false;
    }

    private string GetCompactText(BulletItem t) {
        if (t.Type == "meeting" && t.DbMeetingDetail?.StartTime.HasValue == true) return $"{t.DbMeetingDetail.StartTime.Value:h:mm} {t.Title}";
        if (t.Type == "sports" && t.DbSportsDetail != null) return $"{t.Title} ({t.DbSportsDetail.AwayScore}-{t.DbSportsDetail.HomeScore})";
        if (t.Type == "health") return $"{t.Title} ({t.Meals?.Sum(x => x.Calories) ?? 0} cal)";
        return t.Title;
    }

    private string GetImageForDay(DateTime d) => 
        monthItems.FirstOrDefault(x => x.Date.Date == d.Date && !string.IsNullOrEmpty(x.ImgUrl))?.ImgUrl ?? "";

    private List<BulletItem> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass() { localPageCounter++; return localPageCounter % 2 == 0 ? "page-left" : "page-right"; }

    private string GetIcon(BulletItem item) => item.Type switch {
        "habit" => "ðŸ”¥", "meeting" => "â°", "health" => "ðŸ’ª", "media" => "ðŸŽ¬", "sports" => "ðŸ€", _ => "â€¢"
    };

    private RenderFragment RenderFooter() => builder => {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "page-footer text-[10px] font-black text-gray-300 uppercase tracking-widest flex justify-between px-8 pb-4");
        builder.OpenElement(2, "span");
        builder.AddContent(3, $"Chapter: {CurrentMonthName}");
        builder.CloseElement();
        builder.OpenElement(4, "span");
        builder.AddContent(5, "Page " + (StartPageNumber + localPageCounter));
        builder.CloseElement();
        builder.CloseElement();
    };
}