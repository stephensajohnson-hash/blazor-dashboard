@page "/year-book-export"
@using Dashboard
@using Dashboard.Services
@using Dashboard.Components.Bullet
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Globalization

@layout EmptyLayout
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@inject AppDbContext Db
@inject BulletTaskService TaskService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Year Book Export | Stephens' Dashboard</PageTitle>

<div class="print-container bg-white text-black min-h-screen font-sans">
    @if (isLoading)
    {
        <div class="p-20 text-center text-2xl font-black italic text-gray-400">Preparing Chapter: @CurrentMonthName...</div>
    }
    else
    {
        @* --- MONTHLY OVERVIEW SPREAD (Fixed Grid Logic) --- *@
        <div class="print-page page-left">
            <div class="flex h-full">
                <div class="month-vertical-label">@CurrentMonthName.ToUpper()</div>
                <div class="flex-1 grid grid-cols-3 gap-2 p-6 border-l border-gray-100">
                    @* Monday, Tuesday, Wednesday slots *@
                    @for (int dayOfWeek = 1; dayOfWeek <= 3; dayOfWeek++)
                    {
                        <div class="flex flex-col gap-2">
                            @foreach (var day in GetCalendarSlots(dayOfWeek))
                            {
                                <div class="border border-gray-300 rounded p-2 min-h-[120px] bg-gray-50/30 @(day.IsEmpty ? "opacity-0" : "")">
                                    @if (!day.IsEmpty)
                                    {
                                        <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@day.Date.ToString("ddd d")</span>
                                        <div class="space-y-1">
                                            @foreach (var item in GetItemsForDay(day.Date).Take(6))
                                            {
                                                <div class="text-[8px] leading-tight truncate flex items-center gap-1">
                                                    @GetIcon(item) <span>@item.Title</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(GetImageForDay(day.Date)))
                                            {
                                                <img src="@GetImageForDay(day.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-200" />
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="print-page page-right">
            <div class="flex flex-col h-full">
                <div class="flex-1 grid grid-cols-4 gap-2 p-6 pb-2">
                    @* Thursday, Friday, Saturday, Sunday slots *@
                    @for (int dayOfWeek = 4; dayOfWeek <= 7; dayOfWeek++)
                    {
                        <div class="flex flex-col gap-2">
                            @foreach (var day in GetCalendarSlots(dayOfWeek))
                            {
                                <div class="border border-gray-300 rounded p-2 min-h-[120px] bg-gray-50/30 @(day.IsEmpty ? "opacity-0" : "")">
                                    @if (!day.IsEmpty)
                                    {
                                        <span class="text-[10px] font-black border-b border-gray-200 mb-1 pb-1 block">@day.Date.ToString("ddd d")</span>
                                        <div class="space-y-1">
                                            @foreach (var item in GetItemsForDay(day.Date).Take(6))
                                            {
                                                <div class="text-[8px] leading-tight truncate flex items-center gap-1">
                                                    @GetIcon(item) <span>@item.Title</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(GetImageForDay(day.Date)))
                                            {
                                                <img src="@GetImageForDay(day.Date)" class="mt-1 rounded w-full h-12 object-cover border border-gray-200" />
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="h-24 border-t border-dashed border-gray-300 m-6 mt-0 p-4 rounded-lg bg-gray-50">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Monthly Goals & Focus</div>
                </div>
            </div>
        </div>

        @* --- DAILY DETAIL VIEWS (Elastic Layout) --- *@
        @foreach (var dayDate in AllDays)
        {
            var items = GetItemsForDay(dayDate);
            <div class="print-page daily-detail @(GetSideClass())">
                <div class="p-10 relative h-full flex flex-col">
                    <div class="flex justify-between items-end mb-6 border-b-4 border-black pb-2">
                        <h3 class="text-3xl font-black tracking-tighter uppercase">@dayDate.ToString("dddd")</h3>
                        <div class="text-right">
                            <div class="text-xl font-black">@dayDate.ToString("MMMM d")</div>
                            <div class="text-[10px] font-bold text-gray-400 tracking-[0.2em]">YEAR @Year</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-10 flex-1">
                        <div class="col-span-8 space-y-6">
                            @foreach (var t in items)
                            {
                                <div class="item-entry">
                                    <div class="flex items-start gap-3">
                                        <div class="text-lg mt-0.5">@GetIcon(t)</div>
                                        <div class="flex-1">
                                            <div class="text-sm font-black uppercase tracking-tight">@t.Title</div>
                                            @if (!string.IsNullOrEmpty(t.Description))
                                            {
                                                <div class="text-[11px] text-gray-600 mt-1 leading-relaxed">@t.Description</div>
                                            }
                                            
                                            @if (t.Todos != null && t.Todos.Any())
                                            {
                                                <div class="mt-2 grid grid-cols-1 gap-1 border-l-2 border-gray-100 pl-4">
                                                    @foreach (var todo in t.Todos)
                                                    {
                                                        <div class="text-[10px] flex items-center gap-2">
                                                            <div class="w-2 h-2 border border-black rounded-sm @(todo.IsCompleted ? "bg-black" : "")"></div>
                                                            <span class="@(todo.IsCompleted ? "line-through text-gray-400" : "")">@todo.Content</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="col-span-4 flex flex-col gap-6">
                            @foreach(var img in items.Where(x => !string.IsNullOrEmpty(x.ImgUrl)))
                            {
                                <div class="rounded-lg overflow-hidden border border-gray-200 shadow-sm">
                                    <img src="@img.ImgUrl" class="w-full h-auto" />
                                </div>
                            }

                            @{ var health = items.FirstOrDefault(x => x.Type == "health"); }
                            @if (health != null)
                            {
                                <div class="bg-gray-900 text-white p-4 rounded-xl">
                                    <div class="text-[9px] uppercase font-black text-emerald-400 mb-2 tracking-widest">Health Snapshot</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-xs"><span>Weight:</span><b>@health.HealthDetail?.WeightLbs lbs</b></div>
                                        @if(health.Meals != null) {
                                            @foreach(var meal in health.Meals) {
                                                <div class="text-[9px] border-t border-gray-800 pt-1 mt-1 text-gray-400 italic">@meal.Description (@meal.Calories cal)</div>
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .print-page { width: 8.5in; min-height: 11in; position: relative; page-break-after: always; background: white; overflow: hidden; }
    /* Daily details can grow if content overflows */
    .daily-detail { height: auto; overflow: visible; }
    .page-left { padding-right: 0.8in; padding-left: 0.4in; }
    .page-right { padding-left: 0.8in; padding-right: 0.4in; }
    .month-vertical-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 5rem; font-weight: 900; color: #f3f4f6; display: flex; align-items: center; padding-top: 2rem; line-height: 1; }
    @@media screen { .print-page { border: 1px solid #ddd; margin: 40px auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); height: 11in; overflow-y: auto; } }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }

    private bool isLoading = true;
    private List<BulletTaskService.TaskDTO> monthItems = new();
    private List<DateTime> AllDays = new();
    private List<DateTime> LeftDays = new();
    private List<DateTime> RightDays = new();
    private string CurrentMonthName => new DateTime(Year, Month, 1).ToString("MMMM");
    private int pageCounter = 0;

    protected override async Task OnParametersSetAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        var start = new DateTime(Year, Month, 1);
        var end = start.AddMonths(1).AddDays(-1);
        monthItems = await TaskService.GetTasksForRange(1, start, end);
        
        AllDays.Clear();
        for (var dt = start; dt <= end; dt = dt.AddDays(1)) { AllDays.Add(dt); }
        isLoading = false;
    }

    private IEnumerable<(DateTime Date, bool IsEmpty)> GetCalendarSlots(int dayOfWeek)
    {
        var firstOfMonth = new DateTime(Year, Month, 1);
        // Normalize Monday=1 to Sunday=7
        int startOffset = ((int)firstOfMonth.DayOfWeek + 6) % 7 + 1; 

        for (int week = 0; week < 6; week++)
        {
            int dayNumber = (week * 7) + dayOfWeek - startOffset + 1;
            if (dayNumber >= 1 && dayNumber <= DateTime.DaysInMonth(Year, Month))
            {
                yield return (new DateTime(Year, Month, dayNumber), false);
            }
            else
            {
                yield return (DateTime.MinValue, true);
            }
        }
    }

    private string GetImageForDay(DateTime d) => 
        monthItems.FirstOrDefault(x => x.Date.Date == d.Date && !string.IsNullOrEmpty(x.ImgUrl))?.ImgUrl ?? "";

    private List<BulletTaskService.TaskDTO> GetItemsForDay(DateTime d) => 
        monthItems.Where(x => x.Date.Date == d.Date).OrderBy(x => x.SortOrder).ToList();

    private string GetSideClass() { pageCounter++; return pageCounter % 2 == 0 ? "page-left" : "page-right"; }

    private string GetIcon(BulletTaskService.TaskDTO item) => item.Type switch {
        "habit" => "ðŸ”¥", "meeting" => "â°", "health" => "ðŸ’ª", "media" => "ðŸŽ¬", _ => "â€¢"
    };

    private bool IsDone(BulletTaskService.TaskDTO t) => (t.Detail?.IsCompleted ?? false) || (t.HabitDetail?.IsCompleted ?? false);
}