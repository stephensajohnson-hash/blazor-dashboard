@page "/manage-sports"
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web 
@using Microsoft.AspNetCore.Components.Forms 
@using System.IO
@inject BulletSportsService SportsService
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white p-6">
    
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <span class="text-3xl">üèÜ</span>
            <h1 class="text-2xl font-bold text-white">Manage Sports</h1>
        </div>
        <a href="/bullet-calendar" class="text-sm text-gray-400 hover:text-white transition">‚Üê Back to Calendar</a>
    </div>

    @if (isLoading)
    {
        <div class="flex flex-col items-center justify-center h-64 space-y-4">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-400 animate-pulse">Loading your sports data...</p>
        </div>
    }
    else if (userId == 0)
    {
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <span class="text-4xl mb-2">üîí</span>
            <p>Please log in to manage your sports teams.</p>
        </div>
    }
    else
    {
        <div class="flex gap-2 overflow-x-auto pb-2 mb-6 border-b border-gray-800 scrollbar-hide">
            <button @onclick="() => SwitchMainTab(-1)" 
                    class="px-4 py-2 rounded-t-lg text-sm font-bold transition shrink-0 border-b-2 @(activeTeamId == -1 ? "border-orange-500 text-white bg-gray-800" : "border-transparent text-gray-400 hover:text-gray-200")">
                ‚öôÔ∏è Manage Data
            </button>

            @foreach (var team in favoriteTeams)
            {
                <button @onclick="() => SwitchMainTab(team.Id)" 
                        class="px-4 py-2 rounded-t-lg text-sm font-bold transition shrink-0 flex items-center gap-2 border-b-2 @(activeTeamId == team.Id ? "border-blue-500 text-white bg-gray-800" : "border-transparent text-gray-400 hover:text-gray-200")">
                    @if(!string.IsNullOrEmpty(team.LogoUrl)) { <img src="@team.LogoUrl" class="w-4 h-4 object-contain" /> }
                    else { <span>‚≠êÔ∏è</span> }
                    @team.Name
                </button>
            }
        </div>

        @if(activeTeamId == -1)
        {
            <div class="flex border-b border-gray-800 mb-6">
                <button @onclick='() => configTab = "leagues"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "leagues" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Leagues</button>
                <button @onclick='() => configTab = "seasons"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "seasons" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Seasons</button>
                <button @onclick='() => configTab = "teams"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "teams" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Teams</button>
            </div>

            @if(configTab == "leagues")
            {
                <div class="max-w-2xl">
                    <div class="flex justify-end mb-4"><button @onclick="OpenAddLeague" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add League</button></div>
                    <div class="grid gap-3">
                        @foreach (var l in leagues) {
                            <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-500 transition group shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xl shadow-inner overflow-hidden">
                                        @if(!string.IsNullOrEmpty(l.ImgUrl)) { <img src="@l.ImgUrl" class="w-full h-full object-cover" /> } else { <span>üèÖ</span> }
                                    </div>
                                    <span class="font-bold text-lg text-white">@l.Name</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @onclick="() => OpenEditLeague(l)" class="text-gray-400 hover:text-white p-2" title="Edit">‚úèÔ∏è</button>
                                    <button @onclick="() => DeleteLeague(l.Id)" class="text-gray-500 hover:text-red-500 p-2 font-bold text-lg" title="Delete">‚úï</button>
                                </div>
                            </div>
                        }
                        @if(!leagues.Any()) { <div class="text-gray-500 italic text-center p-4">No leagues found.</div> }
                    </div>
                </div>
            }

            @if(configTab == "seasons")
            {
                <div class="max-w-3xl">
                    <div class="flex justify-end mb-4"><button @onclick="OpenAddSeason" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add Season</button></div>
                    @foreach(var l in leagues) {
                        var leagueSeasons = seasons.Where(s => s.LeagueId == l.Id).OrderByDescending(s => s.Name).ToList();
                        <div class="bg-gray-800/50 border border-gray-700 rounded-xl mb-4 overflow-hidden">
                            <div class="bg-gray-900 p-3 border-b border-gray-700 flex items-center gap-2"><span class="text-xl">üèÖ</span><h3 class="font-bold text-gray-300">@l.Name</h3></div>
                            <div class="p-2 space-y-1">
                                @if(!leagueSeasons.Any()) { <div class="text-xs text-gray-600 italic p-2">No seasons yet.</div> }
                                @foreach(var s in leagueSeasons) {
                                    <div class="flex justify-between items-center bg-gray-800 p-2 px-4 rounded border border-gray-700/50 hover:border-gray-500 transition">
                                        <div class="flex items-center gap-3">
                                            @if(!string.IsNullOrEmpty(s.ImgUrl)) { <img src="@s.ImgUrl" class="w-6 h-6 object-cover rounded" /> }
                                            <span class="text-sm font-bold text-white">@s.Name</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @onclick="() => OpenEditSeason(s)" class="text-gray-400 hover:text-white text-xs p-1">‚úèÔ∏è</button>
                                            <button @onclick="() => DeleteSeason(s.Id)" class="text-gray-600 hover:text-red-500 text-sm font-bold px-1">‚úï</button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            @if(configTab == "teams")
            {
                <div class="max-w-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div class="w-1/2">
                            <select @bind="filterLeagueId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none shadow-sm">
                                @foreach (var l in leagues) { <option value="@l.Id">@l.Name</option> }
                            </select>
                        </div>
                        <button @onclick="OpenAddTeam" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add Team</button>
                    </div>
                    <div class="grid gap-2">
                        @{ var filteredTeams = teams.Where(t => t.LeagueId == filterLeagueId).OrderByDescending(t => t.IsFavorite).ThenBy(t => t.Name).ToList(); }
                        @if(!filteredTeams.Any()) { <div class="text-gray-500 italic p-4 text-center border border-gray-800 rounded-lg">No teams in this league.</div> }
                        @foreach(var t in filteredTeams) {
                            <div class="flex justify-between items-center bg-gray-800 p-2 px-3 rounded border @(t.IsFavorite ? "border-yellow-500/30 bg-yellow-900/10" : "border-gray-700") hover:border-gray-500 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 flex items-center justify-center bg-black/40 rounded p-1">
                                        @if(!string.IsNullOrEmpty(t.LogoUrl)) { <img src="@t.LogoUrl" class="w-full h-full object-contain" /> } else { <span class="text-xs">üõ°Ô∏è</span> }
                                    </div>
                                    <div class="font-bold text-sm text-white flex items-center gap-2">@t.Name <span class="text-gray-500 text-xs font-normal">(@t.Abbreviation)</span> @if(t.IsFavorite) { <span class="text-yellow-500 text-xs">‚≠ê</span> }</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button @onclick="() => OpenEditTeam(t)" class="text-gray-400 hover:text-white text-xs p-1">‚úèÔ∏è</button>
                                    <button @onclick="() => DeleteTeam(t.Id)" class="text-gray-600 hover:text-red-500 text-sm font-bold px-1">‚úï</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }

        @if(activeTeamId > 0)
        {
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-end mb-6">
                    <select value="@selectedSeasonId" @onchange="OnScheduleSeasonChanged" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-white font-bold focus:border-blue-500 outline-none shadow-lg">
                        @foreach(var s in teamSeasons) { <option value="@s.Id">@s.Name</option> }
                    </select>
                </div>

                @if(isScheduleLoading) { <div class="text-center text-gray-500 py-10 animate-pulse">Loading games...</div> }
                else if(!teamGames.Any()) { <div class="text-center text-gray-500 py-10 border border-gray-800 rounded bg-gray-800/20">No games found for this season.</div> }
                else 
                {
                    var nextGame = teamGames.FirstOrDefault(g => !g.Detail.IsComplete);
                    int nextGameId = nextGame?.Id ?? 0;

                    <div class="space-y-6">
                        @foreach(var g in teamGames)
                        {
                            bool isNext = g.Id == nextGameId;
                            <div class="relative">
                                <div class="text-xs font-bold text-gray-500 mb-1 ml-1 uppercase tracking-wide">@FormatDate(g.Date)</div>
                                <div class="rounded-xl transition duration-300 @(isNext ? "p-1 bg-yellow-500/80 shadow-[0_0_20px_rgba(234,179,8,0.3)]" : "border border-transparent")">
                                    <SportsCard Item="g" OnClick="OpenEditGame" />
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

@if (showConfigModal)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="CloseModal">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden" @onclick:stopPropagation="true">
            <div class="p-4 border-b border-gray-700 bg-gray-800/50"><h3 class="font-bold text-white">@modalTitle</h3></div>
            <div class="p-6 space-y-4">
                @if(modalType == "league") {
                    <input @bind="tempName" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="League Name" />
                    <input @bind="tempLinkUrl" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="Link URL (Optional)" />
                    <div><label class="text-xs text-gray-500">Image</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                }
                else if(modalType == "season") {
                    <select @bind="tempLeagueId" class="w-full bg-black border border-gray-600 rounded p-2 text-white"><option value="0">Select League...</option>@foreach(var l in leagues){<option value="@l.Id">@l.Name</option>}</select>
                    <input @bind="tempName" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="Season Name" />
                    <div><label class="text-xs text-gray-500">Image</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                }
                else if(modalType == "team") {
                    <select @bind="tempLeagueId" class="w-full bg-black border border-gray-600 rounded p-2 text-white"><option value="0">Select League...</option>@foreach(var l in leagues){<option value="@l.Id">@l.Name</option>}</select>
                    <div class="flex gap-2"><input @bind="tempName" class="flex-1 bg-black border border-gray-600 rounded p-2 text-white" placeholder="Team Name" /><input @bind="tempAbbr" class="w-20 bg-black border border-gray-600 rounded p-2 text-white text-center uppercase" placeholder="ABR" maxlength="3" /></div>
                    <div><label class="text-xs text-gray-500">Logo</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                    <div class="flex items-center gap-2"><input type="checkbox" @bind="tempIsFav" class="w-4 h-4" /> <label class="text-sm text-gray-300">Favorite?</label></div>
                }
                <div class="flex gap-2 pt-4"><button @onclick="CloseModal" class="flex-1 bg-gray-700 text-white py-2 rounded">Cancel</button><button @onclick="SaveConfigModal" class="flex-1 bg-blue-600 text-white py-2 rounded">Save</button></div>
            </div>
        </div>
    </div>
}

@if (editingGame != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="CloseGameEditor">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden" @onclick:stopPropagation="true">
            <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">Edit Game</h3><button @onclick="CloseGameEditor" class="text-gray-400 hover:text-white">‚úï</button></div>
            <div class="p-4">
                <Dashboard.Components.Bullet.Editors.EditorSports Detail="editingGame.Detail" />
                <div class="mt-4"><button @onclick="SaveGame" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold">Save Game</button></div>
            </div>
        </div>
    </div>
}

@code {
    private int userId = 0;
    private bool isLoading = true;
    
    private int activeTeamId = -1; // -1 = Config
    private string configTab = "leagues";
    private int filterLeagueId = 0;

    private bool isScheduleLoading = false;
    private int selectedSeasonId = 0;
    private List<BulletSportsService.GameDTO> teamGames = new();
    private List<Season> teamSeasons = new();

    private List<League> leagues = new();
    private List<Season> seasons = new();
    private List<Team> teams = new();
    private List<Team> favoriteTeams = new();

    private bool showConfigModal = false;
    private string modalTitle = "", modalType = "";
    private int editingId = 0;
    private string tempName = "", tempImgUrl = "", tempLinkUrl = "", tempAbbr = "";
    private int tempLeagueId = 0;
    private bool tempIsFav = false;
    
    private BulletSportsService.GameDTO? editingGame;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) { 
                    using(var doc = System.Text.Json.JsonDocument.Parse(json)) { 
                        if(doc.RootElement.TryGetProperty("UserId", out var p)) userId = p.GetInt32(); 
                    }
                }
                
                if(userId > 0) {
                    await LoadAllData();
                }
            } catch { 
                // Ignore parsing errors
            } finally {
                // <--- CRITICAL FIX: Always stop the spinner, even if no user found
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadAllData()
    {
        // Parallel Task Execution (Fixes N+1 Performance Issue)
        var t1 = SportsService.GetLeagues(userId);
        var t2 = SportsService.GetSeasons(userId);
        var t3 = SportsService.GetTeams(userId);
        var t4 = SportsService.GetFavoriteTeams(userId);

        await Task.WhenAll(t1, t2, t3, t4);

        leagues = t1.Result;
        seasons = t2.Result;
        teams = t3.Result;
        favoriteTeams = t4.Result;

        if(filterLeagueId == 0 && leagues.Any()) filterLeagueId = leagues.First().Id;
    }

    private async Task SwitchMainTab(int teamId)
    {
        activeTeamId = teamId;
        if(activeTeamId > 0)
        {
            isScheduleLoading = true;
            var team = favoriteTeams.FirstOrDefault(t => t.Id == teamId);
            if(team != null)
            {
                teamSeasons = seasons.Where(s => s.LeagueId == team.LeagueId).OrderByDescending(s => s.Name).ToList();
                selectedSeasonId = await SportsService.GetMostRecentActiveSeasonId(userId, team.Id);
                if(selectedSeasonId == 0 && teamSeasons.Any()) selectedSeasonId = teamSeasons.First().Id;
                await LoadSchedule();
            }
            isScheduleLoading = false;
        }
    }

    private async Task OnScheduleSeasonChanged(ChangeEventArgs e)
    {
        if(int.TryParse(e.Value?.ToString(), out int sid)) { selectedSeasonId = sid; await LoadSchedule(); }
    }

    private async Task LoadSchedule()
    {
        if(activeTeamId > 0 && selectedSeasonId > 0)
        {
            teamGames = await SportsService.GetTeamSchedule(userId, activeTeamId, selectedSeasonId);
        }
    }

    private void OpenEditGame(BulletTaskService.TaskDTO g) { editingGame = teamGames.FirstOrDefault(x => x.Id == g.Id); }
    private void CloseGameEditor() { editingGame = null