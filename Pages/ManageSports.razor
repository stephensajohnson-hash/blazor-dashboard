@page "/manage-sports"
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web 
@using Microsoft.AspNetCore.Components.Forms 
@using System.IO
@using System.Text.Json
@inject BulletSportsService SportsService
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white p-6">
    
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <span class="text-3xl">üèÜ</span>
            <h1 class="text-2xl font-bold text-white">Manage Sports</h1>
        </div>
        <a href="/bullet-calendar" class="text-sm text-gray-400 hover:text-white transition">‚Üê Back to Calendar</a>
    </div>

    @if (isLoading)
    {
        <div class="flex flex-col items-center justify-center h-64 space-y-4">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-400 animate-pulse">Loading your sports data...</p>
        </div>
    }
    else if (userId == 0)
    {
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <span class="text-4xl mb-2">üîí</span>
            <p class="text-xl font-bold text-white">Please Log In</p>
            <p class="mb-6">We could not find your user session.</p>
            <div class="bg-gray-800 p-4 rounded border border-gray-700 max-w-lg overflow-hidden">
                <p class="text-xs text-orange-400 font-bold mb-1">DEBUG INFO:</p>
                <code class="text-xs font-mono text-gray-300 break-all">Storage Value: @debugText</code>
            </div>
        </div>
    }
    else
    {
        <div class="flex gap-2 overflow-x-auto pb-2 mb-6 border-b border-gray-800 scrollbar-hide">
            <button @onclick="() => SwitchMainTab(-1)" 
                    class="px-4 py-2 rounded-t-lg text-sm font-bold transition shrink-0 border-b-2 @(activeTeamId == -1 ? "border-orange-500 text-white bg-gray-800" : "border-transparent text-gray-400 hover:text-gray-200")">
                ‚öôÔ∏è Manage Data
            </button>

            @foreach (var team in favoriteTeams)
            {
                <button @onclick="() => SwitchMainTab(team.Id)" 
                        class="px-4 py-2 rounded-t-lg text-sm font-bold transition shrink-0 flex items-center gap-2 border-b-2 @(activeTeamId == team.Id ? "border-blue-500 text-white bg-gray-800" : "border-transparent text-gray-400 hover:text-gray-200")">
                    @if(!string.IsNullOrEmpty(team.LogoUrl)) { <img src="@team.LogoUrl" class="w-4 h-4 object-contain" /> }
                    else { <span>‚≠êÔ∏è</span> }
                    @team.Name
                </button>
            }
        </div>

        @if(activeTeamId == -1)
        {
            <div class="flex border-b border-gray-800 mb-6">
                <button @onclick='() => configTab = "leagues"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "leagues" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Leagues</button>
                <button @onclick='() => configTab = "seasons"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "seasons" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Seasons</button>
                <button @onclick='() => configTab = "teams"' class="px-6 py-2 text-xs font-bold uppercase tracking-wider transition @(configTab == "teams" ? "text-orange-400 border-b-2 border-orange-400" : "text-gray-500 hover:text-gray-300")">Teams</button>
            </div>

            @if(configTab == "leagues")
            {
                <div class="max-w-2xl">
                    <div class="flex justify-end mb-4"><button @onclick="OpenAddLeague" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add League</button></div>
                    <div class="grid gap-3">
                        @foreach (var l in leagues) {
                            <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-500 transition group shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xl shadow-inner overflow-hidden">
                                        @if(!string.IsNullOrEmpty(l.ImgUrl)) { <img src="@l.ImgUrl" class="w-full h-full object-cover" /> } else { <span>üèÖ</span> }
                                    </div>
                                    <span class="font-bold text-lg text-white">@l.Name</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @onclick="() => OpenEditLeague(l)" class="text-gray-400 hover:text-white p-2" title="Edit">‚úèÔ∏è</button>
                                    <button @onclick="() => DeleteLeague(l.Id)" class="text-gray-500 hover:text-red-500 p-2 font-bold text-lg" title="Delete">‚úï</button>
                                </div>
                            </div>
                        }
                        @if(!leagues.Any()) { <div class="text-gray-500 italic text-center p-4">No leagues found.</div> }
                    </div>
                </div>
            }

            @if(configTab == "seasons")
            {
                <div class="max-w-3xl">
                    <div class="flex justify-end mb-4"><button @onclick="OpenAddSeason" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add Season</button></div>
                    @foreach(var l in leagues) {
                        var leagueSeasons = seasons.Where(s => s.LeagueId == l.Id).OrderByDescending(s => s.Name).ToList();
                        <div class="bg-gray-800/50 border border-gray-700 rounded-xl mb-4 overflow-hidden">
                            <div class="bg-gray-900 p-3 border-b border-gray-700 flex items-center gap-2"><span class="text-xl">üèÖ</span><h3 class="font-bold text-gray-300">@l.Name</h3></div>
                            <div class="p-2 space-y-1">
                                @if(!leagueSeasons.Any()) { <div class="text-xs text-gray-600 italic p-2">No seasons yet.</div> }
                                @foreach(var s in leagueSeasons) {
                                    <div class="flex justify-between items-center bg-gray-800 p-2 px-4 rounded border border-gray-700/50 hover:border-gray-500 transition">
                                        <div class="flex items-center gap-3">
                                            @if(!string.IsNullOrEmpty(s.ImgUrl)) { <img src="@s.ImgUrl" class="w-6 h-6 object-cover rounded" /> }
                                            <span class="text-sm font-bold text-white">@s.Name</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @onclick="() => OpenEditSeason(s)" class="text-gray-400 hover:text-white text-xs p-1">‚úèÔ∏è</button>
                                            <button @onclick="() => DeleteSeason(s.Id)" class="text-gray-600 hover:text-red-500 text-sm font-bold px-1">‚úï</button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            @if(configTab == "teams")
            {
                <div class="max-w-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div class="w-1/2">
                            <select @bind="filterLeagueId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none shadow-sm">
                                @foreach (var l in leagues) { <option value="@l.Id">@l.Name</option> }
                            </select>
                        </div>
                        <button @onclick="OpenAddTeam" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">+ Add Team</button>
                    </div>
                    <div class="grid gap-2">
                        @{ var filteredTeams = teams.Where(t => t.LeagueId == filterLeagueId).OrderByDescending(t => t.IsFavorite).ThenBy(t => t.Name).ToList(); }
                        @if(!filteredTeams.Any()) { <div class="text-gray-500 italic p-4 text-center border border-gray-800 rounded-lg">No teams in this league.</div> }
                        @foreach(var t in filteredTeams) {
                            <div class="flex justify-between items-center bg-gray-800 p-2 px-3 rounded border @(t.IsFavorite ? "border-yellow-500/30 bg-yellow-900/10" : "border-gray-700") hover:border-gray-500 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 flex items-center justify-center bg-black/40 rounded p-1">
                                        @if(!string.IsNullOrEmpty(t.LogoUrl)) { <img src="@t.LogoUrl" class="w-full h-full object-contain" /> } else { <span class="text-xs">üõ°Ô∏è</span> }
                                    </div>
                                    <div class="font-bold text-sm text-white flex items-center gap-2">@t.Name <span class="text-gray-500 text-xs font-normal">(@t.Abbreviation)</span> @if(t.IsFavorite) { <span class="text-yellow-500 text-xs">‚≠ê</span> }</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button @onclick="() => OpenEditTeam(t)" class="text-gray-400 hover:text-white text-xs p-1">‚úèÔ∏è</button>
                                    <button @onclick="() => DeleteTeam(t.Id)" class="text-gray-600 hover:text-red-500 text-sm font-bold px-1">‚úï</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }

        @if(activeTeamId > 0)
        {
            <div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-300">Season Schedule</h2>
                    <select value="@selectedSeasonId" @onchange="OnScheduleSeasonChanged" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-white font-bold focus:border-blue-500 outline-none shadow-lg">
                        @foreach(var s in teamSeasons) { <option value="@s.Id">@s.Name</option> }
                    </select>
                </div>

                @if(isScheduleLoading) { <div class="text-center text-gray-500 py-10 animate-pulse">Loading games...</div> }
                else if(!teamGames.Any()) { <div class="text-center text-gray-500 py-10 border border-gray-800 rounded bg-gray-800/20">No games found for this season.</div> }
                else 
                {
                    var nextGame = teamGames.FirstOrDefault(g => !g.Detail.IsComplete);
                    int nextGameId = nextGame?.Id ?? 0;

                    <div class="space-y-4">
                        @foreach(var g in teamGames)
                        {
                            bool isNext = g.Id == nextGameId;
                            bool isHome = g.Detail.HomeTeamId == activeTeamId;
                            bool isWin = false; bool isLoss = false;
                            
                            // Determine W/L for styling
                            if (g.Detail.IsComplete) {
                                if (isHome) { isWin = g.Detail.HomeScore > g.Detail.AwayScore; isLoss = g.Detail.HomeScore < g.Detail.AwayScore; }
                                else { isWin = g.Detail.AwayScore > g.Detail.HomeScore; isLoss = g.Detail.AwayScore < g.Detail.HomeScore; }
                            }

                            <div class="relative group" @onclick="() => OpenEditGame(g)">
                                <div class="bg-gray-800 rounded-xl overflow-hidden border transition duration-300 @(isNext ? "border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.2)]" : "border-gray-700 hover:border-gray-500")">
                                    
                                    <div class="bg-gray-900/50 p-2 px-4 flex justify-between items-center border-b border-gray-700/50">
                                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wide">@FormatDate(g.Date)</div>
                                        <div class="text-xs text-gray-500 font-mono">
                                            @if(g.Detail.IsComplete) { <span class="text-gray-400">FINAL</span> }
                                            else { <span>@g.Detail.StartTime.ToString("h:mm tt") @if(!string.IsNullOrEmpty(g.Detail.TvChannel)) { <span class="bg-gray-700 text-white px-1 rounded ml-1">@g.Detail.TvChannel</span> }</span> }
                                        </div>
                                    </div>

                                    <div class="p-4 flex items-center justify-between relative">
                                        
                                        @if(g.Detail.IsComplete)
                                        {
                                            <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                                                <span class="text-8xl font-black @(isWin ? "text-green-500" : isLoss ? "text-red-500" : "text-gray-500")">
                                                    @(isWin ? "W" : isLoss ? "L" : "T")
                                                </span>
                                            </div>
                                        }

                                        <div class="flex flex-col items-center w-1/3 z-10">
                                            <div class="w-12 h-12 mb-2 flex items-center justify-center">
                                                @if(g.AwayTeam != null && !string.IsNullOrEmpty(g.AwayTeam.LogoUrl)) { <img src="@g.AwayTeam.LogoUrl" class="w-full h-full object-contain drop-shadow-md" /> }
                                                else { <span class="text-2xl">üõ°Ô∏è</span> }
                                            </div>
                                            <div class="text-center leading-tight">
                                                <div class="font-bold text-white text-sm">@g.AwayTeam?.Name</div>
                                                @if(g.AwayTeam?.Id == activeTeamId && g.FavoriteRecord != null) { <div class="text-[10px] text-gray-500">(@g.FavoriteRecord.Display)</div> }
                                            </div>
                                        </div>

                                        <div class="flex flex-col items-center justify-center w-1/3 z-10">
                                            @if(g.Detail.IsComplete)
                                            {
                                                <div class="flex items-center gap-3 text-2xl font-black text-white">
                                                    <span class="@(g.Detail.AwayScore > g.Detail.HomeScore ? "text-white" : "text-gray-500")">@g.Detail.AwayScore</span>
                                                    <span class="text-xs text-gray-600 font-normal">-</span>
                                                    <span class="@(g.Detail.HomeScore > g.Detail.AwayScore ? "text-white" : "text-gray-500")">@g.Detail.HomeScore</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-xs font-bold text-gray-600 bg-gray-900 px-2 py-1 rounded-full">VS</div>
                                            }
                                        </div>

                                        <div class="flex flex-col items-center w-1/3 z-10">
                                            <div class="w-12 h-12 mb-2 flex items-center justify-center">
                                                @if(g.HomeTeam != null && !string.IsNullOrEmpty(g.HomeTeam.LogoUrl)) { <img src="@g.HomeTeam.LogoUrl" class="w-full h-full object-contain drop-shadow-md" /> }
                                                else { <span class="text-2xl">üõ°Ô∏è</span> }
                                            </div>
                                            <div class="text-center leading-tight">
                                                <div class="font-bold text-white text-sm">@g.HomeTeam?.Name</div>
                                                @if(g.HomeTeam?.Id == activeTeamId && g.FavoriteRecord != null) { <div class="text-[10px] text-gray-500">(@g.FavoriteRecord.Display)</div> }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

@if (showConfigModal)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="CloseModal">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden" @onclick:stopPropagation="true">
            <div class="p-4 border-b border-gray-700 bg-gray-800/50"><h3 class="font-bold text-white">@modalTitle</h3></div>
            <div class="p-6 space-y-4">
                @if(modalType == "league") {
                    <input @bind="tempName" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="League Name" />
                    <input @bind="tempLinkUrl" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="Link URL (Optional)" />
                    <div><label class="text-xs text-gray-500">Image</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                }
                else if(modalType == "season") {
                    <select @bind="tempLeagueId" class="w-full bg-black border border-gray-600 rounded p-2 text-white"><option value="0">Select League...</option>@foreach(var l in leagues){<option value="@l.Id">@l.Name</option>}</select>
                    <input @bind="tempName" class="w-full bg-black border border-gray-600 rounded p-2 text-white" placeholder="Season Name" />
                    <div><label class="text-xs text-gray-500">Image</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                }
                else if(modalType == "team") {
                    <select @bind="tempLeagueId" class="w-full bg-black border border-gray-600 rounded p-2 text-white"><option value="0">Select League...</option>@foreach(var l in leagues){<option value="@l.Id">@l.Name</option>}</select>
                    <div class="flex gap-2"><input @bind="tempName" class="flex-1 bg-black border border-gray-600 rounded p-2 text-white" placeholder="Team Name" /><input @bind="tempAbbr" class="w-20 bg-black border border-gray-600 rounded p-2 text-white text-center uppercase" placeholder="ABR" maxlength="3" /></div>
                    <div><label class="text-xs text-gray-500">Logo</label><InputFile OnChange="HandleFileSelected" class="text-xs text-gray-400" /></div>
                    <div class="flex items-center gap-2"><input type="checkbox" @bind="tempIsFav" class="w-4 h-4" /> <label class="text-sm text-gray-300">Favorite?</label></div>
                }
                <div class="flex gap-2 pt-4"><button @onclick="CloseModal" class="flex-1 bg-gray-700 text-white py-2 rounded">Cancel</button><button @onclick="SaveConfigModal" class="flex-1 bg-blue-600 text-white py-2 rounded">Save</button></div>
            </div>
        </div>
    </div>
}

@if (editingGame != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="CloseGameEditor">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden" @onclick:stopPropagation="true">
            <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">Edit Game</h3><button @onclick="CloseGameEditor" class="text-gray-400 hover:text-white">‚úï</button></div>
            <div class="p-4">
                <Dashboard.Components.Bullet.Editors.EditorSports Detail="editingGame.Detail" />
                <div class="mt-4"><button @onclick="SaveGame" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold">Save Game</button></div>
            </div>
        </div>
    </div>
}

@code {
    private int userId = 0;
    private bool isLoading = true;
    private string debugText = ""; 
    
    private int activeTeamId = -1; 
    private string configTab = "leagues";
    private int filterLeagueId = 0;

    private bool isScheduleLoading = false;
    private int selectedSeasonId = 0;
    private List<BulletSportsService.GameDTO> teamGames = new();
    private List<Season> teamSeasons = new();

    private List<League> leagues = new();
    private List<Season> seasons = new();
    private List<Team> teams = new();
    private List<Team> favoriteTeams = new();

    private bool showConfigModal = false;
    private string modalTitle = "", modalType = "";
    private int editingId = 0;
    private string tempName = "", tempImgUrl = "", tempLinkUrl = "", tempAbbr = "";
    private int tempLeagueId = 0;
    private bool tempIsFav = false;
    
    private BulletSportsService.GameDTO? editingGame;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                debugText = json ?? "NULL (No Session Found)"; 

                if (!string.IsNullOrEmpty(json)) { 
                    using(var doc = JsonDocument.Parse(json)) {
                        if(doc.RootElement.TryGetProperty("UserId", out var p) || 
                           doc.RootElement.TryGetProperty("userId", out p) ||
                           doc.RootElement.TryGetProperty("id", out p)) 
                        {
                            userId = p.GetInt32();
                        }
                    }
                }
                
                if(userId > 0) await LoadAllData();
            } catch (Exception ex) { 
                debugText += " | ERROR: " + ex.Message; 
            } finally {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadAllData()
    {
        leagues = await SportsService.GetLeagues(userId);
        seasons = await SportsService.GetSeasons(userId);
        teams = await SportsService.GetTeams(userId);
        favoriteTeams = await SportsService.GetFavoriteTeams(userId);

        if(filterLeagueId == 0 && leagues.Any()) filterLeagueId = leagues.First().Id;
    }

    private async Task SwitchMainTab(int teamId)
    {
        activeTeamId = teamId;
        if(activeTeamId > 0)
        {
            isScheduleLoading = true;
            var team = favoriteTeams.FirstOrDefault(t => t.Id == teamId);
            if(team != null)
            {
                teamSeasons = seasons.Where(s => s.LeagueId == team.LeagueId).OrderByDescending(s => s.Name).ToList();
                selectedSeasonId = await SportsService.GetMostRecentActiveSeasonId(userId, team.Id);
                if(selectedSeasonId == 0 && teamSeasons.Any()) selectedSeasonId = teamSeasons.First().Id;
                await LoadSchedule();
            }
            isScheduleLoading = false;
        }
    }

    private async Task OnScheduleSeasonChanged(ChangeEventArgs e)
    {
        if(int.TryParse(e.Value?.ToString(), out int sid)) { selectedSeasonId = sid; await LoadSchedule(); }
    }

    private async Task LoadSchedule()
    {
        if(activeTeamId > 0 && selectedSeasonId > 0)
        {
            // 1. Fetch Games
            teamGames = await SportsService.GetTeamSchedule(userId, activeTeamId, selectedSeasonId);
            
            // 2. Calculate Running Record Logic (Custom for UI)
            int wins = 0; int losses = 0; int ties = 0;
            
            foreach(var g in teamGames.OrderBy(x => x.Date))
            {
                if(g.Detail.IsComplete)
                {
                    bool isHome = g.Detail.HomeTeamId == activeTeamId;
                    int myScore = isHome ? g.Detail.HomeScore : g.Detail.AwayScore;
                    int oppScore = isHome ? g.Detail.AwayScore : g.Detail.HomeScore;
                    
                    if(myScore > oppScore) wins++;
                    else if(myScore < oppScore) losses++;
                    else ties++;
                }
                // Assign the "Running Record" to the DTO property we created earlier
                g.FavoriteRecord = new BulletSportsService.TeamRecord { Wins = wins, Losses = losses, Ties = ties };
            }
        }
    }

    private void OpenAddLeague() { modalType = "league"; modalTitle = "Add League"; editingId = 0; tempName = ""; tempImgUrl = ""; tempLinkUrl = ""; showConfigModal = true; }
    private void OpenEditLeague(League l) { modalType = "league"; modalTitle = "Edit League"; editingId = l.Id; tempName = l.Name; tempImgUrl = l.ImgUrl; tempLinkUrl = l.LinkUrl; showConfigModal = true; }
    
    private void OpenAddSeason() { modalType = "season"; modalTitle = "Add Season"; editingId = 0; tempName = ""; tempImgUrl = ""; tempLeagueId = 0; showConfigModal = true; }
    private void OpenEditSeason(Season s) { modalType = "season"; modalTitle = "Edit Season"; editingId = s.Id; tempName = s.Name; tempImgUrl = s.ImgUrl; tempLeagueId = s.LeagueId; showConfigModal = true; }
    
    private void OpenAddTeam() { modalType = "team"; modalTitle = "Add Team"; editingId = 0; tempName = ""; tempImgUrl = ""; tempAbbr = ""; tempLeagueId = filterLeagueId; tempIsFav = false; showConfigModal = true; }
    private void OpenEditTeam(Team t) { modalType = "team"; modalTitle = "Edit Team"; editingId = t.Id; tempName = t.Name; tempImgUrl = t.LogoUrl; tempAbbr = t.Abbreviation; tempLeagueId = t.LeagueId; tempIsFav = t.IsFavorite; showConfigModal = true; }
    
    private void CloseModal() { showConfigModal = false; }
    
    private async Task DeleteLeague(int id) { if(await JS.InvokeAsync<bool>("confirm", "Delete?")) { await SportsService.DeleteLeague(id); await LoadAllData(); } }
    private async Task DeleteSeason(int id) { if(await JS.InvokeAsync<bool>("confirm", "Delete?")) { await SportsService.DeleteSeason(id); await LoadAllData(); } }
    private async Task DeleteTeam(int id) { if(await JS.InvokeAsync<bool>("confirm", "Delete?")) { await SportsService.DeleteTeam(id); await LoadAllData(); } }

    private void OpenEditGame(BulletTaskService.TaskDTO g) { editingGame = teamGames.FirstOrDefault(x => x.Id == g.Id); }
    private void CloseGameEditor() { editingGame = null; }
    private async Task SaveGame() { if(editingGame != null) { await SportsService.SaveGame(editingGame); await LoadSchedule(); editingGame = null; } }

    private async Task HandleFileSelected(InputFileChangeEventArgs e) { try { var f = e.File; var b = new byte[f.Size]; await f.OpenReadStream(5*1024*1024).ReadAsync(b); tempImgUrl = $"data:{f.ContentType};base64,{Convert.ToBase64String(b)}"; } catch {} }

    private async Task SaveConfigModal()
    {
        if(string.IsNullOrWhiteSpace(tempName)) return;
        if(modalType == "league") { if(editingId==0) await SportsService.AddLeague(userId, tempName, tempImgUrl, tempLinkUrl); else await SportsService.UpdateLeague(new League{Id=editingId, UserId=userId, Name=tempName, ImgUrl=tempImgUrl, LinkUrl=tempLinkUrl}); }
        else if(modalType == "season") { if(tempLeagueId==0) return; if(editingId==0) await SportsService.AddSeason(userId, tempLeagueId, tempName, tempImgUrl); else await SportsService.UpdateSeason(new Season{Id=editingId, UserId=userId, LeagueId=tempLeagueId, Name=tempName, ImgUrl=tempImgUrl}); }
        else if(modalType == "team") { if(tempLeagueId==0) return; var t = new Team{Id=editingId, UserId=userId, LeagueId=tempLeagueId, Name=tempName, Abbreviation=tempAbbr, LogoUrl=tempImgUrl, IsFavorite=tempIsFav}; if(editingId==0) await SportsService.AddTeam(userId, tempLeagueId, tempName, tempAbbr, tempImgUrl, tempIsFav); else await SportsService.UpdateTeam(t); }
        
        showConfigModal = false;
        await LoadAllData();
    }

    private string FormatDate(DateTime d)
    {
        string daySuffix = (d.Day % 10 == 1 && d.Day != 11) ? "st" : (d.Day % 10 == 2 && d.Day != 12) ? "nd" : (d.Day % 10 == 3 && d.Day != 13) ? "rd" : "th";
        return $"{d:dddd, MMM. d}{daySuffix}, {d:yyyy}";
    }
}