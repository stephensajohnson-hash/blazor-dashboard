@page "/manage-sports"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using System.Net.Http.Headers
@using Microsoft.JSInterop
@using System.Text.Json
@using System.IO
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

<div class="min-h-screen bg-gray-900 text-white p-6 pb-40">
    <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-white">Manage Sports</h1>
            <p class="text-gray-400 text-sm">Configure Leagues, Seasons, and Teams</p>
        </div>
        <div class="flex gap-2">
             <button @onclick="UpgradeDatabase" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-bold transition">‚ö†Ô∏è Update Database Schema</button>
             <button @onclick="ImportLeagues" class="px-3 py-2 bg-blue-700 hover:bg-blue-600 rounded text-xs font-bold transition" disabled="@isImporting">üì• Import Leagues</button>
             <button @onclick="ImportTeams" class="px-3 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-xs font-bold transition" disabled="@isImporting">üì• Import Teams</button>
            <a href="/bullet-calendar" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm font-bold transition">‚Üê Back to Calendar</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-gray-800/50 rounded-xl border border-gray-700 flex flex-col h-[75vh]">
            <div class="p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-lg">Leagues</h2>
                <button @onclick='() => NewItem("league")' class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded transition">Ôºã Add</button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                @foreach (var l in Leagues) {
                    <div class="p-3 rounded-lg border cursor-pointer transition flex items-center gap-3 @(selectedLeague?.Id == l.Id ? "bg-blue-900/30 border-blue-500" : "bg-gray-900 border-gray-700 hover:border-gray-500")" @onclick="() => SelectLeague(l)">
                        @if(!string.IsNullOrEmpty(l.ImgUrl)) { <img src="@l.ImgUrl" class="w-8 h-8 object-contain rounded bg-white/10 p-0.5" /> }
                        else { <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center text-xs">üèÜ</div> }
                        <div class="flex-1 min-w-0"><div class="font-bold truncate">@l.Name</div></div>
                        <button @onclick='() => EditItem("league", l.Id)' @onclick:stopPropagation="true" class="text-gray-400 hover:text-white">‚úé</button>
                        <button @onclick='() => DeleteItem("league", l.Id)' @onclick:stopPropagation="true" class="text-red-400 hover:text-red-200">‚úï</button>
                    </div>
                }
            </div>
        </div>

        <div class="bg-gray-800/50 rounded-xl border border-gray-700 flex flex-col h-[75vh] @(selectedLeague == null ? "opacity-50 pointer-events-none" : "")">
            <div class="p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-lg">Seasons</h2>
                <button @onclick='() => NewItem("season")' class="text-xs bg-green-600 hover:bg-green-500 px-3 py-1 rounded transition">Ôºã Add</button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                @if(selectedLeague != null) {
                    @foreach (var s in GetSeasons(selectedLeague.Id)) {
                        <div class="p-3 rounded-lg border bg-gray-900 border-gray-700 hover:border-gray-500 transition flex items-center gap-3">
                            <div class="flex-1 min-w-0"><div class="font-bold truncate">@s.Name</div></div>
                            <button @onclick='() => EditItem("season", s.Id)' class="text-gray-400 hover:text-white">‚úé</button>
                            <button @onclick='() => DeleteItem("season", s.Id)' class="text-red-400 hover:text-red-200">‚úï</button>
                        </div>
                    }
                } else { <div class="p-4 text-center text-gray-500 italic">Select a league</div> }
            </div>
        </div>

        <div class="bg-gray-800/50 rounded-xl border border-gray-700 flex flex-col h-[75vh] @(selectedLeague == null ? "opacity-50 pointer-events-none" : "")">
            <div class="p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-lg">Teams</h2>
                <button @onclick='() => NewItem("team")' class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1 rounded transition">Ôºã Add</button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                @if(selectedLeague != null) {
                    @foreach (var t in GetTeams(selectedLeague.Id)) {
                        <div class="p-3 rounded-lg border bg-gray-900 border-gray-700 hover:border-gray-500 transition flex items-center gap-3">
                            @if(!string.IsNullOrEmpty(t.LogoUrl)) { <img src="@t.LogoUrl" class="w-8 h-8 object-contain rounded bg-white/10 p-0.5" /> }
                            else { <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center text-xs">üõ°Ô∏è</div> }
                            <div class="flex-1 min-w-0">
                                <div class="font-bold truncate flex items-center gap-2">@t.Name @if(t.IsFavorite){<span class="text-yellow-400 text-xs">‚òÖ</span>}</div>
                                <div class="text-xs text-gray-500">@t.Abbreviation</div>
                            </div>
                            <button @onclick='() => EditItem("team", t.Id)' class="text-gray-400 hover:text-white">‚úé</button>
                            <button @onclick='() => DeleteItem("team", t.Id)' class="text-red-400 hover:text-red-200">‚úï</button>
                        </div>
                    }
                } else { <div class="p-4 text-center text-gray-500 italic">Select a league</div> }
            </div>
        </div>
    </div>
    
    <div class="mt-6 p-4 bg-black/80 rounded-lg border border-gray-700 font-mono text-[10px] text-green-400 h-64 overflow-y-auto shadow-inner">
        <div class="flex justify-between mb-2 font-bold text-white border-b border-gray-700 pb-1 sticky top-0 bg-black/90"><span>Console Output</span><button @onclick="()=>debugLogs.Clear()" class="hover:text-white text-xs bg-gray-800 px-2 rounded">Clear</button></div>
        @if(!debugLogs.Any()) { <div class="text-gray-500">Ready. Waiting for action...</div> }
        @foreach(var l in debugLogs){ <div class="mb-0.5 break-all">@l</div> }
    </div>
</div>

@if (editingItem != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">@(editingItem.Id == 0 ? "Add" : "Edit") @editingItem.Type</h3>
                <button @onclick="() => editingItem = null" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label><input @bind="editingItem.Name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="Enter name..." /></div>
                
                @if(editingItem.Type == "team") {
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Abbreviation</label><input @bind="editingItem.Abbreviation" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="e.g. DAL" /></div>
                    <div class="flex items-center gap-2 border border-gray-700 p-2 rounded bg-gray-800"><input type="checkbox" @bind="editingItem.IsFavorite" class="w-5 h-5 rounded bg-gray-900 border-gray-600 text-yellow-500" /><label class="text-sm font-bold text-gray-300 uppercase">Is Favorite Team?</label></div>
                }

                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link URL</label><input @bind="editingItem.LinkUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="https://..." /></div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image / Logo</label>
                    <div class="flex gap-2 mb-2">
                        <button class="text-xs px-3 py-1 rounded @(!isUploading?"bg-blue-600":"bg-gray-800")" @onclick="()=>isUploading=false">Link URL</button>
                        <button class="text-xs px-3 py-1 rounded @(isUploading?"bg-blue-600":"bg-gray-800")" @onclick="()=>isUploading=true">Upload</button>
                    </div>
                    @if(!isUploading){<input @bind="editingItem.ImgUrl" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="https://..." />}
                    else{<InputFile OnChange="HandleImageUpload" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" />}
                    @if(!string.IsNullOrEmpty(editingItem.ImgUrl)){<div class="mt-2 h-20 w-20 rounded overflow-hidden border border-gray-600 bg-white/5 p-1"><img src="@editingItem.ImgUrl" class="w-full h-full object-contain" /></div>}
                </div>
            </div>
            <div class="p-4 border-t border-gray-800 bg-gray-800/50 rounded-b-2xl flex justify-end gap-3">
                <button @onclick="() => editingItem = null" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancel</button><button @onclick="SaveItem" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold shadow-lg">Save</button>
            </div>
        </div>
    </div>
}

@code {
    private List<BulletLeague> Leagues = new();
    private List<BulletSeason> Seasons = new();
    private List<BulletTeam> Teams = new();
    private BulletLeague? selectedLeague;
    private DraftItem? editingItem;
    private bool isUploading = false;
    private User? currentUser;
    
    private bool isDbError = false;
    private string errorMessage = "";
    private bool isImporting = false;
    private List<string> debugLogs = new();

    private class DraftItem {
        public int Id { get; set; }
        public string Type { get; set; } = "league"; 
        public string Name { get; set; } = "";
        public string LinkUrl { get; set; } = "";
        public string ImgUrl { get; set; } = "";
        public string Abbreviation { get; set; } = "";
        public bool IsFavorite { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if(firstRender) {
            try {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", true); return; }
                var session = JsonSerializer.Deserialize<SessionData>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", true); return; }
                currentUser = await Db.Users.FindAsync(session.UserId);
                if (currentUser != null) await LoadData();
            } catch (Exception ex) { 
                Console.WriteLine("Error in ManageSports: " + ex.Message);
            }
        }
    }

    private async Task LoadData() {
        if(currentUser == null) return;
        try {
            Leagues = await Db.BulletLeagues.Where(l => l.UserId == currentUser.Id).ToListAsync();
            Seasons = await Db.BulletSeasons.Where(s => s.UserId == currentUser.Id).ToListAsync();
            Teams = await Db.BulletTeams.Where(t => t.UserId == currentUser.Id).ToListAsync();
            isDbError = false; 
            StateHasChanged();
        } catch (Exception ex) {
            if (ex.Message.Contains("42P01")) { // Postgres table missing error
                isDbError = true;
                errorMessage = ex.Message;
                StateHasChanged();
            } else {
                Log("Load Data Error: " + ex.Message);
            }
        }
    }
    
    private void Log(string msg) { debugLogs.Insert(0, $"{DateTime.Now:HH:mm:ss} - {msg}"); InvokeAsync(StateHasChanged); }

    private async Task UpgradeDatabase() {
        try {
            await Db.Database.ExecuteSqlRawAsync(@"
                CREATE TABLE IF NOT EXISTS ""BulletLeagues"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Name"" text, ""LinkUrl"" text, ""ImgUrl"" text);
                CREATE TABLE IF NOT EXISTS ""BulletSeasons"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL DEFAULT 0, ""BulletLeagueId"" integer NOT NULL, ""Name"" text, ""LinkUrl"" text, ""ImgUrl"" text);
                CREATE TABLE IF NOT EXISTS ""BulletTeams"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL DEFAULT 0, ""BulletLeagueId"" integer NOT NULL, ""Name"" text, ""Abbreviation"" text, ""LogoUrl"" text, ""LinkUrl"" text, ""IsFavorite"" boolean DEFAULT false);
                CREATE TABLE IF NOT EXISTS ""BulletGames"" (""Id"" serial PRIMARY KEY, ""UserId"" integer NOT NULL, ""Type"" text, ""Category"" text, ""Title"" text, ""Date"" timestamp with time zone NOT NULL, ""BulletLeagueId"" integer NOT NULL, ""BulletSeasonId"" integer NOT NULL, ""HomeTeamId"" integer NOT NULL, ""AwayTeamId"" integer NOT NULL, ""HomeScore"" integer, ""AwayScore"" integer, ""Status"" text, ""StartTime"" text, ""TvChannel"" text, ""OriginalStringId"" text);
                
                DO $$ 
                BEGIN 
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='BulletSeasons' AND column_name='UserId') THEN
                        ALTER TABLE ""BulletSeasons"" ADD COLUMN ""UserId"" integer NOT NULL DEFAULT 0;
                    END IF;
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='BulletTeams' AND column_name='UserId') THEN
                        ALTER TABLE ""BulletTeams"" ADD COLUMN ""UserId"" integer NOT NULL DEFAULT 0;
                    END IF;
                END $$;
            ");
            Log("Tables created/updated successfully.");
            isDbError = false;
            await LoadData();
        } catch (Exception ex) {
            errorMessage = ex.Message;
            Log($"Error creating tables: {ex.Message}");
        }
    }

    private string GetProp(JsonElement el, string propName) {
        if (el.ValueKind != JsonValueKind.Object) return "";
        foreach (var prop in el.EnumerateObject()) {
            if (prop.Name.Equals(propName, StringComparison.OrdinalIgnoreCase)) return prop.Value.ToString();
        }
        return "";
    }
    
    private bool GetBoolProp(JsonElement el, string propName) {
        if (el.ValueKind != JsonValueKind.Object) return false;
        foreach (var prop in el.EnumerateObject()) {
            if (prop.Name.Equals(propName, StringComparison.OrdinalIgnoreCase)) return prop.Value.ValueKind == JsonValueKind.True;
        }
        return false;
    }

    private async Task ImportLeagues() {
        if (currentUser == null) return;
        isImporting = true; Log("Starting League Import...");
        try {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            var content = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(content);
            var root = doc.RootElement;
            JsonElement items = root;
            if (root.ValueKind == JsonValueKind.Object && root.TryGetProperty("items", out var i)) items = i;

            int count = 0;
            // Check for top-level "leagues" array
            if(root.TryGetProperty("leagues", out var leaguesArr) && leaguesArr.ValueKind == JsonValueKind.Array) {
                 foreach (var el in leaguesArr.EnumerateArray()) {
                    string name = el.ToString();
                    if(!Leagues.Any(x => x.Name.Equals(name, StringComparison.OrdinalIgnoreCase) && x.UserId == currentUser.Id)) {
                        var l = new BulletLeague { UserId = currentUser.Id, Name = name };
                        await Db.BulletLeagues.AddAsync(l);
                        count++;
                        Log($"Queued League: {name}");
                    }
                }
            }
            // Fallback to mixed list
            else if(items.ValueKind == JsonValueKind.Array) {
                foreach (var el in items.EnumerateArray()) {
                    var type = GetProp(el, "type");
                    if (type.Equals("league", StringComparison.OrdinalIgnoreCase)) {
                        var name = GetProp(el, "name");
                        if(!Leagues.Any(x => x.Name.Equals(name, StringComparison.OrdinalIgnoreCase) && x.UserId == currentUser.Id)) {
                            var l = new BulletLeague { UserId = currentUser.Id, Name = name, LinkUrl = GetProp(el, "linkUrl"), ImgUrl = GetProp(el, "imgUrl") };
                            await Db.BulletLeagues.AddAsync(l);
                            count++;
                            Log($"Queued League: {l.Name}");
                        }
                    }
                }
            }

            await Db.SaveChangesAsync();
            Log($"Imported {count} leagues.");
            await LoadData();
        } catch (Exception ex) { Log($"Import Error: {ex.Message}"); }
        finally { isImporting = false; }
    }

    private async Task ImportTeams() {
        if (currentUser == null) return;
        isImporting = true; Log("Starting Team Import...");
        try {
            var filePath = Path.Combine(Env.WebRootPath, "bullet_calendar.json");
            var content = await File.ReadAllTextAsync(filePath);
            using var doc = JsonDocument.Parse(content);
            var root = doc.RootElement;
            JsonElement items = root;
            if (root.ValueKind == JsonValueKind.Object && root.TryGetProperty("items", out var i)) items = i;

            // Refresh leagues
            var leagues = await Db.BulletLeagues.Where(u => u.UserId == currentUser.Id).ToListAsync();
            if(!leagues.Any()) { Log("No leagues found! Import leagues first."); isImporting = false; return; }

            int count = 0;
            
            // Check for top-level "teams" array
            if(root.TryGetProperty("teams", out var teamsArr) && teamsArr.ValueKind == JsonValueKind.Array) {
                 foreach (var el in teamsArr.EnumerateArray()) {
                    string leagueName = GetProp(el, "league");
                    string teamName = GetProp(el, "name");
                    var league = leagues.FirstOrDefault(l => l.Name.Equals(leagueName, StringComparison.OrdinalIgnoreCase));
                    
                    // Fallback league if not found
                    if(league == null) league = leagues.First();

                    if(!Teams.Any(t => t.Name.Equals(teamName, StringComparison.OrdinalIgnoreCase) && t.UserId == currentUser.Id)) {
                        var tm = new BulletTeam { BulletLeagueId = league.Id, UserId = currentUser.Id };
                        tm.Name = teamName;
                        tm.Abbreviation = GetProp(el, "abbrev");
                        tm.LogoUrl = GetProp(el, "logo");
                        if(string.IsNullOrEmpty(tm.LogoUrl)) tm.LogoUrl = GetProp(el, "imgUrl");
                        tm.IsFavorite = GetBoolProp(el, "isFavorite");
                        await Db.BulletTeams.AddAsync(tm);
                        count++;
                        Log($"Queued Team: {tm.Name}");
                    }
                }
            }
            // Fallback to mixed
            else if(items.ValueKind == JsonValueKind.Array) {
                foreach (var el in items.EnumerateArray()) {
                    var type = GetProp(el, "type");
                    if (type.Equals("team", StringComparison.OrdinalIgnoreCase)) {
                        string leagueName = GetProp(el, "league");
                        string teamName = GetProp(el, "name");
                        var league = leagues.FirstOrDefault(l => l.Name.Equals(leagueName, StringComparison.OrdinalIgnoreCase));
                        if(league == null) league = leagues.First();

                        if(!Teams.Any(t => t.Name.Equals(teamName, StringComparison.OrdinalIgnoreCase) && t.UserId == currentUser.Id)) {
                            var tm = new BulletTeam { BulletLeagueId = league.Id, UserId = currentUser.Id };
                            tm.Name = teamName;
                            tm.Abbreviation = GetProp(el, "abbreviation");
                            tm.LogoUrl = GetProp(el, "logoUrl");
                            if(string.IsNullOrEmpty(tm.LogoUrl)) tm.LogoUrl = GetProp(el, "imgUrl");
                            tm.IsFavorite = GetBoolProp(el, "isFavorite");
                            await Db.BulletTeams.AddAsync(tm);
                            count++;
                            Log($"Queued Team: {tm.Name}");
                        }
                    }
                }
            }

            await Db.SaveChangesAsync();
            Log($"Imported {count} teams.");
            await LoadData();
        } catch (Exception ex) { Log($"Import Error: {ex.Message}"); }
        finally { isImporting = false; }
    }

    private List<BulletSeason> GetSeasons(int leagueId) => Seasons.Where(s => s.BulletLeagueId == leagueId).ToList();
    private List<BulletTeam> GetTeams(int leagueId) => Teams.Where(t => t.BulletLeagueId == leagueId).ToList();

    private void SelectLeague(BulletLeague l) { selectedLeague = l; StateHasChanged(); }

    private void NewItem(string type) {
        editingItem = new DraftItem { Type = type };
    }

    private void EditItem(string type, int id) {
        if(type == "league") { var x = Leagues.First(i => i.Id == id); editingItem = new DraftItem { Id = x.Id, Type = "league", Name = x.Name, LinkUrl = x.LinkUrl, ImgUrl = x.ImgUrl }; }
        else if(type == "season") { var x = Seasons.First(i => i.Id == id); editingItem = new DraftItem { Id = x.Id, Type = "season", Name = x.Name, LinkUrl = x.LinkUrl, ImgUrl = x.ImgUrl }; }
        else if(type == "team") { var x = Teams.First(i => i.Id == id); editingItem = new DraftItem { Id = x.Id, Type = "team", Name = x.Name, Abbreviation = x.Abbreviation, LinkUrl = x.LinkUrl, ImgUrl = x.LogoUrl, IsFavorite = x.IsFavorite }; }
    }

    private async Task SaveItem() {
        if(editingItem == null || currentUser == null) return;

        if (editingItem.Type == "league") {
            BulletLeague l;
            if(editingItem.Id > 0) l = await Db.BulletLeagues.FindAsync(editingItem.Id) ?? new BulletLeague();
            else { l = new BulletLeague { UserId = currentUser.Id }; await Db.BulletLeagues.AddAsync(l); }
            l.Name = editingItem.Name; l.LinkUrl = editingItem.LinkUrl; l.ImgUrl = editingItem.ImgUrl;
        }
        else if (editingItem.Type == "season") {
            if(selectedLeague == null) return;
            BulletSeason s;
            if(editingItem.Id > 0) s = await Db.BulletSeasons.FindAsync(editingItem.Id) ?? new BulletSeason();
            else { s = new BulletSeason { BulletLeagueId = selectedLeague.Id, UserId = currentUser.Id }; await Db.BulletSeasons.AddAsync(s); }
            s.Name = editingItem.Name; s.LinkUrl = editingItem.LinkUrl; s.ImgUrl = editingItem.ImgUrl;
        }
        else if (editingItem.Type == "team") {
            if(selectedLeague == null) return;
            BulletTeam t;
            if(editingItem.Id > 0) t = await Db.BulletTeams.FindAsync(editingItem.Id) ?? new BulletTeam();
            else { t = new BulletTeam { BulletLeagueId = selectedLeague.Id, UserId = currentUser.Id }; await Db.BulletTeams.AddAsync(t); }
            t.Name = editingItem.Name; t.Abbreviation = editingItem.Abbreviation; t.LinkUrl = editingItem.LinkUrl; t.LogoUrl = editingItem.ImgUrl; t.IsFavorite = editingItem.IsFavorite;
        }

        await Db.SaveChangesAsync();
        editingItem = null;
        await LoadData();
    }

    private async Task DeleteItem(string type, int id) {
        if(!await JS.InvokeAsync<bool>("confirm", "Delete this item?")) return;
        if(type == "league") { var x = await Db.BulletLeagues.FindAsync(id); if(x!=null) Db.BulletLeagues.Remove(x); if(selectedLeague?.Id == id) selectedLeague = null; }
        else if(type == "season") { var x = await Db.BulletSeasons.FindAsync(id); if(x!=null) Db.BulletSeasons.Remove(x); }
        else if(type == "team") { var x = await Db.BulletTeams.FindAsync(id); if(x!=null) Db.BulletTeams.Remove(x); }
        await Db.SaveChangesAsync();
        await LoadData();
    }
}