@page "/manage-sports"
@using Dashboard
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject AppDbContext Db
@inject BulletSportsService SportsService
@inject IJSRuntime JS

<div class="min-h-screen bg-gray-900 text-white p-6">
    
    <div class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <span class="text-3xl">üèÜ</span>
            <h1 class="text-2xl font-bold text-white">Manage Sports</h1>
        </div>
        <a href="/bullet-calendar" class="text-sm text-gray-400 hover:text-white transition">‚Üê Back to Calendar</a>
    </div>

    <div class="flex border-b border-gray-800 mb-6">
        <button class="px-6 py-3 text-sm font-bold border-b-2 border-orange-500 text-white bg-gray-800/50 rounded-t-lg">
            Leagues
        </button>
        <button class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 cursor-not-allowed opacity-50">Seasons</button>
        <button class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 cursor-not-allowed opacity-50">Teams</button>
    </div>

    <div class="max-w-2xl">
        
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 flex gap-3 shadow-lg">
            <input @bind="newLeagueName" 
                   @onkeyup="HandleInputKey"
                   placeholder="Enter League Name (e.g. NFL, MLB)..." 
                   class="flex-1 bg-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-orange-500 outline-none transition" />
            <button @onclick="AddLeague" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition">
                Add League
            </button>
        </div>

        @if (isLoading)
        {
            <div class="text-gray-500 italic animate-pulse">Loading leagues...</div>
        }
        else if (leagues.Count == 0)
        {
            <div class="text-gray-500 italic p-4 text-center border border-gray-800 rounded-lg">No leagues found. Add one above!</div>
        }
        else
        {
            <div class="grid gap-3">
                @foreach (var l in leagues)
                {
                    <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-500 transition group shadow-md">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xl shadow-inner">
                                üèÖ
                            </div>
                            <span class="font-bold text-lg text-white">@l.Name</span>
                        </div>
                        
                        <button @onclick="() => DeleteLeague(l.Id)" class="text-gray-500 hover:text-red-500 p-2 rounded hover:bg-gray-700 transition" title="Delete League">
                            üóëÔ∏è
                        </button>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private int userId = 0;
    private bool isLoading = true;
    private List<League> leagues = new();
    private string newLeagueName = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (!string.IsNullOrEmpty(json)) 
                { 
                    using(var doc = System.Text.Json.JsonDocument.Parse(json)) 
                    {
                        if(doc.RootElement.TryGetProperty("UserId", out var p) || doc.RootElement.TryGetProperty("userId", out p)) 
                            userId = p.GetInt32();
                    }
                    
                    if(userId > 0) 
                    {
                        await LoadLeagues();
                    }
                }
            }
            catch (Exception ex) 
            {
                Console.WriteLine($"Error loading session: {ex.Message}");
            }
        }
    }

    private async Task HandleInputKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddLeague();
        }
    }

    private async Task LoadLeagues()
    {
        isLoading = true;
        StateHasChanged();

        leagues = await Db.Leagues
            .Where(l => l.UserId == userId)
            .OrderBy(l => l.Name)
            .ToListAsync();

        isLoading = false;
        StateHasChanged();
    }

    private async Task AddLeague()
    {
        if (string.IsNullOrWhiteSpace(newLeagueName) || userId == 0) return;

        var newLeague = new League 
        { 
            UserId = userId, 
            Name = newLeagueName.Trim() 
        };

        Db.Leagues.Add(newLeague);
        await Db.SaveChangesAsync();

        newLeagueName = "";
        await LoadLeagues();
    }

    private async Task DeleteLeague(int id)
    {
        var league = await Db.Leagues.FindAsync(id);
        if (league != null)
        {
            Db.Leagues.Remove(league);
            await Db.SaveChangesAsync();
            await LoadLeagues();
        }
    }
}