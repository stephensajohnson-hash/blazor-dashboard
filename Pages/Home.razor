@page "/"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using Dashboard
@using Dashboard.Components.Bullet
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Globalization
@using System.Text
@using Microsoft.AspNetCore.WebUtilities
@using System.Xml.Linq
@using System.Text.RegularExpressions
@inject AppDbContext Db
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject BulletBaseService BaseService

<BulletHeader />

<div class="min-h-screen bg-gray-900 text-white overflow-x-hidden pb-40 font-sans">

    @if (isDbError)
    {
        <div class="flex flex-col items-center justify-center h-screen space-y-6">
            <div class="text-red-500 text-xl font-black uppercase tracking-widest text-center">
                ‚ö†Ô∏è Database Integrity Alert<br/>
                <span class="text-xs opacity-50 font-mono">Schema Mismatch or Missing Columns</span>
            </div>
            <button @onclick="UpgradeDatabase" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-black uppercase rounded-lg shadow-lg transition tracking-widest">
                Execute Table Repair
            </button>
        </div>
    }
    else
    {
        <main class="w-full px-8 pt-6 pb-8 relative scroll-smooth" @onclick="CloseMenus">
            
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-black uppercase tracking-widest text-gray-200">Hyperlinks</h3>
                <button type="button" @onclick="OpenAddGroupModal" class="text-[10px] font-black uppercase text-gray-500 hover:text-white border border-gray-700 hover:border-gray-500 px-3 py-1 rounded transition tracking-widest">
                    + Add Link Group
                </button>
            </div>

            @* 1. LINK CLUSTERS *@
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
                @foreach (var group in Groups)
                {
                    <div id="@group.Id" class="group/card relative bg-gray-800/40 rounded-xl p-5 border border-gray-700/50 hover:border-blue-500/40 transition shadow-2xl">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                            <h3 class="text-lg font-black text-white flex items-center gap-2 uppercase tracking-tighter">
                                <span class="w-2 h-2 rounded-full shadow-[0_0_10px_currentColor]" style="color: @group.Color; background-color: @group.Color"></span>
                                @group.Name
                            </h3>
                            <div class="relative">
                                <button class="text-gray-500 hover:text-white p-1 text-sm font-black opacity-0 group-hover/card:opacity-100 transition" 
                                        @onclick="() => ToggleGroupMenu(group.Id)" 
                                        @onclick:stopPropagation="true">‚ãÆ</button>
                                @if (activeGroupMenuId == group.Id)
                                {
                                    <div class="absolute right-0 top-full mt-1 w-32 bg-gray-800 border border-gray-600 rounded-lg shadow-2xl z-50 py-1 font-bold">
                                        <button @onclick="() => MoveGroup(group, -1)" class="w-full text-left px-3 py-1 text-xs text-gray-300 hover:bg-gray-700 transition">‚Üê Move Left</button>
                                        <button @onclick="() => MoveGroup(group, 1)" class="w-full text-left px-3 py-1 text-xs text-gray-300 hover:bg-gray-700 transition">‚Üí Move Right</button>
                                        <div class="border-t border-gray-700 my-1"></div>
                                        <button @onclick="() => OpenAddLinkModal(group.Id)" class="w-full text-left px-3 py-1 text-xs text-green-400 hover:bg-gray-700 transition">+ Add Link</button>
                                        <button @onclick="() => OpenEditGroupModal(group)" class="w-full text-left px-3 py-1 text-xs text-blue-400 hover:bg-gray-700 transition">Edit</button>
                                        <button @onclick="() => DeleteGroup(group)" class="w-full text-left px-3 py-1 text-xs text-red-400 hover:bg-gray-700 transition">Delete</button>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            @foreach (var link in group.Links.OrderBy(l => l.Order))
                            {
                                <div class="group/link relative flex flex-col items-center">
                                    <div class="absolute -top-2 -right-2 bg-black/90 rounded border border-gray-700 shadow-md opacity-0 group-hover/link:opacity-100 z-10 transition">
                                        <button class="text-gray-400 hover:text-white px-1.5 py-0.5 text-xs font-black" 
                                                @onclick="() => ToggleLinkMenu(link.Id)" 
                                                @onclick:stopPropagation="true">‚ãÆ</button>
                                    </div>
                                    @if (activeLinkMenuId == link.Id)
                                    {
                                        <div class="absolute right-0 top-full mt-1 w-28 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-50 py-1 font-bold">
                                            <button @onclick="() => MoveLink(link, -1)" class="w-full text-left px-2 py-1 text-[10px] text-gray-300 hover:bg-gray-700 transition">‚Üê Move</button>
                                            <button @onclick="() => MoveLink(link, 1)" class="w-full text-left px-2 py-1 text-[10px] text-gray-300 hover:bg-gray-700 transition">‚Üí Move</button>
                                            <div class="border-t border-gray-700 my-1 font-black"></div>
                                            <button @onclick="() => OpenEditLinkModal(link)" class="w-full text-left px-2 py-1 text-[10px] text-blue-400 hover:bg-gray-700 transition">Edit</button>
                                            <button @onclick="() => DuplicateLink(link)" class="w-full text-left px-2 py-1 text-[10px] text-green-400 hover:bg-gray-700 transition">Duplicate</button>
                                            <button @onclick="() => DeleteLink(link)" class="w-full text-left px-2 py-1 text-[10px] text-red-400 hover:bg-gray-700 transition">Delete</button>
                                        </div>
                                    }
                                    <a href="@link.Url" target="_blank" class="flex flex-col items-center gap-2 p-2 rounded hover:bg-gray-700 transition w-full text-center group font-black uppercase">
                                        @{ string linkDisplayImg = !string.IsNullOrEmpty(link.Img) ? link.Img : GetFaviconUrl(link.Url); }
                                        @if (!string.IsNullOrEmpty(linkDisplayImg))
                                        {
                                            <img src="@linkDisplayImg" class="w-16 h-16 rounded object-cover opacity-80 group-hover:opacity-100 transition shadow-lg" />
                                        }
                                        <span class="text-gray-400 group-hover:text-white transition text-[11px] truncate w-full">@link.Name</span>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            @* 2. TEMPORAL NODES (COUNTDOWNS) *@
            <div class="mb-12">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-black uppercase tracking-widest text-gray-200">Temporal Nodes</h3>
                    <button @onclick="OpenAddCountdownModal" class="text-[10px] font-black uppercase text-gray-500 hover:text-white border border-gray-700 hover:border-gray-500 px-3 py-1 rounded transition tracking-widest">+ Add Node</button>
                </div>
                <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide">
                    @foreach (var c in Countdowns)
                    {
                        var calc = GetCountdownLogic(c.TargetDate);
                        <div class="group relative h-32 bg-gray-800 rounded-xl flex items-center border border-gray-700 shadow-lg shrink-0 overflow-hidden hover:border-gray-500 transition pr-6">
                            <div class="absolute top-2 right-2 flex gap-1 bg-black/80 rounded px-1 opacity-0 group-hover:opacity-100 z-20 transition shadow-md">
                                <button type="button" @onclick="() => MoveCountdown(c, -1)" class="text-[10px] text-gray-300 hover:text-white p-1">‚Üê</button>
                                <button type="button" @onclick="() => MoveCountdown(c, 1)" class="text-[10px] text-gray-300 hover:text-white p-1">‚Üí</button>
                                <div class="w-px h-3 bg-gray-700 my-auto"></div>
                                <button type="button" @onclick="() => OpenEditCountdownModal(c)" class="text-[10px] text-gray-300 hover:text-white p-1 font-bold">‚úèÔ∏è</button>
                                <button type="button" @onclick="() => DeleteCountdown(c)" class="text-[10px] text-gray-300 hover:text-red-400 p-1 font-black">‚úï</button>
                            </div>
                            <div class="h-full w-auto shrink-0 bg-gray-900 overflow-hidden font-black">
                                @if (!string.IsNullOrEmpty(c.Img)) { <img src="@c.Img" class="h-full w-auto object-cover opacity-90 group-hover:opacity-100 transition duration-500 transform group-hover:scale-110" /> }
                            </div>
                            <div class="p-4 flex flex-col justify-center min-w-[140px] font-sans font-black">
                                <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">@c.Name</div>
                                <div class="text-2xl font-black text-white leading-none mb-1">@calc.MainDisplay</div>
                                @if (!string.IsNullOrEmpty(calc.SubDisplay)) { <div class="text-[10px] text-gray-400 font-mono font-bold">@calc.SubDisplay</div> }
                                <div class="text-xs font-black text-blue-400 mt-2 font-mono uppercase tracking-widest">@c.TargetDate.ToShortDateString()</div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @* 3. TICKER ENGINE (STOCKS) *@
            <div class="mb-12">
                <div class="flex items-center justify-between mb-4 font-black uppercase tracking-widest text-gray-200">
                    <h3 class="text-xl">Ticker Engine @if (isLoadingPrices) { <span class="text-[10px] text-yellow-500 animate-pulse ml-2 lowercase tracking-normal font-bold">(handshaking...)</span> }</h3>
                    <button @onclick="OpenAddStockModal" class="text-[10px] text-gray-500 hover:text-white border border-gray-700 hover:border-gray-500 px-3 py-1 rounded transition tracking-widest">+ Add Equity</button>
                </div>
                <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide font-sans font-black">
                    @foreach (var stock in Stocks)
                    {
                        var data = PriceCache.ContainsKey(stock.Symbol) ? PriceCache[stock.Symbol] : null;
                        var price = data?.Price ?? 0;
                        var change = data?.Change ?? 0;
                        var percent = data?.Percent ?? 0;
                        var value = stock.Shares * (double)price;
                        var colorClass = change >= 0 ? "text-green-400" : "text-red-400";
                        string stockDisplayImg = !string.IsNullOrEmpty(stock.ImgUrl) ? stock.ImgUrl : GetFaviconUrl(stock.LinkUrl);

                        <div class="group relative h-32 bg-gray-800 rounded-xl flex items-center border border-gray-700 shadow-lg shrink-0 overflow-hidden hover:border-blue-500/50 transition pr-6">
                            <div class="absolute top-2 right-2 flex gap-1 bg-black/80 rounded px-1 opacity-0 group-hover:opacity-100 z-20 transition border border-gray-700 shadow-md">
                                <button type="button" @onclick="() => MoveStock(stock, -1)" class="text-[10px] text-gray-400 hover:text-white p-1">‚Üê</button>
                                <button type="button" @onclick="() => MoveStock(stock, 1)" class="text-[10px] text-gray-400 hover:text-white p-1">‚Üí</button>
                                <div class="w-px h-3 bg-gray-700 my-auto"></div>
                                <button type="button" @onclick="() => OpenEditStockModal(stock)" class="text-[10px] text-gray-400 hover:text-white p-1">‚úèÔ∏è</button>
                                <button type="button" @onclick="() => DeleteStock(stock)" class="text-[10px] text-gray-400 hover:text-red-400 p-1 font-black">‚úï</button>
                            </div>
                            <a href="@(string.IsNullOrEmpty(stock.LinkUrl) ? "#" : stock.LinkUrl)" target="_blank" class="flex items-center h-full w-full">
                                <div class="h-full w-24 shrink-0 bg-gray-900 flex items-center justify-center overflow-hidden font-black">
                                    @if (!string.IsNullOrEmpty(stockDisplayImg)) { <img src="@stockDisplayImg" class="h-full w-auto object-cover opacity-90 group-hover:opacity-100 transition duration-500 transform group-hover:scale-110 shadow-2xl" /> }
                                    else { <div class="h-full w-full bg-gray-700 flex items-center justify-center text-xs font-black text-gray-400 border-r border-gray-600 uppercase">@stock.Symbol</div> }
                                </div>
                                <div class="p-4 flex flex-col justify-center min-w-[140px]">
                                    <div class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">@stock.Symbol</div>
                                    <div class="text-2xl font-black text-white leading-none mb-1">@(price > 0 ? price.ToString("C", usCulture) : "WAIT...")</div>
                                    @if(price > 0) { <div class="text-[10px] font-black @colorClass uppercase">@(change >= 0 ? "‚ñ≤" : "‚ñº") @Math.Abs(change).ToString("0.00") (@percent.ToString("0.00")%)</div> }
                                    @if (stock.Shares > 0 && price > 0) { <div class="text-xs text-blue-300 font-mono mt-1 pt-1 border-t border-gray-700 uppercase font-black tracking-tighter">Value: @value.ToString("C0", usCulture)</div> }
                                </div>
                            </a>
                        </div>
                    }
                </div>
            </div>

            @* RSS & DERBY (OMITTED FOR SPACE - LOGIC REMAINS IN CODE) *@
        </main>
    }
</div>

@* MODAL REGION - ADDED MISSING LINK GROUP MODAL *@

@if (editingGroup != null)
{
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 font-black" @onclick="() => editingGroup = null">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-sm" @onclick:stopPropagation="true">
            <h3 class="text-lg font-black text-white mb-6 uppercase tracking-widest">Link Cluster</h3>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[9px] text-gray-500 uppercase font-black tracking-widest">Group Identity</label>
                    <input @bind="editingGroup.Name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm uppercase font-black focus:border-blue-500 outline-none" placeholder="Enter Name..." />
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] text-gray-500 uppercase font-black tracking-widest">Accent Color</label>
                    <select @bind="editingGroup.Color" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black uppercase">
                        @foreach(var opt in ColorOptions)
                        {
                            <option value="@opt.Key">@opt.Key</option>
                        }
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3 font-black uppercase tracking-widest">
                <button type="button" @onclick="() => editingGroup = null" class="px-4 py-2 text-gray-400 hover:text-white text-[10px]">Cancel</button>
                <button type="button" @onclick="SaveGroup" class="px-8 py-2 bg-blue-600 text-white rounded text-[10px] shadow-2xl active:scale-95 transition">Save Cluster</button>
            </div>
        </div>
    </div>
}

@if (editingStock != null) 
{ 
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 font-black" @onclick="() => editingStock = null">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-sm" @onclick:stopPropagation="true">
            <h3 class="text-lg font-black text-white mb-6 uppercase tracking-widest">Equity Node</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-gray-700">
                    <div class="w-16 h-16 rounded overflow-hidden flex items-center justify-center bg-black border border-gray-600">
                        @{ string preview = !string.IsNullOrEmpty(editingStock.ImgUrl) ? editingStock.ImgUrl : GetFaviconUrl(editingStock.LinkUrl); }
                        @if(!string.IsNullOrEmpty(preview)){<img src="@preview" class="w-full h-full object-cover" />}
                        else{<span class="text-[9px] text-gray-500 font-black">LOGO</span>}
                    </div>
                    <div class="flex-1 space-y-2">
                        <label class="cursor-pointer block bg-gray-700 hover:bg-gray-600 text-white text-center py-1.5 rounded text-[9px] font-black uppercase tracking-widest transition">Upload File <InputFile OnChange="@(e => HandleUpload(e, "stock"))" class="hidden" /></label>
                        <button @onclick="() => { editingStock.ImgUrl = GetFaviconUrl(editingStock.LinkUrl); }" class="w-full bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white py-1.5 rounded text-[9px] font-black uppercase border border-blue-500/30 transition">‚ö° Fetch Favicon</button>
                    </div>
                </div>
                <input @bind="editingStock.Symbol" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm uppercase font-black" placeholder="Ticker" />
                <input @bind="editingStock.Shares" type="number" step="0.001" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black font-mono" />
                <input @bind="editingStock.LinkUrl" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black" placeholder="Company Website URL" />
                <input @bind="editingStock.ImgUrl" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-[9px] font-mono" placeholder="Custom Graphic URL (Optional)" />
            </div>
            <div class="mt-8 flex justify-end gap-3 font-black uppercase tracking-widest">
                <button type="button" @onclick="() => editingStock = null" class="px-4 py-2 text-gray-400 hover:text-white text-[10px]">Cancel</button>
                <button type="button" @onclick="SaveStock" class="px-8 py-2 bg-blue-600 text-white rounded text-[10px] shadow-2xl active:scale-95 transition">Save</button>
            </div>
        </div>
    </div> 
}

@if (editingLink != null) 
{ 
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 font-black" @onclick="() => editingLink = null">
        <div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-sm font-black" @onclick:stopPropagation="true">
            <h3 class="text-lg font-black text-white mb-6 uppercase tracking-widest font-black">Pointer Node</h3>
            <div class="space-y-4 font-black">
                <div class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-gray-700 font-black">
                    <div class="w-16 h-16 rounded overflow-hidden flex items-center justify-center bg-black border border-gray-600 font-black">
                        @{ string preview = !string.IsNullOrEmpty(editingLink.Img) ? editingLink.Img : GetFaviconUrl(editingLink.Url); }
                        @if(!string.IsNullOrEmpty(preview)){<img src="@preview" class="w-full h-full object-cover" />}
                        else{<span class="text-[9px] text-gray-500 font-black">THUMB</span>}
                    </div>
                    <div class="flex-1 space-y-2 font-black">
                        <label class="cursor-pointer block bg-gray-700 hover:bg-gray-600 text-white text-center py-1.5 rounded text-[9px] font-black uppercase tracking-widest transition">Upload Graphic <InputFile OnChange="@(e => HandleUpload(e, "link"))" class="hidden" /></label>
                        <button @onclick="() => { editingLink.Img = GetFaviconUrl(editingLink.Url); }" class="w-full bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white py-1.5 rounded text-[9px] font-black uppercase border border-blue-500/30 transition">‚ö° Fetch Favicon</button>
                    </div>
                </div>
                <input @bind="editingLink.Name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black" placeholder="Identity" />
                <input @bind="editingLink.Url" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black" placeholder="Target URL" />
                <input @bind="editingLink.Img" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-[9px] font-mono font-black" placeholder="OR Graphic URL" />
                <div>
                    <label class="text-[9px] text-gray-500 uppercase font-black mb-1 block tracking-widest font-black">Cluster</label>
                    <select @bind="editingLink.LinkGroupId" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black uppercase">
                        @foreach(var grp in Groups){<option value="@grp.Id">@grp.Name</option>}
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3 font-black uppercase tracking-widest">
                <button type="button" @onclick="() => editingLink = null" class="px-4 py-2 text-gray-400 hover:text-white text-[10px] font-black">Cancel</button>
                <button type="button" @onclick="SaveLink" class="px-8 py-2 bg-blue-600 text-white rounded text-[10px] font-black uppercase shadow-2xl active:scale-95 transition">Save</button>
            </div>
        </div>
    </div> 
}

@if (editingCountdown != null) { <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 font-black" @onclick="() => editingCountdown = null"><div class="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl w-full max-w-sm font-black uppercase tracking-widest" @onclick:stopPropagation="true"><h3 class="text-lg font-black text-white mb-6">Landmark Node</h3><div class="space-y-4 font-black"><div class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-gray-700 font-black"><div class="w-16 h-16 rounded overflow-hidden flex items-center justify-center bg-black border border-gray-600">@if(!string.IsNullOrEmpty(editingCountdown.Img)){<img src="@editingCountdown.Img" class="w-full h-full object-cover" />}else{<span class="text-[9px] text-gray-500 font-black">ASSET</span>}</div><div class="flex-1 font-black"><label class="cursor-pointer block bg-gray-700 hover:bg-gray-600 text-white text-center py-1.5 rounded text-[9px] font-black uppercase tracking-widest transition">Upload Asset <InputFile OnChange="@(e => HandleUpload(e, "countdown"))" class="hidden" /></label></div></div><input @bind="editingCountdown.Name" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black" placeholder="Identity" /><input @bind="editingCountdown.TargetDate" type="date" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-sm font-black font-mono" /><input @bind="editingCountdown.Img" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white text-[9px] font-mono font-black" placeholder="Asset Graphic URL" /></div><div class="mt-8 flex justify-end gap-3 font-black"><button type="button" @onclick="() => editingCountdown = null" class="px-4 py-2 text-gray-400 hover:text-white text-[10px] uppercase font-black tracking-widest">Cancel</button><button type="button" @onclick="SaveCountdown" class="px-8 py-2 bg-blue-600 text-white rounded text-[10px] uppercase font-black tracking-widest shadow-2xl active:scale-95 transition">Finalize Node</button></div></div></div> }

<script>window.getUserOffset = () => { return new Date().getTimezoneOffset(); };</script>

@code {
    private List<LinkGroup> Groups = new();
    private List<Stock> Stocks = new();
    private List<Countdown> Countdowns = new();
    private List<DerbyEntry> DerbyEntries = new();
    private List<RssItem> RssItems = new();
    private Dictionary<string, StockData> PriceCache = new();
    private record StockData(decimal Price, decimal Change, decimal Percent);
    private Dictionary<string, string> ColorOptions = new() { { "Red", "üî¥" }, { "Orange", "üü†" }, { "Amber", "üî∏" }, { "Yellow", "üü°" }, { "Lime", "üü¢" }, { "Green", "üíö" }, { "Emerald", "‚ùáÔ∏è" }, { "Teal", "üí†" }, { "Cyan", "üîµ" }, { "Sky", "üü¶" }, { "Blue", "üîµ" }, { "Indigo", "üü£" }, { "Violet", "üü£" }, { "Purple", "üü£" }, { "Fuchsia", "üíó" }, { "Pink", "ü©∑" }, { "Rose", "üåπ" }, { "Slate", "ü™®" }, { "Gray", "üîò" }, { "Zinc", "üî©" }, { "Neutral", "üòê" }, { "Stone", "üóø" }, { "Black", "‚ö´" }, { "White", "‚ö™" }, { "Brown", "üü§" }, { "Gold", "ü•á" }, { "Silver", "ü•à" } };
    private CultureInfo usCulture = new CultureInfo("en-US");
    private bool isLoadingPrices = false;
    private int clientOffsetMinutes = 0;
    private bool isDbError = false;
    private string errorMessage = "";
    private User? currentUser;

    private int activeGroupMenuId = -1;
    private int activeLinkMenuId = -1;
    private Stock? editingStock = null;
    private LinkGroup? editingGroup = null;
    private Link? editingLink = null;
    private Countdown? editingCountdown = null;

    protected override async Task OnInitializedAsync() {
        try { await LoadData(); _ = FetchPrices(); _ = FetchDerby(); _ = FetchRssFeeds(); }
        catch (Exception ex) { if (ex.Message.Contains("42703") || ex.InnerException?.Message.Contains("42703") == true) isDbError = true; else throw; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender && !isDbError) { 
            try { 
                var json = await JS.InvokeAsync<string>("localStorage.getItem", "dashboard_session");
                if (string.IsNullOrEmpty(json)) { Nav.NavigateTo("/login", forceLoad: true); return; }
                var session = JsonSerializer.Deserialize<SessionData>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (session == null || session.Expiry < DateTime.UtcNow) { Nav.NavigateTo("/login", forceLoad: true); return; }
                currentUser = await Db.Users.FindAsync(session.UserId);
                if (currentUser != null) { await LoadData(); _ = FetchPrices(); await FetchDerby(); await FetchRssFeeds(); }
                try { clientOffsetMinutes = await JS.InvokeAsync<int>("getUserOffset"); } catch {}
                StateHasChanged();
            } catch { Nav.NavigateTo("/login", forceLoad: true); }
        }
    }

    private string GetFaviconUrl(string url) {
        if (string.IsNullOrWhiteSpace(url)) return "";
        try { var uri = new Uri(url); return $"https://www.google.com/s2/favicons?sz=128&domain={uri.Host}"; } catch { return ""; }
    }

    private async Task HandleUpload(InputFileChangeEventArgs e, string mode) {
        try {
            using var ms = new MemoryStream();
            await e.File.OpenReadStream(5 * 1024 * 1024).CopyToAsync(ms);
            string url = await BaseService.SaveImageAsync(ms.ToArray(), e.File.ContentType);
            if (mode == "stock" && editingStock != null) editingStock.ImgUrl = url;
            else if (mode == "link" && editingLink != null) editingLink.Img = url;
            else if (mode == "countdown" && editingCountdown != null) editingCountdown.Img = url;
            StateHasChanged();
        } catch {}
    }

    private void CloseMenus() { activeGroupMenuId = -1; activeLinkMenuId = -1; }
    private void ToggleGroupMenu(int id) { activeGroupMenuId = (activeGroupMenuId == id) ? -1 : id; activeLinkMenuId = -1; }
    private void ToggleLinkMenu(int id) { activeLinkMenuId = (activeLinkMenuId == id) ? -1 : id; activeGroupMenuId = -1; }

    private async Task UpgradeDatabase() { await Db.Database.ExecuteSqlRawAsync(@"ALTER TABLE ""LinkGroups"" ADD COLUMN IF NOT EXISTS ""Order"" integer DEFAULT 0; ALTER TABLE ""Links"" ADD COLUMN IF NOT EXISTS ""Order"" integer DEFAULT 0; ALTER TABLE ""Stocks"" ADD COLUMN IF NOT EXISTS ""Order"" integer DEFAULT 0; ALTER TABLE ""Countdowns"" ADD COLUMN IF NOT EXISTS ""Order"" integer DEFAULT 0; ALTER TABLE ""LinkGroups"" ADD COLUMN IF NOT EXISTS ""UserId"" integer DEFAULT 1; ALTER TABLE ""Links"" ADD COLUMN IF NOT EXISTS ""UserId"" integer DEFAULT 1; ALTER TABLE ""Stocks"" ADD COLUMN IF NOT EXISTS ""UserId"" integer DEFAULT 1; ALTER TABLE ""Countdowns"" ADD COLUMN IF NOT EXISTS ""UserId"" integer DEFAULT 1;"); await Http.PostAsync("/api/admin/fix-ordering", null); Nav.NavigateTo(Nav.Uri, forceLoad: true); }

    private async Task LoadData() { if (currentUser == null) return; Groups = await Db.LinkGroups.Where(x => x.UserId == currentUser.Id).Include(g => g.Links).OrderBy(g => g.Order).ToListAsync(); Stocks = await Db.Stocks.Where(x => x.UserId == currentUser.Id).OrderBy(s => s.Order).ToListAsync(); Countdowns = await Db.Countdowns.Where(x => x.UserId == currentUser.Id).OrderBy(c => c.Order).ToListAsync(); StateHasChanged(); }
    
    private async Task FetchDerby() { if (currentUser == null) return; try { var feedObj = await Db.Feeds.FirstOrDefaultAsync(f => f.Url == "https://shirt.woot.com/derby/rss" && f.UserId == currentUser.Id); if (feedObj == null || !feedObj.IsEnabled) { DerbyEntries.Clear(); return; } var request = new HttpRequestMessage(HttpMethod.Get, "https://shirt.woot.com/derby/rss"); request.Headers.Add("User-Agent", "Mozilla/5.0"); var response = await Http.SendAsync(request); if (!response.IsSuccessStatusCode) return; var xml = await response.Content.ReadAsStringAsync(); var doc = XDocument.Parse(xml); DerbyEntries = doc.Descendants().Where(x => x.Name.LocalName == "item").Where(item => !item.Elements().Any(e => e.Name.LocalName == "totalvotes" || e.Name.LocalName == "voterank")).Select(item => new DerbyEntry { Title = item.Elements().FirstOrDefault(x => x.Name.LocalName == "title")?.Value ?? "", Link = item.Elements().FirstOrDefault(x => x.Name.LocalName == "link")?.Value ?? "", ImgUrl = ExtractImage(item) }).Where(x => !string.IsNullOrEmpty(x.ImgUrl)).Take(9).ToList(); StateHasChanged(); } catch {} }

    private async Task FetchRssFeeds() { if (currentUser == null) return; try { var feeds = await Db.Feeds.Where(f => f.UserId == currentUser.Id && f.IsEnabled && f.Category != "System").ToListAsync(); var results = await Task.WhenAll(feeds.Select(async f => { try { using var request = new HttpRequestMessage(HttpMethod.Get, f.Url); request.Headers.Add("User-Agent", "Mozilla/5.0"); var response = await Http.SendAsync(request); if (!response.IsSuccessStatusCode) return Enumerable.Empty<RssItem>(); var xml = await response.Content.ReadAsStringAsync(); var doc = XDocument.Parse(xml); var items = doc.Descendants().Where(x => x.Name.LocalName == "item").Take(15).Select(i => new RssItem { Source = f.Name, Title = i.Elements().FirstOrDefault(x => x.Name.LocalName == "title")?.Value ?? "No Title", Link = i.Elements().FirstOrDefault(x => x.Name.LocalName == "link")?.Value ?? "#", ImgUrl = ExtractImage(i) }).ToList(); return items.Take(4); } catch { return Enumerable.Empty<RssItem>(); } })); RssItems = results.SelectMany(x => x).ToList(); StateHasChanged(); } catch {} }
    
    private string ExtractImage(XElement item) { var enc = item.Elements().FirstOrDefault(x => x.Name.LocalName == "enclosure"); if (enc != null && enc.Attribute("type")?.Value.Contains("image") == true) return enc.Attribute("url")?.Value ?? ""; var media = item.Elements().FirstOrDefault(x => x.Name.LocalName == "content" || x.Name.LocalName == "thumbnail"); if (media != null) return media.Attribute("url")?.Value ?? ""; return ""; }

    private async Task MoveGroup(LinkGroup g, int d) { await MoveItem(Db.LinkGroups, g, d); }
    private async Task MoveLink(Link l, int d) { await MoveItem(Db.Links, l, d, x => x.LinkGroupId == l.LinkGroupId); }
    private async Task MoveStock(Stock s, int d) { await MoveItem(Db.Stocks, s, d); }
    private async Task MoveCountdown(Countdown c, int d) { await MoveItem(Db.Countdowns, c, d); }

    private async Task MoveItem<T>(DbSet<T> set, T item, int direction, System.Linq.Expressions.Expression<Func<T, bool>>? filter = null) where T : class { IQueryable<T> query = set; if (filter != null) query = query.Where(filter); var list = await query.ToListAsync(); var userProp = typeof(T).GetProperty("UserId"); if (userProp != null && currentUser != null) list = list.Where(x => (int)userProp.GetValue(x)! == currentUser.Id).ToList(); var prop = typeof(T).GetProperty("Order"); if (prop == null) return; list = list.OrderBy(x => (int)prop.GetValue(x)!).ThenBy(x => (int)typeof(T).GetProperty("Id")!.GetValue(x)!).ToList(); for(int i=0; i<list.Count; i++) prop.SetValue(list[i], i); var idProp = typeof(T).GetProperty("Id"); var itemId = (int)idProp!.GetValue(item)!; var currentItemInList = list.First(x => (int)idProp.GetValue(x)! == itemId); int index = list.IndexOf(currentItemInList); int newIndex = index + direction; if (newIndex >= 0 && newIndex < list.Count && newIndex != index) { list.RemoveAt(index); list.Insert(newIndex, currentItemInList); for(int i=0; i<list.Count; i++) prop.SetValue(list[i], i); set.UpdateRange(list); await Db.SaveChangesAsync(); await LoadData(); } }

    private void OpenAddGroupModal() { CloseMenus(); editingGroup = new LinkGroup { Color = "Blue", Order = Groups.Count, UserId = currentUser!.Id }; }
    private void OpenEditGroupModal(LinkGroup g) { CloseMenus(); editingGroup = g; }
    private async Task SaveGroup() { if (editingGroup == null) return; if (editingGroup.Id == 0) Db.LinkGroups.Add(editingGroup); else Db.LinkGroups.Update(editingGroup); await Db.SaveChangesAsync(); editingGroup = null; await LoadData(); }
    private async Task DeleteGroup(LinkGroup g) { CloseMenus(); if (await JS.InvokeAsync<bool>("confirm", $"Delete '{g.Name}'?")) { Db.LinkGroups.Remove(g); await Db.SaveChangesAsync(); await LoadData(); } }
    private void OpenAddLinkModal(int groupId) { CloseMenus(); var g = Groups.FirstOrDefault(x=>x.Id==groupId); editingLink = new Link { LinkGroupId = groupId, Order = g?.Links.Count ?? 0, UserId = currentUser!.Id }; }
    private void OpenEditLinkModal(Link l) { CloseMenus(); editingLink = l; }
    private void DuplicateLink(Link l) { CloseMenus(); editingLink = new Link { Name = l.Name, Url = l.Url, Img = l.Img, LinkGroupId = l.LinkGroupId, UserId = currentUser!.Id, Order = 9999 }; }
    private async Task SaveLink() { if (editingLink == null) return; if (editingLink.Id == 0) Db.Links.Add(editingLink); else Db.Links.Update(editingLink); await Db.SaveChangesAsync(); editingLink = null; await LoadData(); }
    private async Task DeleteLink(Link l) { CloseMenus(); if (await JS.InvokeAsync<bool>("confirm", $"Delete '{l.Name}'?")) { Db.Links.Remove(l); await Db.SaveChangesAsync(); await LoadData(); } }
    private void OpenAddStockModal() { editingStock = new Stock { Order = Stocks.Count, UserId = currentUser!.Id }; }
    private void OpenEditStockModal(Stock s) { editingStock = s; }
    private async Task SaveStock() { if (editingStock == null) return; if (editingStock.Id == 0) Db.Stocks.Add(editingStock); else Db.Stocks.Update(editingStock); await Db.SaveChangesAsync(); editingStock = null; await LoadData(); _ = FetchPrices(); }
    private async Task DeleteStock(Stock s) { if (await JS.InvokeAsync<bool>("confirm", $"Delete '{s.Symbol}'?")) { Db.Stocks.Remove(s); await Db.SaveChangesAsync(); await LoadData(); } }
    private void OpenAddCountdownModal() { editingCountdown = new Countdown { TargetDate = DateTime.Now.AddDays(1), Order = Countdowns.Count, UserId = currentUser!.Id }; }
    private void OpenEditCountdownModal(Countdown c) { editingCountdown = c; }
    private async Task SaveCountdown() { if (editingCountdown == null) return; editingCountdown.TargetDate = DateTime.SpecifyKind(editingCountdown.TargetDate, DateTimeKind.Utc); if (editingCountdown.Id == 0) Db.Countdowns.Add(editingCountdown); else Db.Countdowns.Update(editingCountdown); await Db.SaveChangesAsync(); editingCountdown = null; await LoadData(); }
    private async Task DeleteCountdown(Countdown c) { if (await JS.InvokeAsync<bool>("confirm", $"Delete '{c.Name}'?")) { Db.Countdowns.Remove(c); await Db.SaveChangesAsync(); await LoadData(); } }

    private (string MainDisplay, string SubDisplay) GetCountdownLogic(DateTime target) { var now = DateTime.UtcNow.AddMinutes(-clientOffsetMinutes); var diff = target.Date - now.Date; if (diff.TotalDays < 0) return ("Done", ""); if (diff.TotalDays <= 30) return ($"{(int)diff.TotalDays} Days", ""); DateTime d = now.Date; int y = 0, m = 0; while (d.AddYears(1) <= target) { y++; d = d.AddYears(1); } while (d.AddMonths(1) <= target) { m++; d = d.AddMonths(1); } int days = (target - d).Days; string res = ""; if (y > 0) res += $"{y}y "; if (m > 0) res += $"{m}m "; res += $"{days}d"; return (res.Trim(), $"({(int)diff.TotalDays} total days)"); }

    private async Task FetchPrices() { if (Stocks.Count == 0) return; isLoadingPrices = true; StateHasChanged(); using var client = new HttpClient(); client.DefaultRequestHeaders.Add("User-Agent", "Mozilla/5.0"); foreach (var s in Stocks) { try { var json = await client.GetStringAsync($"https://query1.finance.yahoo.com/v8/finance/chart/{s.Symbol}?interval=1d"); using (var doc = JsonDocument.Parse(json)) { var meta = doc.RootElement.GetProperty("chart").GetProperty("result")[0].GetProperty("meta"); decimal price = meta.GetProperty("regularMarketPrice").GetDecimal(); decimal prev = meta.GetProperty("chartPreviousClose").GetDecimal(); decimal chg = price - prev; decimal pct = (prev != 0) ? (chg / prev) * 100 : 0; PriceCache[s.Symbol] = new StockData(price, chg, pct); } } catch {} StateHasChanged(); } isLoadingPrices = false; StateHasChanged(); }
    
    public class SessionData { public int UserId { get; set; } public DateTime Expiry { get; set; } }
    public class DerbyEntry { public string Title { get; set; } = ""; public string Link { get; set; } = ""; public string ImgUrl { get; set; } = ""; }
    public class RssItem { public string Source { get; set; } = ""; public string Title { get; set; } = ""; public string Link { get; set; } = ""; public string ImgUrl { get; set; } = ""; }
}