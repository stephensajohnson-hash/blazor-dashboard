@namespace Dashboard
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <title>Stephens' Dashboard V1.3</title>
    <link rel="icon" href="/images/dashboard.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .low-temp-offset { position: relative; top: 6px; }
        .high-temp-offset { position: relative; bottom: 6px; }
    </style>
    <HeadOutlet @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    <Routes @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />

    <script src="_framework/blazor.web.js" autostart="false"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3.0.0/dist/chartjs-chart-treemap.min.js"></script>
    
    <script>
        Blazor.start({
            circuit: {
                reconnectionHandler: {
                    onConnectionDown: (options, error) => {
                        console.warn("Connection lost. Reloading page...");
                        window.location.reload();
                    },
                    onConnectionUp: () => {
                        console.log("Reconnected!");
                    }
                }
            }
        });
    </script>

    <script>
        // 1. Local Clock Utility
        window.startLocalClock = function() {
            function update() {
                const el = document.getElementById('local-clock');
                if (el) {
                    const now = new Date();
                    el.innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).toLowerCase();
                }
            }
            setInterval(update, 1000); 
            update(); 
        };

        // 2. Budget Treemap Visualization Utility (v66.6 - Added Yellow Zero State)
window.renderBudgetTreemap = (canvasId, rawJsonData) => {
    let attempts = 0;
    const maxAttempts = 10;

    const tryRender = () => {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            attempts++;
            if (attempts < maxAttempts) { setTimeout(tryRender, 200); }
            return;
        }

        const existingChart = Chart.getChart(canvasId);
        if (existingChart) existingChart.destroy();

        try {
            // DIAGNOSTIC 1: Check what actually arrived
            const chartData = JSON.parse(rawJsonData);
            console.log("TREEMAP DIAGNOSTIC - Raw Data:", chartData);

            new Chart(ctx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        tree: chartData,
                        key: 'v',
                        groups: ['l'],
                        spacing: 1,
                        borderWidth: 2,
                        borderColor: 'rgba(0,0,0,0.3)',
                        backgroundColor: (context) => {
                            if (context.type !== 'data' || !context.raw) return '#4B5563';
                            
                            // DIAGNOSTIC 2: Access the data point directly
                            const dataPoint = context.raw._data || context.raw;
                            const rem = parseFloat(dataPoint.r);
                            const label = dataPoint.l;

                            if (label === 'Unaccounted') return '#3B82F6';
                            if (rem < 0) return '#EF4444';
                            if (Math.abs(rem) < 0.01) return '#FACC15'; 
                            return '#10B981';
                        },
                        labels: {
                            display: true,
                            formatter: (context) => {
                                const dataPoint = context.raw._data || context.raw;
                                return dataPoint.v > 50 ? [dataPoint.l, `$${Math.round(dataPoint.v)}`] : [];
                            },
                            font: { size: 12, weight: '900' },
                            color: 'white'
                        }
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                title: (items) => {
                                    const d = items[0].raw._data || items[0].raw;
                                    return d.l;
                                },
                                label: (item) => {
                                    const d = item.raw._data || item.raw;
                                    const remValue = parseFloat(d.r);
                                    const valValue = parseFloat(d.v);

                                    // DIAGNOSTIC 3: Log tooltip values if they are NaN
                                    if (isNaN(remValue)) console.error("NaN detected for label:", d.l, "Data:", d);

                                    let status = remValue < -0.01 ? "Deficit" : (Math.abs(remValue) < 0.01 ? "Balanced" : "Remaining");
                                    return [
                                        ` Total Allocated: $${valValue.toLocaleString()}`,
                                        ` ${status}: $${Math.abs(remValue).toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        } catch (e) {
            console.error("TREEMAP FATAL ERROR:", e);
        }
    };
    tryRender();
};
    </script>
</body>
</html>