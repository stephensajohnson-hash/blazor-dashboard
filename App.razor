@namespace Dashboard
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <title>Stephens' Dashboard V1.3</title>
    <link rel="icon" href="/images/dashboard.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        
        /* Debug Console specific styles */
        #debug-console-ui { display: none; }
        #debug-console-ui.visible { display: flex; }
    </style>
    <HeadOutlet @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    <Routes @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />

    <div id="debug-console-ui" class="fixed bottom-0 left-0 right-0 h-64 bg-black/95 border-t border-blue-900/50 z-[9999] flex-col font-mono shadow-2xl backdrop-blur-md">
        <div class="flex justify-between items-center bg-gray-900 px-4 py-2 border-b border-gray-800">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                <span class="text-[10px] font-black uppercase tracking-widest text-blue-400">System Trace Logs</span>
            </div>
            <div class="flex gap-3">
                <button onclick="systemConsole.copy()" class="text-[10px] text-gray-400 hover:text-white uppercase font-bold">Copy Logs</button>
                <button onclick="systemConsole.clear()" class="text-[10px] text-gray-400 hover:text-white uppercase font-bold">Clear</button>
                <button onclick="systemConsole.toggle()" class="text-[10px] text-red-400 hover:text-red-200 uppercase font-bold">Hide Console</button>
            </div>
        </div>
        <div id="debug-log-output" class="flex-1 overflow-y-auto p-3 text-[11px] leading-relaxed"></div>
    </div>

    <button onclick="systemConsole.toggle()" class="fixed bottom-6 right-6 w-12 h-12 bg-blue-600 hover:bg-blue-500 rounded-2xl shadow-2xl z-[9998] flex items-center justify-center border border-blue-400/30 transition-all active:scale-95 group">
        <span class="text-xl group-hover:rotate-12 transition-transform">ðŸ“Ÿ</span>
    </button>

    <script src="_framework/blazor.web.js" autostart="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3.0.0/dist/chartjs-chart-treemap.min.js"></script>
    
    <script>
        window.systemConsole = {
            init: function() {
                const output = document.getElementById('debug-log-output');
                const originalLog = console.log;
                const originalError = console.error;

                const addLine = (msg, isError) => {
                    const div = document.createElement('div');
                    div.className = `border-b border-gray-900/50 py-1 ${isError ? 'text-red-400' : 'text-blue-300'}`;
                    div.innerHTML = `<span class="opacity-40 text-[9px] mr-2">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
                    output.appendChild(div);
                    output.scrollTop = output.scrollHeight;
                };

                console.log = (...args) => {
                    addLine(args.join(' '), false);
                    originalLog.apply(console, args);
                };

                console.error = (...args) => {
                    addLine(args.join(' '), true);
                    originalError.apply(console, args);
                };
                
                console.log("System Console Initialized. Monitoring circuit...");
            },
            toggle: function() {
                document.getElementById('debug-console-ui').classList.toggle('visible');
            },
            clear: function() {
                document.getElementById('debug-log-output').innerHTML = '';
            },
            copy: function() {
                const text = document.getElementById('debug-log-output').innerText;
                navigator.clipboard.writeText(text);
                alert("Logs copied to clipboard.");
            }
        };

        // SURGICAL: Modal Dragging Logic
        window.initDraggable = (element, handle) => {
            if (!element || !handle) return;
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            handle.onmousedown = (e) => {
                // Ensure we aren't clicking a button inside the handle
                if (e.target.tagName === 'BUTTON') return;

                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;

                document.onmouseup = () => {
                    document.onmouseup = null;
                    document.onmousemove = null;
                };

                document.onmousemove = (e) => {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                    element.style.position = 'fixed';
                    element.style.margin = '0';
                    element.style.transform = 'none'; // Clear any CSS centering
                };
            };
        }

        // Initialize Console
        systemConsole.init();

        // Your existing Blazor Start logic
        Blazor.start({
            circuit: {
                reconnectionHandler: {
                    onConnectionDown: (options, error) => { 
                        console.error("Circuit Down: " + error);
                        window.location.reload(); 
                    }
                }
            }
        });
    </script>

    <script>
        window.startLocalClock = function() {
            function update() {
                const el = document.getElementById('local-clock');
                if (el) {
                    const now = new Date();
                    el.innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).toLowerCase();
                }
            }
            setInterval(update, 1000); 
            update(); 
        };

        window.renderBudgetTreemap = (canvasId, rawJsonData) => {
            console.log("Rendering Treemap for: " + canvasId);
            const tryDrawing = () => {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return false;
                
                // (Existing Treemap drawing logic would go here)
                
                return true;
            };
            if (!tryDrawing()) {
                const observer = new MutationObserver(() => { if (document.getElementById(canvasId)) { tryDrawing(); observer.disconnect(); } });
                observer.observe(document.body, { childList: true, subtree: true });
            }
        };
    </script>
</body>
</html>