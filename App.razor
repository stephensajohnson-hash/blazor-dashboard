@namespace Dashboard
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <title>Stephens' Dashboard V1.3</title>
    <link rel="icon" href="/images/dashboard.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
    </style>
    <HeadOutlet @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    <Routes @rendermode="@(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))" />

    <script src="_framework/blazor.web.js" autostart="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3.0.0/dist/chartjs-chart-treemap.min.js"></script>
    
    <script>
        Blazor.start({
            circuit: {
                reconnectionHandler: {
                    onConnectionDown: (options, error) => { window.location.reload(); }
                }
            }
        });
    </script>

    <script>
        window.startLocalClock = function() {
            function update() {
                const el = document.getElementById('local-clock');
                if (el) {
                    const now = new Date();
                    el.innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).toLowerCase();
                }
            }
            setInterval(update, 1000); 
            update(); 
        };

        // Treemap Visualization (v66.10 - Safe Data Accessor)
        window.renderBudgetTreemap = (canvasId, rawJsonData) => {
            let attempts = 0;
            const tryRender = () => {
                const ctx = document.getElementById(canvasId);
                if (!ctx) {
                    if (attempts++ < 15) setTimeout(tryRender, 200);
                    return;
                }

                const existingChart = Chart.getChart(canvasId);
                if (existingChart) existingChart.destroy();

                try {
                    const chartData = JSON.parse(rawJsonData);
                    
                    // HELPER: Safely find our custom data regardless of nesting
                    const getPoint = (context) => {
                        const raw = context.raw || context;
                        return raw._data || raw;
                    };

                    new Chart(ctx, {
                        type: 'treemap',
                        data: {
                            datasets: [{
                                tree: chartData,
                                key: 'v',
                                groups: ['l'],
                                spacing: 1,
                                borderWidth: 2,
                                borderColor: 'rgba(0,0,0,0.3)',
                                backgroundColor: (context) => {
                                    if (context.type !== 'data' || !context.raw) return '#4B5563';
                                    
                                    const d = getPoint(context);
                                    const rem = parseFloat(d.r);

                                    if (d.l === 'Unaccounted') return '#3B82F6';
                                    if (rem < -0.01) return '#EF4444';
                                    if (Math.abs(rem) < 0.01) return '#FACC15'; // YELLOW logic
                                    return '#10B981';
                                },
                                labels: {
                                    display: true,
                                    formatter: (context) => {
                                        const d = getPoint(context);
                                        return d.v > 100 ? [d.l, `$${Math.round(d.v)}`] : [];
                                    },
                                    font: { size: 11, weight: '900' },
                                    color: 'white'
                                }
                            }]
                        },
                        options: {
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        title: (items) => getPoint(items[0]).l,
                                        label: (item) => {
                                            const d = getPoint(item);
                                            const rem = parseFloat(d.r) || 0;
                                            const val = parseFloat(d.v) || 0;
                                            
                                            let status = "Remaining";
                                            if (rem < -0.01) status = "Deficit";
                                            if (Math.abs(rem) < 0.01) status = "Balanced";

                                            return [
                                                ` Budget: $${val.toLocaleString()}`,
                                                ` ${status}: $${Math.abs(rem).toLocaleString()}`
                                            ];
                                        }
                                    }
                                }
                            },
                            maintainAspectRatio: false,
                            responsive: true
                        }
                    });
                } catch (e) { console.error("Treemap Render Error:", e); }
            };
            tryRender();
        };
    </script>
</body>
</html>